import{u as e,c as s,r as a,j as t}from"./vendor-react-rLLBBC7n.js";import{s as i,J as n,B as r,C as l,a as d,b as c,c as o,e as m,o as x,D as h,f as j,g as u,h as p,W as f,L as g,I as v,S as N,i as y,j as _,k as w,l as b,X as C}from"./index-BDl0jLJK.js";import{T as P,a as S,b as A,c as F}from"./tabs-CFW1rRMF.js";import{T as k,a as $,b as D,c as R,d as q,e as E}from"./table-BylhXb36.js";import{A as z}from"./AdminLayout-DwaN-V0p.js";import{y as L,az as O,H as I,ct as T,aA as B,q as M,cp as H,cu as J,U,co as V,ch as W,N as Q,ap as X,ag as G}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const K=()=>{const K=e(),{affiliateId:Y}=s(),[Z,ee]=a.useState(null),[se,ae]=a.useState([]),[te,ie]=a.useState([]),[ne,re]=a.useState([]),[le,de]=a.useState(!0),[ce,oe]=a.useState("overview"),[me,xe]=a.useState({totalReferrals:0,totalEarned:0,pendingCommission:0,paidCommission:0,activeCodes:0}),[he,je]=a.useState(!1),[ue,pe]=a.useState({amount:0,payment_method:"",payment_reference:"",notes:""}),[fe,ge]=a.useState(!1);a.useEffect(()=>{Y&&ve()},[Y]);const ve=async()=>{if(Y){de(!0);try{const{data:e,error:s}=await i.from("affiliates").select("*").eq("id",Y).single();if(s)throw s;ee(e);const{data:a,error:t}=await i.from("affiliate_codes").select("*").eq("affiliate_id",Y).order("created_at",{ascending:!1});if(t)throw t;ae(a||[]);const{data:n,error:r}=await i.from("affiliate_referrals").select("\n          *,\n          affiliate_code:affiliate_codes(code)\n        ").eq("affiliate_id",Y).order("created_at",{ascending:!1});if(r)throw r;ie(n||[]);const{data:l,error:d}=await i.from("affiliate_payouts").select("*").eq("affiliate_id",Y).order("created_at",{ascending:!1});if(d)throw d;re(l||[]);const c=(n||[]).reduce((e,s)=>e+s.commission_amount,0),o=(n||[]).filter(e=>"pending"===e.commission_status).reduce((e,s)=>e+s.commission_amount,0),m=(l||[]).filter(e=>"paid"===e.status).reduce((e,s)=>e+s.amount,0);xe({totalReferrals:(null==n?void 0:n.length)||0,totalEarned:c,pendingCommission:o,paidCommission:m,activeCodes:(a||[]).filter(e=>e.is_active).length}),pe(e=>({...e,amount:o}))}catch(e){console.error("Error loading affiliate data:",e),n.error("Failed to load affiliate data")}finally{de(!1)}}},Ne=async(e,s)=>{try{const a={status:s};"paid"===s&&(a.paid_at=(new Date).toISOString());const{error:t}=await i.from("affiliate_payouts").update(a).eq("id",e.id);if(t)throw t;"paid"===s&&await i.from("affiliate_referrals").update({commission_status:"paid"}).eq("affiliate_id",null==Z?void 0:Z.id).eq("commission_status","pending"),n.success(`Payout marked as ${s}`),ve()}catch(a){console.error("Error updating payout:",a),n.error("Failed to update payout")}};return le?t.jsx(z,{title:"Loading...",children:t.jsx("div",{className:"flex justify-center py-12",children:t.jsx(L,{className:"w-8 h-8 animate-spin"})})}):Z?t.jsxs(z,{title:Z.name,description:`${"organization"===Z.type?"Organization":"Individual"} • ${Z.email}`,children:[t.jsxs(r,{variant:"outline",className:"mb-4",onClick:()=>K("/admin/affiliates"),children:[t.jsx(O,{className:"w-4 h-4 mr-2"})," Back to Affiliates"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 mb-6",children:[t.jsx(l,{children:t.jsx(d,{className:"pt-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:t.jsx(I,{className:"w-5 h-5 text-blue-600"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Referrals"}),t.jsx("p",{className:"text-2xl font-bold",children:me.totalReferrals})]})]})})}),t.jsx(l,{children:t.jsx(d,{className:"pt-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:t.jsx(T,{className:"w-5 h-5 text-green-600"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Earned"}),t.jsxs("p",{className:"text-2xl font-bold",children:["$",me.totalEarned.toFixed(2)]})]})]})})}),t.jsx(l,{children:t.jsx(d,{className:"pt-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:t.jsx(B,{className:"w-5 h-5 text-amber-600"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Pending"}),t.jsxs("p",{className:"text-2xl font-bold",children:["$",me.pendingCommission.toFixed(2)]})]})]})})}),t.jsx(l,{children:t.jsx(d,{className:"pt-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:t.jsx(M,{className:"w-5 h-5 text-purple-600"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Paid Out"}),t.jsxs("p",{className:"text-2xl font-bold",children:["$",me.paidCommission.toFixed(2)]})]})]})})}),t.jsx(l,{children:t.jsx(d,{className:"pt-6",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:t.jsx(H,{className:"w-5 h-5 text-indigo-600"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Codes"}),t.jsx("p",{className:"text-2xl font-bold",children:me.activeCodes})]})]})})})]}),t.jsxs(P,{value:ce,onValueChange:oe,children:[t.jsxs(S,{className:"mb-4",children:[t.jsx(A,{value:"overview",children:"Overview"}),t.jsxs(A,{value:"referrals",children:["Referrals (",te.length,")"]}),t.jsxs(A,{value:"payouts",children:["Payouts (",ne.length,")"]}),t.jsxs(A,{value:"codes",children:["Codes (",se.length,")"]})]}),t.jsx(F,{value:"overview",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs(l,{children:[t.jsx(c,{children:t.jsxs(o,{className:"flex items-center gap-2",children:["organization"===Z.type?t.jsx(J,{className:"w-5 h-5"}):t.jsx(U,{className:"w-5 h-5"}),"Affiliate Details"]})}),t.jsxs(d,{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(V,{className:"w-4 h-4 text-muted-foreground"}),t.jsx("span",{children:Z.email})]}),Z.phone&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(W,{className:"w-4 h-4 text-muted-foreground"}),t.jsx("span",{children:Z.phone})]}),Z.contact_person&&t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(U,{className:"w-4 h-4 text-muted-foreground"}),t.jsxs("span",{children:["Contact: ",Z.contact_person]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(T,{className:"w-4 h-4 text-muted-foreground"}),t.jsxs("span",{children:["Commission Rate: ",Z.commission_percent,"%"]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(Q,{className:"w-4 h-4 text-muted-foreground"}),t.jsxs("span",{children:["Joined: ",new Date(Z.created_at).toLocaleDateString()]})]}),Z.notes&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(X,{className:"w-4 h-4 text-muted-foreground mt-1"}),t.jsx("span",{className:"text-muted-foreground",children:Z.notes})]}),t.jsx("div",{className:"pt-4",children:t.jsx(m,{variant:"active"===Z.status?"default":"secondary",children:Z.status})})]})]}),t.jsxs(l,{children:[t.jsx(c,{className:"flex flex-row items-center justify-between",children:t.jsxs(o,{className:"flex items-center gap-2",children:[t.jsx(G,{className:"w-5 h-5"}),"Quick Payout"]})}),t.jsx(d,{children:me.pendingCommission>0?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"p-4 bg-amber-50 rounded-lg border border-amber-200",children:[t.jsx("p",{className:"text-sm text-amber-700",children:"Pending commission to pay out:"}),t.jsxs("p",{className:"text-3xl font-bold text-amber-900",children:["$",me.pendingCommission.toFixed(2)]})]}),t.jsxs(r,{className:"w-full",onClick:()=>je(!0),children:[t.jsx(T,{className:"w-4 h-4 mr-2"})," Create Payout"]})]}):t.jsxs("div",{className:"text-center py-6 text-muted-foreground",children:[t.jsx(M,{className:"w-12 h-12 mx-auto mb-2 text-green-500"}),t.jsx("p",{children:"All commissions have been paid out!"})]})})]})]})}),t.jsx(F,{value:"referrals",children:t.jsxs(l,{children:[t.jsxs(c,{children:[t.jsx(o,{children:"Referral History"}),t.jsx(x,{children:"All successful referrals from this affiliate"})]}),t.jsx(d,{children:0===te.length?t.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No referrals yet"}):t.jsxs(k,{children:[t.jsx($,{children:t.jsxs(D,{children:[t.jsx(R,{children:"Date"}),t.jsx(R,{children:"Code Used"}),t.jsx(R,{children:"Plan"}),t.jsx(R,{children:"Original"}),t.jsx(R,{children:"Discount"}),t.jsx(R,{children:"Paid"}),t.jsx(R,{children:"Commission"}),t.jsx(R,{children:"Status"})]})}),t.jsx(q,{children:te.map(e=>{var s;return t.jsxs(D,{children:[t.jsx(E,{children:new Date(e.created_at).toLocaleDateString()}),t.jsx(E,{children:t.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm",children:(null==(s=e.affiliate_code)?void 0:s.code)||"N/A"})}),t.jsx(E,{children:e.plan_id||"N/A"}),t.jsxs(E,{children:["$",e.original_amount.toFixed(2)]}),t.jsxs(E,{className:"text-red-600",children:["-$",e.discount_amount.toFixed(2)]}),t.jsxs(E,{children:["$",e.final_amount.toFixed(2)]}),t.jsxs(E,{className:"text-green-600 font-medium",children:["$",e.commission_amount.toFixed(2)]}),t.jsx(E,{children:t.jsx(m,{variant:"paid"===e.commission_status?"default":"pending"===e.commission_status?"secondary":"outline",children:e.commission_status})})]},e.id)})})]})})]})}),t.jsx(F,{value:"payouts",children:t.jsxs(l,{children:[t.jsxs(c,{className:"flex flex-row items-center justify-between",children:[t.jsxs("div",{children:[t.jsx(o,{children:"Payout History"}),t.jsx(x,{children:"Record of all payouts to this affiliate"})]}),t.jsxs(r,{onClick:()=>je(!0),children:[t.jsx(T,{className:"w-4 h-4 mr-2"})," New Payout"]})]}),t.jsx(d,{children:0===ne.length?t.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No payouts yet"}):t.jsxs(k,{children:[t.jsx($,{children:t.jsxs(D,{children:[t.jsx(R,{children:"Date"}),t.jsx(R,{children:"Amount"}),t.jsx(R,{children:"Method"}),t.jsx(R,{children:"Reference"}),t.jsx(R,{children:"Notes"}),t.jsx(R,{children:"Status"}),t.jsx(R,{className:"text-right",children:"Actions"})]})}),t.jsx(q,{children:ne.map(e=>t.jsxs(D,{children:[t.jsx(E,{children:new Date(e.created_at).toLocaleDateString()}),t.jsxs(E,{className:"font-medium",children:["$",e.amount.toFixed(2)]}),t.jsx(E,{children:e.payment_method||"-"}),t.jsx(E,{className:"max-w-[150px] truncate",children:e.payment_reference||"-"}),t.jsx(E,{className:"max-w-[200px] truncate",children:e.notes||"-"}),t.jsx(E,{children:t.jsx(m,{variant:"paid"===e.status?"default":"processing"===e.status?"secondary":"failed"===e.status?"destructive":"outline",children:e.status})}),t.jsxs(E,{className:"text-right",children:["pending"===e.status&&t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(r,{variant:"outline",size:"sm",onClick:()=>Ne(e,"processing"),children:"Processing"}),t.jsx(r,{size:"sm",onClick:()=>Ne(e,"paid"),children:"Mark Paid"})]}),"processing"===e.status&&t.jsx(r,{size:"sm",onClick:()=>Ne(e,"paid"),children:"Mark Paid"})]})]},e.id))})]})})]})}),t.jsx(F,{value:"codes",children:t.jsxs(l,{children:[t.jsxs(c,{children:[t.jsx(o,{children:"Promo Codes"}),t.jsx(x,{children:"All codes assigned to this affiliate"})]}),t.jsx(d,{children:0===se.length?t.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No codes created yet"}):t.jsxs(k,{children:[t.jsx($,{children:t.jsxs(D,{children:[t.jsx(R,{children:"Code"}),t.jsx(R,{children:"Discount"}),t.jsx(R,{children:"Redemptions"}),t.jsx(R,{children:"Status"}),t.jsx(R,{children:"Created"})]})}),t.jsx(q,{children:se.map(e=>t.jsxs(D,{children:[t.jsx(E,{children:t.jsx("code",{className:"bg-muted px-2 py-1 rounded font-mono",children:e.code})}),t.jsx(E,{children:"percent"===e.discount_type?`${e.discount_value}% off`:`$${e.discount_value} off`}),t.jsxs(E,{children:[e.current_redemptions," / ",e.max_redemptions||"∞"]}),t.jsx(E,{children:t.jsx(m,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})}),t.jsx(E,{children:new Date(e.created_at).toLocaleDateString()})]},e.id))})]})})]})})]}),t.jsx(h,{open:he,onOpenChange:je,children:t.jsxs(j,{className:"sm:max-w-[450px]",children:[t.jsxs(u,{children:[t.jsx(p,{children:"Create Payout"}),t.jsxs(f,{children:["Record a payout to ",Z.name]})]}),t.jsxs("div",{className:"space-y-4 py-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"amount",children:"Amount ($)"}),t.jsx(v,{id:"amount",type:"number",min:"0",step:"0.01",value:ue.amount,onChange:e=>pe({...ue,amount:parseFloat(e.target.value)||0})}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Pending commission: $",me.pendingCommission.toFixed(2)]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"payment_method",children:"Payment Method"}),t.jsxs(N,{value:ue.payment_method,onValueChange:e=>pe({...ue,payment_method:e}),children:[t.jsx(y,{children:t.jsx(_,{placeholder:"Select method..."})}),t.jsxs(w,{children:[t.jsx(b,{value:"bank_transfer",children:"Bank Transfer"}),t.jsx(b,{value:"paypal",children:"PayPal"}),t.jsx(b,{value:"wise",children:"Wise"}),t.jsx(b,{value:"crypto",children:"Cryptocurrency"}),t.jsx(b,{value:"other",children:"Other"})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"reference",children:"Payment Reference"}),t.jsx(v,{id:"reference",value:ue.payment_reference,onChange:e=>pe({...ue,payment_reference:e.target.value}),placeholder:"Transaction ID..."})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"notes",children:"Notes"}),t.jsx(v,{id:"notes",value:ue.notes,onChange:e=>pe({...ue,notes:e.target.value}),placeholder:"Additional notes..."})]})]}),t.jsxs(C,{children:[t.jsx(r,{variant:"outline",onClick:()=>je(!1),children:"Cancel"}),t.jsxs(r,{onClick:async()=>{if(!Z||ue.amount<=0)n.error("Please enter a valid amount");else{ge(!0);try{const{error:e}=await i.from("affiliate_payouts").insert({affiliate_id:Z.id,amount:ue.amount,currency:"usd",status:"pending",payment_method:ue.payment_method||null,payment_reference:ue.payment_reference||null,notes:ue.notes||null});if(e)throw e;n.success("Payout record created"),je(!1),pe({amount:0,payment_method:"",payment_reference:"",notes:""}),ve()}catch(e){console.error("Error creating payout:",e),n.error(e.message||"Failed to create payout")}finally{ge(!1)}}},disabled:fe||ue.amount<=0,children:[fe&&t.jsx(L,{className:"w-4 h-4 mr-2 animate-spin"}),"Create Payout"]})]})]})})]}):t.jsx(z,{title:"Affiliate Not Found",children:t.jsxs("div",{className:"text-center py-12",children:[t.jsx("p",{className:"text-muted-foreground mb-4",children:"Affiliate not found"}),t.jsxs(r,{onClick:()=>K("/admin/affiliates"),children:[t.jsx(O,{className:"w-4 h-4 mr-2"})," Back to Affiliates"]})]})})};export{K as default};
