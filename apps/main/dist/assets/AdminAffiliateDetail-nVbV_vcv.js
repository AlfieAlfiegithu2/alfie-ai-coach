import{u as e,G as s,r as a,J as t,j as i,ap as n,B as r,ai as l,C as d,a as c,af as o,R as m,x,b as h,d as j,ad as u,ag as f,F as p,l as g,aq as N,y as v,D as y,m as _,n as w,o as b,bo as C,O as P,I as S,S as F,p as A,q as k,s as D,t as $,cc as R}from"./index-Dbr7DlF4.js";import{T as q,a as E,b as O,c as T}from"./tabs-mzfnconq.js";import{T as z,a as I,b as L,c as B,d as M,e as H}from"./table-TgQsJgbC.js";import{A as J}from"./AdminLayout-Duzzfzn2.js";import{s as V}from"./supabase-DWL4C3fA.js";import{D as G}from"./dollar-sign-BtumWTgn.js";import{T as Q}from"./tag-zScntxZy.js";import{B as U}from"./building-2-DjiPEQ86.js";import{M as W}from"./mail-CEVetjG-.js";import{P as Z}from"./phone-CgC__11W.js";const K=()=>{const K=e(),{affiliateId:X}=s(),[Y,ee]=a.useState(null),[se,ae]=a.useState([]),[te,ie]=a.useState([]),[ne,re]=a.useState([]),[le,de]=a.useState(!0),[ce,oe]=a.useState("overview"),[me,xe]=a.useState({totalReferrals:0,totalEarned:0,pendingCommission:0,paidCommission:0,activeCodes:0}),[he,je]=a.useState(!1),[ue,fe]=a.useState({amount:0,payment_method:"",payment_reference:"",notes:""}),[pe,ge]=a.useState(!1);a.useEffect(()=>{X&&Ne()},[X]);const Ne=async()=>{if(X){de(!0);try{const{data:e,error:s}=await V.from("affiliates").select("*").eq("id",X).single();if(s)throw s;ee(e);const{data:a,error:t}=await V.from("affiliate_codes").select("*").eq("affiliate_id",X).order("created_at",{ascending:!1});if(t)throw t;ae(a||[]);const{data:i,error:n}=await V.from("affiliate_referrals").select("\n          *,\n          affiliate_code:affiliate_codes(code)\n        ").eq("affiliate_id",X).order("created_at",{ascending:!1});if(n)throw n;ie(i||[]);const{data:r,error:l}=await V.from("affiliate_payouts").select("*").eq("affiliate_id",X).order("created_at",{ascending:!1});if(l)throw l;re(r||[]);const d=(i||[]).reduce((e,s)=>e+s.commission_amount,0),c=(i||[]).filter(e=>"pending"===e.commission_status).reduce((e,s)=>e+s.commission_amount,0),o=(r||[]).filter(e=>"paid"===e.status).reduce((e,s)=>e+s.amount,0);xe({totalReferrals:(null==i?void 0:i.length)||0,totalEarned:d,pendingCommission:c,paidCommission:o,activeCodes:(a||[]).filter(e=>e.is_active).length}),fe(e=>({...e,amount:c}))}catch(e){console.error("Error loading affiliate data:",e),t.error("Failed to load affiliate data")}finally{de(!1)}}},ve=async(e,s)=>{try{const a={status:s};"paid"===s&&(a.paid_at=(new Date).toISOString());const{error:i}=await V.from("affiliate_payouts").update(a).eq("id",e.id);if(i)throw i;"paid"===s&&await V.from("affiliate_referrals").update({commission_status:"paid"}).eq("affiliate_id",null==Y?void 0:Y.id).eq("commission_status","pending"),t.success(`Payout marked as ${s}`),Ne()}catch(a){console.error("Error updating payout:",a),t.error("Failed to update payout")}};return le?i.jsx(J,{title:"Loading...",children:i.jsx("div",{className:"flex justify-center py-12",children:i.jsx(n,{className:"w-8 h-8 animate-spin"})})}):Y?i.jsxs(J,{title:Y.name,description:`${"organization"===Y.type?"Organization":"Individual"} • ${Y.email}`,children:[i.jsxs(r,{variant:"outline",className:"mb-4",onClick:()=>K("/admin/affiliates"),children:[i.jsx(l,{className:"w-4 h-4 mr-2"})," Back to Affiliates"]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 mb-6",children:[i.jsx(d,{children:i.jsx(c,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:i.jsx(o,{className:"w-5 h-5 text-blue-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Referrals"}),i.jsx("p",{className:"text-2xl font-bold",children:me.totalReferrals})]})]})})}),i.jsx(d,{children:i.jsx(c,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:i.jsx(G,{className:"w-5 h-5 text-green-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Earned"}),i.jsxs("p",{className:"text-2xl font-bold",children:["$",me.totalEarned.toFixed(2)]})]})]})})}),i.jsx(d,{children:i.jsx(c,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:i.jsx(m,{className:"w-5 h-5 text-amber-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Pending"}),i.jsxs("p",{className:"text-2xl font-bold",children:["$",me.pendingCommission.toFixed(2)]})]})]})})}),i.jsx(d,{children:i.jsx(c,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:i.jsx(x,{className:"w-5 h-5 text-purple-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Paid Out"}),i.jsxs("p",{className:"text-2xl font-bold",children:["$",me.paidCommission.toFixed(2)]})]})]})})}),i.jsx(d,{children:i.jsx(c,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-indigo-100 rounded-lg",children:i.jsx(Q,{className:"w-5 h-5 text-indigo-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Codes"}),i.jsx("p",{className:"text-2xl font-bold",children:me.activeCodes})]})]})})})]}),i.jsxs(q,{value:ce,onValueChange:oe,children:[i.jsxs(E,{className:"mb-4",children:[i.jsx(O,{value:"overview",children:"Overview"}),i.jsxs(O,{value:"referrals",children:["Referrals (",te.length,")"]}),i.jsxs(O,{value:"payouts",children:["Payouts (",ne.length,")"]}),i.jsxs(O,{value:"codes",children:["Codes (",se.length,")"]})]}),i.jsx(T,{value:"overview",children:i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[i.jsxs(d,{children:[i.jsx(h,{children:i.jsxs(j,{className:"flex items-center gap-2",children:["organization"===Y.type?i.jsx(U,{className:"w-5 h-5"}):i.jsx(u,{className:"w-5 h-5"}),"Affiliate Details"]})}),i.jsxs(c,{className:"space-y-4",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(W,{className:"w-4 h-4 text-muted-foreground"}),i.jsx("span",{children:Y.email})]}),Y.phone&&i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(Z,{className:"w-4 h-4 text-muted-foreground"}),i.jsx("span",{children:Y.phone})]}),Y.contact_person&&i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(u,{className:"w-4 h-4 text-muted-foreground"}),i.jsxs("span",{children:["Contact: ",Y.contact_person]})]}),i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(G,{className:"w-4 h-4 text-muted-foreground"}),i.jsxs("span",{children:["Commission Rate: ",Y.commission_percent,"%"]})]}),i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx(f,{className:"w-4 h-4 text-muted-foreground"}),i.jsxs("span",{children:["Joined: ",new Date(Y.created_at).toLocaleDateString()]})]}),Y.notes&&i.jsxs("div",{className:"flex items-start gap-3",children:[i.jsx(p,{className:"w-4 h-4 text-muted-foreground mt-1"}),i.jsx("span",{className:"text-muted-foreground",children:Y.notes})]}),i.jsx("div",{className:"pt-4",children:i.jsx(g,{variant:"active"===Y.status?"default":"secondary",children:Y.status})})]})]}),i.jsxs(d,{children:[i.jsx(h,{className:"flex flex-row items-center justify-between",children:i.jsxs(j,{className:"flex items-center gap-2",children:[i.jsx(N,{className:"w-5 h-5"}),"Quick Payout"]})}),i.jsx(c,{children:me.pendingCommission>0?i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"p-4 bg-amber-50 rounded-lg border border-amber-200",children:[i.jsx("p",{className:"text-sm text-amber-700",children:"Pending commission to pay out:"}),i.jsxs("p",{className:"text-3xl font-bold text-amber-900",children:["$",me.pendingCommission.toFixed(2)]})]}),i.jsxs(r,{className:"w-full",onClick:()=>je(!0),children:[i.jsx(G,{className:"w-4 h-4 mr-2"})," Create Payout"]})]}):i.jsxs("div",{className:"text-center py-6 text-muted-foreground",children:[i.jsx(x,{className:"w-12 h-12 mx-auto mb-2 text-green-500"}),i.jsx("p",{children:"All commissions have been paid out!"})]})})]})]})}),i.jsx(T,{value:"referrals",children:i.jsxs(d,{children:[i.jsxs(h,{children:[i.jsx(j,{children:"Referral History"}),i.jsx(v,{children:"All successful referrals from this affiliate"})]}),i.jsx(c,{children:0===te.length?i.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No referrals yet"}):i.jsxs(z,{children:[i.jsx(I,{children:i.jsxs(L,{children:[i.jsx(B,{children:"Date"}),i.jsx(B,{children:"Code Used"}),i.jsx(B,{children:"Plan"}),i.jsx(B,{children:"Original"}),i.jsx(B,{children:"Discount"}),i.jsx(B,{children:"Paid"}),i.jsx(B,{children:"Commission"}),i.jsx(B,{children:"Status"})]})}),i.jsx(M,{children:te.map(e=>{var s;return i.jsxs(L,{children:[i.jsx(H,{children:new Date(e.created_at).toLocaleDateString()}),i.jsx(H,{children:i.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm",children:(null==(s=e.affiliate_code)?void 0:s.code)||"N/A"})}),i.jsx(H,{children:e.plan_id||"N/A"}),i.jsxs(H,{children:["$",e.original_amount.toFixed(2)]}),i.jsxs(H,{className:"text-red-600",children:["-$",e.discount_amount.toFixed(2)]}),i.jsxs(H,{children:["$",e.final_amount.toFixed(2)]}),i.jsxs(H,{className:"text-green-600 font-medium",children:["$",e.commission_amount.toFixed(2)]}),i.jsx(H,{children:i.jsx(g,{variant:"paid"===e.commission_status?"default":"pending"===e.commission_status?"secondary":"outline",children:e.commission_status})})]},e.id)})})]})})]})}),i.jsx(T,{value:"payouts",children:i.jsxs(d,{children:[i.jsxs(h,{className:"flex flex-row items-center justify-between",children:[i.jsxs("div",{children:[i.jsx(j,{children:"Payout History"}),i.jsx(v,{children:"Record of all payouts to this affiliate"})]}),i.jsxs(r,{onClick:()=>je(!0),children:[i.jsx(G,{className:"w-4 h-4 mr-2"})," New Payout"]})]}),i.jsx(c,{children:0===ne.length?i.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No payouts yet"}):i.jsxs(z,{children:[i.jsx(I,{children:i.jsxs(L,{children:[i.jsx(B,{children:"Date"}),i.jsx(B,{children:"Amount"}),i.jsx(B,{children:"Method"}),i.jsx(B,{children:"Reference"}),i.jsx(B,{children:"Notes"}),i.jsx(B,{children:"Status"}),i.jsx(B,{className:"text-right",children:"Actions"})]})}),i.jsx(M,{children:ne.map(e=>i.jsxs(L,{children:[i.jsx(H,{children:new Date(e.created_at).toLocaleDateString()}),i.jsxs(H,{className:"font-medium",children:["$",e.amount.toFixed(2)]}),i.jsx(H,{children:e.payment_method||"-"}),i.jsx(H,{className:"max-w-[150px] truncate",children:e.payment_reference||"-"}),i.jsx(H,{className:"max-w-[200px] truncate",children:e.notes||"-"}),i.jsx(H,{children:i.jsx(g,{variant:"paid"===e.status?"default":"processing"===e.status?"secondary":"failed"===e.status?"destructive":"outline",children:e.status})}),i.jsxs(H,{className:"text-right",children:["pending"===e.status&&i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsx(r,{variant:"outline",size:"sm",onClick:()=>ve(e,"processing"),children:"Processing"}),i.jsx(r,{size:"sm",onClick:()=>ve(e,"paid"),children:"Mark Paid"})]}),"processing"===e.status&&i.jsx(r,{size:"sm",onClick:()=>ve(e,"paid"),children:"Mark Paid"})]})]},e.id))})]})})]})}),i.jsx(T,{value:"codes",children:i.jsxs(d,{children:[i.jsxs(h,{children:[i.jsx(j,{children:"Promo Codes"}),i.jsx(v,{children:"All codes assigned to this affiliate"})]}),i.jsx(c,{children:0===se.length?i.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No codes created yet"}):i.jsxs(z,{children:[i.jsx(I,{children:i.jsxs(L,{children:[i.jsx(B,{children:"Code"}),i.jsx(B,{children:"Discount"}),i.jsx(B,{children:"Redemptions"}),i.jsx(B,{children:"Status"}),i.jsx(B,{children:"Created"})]})}),i.jsx(M,{children:se.map(e=>i.jsxs(L,{children:[i.jsx(H,{children:i.jsx("code",{className:"bg-muted px-2 py-1 rounded font-mono",children:e.code})}),i.jsx(H,{children:"percent"===e.discount_type?`${e.discount_value}% off`:`$${e.discount_value} off`}),i.jsxs(H,{children:[e.current_redemptions," / ",e.max_redemptions||"∞"]}),i.jsx(H,{children:i.jsx(g,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})}),i.jsx(H,{children:new Date(e.created_at).toLocaleDateString()})]},e.id))})]})})]})})]}),i.jsx(y,{open:he,onOpenChange:je,children:i.jsxs(_,{className:"sm:max-w-[450px]",children:[i.jsxs(w,{children:[i.jsx(b,{children:"Create Payout"}),i.jsxs(C,{children:["Record a payout to ",Y.name]})]}),i.jsxs("div",{className:"space-y-4 py-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(P,{htmlFor:"amount",children:"Amount ($)"}),i.jsx(S,{id:"amount",type:"number",min:"0",step:"0.01",value:ue.amount,onChange:e=>fe({...ue,amount:parseFloat(e.target.value)||0})}),i.jsxs("p",{className:"text-xs text-muted-foreground",children:["Pending commission: $",me.pendingCommission.toFixed(2)]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(P,{htmlFor:"payment_method",children:"Payment Method"}),i.jsxs(F,{value:ue.payment_method,onValueChange:e=>fe({...ue,payment_method:e}),children:[i.jsx(A,{children:i.jsx(k,{placeholder:"Select method..."})}),i.jsxs(D,{children:[i.jsx($,{value:"bank_transfer",children:"Bank Transfer"}),i.jsx($,{value:"paypal",children:"PayPal"}),i.jsx($,{value:"wise",children:"Wise"}),i.jsx($,{value:"crypto",children:"Cryptocurrency"}),i.jsx($,{value:"other",children:"Other"})]})]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(P,{htmlFor:"reference",children:"Payment Reference"}),i.jsx(S,{id:"reference",value:ue.payment_reference,onChange:e=>fe({...ue,payment_reference:e.target.value}),placeholder:"Transaction ID..."})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(P,{htmlFor:"notes",children:"Notes"}),i.jsx(S,{id:"notes",value:ue.notes,onChange:e=>fe({...ue,notes:e.target.value}),placeholder:"Additional notes..."})]})]}),i.jsxs(R,{children:[i.jsx(r,{variant:"outline",onClick:()=>je(!1),children:"Cancel"}),i.jsxs(r,{onClick:async()=>{if(!Y||ue.amount<=0)t.error("Please enter a valid amount");else{ge(!0);try{const{error:e}=await V.from("affiliate_payouts").insert({affiliate_id:Y.id,amount:ue.amount,currency:"usd",status:"pending",payment_method:ue.payment_method||null,payment_reference:ue.payment_reference||null,notes:ue.notes||null});if(e)throw e;t.success("Payout record created"),je(!1),fe({amount:0,payment_method:"",payment_reference:"",notes:""}),Ne()}catch(e){console.error("Error creating payout:",e),t.error(e.message||"Failed to create payout")}finally{ge(!1)}}},disabled:pe||ue.amount<=0,children:[pe&&i.jsx(n,{className:"w-4 h-4 mr-2 animate-spin"}),"Create Payout"]})]})]})})]}):i.jsx(J,{title:"Affiliate Not Found",children:i.jsxs("div",{className:"text-center py-12",children:[i.jsx("p",{className:"text-muted-foreground mb-4",children:"Affiliate not found"}),i.jsxs(r,{onClick:()=>K("/admin/affiliates"),children:[i.jsx(l,{className:"w-4 h-4 mr-2"})," Back to Affiliates"]})]})})};export{K as default};
