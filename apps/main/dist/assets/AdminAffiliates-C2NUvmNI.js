import{u as e,r as s,j as a}from"./vendor-react-rLLBBC7n.js";import{s as i,J as t,C as r,a as l,b as n,c,o,B as d,e as m,D as x,f as h,g as j,h as p,W as u,L as f,I as v,S as g,i as N,j as y,k as _,l as C,X as w}from"./index-BDl0jLJK.js";import{T as A,a as b,b as F,c as S}from"./tabs-CFW1rRMF.js";import{A as k,a as E,b as T,c as D,d as z,e as R,f as M,g as q,h as U}from"./alert-dialog-C3e0CSUs.js";import{T as $,a as P,b as I,c as V,d as L,e as O}from"./table-BylhXb36.js";import{A as J}from"./AdminLayout-DwaN-V0p.js";import{aZ as X,q as B,H as G,ct as H,av as W,y as Y,cu as Z,U as K,cp as Q,aN as ee,aX as se,aY as ae,X as ie,E as te}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const re=()=>{const re=e(),[le,ne]=s.useState([]),[ce,oe]=s.useState(!0),[de,me]=s.useState("affiliates"),[xe,he]=s.useState(!1),[je,pe]=s.useState(null),[ue,fe]=s.useState({name:"",email:"",type:"individual",commission_percent:10,contact_person:"",phone:"",notes:""}),[ve,ge]=s.useState(!1),[Ne,ye]=s.useState(null),[_e,Ce]=s.useState([]),[we,Ae]=s.useState(!1),[be,Fe]=s.useState({code:"",discount_type:"percent",discount_value:10,currency:"usd",max_redemptions:"",expires_at:""}),[Se,ke]=s.useState(!1),[Ee,Te]=s.useState(null),[De,ze]=s.useState({totalAffiliates:0,activeAffiliates:0,totalReferrals:0,totalCommission:0});s.useEffect(()=>{Re()},[]),s.useEffect(()=>{Ne&&Me(Ne.id)},[Ne]);const Re=async()=>{try{oe(!0);const{data:e,error:s}=await i.from("affiliates").select("\n          *,\n          affiliate_codes(count),\n          affiliate_referrals(\n            commission_amount\n          )\n        ").order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map(e=>{var s,a,i,t;return{...e,codes_count:(null==(a=null==(s=e.affiliate_codes)?void 0:s[0])?void 0:a.count)||0,total_referrals:(null==(i=e.affiliate_referrals)?void 0:i.length)||0,total_commission:(null==(t=e.affiliate_referrals)?void 0:t.reduce((e,s)=>e+(s.commission_amount||0),0))||0}});ne(a),ze({totalAffiliates:a.length,activeAffiliates:a.filter(e=>"active"===e.status).length,totalReferrals:a.reduce((e,s)=>e+(s.total_referrals||0),0),totalCommission:a.reduce((e,s)=>e+(s.total_commission||0),0)})}catch(e){console.error("Error loading affiliates:",e),t.error("Failed to load affiliates")}finally{oe(!1)}},Me=async e=>{try{const{data:s,error:a}=await i.from("affiliate_codes").select("*").eq("affiliate_id",e).order("created_at",{ascending:!1});if(a)throw a;Ce(s||[])}catch(s){console.error("Error loading codes:",s),t.error("Failed to load affiliate codes")}},qe=()=>{fe({name:"",email:"",type:"individual",commission_percent:10,contact_person:"",phone:"",notes:""})},Ue=()=>{Fe({code:"",discount_type:"percent",discount_value:10,currency:"usd",max_redemptions:"",expires_at:""})};return a.jsxs(J,{title:"Affiliate Management",description:"Manage affiliates, promo codes, and track referrals",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[a.jsx(r,{children:a.jsx(l,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:a.jsx(X,{className:"w-5 h-5 text-blue-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Affiliates"}),a.jsx("p",{className:"text-2xl font-bold",children:De.totalAffiliates})]})]})})}),a.jsx(r,{children:a.jsx(l,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:a.jsx(B,{className:"w-5 h-5 text-green-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Affiliates"}),a.jsx("p",{className:"text-2xl font-bold",children:De.activeAffiliates})]})]})})}),a.jsx(r,{children:a.jsx(l,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:a.jsx(G,{className:"w-5 h-5 text-purple-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Referrals"}),a.jsx("p",{className:"text-2xl font-bold",children:De.totalReferrals})]})]})})}),a.jsx(r,{children:a.jsx(l,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:a.jsx(H,{className:"w-5 h-5 text-amber-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Commission"}),a.jsxs("p",{className:"text-2xl font-bold",children:["$",De.totalCommission.toFixed(2)]})]})]})})})]}),a.jsxs(A,{value:de,onValueChange:me,children:[a.jsxs(b,{className:"mb-4",children:[a.jsx(F,{value:"affiliates",children:"Affiliates"}),a.jsxs(F,{value:"codes",disabled:!Ne,children:["Codes ",Ne&&`(${Ne.name})`]})]}),a.jsx(S,{value:"affiliates",children:a.jsxs(r,{children:[a.jsxs(n,{className:"flex flex-row items-center justify-between",children:[a.jsxs("div",{children:[a.jsx(c,{children:"Affiliates"}),a.jsx(o,{children:"Manage your affiliate partners"})]}),a.jsxs(d,{onClick:()=>{qe(),pe(null),he(!0)},children:[a.jsx(W,{className:"w-4 h-4 mr-2"})," Add Affiliate"]})]}),a.jsx(l,{children:ce?a.jsx("div",{className:"flex justify-center py-8",children:a.jsx(Y,{className:"w-6 h-6 animate-spin"})}):0===le.length?a.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No affiliates yet. Create your first affiliate to get started."}):a.jsxs($,{children:[a.jsx(P,{children:a.jsxs(I,{children:[a.jsx(V,{children:"Name"}),a.jsx(V,{children:"Type"}),a.jsx(V,{children:"Commission"}),a.jsx(V,{children:"Codes"}),a.jsx(V,{children:"Referrals"}),a.jsx(V,{children:"Earned"}),a.jsx(V,{children:"Status"}),a.jsx(V,{className:"text-right",children:"Actions"})]})}),a.jsx(L,{children:le.map(e=>a.jsxs(I,{children:[a.jsx(O,{children:a.jsxs("div",{children:[a.jsx("p",{className:"font-medium",children:e.name}),a.jsx("p",{className:"text-sm text-muted-foreground",children:e.email})]})}),a.jsx(O,{children:a.jsxs(m,{variant:"outline",className:"gap-1",children:["organization"===e.type?a.jsx(Z,{className:"w-3 h-3"}):a.jsx(K,{className:"w-3 h-3"}),e.type]})}),a.jsxs(O,{children:[e.commission_percent,"%"]}),a.jsx(O,{children:e.codes_count||0}),a.jsx(O,{children:e.total_referrals||0}),a.jsxs(O,{children:["$",(e.total_commission||0).toFixed(2)]}),a.jsx(O,{children:a.jsx(m,{variant:"active"===e.status?"default":"secondary",children:e.status})}),a.jsx(O,{className:"text-right",children:a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{ye(e),me("codes")},children:[a.jsx(Q,{className:"w-4 h-4 mr-1"})," Codes"]}),a.jsx(d,{variant:"outline",size:"sm",onClick:()=>re(`/admin/affiliates/${e.id}`),children:a.jsx(ee,{className:"w-4 h-4"})}),a.jsx(d,{variant:"outline",size:"sm",onClick:()=>(e=>{pe(e),fe({name:e.name,email:e.email,type:e.type,commission_percent:e.commission_percent,contact_person:e.contact_person||"",phone:e.phone||"",notes:e.notes||""}),he(!0)})(e),children:a.jsx(se,{className:"w-4 h-4"})}),a.jsx(d,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const{error:s}=await i.from("affiliates").update({status:"active"===e.status?"inactive":"active"}).eq("id",e.id);if(s)throw s;t.success("Affiliate "+("active"===e.status?"deactivated":"activated")),Re()}catch(s){console.error("Error toggling status:",s),t.error("Failed to update status")}})(e),children:"active"===e.status?"Deactivate":"Activate"}),a.jsxs(k,{children:[a.jsx(E,{asChild:!0,children:a.jsx(d,{variant:"destructive",size:"sm",children:a.jsx(ae,{className:"w-4 h-4"})})}),a.jsxs(T,{children:[a.jsxs(D,{children:[a.jsx(z,{children:"Delete Affiliate?"}),a.jsx(R,{children:"This will delete the affiliate and all their codes. This action cannot be undone."})]}),a.jsxs(M,{children:[a.jsx(q,{children:"Cancel"}),a.jsx(U,{onClick:()=>(async e=>{try{const{error:s}=await i.from("affiliates").delete().eq("id",e.id);if(s)throw s;t.success("Affiliate deleted"),Re()}catch(s){console.error("Error deleting affiliate:",s),t.error(s.message||"Failed to delete affiliate")}})(e),children:"Delete"})]})]})]})]})})]},e.id))})]})})]})}),a.jsx(S,{value:"codes",children:Ne&&a.jsxs(r,{children:[a.jsxs(n,{className:"flex flex-row items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs(c,{children:["Promo Codes for ",Ne.name]}),a.jsxs(o,{children:["Commission rate: ",Ne.commission_percent,"%"]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(d,{variant:"outline",onClick:()=>{ye(null),me("affiliates")},children:[a.jsx(ie,{className:"w-4 h-4 mr-2"})," Close"]}),a.jsxs(d,{onClick:()=>{Ue(),Ae(!0)},children:[a.jsx(W,{className:"w-4 h-4 mr-2"})," Create Code"]})]})]}),a.jsx(l,{children:0===_e.length?a.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No codes yet. Create a promo code for this affiliate."}):a.jsxs($,{children:[a.jsx(P,{children:a.jsxs(I,{children:[a.jsx(V,{children:"Code"}),a.jsx(V,{children:"Discount"}),a.jsx(V,{children:"Redemptions"}),a.jsx(V,{children:"Expires"}),a.jsx(V,{children:"Status"}),a.jsx(V,{className:"text-right",children:"Actions"})]})}),a.jsx(L,{children:_e.map(e=>a.jsxs(I,{children:[a.jsx(O,{children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("code",{className:"bg-muted px-2 py-1 rounded font-mono text-sm",children:e.code}),a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>(e=>{navigator.clipboard.writeText(e),Te(e),setTimeout(()=>Te(null),2e3),t.success("Code copied!")})(e.code),children:Ee===e.code?a.jsx(B,{className:"w-4 h-4 text-green-500"}):a.jsx(te,{className:"w-4 h-4"})})]})}),a.jsx(O,{children:"percent"===e.discount_type?`${e.discount_value}% off`:`$${e.discount_value} off`}),a.jsxs(O,{children:[e.current_redemptions," / ",e.max_redemptions||"âˆž"]}),a.jsx(O,{children:e.expires_at?new Date(e.expires_at).toLocaleDateString():"Never"}),a.jsx(O,{children:a.jsx(m,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})}),a.jsx(O,{className:"text-right",children:a.jsx(d,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const{error:s}=await i.from("affiliate_codes").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;t.success("Code "+(e.is_active?"deactivated":"activated")),Ne&&Me(Ne.id)}catch(s){console.error("Error toggling code:",s),t.error("Failed to update code")}})(e),children:e.is_active?"Deactivate":"Activate"})})]},e.id))})]})})]})})]}),a.jsx(x,{open:xe,onOpenChange:he,children:a.jsxs(h,{className:"sm:max-w-[500px]",children:[a.jsxs(j,{children:[a.jsx(p,{children:je?"Edit Affiliate":"Create Affiliate"}),a.jsx(u,{children:je?"Update affiliate details":"Add a new affiliate partner"})]}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"name",children:"Name *"}),a.jsx(v,{id:"name",value:ue.name,onChange:e=>fe({...ue,name:e.target.value}),placeholder:"John Doe"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"email",children:"Email *"}),a.jsx(v,{id:"email",type:"email",value:ue.email,onChange:e=>fe({...ue,email:e.target.value}),placeholder:"john@example.com"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"type",children:"Type"}),a.jsxs(g,{value:ue.type,onValueChange:e=>fe({...ue,type:e}),children:[a.jsx(N,{children:a.jsx(y,{})}),a.jsxs(_,{children:[a.jsx(C,{value:"individual",children:"Individual"}),a.jsx(C,{value:"organization",children:"Organization"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"commission",children:"Commission %"}),a.jsx(v,{id:"commission",type:"number",min:"0",max:"100",value:ue.commission_percent,onChange:e=>fe({...ue,commission_percent:parseFloat(e.target.value)||0})})]})]}),"organization"===ue.type&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"contact",children:"Contact Person"}),a.jsx(v,{id:"contact",value:ue.contact_person,onChange:e=>fe({...ue,contact_person:e.target.value}),placeholder:"Contact name"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"phone",children:"Phone"}),a.jsx(v,{id:"phone",value:ue.phone,onChange:e=>fe({...ue,phone:e.target.value}),placeholder:"+1 234 567 8900"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"notes",children:"Notes"}),a.jsx(v,{id:"notes",value:ue.notes,onChange:e=>fe({...ue,notes:e.target.value}),placeholder:"Additional notes..."})]})]}),a.jsxs(w,{children:[a.jsx(d,{variant:"outline",onClick:()=>he(!1),children:"Cancel"}),a.jsxs(d,{onClick:async()=>{if(ue.name&&ue.email){ge(!0);try{if(je){const{error:e}=await i.from("affiliates").update({name:ue.name,email:ue.email,type:ue.type,commission_percent:ue.commission_percent,contact_person:ue.contact_person||null,phone:ue.phone||null,notes:ue.notes||null}).eq("id",je.id);if(e)throw e;t.success("Affiliate updated")}else{const{error:e}=await i.from("affiliates").insert({name:ue.name,email:ue.email,type:ue.type,commission_percent:ue.commission_percent,contact_person:ue.contact_person||null,phone:ue.phone||null,notes:ue.notes||null,status:"active"});if(e)throw e;t.success("Affiliate created")}he(!1),pe(null),qe(),Re()}catch(e){console.error("Error saving affiliate:",e),t.error(e.message||"Failed to save affiliate")}finally{ge(!1)}}else t.error("Name and email are required")},disabled:ve,children:[ve&&a.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),je?"Update":"Create"]})]})]})}),a.jsx(x,{open:we,onOpenChange:Ae,children:a.jsxs(h,{className:"sm:max-w-[500px]",children:[a.jsxs(j,{children:[a.jsx(p,{children:"Create Promo Code"}),a.jsxs(u,{children:["Create a new promo code for ",null==Ne?void 0:Ne.name]})]}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"code",children:"Code *"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(v,{id:"code",value:be.code,onChange:e=>Fe({...be,code:e.target.value.toUpperCase()}),placeholder:"SUMMER2024",className:"font-mono"}),a.jsx(d,{variant:"outline",onClick:()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let a=0;a<8;a++)s+=e.charAt(Math.floor(36*Math.random()));Fe({...be,code:s})},children:"Generate"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"discount_type",children:"Discount Type"}),a.jsxs(g,{value:be.discount_type,onValueChange:e=>Fe({...be,discount_type:e}),children:[a.jsx(N,{children:a.jsx(y,{})}),a.jsxs(_,{children:[a.jsx(C,{value:"percent",children:"Percentage"}),a.jsx(C,{value:"fixed",children:"Fixed Amount"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"discount_value",children:"percent"===be.discount_type?"Discount %":"Discount Amount ($)"}),a.jsx(v,{id:"discount_value",type:"number",min:"0",value:be.discount_value,onChange:e=>Fe({...be,discount_value:parseFloat(e.target.value)||0})})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"max_redemptions",children:"Max Redemptions (optional)"}),a.jsx(v,{id:"max_redemptions",type:"number",min:"1",value:be.max_redemptions,onChange:e=>Fe({...be,max_redemptions:e.target.value}),placeholder:"Unlimited"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"expires_at",children:"Expires At (optional)"}),a.jsx(v,{id:"expires_at",type:"date",value:be.expires_at,onChange:e=>Fe({...be,expires_at:e.target.value})})]})]})]}),a.jsxs(w,{children:[a.jsx(d,{variant:"outline",onClick:()=>Ae(!1),children:"Cancel"}),a.jsxs(d,{onClick:async()=>{if(Ne&&be.code){ke(!0);try{const{data:e,error:s}=await i.functions.invoke("create-affiliate-code",{body:{affiliateId:Ne.id,code:be.code.toUpperCase(),discountType:be.discount_type,discountValue:be.discount_value,currency:be.currency,maxRedemptions:be.max_redemptions?parseInt(be.max_redemptions):void 0,expiresAt:be.expires_at||void 0}});if(s)throw s;if(!e.success)throw new Error(e.error||"Failed to create code");t.success("Promo code created"),Ae(!1),Ue(),Me(Ne.id)}catch(e){console.error("Error creating code:",e),t.error(e.message||"Failed to create code")}finally{ke(!1)}}else t.error("Code is required")},disabled:Se||!be.code,children:[Se&&a.jsx(Y,{className:"w-4 h-4 mr-2 animate-spin"}),"Create Code"]})]})]})})]})};export{re as default};
