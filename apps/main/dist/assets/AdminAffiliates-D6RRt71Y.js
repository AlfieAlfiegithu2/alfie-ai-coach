import{u as e,r as s,J as a,j as i,C as t,a as l,x as r,an as n,b as c,d as o,y as d,B as m,P as x,av as h,l as j,al as p,E as u,X as f,U as v,D as g,m as N,n as y,o as _,bp as C,R as w,I as b,S as A,p as F,q as S,s as k,t as E,bs as T}from"./index-CPFoM8ii.js";import{T as D,a as z,b as R,c as q}from"./tabs-CR9FwOog.js";import{A as M,a as U,b as P,c as $,d as I,e as V,f as O,g as B,h as J}from"./alert-dialog-_6wdsOhv.js";import{T as L,a as G,b as H,c as K,d as Q,e as W}from"./table-6_qyJt5F.js";import{A as X}from"./AdminLayout-WICn54lk.js";import{s as Y}from"./supabase-DWL4C3fA.js";import{U as Z}from"./users-BFBv5O-P.js";import{D as ee}from"./dollar-sign-PbsMM6pI.js";import{B as se}from"./building-2-DGAvx6Gc.js";import{T as ae}from"./tag-CeEzhG2d.js";import{S as ie}from"./square-pen-B8hdEABV.js";import{T as te}from"./trash-2-DdJQUqiT.js";const le=()=>{const le=e(),[re,ne]=s.useState([]),[ce,oe]=s.useState(!0),[de,me]=s.useState("affiliates"),[xe,he]=s.useState(!1),[je,pe]=s.useState(null),[ue,fe]=s.useState({name:"",email:"",type:"individual",commission_percent:10,contact_person:"",phone:"",notes:""}),[ve,ge]=s.useState(!1),[Ne,ye]=s.useState(null),[_e,Ce]=s.useState([]),[we,be]=s.useState(!1),[Ae,Fe]=s.useState({code:"",discount_type:"percent",discount_value:10,currency:"usd",max_redemptions:"",expires_at:""}),[Se,ke]=s.useState(!1),[Ee,Te]=s.useState(null),[De,ze]=s.useState({totalAffiliates:0,activeAffiliates:0,totalReferrals:0,totalCommission:0});s.useEffect(()=>{Re()},[]),s.useEffect(()=>{Ne&&qe(Ne.id)},[Ne]);const Re=async()=>{try{oe(!0);const{data:e,error:s}=await Y.from("affiliates").select("\n          *,\n          affiliate_codes(count),\n          affiliate_referrals(\n            commission_amount\n          )\n        ").order("created_at",{ascending:!1});if(s)throw s;const a=(e||[]).map(e=>{var s,a,i,t;return{...e,codes_count:(null==(a=null==(s=e.affiliate_codes)?void 0:s[0])?void 0:a.count)||0,total_referrals:(null==(i=e.affiliate_referrals)?void 0:i.length)||0,total_commission:(null==(t=e.affiliate_referrals)?void 0:t.reduce((e,s)=>e+(s.commission_amount||0),0))||0}});ne(a),ze({totalAffiliates:a.length,activeAffiliates:a.filter(e=>"active"===e.status).length,totalReferrals:a.reduce((e,s)=>e+(s.total_referrals||0),0),totalCommission:a.reduce((e,s)=>e+(s.total_commission||0),0)})}catch(e){console.error("Error loading affiliates:",e),a.error("Failed to load affiliates")}finally{oe(!1)}},qe=async e=>{try{const{data:s,error:a}=await Y.from("affiliate_codes").select("*").eq("affiliate_id",e).order("created_at",{ascending:!1});if(a)throw a;Ce(s||[])}catch(s){console.error("Error loading codes:",s),a.error("Failed to load affiliate codes")}},Me=()=>{fe({name:"",email:"",type:"individual",commission_percent:10,contact_person:"",phone:"",notes:""})},Ue=()=>{Fe({code:"",discount_type:"percent",discount_value:10,currency:"usd",max_redemptions:"",expires_at:""})};return i.jsxs(X,{title:"Affiliate Management",description:"Manage affiliates, promo codes, and track referrals",children:[i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[i.jsx(t,{children:i.jsx(l,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:i.jsx(Z,{className:"w-5 h-5 text-blue-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Affiliates"}),i.jsx("p",{className:"text-2xl font-bold",children:De.totalAffiliates})]})]})})}),i.jsx(t,{children:i.jsx(l,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:i.jsx(r,{className:"w-5 h-5 text-green-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Affiliates"}),i.jsx("p",{className:"text-2xl font-bold",children:De.activeAffiliates})]})]})})}),i.jsx(t,{children:i.jsx(l,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:i.jsx(n,{className:"w-5 h-5 text-purple-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Referrals"}),i.jsx("p",{className:"text-2xl font-bold",children:De.totalReferrals})]})]})})}),i.jsx(t,{children:i.jsx(l,{className:"pt-6",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:i.jsx(ee,{className:"w-5 h-5 text-amber-600"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Commission"}),i.jsxs("p",{className:"text-2xl font-bold",children:["$",De.totalCommission.toFixed(2)]})]})]})})})]}),i.jsxs(D,{value:de,onValueChange:me,children:[i.jsxs(z,{className:"mb-4",children:[i.jsx(R,{value:"affiliates",children:"Affiliates"}),i.jsxs(R,{value:"codes",disabled:!Ne,children:["Codes ",Ne&&`(${Ne.name})`]})]}),i.jsx(q,{value:"affiliates",children:i.jsxs(t,{children:[i.jsxs(c,{className:"flex flex-row items-center justify-between",children:[i.jsxs("div",{children:[i.jsx(o,{children:"Affiliates"}),i.jsx(d,{children:"Manage your affiliate partners"})]}),i.jsxs(m,{onClick:()=>{Me(),pe(null),he(!0)},children:[i.jsx(x,{className:"w-4 h-4 mr-2"})," Add Affiliate"]})]}),i.jsx(l,{children:ce?i.jsx("div",{className:"flex justify-center py-8",children:i.jsx(h,{className:"w-6 h-6 animate-spin"})}):0===re.length?i.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No affiliates yet. Create your first affiliate to get started."}):i.jsxs(L,{children:[i.jsx(G,{children:i.jsxs(H,{children:[i.jsx(K,{children:"Name"}),i.jsx(K,{children:"Type"}),i.jsx(K,{children:"Commission"}),i.jsx(K,{children:"Codes"}),i.jsx(K,{children:"Referrals"}),i.jsx(K,{children:"Earned"}),i.jsx(K,{children:"Status"}),i.jsx(K,{className:"text-right",children:"Actions"})]})}),i.jsx(Q,{children:re.map(e=>i.jsxs(H,{children:[i.jsx(W,{children:i.jsxs("div",{children:[i.jsx("p",{className:"font-medium",children:e.name}),i.jsx("p",{className:"text-sm text-muted-foreground",children:e.email})]})}),i.jsx(W,{children:i.jsxs(j,{variant:"outline",className:"gap-1",children:["organization"===e.type?i.jsx(se,{className:"w-3 h-3"}):i.jsx(p,{className:"w-3 h-3"}),e.type]})}),i.jsxs(W,{children:[e.commission_percent,"%"]}),i.jsx(W,{children:e.codes_count||0}),i.jsx(W,{children:e.total_referrals||0}),i.jsxs(W,{children:["$",(e.total_commission||0).toFixed(2)]}),i.jsx(W,{children:i.jsx(j,{variant:"active"===e.status?"default":"secondary",children:e.status})}),i.jsx(W,{className:"text-right",children:i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsxs(m,{variant:"outline",size:"sm",onClick:()=>{ye(e),me("codes")},children:[i.jsx(ae,{className:"w-4 h-4 mr-1"})," Codes"]}),i.jsx(m,{variant:"outline",size:"sm",onClick:()=>le(`/admin/affiliates/${e.id}`),children:i.jsx(u,{className:"w-4 h-4"})}),i.jsx(m,{variant:"outline",size:"sm",onClick:()=>(e=>{pe(e),fe({name:e.name,email:e.email,type:e.type,commission_percent:e.commission_percent,contact_person:e.contact_person||"",phone:e.phone||"",notes:e.notes||""}),he(!0)})(e),children:i.jsx(ie,{className:"w-4 h-4"})}),i.jsx(m,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const{error:s}=await Y.from("affiliates").update({status:"active"===e.status?"inactive":"active"}).eq("id",e.id);if(s)throw s;a.success("Affiliate "+("active"===e.status?"deactivated":"activated")),Re()}catch(s){console.error("Error toggling status:",s),a.error("Failed to update status")}})(e),children:"active"===e.status?"Deactivate":"Activate"}),i.jsxs(M,{children:[i.jsx(U,{asChild:!0,children:i.jsx(m,{variant:"destructive",size:"sm",children:i.jsx(te,{className:"w-4 h-4"})})}),i.jsxs(P,{children:[i.jsxs($,{children:[i.jsx(I,{children:"Delete Affiliate?"}),i.jsx(V,{children:"This will delete the affiliate and all their codes. This action cannot be undone."})]}),i.jsxs(O,{children:[i.jsx(B,{children:"Cancel"}),i.jsx(J,{onClick:()=>(async e=>{try{const{error:s}=await Y.from("affiliates").delete().eq("id",e.id);if(s)throw s;a.success("Affiliate deleted"),Re()}catch(s){console.error("Error deleting affiliate:",s),a.error(s.message||"Failed to delete affiliate")}})(e),children:"Delete"})]})]})]})]})})]},e.id))})]})})]})}),i.jsx(q,{value:"codes",children:Ne&&i.jsxs(t,{children:[i.jsxs(c,{className:"flex flex-row items-center justify-between",children:[i.jsxs("div",{children:[i.jsxs(o,{children:["Promo Codes for ",Ne.name]}),i.jsxs(d,{children:["Commission rate: ",Ne.commission_percent,"%"]})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs(m,{variant:"outline",onClick:()=>{ye(null),me("affiliates")},children:[i.jsx(f,{className:"w-4 h-4 mr-2"})," Close"]}),i.jsxs(m,{onClick:()=>{Ue(),be(!0)},children:[i.jsx(x,{className:"w-4 h-4 mr-2"})," Create Code"]})]})]}),i.jsx(l,{children:0===_e.length?i.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No codes yet. Create a promo code for this affiliate."}):i.jsxs(L,{children:[i.jsx(G,{children:i.jsxs(H,{children:[i.jsx(K,{children:"Code"}),i.jsx(K,{children:"Discount"}),i.jsx(K,{children:"Redemptions"}),i.jsx(K,{children:"Expires"}),i.jsx(K,{children:"Status"}),i.jsx(K,{className:"text-right",children:"Actions"})]})}),i.jsx(Q,{children:_e.map(e=>i.jsxs(H,{children:[i.jsx(W,{children:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("code",{className:"bg-muted px-2 py-1 rounded font-mono text-sm",children:e.code}),i.jsx(m,{variant:"ghost",size:"sm",onClick:()=>(e=>{navigator.clipboard.writeText(e),Te(e),setTimeout(()=>Te(null),2e3),a.success("Code copied!")})(e.code),children:Ee===e.code?i.jsx(r,{className:"w-4 h-4 text-green-500"}):i.jsx(v,{className:"w-4 h-4"})})]})}),i.jsx(W,{children:"percent"===e.discount_type?`${e.discount_value}% off`:`$${e.discount_value} off`}),i.jsxs(W,{children:[e.current_redemptions," / ",e.max_redemptions||"âˆž"]}),i.jsx(W,{children:e.expires_at?new Date(e.expires_at).toLocaleDateString():"Never"}),i.jsx(W,{children:i.jsx(j,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})}),i.jsx(W,{className:"text-right",children:i.jsx(m,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const{error:s}=await Y.from("affiliate_codes").update({is_active:!e.is_active}).eq("id",e.id);if(s)throw s;a.success("Code "+(e.is_active?"deactivated":"activated")),Ne&&qe(Ne.id)}catch(s){console.error("Error toggling code:",s),a.error("Failed to update code")}})(e),children:e.is_active?"Deactivate":"Activate"})})]},e.id))})]})})]})})]}),i.jsx(g,{open:xe,onOpenChange:he,children:i.jsxs(N,{className:"sm:max-w-[500px]",children:[i.jsxs(y,{children:[i.jsx(_,{children:je?"Edit Affiliate":"Create Affiliate"}),i.jsx(C,{children:je?"Update affiliate details":"Add a new affiliate partner"})]}),i.jsxs("div",{className:"space-y-4 py-4",children:[i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"name",children:"Name *"}),i.jsx(b,{id:"name",value:ue.name,onChange:e=>fe({...ue,name:e.target.value}),placeholder:"John Doe"})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"email",children:"Email *"}),i.jsx(b,{id:"email",type:"email",value:ue.email,onChange:e=>fe({...ue,email:e.target.value}),placeholder:"john@example.com"})]})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"type",children:"Type"}),i.jsxs(A,{value:ue.type,onValueChange:e=>fe({...ue,type:e}),children:[i.jsx(F,{children:i.jsx(S,{})}),i.jsxs(k,{children:[i.jsx(E,{value:"individual",children:"Individual"}),i.jsx(E,{value:"organization",children:"Organization"})]})]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"commission",children:"Commission %"}),i.jsx(b,{id:"commission",type:"number",min:"0",max:"100",value:ue.commission_percent,onChange:e=>fe({...ue,commission_percent:parseFloat(e.target.value)||0})})]})]}),"organization"===ue.type&&i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"contact",children:"Contact Person"}),i.jsx(b,{id:"contact",value:ue.contact_person,onChange:e=>fe({...ue,contact_person:e.target.value}),placeholder:"Contact name"})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"phone",children:"Phone"}),i.jsx(b,{id:"phone",value:ue.phone,onChange:e=>fe({...ue,phone:e.target.value}),placeholder:"+1 234 567 8900"})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"notes",children:"Notes"}),i.jsx(b,{id:"notes",value:ue.notes,onChange:e=>fe({...ue,notes:e.target.value}),placeholder:"Additional notes..."})]})]}),i.jsxs(T,{children:[i.jsx(m,{variant:"outline",onClick:()=>he(!1),children:"Cancel"}),i.jsxs(m,{onClick:async()=>{if(ue.name&&ue.email){ge(!0);try{if(je){const{error:e}=await Y.from("affiliates").update({name:ue.name,email:ue.email,type:ue.type,commission_percent:ue.commission_percent,contact_person:ue.contact_person||null,phone:ue.phone||null,notes:ue.notes||null}).eq("id",je.id);if(e)throw e;a.success("Affiliate updated")}else{const{error:e}=await Y.from("affiliates").insert({name:ue.name,email:ue.email,type:ue.type,commission_percent:ue.commission_percent,contact_person:ue.contact_person||null,phone:ue.phone||null,notes:ue.notes||null,status:"active"});if(e)throw e;a.success("Affiliate created")}he(!1),pe(null),Me(),Re()}catch(e){console.error("Error saving affiliate:",e),a.error(e.message||"Failed to save affiliate")}finally{ge(!1)}}else a.error("Name and email are required")},disabled:ve,children:[ve&&i.jsx(h,{className:"w-4 h-4 mr-2 animate-spin"}),je?"Update":"Create"]})]})]})}),i.jsx(g,{open:we,onOpenChange:be,children:i.jsxs(N,{className:"sm:max-w-[500px]",children:[i.jsxs(y,{children:[i.jsx(_,{children:"Create Promo Code"}),i.jsxs(C,{children:["Create a new promo code for ",null==Ne?void 0:Ne.name]})]}),i.jsxs("div",{className:"space-y-4 py-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"code",children:"Code *"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx(b,{id:"code",value:Ae.code,onChange:e=>Fe({...Ae,code:e.target.value.toUpperCase()}),placeholder:"SUMMER2024",className:"font-mono"}),i.jsx(m,{variant:"outline",onClick:()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let a=0;a<8;a++)s+=e.charAt(Math.floor(36*Math.random()));Fe({...Ae,code:s})},children:"Generate"})]})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"discount_type",children:"Discount Type"}),i.jsxs(A,{value:Ae.discount_type,onValueChange:e=>Fe({...Ae,discount_type:e}),children:[i.jsx(F,{children:i.jsx(S,{})}),i.jsxs(k,{children:[i.jsx(E,{value:"percent",children:"Percentage"}),i.jsx(E,{value:"fixed",children:"Fixed Amount"})]})]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"discount_value",children:"percent"===Ae.discount_type?"Discount %":"Discount Amount ($)"}),i.jsx(b,{id:"discount_value",type:"number",min:"0",value:Ae.discount_value,onChange:e=>Fe({...Ae,discount_value:parseFloat(e.target.value)||0})})]})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"max_redemptions",children:"Max Redemptions (optional)"}),i.jsx(b,{id:"max_redemptions",type:"number",min:"1",value:Ae.max_redemptions,onChange:e=>Fe({...Ae,max_redemptions:e.target.value}),placeholder:"Unlimited"})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(w,{htmlFor:"expires_at",children:"Expires At (optional)"}),i.jsx(b,{id:"expires_at",type:"date",value:Ae.expires_at,onChange:e=>Fe({...Ae,expires_at:e.target.value})})]})]})]}),i.jsxs(T,{children:[i.jsx(m,{variant:"outline",onClick:()=>be(!1),children:"Cancel"}),i.jsxs(m,{onClick:async()=>{if(Ne&&Ae.code){ke(!0);try{const{data:e,error:s}=await Y.functions.invoke("create-affiliate-code",{body:{affiliateId:Ne.id,code:Ae.code.toUpperCase(),discountType:Ae.discount_type,discountValue:Ae.discount_value,currency:Ae.currency,maxRedemptions:Ae.max_redemptions?parseInt(Ae.max_redemptions):void 0,expiresAt:Ae.expires_at||void 0}});if(s)throw s;if(!e.success)throw new Error(e.error||"Failed to create code");a.success("Promo code created"),be(!1),Ue(),qe(Ne.id)}catch(e){console.error("Error creating code:",e),a.error(e.message||"Failed to create code")}finally{ke(!1)}}else a.error("Code is required")},disabled:Se||!Ae.code,children:[Se&&i.jsx(h,{className:"w-4 h-4 mr-2 animate-spin"}),"Create Code"]})]})]})})]})};export{le as default};
