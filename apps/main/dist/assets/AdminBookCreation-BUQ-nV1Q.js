import{u as e,w as s,r as a,J as r,j as t,ap as l,l as n,C as i,b as o,d as c,e as d,y as h,a as m,O as u,I as x,T as p,S as j,p as g,q as f,s as v,t as b,K as N,B as w,W as y,Y as k,U as C,E as S,a6 as P,L as _}from"./index-C36stBbp.js";import{S as B}from"./separator-BeAn9HfZ.js";import{A,a as F,b as I,c as O,d as T,e as $,f as E,g as z,h as q}from"./alert-dialog-40rKjtDq.js";import{A as D}from"./AdminLayout-j7tae2vu.js";import{s as R}from"./supabase-DWL4C3fA.js";import{W as L}from"./wand-sparkles-KfYScWg9.js";import{I as M}from"./image-BvNv84Ah.js";import{T as U}from"./trash-2-CDHwe5Zo.js";import{C as G}from"./circle-alert-DsvRNcJP.js";const Y=5e3,J=()=>{const J=e(),{admin:W,loading:V}=s(),K=a.useRef(null),[Q,H]=a.useState(""),[X,Z]=a.useState(""),[ee,se]=a.useState(""),[ae,re]=a.useState(""),[te,le]=a.useState(""),[ne,ie]=a.useState(""),[oe,ce]=a.useState(""),[de,he]=a.useState("gemini-3-pro-preview"),[me,ue]=a.useState(!1),[xe,pe]=a.useState(!1),[je,ge]=a.useState(null),[fe,ve]=a.useState(0),[be,Ne]=a.useState(0),[we,ye]=a.useState(0),[ke,Ce]=a.useState(""),[Se,Pe]=a.useState(null),[_e,Be]=a.useState(null),[Ae,Fe]=a.useState(!1),[Ie,Oe]=a.useState([]),[Te,$e]=a.useState(!0),Ee=a.useRef(null);a.useEffect(()=>{V||W?W&&ze():J("/admin/login")},[W,V,J]);const ze=async()=>{$e(!0);try{const{data:e,error:s}=await R.from("books").select("*").order("created_at",{ascending:!1});if(s)throw s;Oe(e||[])}catch(e){console.error("Error loading books:",e),r.error("Failed to load books")}finally{$e(!1)}},qe=async(e,s,a,r,t)=>{const l=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/book-process-chunk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chunkText:e,chunkIndex:s,totalChunks:a,bookId:r,chapterId:t,newAuthor:X,originalAuthor:ee||void 0,newCompany:ae||void 0,originalCompany:te||void 0,model:de})});if(!l.ok){const e=await l.json();throw new Error(e.error||"Failed to process chunk")}return(await l.json()).processedText},De=()=>{H(""),Z(""),se(""),re(""),le(""),ie(""),ce(""),Pe(null),Be(null),ge(null),ve(0),Ne(0),ye(0),Ce("")},Re=e=>{switch(e){case"draft":return t.jsxs(n,{variant:"secondary",children:[t.jsx(G,{className:"w-3 h-3 mr-1"}),"Draft"]});case"processing":return t.jsxs(n,{variant:"default",className:"bg-yellow-500",children:[t.jsx(l,{className:"w-3 h-3 mr-1 animate-spin"}),"Processing"]});case"published":return t.jsxs(n,{variant:"default",className:"bg-green-500",children:[t.jsx(_,{className:"w-3 h-3 mr-1"}),"Published"]});case"archived":return t.jsxs(n,{variant:"outline",children:[t.jsx(P,{className:"w-3 h-3 mr-1"}),"Archived"]});default:return t.jsx(n,{variant:"outline",children:e})}};if(V)return t.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:t.jsx(l,{className:"w-8 h-8 animate-spin"})});if(!W)return null;const Le=oe.split(/\s+/).filter(Boolean).length,Me=Math.ceil(oe.length/Y),Ue=15*Me;return t.jsx(D,{title:"Book Creation",showBackButton:!0,backPath:"/admin/ielts",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:"Book Creation Studio"}),t.jsx("p",{className:"text-muted-foreground",children:"Paraphrase and publish educational books with AI assistance"})]}),t.jsxs(n,{variant:"secondary",className:"text-sm",children:[t.jsx(L,{className:"w-4 h-4 mr-1"}),"AI-Powered"]})]}),t.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[t.jsx("div",{className:"lg:col-span-2 space-y-6",children:t.jsxs(i,{children:[t.jsxs(o,{children:[t.jsxs(c,{className:"flex items-center gap-2",children:[t.jsx(d,{className:"w-5 h-5"}),"Create New Book"]}),t.jsx(h,{children:"Paste your content and let AI paraphrase it while replacing author and company names"})]}),t.jsxs(m,{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"title",children:"Book Title *"}),t.jsx(x,{id:"title",placeholder:"Enter the book title",value:Q,onChange:e=>H(e.target.value),disabled:me})]}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"newAuthor",children:"New Author Name *"}),t.jsx(x,{id:"newAuthor",placeholder:"Your author name",value:X,onChange:e=>Z(e.target.value),disabled:me})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"originalAuthor",children:"Original Author (to replace)"}),t.jsx(x,{id:"originalAuthor",placeholder:"Original author name to find & replace",value:ee,onChange:e=>se(e.target.value),disabled:me})]})]}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"newCompany",children:"New Company/Publisher"}),t.jsx(x,{id:"newCompany",placeholder:"Your company name",value:ae,onChange:e=>re(e.target.value),disabled:me})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"originalCompany",children:"Original Company (to replace)"}),t.jsx(x,{id:"originalCompany",placeholder:"Original company to find & replace",value:te,onChange:e=>le(e.target.value),disabled:me})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"description",children:"Book Description"}),t.jsx(p,{id:"description",placeholder:"Brief description of the book...",value:ne,onChange:e=>ie(e.target.value),disabled:me,rows:2})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{children:"AI Model"}),t.jsxs(j,{value:de,onValueChange:e=>he(e),disabled:me,children:[t.jsx(g,{children:t.jsx(f,{})}),t.jsxs(v,{children:[t.jsx(b,{value:"gemini-3-pro-preview",children:"Gemini 3 Pro (Google) - Best Quality"}),t.jsx(b,{value:"deepseek-v3",children:"DeepSeek V3 (OpenRouter) - Fast & Efficient"})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(u,{htmlFor:"content",children:"Book Content *"}),t.jsxs("span",{className:"text-sm text-muted-foreground",children:[Le.toLocaleString()," words | ~",Me," chunks | ~",Math.ceil(Ue/60)," min"]})]}),t.jsx(p,{id:"content",placeholder:"Paste your entire book content here (supports 100-200+ pages)...",value:oe,onChange:e=>ce(e.target.value),disabled:me,rows:15,className:"font-mono text-sm"})]}),me&&t.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm font-medium",children:ke}),t.jsxs("span",{className:"text-sm text-muted-foreground",children:[be," / ",we," chunks"]})]}),t.jsx(N,{value:fe,className:"h-2"}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Processing with ",de,". This may take several minutes for large books."]})]}),t.jsxs("div",{className:"flex gap-3",children:[me?t.jsx(t.Fragment,{children:xe?t.jsxs(w,{onClick:async()=>{r.info("Resume feature coming soon. Please restart processing.")},children:[t.jsx(k,{className:"w-4 h-4 mr-2"}),"Resume"]}):t.jsxs(w,{variant:"secondary",onClick:()=>{var e;pe(!0),null==(e=Ee.current)||e.abort(),r.info("Processing paused")},children:[t.jsx(y,{className:"w-4 h-4 mr-2"}),"Pause"]})}):t.jsxs(w,{onClick:async()=>{var e,s;if(Q.trim()&&X.trim()&&oe.trim()){ue(!0),pe(!1),Ce("Creating book..."),Ee.current=new AbortController;try{const{data:t,error:l}=await R.from("books").insert({title:Q,author:X,original_author:ee||null,company:ae||null,original_company:te||null,description:ne||null,status:"processing",processing_model:de}).select().single();if(l)throw l;ge(t.id);const n=(e=>{const s=[];let a=0;for(;a<e.length;){let r=a+Y;if(r<e.length){const s=e.lastIndexOf("\n\n",r);if(s>a+3500)r=s+2;else{const s=e.lastIndexOf(". ",r);s>a+3500&&(r=s+2)}}s.push(e.slice(a,r).trim()),a=r}return s.filter(e=>e.length>0)})(oe);ye(n.length),Ne(0);const i=n.map((e,s)=>({book_id:t.id,chapter_number:s+1,chapter_title:`Chapter ${s+1}`,original_content:e,status:"pending"})),{data:o,error:c}=await R.from("book_chapters").insert(i).select();if(c)throw c;const{error:d}=await R.from("book_processing_jobs").insert({book_id:t.id,total_chunks:n.length,processed_chunks:0,current_chunk:0,status:"processing",processing_model:de,started_at:(new Date).toISOString()});if(d)throw d;await R.from("books").update({total_chapters:n.length}).eq("id",t.id);for(let s=0;s<n.length;s++){if(xe||(null==(e=Ee.current)?void 0:e.signal.aborted)){Ce("Processing paused");break}Ce(`Processing chunk ${s+1} of ${n.length}...`);try{await qe(n[s],s,n.length,t.id,o[s].id);Ne(s+1),ve((s+1)/n.length*100),s<n.length-1&&await new Promise(e=>setTimeout(e,1e3))}catch(a){console.error(`Error processing chunk ${s+1}:`,a),await R.from("book_chapters").update({status:"failed",error_message:a.message}).eq("id",o[s].id),a.message.includes("rate limit")&&(r.error("Rate limit reached. Pausing for 30 seconds..."),await new Promise(e=>setTimeout(e,3e4)),s--)}}xe||(null==(s=Ee.current)?void 0:s.signal.aborted)||(Ce("Processing complete!"),r.success("Book processing complete!"),await R.from("books").update({status:"draft"}).eq("id",t.id),ze(),De())}catch(a){console.error("Error during processing:",a),r.error(`Processing failed: ${a.message}`),Ce("Processing failed")}finally{ue(!1)}}else r.error("Please fill in Title, New Author, and Content")},disabled:!Q||!X||!oe,children:[t.jsx(L,{className:"w-4 h-4 mr-2"}),"Start Processing"]}),t.jsx(w,{variant:"outline",onClick:De,disabled:me&&!xe,children:"Clear Form"})]})]})]})}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs(i,{children:[t.jsx(o,{children:t.jsxs(c,{className:"flex items-center gap-2",children:[t.jsx(M,{className:"w-5 h-5"}),"Book Cover"]})}),t.jsxs(m,{className:"space-y-4",children:[t.jsx("input",{ref:K,type:"file",accept:"image/*",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(a){if(!a.type.startsWith("image/"))return void r.error("Please select an image file");if(a.size>5242880)return void r.error("Image must be less than 5MB");Pe(a),Be(URL.createObjectURL(a))}},className:"hidden"}),_e?t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:_e,alt:"Cover preview",className:"w-full h-48 object-cover rounded-lg"}),t.jsx(w,{size:"sm",variant:"secondary",className:"absolute top-2 right-2",onClick:()=>{Pe(null),Be(null)},children:t.jsx(U,{className:"w-4 h-4"})})]}):t.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>{var e;return null==(e=K.current)?void 0:e.click()},children:[t.jsx(C,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to upload cover image"}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PNG, JPG up to 5MB"})]}),je&&Se&&t.jsx(w,{className:"w-full",onClick:()=>(async e=>{var s;if(!Se)return null;Fe(!0);try{const{data:a}=await R.auth.getSession(),t=new FormData;t.append("file",Se),t.append("path",`books/covers/${e}/${Se.name}`),t.append("contentType",Se.type);const l=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/r2-upload",{method:"POST",headers:{Authorization:`Bearer ${null==(s=null==a?void 0:a.session)?void 0:s.access_token}`},body:t});if(!l.ok)throw new Error("Failed to upload cover");const n=await l.json();return await R.from("books").update({cover_url:n.url}).eq("id",e),r.success("Cover uploaded successfully!"),ze(),n.url}catch(a){return console.error("Error uploading cover:",a),r.error(`Failed to upload cover: ${a.message}`),null}finally{Fe(!1)}})(je),disabled:Ae,children:Ae?t.jsxs(t.Fragment,{children:[t.jsx(l,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):t.jsxs(t.Fragment,{children:[t.jsx(C,{className:"w-4 h-4 mr-2"}),"Upload Cover"]})})]})]}),t.jsxs(i,{children:[t.jsx(o,{children:t.jsx(c,{children:"Processing Info"})}),t.jsxs(m,{className:"space-y-3 text-sm",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:"Chunk Size"}),t.jsxs("span",{children:[Y.toLocaleString()," chars"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:"Est. Processing"}),t.jsx("span",{children:"~15s per chunk"})]}),t.jsx(B,{}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Content is split into manageable chunks to avoid timeouts. Progress is saved after each chunk."})]})]})]})]}),t.jsx(B,{}),t.jsxs("div",{className:"space-y-4",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Your Books"}),Te?t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(l,{className:"w-6 h-6 animate-spin"})}):0===Ie.length?t.jsx(i,{children:t.jsxs(m,{className:"py-8 text-center",children:[t.jsx(d,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),t.jsx("p",{className:"text-muted-foreground",children:"No books created yet"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Create your first book above!"})]})}):t.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:Ie.map(e=>t.jsxs(i,{className:"overflow-hidden",children:[t.jsx("div",{className:"h-32 bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center",children:e.cover_url?t.jsx("img",{src:e.cover_url,alt:e.title,className:"w-full h-full object-cover"}):t.jsx(d,{className:"w-12 h-12 text-muted-foreground"})}),t.jsxs(o,{className:"pb-2",children:[t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsx(c,{className:"text-lg line-clamp-1",children:e.title}),Re(e.status)]}),t.jsxs(h,{className:"line-clamp-1",children:["by ",e.author]})]}),t.jsxs(m,{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[t.jsxs("span",{children:[e.total_chapters," chapters"]}),t.jsx("span",{children:e.processing_model})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(w,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>J(`/books/${e.id}?preview=true`),children:[t.jsx(S,{className:"w-4 h-4 mr-1"}),"Preview"]}),"draft"===e.status&&t.jsx(w,{size:"sm",className:"flex-1",onClick:()=>(async e=>{try{const{error:s}=await R.from("books").update({status:"published",published_at:(new Date).toISOString()}).eq("id",e);if(s)throw s;r.success("Book published successfully!"),ze()}catch(s){r.error(`Failed to publish: ${s.message}`)}})(e.id),children:"Publish"}),!e.cover_url&&t.jsx(w,{size:"sm",variant:"secondary",onClick:()=>{var s;ge(e.id),null==(s=K.current)||s.click()},children:t.jsx(M,{className:"w-4 h-4"})}),t.jsxs(A,{children:[t.jsx(F,{asChild:!0,children:t.jsx(w,{size:"sm",variant:"ghost",children:t.jsx(U,{className:"w-4 h-4 text-red-500"})})}),t.jsxs(I,{children:[t.jsxs(O,{children:[t.jsx(T,{children:"Delete Book"}),t.jsxs($,{children:['Are you sure you want to delete "',e.title,'"? This action cannot be undone.']})]}),t.jsxs(E,{children:[t.jsx(z,{children:"Cancel"}),t.jsx(q,{onClick:()=>(async e=>{try{const{error:s}=await R.from("books").delete().eq("id",e);if(s)throw s;r.success("Book deleted successfully!"),ze()}catch(s){r.error(`Failed to delete: ${s.message}`)}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]},e.id))})]})]})})};export{J as default};
