import{u as e,r as s,j as a}from"./vendor-react-rLLBBC7n.js";import{n as t,s as r,J as n,e as i,C as o,b as l,c,o as d,a as h,L as m,I as u,T as x,S as p,i as g,j,k as f,l as v,P as b,B as w}from"./index-BDl0jLJK.js";import{S as N}from"./separator-C0bogF69.js";import{A as y,a as k,b as C,c as S,d as P,e as _,f as F,g as z,h as $}from"./alert-dialog-C3e0CSUs.js";import{D as T,a as B,b as A,c as D}from"./dropdown-menu-DF6eZyHV.js";import{A as I}from"./AdminLayout-DwaN-V0p.js";import{E as O}from"./jspdf.es.min-C-6aUN2p.js";import{y as E,b7 as L,ao as q,aK as R,aL as G,aS as M,aY as J,aV as U,aN as Y,bo as V,ap as K,G as W,aI as H,at as Q,b4 as Z}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const X=5e3,ee=()=>{const ee=e(),{admin:se,loading:ae}=t(),te=s.useRef(null),[re,ne]=s.useState(""),[ie,oe]=s.useState(""),[le,ce]=s.useState(""),[de,he]=s.useState(""),[me,ue]=s.useState(""),[xe,pe]=s.useState(""),[ge,je]=s.useState(""),[fe,ve]=s.useState("gemini-3-pro-preview"),[be,we]=s.useState(!1),[Ne,ye]=s.useState(!1),[ke,Ce]=s.useState(null),[Se,Pe]=s.useState(0),[_e,Fe]=s.useState(0),[ze,$e]=s.useState(0),[Te,Be]=s.useState(""),[Ae,De]=s.useState(null),[Ie,Oe]=s.useState(null),[Ee,Le]=s.useState(!1),[qe,Re]=s.useState([]),[Ge,Me]=s.useState(!0),[Je,Ue]=s.useState(null),[Ye,Ve]=s.useState(0),[Ke,We]=s.useState(""),He=s.useRef(null);s.useEffect(()=>{ae||se?se&&Qe():ee("/admin/login")},[se,ae,ee]);const Qe=async()=>{Me(!0);try{const{data:e,error:s}=await r.from("books").select("*").order("created_at",{ascending:!1});if(s)throw s;Re(e||[])}catch(e){console.error("Error loading books:",e),n.error("Failed to load books")}finally{Me(!1)}},Ze=async(e,s,a,t,r)=>{const n=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/book-process-chunk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chunkText:e,chunkIndex:s,totalChunks:a,bookId:t,chapterId:r,newAuthor:ie,originalAuthor:le||void 0,newCompany:de||void 0,originalCompany:me||void 0,model:fe})});if(!n.ok){const e=await n.json();throw new Error(e.error||"Failed to process chunk")}return(await n.json()).processedText},Xe=()=>{ne(""),oe(""),ce(""),he(""),ue(""),pe(""),je(""),De(null),Oe(null),Ce(null),Pe(0),Fe(0),$e(0),Be("")},es=async(e,s)=>{var a;try{const t=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/translation-service",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,sourceLang:"en",targetLang:s,bypassCache:!0})});if(!t.ok)throw new Error("Translation failed");return(null==(a=(await t.json()).result)?void 0:a.translation)||e}catch(t){return console.error("Translation error:",t),e}},ss=async(e,s)=>{const a=qe.find(s=>s.id===e);if(a){Ue(e),Ve(0),We("Loading chapters...");try{const{data:t,error:i}=await r.from("book_chapters").select("chapter_number, chapter_title, processed_content").eq("book_id",e).eq("status","completed").order("chapter_number",{ascending:!0});if(i)throw i;if(!t||0===t.length)return n.error("No completed chapters found"),void Ue(null);const o=new O({orientation:"portrait",unit:"mm",format:"a4"}),l=o.internal.pageSize.getWidth(),c=o.internal.pageSize.getHeight(),d=20,h=l-2*d,m=7;let u=d;const x={en:"English",ko:"한국어",zh:"中文"};o.setFontSize(28);const p="en"===s?a.title:await es(a.title,s),g=o.splitTextToSize(p,h);o.text(g,l/2,c/3,{align:"center"}),o.setFontSize(16);const j="en"===s?"by":"ko"===s?"저자:":"作者:";o.text(`${j} ${a.author}`,l/2,c/3+30,{align:"center"}),a.company&&(o.setFontSize(12),o.text(a.company,l/2,c/3+45,{align:"center"})),o.setFontSize(10),o.text(`Language: ${x[s]}`,l/2,c-d,{align:"center"});for(let e=0;e<t.length;e++){const a=t[e];Ve(Math.round((e+1)/t.length*100)),We("en"===s?`Processing chapter ${e+1} of ${t.length}...`:`Translating chapter ${e+1} of ${t.length}...`),o.addPage(),u=d,o.setFontSize(18);const r="en"===s?a.chapter_title||`Chapter ${a.chapter_number}`:await es(a.chapter_title||`Chapter ${a.chapter_number}`,s),n=o.splitTextToSize(r,h);if(o.text(n,d,u),u+=10*n.length+10,a.processed_content){o.setFontSize(11);let e=a.processed_content;if("en"!==s){const a=e.split("\n\n").filter(e=>e.trim()),t=[];for(let e=0;e<a.length;e++){const r=await es(a[e],s);t.push(r),e<a.length-1&&await new Promise(e=>setTimeout(e,300))}e=t.join("\n\n")}const t=e.split("\n\n").filter(e=>e.trim());for(const s of t){const e=o.splitTextToSize(s.trim(),h);for(const s of e)u+m>c-d&&(o.addPage(),u=d),o.text(s,d,u),u+=m;u+=3}}}const f="en"===s?"":`_${s}`,v=`${a.title.replace(/[^a-zA-Z0-9]/g,"_")}${f}.pdf`;o.save(v),n.success(`PDF downloaded: ${v}`),We(""),Ve(0)}catch(t){console.error("Error generating PDF:",t),n.error(`PDF generation failed: ${t.message}`)}finally{Ue(null)}}else n.error("Book not found")},as=e=>{switch(e){case"draft":return a.jsxs(i,{variant:"secondary",children:[a.jsx(Z,{className:"w-3 h-3 mr-1"}),"Draft"]});case"processing":return a.jsxs(i,{variant:"default",className:"bg-yellow-500",children:[a.jsx(E,{className:"w-3 h-3 mr-1 animate-spin"}),"Processing"]});case"published":return a.jsxs(i,{variant:"default",className:"bg-green-500",children:[a.jsx(Q,{className:"w-3 h-3 mr-1"}),"Published"]});case"archived":return a.jsxs(i,{variant:"outline",children:[a.jsx(H,{className:"w-3 h-3 mr-1"}),"Archived"]});default:return a.jsx(i,{variant:"outline",children:e})}};if(ae)return a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsx(E,{className:"w-8 h-8 animate-spin"})});if(!se)return null;const ts=ge.split(/\s+/).filter(Boolean).length,rs=Math.ceil(ge.length/X),ns=15*rs;return a.jsx(I,{title:"Book Creation",showBackButton:!0,backPath:"/admin/ielts",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:"Book Creation Studio"}),a.jsx("p",{className:"text-muted-foreground",children:"Paraphrase and publish educational books with AI assistance"})]}),a.jsxs(i,{variant:"secondary",className:"text-sm",children:[a.jsx(L,{className:"w-4 h-4 mr-1"}),"AI-Powered"]})]}),a.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[a.jsx("div",{className:"lg:col-span-2 space-y-6",children:a.jsxs(o,{children:[a.jsxs(l,{children:[a.jsxs(c,{className:"flex items-center gap-2",children:[a.jsx(q,{className:"w-5 h-5"}),"Create New Book"]}),a.jsx(d,{children:"Paste your content and let AI paraphrase it while replacing author and company names"})]}),a.jsxs(h,{className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"title",children:"Book Title *"}),a.jsx(u,{id:"title",placeholder:"Enter the book title",value:re,onChange:e=>ne(e.target.value),disabled:be})]}),a.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"newAuthor",children:"New Author Name *"}),a.jsx(u,{id:"newAuthor",placeholder:"Your author name",value:ie,onChange:e=>oe(e.target.value),disabled:be})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"originalAuthor",children:"Original Author (to replace)"}),a.jsx(u,{id:"originalAuthor",placeholder:"Original author name to find & replace",value:le,onChange:e=>ce(e.target.value),disabled:be})]})]}),a.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"newCompany",children:"New Company/Publisher"}),a.jsx(u,{id:"newCompany",placeholder:"Your company name",value:de,onChange:e=>he(e.target.value),disabled:be})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"originalCompany",children:"Original Company (to replace)"}),a.jsx(u,{id:"originalCompany",placeholder:"Original company to find & replace",value:me,onChange:e=>ue(e.target.value),disabled:be})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{htmlFor:"description",children:"Book Description"}),a.jsx(x,{id:"description",placeholder:"Brief description of the book...",value:xe,onChange:e=>pe(e.target.value),disabled:be,rows:2})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(m,{children:"AI Model"}),a.jsxs(p,{value:fe,onValueChange:e=>ve(e),disabled:be,children:[a.jsx(g,{children:a.jsx(j,{})}),a.jsxs(f,{children:[a.jsx(v,{value:"gemini-3-pro-preview",children:"Gemini 3 Pro (Google) - Best Quality"}),a.jsx(v,{value:"deepseek-v3",children:"DeepSeek V3 (OpenRouter) - Fast & Efficient"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(m,{htmlFor:"content",children:"Book Content *"}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[ts.toLocaleString()," words | ~",rs," chunks | ~",Math.ceil(ns/60)," min"]})]}),a.jsx(x,{id:"content",placeholder:"Paste your entire book content here (supports 100-200+ pages)...",value:ge,onChange:e=>je(e.target.value),disabled:be,rows:15,className:"font-mono text-sm"})]}),be&&a.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm font-medium",children:Te}),a.jsxs("span",{className:"text-sm text-muted-foreground",children:[_e," / ",ze," chunks"]})]}),a.jsx(b,{value:Se,className:"h-2"}),a.jsxs("p",{className:"text-xs text-muted-foreground",children:["Processing with ",fe,". This may take several minutes for large books."]})]}),a.jsxs("div",{className:"flex gap-3",children:[be?a.jsx(a.Fragment,{children:Ne?a.jsxs(w,{onClick:async()=>{n.info("Resume feature coming soon. Please restart processing.")},children:[a.jsx(G,{className:"w-4 h-4 mr-2"}),"Resume"]}):a.jsxs(w,{variant:"secondary",onClick:()=>{var e;ye(!0),null==(e=He.current)||e.abort(),n.info("Processing paused")},children:[a.jsx(R,{className:"w-4 h-4 mr-2"}),"Pause"]})}):a.jsxs(w,{onClick:async()=>{var e,s;if(re.trim()&&ie.trim()&&ge.trim()){we(!0),ye(!1),Be("Creating book..."),He.current=new AbortController;try{const{data:t,error:i}=await r.from("books").insert({title:re,author:ie,original_author:le||null,company:de||null,original_company:me||null,description:xe||null,status:"processing",processing_model:fe}).select().single();if(i)throw i;Ce(t.id);const o=(e=>{const s=[];let a=0;for(;a<e.length;){let t=a+X;if(t<e.length){const s=e.lastIndexOf("\n\n",t);if(s>a+3500)t=s+2;else{const s=e.lastIndexOf(". ",t);s>a+3500&&(t=s+2)}}s.push(e.slice(a,t).trim()),a=t}return s.filter(e=>e.length>0)})(ge);$e(o.length),Fe(0);const l=o.map((e,s)=>({book_id:t.id,chapter_number:s+1,chapter_title:`Chapter ${s+1}`,original_content:e,status:"pending"})),{data:c,error:d}=await r.from("book_chapters").insert(l).select();if(d)throw d;const{error:h}=await r.from("book_processing_jobs").insert({book_id:t.id,total_chunks:o.length,processed_chunks:0,current_chunk:0,status:"processing",processing_model:fe,started_at:(new Date).toISOString()});if(h)throw h;await r.from("books").update({total_chapters:o.length}).eq("id",t.id);for(let s=0;s<o.length;s++){if(Ne||(null==(e=He.current)?void 0:e.signal.aborted)){Be("Processing paused");break}Be(`Processing chunk ${s+1} of ${o.length}...`);try{await Ze(o[s],s,o.length,t.id,c[s].id);Fe(s+1),Pe((s+1)/o.length*100),s<o.length-1&&await new Promise(e=>setTimeout(e,1e3))}catch(a){console.error(`Error processing chunk ${s+1}:`,a),await r.from("book_chapters").update({status:"failed",error_message:a.message}).eq("id",c[s].id),a.message.includes("rate limit")&&(n.error("Rate limit reached. Pausing for 30 seconds..."),await new Promise(e=>setTimeout(e,3e4)),s--)}}Ne||(null==(s=He.current)?void 0:s.signal.aborted)||(Be("Processing complete!"),n.success("Book processing complete!"),await r.from("books").update({status:"draft"}).eq("id",t.id),Qe(),Xe())}catch(a){console.error("Error during processing:",a),n.error(`Processing failed: ${a.message}`),Be("Processing failed")}finally{we(!1)}}else n.error("Please fill in Title, New Author, and Content")},disabled:!re||!ie||!ge,children:[a.jsx(L,{className:"w-4 h-4 mr-2"}),"Start Processing"]}),a.jsx(w,{variant:"outline",onClick:Xe,disabled:be&&!Ne,children:"Clear Form"})]})]})]})}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs(o,{children:[a.jsx(l,{children:a.jsxs(c,{className:"flex items-center gap-2",children:[a.jsx(M,{className:"w-5 h-5"}),"Book Cover"]})}),a.jsxs(h,{className:"space-y-4",children:[a.jsx("input",{ref:te,type:"file",accept:"image/*",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(a){if(!a.type.startsWith("image/"))return void n.error("Please select an image file");if(a.size>5242880)return void n.error("Image must be less than 5MB");De(a),Oe(URL.createObjectURL(a))}},className:"hidden"}),Ie?a.jsxs("div",{className:"relative",children:[a.jsx("img",{src:Ie,alt:"Cover preview",className:"w-full h-48 object-cover rounded-lg"}),a.jsx(w,{size:"sm",variant:"secondary",className:"absolute top-2 right-2",onClick:()=>{De(null),Oe(null)},children:a.jsx(J,{className:"w-4 h-4"})})]}):a.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>{var e;return null==(e=te.current)?void 0:e.click()},children:[a.jsx(U,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to upload cover image"}),a.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PNG, JPG up to 5MB"})]}),ke&&Ae&&a.jsx(w,{className:"w-full",onClick:()=>(async e=>{var s;if(!Ae)return null;Le(!0);try{const{data:a}=await r.auth.getSession(),t=new FormData;t.append("file",Ae),t.append("path",`books/covers/${e}/${Ae.name}`),t.append("contentType",Ae.type);const i=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/r2-upload",{method:"POST",headers:{Authorization:`Bearer ${null==(s=null==a?void 0:a.session)?void 0:s.access_token}`},body:t});if(!i.ok)throw new Error("Failed to upload cover");const o=await i.json();return await r.from("books").update({cover_url:o.url}).eq("id",e),n.success("Cover uploaded successfully!"),Qe(),o.url}catch(a){return console.error("Error uploading cover:",a),n.error(`Failed to upload cover: ${a.message}`),null}finally{Le(!1)}})(ke),disabled:Ee,children:Ee?a.jsxs(a.Fragment,{children:[a.jsx(E,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):a.jsxs(a.Fragment,{children:[a.jsx(U,{className:"w-4 h-4 mr-2"}),"Upload Cover"]})})]})]}),a.jsxs(o,{children:[a.jsx(l,{children:a.jsx(c,{children:"Processing Info"})}),a.jsxs(h,{className:"space-y-3 text-sm",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-muted-foreground",children:"Chunk Size"}),a.jsxs("span",{children:[X.toLocaleString()," chars"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-muted-foreground",children:"Est. Processing"}),a.jsx("span",{children:"~15s per chunk"})]}),a.jsx(N,{}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Content is split into manageable chunks to avoid timeouts. Progress is saved after each chunk."})]})]})]})]}),a.jsx(N,{}),Je&&a.jsxs("div",{className:"fixed bottom-6 right-6 z-50 bg-background border shadow-lg rounded-lg p-4 w-80",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[a.jsx(E,{className:"w-5 h-5 animate-spin text-primary"}),a.jsx("span",{className:"font-medium",children:"Generating PDF"})]}),a.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:Ke}),a.jsx(b,{value:Ye,className:"h-2"}),a.jsxs("p",{className:"text-xs text-muted-foreground mt-1 text-right",children:[Ye,"%"]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsx("h2",{className:"text-xl font-semibold",children:"Your Books"}),Ge?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx(E,{className:"w-6 h-6 animate-spin"})}):0===qe.length?a.jsx(o,{children:a.jsxs(h,{className:"py-8 text-center",children:[a.jsx(q,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),a.jsx("p",{className:"text-muted-foreground",children:"No books created yet"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Create your first book above!"})]})}):a.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:qe.map(e=>a.jsxs(o,{className:"overflow-hidden",children:[a.jsx("div",{className:"h-32 bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center",children:e.cover_url?a.jsx("img",{src:e.cover_url,alt:e.title,className:"w-full h-full object-cover"}):a.jsx(q,{className:"w-12 h-12 text-muted-foreground"})}),a.jsxs(l,{className:"pb-2",children:[a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsx(c,{className:"text-lg line-clamp-1",children:e.title}),as(e.status)]}),a.jsxs(d,{className:"line-clamp-1",children:["by ",e.author]})]}),a.jsxs(h,{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[a.jsxs("span",{children:[e.total_chapters," chapters"]}),a.jsx("span",{children:e.processing_model})]}),a.jsxs("div",{className:"flex gap-2 flex-wrap",children:[a.jsxs(w,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>ee(`/books/${e.id}?preview=true`),children:[a.jsx(Y,{className:"w-4 h-4 mr-1"}),"Preview"]}),"draft"===e.status&&a.jsx(w,{size:"sm",className:"flex-1",onClick:()=>(async e=>{try{const{error:s}=await r.from("books").update({status:"published",published_at:(new Date).toISOString()}).eq("id",e);if(s)throw s;n.success("Book published successfully!"),Qe()}catch(s){n.error(`Failed to publish: ${s.message}`)}})(e.id),children:"Publish"}),a.jsxs(T,{children:[a.jsx(B,{asChild:!0,children:a.jsx(w,{size:"sm",variant:"secondary",disabled:Je===e.id||0===e.total_chapters,children:Je===e.id?a.jsx(E,{className:"w-4 h-4 animate-spin"}):a.jsx(V,{className:"w-4 h-4"})})}),a.jsxs(A,{align:"end",children:[a.jsxs(D,{onClick:()=>ss(e.id,"en"),className:"cursor-pointer",children:[a.jsx(K,{className:"w-4 h-4 mr-2"}),"English PDF"]}),a.jsxs(D,{onClick:()=>ss(e.id,"ko"),className:"cursor-pointer",children:[a.jsx(W,{className:"w-4 h-4 mr-2"}),"한국어 (Korean) PDF"]}),a.jsxs(D,{onClick:()=>ss(e.id,"zh"),className:"cursor-pointer",children:[a.jsx(W,{className:"w-4 h-4 mr-2"}),"中文 (Chinese) PDF"]})]})]}),!e.cover_url&&a.jsx(w,{size:"sm",variant:"secondary",onClick:()=>{var s;Ce(e.id),null==(s=te.current)||s.click()},children:a.jsx(M,{className:"w-4 h-4"})}),a.jsxs(y,{children:[a.jsx(k,{asChild:!0,children:a.jsx(w,{size:"sm",variant:"ghost",children:a.jsx(J,{className:"w-4 h-4 text-red-500"})})}),a.jsxs(C,{children:[a.jsxs(S,{children:[a.jsx(P,{children:"Delete Book"}),a.jsxs(_,{children:['Are you sure you want to delete "',e.title,'"? This action cannot be undone.']})]}),a.jsxs(F,{children:[a.jsx(z,{children:"Cancel"}),a.jsx($,{onClick:()=>(async e=>{try{const{error:s}=await r.from("books").delete().eq("id",e);if(s)throw s;n.success("Book deleted successfully!"),Qe()}catch(s){n.error(`Failed to delete: ${s.message}`)}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]},e.id))})]})]})})};export{ee as default};
