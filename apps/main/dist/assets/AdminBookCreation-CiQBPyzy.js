import{u as e,w as s,r as a,J as t,j as r,ao as n,l as i,C as o,b as l,d as c,e as d,y as h,a as m,O as u,I as x,T as p,S as g,p as j,q as f,s as w,t as v,K as b,B as N,U as y,W as k,E as C,F as S,a8 as P,a5 as _,L as F}from"./index-DGTvukq5.js";import{S as z}from"./separator-CgnUKQbQ.js";import{A as T,a as $,b as B,c as A,d as D,e as O,f as E,g as I,h as L}from"./alert-dialog-T6vsfLcH.js";import{D as q,a as R,b as M,c as U}from"./dropdown-menu-WQP2sNky.js";import{A as G}from"./AdminLayout-BRLZp4iC.js";import{s as J}from"./supabase-DWL4C3fA.js";import{E as W}from"./jspdf.es.min-CwqyglcI.js";import{W as Y}from"./wand-sparkles-lRG5n9i8.js";import{I as K}from"./image-BbyXBLK1.js";import{T as V}from"./trash-2-BpM8jHBU.js";import{U as H}from"./upload-DXMRZFru.js";import{D as Q}from"./download-BtONrFw3.js";import{C as Z}from"./circle-alert-CF23T1As.js";const X=5e3,ee=()=>{const ee=e(),{admin:se,loading:ae}=s(),te=a.useRef(null),[re,ne]=a.useState(""),[ie,oe]=a.useState(""),[le,ce]=a.useState(""),[de,he]=a.useState(""),[me,ue]=a.useState(""),[xe,pe]=a.useState(""),[ge,je]=a.useState(""),[fe,we]=a.useState("gemini-3-pro-preview"),[ve,be]=a.useState(!1),[Ne,ye]=a.useState(!1),[ke,Ce]=a.useState(null),[Se,Pe]=a.useState(0),[_e,Fe]=a.useState(0),[ze,Te]=a.useState(0),[$e,Be]=a.useState(""),[Ae,De]=a.useState(null),[Oe,Ee]=a.useState(null),[Ie,Le]=a.useState(!1),[qe,Re]=a.useState([]),[Me,Ue]=a.useState(!0),[Ge,Je]=a.useState(null),[We,Ye]=a.useState(0),[Ke,Ve]=a.useState(""),He=a.useRef(null);a.useEffect(()=>{ae||se?se&&Qe():ee("/admin/login")},[se,ae,ee]);const Qe=async()=>{Ue(!0);try{const{data:e,error:s}=await J.from("books").select("*").order("created_at",{ascending:!1});if(s)throw s;Re(e||[])}catch(e){console.error("Error loading books:",e),t.error("Failed to load books")}finally{Ue(!1)}},Ze=async(e,s,a,t,r)=>{const n=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/book-process-chunk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chunkText:e,chunkIndex:s,totalChunks:a,bookId:t,chapterId:r,newAuthor:ie,originalAuthor:le||void 0,newCompany:de||void 0,originalCompany:me||void 0,model:fe})});if(!n.ok){const e=await n.json();throw new Error(e.error||"Failed to process chunk")}return(await n.json()).processedText},Xe=()=>{ne(""),oe(""),ce(""),he(""),ue(""),pe(""),je(""),De(null),Ee(null),Ce(null),Pe(0),Fe(0),Te(0),Be("")},es=async(e,s)=>{var a;try{const t=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/translation-service",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,sourceLang:"en",targetLang:s,bypassCache:!0})});if(!t.ok)throw new Error("Translation failed");return(null==(a=(await t.json()).result)?void 0:a.translation)||e}catch(t){return console.error("Translation error:",t),e}},ss=async(e,s)=>{const a=qe.find(s=>s.id===e);if(a){Je(e),Ye(0),Ve("Loading chapters...");try{const{data:r,error:n}=await J.from("book_chapters").select("chapter_number, chapter_title, processed_content").eq("book_id",e).eq("status","completed").order("chapter_number",{ascending:!0});if(n)throw n;if(!r||0===r.length)return t.error("No completed chapters found"),void Je(null);const i=new W({orientation:"portrait",unit:"mm",format:"a4"}),o=i.internal.pageSize.getWidth(),l=i.internal.pageSize.getHeight(),c=20,d=o-2*c,h=7;let m=c;const u={en:"English",ko:"한국어",zh:"中文"};i.setFontSize(28);const x="en"===s?a.title:await es(a.title,s),p=i.splitTextToSize(x,d);i.text(p,o/2,l/3,{align:"center"}),i.setFontSize(16);const g="en"===s?"by":"ko"===s?"저자:":"作者:";i.text(`${g} ${a.author}`,o/2,l/3+30,{align:"center"}),a.company&&(i.setFontSize(12),i.text(a.company,o/2,l/3+45,{align:"center"})),i.setFontSize(10),i.text(`Language: ${u[s]}`,o/2,l-c,{align:"center"});for(let e=0;e<r.length;e++){const a=r[e];Ye(Math.round((e+1)/r.length*100)),Ve("en"===s?`Processing chapter ${e+1} of ${r.length}...`:`Translating chapter ${e+1} of ${r.length}...`),i.addPage(),m=c,i.setFontSize(18);const t="en"===s?a.chapter_title||`Chapter ${a.chapter_number}`:await es(a.chapter_title||`Chapter ${a.chapter_number}`,s),n=i.splitTextToSize(t,d);if(i.text(n,c,m),m+=10*n.length+10,a.processed_content){i.setFontSize(11);let e=a.processed_content;if("en"!==s){const a=e.split("\n\n").filter(e=>e.trim()),t=[];for(let e=0;e<a.length;e++){const r=await es(a[e],s);t.push(r),e<a.length-1&&await new Promise(e=>setTimeout(e,300))}e=t.join("\n\n")}const t=e.split("\n\n").filter(e=>e.trim());for(const s of t){const e=i.splitTextToSize(s.trim(),d);for(const s of e)m+h>l-c&&(i.addPage(),m=c),i.text(s,c,m),m+=h;m+=3}}}const j="en"===s?"":`_${s}`,f=`${a.title.replace(/[^a-zA-Z0-9]/g,"_")}${j}.pdf`;i.save(f),t.success(`PDF downloaded: ${f}`),Ve(""),Ye(0)}catch(r){console.error("Error generating PDF:",r),t.error(`PDF generation failed: ${r.message}`)}finally{Je(null)}}else t.error("Book not found")},as=e=>{switch(e){case"draft":return r.jsxs(i,{variant:"secondary",children:[r.jsx(Z,{className:"w-3 h-3 mr-1"}),"Draft"]});case"processing":return r.jsxs(i,{variant:"default",className:"bg-yellow-500",children:[r.jsx(n,{className:"w-3 h-3 mr-1 animate-spin"}),"Processing"]});case"published":return r.jsxs(i,{variant:"default",className:"bg-green-500",children:[r.jsx(F,{className:"w-3 h-3 mr-1"}),"Published"]});case"archived":return r.jsxs(i,{variant:"outline",children:[r.jsx(_,{className:"w-3 h-3 mr-1"}),"Archived"]});default:return r.jsx(i,{variant:"outline",children:e})}};if(ae)return r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsx(n,{className:"w-8 h-8 animate-spin"})});if(!se)return null;const ts=ge.split(/\s+/).filter(Boolean).length,rs=Math.ceil(ge.length/X),ns=15*rs;return r.jsx(G,{title:"Book Creation",showBackButton:!0,backPath:"/admin/ielts",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:"Book Creation Studio"}),r.jsx("p",{className:"text-muted-foreground",children:"Paraphrase and publish educational books with AI assistance"})]}),r.jsxs(i,{variant:"secondary",className:"text-sm",children:[r.jsx(Y,{className:"w-4 h-4 mr-1"}),"AI-Powered"]})]}),r.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[r.jsx("div",{className:"lg:col-span-2 space-y-6",children:r.jsxs(o,{children:[r.jsxs(l,{children:[r.jsxs(c,{className:"flex items-center gap-2",children:[r.jsx(d,{className:"w-5 h-5"}),"Create New Book"]}),r.jsx(h,{children:"Paste your content and let AI paraphrase it while replacing author and company names"})]}),r.jsxs(m,{className:"space-y-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"title",children:"Book Title *"}),r.jsx(x,{id:"title",placeholder:"Enter the book title",value:re,onChange:e=>ne(e.target.value),disabled:ve})]}),r.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"newAuthor",children:"New Author Name *"}),r.jsx(x,{id:"newAuthor",placeholder:"Your author name",value:ie,onChange:e=>oe(e.target.value),disabled:ve})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"originalAuthor",children:"Original Author (to replace)"}),r.jsx(x,{id:"originalAuthor",placeholder:"Original author name to find & replace",value:le,onChange:e=>ce(e.target.value),disabled:ve})]})]}),r.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"newCompany",children:"New Company/Publisher"}),r.jsx(x,{id:"newCompany",placeholder:"Your company name",value:de,onChange:e=>he(e.target.value),disabled:ve})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"originalCompany",children:"Original Company (to replace)"}),r.jsx(x,{id:"originalCompany",placeholder:"Original company to find & replace",value:me,onChange:e=>ue(e.target.value),disabled:ve})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"description",children:"Book Description"}),r.jsx(p,{id:"description",placeholder:"Brief description of the book...",value:xe,onChange:e=>pe(e.target.value),disabled:ve,rows:2})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{children:"AI Model"}),r.jsxs(g,{value:fe,onValueChange:e=>we(e),disabled:ve,children:[r.jsx(j,{children:r.jsx(f,{})}),r.jsxs(w,{children:[r.jsx(v,{value:"gemini-3-pro-preview",children:"Gemini 3 Pro (Google) - Best Quality"}),r.jsx(v,{value:"deepseek-v3",children:"DeepSeek V3 (OpenRouter) - Fast & Efficient"})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(u,{htmlFor:"content",children:"Book Content *"}),r.jsxs("span",{className:"text-sm text-muted-foreground",children:[ts.toLocaleString()," words | ~",rs," chunks | ~",Math.ceil(ns/60)," min"]})]}),r.jsx(p,{id:"content",placeholder:"Paste your entire book content here (supports 100-200+ pages)...",value:ge,onChange:e=>je(e.target.value),disabled:ve,rows:15,className:"font-mono text-sm"})]}),ve&&r.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm font-medium",children:$e}),r.jsxs("span",{className:"text-sm text-muted-foreground",children:[_e," / ",ze," chunks"]})]}),r.jsx(b,{value:Se,className:"h-2"}),r.jsxs("p",{className:"text-xs text-muted-foreground",children:["Processing with ",fe,". This may take several minutes for large books."]})]}),r.jsxs("div",{className:"flex gap-3",children:[ve?r.jsx(r.Fragment,{children:Ne?r.jsxs(N,{onClick:async()=>{t.info("Resume feature coming soon. Please restart processing.")},children:[r.jsx(k,{className:"w-4 h-4 mr-2"}),"Resume"]}):r.jsxs(N,{variant:"secondary",onClick:()=>{var e;ye(!0),null==(e=He.current)||e.abort(),t.info("Processing paused")},children:[r.jsx(y,{className:"w-4 h-4 mr-2"}),"Pause"]})}):r.jsxs(N,{onClick:async()=>{var e,s;if(re.trim()&&ie.trim()&&ge.trim()){be(!0),ye(!1),Be("Creating book..."),He.current=new AbortController;try{const{data:r,error:n}=await J.from("books").insert({title:re,author:ie,original_author:le||null,company:de||null,original_company:me||null,description:xe||null,status:"processing",processing_model:fe}).select().single();if(n)throw n;Ce(r.id);const i=(e=>{const s=[];let a=0;for(;a<e.length;){let t=a+X;if(t<e.length){const s=e.lastIndexOf("\n\n",t);if(s>a+3500)t=s+2;else{const s=e.lastIndexOf(". ",t);s>a+3500&&(t=s+2)}}s.push(e.slice(a,t).trim()),a=t}return s.filter(e=>e.length>0)})(ge);Te(i.length),Fe(0);const o=i.map((e,s)=>({book_id:r.id,chapter_number:s+1,chapter_title:`Chapter ${s+1}`,original_content:e,status:"pending"})),{data:l,error:c}=await J.from("book_chapters").insert(o).select();if(c)throw c;const{error:d}=await J.from("book_processing_jobs").insert({book_id:r.id,total_chunks:i.length,processed_chunks:0,current_chunk:0,status:"processing",processing_model:fe,started_at:(new Date).toISOString()});if(d)throw d;await J.from("books").update({total_chapters:i.length}).eq("id",r.id);for(let s=0;s<i.length;s++){if(Ne||(null==(e=He.current)?void 0:e.signal.aborted)){Be("Processing paused");break}Be(`Processing chunk ${s+1} of ${i.length}...`);try{await Ze(i[s],s,i.length,r.id,l[s].id);Fe(s+1),Pe((s+1)/i.length*100),s<i.length-1&&await new Promise(e=>setTimeout(e,1e3))}catch(a){console.error(`Error processing chunk ${s+1}:`,a),await J.from("book_chapters").update({status:"failed",error_message:a.message}).eq("id",l[s].id),a.message.includes("rate limit")&&(t.error("Rate limit reached. Pausing for 30 seconds..."),await new Promise(e=>setTimeout(e,3e4)),s--)}}Ne||(null==(s=He.current)?void 0:s.signal.aborted)||(Be("Processing complete!"),t.success("Book processing complete!"),await J.from("books").update({status:"draft"}).eq("id",r.id),Qe(),Xe())}catch(a){console.error("Error during processing:",a),t.error(`Processing failed: ${a.message}`),Be("Processing failed")}finally{be(!1)}}else t.error("Please fill in Title, New Author, and Content")},disabled:!re||!ie||!ge,children:[r.jsx(Y,{className:"w-4 h-4 mr-2"}),"Start Processing"]}),r.jsx(N,{variant:"outline",onClick:Xe,disabled:ve&&!Ne,children:"Clear Form"})]})]})]})}),r.jsxs("div",{className:"space-y-6",children:[r.jsxs(o,{children:[r.jsx(l,{children:r.jsxs(c,{className:"flex items-center gap-2",children:[r.jsx(K,{className:"w-5 h-5"}),"Book Cover"]})}),r.jsxs(m,{className:"space-y-4",children:[r.jsx("input",{ref:te,type:"file",accept:"image/*",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(a){if(!a.type.startsWith("image/"))return void t.error("Please select an image file");if(a.size>5242880)return void t.error("Image must be less than 5MB");De(a),Ee(URL.createObjectURL(a))}},className:"hidden"}),Oe?r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:Oe,alt:"Cover preview",className:"w-full h-48 object-cover rounded-lg"}),r.jsx(N,{size:"sm",variant:"secondary",className:"absolute top-2 right-2",onClick:()=>{De(null),Ee(null)},children:r.jsx(V,{className:"w-4 h-4"})})]}):r.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>{var e;return null==(e=te.current)?void 0:e.click()},children:[r.jsx(H,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to upload cover image"}),r.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PNG, JPG up to 5MB"})]}),ke&&Ae&&r.jsx(N,{className:"w-full",onClick:()=>(async e=>{var s;if(!Ae)return null;Le(!0);try{const{data:a}=await J.auth.getSession(),r=new FormData;r.append("file",Ae),r.append("path",`books/covers/${e}/${Ae.name}`),r.append("contentType",Ae.type);const n=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/r2-upload",{method:"POST",headers:{Authorization:`Bearer ${null==(s=null==a?void 0:a.session)?void 0:s.access_token}`},body:r});if(!n.ok)throw new Error("Failed to upload cover");const i=await n.json();return await J.from("books").update({cover_url:i.url}).eq("id",e),t.success("Cover uploaded successfully!"),Qe(),i.url}catch(a){return console.error("Error uploading cover:",a),t.error(`Failed to upload cover: ${a.message}`),null}finally{Le(!1)}})(ke),disabled:Ie,children:Ie?r.jsxs(r.Fragment,{children:[r.jsx(n,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):r.jsxs(r.Fragment,{children:[r.jsx(H,{className:"w-4 h-4 mr-2"}),"Upload Cover"]})})]})]}),r.jsxs(o,{children:[r.jsx(l,{children:r.jsx(c,{children:"Processing Info"})}),r.jsxs(m,{className:"space-y-3 text-sm",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{className:"text-muted-foreground",children:"Chunk Size"}),r.jsxs("span",{children:[X.toLocaleString()," chars"]})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{className:"text-muted-foreground",children:"Est. Processing"}),r.jsx("span",{children:"~15s per chunk"})]}),r.jsx(z,{}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Content is split into manageable chunks to avoid timeouts. Progress is saved after each chunk."})]})]})]})]}),r.jsx(z,{}),Ge&&r.jsxs("div",{className:"fixed bottom-6 right-6 z-50 bg-background border shadow-lg rounded-lg p-4 w-80",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[r.jsx(n,{className:"w-5 h-5 animate-spin text-primary"}),r.jsx("span",{className:"font-medium",children:"Generating PDF"})]}),r.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:Ke}),r.jsx(b,{value:We,className:"h-2"}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-1 text-right",children:[We,"%"]})]}),r.jsxs("div",{className:"space-y-4",children:[r.jsx("h2",{className:"text-xl font-semibold",children:"Your Books"}),Me?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsx(n,{className:"w-6 h-6 animate-spin"})}):0===qe.length?r.jsx(o,{children:r.jsxs(m,{className:"py-8 text-center",children:[r.jsx(d,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),r.jsx("p",{className:"text-muted-foreground",children:"No books created yet"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Create your first book above!"})]})}):r.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:qe.map(e=>r.jsxs(o,{className:"overflow-hidden",children:[r.jsx("div",{className:"h-32 bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center",children:e.cover_url?r.jsx("img",{src:e.cover_url,alt:e.title,className:"w-full h-full object-cover"}):r.jsx(d,{className:"w-12 h-12 text-muted-foreground"})}),r.jsxs(l,{className:"pb-2",children:[r.jsxs("div",{className:"flex items-start justify-between",children:[r.jsx(c,{className:"text-lg line-clamp-1",children:e.title}),as(e.status)]}),r.jsxs(h,{className:"line-clamp-1",children:["by ",e.author]})]}),r.jsxs(m,{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[r.jsxs("span",{children:[e.total_chapters," chapters"]}),r.jsx("span",{children:e.processing_model})]}),r.jsxs("div",{className:"flex gap-2 flex-wrap",children:[r.jsxs(N,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>ee(`/books/${e.id}?preview=true`),children:[r.jsx(C,{className:"w-4 h-4 mr-1"}),"Preview"]}),"draft"===e.status&&r.jsx(N,{size:"sm",className:"flex-1",onClick:()=>(async e=>{try{const{error:s}=await J.from("books").update({status:"published",published_at:(new Date).toISOString()}).eq("id",e);if(s)throw s;t.success("Book published successfully!"),Qe()}catch(s){t.error(`Failed to publish: ${s.message}`)}})(e.id),children:"Publish"}),r.jsxs(q,{children:[r.jsx(R,{asChild:!0,children:r.jsx(N,{size:"sm",variant:"secondary",disabled:Ge===e.id||0===e.total_chapters,children:Ge===e.id?r.jsx(n,{className:"w-4 h-4 animate-spin"}):r.jsx(Q,{className:"w-4 h-4"})})}),r.jsxs(M,{align:"end",children:[r.jsxs(U,{onClick:()=>ss(e.id,"en"),className:"cursor-pointer",children:[r.jsx(S,{className:"w-4 h-4 mr-2"}),"English PDF"]}),r.jsxs(U,{onClick:()=>ss(e.id,"ko"),className:"cursor-pointer",children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"한국어 (Korean) PDF"]}),r.jsxs(U,{onClick:()=>ss(e.id,"zh"),className:"cursor-pointer",children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"中文 (Chinese) PDF"]})]})]}),!e.cover_url&&r.jsx(N,{size:"sm",variant:"secondary",onClick:()=>{var s;Ce(e.id),null==(s=te.current)||s.click()},children:r.jsx(K,{className:"w-4 h-4"})}),r.jsxs(T,{children:[r.jsx($,{asChild:!0,children:r.jsx(N,{size:"sm",variant:"ghost",children:r.jsx(V,{className:"w-4 h-4 text-red-500"})})}),r.jsxs(B,{children:[r.jsxs(A,{children:[r.jsx(D,{children:"Delete Book"}),r.jsxs(O,{children:['Are you sure you want to delete "',e.title,'"? This action cannot be undone.']})]}),r.jsxs(E,{children:[r.jsx(I,{children:"Cancel"}),r.jsx(L,{onClick:()=>(async e=>{try{const{error:s}=await J.from("books").delete().eq("id",e);if(s)throw s;t.success("Book deleted successfully!"),Qe()}catch(s){t.error(`Failed to delete: ${s.message}`)}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]},e.id))})]})]})})};export{ee as default};
