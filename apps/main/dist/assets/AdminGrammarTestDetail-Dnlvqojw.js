import{r as e,j as t,C as n,b as r,c as s,a as i,B as a,J as o,ak as c,D as l,l as d,m as u,n as m,a8 as h,I as p,T as f}from"./index-C29BzD67.js";import{A as g}from"./AdminLayout-Dz357U_T.js";import{S as w}from"./separator-0dTeAATM.js";import{A as x,a as v}from"./alert-CeaTc7wS.js";import{s as _}from"./supabase-DUkWVuqu.js";import{V as j}from"./VocabularyQuizPreview-CnrAG2IY.js";const b=["QuestionFormat","WordOrSentence","CorrectAnswer","IncorrectAnswer1","IncorrectAnswer2","IncorrectAnswer3","Explanation"];function y(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const t=e.slice(0,180),n=Math.max(t.lastIndexOf("."),t.lastIndexOf(","),t.lastIndexOf(";"),t.lastIndexOf(":"));return(n>60?t.slice(0,n):t).trim()}function k(e){const t=[];let n="",r=!1;for(let s=0;s<e.length;s++){const i=e[s];'"'===i?r&&'"'===e[s+1]?(n+='"',s++):r=!r:","!==i||r?n+=i:(t.push(n),n="")}return t.push(n),t.map(e=>e.trim())}function I(e){return/^[A-Za-z][A-Za-z\-']*$/.test(e.trim())}function S(e){const t=e.toLowerCase();return/ly$/.test(t)?"adverb":/(tion|ment|ness|ity|ance|ence|ship|ism)$/.test(t)?"noun":/(ous|ive|able|ible|al|ic|ical|ary|ory)$/.test(t)?"adjective":"verb"}const A={verb:["mitigate","undermine","amplify","circumvent","invalidate","corroborate","repudiate"],noun:["anomaly","paradigm","tenet","conjecture","impetus","nuance","rebuttal"],adjective:["pervasive","tentative","redundant","spurious","intrinsic","ambiguous","salient"],adverb:["ostensibly","tangentially","inadvertently","inherently","predominantly","marginally"]};function q(e,t){const n=A[e]||A.verb;for(const s of n)if(!t.has(s))return s;let r=1;for(;t.has(`option${r}`);)r++;return`option${r}`}const N=["A temporary or short-lived occurrence","An idea that lacks practical application","Something rare or infrequently encountered","A minor detail with little significance","A device used to measure performance"];function F(e,t){for(const r of N)if(!t.has(r)&&r.toLowerCase()!==e.toLowerCase())return r;let n=1;for(;t.has(`Unrelated definition ${n}`);)n++;return`Unrelated definition ${n}`}function $(e,t,n){const r=[],s=[],i=[];let a=(e||"").replace(/^\uFEFF/,"");a=function(e){return e.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'")}(a),a=function(e){const t=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",n=(t.match(/,/g)||[]).length;return(t.match(/;/g)||[]).length>0&&0===n?e.replace(/;/g,","):e}(a);const o=a.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===o.length)return{ok:!1,skill_type:t,skill_test_id:n,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${b.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const c=k(o[0]).map(e=>e.replace(/^"|"$/g,"").trim()),l={};c.forEach((e,t)=>l[e]=t);const d=b.filter(e=>void 0===l[e]);if(d.length>0)return{ok:!1,skill_type:t,skill_test_id:n,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${d.join("; ")}. Expected: ${b.join(",")}`,raw:Object.fromEntries(c.map((e,t)=>[t.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=o.slice(1);u.forEach((e,a)=>{const o=a+1,c=k(e),d=e=>y(function(e){return e.replace(/<[^>]*>/g,"")}(c[l[e]]||""));let u=d("QuestionFormat");const m=C(d("WordOrSentence"));let h=C(d("CorrectAnswer")),p=C(d("IncorrectAnswer1")),f=C(d("IncorrectAnswer2")),g=C(d("IncorrectAnswer3")),w=C(d("Explanation"));const x={QuestionFormat:u,WordOrSentence:m,CorrectAnswer:h,IncorrectAnswer1:p,IncorrectAnswer2:f,IncorrectAnswer3:g,Explanation:w};if(!u||!m||!h)return void s.push({row:o,message:"Missing critical fields",raw:x});if("DefinitionMatch"!==u&&"SentenceFillIn"!==u){const e=function(e){const t=e.replace(/[^a-z]/gi,"").toLowerCase();return["definitionmatch","definitionmatching","defmatch","definition","def"].includes(t)?"DefinitionMatch":["sentencefillin","sentencefill","fillintheblank","fillblanks","fillblank","blank","cloze","clozetest","grammarfixit","grammarfixitquestions","grammarfix"].includes(t)?"SentenceFillIn":null}(u);if(e)r.push({row:o,message:`Corrected QuestionFormat to ${e}`}),u=e;else{const e=/_{2,}/.test(m),t=I(m),n=h.split(" ").length>=3,s=e?"SentenceFillIn":t&&n?"DefinitionMatch":"SentenceFillIn";r.push({row:o,message:`Guessed QuestionFormat as ${s} from data`}),u=s}}let v=m,_=h,j=[p,f,g].filter(e=>null!=e);if("DefinitionMatch"===u){if(!I(v)){const e=v.split(/[^A-Za-z\-']/).filter(Boolean)[0]||v.split(" ")[0];e&&I(e)?(r.push({row:o,message:`Extracted headword '${e}' from phrase`}),v=e):r.push({row:o,message:"Content appears to be a phrase; accepted as-is"})}const e=new Set([_.toLowerCase(),...j.map(e=>e.toLowerCase())]);j=j.map(e=>e||"");for(let t=0;t<j.length;t++){let n=j[t];if(!n||n.length<2){const n=F(_,e);j[t]=n,e.add(n.toLowerCase()),r.push({row:o,message:"Replaced trivial/empty distractor with plausible definition"})}}}else if("SentenceFillIn"===u){const e=function(e,t,n){const r=(e.match(/_+/g)||[]).filter(e=>e.length>=2);if(r.length>1)return{content:e,error:"Multiple blanks detected"};if(0===r.length){const r=new RegExp(`\\b${t.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}\\b`,"i");if(r.test(e))return n.push("Inserted blank by replacing the correct answer occurrence"),{content:e.replace(r,"_______")};const s=Math.max(e.lastIndexOf(" "),0);return n.push("Inserted a blank at a natural position"),{content:e.slice(0,s)+" _______"+e.slice(s)}}return{content:e.replace(/_+/g,"_______")}}(v,_,[]);if(e.error)return void s.push({row:o,message:e.error,raw:x});v=e.content,_=y(_);let t=j.map(e=>y(e||""));const n=new Set([_.toLowerCase(),...t.map(e=>e.toLowerCase()).filter(Boolean)]);for(let s=0;s<t.length;s++)if(!t[s]){const e=q(S(_.split(" ")[0]||_),n);t[s]=e,n.add(e.toLowerCase()),r.push({row:o,message:"Filled missing distractor"})}j=t}const b=[_,...j].map(e=>y(e)),A=new Set;let N=b.filter(e=>{const t=e.toLowerCase();return!A.has(t)&&(A.add(t),!0)});if(N.length<4){const e=new Set(N.map(e=>e.toLowerCase())),t=4-N.length;for(let n=0;n<t;n++){if("SentenceFillIn"===u){const t=q(S(_.split(" ")[0]||_),e);N.push(t),e.add(t.toLowerCase())}else{const t=F(_,e);N.push(t),e.add(t.toLowerCase())}r.push({row:o,message:"Added synthesized distractor to ensure 4 unique options"})}}const $=N[0],L=N.slice(1,4);i.push({skill_type:t,skill_test_id:n,question_format:u,content:C(v),correct_answer:C($),incorrect_answers:L.map(C),explanation:C(w||"")})});const m=new Set(r.map(e=>e.row)).size;return{ok:i.length>0,skill_type:t,skill_test_id:n,insert:i,warnings:r,errors:s,summary:{rows_received:u.length,rows_valid:i.length,rows_with_warnings:m,rows_with_errors:s.length}}}function L({skillTestId:c,onImported:l}){const[d,u]=e.useState(null),[m,h]=e.useState([]),[p,f]=e.useState(null),[g,w]=e.useState(!1),j=e.useRef(null);return t.jsxs(n,{children:[t.jsx(r,{children:t.jsx(s,{className:"text-base",children:"Upload Grammar CSV"})}),t.jsxs(i,{className:"space-y-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{ref:j,type:"file",accept:".csv",className:"hidden",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];n&&(async t=>{var n;try{u(null),h([]),f(null);const e=$(await t.text(),"Grammar Fix-it",c);if(f(e),0===e.insert.length){const t=(null==(n=e.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void u(t)}e.errors.length>0&&o.warning(`${e.errors.length} row(s) have errors and will be skipped`),e.warnings.length>0&&o.message(`${e.warnings.length} warning(s) during normalization`),h(e.insert)}catch(e){u(e.message||"Failed to parse CSV")}})(n)}}),t.jsx(a,{onClick:()=>{var e;return null==(e=j.current)?void 0:e.click()},children:"Choose CSV"}),t.jsx(a,{variant:"secondary",onClick:()=>{const e=['SentenceFillIn,"She has been _______ English for five years.","studying","study","studies","studied","Use present perfect continuous for ongoing actions"','DefinitionMatch,"Subject-verb agreement","The subject and verb must agree in number","A tense that shows completed actions","A clause that cannot stand alone","A verb form used as a noun","Basic grammar rule"'].join("\n"),t=new Blob(["QuestionFormat,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="grammar-fix-it-template.csv",r.click(),URL.revokeObjectURL(n)},children:"Download Template"})]}),d&&t.jsx(x,{variant:"destructive",children:t.jsx(v,{children:d})}),m.length>0&&t.jsxs("div",{className:"space-y-2",children:[p&&t.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",m.length," valid row(s)",p.warnings.length>0&&` • ${p.warnings.length} warning(s)`,p.errors.length>0&&` • ${p.errors.length} error row(s) skipped`]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(a,{onClick:async()=>{if(p&&0!==p.insert.length){w(!0);try{const{error:e}=await _.from("skill_practice_questions").insert(p.insert);if(e)throw e;o.success(`Imported ${p.insert.length} questions`),h([]),f(null),null==l||l()}catch(e){console.error(e),o.error(e.message||"Import failed")}finally{w(!1)}}},disabled:g,children:g?"Importing...":"Import"}),t.jsx(a,{variant:"secondary",onClick:()=>{h([]),f(null)},children:"Cancel"})]}),t.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[m.slice(0,10).map((e,n)=>t.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[t.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),t.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},n)),m.length>10&&t.jsxs("div",{className:"text-muted-foreground",children:["...and ",m.length-10," more"]})]})]})]})]})}const E=()=>{const{id:o}=c(),[x,v]=e.useState(null),[b,y]=e.useState([]),[C,k]=e.useState(null),[I,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:""}),[A,q]=e.useState(null),N=e.useRef(null),F=async()=>{if(!o)return;const{data:e}=await _.from("skill_tests").select("id,title").eq("id",o).maybeSingle();v(e??null);const{data:t}=await _.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",o).order("created_at",{ascending:!1});y(t??[])};return e.useEffect(()=>{F()},[o]),t.jsxs(g,{title:x?`Manage: ${x.title}`:"Manage Grammar Test",showBackButton:!0,children:[t.jsxs("section",{className:"space-y-6",children:[o&&t.jsx(L,{skillTestId:o,onImported:F}),t.jsx(w,{}),t.jsx("div",{ref:N,children:t.jsxs(n,{children:[t.jsx(r,{children:t.jsx(s,{className:"text-base",children:"Student Preview"})}),t.jsx(i,{children:t.jsx(j,{questions:b,selectedQuestionId:A||void 0})})]})}),t.jsxs(n,{children:[t.jsx(r,{children:t.jsx(s,{className:"text-base",children:"Questions"})}),t.jsx(i,{className:"space-y-3",children:0===b.length?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):b.map(e=>t.jsx("div",{className:"p-3 border rounded-md space-y-2",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{onClick:()=>{return t=e.id,q(t),void requestAnimationFrame(()=>{var e;null==(e=N.current)||e.scrollIntoView({behavior:"smooth",block:"start"})});var t},className:"cursor-pointer",children:[t.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),t.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),t.jsxs("div",{className:"flex gap-2 shrink-0",children:[t.jsx(a,{size:"sm",onClick:()=>(e=>{var t,n,r;k(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(t=e.incorrect_answers)?void 0:t[0])||"",incorrect2:(null==(n=e.incorrect_answers)?void 0:n[1])||"",incorrect3:(null==(r=e.incorrect_answers)?void 0:r[2])||"",explanation:e.explanation||""})})(e),children:"Edit"}),t.jsx(a,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await _.from("skill_practice_questions").delete().eq("id",e),await F())})(e.id),children:"Delete"})]})]})},e.id))})]})]}),t.jsx(l,{open:!!C,onOpenChange:e=>{e||k(null)},children:t.jsxs(d,{className:"sm:max-w-lg",children:[t.jsx(u,{children:t.jsx(m,{children:"Edit Question"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx(h,{htmlFor:"question_format",children:"Format"}),t.jsx(p,{id:"question_format",value:I.question_format,onChange:e=>S({...I,question_format:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(h,{htmlFor:"content",children:"Content"}),t.jsx(f,{id:"content",value:I.content,onChange:e=>S({...I,content:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(h,{htmlFor:"correct_answer",children:"Correct Answer"}),t.jsx(p,{id:"correct_answer",value:I.correct_answer,onChange:e=>S({...I,correct_answer:e.target.value})})]}),t.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[t.jsxs("div",{children:[t.jsx(h,{children:"Incorrect 1"}),t.jsx(p,{value:I.incorrect1,onChange:e=>S({...I,incorrect1:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(h,{children:"Incorrect 2"}),t.jsx(p,{value:I.incorrect2,onChange:e=>S({...I,incorrect2:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(h,{children:"Incorrect 3"}),t.jsx(p,{value:I.incorrect3,onChange:e=>S({...I,incorrect3:e.target.value})})]})]}),t.jsxs("div",{children:[t.jsx(h,{htmlFor:"explanation",children:"Explanation"}),t.jsx(f,{id:"explanation",value:I.explanation,onChange:e=>S({...I,explanation:e.target.value})})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx(a,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),t.jsx(a,{onClick:async()=>{if(!C)return;const e=[I.incorrect1,I.incorrect2,I.incorrect3].filter(Boolean),{error:t}=await _.from("skill_practice_questions").update({content:I.content,question_format:I.question_format,correct_answer:I.correct_answer,incorrect_answers:e,explanation:I.explanation}).eq("id",C.id);t||(k(null),await F())},children:"Save"})]})]})})]})};export{E as default};
