import{_ as e}from"./supabase-DWL4C3fA.js";import{c as s,r as t,j as a,C as r,b as i,d as n,a as l,B as o,J as d,u as c,G as u,w as m,g as x,l as p,L as b,bb as h,I as g,H as f,T as j,N as w}from"./index-BG1vve5R.js";import{A as N}from"./AdminLayout-DpzV0QUI.js";import{I as v}from"./ImageQuestionExtractor-U-lMSRHl.js";import{U as y}from"./upload-DDVdSGYe.js";import{T as k}from"./trash-2-CazcZ_bL.js";import"./image-dwHBkxmX.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=s("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]);function T({audioFile:e,onTrimComplete:s}){const[c,u]=t.useState(0),[m,x]=t.useState([0,0]),[p,b]=t.useState(!1),h=t.useRef(null),g=t.useRef(null),f=t.useState(()=>URL.createObjectURL(e))[0];t.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),t.useEffect(()=>{const e=h.current;if(!e)return;const s=()=>{const s=e.duration;u(s),x([0,s])};return e.addEventListener("loadedmetadata",s),()=>e.removeEventListener("loadedmetadata",s)},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return a.jsxs(r,{className:"border-2 border-purple-200 dark:border-purple-800",children:[a.jsx(i,{children:a.jsxs(n,{className:"flex items-center gap-2",children:[a.jsx(F,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsx("audio",{ref:h,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const s=e.currentTarget.currentTime;s<m[0]?e.currentTarget.currentTime=m[0]:s>m[1]&&(e.currentTarget.currentTime=m[0],e.currentTarget.pause())}}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[a.jsxs("span",{children:["Start: ",j(m[0])]}),a.jsxs("span",{children:["End: ",j(m[1])]})]}),a.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[a.jsx("input",{type:"range",min:0,max:c,step:.1,value:m[0],onChange:e=>{const s=parseFloat(e.target.value);s<m[1]&&x([s,m[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("input",{type:"range",min:0,max:c,step:.1,value:m[1],onChange:e=>{const s=parseFloat(e.target.value);s>m[0]&&x([m[0],s])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:a.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:m[0]/c*100+"%",right:100-m[1]/c*100+"%",position:"absolute"}})})]}),a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["Duration: ",j(c)]}),a.jsxs("span",{children:["Trimmed Length: ",j(m[1]-m[0])]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx(o,{onClick:async()=>{const[t,a]=m;if(t>=a)d.error("Start time must be before end time");else{b(!0);try{const r=await e.arrayBuffer();g.current||(g.current=new(window.AudioContext||window.webkitAudioContext));const i=g.current,n=await i.decodeAudioData(r),l=Math.floor(t*n.sampleRate),o=Math.floor(a*n.sampleRate)-l,c=i.createBuffer(n.numberOfChannels,o,n.sampleRate);for(let e=0;e<n.numberOfChannels;e++){const s=n.getChannelData(e),t=c.getChannelData(e);for(let e=0;e<o;e++)t[e]=s[l+e]}const u=function(e){const s=e.length*e.numberOfChannels*2+44,t=new ArrayBuffer(s),a=new DataView(t),r=[];let i=0,n=0;const l=e=>{a.setUint16(n,e,!0),n+=2},o=e=>{a.setUint32(n,e,!0),n+=4};o(1179011410),o(s-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(s-n-4);for(let d=0;d<e.numberOfChannels;d++)r.push(e.getChannelData(d));for(;n<s;){for(let s=0;s<e.numberOfChannels;s++){let e=Math.max(-1,Math.min(1,r[s][i]));e=e<0?32768*e:32767*e,a.setInt16(n,e,!0),n+=2}i++}return t}(c),m=new Blob([u],{type:"audio/wav"}),x=new File([m],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});s(x,t,a),d.success(`Audio trimmed: ${t.toFixed(1)}s to ${a.toFixed(1)}s`)}catch(r){console.error("Trim error:",r),d.error(`Failed to trim audio: ${r.message}`)}finally{b(!1)}}},disabled:p,className:"flex-1",children:p?"Trimming...":"Apply Trim"})})]})]})}const _=()=>{const s=c(),{testType:_,testId:A}=u(),{admin:E,loading:U}=m(),C=_||"ielts",S=`/admin/${C}/listening`,{listContent:I,createContent:q,uploadAudio:L}=x(),[R,O]=t.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,saved:!1}),[P,$]=t.useState(!1),[M,D]=t.useState(!1),[z,B]=t.useState(!1);t.useState(!1);const[G,Q]=t.useState({}),[J,V]=t.useState(!1),[W,H]=t.useState([]),[Y,K]=t.useState(1),X=e=>e<=0||e<=10?1:e<=20?2:e<=30?3:4,Z=W.map((e,s)=>{const t=e.question_number_in_part||s+1,a=e.part_number||X(t);return{...e,displayNumber:t,part:a}}).reduce((e,s)=>(e[s.part]=e[s.part]?[...e[s.part],s]:[s],e),{});t.useEffect(()=>{U||E||s("/admin/login")},[E,U,s]),t.useEffect(()=>{ee()},[_,A]);const ee=async()=>{const s=_||"IELTS";if(console.log("üîÑ loadExistingData called with testType:",s,"testId:",A),A)try{const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await s.from("tests").select("*").eq("id",A).maybeSingle();if(!t)return void console.log("‚ö†Ô∏è No existing test found for testId:",A);console.log("üìã Found existing test:",t.test_name),console.log("üìº Audio URL from tests table:",t.audio_url);const{data:a}=await s.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});console.log("üìä Found",(null==a?void 0:a.length)||0,"questions for this test");const r=t.audio_url||(a&&a.length>0?a[0].audio_url:null);if(console.log("üìº Final audio URL to use:",r),a&&a.length>0){const e=a[0],s=a.map((e,s)=>{const t=e.question_number_in_part||s+1,a=e.part_number||X(t);return{question_text:e.question_text,question_type:e.question_type,options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:[],correct_answer:e.correct_answer,explanation:e.explanation,part_number:a,question_number_in_part:t}});H(s);const i=JSON.stringify(s),n=new File([i],"existing-questions.json",{type:"application/json"});O({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:r||null,csvFile:n,transcriptText:e.transcription||"",answerImageFile:null,saved:!0}),r?d.success(`Existing audio loaded: ${r.split("/").pop()}`):console.warn("‚ö†Ô∏è No audio URL found in database for this test")}else console.log("‚ö†Ô∏è No questions found, loading audio from tests table"),O(e=>({...e,title:t.test_name,existingAudioUrl:r||null,saved:!0})),r?(console.log("‚úÖ Audio URL loaded from tests table:",r),d.success(`Existing audio loaded: ${r.split("/").pop()}`)):console.warn("‚ö†Ô∏è No audio URL found in tests table")}catch(t){console.error("Error loading existing data:",t),d.error("Failed to load existing data")}else console.log("‚ö†Ô∏è Skipping loadExistingData - missing testId")},se=(e,s)=>{O(t=>({...t,[e]:s,saved:!1}))},te=async()=>{if(0!==W.length)if(R.transcriptText){B(!0);try{console.log("ü§ñ Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await s.functions.invoke("generate-listening-explanations",{body:{questions:W,transcriptText:R.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const r=W.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});H(r);const i=JSON.stringify(r),n=new File([i],"questions-with-explanations.json",{type:"application/json"});se("csvFile",n),d.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(s){console.error("Error generating explanations:",s),d.error(`Failed to generate explanations: ${s.message}`)}finally{B(!1)}}else d.error("Please provide a transcript first");else d.error("Please upload questions first")};return U?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):E?a.jsx(N,{title:`${C.toUpperCase()} Test ${A} - Listening Management`,showBackButton:!0,backPath:S,onBackClick:()=>s(S),children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-[#2f241f]",children:[C.toUpperCase()," Test ",A," - Listening Management"]}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Note theme: warm paper, clear contrast, and per-part review."})]}),a.jsxs(p,{variant:"secondary",className:"text-sm bg-amber-100 text-amber-900 border-amber-200",children:["Test ",A]})]}),a.jsxs(r,{className:"border border-[#eadfd3] bg-[#fdfaf3] shadow-sm",children:[a.jsx(i,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(n,{className:"flex items-center gap-2",children:[R.saved?a.jsx(b,{className:"w-5 h-5 text-green-500"}):a.jsx(h,{className:"w-5 h-5 text-muted-foreground"}),"Listening Test - All Parts (1-4)"]}),a.jsx(p,{variant:R.saved?"default":"outline",children:R.saved?"Saved":"Not Saved"})]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Test Name *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:'Give this test a descriptive name (e.g., "IELTS Listening Test 1 - Cambridge 18")'}),a.jsx(g,{placeholder:`IELTS Listening Test ${A}`,value:R.title,onChange:e=>se("title",e.target.value),className:"max-w-md bg-white/80 border-[#e0d6c7] focus:border-amber-400 focus:ring-amber-200"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Audio File (All 4 Parts) *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload one continuous audio file containing all 4 parts of the listening test (approximately 30 minutes)"}),a.jsxs("div",{className:"border-2 border-dashed border-[#e0d6c7] bg-white/80 rounded-lg p-6 hover:bg-amber-50 transition-colors",children:[a.jsx("div",{className:"flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(f,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),a.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload MP3 or WAV audio file (recommended: 30-40 minutes)"}),a.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{O(s=>({...s,audioFile:e})),O(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),V(!0),d.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),a.jsxs(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},className:"bg-amber-50 border-amber-200 text-amber-900 hover:bg-amber-100",children:[a.jsx(y,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),R.audioFile&&a.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["‚úì Audio file ready: ",R.audioFile.name]}),a.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(R.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>V(!0),className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-green-200 text-green-800 dark:text-green-200",children:[a.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim Audio"]})]}),a.jsx("audio",{controls:!0,src:URL.createObjectURL(R.audioFile),className:"w-full mt-3 h-8"})]}),!R.audioFile&&R.existingAudioUrl&&a.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:"‚úì Audio file already uploaded"}),a.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1 break-all",children:R.existingAudioUrl.split("/").pop()}),a.jsxs("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:[a.jsx("source",{src:R.existingAudioUrl,type:"audio/mpeg"}),"Your browser does not support the audio element."]})]}),a.jsxs("div",{className:"flex space-x-2 ml-4",children:[a.jsxs(o,{variant:"outline",size:"sm",onClick:async()=>{if(R.existingAudioUrl)try{const e=d.loading("Loading audio for editing..."),s=await fetch(R.existingAudioUrl),t=await s.blob(),a=R.existingAudioUrl.split("/").pop()||"existing-audio.mp3",r=new File([t],a,{type:t.type});O(e=>({...e,audioFile:r})),V(!0),d.dismiss(e),d.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),d.dismiss(),d.error("Failed to load audio for editing")}},className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-blue-200 text-blue-800 dark:text-blue-200",children:[a.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim / Modify"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(O(e=>({...e,existingAudioUrl:null,audioFile:null})),d.success("Audio deleted"))},className:"bg-white/50 hover:bg-red-50 dark:bg-black/20 dark:hover:bg-red-900/20 border-red-200 text-red-600 dark:text-red-400",children:[a.jsx(k,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),J&&R.audioFile&&a.jsx(T,{audioFile:R.audioFile,onTrimComplete:(e,s,t)=>{se("audioFile",e),se("audioTrimStart",s),se("audioTrimEnd",t),V(!1),d.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("label",{className:"text-sm font-medium",children:["Transcript Text ",a.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional)"})]}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Paste the full transcript text here. AI will automatically sync it with the audio for the student viewer."}),a.jsx(j,{placeholder:"Paste the full transcript text here...",value:R.transcriptText,onChange:e=>se("transcriptText",e.target.value),rows:6,className:"font-mono text-sm bg-white/80 border-[#e0d6c7] focus:border-amber-400 focus:ring-amber-200"}),R.transcriptText&&a.jsx("div",{className:"p-3 bg-amber-50 rounded-lg border border-amber-200",children:a.jsxs("p",{className:"text-xs text-amber-900 flex items-center gap-2",children:[a.jsx(w,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save."]})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Answer Image & Questions (All 40 Questions) *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload an image of the questions/answer sheet. The image will be stored as the Answer Image, and you can extract questions from it using AI."}),a.jsx(v,{testId:A||"",testType:C,initialImageFile:R.answerImageFile,onImageSelected:e=>se("answerImageFile",e),onQuestionsExtracted:e=>{console.log("‚ú® AI extracted questions:",e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});H(e),se("csvFile",t),d.success(`Ready to save ${e.length} AI-extracted questions!`)}})]}),W.length>0&&a.jsxs("div",{className:"space-y-6 border-t pt-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"text-lg font-semibold text-[#2f241f]",children:"Review by Part (Note Theme)"}),a.jsx("div",{className:"flex gap-2",children:[1,2,3,4].map(e=>a.jsxs(o,{variant:Y===e?"default":"outline",size:"sm",className:Y===e?"bg-amber-500 hover:bg-amber-600 text-white":"bg-white/70 border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",onClick:()=>K(e),children:["Part ",e]},e))})]}),!R.transcriptText&&a.jsx("p",{className:"text-sm text-amber-700 bg-amber-50 p-2 rounded border border-amber-200",children:"Add a transcript above to generate AI explanations."}),a.jsx(r,{className:"bg-white border border-[#e0d6c7] shadow-sm",children:a.jsxs(l,{className:"space-y-0 p-0",children:[a.jsxs("div",{className:"bg-[#ffd500] text-black px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[a.jsxs("div",{className:"text-base font-bold",children:["Part - ",Y," ¬†¬† Questions ",10*(Y-1)+1," - ",10*Y]}),a.jsx("div",{className:"text-sm font-semibold",children:"Complete the notes below. Write NO MORE THAN TWO WORDS OR A NUMBER for each answer."})]}),a.jsxs("div",{className:"p-4 sm:p-6 space-y-2",children:[0===(Z[Y]||[]).length&&a.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet for this part."}),(Z[Y]||[]).length>0&&a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-6",children:[a.jsx("div",{className:"space-y-3",children:(Z[Y]||[]).slice(0,Math.ceil((Z[Y]||[]).length/2)).map(e=>a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("p",{className:"text-base text-[#1f1f1f] font-medium leading-tight",children:e.question_text||`Question ${e.displayNumber}`}),a.jsx("div",{className:"flex-1 h-[1px] border-b-2 border-dotted border-red-500"}),a.jsxs("span",{className:"text-red-600 font-bold",children:["( ",e.displayNumber," )"]})]},e.displayNumber))}),a.jsx("div",{className:"space-y-3",children:(Z[Y]||[]).slice(Math.ceil((Z[Y]||[]).length/2)).map(e=>a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("p",{className:"text-base text-[#1f1f1f] font-medium leading-tight",children:e.question_text||`Question ${e.displayNumber}`}),a.jsx("div",{className:"flex-1 h-[1px] border-b-2 border-dotted border-red-500"}),a.jsxs("span",{className:"text-red-600 font-bold",children:["( ",e.displayNumber," )"]})]},e.displayNumber))})]})]})]})}),a.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:[1,2,3,4].map(e=>{const s=Z[e]||[],t=10*(e-1)+1,o=10*e;return a.jsxs(r,{className:"bg-white/90 border border-[#e0d6c7] shadow-sm",children:[a.jsx(i,{className:"pb-2",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(n,{className:"text-base font-semibold text-[#2f241f]",children:["Part ",e," ‚Ä¢ Q",t,"‚Äì",o]}),a.jsxs(p,{variant:"outline",className:"bg-amber-50 border-amber-200 text-amber-900",children:[s.length," questions"]})]})}),a.jsxs(l,{className:"space-y-3 max-h-[320px] overflow-y-auto pr-1",children:[s.map((e,s)=>a.jsxs("div",{className:"rounded-lg border border-[#e0d6c7] bg-[#fdfaf3] p-3 space-y-2",children:[a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsxs(p,{variant:"outline",className:"bg-white/80 border-amber-200 text-amber-900",children:["Q",e.displayNumber]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("p",{className:"text-sm font-medium text-[#2f241f]",children:e.question_text}),a.jsxs("p",{className:"text-xs text-muted-foreground",children:["Answer: ",a.jsx("span",{className:"font-semibold text-green-700",children:e.correct_answer})]})]})]}),a.jsxs("div",{className:"bg-white border border-[#e0d6c7] rounded-lg p-2 text-sm",children:[a.jsxs("div",{className:"flex items-center gap-1 mb-1 text-amber-800 font-semibold text-xs uppercase tracking-wider",children:[a.jsx(w,{className:"w-3 h-3"}),"Explanation"]}),G[e.displayNumber-1]||e.explanation?a.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:G[e.displayNumber-1]||e.explanation}):a.jsx("p",{className:"text-muted-foreground/60 italic",children:"No explanation yet."})]})]},e.displayNumber)),0===s.length&&a.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions assigned to this part yet."})]})]},e)})}),a.jsx("div",{className:"flex items-center justify-end gap-3",children:a.jsxs(o,{variant:"outline",onClick:te,disabled:z||!R.transcriptText,className:"gap-2 border-amber-200 text-amber-900 hover:bg-amber-50",children:[z?a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-500"}):a.jsx(w,{className:"w-4 h-4 text-amber-600"}),"Generate Explanations with Gemini 3.0 Pro"]})})]}),a.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200",children:[a.jsx("h4",{className:"text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"üí° How this works:"}),a.jsxs("ul",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[a.jsx("li",{children:"Upload ONE audio file containing all 4 parts (Parts 1-4)"}),a.jsx("li",{children:"Use AI to extract questions from your test images"}),a.jsx("li",{children:"Questions 1-10 = Part 1, 11-20 = Part 2, 21-30 = Part 3, 31-40 = Part 4"}),a.jsx("li",{children:"Audio will be uploaded to Cloudflare R2 for fast global delivery"})]})]}),a.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[R.csvFile&&R.transcriptText&&a.jsx(o,{variant:"outline",onClick:te,disabled:z||!R.csvFile,className:"border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/20",size:"lg",children:z?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Generating AI Explanations..."]}):a.jsxs(a.Fragment,{children:[a.jsx(w,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})}),a.jsx(o,{onClick:()=>(async()=>{const s=R.audioFile;if(s||R.existingAudioUrl||0!==W.length){$(!0);try{let a=R.existingAudioUrl;if(console.log("üíæ Starting save with existingAudioUrl:",a),s){console.log("üì§ Uploading audio to Cloudflare R2...");const e=await L(s);a=e.url,console.log("‚úÖ Audio uploaded successfully:",a)}else console.log("‚ÑπÔ∏è No new audio file to upload, using existing URL:",a);let r=null;if(R.transcriptText.trim()&&a){D(!0);try{console.log("üéôÔ∏è Generating timestamps for transcript...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:i}=await s.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:R.transcriptText}});if(i)throw i;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");r=t.timestamps,console.log("‚úÖ Timestamps generated successfully"),d.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),d.error("Failed to generate timestamps, but saving test anyway.")}finally{D(!1)}}let i=null;R.answerImageFile&&(console.log("üì§ Uploading answer image..."),i=(await L(R.answerImageFile)).url,console.log("‚úÖ Answer image uploaded:",i));const n=W.length>0?W:[];if(0===n.length&&R.csvFile){const e=await R.csvFile.text();try{const s=JSON.parse(e);n.push(...s)}catch{const s=e.split("\n").filter(e=>e.trim()),t=s[0].split(",").map(e=>e.trim().replace(/"/g,"")),a=s.slice(1).map(e=>{const s=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return t.forEach((e,t)=>{a[e]=s[t]||""}),a}).filter(e=>e.question_text&&e.correct_answer);n.push(...a)}}const{supabase:l}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),o={testId:A,testData:{title:R.title||`IELTS Listening Test ${A}`,instructions:R.instructions,audioUrl:a,transcriptText:R.transcriptText,transcriptJson:r,answerImageUrl:i},questions:n.map((e,s)=>{const t=e.question_number_in_part||s+1,a=e.part_number||X(t),r=e.question_number_in_part||(t-1)%10+1,i=1===r;return{...e,part_number:a,question_number_in_part:r,explanation:G[s]||e.explanation||"",passage_text:i?R.instructions:e.passage_text||null}})};console.log("üíæ Saving test via Edge Function with audioUrl:",a),console.log("üì¶ Data being sent to Edge Function:",JSON.stringify(o,null,2));const{data:c,error:u}=await l.functions.invoke("save-listening-test",{body:o});if(console.log("Edge Function response:",{data:c,error:u}),u)throw console.error("Edge Function error:",u),new Error(`Edge Function failed: ${u.message||JSON.stringify(u)}`);if(!c||!c.success){const e=(null==c?void 0:c.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("‚úÖ Test saved successfully!"),d.success("Test saved successfully!"),console.log("üìù About to update state with:",{saved:!0,existingAudioUrl:a,audioFile:null}),O(e=>{const s={...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null};return console.log("üìù Updated state after save:",{existingAudioUrl:s.existingAudioUrl,saved:s.saved}),s}),$(!1)}catch(a){console.error("Error saving test:",a),d.error(`Failed to save test: ${a.message}`),$(!1)}}else d.error("Please upload either an audio file or add questions first")})(),disabled:P||!R.audioFile&&!R.existingAudioUrl&&0===W.length,className:"bg-primary hover:bg-primary/90 px-8",size:"lg",children:P?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Test..."]}):a.jsxs(a.Fragment,{children:[a.jsx(y,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})]})]})]})]})}):null};export{_ as default};
