import{_ as e}from"./supabase-DWL4C3fA.js";import{c as s,r as t,j as a,C as i,b as r,d as n,a as l,B as o,J as d,u as c,G as u,w as m,g as p,l as x,L as g,bd as h,I as b,H as f,U as w,T as j,N as v}from"./index-DdedLmvr.js";import{A as N}from"./AdminLayout-BIB6DPA-.js";import{I as y}from"./ImageQuestionExtractor-CMEXh1IK.js";import{T as k}from"./trash-2-BMwIHhRg.js";import"./image-DrR9QGIj.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=s("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]);function T({audioFile:e,onTrimComplete:s}){const[c,u]=t.useState(0),[m,p]=t.useState([0,0]),[x,g]=t.useState(!1),h=t.useRef(null),b=t.useRef(null),f=t.useState(()=>URL.createObjectURL(e))[0];t.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),t.useEffect(()=>{const e=h.current;if(!e)return;const s=()=>{const s=e.duration;u(s),p([0,s])};return e.addEventListener("loadedmetadata",s),()=>e.removeEventListener("loadedmetadata",s)},[e]);const w=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return a.jsxs(i,{className:"border-2 border-purple-200 dark:border-purple-800",children:[a.jsx(r,{children:a.jsxs(n,{className:"flex items-center gap-2",children:[a.jsx(F,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsx("audio",{ref:h,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const s=e.currentTarget.currentTime;s<m[0]?e.currentTarget.currentTime=m[0]:s>m[1]&&(e.currentTarget.currentTime=m[0],e.currentTarget.pause())}}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[a.jsxs("span",{children:["Start: ",w(m[0])]}),a.jsxs("span",{children:["End: ",w(m[1])]})]}),a.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[a.jsx("input",{type:"range",min:0,max:c,step:.1,value:m[0],onChange:e=>{const s=parseFloat(e.target.value);s<m[1]&&p([s,m[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("input",{type:"range",min:0,max:c,step:.1,value:m[1],onChange:e=>{const s=parseFloat(e.target.value);s>m[0]&&p([m[0],s])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:a.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:m[0]/c*100+"%",right:100-m[1]/c*100+"%",position:"absolute"}})})]}),a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["Duration: ",w(c)]}),a.jsxs("span",{children:["Trimmed Length: ",w(m[1]-m[0])]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx(o,{onClick:async()=>{const[t,a]=m;if(t>=a)d.error("Start time must be before end time");else{g(!0);try{const i=await e.arrayBuffer();b.current||(b.current=new(window.AudioContext||window.webkitAudioContext));const r=b.current,n=await r.decodeAudioData(i),l=Math.floor(t*n.sampleRate),o=Math.floor(a*n.sampleRate)-l,c=r.createBuffer(n.numberOfChannels,o,n.sampleRate);for(let e=0;e<n.numberOfChannels;e++){const s=n.getChannelData(e),t=c.getChannelData(e);for(let e=0;e<o;e++)t[e]=s[l+e]}const u=function(e){const s=e.length*e.numberOfChannels*2+44,t=new ArrayBuffer(s),a=new DataView(t),i=[];let r=0,n=0;const l=e=>{a.setUint16(n,e,!0),n+=2},o=e=>{a.setUint32(n,e,!0),n+=4};o(1179011410),o(s-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(s-n-4);for(let d=0;d<e.numberOfChannels;d++)i.push(e.getChannelData(d));for(;n<s;){for(let s=0;s<e.numberOfChannels;s++){let e=Math.max(-1,Math.min(1,i[s][r]));e=e<0?32768*e:32767*e,a.setInt16(n,e,!0),n+=2}r++}return t}(c),m=new Blob([u],{type:"audio/wav"}),p=new File([m],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});s(p,t,a),d.success(`Audio trimmed: ${t.toFixed(1)}s to ${a.toFixed(1)}s`)}catch(i){console.error("Trim error:",i),d.error(`Failed to trim audio: ${i.message}`)}finally{g(!1)}}},disabled:x,className:"flex-1",children:x?"Trimming...":"Apply Trim"})})]})]})}const A=()=>{const s=c(),{testType:A,testId:E}=u(),{admin:U,loading:_}=m(),I=A||"ielts",C=`/admin/${I}/listening`,{listContent:S,createContent:L,uploadAudio:q}=p(),[R,O]=t.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,saved:!1}),[$,P]=t.useState(!1),[D,M]=t.useState(!1),[G,z]=t.useState(!1);t.useState(!1);const[B,J]=t.useState({}),[Q,V]=t.useState(!1),[H,Y]=t.useState([]);t.useEffect(()=>{_||U||s("/admin/login")},[U,_,s]),t.useEffect(()=>{W()},[A,E]);const W=async()=>{const s=A||"IELTS";if(console.log("üîÑ loadExistingData called with testType:",s,"testId:",E),E)try{const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await s.from("tests").select("*").eq("id",E).maybeSingle();if(!t)return void console.log("‚ö†Ô∏è No existing test found for testId:",E);console.log("üìã Found existing test:",t.test_name),console.log("üìº Audio URL from tests table:",t.audio_url);const{data:a}=await s.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});console.log("üìä Found",(null==a?void 0:a.length)||0,"questions for this test");const i=t.audio_url||(a&&a.length>0?a[0].audio_url:null);if(console.log("üìº Final audio URL to use:",i),a&&a.length>0){const e=a[0],s=a.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:[],correct_answer:e.correct_answer,explanation:e.explanation}));Y(s);const r=JSON.stringify(s),n=new File([r],"existing-questions.json",{type:"application/json"});O({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:i||null,csvFile:n,transcriptText:e.transcription||"",answerImageFile:null,saved:!0}),i?d.success(`Existing audio loaded: ${i.split("/").pop()}`):console.warn("‚ö†Ô∏è No audio URL found in database for this test")}else console.log("‚ö†Ô∏è No questions found, loading audio from tests table"),O(e=>({...e,title:t.test_name,existingAudioUrl:i||null,saved:!0})),i?(console.log("‚úÖ Audio URL loaded from tests table:",i),d.success(`Existing audio loaded: ${i.split("/").pop()}`)):console.warn("‚ö†Ô∏è No audio URL found in tests table")}catch(t){console.error("Error loading existing data:",t),d.error("Failed to load existing data")}else console.log("‚ö†Ô∏è Skipping loadExistingData - missing testId")},K=(e,s)=>{O(t=>({...t,[e]:s,saved:!1}))},X=async()=>{if(0!==H.length)if(R.transcriptText){z(!0);try{console.log("ü§ñ Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await s.functions.invoke("generate-listening-explanations",{body:{questions:H,transcriptText:R.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const i=H.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});Y(i);const r=JSON.stringify(i),n=new File([r],"questions-with-explanations.json",{type:"application/json"});K("csvFile",n),d.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(s){console.error("Error generating explanations:",s),d.error(`Failed to generate explanations: ${s.message}`)}finally{z(!1)}}else d.error("Please provide a transcript first");else d.error("Please upload questions first")};return _?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):U?a.jsx(N,{title:`${I.toUpperCase()} Test ${E} - Listening Management`,showBackButton:!0,backPath:C,onBackClick:()=>s(C),children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:[I.toUpperCase()," Test ",E," - Listening Management"]}),a.jsx("p",{className:"text-muted-foreground mt-1",children:"Create a complete listening test with one audio file and questions for all 4 parts (40 questions total)"})]}),a.jsxs(x,{variant:"secondary",className:"text-sm",children:["Test ",E]})]}),a.jsxs(i,{className:"border border-border bg-card shadow-sm",children:[a.jsx(r,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(n,{className:"flex items-center gap-2",children:[R.saved?a.jsx(g,{className:"w-5 h-5 text-green-500"}):a.jsx(h,{className:"w-5 h-5 text-muted-foreground"}),"Listening Test - All Parts (1-4)"]}),a.jsx(x,{variant:R.saved?"default":"outline",children:R.saved?"Saved":"Not Saved"})]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Test Name *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:'Give this test a descriptive name (e.g., "IELTS Listening Test 1 - Cambridge 18")'}),a.jsx(b,{placeholder:`IELTS Listening Test ${E}`,value:R.title,onChange:e=>K("title",e.target.value),className:"max-w-md"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Audio File (All 4 Parts) *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload one continuous audio file containing all 4 parts of the listening test (approximately 30 minutes)"}),a.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 bg-muted/5 rounded-lg p-6 hover:bg-muted/10 transition-colors",children:[a.jsx("div",{className:"flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(f,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),a.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload MP3 or WAV audio file (recommended: 30-40 minutes)"}),a.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{O(s=>({...s,audioFile:e})),O(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),V(!0),d.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),a.jsxs(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},children:[a.jsx(w,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),R.audioFile&&a.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["‚úì Audio file ready: ",R.audioFile.name]}),a.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(R.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>V(!0),className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-green-200 text-green-800 dark:text-green-200",children:[a.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim Audio"]})]}),a.jsx("audio",{controls:!0,src:URL.createObjectURL(R.audioFile),className:"w-full mt-3 h-8"})]}),!R.audioFile&&R.existingAudioUrl&&a.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:"‚úì Audio file already uploaded"}),a.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1 break-all",children:R.existingAudioUrl.split("/").pop()}),a.jsxs("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:[a.jsx("source",{src:R.existingAudioUrl,type:"audio/mpeg"}),"Your browser does not support the audio element."]})]}),a.jsxs("div",{className:"flex space-x-2 ml-4",children:[a.jsxs(o,{variant:"outline",size:"sm",onClick:async()=>{if(R.existingAudioUrl)try{const e=d.loading("Loading audio for editing..."),s=await fetch(R.existingAudioUrl),t=await s.blob(),a=R.existingAudioUrl.split("/").pop()||"existing-audio.mp3",i=new File([t],a,{type:t.type});O(e=>({...e,audioFile:i})),V(!0),d.dismiss(e),d.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),d.dismiss(),d.error("Failed to load audio for editing")}},className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-blue-200 text-blue-800 dark:text-blue-200",children:[a.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim / Modify"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(O(e=>({...e,existingAudioUrl:null,audioFile:null})),d.success("Audio deleted"))},className:"bg-white/50 hover:bg-red-50 dark:bg-black/20 dark:hover:bg-red-900/20 border-red-200 text-red-600 dark:text-red-400",children:[a.jsx(k,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),Q&&R.audioFile&&a.jsx(T,{audioFile:R.audioFile,onTrimComplete:(e,s,t)=>{K("audioFile",e),K("audioTrimStart",s),K("audioTrimEnd",t),V(!1),d.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("label",{className:"text-sm font-medium",children:["Transcript Text ",a.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional)"})]}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Paste the full transcript text here. AI will automatically sync it with the audio for the student viewer."}),a.jsx(j,{placeholder:"Paste the full transcript text here...",value:R.transcriptText,onChange:e=>K("transcriptText",e.target.value),rows:6,className:"font-mono text-sm"}),R.transcriptText&&a.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200",children:a.jsxs("p",{className:"text-xs text-purple-800 dark:text-purple-200 flex items-center gap-2",children:[a.jsx(v,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save!"]})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Answer Image & Questions (All 40 Questions) *"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload an image of the questions/answer sheet. The image will be stored as the Answer Image, and you can extract questions from it using AI."}),a.jsx(y,{testId:E||"",testType:I,initialImageFile:R.answerImageFile,onImageSelected:e=>K("answerImageFile",e),onQuestionsExtracted:e=>{console.log("‚ú® AI extracted questions:",e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});Y(e),K("csvFile",t),d.success(`Ready to save ${e.length} AI-extracted questions!`)}})]}),H.length>0&&a.jsxs("div",{className:"space-y-4 border-t pt-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"Review Questions & Explanations"}),a.jsxs(o,{variant:"outline",onClick:X,disabled:G||!R.transcriptText,className:"gap-2",children:[G?a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}):a.jsx(v,{className:"w-4 h-4 text-purple-500"}),"Generate Explanations with Gemini 3.0 Pro"]})]}),!R.transcriptText&&a.jsx("p",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded",children:"‚ö†Ô∏è You need to add a transcript above to generate AI explanations."}),a.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto pr-2",children:H.map((e,s)=>a.jsx(i,{className:"bg-card border border-border shadow-sm hover:border-primary/50 transition-colors",children:a.jsxs(l,{className:"p-4 space-y-2",children:[a.jsx("div",{className:"flex justify-between items-start gap-4",children:a.jsxs("div",{className:"space-y-1 flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(x,{variant:"outline",children:["Q",s+1]}),a.jsx("span",{className:"font-medium",children:e.question_text})]}),a.jsxs("div",{className:"text-sm text-muted-foreground pl-10",children:["Answer: ",a.jsx("span",{className:"font-semibold text-green-600",children:e.correct_answer})]})]})}),a.jsx("div",{className:"pl-10 mt-2",children:a.jsxs("div",{className:"bg-white dark:bg-slate-800 p-3 rounded-md border border-border text-sm",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1 text-purple-600 dark:text-purple-400 font-medium text-xs uppercase tracking-wider",children:[a.jsx(v,{className:"w-3 h-3"}),"AI Explanation"]}),B[s]||e.explanation?a.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:B[s]||e.explanation}):a.jsx("p",{className:"text-muted-foreground/50 italic",children:'No explanation generated yet. Click "Generate AI Explanations" above.'})]})})]})},s))})]}),a.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200",children:[a.jsx("h4",{className:"text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"üí° How this works:"}),a.jsxs("ul",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[a.jsx("li",{children:"Upload ONE audio file containing all 4 parts (Parts 1-4)"}),a.jsx("li",{children:"Use AI to extract questions from your test images"}),a.jsx("li",{children:"Questions 1-10 = Part 1, 11-20 = Part 2, 21-30 = Part 3, 31-40 = Part 4"}),a.jsx("li",{children:"Audio will be uploaded to Cloudflare R2 for fast global delivery"})]})]}),a.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[R.csvFile&&R.transcriptText&&a.jsx(o,{variant:"outline",onClick:X,disabled:G||!R.csvFile,className:"border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/20",size:"lg",children:G?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Generating AI Explanations..."]}):a.jsxs(a.Fragment,{children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})}),a.jsx(o,{onClick:()=>(async()=>{const s=R.audioFile;if(s||R.existingAudioUrl||0!==H.length){P(!0);try{let a=R.existingAudioUrl;if(console.log("üíæ Starting save with existingAudioUrl:",a),s){console.log("üì§ Uploading audio to Cloudflare R2...");const e=await q(s);a=e.url,console.log("‚úÖ Audio uploaded successfully:",a)}else console.log("‚ÑπÔ∏è No new audio file to upload, using existing URL:",a);let i=null;if(R.transcriptText.trim()&&a){M(!0);try{console.log("üéôÔ∏è Generating timestamps for transcript...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:r}=await s.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:R.transcriptText}});if(r)throw r;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");i=t.timestamps,console.log("‚úÖ Timestamps generated successfully"),d.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),d.error("Failed to generate timestamps, but saving test anyway.")}finally{M(!1)}}let r=null;R.answerImageFile&&(console.log("üì§ Uploading answer image..."),r=(await q(R.answerImageFile)).url,console.log("‚úÖ Answer image uploaded:",r));const n=H.length>0?H:[];if(0===n.length&&R.csvFile){const e=await R.csvFile.text();try{const s=JSON.parse(e);n.push(...s)}catch{const s=e.split("\n").filter(e=>e.trim()),t=s[0].split(",").map(e=>e.trim().replace(/"/g,"")),a=s.slice(1).map(e=>{const s=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return t.forEach((e,t)=>{a[e]=s[t]||""}),a}).filter(e=>e.question_text&&e.correct_answer);n.push(...a)}}const{supabase:l}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),o={testId:E,testData:{title:R.title||`IELTS Listening Test ${E}`,instructions:R.instructions,audioUrl:a,transcriptText:R.transcriptText,transcriptJson:i,answerImageUrl:r},questions:n.map((e,s)=>({...e,explanation:B[s]||e.explanation||""}))};console.log("üíæ Saving test via Edge Function with audioUrl:",a),console.log("üì¶ Data being sent to Edge Function:",JSON.stringify(o,null,2));const{data:c,error:u}=await l.functions.invoke("save-listening-test",{body:o});if(console.log("Edge Function response:",{data:c,error:u}),u)throw console.error("Edge Function error:",u),new Error(`Edge Function failed: ${u.message||JSON.stringify(u)}`);if(!c||!c.success){const e=(null==c?void 0:c.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("‚úÖ Test saved successfully!"),d.success("Test saved successfully!"),console.log("üìù About to update state with:",{saved:!0,existingAudioUrl:a,audioFile:null}),O(e=>{const s={...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null};return console.log("üìù Updated state after save:",{existingAudioUrl:s.existingAudioUrl,saved:s.saved}),s}),P(!1)}catch(a){console.error("Error saving test:",a),d.error(`Failed to save test: ${a.message}`),P(!1)}}else d.error("Please upload either an audio file or add questions first")})(),disabled:$||!R.audioFile&&!R.existingAudioUrl&&0===H.length,className:"bg-primary hover:bg-primary/90 px-8",size:"lg",children:$?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Test..."]}):a.jsxs(a.Fragment,{children:[a.jsx(w,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})]})]})]})]})}):null};export{A as default};
