import{s as e,_ as s}from"./supabase-Bqkrifq5.js";import{y as t,r as a,j as r,C as n,b as i,c as l,b6 as o,a as d,B as c,w as m,I as u,S as x,o as p,p as g,q as h,s as j,E as b,k as f,T as v,X as N,J as w,b7 as y,ac as k,u as F,ak as T,v as E,f as A,b8 as C,b3 as _,H as I}from"./index-B_bFcAM1.js";import{A as S}from"./AdminLayout-DHWLi_lm.js";import{I as q}from"./image-Cu0-epkN.js";import{U as P}from"./upload-DZEDzBTJ.js";import{S as U}from"./slider-Bg_0t26r.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=t("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),D=t("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]),$=({testId:s,testType:t,onQuestionsExtracted:y})=>{const[k,F]=a.useState(null),[T,E]=a.useState(""),[A,C]=a.useState("1-13"),[_,I]=a.useState("Multiple Choice"),[S,U]=a.useState(!1),[D,$]=a.useState([]),[z,G]=a.useState(null),[R,M]=a.useState(null),[O,Q]=a.useState(!1),B=e=>{if(!e.type.startsWith("image/"))return void w.error("Please upload an image file (JPG, PNG, WebP)");if(e.size>10485760)return void w.error("Image size should be less than 10MB");F(e);const s=new FileReader;s.onloadend=()=>{E(s.result)},s.readAsDataURL(e),w.success("Image uploaded successfully!")},J=()=>{G(null),M(null)},V=()=>{if(null!==z&&R){const e=[...D];e[z]=R,$(e),G(null),M(null),w.success("Question updated")}};return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(n,{className:"border-2 border-purple-200 dark:border-purple-800",children:[r.jsxs(i,{className:"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950 dark:to-blue-950",children:[r.jsxs(l,{className:"flex items-center gap-2",children:[r.jsx(o,{className:"w-5 h-5 text-purple-600"}),"AI Question Extraction (Gemini Vision)"]}),r.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Upload an image of IELTS questions and let Gemini AI extract them automatically"})]}),r.jsxs(d,{className:"pt-6 space-y-6",children:[r.jsx("div",{className:"border-2 border-dashed rounded-lg p-8 transition-all duration-200 "+(O?"border-purple-500 bg-purple-50 dark:bg-purple-900/20 scale-[1.02]":"border-border hover:border-purple-400"),onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),Q(!0)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget===e.target&&Q(!1)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),Q(!1);const s=e.dataTransfer.files;if(s&&s.length>0){const e=s[0];B(e)}},children:T?r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"relative max-h-96 overflow-hidden rounded-lg border",children:r.jsx("img",{src:T,alt:"Questions Preview",className:"w-full object-contain"})}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[r.jsx(m,{className:"w-4 h-4 text-green-500"}),null==k?void 0:k.name," (",(k.size/1024).toFixed(0)," KB)"]}),r.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{F(null),E(""),$([])},children:"Change Image"})]})]}):r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"transition-transform duration-200 "+(O?"scale-110":""),children:r.jsx(q,{className:"w-16 h-16 mx-auto mb-4 "+(O?"text-purple-600":"text-purple-400")})}),r.jsx("h4",{className:"font-medium mb-2",children:O?"ðŸ“Ž Drop image here!":"Upload Question Image"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:O?"Release to upload":"Drag & drop or click to browse â€¢ JPG, PNG, WebP (max 10MB)"}),!O&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&B(t)},className:"hidden",id:"question-image-upload"}),r.jsxs(c,{onClick:()=>{var e;return null==(e=document.getElementById("question-image-upload"))?void 0:e.click()},variant:"outline",className:"border-purple-300 hover:bg-purple-50",children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"Choose Image"]}),r.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"ðŸ’¡ Tip: Clear, high-resolution images work best"})]})]})}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Question Range ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),r.jsx(u,{placeholder:"Leave empty for AI auto-detect or enter like: 1-13",value:A,onChange:e=>C(e.target.value),className:"font-mono"}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI can automatically detect the question range from your image"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Question Type ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),r.jsxs(x,{value:_,onValueChange:I,children:[r.jsx(p,{children:r.jsx(g,{placeholder:"AI will auto-detect type"})}),r.jsxs(h,{children:[r.jsx(j,{value:"auto",children:"ðŸ¤– Auto-Detect (Recommended)"}),r.jsx(j,{value:"Multiple Choice",children:"Multiple Choice"}),r.jsx(j,{value:"Fill in the blank",children:"Fill in the Blank"}),r.jsx(j,{value:"True/False/Not Given",children:"True/False/Not Given"}),r.jsx(j,{value:"Matching",children:"Matching"}),r.jsx(j,{value:"Sentence Completion",children:"Sentence Completion"}),r.jsx(j,{value:"Short Answer",children:"Short Answer"}),r.jsx(j,{value:"Summary Completion",children:"Summary Completion"})]})]}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI analyzes the image to identify question types"})]})]}),r.jsx(c,{onClick:async()=>{if(k){if(A&&A.trim()){if(!/^\d+-\d+$/.test(A.trim()))return void w.error('Invalid range format. Use format: "1-13" or leave empty for auto-detect')}U(!0);try{const a=T.split(",")[1],r=A&&A.trim()?A.trim():"",n=_&&"auto"!==_?_:"";console.log("ðŸ“¤ Sending to Gemini:",{questionRange:r||"AUTO-DETECT",questionType:n||"AUTO-DETECT",imageSize:a.length});const{data:i,error:l}=await e.functions.invoke("gemini-question-extractor",{body:{imageBase64:a,questionRange:r,questionType:n,testType:t,testId:s}});if(l)throw console.error("âŒ Extraction error:",l),l;if(!i.success)throw new Error(i.error||"Extraction failed");console.log("âœ… Extracted questions:",i),$(i.questions);const o=i.autoDetected?`\nDetected: ${i.range} (${i.questionType})`:`Range: ${i.range}`;w.success(`âœ¨ Successfully extracted ${i.count} questions!`,{description:o})}catch(a){console.error("âŒ Extraction failed:",a),w.error("Failed to extract questions",{description:a.message||"Please try again or check the image quality"})}finally{U(!1)}}else w.error("Please upload an image")},disabled:!k||S,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700",size:"lg",children:S?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Gemini AI is analyzing the image..."]}):r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"w-5 h-5 mr-2"}),"Extract Questions with AI"]})})]})]}),D.length>0&&r.jsxs(n,{children:[r.jsx(i,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs(l,{className:"flex items-center gap-2",children:[r.jsx(b,{className:"w-5 h-5"}),"Extracted Questions (",D.length,")"]}),r.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and edit if needed, then save to database"})]}),r.jsx(f,{variant:"secondary",className:"text-sm",children:A})]})}),r.jsxs(d,{children:[r.jsx("div",{className:"max-h-[600px] overflow-y-auto space-y-4",children:D.map((e,s)=>r.jsx("div",{className:"border rounded-lg overflow-hidden",children:z===s?r.jsxs("div",{className:"p-4 space-y-3 bg-muted/30",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"text-xs font-medium",children:["Question ",e.question_number]}),r.jsx(v,{value:(null==R?void 0:R.question_text)||"",onChange:e=>M(s=>s?{...s,question_text:e.target.value}:null),rows:3,className:"mt-1"})]}),(null==R?void 0:R.options)&&r.jsxs("div",{children:[r.jsx("label",{className:"text-xs font-medium",children:"Options (one per line)"}),r.jsx(v,{value:R.options.join("\n"),onChange:e=>M(s=>s?{...s,options:e.target.value.split("\n")}:null),rows:4,className:"mt-1"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-xs font-medium",children:"Correct Answer"}),r.jsx(u,{value:(null==R?void 0:R.correct_answer)||"",onChange:e=>M(s=>s?{...s,correct_answer:e.target.value}:null),className:"mt-1"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs(c,{size:"sm",onClick:V,children:[r.jsx(m,{className:"w-4 h-4 mr-1"}),"Save"]}),r.jsxs(c,{size:"sm",variant:"outline",onClick:J,children:[r.jsx(N,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]}):r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 border-b",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(f,{variant:"outline",className:"font-mono",children:["Q",e.question_number]}),r.jsx(f,{variant:"secondary",className:"Multiple Choice"===e.question_type?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"Fill in the blank"===e.question_type?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"True/False/Not Given"===e.question_type?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:e.question_type})]}),r.jsxs("div",{className:"flex gap-1",children:[r.jsx(c,{size:"sm",variant:"ghost",onClick:()=>(e=>{G(e),M({...D[e]})})(s),children:r.jsx(L,{className:"w-3 h-3"})}),r.jsx(c,{size:"sm",variant:"ghost",onClick:()=>(e=>{const s=D.filter((s,t)=>t!==e);$(s),w.success("Question removed")})(s),className:"text-red-500 hover:text-red-700",children:r.jsx(N,{className:"w-3 h-3"})})]})]}),r.jsxs("div",{className:"p-4 bg-white dark:bg-gray-900",children:[r.jsxs("div",{className:"mb-3",children:[r.jsxs("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1",children:["Question ",e.question_number]}),r.jsx("p",{className:"text-base leading-relaxed",children:e.question_text})]}),e.options&&e.options.length>0&&r.jsx("div",{className:"space-y-2 pl-2",children:e.options.map((t,a)=>r.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors "+(t===e.correct_answer?"bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[r.jsx("input",{type:"radio",name:`question-${s}`,checked:t===e.correct_answer,readOnly:!0,className:"w-4 h-4"}),r.jsx("span",{className:t===e.correct_answer?"font-medium text-green-700 dark:text-green-300":"",children:t}),t===e.correct_answer&&r.jsx(f,{variant:"default",className:"ml-auto text-xs",children:"âœ“ Correct"})]},a))}),!e.options&&e.correct_answer&&r.jsx("div",{className:"space-y-2",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("label",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Answer:"}),r.jsx(u,{value:e.correct_answer,readOnly:!0,className:"max-w-xs bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700 font-medium"}),r.jsx(f,{variant:"default",className:"text-xs",children:"âœ“ Correct Answer"})]})}),e.explanation&&r.jsxs("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[r.jsx("p",{className:"text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1",children:"Explanation:"}),r.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-400",children:e.explanation})]})]})]})},s))}),r.jsxs("div",{className:"mt-6 flex gap-3",children:[r.jsxs(c,{onClick:()=>y(D),className:"flex-1 bg-green-600 hover:bg-green-700",size:"lg",children:[r.jsx(m,{className:"w-5 h-5 mr-2"}),"Save ",D.length," Questions to Database"]}),r.jsx(c,{variant:"outline",onClick:()=>$([]),children:"Clear All"})]})]})]})]})},z=({audioFile:e,onTrimComplete:s,onClose:t})=>{const n=a.useRef(null),[i,l]=a.useState(!1),[o,d]=a.useState(0),[m,u]=a.useState(0),[x,p]=a.useState([0,100]),[g,h]=a.useState(!0);a.useEffect(()=>{const e=n.current;if(!e)return;const s=()=>{d(e.duration),p([0,100]),h(!1)},t=()=>{u(e.currentTime)},a=()=>{l(!1)};return e.addEventListener("loadedmetadata",s),e.addEventListener("timeupdate",t),e.addEventListener("ended",a),()=>{e.removeEventListener("loadedmetadata",s),e.removeEventListener("timeupdate",t),e.removeEventListener("ended",a)}},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`,b=x[0]/100*o,f=x[1]/100*o;return r.jsxs("div",{className:"bg-card border rounded-lg p-6 space-y-4",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[r.jsx(D,{className:"h-5 w-5"}),"Audio Trimmer"]}),t&&r.jsx(c,{variant:"ghost",size:"icon",onClick:t,children:r.jsx(N,{className:"h-4 w-4"})})]}),r.jsx("audio",{ref:n,src:e,preload:"metadata"}),g?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx(c,{variant:"outline",size:"icon",onClick:()=>{const e=n.current;if(e){if(i)e.pause();else{const s=x[0]/100*o;e.currentTime=s,e.play()}l(!i)}},children:i?r.jsx(y,{className:"h-4 w-4"}):r.jsx(k,{className:"h-4 w-4"})}),r.jsxs("span",{className:"text-sm text-muted-foreground",children:[j(m)," / ",j(o)]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Select Trim Range"}),r.jsx(U,{value:x,onValueChange:e=>{p([e[0],e[1]])},max:100,step:.1,className:"w-full"}),r.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[r.jsxs("span",{children:["Start: ",j(b)]}),r.jsxs("span",{children:["End: ",j(f)]}),r.jsxs("span",{children:["Duration: ",j(f-b)]})]})]}),r.jsxs("div",{className:"flex gap-2 pt-2",children:[r.jsxs(c,{onClick:()=>{const t=x[0]/100*o,a=x[1]/100*o;s(e,t,a)},className:"flex-1",children:[r.jsx(D,{className:"h-4 w-4 mr-2"}),"Apply Trim"]}),t&&r.jsx(c,{variant:"outline",onClick:t,children:"Cancel"})]})]})]})},G=()=>{const e=F(),{testType:t,testId:m}=T(),{admin:u,loading:x}=E(),{listContent:p,createContent:g,uploadAudio:h}=A(),[j,b]=a.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,saved:!1}),[N,y]=a.useState(!1),[k,U]=a.useState(!1),[L,G]=a.useState(!1);a.useState(!1);const[R,M]=a.useState({}),[O,Q]=a.useState(!1),[B,J]=a.useState([]);a.useEffect(()=>{x||u||e("/admin/login")},[u,x,e]),a.useEffect(()=>{V()},[t,m]);const V=async()=>{if(t&&m)try{const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await e.from("tests").select("*").eq("test_type","IELTS").eq("module","Listening").ilike("test_name",`%Test ${m}%`).maybeSingle();if(!t)return;const{data:a}=await e.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});if(a&&a.length>0){const e=a[0],s=a.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:[],correct_answer:e.correct_answer,explanation:e.explanation}));J(s);const r=JSON.stringify(s),n=new File([r],"existing-questions.json",{type:"application/json"}),i=e.audio_url;console.log("ðŸ“¼ Audio URL from database:",i),b({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:i||null,csvFile:n,transcriptText:e.transcription||"",answerImageFile:null,saved:!0}),i&&w.success(`Existing audio loaded: ${i.split("/").pop()}`)}}catch(e){console.error("Error loading existing data:",e),w.error("Failed to load existing data")}},W=(e,s)=>{b(t=>({...t,[e]:s,saved:!1}))},Y=async()=>{if(0!==B.length)if(j.transcriptText){G(!0);try{console.log("ðŸ¤– Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await e.functions.invoke("generate-listening-explanations",{body:{questions:B,transcriptText:j.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const r=B.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});J(r);const n=JSON.stringify(r),i=new File([n],"questions-with-explanations.json",{type:"application/json"});W("csvFile",i),w.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(e){console.error("Error generating explanations:",e),w.error(`Failed to generate explanations: ${e.message}`)}finally{G(!1)}}else w.error("Please provide a transcript first");else w.error("Please upload questions first")};return x?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):u?r.jsx(S,{title:`${null==t?void 0:t.toUpperCase()} Test ${m} - Listening Management`,showBackButton:!0,backPath:`/admin/${t}/listening`,onBackClick:()=>e(`/admin/${t}/listening`),children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:[null==t?void 0:t.toUpperCase()," Test ",m," - Listening Management"]}),r.jsx("p",{className:"text-muted-foreground mt-1",children:"Create a complete listening test with one audio file and questions for all 4 parts (40 questions total)"})]}),r.jsxs(f,{variant:"secondary",className:"text-sm",children:["Test ",m]})]}),r.jsxs(n,{className:"border border-border bg-card shadow-sm",children:[r.jsx(i,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(l,{className:"flex items-center gap-2",children:[j.saved?r.jsx(C,{className:"w-5 h-5 text-green-500"}):r.jsx(_,{className:"w-5 h-5 text-muted-foreground"}),"Listening Test - All Parts (1-4)"]}),r.jsx(f,{variant:j.saved?"default":"outline",children:j.saved?"Saved":"Not Saved"})]})}),r.jsxs(d,{className:"space-y-6",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Audio File (All 4 Parts) *"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload one continuous audio file containing all 4 parts of the listening test (approximately 30 minutes)"}),r.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 bg-muted/5 rounded-lg p-6 hover:bg-muted/10 transition-colors",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(I,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload MP3 or WAV audio file (recommended: 30-40 minutes)"}),r.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{W("audioFile",e),Q(!0),w.success(`Audio file uploaded: ${e.name}. You can now trim if needed.`)})(t)},className:"hidden",id:"audio-upload"}),r.jsxs(c,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),j.audioFile&&r.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["âœ“ Audio file ready: ",j.audioFile.name]}),r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(j.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),r.jsxs(c,{variant:"outline",size:"sm",onClick:()=>Q(!0),className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-green-200 text-green-800 dark:text-green-200",children:[r.jsx(D,{className:"w-3 h-3 mr-2"}),"Trim Audio"]})]}),r.jsx("audio",{controls:!0,src:URL.createObjectURL(j.audioFile),className:"w-full mt-3 h-8"})]}),!j.audioFile&&j.existingAudioUrl&&r.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200",children:r.jsx("div",{className:"flex justify-between items-start",children:r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:"âœ“ Audio file already uploaded"}),r.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1 break-all",children:j.existingAudioUrl.split("/").pop()}),r.jsxs("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:[r.jsx("source",{src:j.existingAudioUrl,type:"audio/mpeg"}),"Your browser does not support the audio element."]})]})})})]})]}),O&&j.audioFile&&r.jsx(z,{audioFile:j.audioFile,onTrimComplete:(e,s,t)=>{W("audioFile",e),W("audioTrimStart",s),W("audioTrimEnd",t),Q(!1),w.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Transcript Text ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional)"})]}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Paste the full transcript text here. AI will automatically sync it with the audio for the student viewer."}),r.jsx(v,{placeholder:"Paste the full transcript text here...",value:j.transcriptText,onChange:e=>W("transcriptText",e.target.value),rows:6,className:"font-mono text-sm"}),j.transcriptText&&r.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200",children:r.jsxs("p",{className:"text-xs text-purple-800 dark:text-purple-200 flex items-center gap-2",children:[r.jsx(o,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save!"]})})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Answer Image (Optional)"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload an image that represents the correct answer (e.g., diagram, map). This will be stored with the listening section."}),r.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 bg-muted/5 rounded-lg p-6 hover:bg-muted/10 transition-colors",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload PNG/JPEG image (recommended max 2MB)"}),r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&W("answerImageFile",t)},className:"hidden",id:"answer-image-upload"}),r.jsxs(c,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("answer-image-upload"))?void 0:e.click()},children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"Choose Image"]})]})}),j.answerImageFile&&r.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[r.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["âœ“ Image ready: ",j.answerImageFile.name]}),r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(j.answerImageFile.size/1024/1024).toFixed(2)," MB"]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Questions (All 40 Questions) *"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Use AI to extract questions from images."}),r.jsx("div",{className:"border border-border rounded-lg p-4 bg-card shadow-sm",children:r.jsx($,{testId:m||"",testType:t||"ielts",onQuestionsExtracted:e=>{console.log("âœ¨ AI extracted questions:",e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});J(e),W("csvFile",t),w.success(`Ready to save ${e.length} AI-extracted questions!`)}})})]}),B.length>0&&r.jsxs("div",{className:"space-y-4 border-t pt-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h3",{className:"text-lg font-semibold",children:"Review Questions & Explanations"}),r.jsxs(c,{variant:"outline",onClick:Y,disabled:L||!j.transcriptText,className:"gap-2",children:[L?r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}):r.jsx(o,{className:"w-4 h-4 text-purple-500"}),"Generate Explanations with Gemini 3.0 Pro"]})]}),!j.transcriptText&&r.jsx("p",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded",children:"âš ï¸ You need to add a transcript above to generate AI explanations."}),r.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto pr-2",children:B.map((e,s)=>r.jsx(n,{className:"bg-card border border-border shadow-sm hover:border-primary/50 transition-colors",children:r.jsxs(d,{className:"p-4 space-y-2",children:[r.jsx("div",{className:"flex justify-between items-start gap-4",children:r.jsxs("div",{className:"space-y-1 flex-1",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(f,{variant:"outline",children:["Q",s+1]}),r.jsx("span",{className:"font-medium",children:e.question_text})]}),r.jsxs("div",{className:"text-sm text-muted-foreground pl-10",children:["Answer: ",r.jsx("span",{className:"font-semibold text-green-600",children:e.correct_answer})]})]})}),r.jsx("div",{className:"pl-10 mt-2",children:r.jsxs("div",{className:"bg-white dark:bg-slate-800 p-3 rounded-md border border-border text-sm",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1 text-purple-600 dark:text-purple-400 font-medium text-xs uppercase tracking-wider",children:[r.jsx(o,{className:"w-3 h-3"}),"AI Explanation"]}),R[s]||e.explanation?r.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:R[s]||e.explanation}):r.jsx("p",{className:"text-muted-foreground/50 italic",children:'No explanation generated yet. Click "Generate AI Explanations" above.'})]})})]})},s))})]}),r.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"ðŸ’¡ How this works:"}),r.jsxs("ul",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[r.jsx("li",{children:"Upload ONE audio file containing all 4 parts (Parts 1-4)"}),r.jsx("li",{children:"Use AI to extract questions from your test images"}),r.jsx("li",{children:"Questions 1-10 = Part 1, 11-20 = Part 2, 21-30 = Part 3, 31-40 = Part 4"}),r.jsx("li",{children:"Audio will be uploaded to Cloudflare R2 for fast global delivery"})]})]}),r.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[j.csvFile&&j.transcriptText&&r.jsx(c,{variant:"outline",onClick:Y,disabled:L||!j.csvFile,className:"border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/20",size:"lg",children:L?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Generating AI Explanations..."]}):r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})}),r.jsx(c,{onClick:()=>(async()=>{const e=j.audioFile;if(e||j.existingAudioUrl||0!==B.length){y(!0);try{let a=j.existingAudioUrl;e&&(console.log("ðŸ“¤ Uploading audio to Cloudflare R2..."),a=(await h(e)).url,console.log("âœ… Audio uploaded successfully:",a));let r=null;if(j.transcriptText.trim()&&a){U(!0);try{console.log("ðŸŽ™ï¸ Generating timestamps for transcript...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:n}=await e.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:j.transcriptText}});if(n)throw n;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");r=t.timestamps,console.log("âœ… Timestamps generated successfully"),w.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),w.error("Failed to generate timestamps, but saving test anyway.")}finally{U(!1)}}let n=null;j.answerImageFile&&(console.log("ðŸ“¤ Uploading answer image..."),n=(await h(j.answerImageFile)).url,console.log("âœ… Answer image uploaded:",n));const i=B.length>0?B:[];if(0===i.length&&j.csvFile){const e=await j.csvFile.text();try{const s=JSON.parse(e);i.push(...s)}catch{const s=e.split("\n").filter(e=>e.trim()),t=s[0].split(",").map(e=>e.trim().replace(/"/g,"")),a=s.slice(1).map(e=>{const s=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return t.forEach((e,t)=>{a[e]=s[t]||""}),a}).filter(e=>e.question_text&&e.correct_answer);i.push(...a)}}const{supabase:l}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]);console.log("ðŸ’¾ Saving test via Edge Function...");const{data:o,error:d}=await l.functions.invoke("save-listening-test",{body:{testId:m,testData:{title:j.title||`IELTS Listening Test ${m}`,instructions:j.instructions,audioUrl:a,transcriptText:j.transcriptText,transcriptJson:r,answerImageUrl:n},questions:i.map((e,s)=>({...e,explanation:R[s]||e.explanation||""}))}});if(console.log("Edge Function response:",{data:o,error:d}),d)throw console.error("Edge Function error:",d),new Error(`Edge Function failed: ${d.message||JSON.stringify(d)}`);if(!o||!o.success){const e=(null==o?void 0:o.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("âœ… Test saved successfully!"),w.success("Test saved successfully!"),b(e=>({...e,saved:!0})),y(!1),V()}catch(a){console.error("Error saving test:",a),w.error(`Failed to save test: ${a.message}`),y(!1)}}else w.error("Please upload either an audio file or add questions first")})(),disabled:N||!j.audioFile&&!j.existingAudioUrl&&0===B.length,className:"bg-primary hover:bg-primary/90 px-8",size:"lg",children:N?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Test..."]}):r.jsxs(r.Fragment,{children:[r.jsx(P,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})]})]})]})]})}):null};
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */export{G as default};
