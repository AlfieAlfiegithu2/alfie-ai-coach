const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-KxDfHqNJ.js","assets/vendor-react-rLLBBC7n.js","assets/vendor-react-dom-CgqbTh6h.js","assets/vendor-charts-0DeywwxG.js","assets/vendor-ui-BGi_EvHx.js","assets/vendor-i18n-gE2_DBDv.js","assets/vendor-utils-Cn4gX4Gv.js","assets/vendor-supabase-DcWtwiPX.js","assets/vendor-animation-DlplP_f6.js","assets/vendor-date-DT7Rq6D9.js","assets/index-D-tbnM1e.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./vendor-i18n-gE2_DBDv.js";import{r as s,j as t,u as a,c as n}from"./vendor-react-rLLBBC7n.js";import{C as r,b as i,c as l,a as o,B as c,J as d,n as m,u,e as x,I as p,T as h,S as b,i as g,j as f,k as j,l as N,D as w,f as v,g as _,h as y,X as q}from"./index-KxDfHqNJ.js";import{A as C}from"./AdminLayout-DGXoIbe0.js";import{I as T}from"./ImageQuestionExtractor-CyDub9QF.js";import{b$ as F,at as k,au as I,W as E,av as S,aJ as A,aV as U,aY as $,aS as O,X as P,ak as M,aN as L,ap as R,bD as Q,b5 as D,c0 as B,c1 as z,a$ as W,c2 as J,b9 as V}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";function G({audioFile:e,onTrimComplete:a}){const[n,m]=s.useState(0),[u,x]=s.useState([0,0]),[p,h]=s.useState(!1),b=s.useRef(null),g=s.useRef(null),f=s.useState(()=>URL.createObjectURL(e))[0];s.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),s.useEffect(()=>{const e=b.current;if(!e)return;const s=()=>{const s=e.duration;m(s),x([0,s])};return e.addEventListener("loadedmetadata",s),()=>e.removeEventListener("loadedmetadata",s)},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return t.jsxs(r,{className:"border-2 border-purple-200 dark:border-purple-800",children:[t.jsx(i,{children:t.jsxs(l,{className:"flex items-center gap-2",children:[t.jsx(F,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),t.jsxs(o,{className:"space-y-6",children:[t.jsx("audio",{ref:b,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const s=e.currentTarget.currentTime;s<u[0]?e.currentTarget.currentTime=u[0]:s>u[1]&&(e.currentTarget.currentTime=u[0],e.currentTarget.pause())}}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[t.jsxs("span",{children:["Start: ",j(u[0])]}),t.jsxs("span",{children:["End: ",j(u[1])]})]}),t.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[t.jsx("input",{type:"range",min:0,max:n,step:.1,value:u[0],onChange:e=>{const s=parseFloat(e.target.value);s<u[1]&&x([s,u[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),t.jsx("input",{type:"range",min:0,max:n,step:.1,value:u[1],onChange:e=>{const s=parseFloat(e.target.value);s>u[0]&&x([u[0],s])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),t.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:t.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:u[0]/n*100+"%",right:100-u[1]/n*100+"%",position:"absolute"}})})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[t.jsxs("span",{children:["Duration: ",j(n)]}),t.jsxs("span",{children:["Trimmed Length: ",j(u[1]-u[0])]})]})]}),t.jsx("div",{className:"flex gap-2",children:t.jsx(c,{onClick:async()=>{const[s,t]=u;if(s>=t)d.error("Start time must be before end time");else{h(!0);try{const n=await e.arrayBuffer();g.current||(g.current=new(window.AudioContext||window.webkitAudioContext));const r=g.current,i=await r.decodeAudioData(n),l=Math.floor(s*i.sampleRate),o=Math.floor(t*i.sampleRate)-l,c=r.createBuffer(i.numberOfChannels,o,i.sampleRate);for(let e=0;e<i.numberOfChannels;e++){const s=i.getChannelData(e),t=c.getChannelData(e);for(let e=0;e<o;e++)t[e]=s[l+e]}const m=function(e){const s=e.length*e.numberOfChannels*2+44,t=new ArrayBuffer(s),a=new DataView(t),n=[];let r=0,i=0;const l=e=>{a.setUint16(i,e,!0),i+=2},o=e=>{a.setUint32(i,e,!0),i+=4};o(1179011410),o(s-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(s-i-4);for(let c=0;c<e.numberOfChannels;c++)n.push(e.getChannelData(c));for(;i<s;){for(let s=0;s<e.numberOfChannels;s++){let e=Math.max(-1,Math.min(1,n[s][r]));e=e<0?32768*e:32767*e,a.setInt16(i,e,!0),i+=2}r++}return t}(c),u=new Blob([m],{type:"audio/wav"}),x=new File([u],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});a(x,s,t),d.success(`Audio trimmed: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}catch(n){console.error("Trim error:",n),d.error(`Failed to trim audio: ${n.message}`)}finally{h(!1)}}},disabled:p,className:"flex-1",children:p?"Trimming...":"Apply Trim"})})]})]})}const H=/questions?\s+(\d+)(?:\s*[-â€“]\s*(\d+))?/i,X=/\(?(\d{1,3})\)?/g;function Y(e,s){const t=`${e} ${s}`.toLowerCase();return t.includes("table")||t.includes("form")?"table_completion":t.includes("map")||t.includes("diagram")?"map_labeling":t.includes("plan")?"plan_labeling":t.includes("flowchart")?"flowchart_completion":t.includes("matching")||t.includes("match")?"multiple_choice_matching":t.includes("choose the correct letter")||t.match(/\([abc]\)/)?"multiple_choice":t.includes("summary")||t.includes("note")?"note_completion":t.includes("sentence")?"sentence_completion":"fill_blank"}function K(e,s,t,a){const n=[],r=[...e.matchAll(X)];return 0===r.length||r.forEach(r=>{const i=r[1],l=Number(i);if(!Number.isFinite(l))return;if(a&&a.has(l))return;const o=Math.max(1,Math.floor((l-1)/10)+1),c=(l-1)%10+1,d=function(e,s,t){return`${e.slice(Math.max(0,s-50),s).trimStart()} _____ ${e.slice(t,Math.min(e.length,t+50)).trimEnd()}`.replace(/\s+/g," ").trim()}(e,r.index||0,(r.index||0)+r[0].length);n.push({question_number:l,question_text:d||e,question_type:Y(s,e),correct_answer:"",section_header:t,section_instruction:s||void 0,part_number:o,question_number_in_part:c}),a&&a.add(l)}),n}function Z(e){const s=(e||"").replace(/\r\n/g,"\n").split("\n").map(e=>e.replace(/\s+/g," ").trim()).filter(e=>e.length>0&&"click to edit"!==e.toLowerCase());const t=[],a=[];let n,r="";const i=new Set;return s.forEach(e=>{if(e.match(H))return n=e,void(r="");if(function(e){const s=e.toLowerCase();return s.includes("no more than")||s.includes("write your answers")||s.includes("answer the questions")||s.includes("complete")||s.includes("summary")||s.includes("choose")||s.includes("matching")}(e))return void(r=r?`${r} ${e}`:e);if(e.includes("_")||e.match(/\(\d{1,3}\)/)){const s=K(e,r,n,i);if(s.length>0)return void t.push(...s)}const s=function(e,s,t){const a=e.match(/^(\d{1,3})[).:-]?\s+(.*)$/);if(!a)return null;const n=Number(a[1]);if(!Number.isFinite(n))return null;const r=Math.max(1,Math.floor((n-1)/10)+1),i=(n-1)%10+1;return{question_number:n,question_text:a[2].trim(),question_type:Y(s,e),correct_answer:"",section_header:t,section_instruction:s||void 0,part_number:r,question_number_in_part:i}}(e,r,n);if(s)return i.has(s.question_number)?void a.push(`Duplicate question number ${s.question_number} skipped.`):(i.add(s.question_number),void t.push(s));/^\d{1,3}$/.test(e)}),0===t.length&&a.push("No questions detected. Check formatting or add numbering."),t.sort((e,s)=>e.question_number-s.question_number),{questions:t,warnings:a}}const ee={note_completion:{label:"Note Completion",icon:R,description:"Fill in blanks in notes"},table_completion:{label:"Table/Form Completion",icon:B,description:"Fill in table cells"},map_labeling:{label:"Map/Plan Labeling",icon:z,description:"Label locations on a map"},multiple_choice_matching:{label:"Multiple Choice Matching",icon:W,description:"Match letters A-H to items"},sentence_completion:{label:"Sentence Completion",icon:R,description:"Complete sentences"},flowchart_completion:{label:"Flowchart Completion",icon:J,description:"Fill in flowchart boxes"},plan_labeling:{label:"Plan/Diagram Labeling",icon:V,description:"Label a plan or diagram"},multiple_choice:{label:"Multiple Choice",icon:W,description:"Choose correct answer"},fill_blank:{label:"Fill in the Blank",icon:R,description:"Generic fill-in-blank"}},se={questionCount:5,questionType:"note_completion",instruction:"Write NO MORE THAN TWO WORDS OR A NUMBER for each answer."},te=()=>{var B,z,W,J,V,H;const X=a(),{testType:Y,testId:K}=n(),{admin:te,loading:ae}=m(),ne=Y||"ielts",re=`/admin/${ne}/listening`,{listContent:ie,createContent:le,uploadAudio:oe}=u(),[ce,de]=s.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,referenceImageUrl:null,saved:!1}),[me,ue]=s.useState(!1),[xe,pe]=s.useState(!1),[he,be]=s.useState(!1);s.useState(!1);const[ge,fe]=s.useState({}),[je,Ne]=s.useState(!1),[we,ve]=s.useState(!1),[_e,ye]=s.useState(""),[qe,Ce]=s.useState([]),[Te,Fe]=s.useState([]),[ke,Ie]=s.useState(1),[Ee,Se]=s.useState(8),[Ae,Ue]=s.useState(()=>{const e={};for(let s=1;s<=8;s++)e[s]={...se,questionCount:5};return e}),$e=Object.fromEntries(Object.entries(Ae).map(([e,s])=>[e,s.questionCount])),[Oe,Pe]=s.useState(null),[Me,Le]=s.useState(null),Re=()=>Array.from({length:Ee},(e,s)=>$e[s+1]||5),Qe=e=>{const s=Re();let t=0;for(let a=0;a<s.length;a++)if(t+=s[a],e<t)return a+1;return Ee},De=e=>{const s=Re();let t=0;for(let a=0;a<s.length;a++){const n=t+s[a];if(e<n)return e-t+1;t=n}return e-s.slice(0,s.length-1).reduce((e,s)=>e+s,0)+1},Be=e=>Re().slice(0,e-1).reduce((e,s)=>e+s,0)+1,ze=(e,s)=>{Ue(t=>({...t,[e]:{...t[e]||se,...s}}))},We=(()=>{let e=0,s=1;return Te.map((t,a)=>{if(!0===t.is_info_row||0===t.question_number){const e=t.part_number||s;return{...t,globalNumber:0,part:e,questionInPart:0,originalIndex:a,is_info_row:!0}}{const n=t.part_number||Qe(e);s=n;const r=t.question_number_in_part||De(e),i=t.question_number||Be(n)+r-1;return e++,{...t,globalNumber:i,part:n,questionInPart:r,originalIndex:a}}})})().reduce((e,s)=>(e[s.part]=e[s.part]?[...e[s.part],s]:[s],e),{});s.useEffect(()=>{ae||te||X("/admin/login")},[te,ae,X]),s.useEffect(()=>{Je()},[Y,K]);const Je=async()=>{const s=Y||"IELTS";if(console.log("ðŸ”„ loadExistingData called with testType:",s,"testId:",K),K)try{const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./index-KxDfHqNJ.js").then(e=>e.ab);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:t}=await s.from("tests").select("*").eq("id",K).maybeSingle();if(!t)return void console.log("âš ï¸ No existing test found for testId:",K);console.log("ðŸ“‹ Found existing test:",t.test_name);const{data:a}=await s.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});console.log("ðŸ“Š Found",(null==a?void 0:a.length)||0,"questions for this test");const n=t.audio_url||(a&&a.length>0?a[0].audio_url:null),r=t.reference_image_url||null;if(a&&a.length>0){const e=a[0],s=a.map((e,s)=>{const t=e.part_number||Qe(s),a=e.question_number_in_part||De(s);return{question_number:e.question_number_in_part||s+1,question_text:e.question_text,question_type:e.question_type||"fill_blank",options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:void 0,correct_answer:e.correct_answer,explanation:e.explanation,section_header:e.section_header||void 0,section_label:e.section_label||void 0,part_number:t,question_number_in_part:a}});Fe(s);const i=JSON.stringify(s),l=new File([i],"existing-questions.json",{type:"application/json"});de({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:n||null,csvFile:l,transcriptText:e.transcription||"",answerImageFile:null,referenceImageUrl:r,saved:!0}),n&&d.success(`Existing audio loaded: ${n.split("/").pop()}`)}else de(e=>({...e,title:t.test_name,existingAudioUrl:n||null,referenceImageUrl:r,saved:!0})),n&&d.success(`Existing audio loaded: ${n.split("/").pop()}`)}catch(t){console.error("Error loading existing data:",t),d.error("Failed to load existing data")}else console.log("âš ï¸ Skipping loadExistingData - missing testId")},Ve=(e,s)=>{de(t=>({...t,[e]:s,saved:!1}))};return ae?t.jsx("div",{className:"min-h-screen bg-[#fdfaf3] flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600 mx-auto"}),t.jsx("p",{className:"mt-2 text-sm text-[#5a4a3f]",children:"Loading Listening Management..."})]})}):te?t.jsxs(C,{title:`${ne.toUpperCase()} Test ${K} - Listening Management`,showBackButton:!0,backPath:re,onBackClick:()=>X(re),children:[t.jsxs("div",{className:"space-y-6 bg-[#fdfaf3] min-h-screen p-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-[#2f241f]",children:[ne.toUpperCase()," Test ",K," - Listening Management"]}),t.jsx("p",{className:"text-sm text-[#5a4a3f] mt-1",children:"Note theme: warm paper, per-part review with student preview"})]}),t.jsxs(x,{variant:"secondary",className:"text-sm bg-amber-100 text-amber-900 border-amber-200",children:["Test ",K]})]}),t.jsxs(r,{className:"border border-[#e0d6c7] bg-[#fdfaf3] shadow-sm",children:[t.jsx(i,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(l,{className:"flex items-center gap-2 text-[#2f241f]",children:[ce.saved?t.jsx(k,{className:"w-5 h-5 text-green-600"}):t.jsx(I,{className:"w-5 h-5 text-[#a89a8c]"}),"Listening Test - ",Ee," Part",Ee>1?"s":""," (",Re().reduce((e,s)=>e+s,0)," Questions)"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(c,{variant:"outline",size:"sm",onClick:()=>{if(Ee<=1)return void d.error("Minimum 1 part required");const e=Te.filter(e=>(e.part_number||Qe(Te.indexOf(e)))===Ee);if(e.length>0&&!confirm(`Part ${Ee} has ${e.length} question(s). Remove anyway?`))return;const s={...Ae};delete s[Ee],Ue(s),Se(Ee-1),ke>Ee-1&&Ie(Ee-1),d.success(`Part ${Ee} removed`)},disabled:Ee<=1,className:"h-8 w-8 p-0 border-amber-200",children:t.jsx(E,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-sm font-medium text-[#2f241f] min-w-[60px] text-center",children:[Ee," Parts"]}),t.jsx(c,{variant:"outline",size:"sm",onClick:()=>{if(Ee>=20)return void d.error("Maximum 20 parts allowed");const e=Ee+1;Se(e),Ue(s=>({...s,[e]:{...se}})),d.success(`Part ${e} added`)},disabled:Ee>=20,className:"h-8 w-8 p-0 border-amber-200",children:t.jsx(S,{className:"w-4 h-4"})})]}),t.jsx(x,{variant:ce.saved?"default":"outline",className:ce.saved?"bg-green-100 text-green-800 border-green-200":"border-[#e0d6c7]",children:ce.saved?"Saved":"Not Saved"})]})]})}),t.jsxs(o,{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Test Name *"}),t.jsx(p,{placeholder:`IELTS Listening Test ${K}`,value:ce.title,onChange:e=>Ve("title",e.target.value),className:"max-w-md bg-white border-[#e0d6c7] focus:border-amber-400 focus:ring-amber-200 text-[#2f241f]"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Audio File (All Parts) *"}),t.jsxs("div",{className:"border-2 border-dashed border-[#e0d6c7] bg-white rounded-lg p-6 hover:bg-amber-50/50 transition-colors",children:[t.jsx("div",{className:"flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx(A,{className:"w-12 h-12 mx-auto mb-3 text-amber-600"}),t.jsx("p",{className:"text-sm text-[#5a4a3f] mb-3",children:"Upload MP3 or WAV (30-40 minutes)"}),t.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{de(s=>({...s,audioFile:e})),de(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),Ne(!0),d.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),t.jsxs(c,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},className:"bg-amber-50 border-amber-200 text-amber-900 hover:bg-amber-100",children:[t.jsx(U,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),ce.audioFile&&t.jsxs("div",{className:"mt-4 p-3 bg-green-50 rounded-lg border border-green-200",children:[t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsxs("p",{className:"text-sm font-medium text-green-800",children:["âœ“ Audio file ready: ",ce.audioFile.name]}),t.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Size: ",(ce.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),t.jsxs(c,{variant:"outline",size:"sm",onClick:()=>Ne(!0),className:"border-green-200 text-green-800",children:[t.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim"]})]}),t.jsx("audio",{controls:!0,src:URL.createObjectURL(ce.audioFile),className:"w-full mt-3 h-8"})]}),!ce.audioFile&&ce.existingAudioUrl&&t.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-medium text-blue-800",children:"âœ“ Audio file already uploaded"}),t.jsx("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:t.jsx("source",{src:ce.existingAudioUrl,type:"audio/mpeg"})})]}),t.jsxs("div",{className:"flex gap-2 ml-4",children:[t.jsxs(c,{variant:"outline",size:"sm",onClick:async()=>{if(ce.existingAudioUrl)try{const e=d.loading("Loading audio for editing..."),s=await fetch(ce.existingAudioUrl),t=await s.blob(),a=ce.existingAudioUrl.split("/").pop()||"existing-audio.mp3",n=new File([t],a,{type:t.type});de(e=>({...e,audioFile:n})),Ne(!0),d.dismiss(e),d.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),d.dismiss(),d.error("Failed to load audio for editing")}},className:"border-blue-200 text-blue-800",children:[t.jsx(F,{className:"w-3 h-3 mr-2"}),"Trim"]}),t.jsxs(c,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(de(e=>({...e,existingAudioUrl:null,audioFile:null})),d.success("Audio deleted"))},className:"border-red-200 text-red-600",children:[t.jsx($,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),je&&ce.audioFile&&t.jsx(G,{audioFile:ce.audioFile,onTrimComplete:(e,s,t)=>{Ve("audioFile",e),Ve("audioTrimStart",s),Ve("audioTrimEnd",t),Ne(!1),d.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Reference Image (Optional)"}),t.jsx("p",{className:"text-xs text-[#5a4a3f]",children:"Upload the original test image for reference in student preview"}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(async e=>{if(e.type.startsWith("image/")){ve(!0);try{const s=await oe(e);de(e=>({...e,referenceImageUrl:s.url})),d.success("Reference image uploaded")}catch(s){d.error("Failed to upload reference image: "+s.message)}finally{ve(!1)}}else d.error("Please upload an image file")})(t)},className:"hidden",id:"reference-image-upload"}),t.jsx(c,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("reference-image-upload"))?void 0:e.click()},disabled:we,className:"bg-white border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",children:we?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-600 mr-2"}),"Uploading..."]}):t.jsxs(t.Fragment,{children:[t.jsx(O,{className:"w-4 h-4 mr-2"}),"Upload Reference Image"]})}),ce.referenceImageUrl&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(k,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{className:"text-sm text-green-700",children:"Reference image uploaded"}),t.jsx(c,{variant:"ghost",size:"sm",onClick:()=>Ve("referenceImageUrl",null),className:"text-red-500 h-6",children:t.jsx(P,{className:"w-3 h-3"})})]})]}),ce.referenceImageUrl&&t.jsx("img",{src:ce.referenceImageUrl,alt:"Reference",className:"max-w-md rounded-lg border border-[#e0d6c7] mt-2"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Transcript Text (Optional)"}),t.jsx(h,{placeholder:"Paste the full transcript text here...",value:ce.transcriptText,onChange:e=>Ve("transcriptText",e.target.value),rows:6,className:"font-mono text-sm bg-white border-[#e0d6c7] text-[#2f241f]"}),ce.transcriptText&&t.jsx("div",{className:"p-3 bg-amber-50 rounded-lg border border-amber-200",children:t.jsxs("p",{className:"text-xs text-amber-900 flex items-center gap-2",children:[t.jsx(M,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save."]})})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Paste questions to auto-parse"}),t.jsx("p",{className:"text-xs text-[#5a4a3f]",children:"Paste IELTS listening prompts (e.g., â€œQuestions 6-9...â€) and we will detect sections, instructions, and blanks without AI."}),t.jsx(h,{placeholder:"Questions 6-9\nAnswer the questions below using NO MORE THAN TWO WORDS...\n6   At the end of the 19th century...\n7   When did the British Royalty first visit Bondi?",value:_e,onChange:e=>ye(e.target.value),rows:8,className:"font-mono text-sm bg-white border-[#e0d6c7] text-[#2f241f]"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(c,{onClick:()=>{if(!_e.trim())return void d.error("Paste listening questions first");const{questions:e,warnings:s}=Z(_e);if(Ce(s),0===e.length)return void d.error("No questions detected. Please check formatting.");const t=e.map(e=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type||"fill_blank",options:e.options,correct_answer:e.correct_answer||"",section_header:e.section_header,section_instruction:e.section_instruction,part_number:e.part_number,question_number_in_part:e.question_number_in_part}));Fe(t),(e=>{const s={};e.forEach((e,t)=>{const a=e.part_number||Math.max(1,Math.floor(((e.question_number||t+1)-1)/5)+1),n=e.question_number_in_part||(e.question_number||t+1)-5*(a-1)||1;s[a]=Math.max(s[a]||0,n)});const t=Object.keys(s).map(e=>Number(e)),a=Math.max(Ee,t.length>0?Math.max(...t):Ee);Se(a),Ue(e=>{const a={...e};return t.forEach(e=>{const t=s[e]||5;a[e]={...a[e]||se,questionCount:t}}),a})})(t);const a=JSON.stringify(t),n=new File([a],"parsed-questions.json",{type:"application/json"});Ve("csvFile",n),d.success(`Parsed ${t.length} questions from pasted text`)},disabled:!_e.trim(),className:"bg-emerald-600 hover:bg-emerald-700",children:"Parse pasted text"}),t.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{ye(""),Ce([])},className:"text-[#5a4a3f]",children:"Clear"})]}),qe.length>0&&t.jsx("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-900 space-y-1",children:qe.map((e,s)=>t.jsxs("div",{children:["â€¢ ",e]},s))})]}),t.jsxs("div",{className:"space-y-4 border-t border-[#e0d6c7] pt-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Extract Questions from Image *"}),t.jsx("span",{className:"text-xs text-[#5a4a3f]",children:"Upload test image to auto-fill questions"})]}),t.jsx(T,{testId:K||"",testType:ne,initialImageFile:ce.answerImageFile,onImageSelected:e=>Ve("answerImageFile",e),onQuestionsExtracted:e=>{console.log("âœ¨ AI extracted questions:",e),console.log("ðŸ“Š Question details:"),e.forEach((e,s)=>{var t;console.log(`  ${s}: num=${e.question_number}, label="${e.label}", value="${e.value}", is_info=${e.is_info_row}, text="${null==(t=e.question_text)?void 0:t.substring(0,50)}"`)});const s=e.filter(e=>!0===e.is_info_row);console.log(`ðŸ“‹ Info rows found: ${s.length}`,s);const t=JSON.stringify(e),a=new File([t],"ai-extracted-questions.json",{type:"application/json"});Fe(e),Ve("csvFile",a),d.success(`Ready to save ${e.length} items (${s.length} info rows)!`)}})]}),t.jsxs("div",{className:"border-t border-[#e0d6c7] pt-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-[#2f241f] flex items-center gap-2 mb-4",children:[t.jsx(L,{className:"w-5 h-5"}),"Preview Comparison"]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h4",{className:"text-sm font-semibold text-[#5a4a3f] flex items-center gap-2",children:[t.jsx(O,{className:"w-4 h-4"}),"Uploaded Image (Original)"]}),t.jsx(r,{className:"bg-white border-2 border-[#e0d6c7] overflow-hidden",children:ce.answerImageFile?t.jsx("div",{className:"p-4",children:t.jsx("img",{src:URL.createObjectURL(ce.answerImageFile),alt:"Uploaded Question Image",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):ce.referenceImageUrl?t.jsx("div",{className:"p-4",children:t.jsx("img",{src:ce.referenceImageUrl,alt:"Reference",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):t.jsxs("div",{className:"p-8 text-center text-[#5a4a3f]",children:[t.jsx(O,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),t.jsx("p",{className:"text-sm",children:"No image uploaded yet"}),t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Upload an image above to see it here"})]})})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h4",{className:"text-sm font-semibold text-[#5a4a3f] flex items-center gap-2",children:[t.jsx(L,{className:"w-4 h-4"}),"Extracted Questions (Student View)"]}),t.jsxs(r,{className:"bg-white border-2 border-[#e0d6c7] overflow-hidden",style:{minHeight:"400px"},children:[t.jsxs("div",{className:"bg-[#ffd500] px-4 py-3",children:[t.jsxs("div",{className:"text-black font-bold",children:["Part - ",ke," Â  Questions ",Be(ke)," - ",Be(ke)+((null==(B=Ae[ke])?void 0:B.questionCount)||5)-1]}),t.jsx("div",{className:"text-black text-xs font-medium mt-1",children:(null==(z=Ae[ke])?void 0:z.instruction)||se.instruction})]}),t.jsx(o,{className:"p-6",children:0===(We[ke]||[]).length&&0===Te.length?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(M,{className:"w-8 h-8 mx-auto mb-3 text-amber-300"}),t.jsx("p",{className:"text-[#5a4a3f] text-sm",children:"No questions extracted yet"}),t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:'Upload an image and click "Extract" to see questions here'})]}):t.jsx("table",{className:"w-full",children:t.jsx("tbody",{children:[...We[ke]||[]].sort((e,s)=>(e.originalIndex||0)-(s.originalIndex||0)).map((e,s)=>(e=>{const s=e.globalNumber||e.questionInPart,a=e.question_type||"fill_blank";if("multiple_choice_matching"===a||e.options&&e.options.length>0&&"multiple_choice"!==a)return t.jsx("tr",{className:"border-b border-gray-100",children:t.jsx("td",{colSpan:2,className:"py-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text}),t.jsx("span",{className:"flex-1 border-b-2 border-dotted border-red-500 min-w-[60px]"})]})})},`q-${s}`);if("multiple_choice"===a)return t.jsx("tr",{className:"border-b border-gray-100",children:t.jsxs("td",{colSpan:2,className:"py-3",children:[t.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text})]}),t.jsx("div",{className:"pl-8 space-y-1",children:(e.options||[]).map((e,s)=>t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsxs("span",{className:"text-blue-600 font-semibold",children:["(",String.fromCharCode(65+s),")"]}),t.jsx("span",{className:"text-blue-600",children:e})]},s))})]})},`q-${s}`);if("table_completion"===a)return t.jsxs("tr",{className:"border-b border-gray-100",children:[t.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:e.question_text}),t.jsx("td",{className:"py-3",children:t.jsxs("span",{className:"inline-flex items-baseline",children:[t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"inline-block w-[180px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${s}`);if("map_labeling"===a||"plan_labeling"===a)return t.jsx("tr",{className:"border-b border-gray-100",children:t.jsx("td",{colSpan:2,className:"py-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-500"}),e.question_text&&t.jsx("span",{className:"text-[#1a1a1a] text-lg",children:e.question_text})]})})},`q-${s}`);if("flowchart_completion"===a)return t.jsxs("tr",{className:"border-b border-gray-100",children:[t.jsxs("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg",children:["â†’ ",e.question_text||""]}),t.jsx("td",{className:"py-3",children:t.jsxs("span",{className:"inline-flex items-baseline",children:[t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${s}`);if("sentence_completion"===a){const a=e.question_text||"";if(a.includes("___")||a.includes("...")){const e=a.split(/___|\.\.\./);return t.jsx("tr",{className:"border-b border-gray-100",children:t.jsx("td",{colSpan:2,className:"py-3",children:t.jsxs("span",{className:"text-[#1a1a1a] font-medium text-lg",children:[e[0],t.jsxs("span",{className:"text-red-600 font-bold mx-1",children:["(",s,")"]}),t.jsx("span",{className:"inline-block border-b-2 border-dotted border-red-500 w-[120px] mx-1"}),e[1]||""]})})},`q-${s}`)}}let n=e.label||"",r=e.value||"";const i=!0===e.is_info_row;if(!n&&e.question_text){const s=e.question_text,t=s.indexOf(":");if(t>0&&t<30){n=s.substring(0,t).trim();const e=s.substring(t+1).trim(),a=e.match(/\(?\d+\)?/);a&&a.index&&a.index>0&&(r=e.substring(0,a.index).trim())}else n=s.replace(/\(\d+\).*/,"").replace(/\.+$/,"").trim()}return i?t.jsxs("tr",{className:"border-b border-gray-100",children:[t.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:n}),t.jsx("td",{className:"py-3 text-[#1a1a1a] font-semibold text-lg",children:r})]},`info-${n}-${e.originalIndex}`):t.jsxs("tr",{className:"border-b border-gray-100",children:[t.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:n||`Question ${s}`}),t.jsx("td",{className:"py-3",children:t.jsxs("span",{className:"inline-flex items-baseline",children:[r&&t.jsx("span",{className:"text-[#1a1a1a] font-semibold text-lg mr-2",children:r}),t.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),t.jsx("span",{className:"inline-block w-[180px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${s}`)})(e))})})})]})]})]}),t.jsx("div",{className:"flex gap-2 flex-wrap mt-4 justify-center",children:Array.from({length:Ee},(e,s)=>s+1).map(e=>{var s;const a=We[e]||[],n=Ae[e]||se,r=(null==(s=ee[n.questionType])?void 0:s.icon)||R;return t.jsxs(c,{variant:ke===e?"default":"outline",size:"sm",className:ke===e?"bg-amber-500 hover:bg-amber-600 text-white":"bg-white border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",onClick:()=>Ie(e),children:[t.jsx(r,{className:"w-3 h-3 mr-1"}),"Part ",e," (",a.length,")"]},e)})})]}),t.jsxs("div",{className:"space-y-6 border-t border-[#e0d6c7] pt-6",children:[t.jsxs("div",{className:"p-4 bg-amber-50 rounded-lg border border-amber-200 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-semibold text-amber-900",children:["Part ",ke," Settings"]}),t.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:["Questions ",Be(ke)," â€“ ",Be(ke)+((null==(W=Ae[ke])?void 0:W.questionCount)||5)-1]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Questions in Part"}),t.jsx("input",{type:"number",min:1,max:20,value:(null==(J=Ae[ke])?void 0:J.questionCount)||5,onChange:e=>ze(ke,{questionCount:Math.max(1,Math.min(20,Number(e.target.value)||1))}),className:"w-full px-3 py-2 rounded border border-amber-200 bg-white text-[#2f241f] text-sm"})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Question Type"}),t.jsxs(b,{value:(null==(V=Ae[ke])?void 0:V.questionType)||"note_completion",onValueChange:e=>ze(ke,{questionType:e}),children:[t.jsx(g,{className:"bg-white border-amber-200",children:t.jsx(f,{})}),t.jsx(j,{children:Object.entries(ee).map(([e,s])=>{const a=s.icon;return t.jsx(N,{value:e,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(a,{className:"w-4 h-4"}),s.label]})},e)})})]})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Instruction Text"}),t.jsx(p,{value:(null==(H=Ae[ke])?void 0:H.instruction)||se.instruction,onChange:e=>ze(ke,{instruction:e.target.value}),placeholder:"Write NO MORE THAN...",className:"bg-white border-amber-200 text-sm"})]})]}),t.jsx("div",{className:"flex items-center gap-2 text-xs text-amber-700 bg-amber-100/50 rounded px-2 py-1",children:(()=>{var e;const s=ee[null==(e=Ae[ke])?void 0:e.questionType]||ee.note_completion,a=s.icon;return t.jsxs(t.Fragment,{children:[t.jsx(a,{className:"w-4 h-4"}),t.jsx("span",{children:s.description})]})})()})]}),t.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from({length:Ee},(e,s)=>s+1).map(e=>{var s,a;const n=We[e]||[],d=Ae[e]||se,m=d.questionCount,u=Be(e),p=u+m-1,h=(null==(s=ee[d.questionType])?void 0:s.icon)||R;return t.jsxs(r,{className:"bg-white border "+(ke===e?"border-amber-400 ring-2 ring-amber-200":"border-[#e0d6c7]"),children:[t.jsxs(i,{className:"pb-2 bg-amber-50/50",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(l,{className:"text-sm font-semibold text-[#2f241f] flex items-center gap-1",children:[t.jsx(h,{className:"w-3 h-3 text-amber-600"}),"Part ",e," â€¢ Q",u,"â€“",p]}),t.jsxs(x,{variant:"outline",className:"bg-white border-amber-200 text-amber-800 text-xs",children:[n.length,"/",m]})]}),t.jsx("p",{className:"text-xs text-[#5a4a3f] truncate",children:null==(a=ee[d.questionType])?void 0:a.label})]}),t.jsx(o,{className:"space-y-2 max-h-[250px] overflow-y-auto p-3",children:0===n.length?t.jsx("p",{className:"text-xs text-[#5a4a3f] text-center py-4",children:"No questions yet"}):[...n].sort((e,s)=>(e.questionInPart||0)-(s.questionInPart||0)).map(e=>{var s;return t.jsx("div",{className:"p-2 rounded border border-[#e0d6c7] bg-[#fdfaf3] group",children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(x,{variant:"outline",className:"bg-white border-amber-200 text-amber-800 text-xs shrink-0",children:["Q",e.globalNumber]}),t.jsxs("span",{className:"text-xs text-[#5a4a3f] truncate",children:[null==(s=e.question_text)?void 0:s.slice(0,35),"..."]})]}),t.jsxs("p",{className:"text-xs text-green-700 mt-1 truncate",children:["Answer: ",e.correct_answer]})]}),t.jsx(c,{variant:"ghost",size:"sm",className:"opacity-0 group-hover:opacity-100 h-6 text-amber-600 shrink-0",onClick:()=>((e,s)=>{Pe({...e}),Le(s)})(e,e.originalIndex),children:t.jsx(Q,{className:"w-3 h-3"})})]})},`list-${e.globalNumber}`)})})]},e)})}),t.jsx("div",{className:"flex justify-end",children:t.jsx(c,{variant:"outline",onClick:async()=>{if(0!==Te.length)if(ce.transcriptText){be(!0);try{console.log("ðŸ¤– Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./index-KxDfHqNJ.js").then(e=>e.ab);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:t,error:a}=await s.functions.invoke("generate-listening-explanations",{body:{questions:Te,transcriptText:ce.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const n=Te.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});Fe(n);const r=JSON.stringify(n),i=new File([r],"questions-with-explanations.json",{type:"application/json"});Ve("csvFile",i),d.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(s){console.error("Error generating explanations:",s),d.error(`Failed to generate explanations: ${s.message}`)}finally{be(!1)}}else d.error("Please provide a transcript first");else d.error("Please upload questions first")},disabled:he||!ce.transcriptText,className:"border-amber-200 text-amber-900 hover:bg-amber-50",children:he?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-500 mr-2"}),"Generating..."]}):t.jsxs(t.Fragment,{children:[t.jsx(M,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})})})]}),t.jsxs("div",{className:"bg-amber-50 rounded-lg p-4 border border-amber-200",children:[t.jsx("h4",{className:"text-sm font-semibold text-amber-900 mb-2",children:"ðŸ’¡ Tips:"}),t.jsxs("ul",{className:"text-xs text-amber-800 space-y-1 list-disc list-inside",children:[t.jsx("li",{children:"Upload audio file containing all parts"}),t.jsx("li",{children:"Use AI to extract questions from test images"}),t.jsxs("li",{children:[t.jsx("strong",{children:"Add/remove parts"})," using the +/- buttons (up to ",20," parts)"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Question types:"})," Note completion, Table, Map labeling, Multiple choice, Sentence completion, Flowchart, Plan labeling"]}),t.jsx("li",{children:"Each part has its own question count and instruction text"}),t.jsx("li",{children:"Edit questions directly - changes reflect in preview instantly"})]})]}),t.jsx("div",{className:"flex gap-3 justify-end pt-4 border-t border-[#e0d6c7]",children:t.jsx(c,{onClick:()=>(async()=>{const s=ce.audioFile;if(s||ce.existingAudioUrl||0!==Te.length){ue(!0);try{let a=ce.existingAudioUrl;if(console.log("ðŸ’¾ Starting save with existingAudioUrl:",a),s){console.log("ðŸ“¤ Uploading audio to Cloudflare R2...");const e=await oe(s);a=e.url,console.log("âœ… Audio uploaded successfully:",a)}let n=null;if(ce.transcriptText.trim()&&a){pe(!0);try{console.log("ðŸŽ™ï¸ Generating timestamps for transcript...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./index-KxDfHqNJ.js").then(e=>e.ab);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:t,error:r}=await s.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:ce.transcriptText}});if(r)throw r;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");n=t.timestamps,console.log("âœ… Timestamps generated successfully"),d.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),d.error("Failed to generate timestamps, but saving test anyway.")}finally{pe(!1)}}let r=null;ce.answerImageFile&&(console.log("ðŸ“¤ Uploading answer image..."),r=(await oe(ce.answerImageFile)).url,console.log("âœ… Answer image uploaded:",r));const i=Te.length>0?Te:[],{supabase:l}=await e(async()=>{const{supabase:e}=await import("./index-KxDfHqNJ.js").then(e=>e.ab);return{supabase:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),o={testId:K,testData:{title:ce.title||`IELTS Listening Test ${K}`,instructions:ce.instructions,audioUrl:a,transcriptText:ce.transcriptText,transcriptJson:n,answerImageUrl:r,referenceImageUrl:ce.referenceImageUrl,totalParts:Ee,partConfigs:Ae,partQuestionCounts:$e},questions:i.map((e,s)=>{const t=e.part_number||Qe(s),a=e.question_number_in_part||De(s),n=1===a,r=Ae[t]||se;return{...e,part_number:t,question_number_in_part:a,question_type:e.question_type||r.questionType,explanation:ge[s]||e.explanation||"",passage_text:n?r.instruction:null,section_instruction:n?r.instruction:null}})};console.log("ðŸ’¾ Saving test via Edge Function with audioUrl:",a);const{data:c,error:m}=await l.functions.invoke("save-listening-test",{body:o});if(m)throw console.error("Edge Function error:",m),new Error(`Edge Function failed: ${m.message||JSON.stringify(m)}`);if(!c||!c.success){const e=(null==c?void 0:c.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("âœ… Test saved successfully!"),d.success("Test saved successfully!"),de(e=>({...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null})),ue(!1)}catch(a){console.error("Error saving test:",a),d.error(`Failed to save test: ${a.message}`),ue(!1)}}else d.error("Please upload either an audio file or add questions first")})(),disabled:me||!ce.audioFile&&!ce.existingAudioUrl&&0===Te.length,className:"bg-amber-600 hover:bg-amber-700 text-white px-8",size:"lg",children:me?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):t.jsxs(t.Fragment,{children:[t.jsx(D,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})})]})]})]}),t.jsx(w,{open:null!==Oe,onOpenChange:e=>!e&&Pe(null),children:t.jsxs(v,{className:"max-w-md bg-[#fdfaf3] border-[#e0d6c7]",children:[t.jsx(_,{children:t.jsxs(y,{className:"text-[#2f241f]",children:["Edit Question ",null==Oe?void 0:Oe.question_number]})}),Oe&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Question Text"}),t.jsx(h,{value:Oe.question_text||"",onChange:e=>Pe({...Oe,question_text:e.target.value}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter question text. Use newlines for extra context/rows (e.g. 'Make Allegro')."}),t.jsx("p",{className:"text-xs text-[#5a4a3f] mt-1",children:"Tip: Use newlines to add informational rows before the question."})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Correct Answer"}),t.jsx(p,{value:Oe.correct_answer||"",onChange:e=>Pe({...Oe,correct_answer:e.target.value}),className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter correct answer..."})]}),Oe.options&&Oe.options.length>0&&t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Options (one per line)"}),t.jsx(h,{value:(Oe.options||[]).join("\n"),onChange:e=>Pe({...Oe,options:e.target.value.split("\n").filter(e=>e.trim())}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Section Label (Optional)"}),t.jsx(p,{value:Oe.section_label||"",onChange:e=>Pe({...Oe,section_label:e.target.value}),placeholder:"e.g., The Gherkin Building",className:"mt-1 bg-white border-[#e0d6c7]"})]})]}),t.jsxs(q,{children:[t.jsx(c,{variant:"outline",onClick:()=>Pe(null),className:"border-[#e0d6c7]",children:"Cancel"}),t.jsxs(c,{onClick:()=>{if(null!==Me&&Oe){const e=[...Te];e[Me]={...e[Me],question_text:Oe.question_text,question_type:Oe.question_type,correct_answer:Oe.correct_answer,options:Oe.options,section_header:Oe.section_header,section_label:Oe.section_label,section_instruction:Oe.section_instruction,explanation:Oe.explanation},Fe(e),Pe(null),Le(null),d.success("Question updated")}},className:"bg-amber-600 hover:bg-amber-700 text-white",children:[t.jsx(D,{className:"w-4 h-4 mr-2"}),"Save"]})]})]})})]}):null};export{te as default};
