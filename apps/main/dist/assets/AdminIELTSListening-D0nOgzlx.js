import{_ as e}from"./supabase-DWL4C3fA.js";import{c as t,r as s,j as a,C as r,b as n,d as i,a as l,B as o,J as c,D as d,O as m,m as u,o as x,bp as p,E as h,T as b,br as g,ax as f,u as j,G as N,w as v,g as w,l as _,L as y,bi as q,bs as C,P as k,I as T,H as F,X as A,F as I,S,p as E,q as U,s as P,t as L,n as O,bt as $}from"./index-CCrhrMPI.js";import{A as M}from"./AdminLayout-CgN88KFQ.js";import{P as R,I as D}from"./ImageQuestionExtractor-CBilfPtq.js";import{S as Q}from"./scroll-area-BRrDe8k0.js";import{T as z,a as B,b as V,c as H}from"./tabs-BkiqQW0C.js";import{A as W,b as G,a as J}from"./alert-D385Xpqz.js";import{T as X,a as Y,b as Z,c as K,d as ee,e as te}from"./table-BCvkanW2.js";import{C as se}from"./circle-alert-BxkfQePb.js";import{U as ae}from"./upload-CTuMeZjt.js";import{T as re}from"./trash-2-CfUw_ieB.js";import{I as ne}from"./image-DnEl7Dyu.js";import{S as ie}from"./save-CGhourib.js";import{L as le}from"./list-ordered-BX5Zd2l3.js";import{L as oe}from"./layout-grid-Die3eNXP.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=t("GitBranch",[["line",{x1:"6",x2:"6",y1:"3",y2:"15",key:"17qcm7"}],["circle",{cx:"18",cy:"6",r:"3",key:"1h7g24"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M18 9a9 9 0 0 1-9 9",key:"n2h4wq"}]]),de=t("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),me=t("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]),ue=t("Table2",[["path",{d:"M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18",key:"gugj83"}]]);
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function xe({audioFile:e,onTrimComplete:t}){const[d,m]=s.useState(0),[u,x]=s.useState([0,0]),[p,h]=s.useState(!1),b=s.useRef(null),g=s.useRef(null),f=s.useState(()=>URL.createObjectURL(e))[0];s.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),s.useEffect(()=>{const e=b.current;if(!e)return;const t=()=>{const t=e.duration;m(t),x([0,t])};return e.addEventListener("loadedmetadata",t),()=>e.removeEventListener("loadedmetadata",t)},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return a.jsxs(r,{className:"border-2 border-purple-200 dark:border-purple-800",children:[a.jsx(n,{children:a.jsxs(i,{className:"flex items-center gap-2",children:[a.jsx(me,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsx("audio",{ref:b,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const t=e.currentTarget.currentTime;t<u[0]?e.currentTarget.currentTime=u[0]:t>u[1]&&(e.currentTarget.currentTime=u[0],e.currentTarget.pause())}}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[a.jsxs("span",{children:["Start: ",j(u[0])]}),a.jsxs("span",{children:["End: ",j(u[1])]})]}),a.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[a.jsx("input",{type:"range",min:0,max:d,step:.1,value:u[0],onChange:e=>{const t=parseFloat(e.target.value);t<u[1]&&x([t,u[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("input",{type:"range",min:0,max:d,step:.1,value:u[1],onChange:e=>{const t=parseFloat(e.target.value);t>u[0]&&x([u[0],t])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:a.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:u[0]/d*100+"%",right:100-u[1]/d*100+"%",position:"absolute"}})})]}),a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["Duration: ",j(d)]}),a.jsxs("span",{children:["Trimmed Length: ",j(u[1]-u[0])]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx(o,{onClick:async()=>{const[s,a]=u;if(s>=a)c.error("Start time must be before end time");else{h(!0);try{const r=await e.arrayBuffer();g.current||(g.current=new(window.AudioContext||window.webkitAudioContext));const n=g.current,i=await n.decodeAudioData(r),l=Math.floor(s*i.sampleRate),o=Math.floor(a*i.sampleRate)-l,d=n.createBuffer(i.numberOfChannels,o,i.sampleRate);for(let e=0;e<i.numberOfChannels;e++){const t=i.getChannelData(e),s=d.getChannelData(e);for(let e=0;e<o;e++)s[e]=t[l+e]}const m=function(e){const t=e.length*e.numberOfChannels*2+44,s=new ArrayBuffer(t),a=new DataView(s),r=[];let n=0,i=0;const l=e=>{a.setUint16(i,e,!0),i+=2},o=e=>{a.setUint32(i,e,!0),i+=4};o(1179011410),o(t-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(t-i-4);for(let c=0;c<e.numberOfChannels;c++)r.push(e.getChannelData(c));for(;i<t;){for(let t=0;t<e.numberOfChannels;t++){let e=Math.max(-1,Math.min(1,r[t][n]));e=e<0?32768*e:32767*e,a.setInt16(i,e,!0),i+=2}n++}return s}(d),u=new Blob([m],{type:"audio/wav"}),x=new File([u],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});t(x,s,a),c.success(`Audio trimmed: ${s.toFixed(1)}s to ${a.toFixed(1)}s`)}catch(r){console.error("Trim error:",r),c.error(`Failed to trim audio: ${r.message}`)}finally{h(!1)}}},disabled:p,className:"flex-1",children:p?"Trimming...":"Apply Trim"})})]})]})}function pe({onImport:e}){const[t,r]=s.useState(!1),[n,i]=s.useState(""),[l,c]=s.useState([]),[j,N]=s.useState("input"),v=(e,t,s)=>{const a=[];let r=[];const n=[],i=e.filter(e=>e.trim().length>0);if(0===i.length)return{tableStructure:{headers:[],rows:[]},questions:[]};const l=i[0],o=l.includes("\t")?"\t":/\s{3,}/;r=l.split(o).map(e=>e.trim()).filter(Boolean);for(let c=1;c<i.length;c++){const e=i[c].split(o).map(e=>e.trim()).map((e,a)=>{const i=Array.from(e.matchAll(/\(?(\d+)\)?[\s\._â€¦]+/g));if(i.length>0){const l=i[0],o=parseInt(l[1]),c=r[a]||`Column ${a+1}`,d=e.substring(0,l.index).trim();return n.push({question_number:o,question_text:`${c}: ________________`,question_type:"table_completion",part_number:t,label:c,value:d,is_info_row:!1,section_header:s,passage_text:null}),{type:"question",num:o,text:d,raw:e}}return{type:"text",text:e,raw:e}});a.push(e),!e.some(e=>"question"===e.type)&&e.some(e=>e.text)&&n.push({question_number:0,question_text:e.map(e=>e.text).join(" | "),question_type:"table_completion",part_number:t,is_info_row:!0,section_header:s})}return{tableStructure:{headers:r,rows:a},questions:n}},w=(e,t,s)=>{const a=[];let r=null;for(const n of e){const e=n.trim();if(!e)continue;const i=e.match(/^(\d+)[.)]?\s+(.+)/),l=e.match(/^([A-Z])([.)]|\s)\s*(.+)/);i?(r&&a.push(r),r={question_number:parseInt(i[1]),question_text:i[2],question_type:"multiple_choice",options:[],part_number:t,section_header:s,correct_answer:""}):l&&r?r.options.push(l[3]):r&&!l&&(r.question_text+=" "+e)}return r&&a.push(r),a},_=(e,t,s)=>{const a=[];for(const r of e){const e=r.trim();if(!e)continue;const n=Array.from(e.matchAll(/\((\d+)\)/g));if(n.length>0){for(const r of n){const n=parseInt(r[1]),i=e.substring(0,r.index).trim(),l=e.substring(r.index+r[0].length).trim();a.push({question_number:n,question_text:`${i} ______ ${l}`.trim(),question_type:"note_completion",part_number:t,label:"Note",value:"",section_header:s})}continue}const i=e.match(/^(\d+)[.)]\s+(.*)/);if(i){const e=parseInt(i[1]);let r=i[2].trim();/[\._â€“-]{3,}/.test(r)||(r+=" ______"),a.push({question_number:e,question_text:r,question_type:"note_completion",part_number:t,label:"Note",value:"",section_header:s});continue}const l=Array.from(e.matchAll(/(\d+)[\._â€¦]+/g));if(l.length>0)for(const r of l){const n=parseInt(r[1]),i=e.substring(0,r.index).trim(),l=e.substring(r.index+r[0].length).trim();a.push({question_number:n,question_text:`${i} ______ ${l}`.trim(),question_type:"note_completion",part_number:t,label:"Note",value:"",section_header:s})}}return a};return a.jsxs(d,{open:t,onOpenChange:r,children:[a.jsxs(o,{onClick:()=>r(!0),className:"gap-2 bg-amber-600 hover:bg-amber-700 text-white shadow-md border-amber-500",children:[a.jsx(m,{className:"w-4 h-4"}),"Smart Paste Questions"]}),a.jsxs(u,{className:"max-w-5xl max-h-[90vh] flex flex-col p-0 gap-0 overflow-hidden bg-[#fdfaf3]",children:[a.jsxs("div",{className:"p-6 border-b flex items-start justify-between bg-amber-50/50 border-amber-100",children:[a.jsxs("div",{children:[a.jsx(x,{className:"text-2xl font-bold text-amber-900 font-serif",children:"Smart Content Parser"}),a.jsx(p,{className:"mt-1 text-amber-800/80",children:"Paste your Listening Test content. The AI will preserve tables, formatting, and sections."})]}),a.jsx(o,{variant:"outline",size:"sm",className:"border-amber-200 text-amber-900 hover:bg-amber-100",onClick:()=>i("Part 1: Questions 1-10\nComplete the table below. Write NO MORE THAN ONE WORD OR A NUMBER.\n\nHOLIDAY RENTALS DATES (EXAMPLE) : 10 â€“ 22 JULY\nName of property\tLocation\tFeatures\tDisadvantages\nKingfisher\tRural\tApartment\tDistance from (1)........\nSunnybanks\tVillage\tHouse\tNo (2)........"),children:"Load Table Example"}),a.jsx(o,{variant:"outline",size:"sm",className:"border-amber-200 text-amber-900 hover:bg-amber-100",onClick:()=>i("Part 2: Questions 11-16\nComplete the notes below. Write ONE WORD AND/OR A NUMBER for each answer.\n\nStart of the project:\n11. The original plan was to build a ....................\n12. The location was chosen because of the ....................\n\nCosts:\n13. Total estimated cost: $ ....................\n14. Main expense: ...................."),children:"Load Note Example"})]}),a.jsx("div",{className:"flex-1 overflow-hidden",children:a.jsxs(z,{value:j,onValueChange:N,className:"h-full flex flex-col",children:[a.jsx("div",{className:"px-6 border-b bg-amber-50/30 border-amber-100",children:a.jsxs(B,{className:"bg-transparent p-0 h-auto gap-4",children:[a.jsxs(V,{value:"input",className:"px-0 pb-2 rounded-none border-b-2 border-transparent data-[state=active]:border-amber-600 data-[state=active]:text-amber-900 data-[state=active]:bg-transparent data-[state=active]:shadow-none font-medium text-amber-900/60 flex gap-2",children:[a.jsx(R,{className:"w-4 h-4"})," Input Text"]}),a.jsxs(V,{value:"preview",className:"px-0 pb-2 rounded-none border-b-2 border-transparent data-[state=active]:border-amber-600 data-[state=active]:text-amber-900 data-[state=active]:bg-transparent data-[state=active]:shadow-none font-medium text-amber-900/60 flex gap-2",disabled:0===l.length,children:[a.jsx(h,{className:"w-4 h-4"})," Student Preview (",l.reduce((e,t)=>e+t.questions.filter(e=>0!==e.question_number).length,0)," Qs)"]})]})}),a.jsxs(H,{value:"input",className:"flex-1 flex flex-col min-h-0 m-0 p-6 space-y-4",children:[a.jsxs(W,{className:"bg-amber-50 border-amber-200 text-amber-900",children:[a.jsx(se,{className:"w-4 h-4 text-amber-600"}),a.jsx(G,{children:"Format Tips"}),a.jsx(J,{className:"text-xs text-amber-800/80 mt-1",children:'Paste directly from PDF. Ensure "Part X" and "Questions X-Y" lines are included for best structure detection.'})]}),a.jsx(b,{value:n,onChange:e=>i(e.target.value),placeholder:"Paste part content here...\nPart 1: Questions 1-5\nComplete the table...",className:"flex-1 font-mono text-sm resize-none focus-visible:ring-amber-500 border-amber-200 bg-white text-stone-900"}),a.jsx("div",{className:"flex justify-end",children:a.jsxs(o,{onClick:()=>{if(!n.trim())return;const e=[],t=n.split("\n");let s=1;const a=/Part\s+(\d+)/i,r=/Questions\s+(\d+)[-â€“](\d+)/i;let i=0;for(;i<t.length;){let n=t[i].trim();if(!n){i++;continue}const l=n.match(a);l&&(s=parseInt(l[1]));const o=n.match(r),c=/^(Complete|Write|Choose|Label)\s+/i.test(n);if(o||c){let l=o?`Questions ${o[1]}-${o[2]}`:`Questions (Part ${s})`,d="",m=i;for(c?d=n.replace(a,"").replace(r,"").trim():m++;m<t.length;){const e=t[m].trim();if(!e){m++;continue}const s=/^(Complete|Write|Choose|Label|No more than|Look at|Read the|Circle|Tick|Match|List)/i.test(e),a=/^\d+[.)]/.test(e)||/\t/.test(e)||/\.{3,}/.test(e)||/^[A-Z]\s+[A-Z]/.test(e);if(s&&!a)d+=(d?"\n":"")+e,m++;else{if(d||e!==e.toUpperCase()||a||!(e.length<50))break;d+=(d?"\n":"")+e,m++}}const u=m;let x="notes",p=!1,h=!1;for(let e=u;e<Math.min(t.length,u+8);e++){const s=t[e].trim();if(s&&((s.includes("\t")||s.match(/\s{3,}/)&&s.match(/\(.*\)/))&&(p=!0),/^\d+[.)]/.test(s))){let s=e+1;for(;s<t.length&&s<e+5;){const e=t[s].trim();if(/^[A-C][.)\s]/.test(e)){h=!0;break}if(/^\d+[.)]/.test(e))break;s++}}}d.toLowerCase().includes("table")&&(p=!0),(d.toLowerCase().includes("multiple choice")||d.toLowerCase().includes("choose the correct letter"))&&(h=!0),h?x="mcq":p&&(x="table");const b=[];for(;m<t.length;){const e=t[m];if(e.match(a))break;if(e.match(/^Questions\s+\d+[-â€“]\d+/i))break;b.push(e),m++}let g=null,f=[];if("table"===x){const{tableStructure:e,questions:t}=v(b,s,d);g=e,f=t}else"mcq"===x?(f=w(b,s,d),g=f):(f=_(b,s,d),g=b.join("\n"));f.length>0&&e.push({id:Math.random().toString(36).substr(2,9),part:s,title:l,instruction:d.trim(),type:x,content:g,questions:f}),i=m;continue}i++}c(e),N("preview")},size:"lg",className:"w-full sm:w-auto gap-2 bg-amber-600 hover:bg-amber-700 text-white",children:["Parse Content ",a.jsx(g,{className:"w-4 h-4"})]})})]}),a.jsxs(H,{value:"preview",className:"flex-1 min-h-0 m-0 relative bg-[#fdfaf3]",children:[a.jsx(Q,{className:"h-full",children:a.jsx("div",{className:"p-8 max-w-4xl mx-auto space-y-8",children:0===l.length?a.jsx("div",{className:"text-center py-12 text-stone-500 italic",children:"No sections detected. Check input format."}):l.map((e,t)=>a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"border-b-2 border-amber-200 pb-2",children:[a.jsx("h3",{className:"text-xl font-bold text-amber-900",children:e.title}),e.instruction&&a.jsx("p",{className:"text-stone-800 font-medium mt-1 whitespace-pre-wrap",children:e.instruction})]}),a.jsx("div",{className:"bg-white p-6 rounded-xl border border-[#e0d6c7] shadow-sm",children:"table"===e.type?a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(X,{children:[a.jsx(Y,{children:a.jsx(Z,{className:"hover:bg-transparent border-amber-100",children:e.content.headers.map((e,t)=>a.jsx(K,{className:"text-amber-900 font-bold bg-amber-50",children:e},t))})}),a.jsx(ee,{children:e.content.rows.map((e,t)=>a.jsx(Z,{className:"hover:bg-amber-50/30 border-amber-100",children:e.map((e,t)=>a.jsx(te,{className:"align-top py-3",children:"question"===e.type?a.jsxs("div",{className:"flex items-baseline gap-2",children:[e.text&&a.jsx("span",{className:"text-stone-900",children:e.text}),a.jsxs("div",{className:"flex items-center",children:[a.jsxs("span",{className:"font-bold text-red-600 mr-1",children:["(",e.num,")"]}),a.jsx("div",{className:"w-24 h-6 border-b-2 border-dotted border-stone-400 bg-stone-50/50"})]})]}):a.jsx("span",{className:"text-stone-800",children:e.text})},t))},t))})]})}):a.jsx("div",{className:"space-y-6",children:e.questions.map((e,t)=>{var s;return a.jsxs("div",{className:"flex gap-4 group",children:[a.jsx("div",{className:"shrink-0 w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center font-bold text-amber-700 group-hover:bg-amber-200 transition-colors",children:e.question_number}),a.jsxs("div",{className:"flex-1 space-y-2",children:[a.jsx("p",{className:"text-lg text-stone-900 font-medium",children:e.question_text}),"multiple_choice"===e.question_type&&a.jsx("div",{className:"space-y-1 ml-1",children:null==(s=e.options)?void 0:s.map((e,t)=>a.jsxs("div",{className:"flex gap-2 items-center text-stone-700",children:[a.jsx("div",{className:"w-6 h-6 rounded-full border border-stone-300 flex items-center justify-center text-xs font-bold bg-white text-stone-900",children:String.fromCharCode(65+t)}),a.jsx("span",{children:e})]},t))}),"note_completion"===e.question_type&&a.jsx("div",{className:"h-8 border-b border-stone-300 bg-stone-50 w-full max-w-xs mt-2"})]})]},t)})})})]},t))})}),a.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-[#fdfaf3]/95 backdrop-blur border-t border-[#e0d6c7] p-4 flex justify-end gap-2",children:[a.jsx(o,{variant:"ghost",onClick:()=>N("input"),className:"text-amber-900 hover:bg-amber-100",children:"Back to Input"}),a.jsxs(o,{onClick:()=>{const t=l.flatMap(e=>e.questions);t.sort((e,t)=>0===e.question_number||0===t.question_number?999:e.question_number-t.question_number),e(t),r(!1)},className:"bg-amber-600 hover:bg-amber-700 text-white gap-2",children:[a.jsx(f,{className:"w-4 h-4"})," Import Content"]})]})]})]})})]})]})}const he={note_completion:{label:"Note Completion",icon:I,description:"Fill in blanks in notes"},table_completion:{label:"Table/Form Completion",icon:ue,description:"Fill in table cells"},map_labeling:{label:"Map/Plan Labeling",icon:de,description:"Label locations on a map"},multiple_choice_matching:{label:"Multiple Choice Matching",icon:le,description:"Match letters A-H to items"},sentence_completion:{label:"Sentence Completion",icon:I,description:"Complete sentences"},flowchart_completion:{label:"Flowchart Completion",icon:ce,description:"Fill in flowchart boxes"},plan_labeling:{label:"Plan/Diagram Labeling",icon:oe,description:"Label a plan or diagram"},multiple_choice:{label:"Multiple Choice",icon:le,description:"Choose correct answer"},fill_blank:{label:"Fill in the Blank",icon:I,description:"Generic fill-in-blank"}},be={questionCount:5,questionType:"note_completion",instruction:"Write NO MORE THAN TWO WORDS OR A NUMBER for each answer."},ge=()=>{var t,p,g,f,Q,z;const B=j(),{testType:V,testId:H}=N(),{admin:W,loading:G}=v(),J=V||"ielts",X=`/admin/${J}/listening`,{listContent:Y,createContent:Z,uploadAudio:K}=w(),[ee,te]=s.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,referenceImageUrl:null,saved:!1}),[se,le]=s.useState(!1),[oe,ce]=s.useState(!1),[de,ue]=s.useState(!1);s.useState(!1);const[ge,fe]=s.useState({}),[je,Ne]=s.useState(!1),[ve,we]=s.useState(!1),[_e,ye]=s.useState([]),[qe,Ce]=s.useState(1),[ke,Te]=s.useState(8),[Fe,Ae]=s.useState(()=>{const e={};for(let t=1;t<=8;t++)e[t]={...be,questionCount:5};return e}),Ie=Object.fromEntries(Object.entries(Fe).map(([e,t])=>[e,t.questionCount])),[Se,Ee]=s.useState(null),[Ue,Pe]=s.useState(null),Le=()=>Array.from({length:ke},(e,t)=>Ie[t+1]||5),Oe=e=>{const t=Le();let s=0;for(let a=0;a<t.length;a++)if(s+=t[a],e<s)return a+1;return ke},$e=e=>{const t=Le();let s=0;for(let a=0;a<t.length;a++){const r=s+t[a];if(e<r)return e-s+1;s=r}return e-t.slice(0,t.length-1).reduce((e,t)=>e+t,0)+1},Me=e=>Le().slice(0,e-1).reduce((e,t)=>e+t,0)+1,Re=(e,t)=>{Ae(s=>({...s,[e]:{...s[e]||be,...t}}))},De=(()=>{let e=0,t=1;return _e.map((s,a)=>{if(!0===s.is_info_row||0===s.question_number){const e=s.part_number||t;return{...s,globalNumber:0,part:e,questionInPart:0,originalIndex:a,is_info_row:!0}}{const r=s.part_number||Oe(e);t=r;const n=s.question_number_in_part||$e(e),i=s.question_number||Me(r)+n-1;return e++,{...s,globalNumber:i,part:r,questionInPart:n,originalIndex:a}}})})().reduce((e,t)=>(e[t.part]=e[t.part]?[...e[t.part],t]:[t],e),{});s.useEffect(()=>{G||W||B("/admin/login")},[W,G,B]),s.useEffect(()=>{Qe()},[V,H]);const Qe=async()=>{const t=V||"IELTS";if(console.log("ðŸ”„ loadExistingData called with testType:",t,"testId:",H),H)try{const{supabase:t}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:s}=await t.from("tests").select("*").eq("id",H).maybeSingle();if(!s)return void console.log("âš ï¸ No existing test found for testId:",H);console.log("ðŸ“‹ Found existing test:",s.test_name);const{data:a}=await t.from("questions").select("*").eq("test_id",s.id).order("question_number_in_part",{ascending:!0});console.log("ðŸ“Š Found",(null==a?void 0:a.length)||0,"questions for this test");const r=s.audio_url||(a&&a.length>0?a[0].audio_url:null),n=s.reference_image_url||null;if(a&&a.length>0){const e=a[0],t=a.map((e,t)=>{const s=e.part_number||Oe(t),a=e.question_number_in_part||$e(t);return{question_number:e.question_number_in_part||t+1,question_text:e.question_text,question_type:e.question_type||"fill_blank",options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:void 0,correct_answer:e.correct_answer,explanation:e.explanation,section_header:e.section_header||void 0,section_label:e.section_label||void 0,part_number:s,question_number_in_part:a}});ye(t);const i=JSON.stringify(t),l=new File([i],"existing-questions.json",{type:"application/json"});te({title:s.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:r||null,csvFile:l,transcriptText:e.transcription||"",answerImageFile:null,referenceImageUrl:n,saved:!0}),r&&c.success(`Existing audio loaded: ${r.split("/").pop()}`)}else te(e=>({...e,title:s.test_name,existingAudioUrl:r||null,referenceImageUrl:n,saved:!0})),r&&c.success(`Existing audio loaded: ${r.split("/").pop()}`)}catch(s){console.error("Error loading existing data:",s),c.error("Failed to load existing data")}else console.log("âš ï¸ Skipping loadExistingData - missing testId")},ze=(e,t)=>{te(s=>({...s,[e]:t,saved:!1}))};return G?a.jsx("div",{className:"min-h-screen bg-[#fdfaf3] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600 mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-[#5a4a3f]",children:"Loading Listening Management..."})]})}):W?a.jsxs(M,{title:`${J.toUpperCase()} Test ${H} - Listening Management`,showBackButton:!0,backPath:X,onBackClick:()=>B(X),children:[a.jsxs("div",{className:"space-y-6 bg-[#fdfaf3] min-h-screen p-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-[#2f241f]",children:[J.toUpperCase()," Test ",H," - Listening Management"]}),a.jsx("p",{className:"text-sm text-[#5a4a3f] mt-1",children:"Note theme: warm paper, per-part review with student preview"})]}),a.jsxs(_,{variant:"secondary",className:"text-sm bg-amber-100 text-amber-900 border-amber-200",children:["Test ",H]})]}),a.jsxs(r,{className:"border border-[#e0d6c7] bg-[#fdfaf3] shadow-sm",children:[a.jsx(n,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(i,{className:"flex items-center gap-2 text-[#2f241f]",children:[ee.saved?a.jsx(y,{className:"w-5 h-5 text-green-600"}):a.jsx(q,{className:"w-5 h-5 text-[#a89a8c]"}),"Listening Test - ",ke," Part",ke>1?"s":""," (",Le().reduce((e,t)=>e+t,0)," Questions)"]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(o,{variant:"outline",size:"sm",onClick:()=>{if(ke<=1)return void c.error("Minimum 1 part required");const e=_e.filter(e=>(e.part_number||Oe(_e.indexOf(e)))===ke);if(e.length>0&&!confirm(`Part ${ke} has ${e.length} question(s). Remove anyway?`))return;const t={...Fe};delete t[ke],Ae(t),Te(ke-1),qe>ke-1&&Ce(ke-1),c.success(`Part ${ke} removed`)},disabled:ke<=1,className:"h-8 w-8 p-0 border-amber-200",children:a.jsx(C,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium text-[#2f241f] min-w-[60px] text-center",children:[ke," Parts"]}),a.jsx(o,{variant:"outline",size:"sm",onClick:()=>{if(ke>=20)return void c.error("Maximum 20 parts allowed");const e=ke+1;Te(e),Ae(t=>({...t,[e]:{...be}})),c.success(`Part ${e} added`)},disabled:ke>=20,className:"h-8 w-8 p-0 border-amber-200",children:a.jsx(k,{className:"w-4 h-4"})})]}),a.jsx(_,{variant:ee.saved?"default":"outline",className:ee.saved?"bg-green-100 text-green-800 border-green-200":"border-[#e0d6c7]",children:ee.saved?"Saved":"Not Saved"})]})]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Test Name *"}),a.jsx(T,{placeholder:`IELTS Listening Test ${H}`,value:ee.title,onChange:e=>ze("title",e.target.value),className:"max-w-md bg-white border-[#e0d6c7] focus:border-amber-400 focus:ring-amber-200 text-[#2f241f]"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Audio File (All Parts) *"}),a.jsxs("div",{className:"border-2 border-dashed border-[#e0d6c7] bg-white rounded-lg p-6 hover:bg-amber-50/50 transition-colors",children:[a.jsx("div",{className:"flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(F,{className:"w-12 h-12 mx-auto mb-3 text-amber-600"}),a.jsx("p",{className:"text-sm text-[#5a4a3f] mb-3",children:"Upload MP3 or WAV (30-40 minutes)"}),a.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];s&&(e=>{te(t=>({...t,audioFile:e})),te(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),Ne(!0),c.success(`Audio file uploaded: ${e.name}`)})(s)},className:"hidden",id:"audio-upload"}),a.jsxs(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},className:"bg-amber-50 border-amber-200 text-amber-900 hover:bg-amber-100",children:[a.jsx(ae,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),ee.audioFile&&a.jsxs("div",{className:"mt-4 p-3 bg-green-50 rounded-lg border border-green-200",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("p",{className:"text-sm font-medium text-green-800",children:["âœ“ Audio file ready: ",ee.audioFile.name]}),a.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Size: ",(ee.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>Ne(!0),className:"border-green-200 text-green-800",children:[a.jsx(me,{className:"w-3 h-3 mr-2"}),"Trim"]})]}),a.jsx("audio",{controls:!0,src:URL.createObjectURL(ee.audioFile),className:"w-full mt-3 h-8"})]}),!ee.audioFile&&ee.existingAudioUrl&&a.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"text-sm font-medium text-blue-800",children:"âœ“ Audio file already uploaded"}),a.jsx("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:a.jsx("source",{src:ee.existingAudioUrl,type:"audio/mpeg"})})]}),a.jsxs("div",{className:"flex gap-2 ml-4",children:[a.jsxs(o,{variant:"outline",size:"sm",onClick:async()=>{if(ee.existingAudioUrl)try{const e=c.loading("Loading audio for editing..."),t=await fetch(ee.existingAudioUrl),s=await t.blob(),a=ee.existingAudioUrl.split("/").pop()||"existing-audio.mp3",r=new File([s],a,{type:s.type});te(e=>({...e,audioFile:r})),Ne(!0),c.dismiss(e),c.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),c.dismiss(),c.error("Failed to load audio for editing")}},className:"border-blue-200 text-blue-800",children:[a.jsx(me,{className:"w-3 h-3 mr-2"}),"Trim"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(te(e=>({...e,existingAudioUrl:null,audioFile:null})),c.success("Audio deleted"))},className:"border-red-200 text-red-600",children:[a.jsx(re,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),je&&ee.audioFile&&a.jsx(xe,{audioFile:ee.audioFile,onTrimComplete:(e,t,s)=>{ze("audioFile",e),ze("audioTrimStart",t),ze("audioTrimEnd",s),Ne(!1),c.success(`Trim applied: ${t.toFixed(1)}s to ${s.toFixed(1)}s`)}}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Reference Image (Optional)"}),a.jsx("p",{className:"text-xs text-[#5a4a3f]",children:"Upload the original test image for reference in student preview"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];s&&(async e=>{if(e.type.startsWith("image/")){we(!0);try{const t=await K(e);te(e=>({...e,referenceImageUrl:t.url})),c.success("Reference image uploaded")}catch(t){c.error("Failed to upload reference image: "+t.message)}finally{we(!1)}}else c.error("Please upload an image file")})(s)},className:"hidden",id:"reference-image-upload"}),a.jsx(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("reference-image-upload"))?void 0:e.click()},disabled:ve,className:"bg-white border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",children:ve?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-600 mr-2"}),"Uploading..."]}):a.jsxs(a.Fragment,{children:[a.jsx(ne,{className:"w-4 h-4 mr-2"}),"Upload Reference Image"]})}),ee.referenceImageUrl&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(y,{className:"w-4 h-4 text-green-600"}),a.jsx("span",{className:"text-sm text-green-700",children:"Reference image uploaded"}),a.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ze("referenceImageUrl",null),className:"text-red-500 h-6",children:a.jsx(A,{className:"w-3 h-3"})})]})]}),ee.referenceImageUrl&&a.jsx("img",{src:ee.referenceImageUrl,alt:"Reference",className:"max-w-md rounded-lg border border-[#e0d6c7] mt-2"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Transcript Text (Optional)"}),a.jsx(b,{placeholder:"Paste the full transcript text here...",value:ee.transcriptText,onChange:e=>ze("transcriptText",e.target.value),rows:6,className:"font-mono text-sm bg-white border-[#e0d6c7] text-[#2f241f]"}),ee.transcriptText&&a.jsx("div",{className:"p-3 bg-amber-50 rounded-lg border border-amber-200",children:a.jsxs("p",{className:"text-xs text-amber-900 flex items-center gap-2",children:[a.jsx(m,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save."]})})]}),a.jsxs("div",{className:"space-y-4 border-t border-[#e0d6c7] pt-6",children:[a.jsx("div",{className:"flex items-center justify-between mb-4",children:a.jsx("h3",{className:"text-lg font-semibold text-[#2f241f]",children:"Add Content"})}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs(r,{className:"bg-white border-[#e0d6c7] shadow-sm",children:[a.jsx(n,{children:a.jsxs(i,{className:"text-base text-[#2f241f] flex gap-2",children:[a.jsx(I,{className:"w-5 h-5 text-indigo-600"}),"Paste Text / PDF"]})}),a.jsxs(l,{children:[a.jsx("p",{className:"text-sm text-[#5a4a3f] mb-4",children:"Paste text directly from IELTS PDFs. Auto-detects tables, multiple choice, and note completion formats."}),a.jsx(pe,{onImport:e=>{const t=e.map((e,t)=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer||"",explanation:"",part_number:e.part_number,question_number_in_part:0,is_info_row:e.is_info_row,label:e.label,value:e.value,section_header:e.section_header}));ye(t);const s=Math.max(...e.map(e=>e.part_number||1),ke);s>ke&&(Te(s),Ae(e=>{const t={...e};for(let a=ke+1;a<=s;a++)t[a]={...be};return t}));const a={},r={},n={};e.forEach(e=>{const t=e.part_number||1;e.question_number>0&&(a[t]=(a[t]||0)+1),e.section_header&&!r[t]&&(r[t]=e.section_header),e.question_type&&!n[t]&&(n[t]=e.question_type)}),Ae(e=>{const t={...e};for(let i=1;i<=s;i++)t[i]||(t[i]={...be}),void 0!==a[i]&&(t[i].questionCount=a[i]),r[i]&&(t[i].instruction=r[i]),n[i]&&(t[i].questionType=n[i]);return t}),c.success(`Imported ${e.length} questions from text`)}})]})]}),a.jsxs(r,{className:"bg-white border-[#e0d6c7] shadow-sm",children:[a.jsx(n,{children:a.jsxs(i,{className:"text-base text-[#2f241f] flex gap-2",children:[a.jsx(ne,{className:"w-5 h-5 text-amber-600"}),"Extract from Image"]})}),a.jsx(l,{children:a.jsxs("div",{className:"space-y-4",children:[a.jsx("p",{className:"text-sm text-[#5a4a3f]",children:"Upload a screenshot of the test. AI will identify questions and layout."}),a.jsx(D,{testId:H||"",testType:J,initialImageFile:ee.answerImageFile,onImageSelected:e=>ze("answerImageFile",e),onQuestionsExtracted:e=>{console.log("âœ¨ AI extracted questions:",e),ye(e);const t=JSON.stringify(e),s=new File([t],"ai-extracted-questions.json",{type:"application/json"});ze("csvFile",s),c.success(`Ready to save ${e.length} items!`)}})]})})]})]})]}),a.jsxs("div",{className:"border-t border-[#e0d6c7] pt-6",children:[a.jsxs("h3",{className:"text-lg font-semibold text-[#2f241f] flex items-center gap-2 mb-4",children:[a.jsx(h,{className:"w-5 h-5"}),"Preview Comparison"]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"space-y-3",children:[a.jsxs("h4",{className:"text-sm font-semibold text-[#5a4a3f] flex items-center gap-2",children:[a.jsx(ne,{className:"w-4 h-4"}),"Uploaded Image (Original)"]}),a.jsx(r,{className:"bg-white border-2 border-[#e0d6c7] overflow-hidden",children:ee.answerImageFile?a.jsx("div",{className:"p-4",children:a.jsx("img",{src:URL.createObjectURL(ee.answerImageFile),alt:"Uploaded Question Image",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):ee.referenceImageUrl?a.jsx("div",{className:"p-4",children:a.jsx("img",{src:ee.referenceImageUrl,alt:"Reference",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):a.jsxs("div",{className:"p-8 text-center text-[#5a4a3f]",children:[a.jsx(ne,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm",children:"No image uploaded yet"}),a.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Upload an image above to see it here"})]})})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("h4",{className:"text-sm font-semibold text-[#5a4a3f] flex items-center gap-2",children:[a.jsx(h,{className:"w-4 h-4"}),"Extracted Questions (Student View)"]}),a.jsxs(r,{className:"bg-white border-2 border-[#e0d6c7] overflow-hidden",style:{minHeight:"400px"},children:[a.jsxs("div",{className:"bg-[#ffd500] px-4 py-3",children:[a.jsxs("div",{className:"text-black font-bold",children:["Part - ",qe," Â  Questions ",Me(qe)," - ",Me(qe)+((null==(t=Fe[qe])?void 0:t.questionCount)||5)-1]}),a.jsx("div",{className:"text-black text-xs font-medium mt-1",children:(null==(p=Fe[qe])?void 0:p.instruction)||be.instruction})]}),a.jsx(l,{className:"p-6",children:0===(De[qe]||[]).length&&0===_e.length?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(m,{className:"w-8 h-8 mx-auto mb-3 text-amber-300"}),a.jsx("p",{className:"text-[#5a4a3f] text-sm",children:"No questions extracted yet"}),a.jsx("p",{className:"text-xs text-gray-400 mt-1",children:'Upload an image and click "Extract" to see questions here'})]}):a.jsx("table",{className:"w-full",children:a.jsx("tbody",{children:[...De[qe]||[]].sort((e,t)=>(e.originalIndex||0)-(t.originalIndex||0)).map((e,t)=>(e=>{const t=e.globalNumber||e.questionInPart,s=e.question_type||"fill_blank";if("multiple_choice_matching"===s||e.options&&e.options.length>0&&"multiple_choice"!==s)return a.jsx("tr",{className:"border-b border-gray-100",children:a.jsx("td",{colSpan:2,className:"py-3",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text}),a.jsx("span",{className:"flex-1 border-b-2 border-dotted border-red-500 min-w-[60px]"})]})})},`q-${t}`);if("multiple_choice"===s)return a.jsx("tr",{className:"border-b border-gray-100",children:a.jsxs("td",{colSpan:2,className:"py-3",children:[a.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text})]}),a.jsx("div",{className:"pl-8 space-y-1",children:(e.options||[]).map((e,t)=>a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsxs("span",{className:"text-blue-600 font-semibold",children:["(",String.fromCharCode(65+t),")"]}),a.jsx("span",{className:"text-blue-600",children:e})]},t))})]})},`q-${t}`);if("table_completion"===s)return a.jsxs("tr",{className:"border-b border-gray-100",children:[a.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:e.question_text}),a.jsx("td",{className:"py-3",children:a.jsxs("span",{className:"inline-flex items-baseline",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"inline-block w-[180px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${t}`);if("map_labeling"===s||"plan_labeling"===s)return a.jsx("tr",{className:"border-b border-gray-100",children:a.jsx("td",{colSpan:2,className:"py-3",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-500"}),e.question_text&&a.jsx("span",{className:"text-[#1a1a1a] text-lg",children:e.question_text})]})})},`q-${t}`);if("flowchart_completion"===s)return a.jsxs("tr",{className:"border-b border-gray-100",children:[a.jsxs("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg",children:["â†’ ",e.question_text||""]}),a.jsx("td",{className:"py-3",children:a.jsxs("span",{className:"inline-flex items-baseline",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${t}`);if("sentence_completion"===s){const s=e.question_text||"";if(s.includes("___")||s.includes("...")){const e=s.split(/___|\.\.\./);return a.jsx("tr",{className:"border-b border-gray-100",children:a.jsx("td",{colSpan:2,className:"py-3",children:a.jsxs("span",{className:"text-[#1a1a1a] font-medium text-lg",children:[e[0],a.jsxs("span",{className:"text-red-600 font-bold mx-1",children:["(",t,")"]}),a.jsx("span",{className:"inline-block border-b-2 border-dotted border-red-500 w-[120px] mx-1"}),e[1]||""]})})},`q-${t}`)}}let r=e.label||"",n=e.value||"";const i=!0===e.is_info_row;if(!r&&e.question_text){const t=e.question_text,s=t.indexOf(":");if(s>0&&s<30){r=t.substring(0,s).trim();const e=t.substring(s+1).trim(),a=e.match(/\(?\d+\)?/);a&&a.index&&a.index>0&&(n=e.substring(0,a.index).trim())}else r=t.replace(/\(\d+\).*/,"").replace(/\.+$/,"").trim()}return i?a.jsxs("tr",{className:"border-b border-gray-100",children:[a.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:r}),a.jsx("td",{className:"py-3 text-[#1a1a1a] font-semibold text-lg",children:n})]},`info-${r}-${e.originalIndex}`):a.jsxs("tr",{className:"border-b border-gray-100",children:[a.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:r||`Question ${t}`}),a.jsx("td",{className:"py-3",children:a.jsxs("span",{className:"inline-flex items-baseline",children:[n&&a.jsx("span",{className:"text-[#1a1a1a] font-semibold text-lg mr-2",children:n}),a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",t,")"]}),a.jsx("span",{className:"inline-block w-[180px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${t}`)})(e))})})})]})]})]}),a.jsx("div",{className:"flex gap-2 flex-wrap mt-4 justify-center",children:Array.from({length:ke},(e,t)=>t+1).map(e=>{var t;const s=De[e]||[],r=Fe[e]||be,n=(null==(t=he[r.questionType])?void 0:t.icon)||I;return a.jsxs(o,{variant:qe===e?"default":"outline",size:"sm",className:qe===e?"bg-amber-500 hover:bg-amber-600 text-white":"bg-white border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",onClick:()=>Ce(e),children:[a.jsx(n,{className:"w-3 h-3 mr-1"}),"Part ",e," (",s.length,")"]},e)})})]}),a.jsxs("div",{className:"space-y-6 border-t border-[#e0d6c7] pt-6",children:[a.jsxs("div",{className:"p-4 bg-amber-50 rounded-lg border border-amber-200 space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"text-sm font-semibold text-amber-900",children:["Part ",qe," Settings"]}),a.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:["Questions ",Me(qe)," â€“ ",Me(qe)+((null==(g=Fe[qe])?void 0:g.questionCount)||5)-1]})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Questions in Part"}),a.jsx("input",{type:"number",min:1,max:20,value:(null==(f=Fe[qe])?void 0:f.questionCount)||5,onChange:e=>Re(qe,{questionCount:Math.max(1,Math.min(20,Number(e.target.value)||1))}),className:"w-full px-3 py-2 rounded border border-amber-200 bg-white text-[#2f241f] text-sm"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Question Type"}),a.jsxs(S,{value:(null==(Q=Fe[qe])?void 0:Q.questionType)||"note_completion",onValueChange:e=>Re(qe,{questionType:e}),children:[a.jsx(E,{className:"bg-white border-amber-200",children:a.jsx(U,{})}),a.jsx(P,{children:Object.entries(he).map(([e,t])=>{const s=t.icon;return a.jsx(L,{value:e,children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(s,{className:"w-4 h-4"}),t.label]})},e)})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-amber-800 font-medium",children:"Instruction Text"}),a.jsx(T,{value:(null==(z=Fe[qe])?void 0:z.instruction)||be.instruction,onChange:e=>Re(qe,{instruction:e.target.value}),placeholder:"Write NO MORE THAN...",className:"bg-white border-amber-200 text-sm"})]})]}),a.jsx("div",{className:"flex items-center gap-2 text-xs text-amber-700 bg-amber-100/50 rounded px-2 py-1",children:(()=>{var e;const t=he[null==(e=Fe[qe])?void 0:e.questionType]||he.note_completion,s=t.icon;return a.jsxs(a.Fragment,{children:[a.jsx(s,{className:"w-4 h-4"}),a.jsx("span",{children:t.description})]})})()})]}),a.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from({length:ke},(e,t)=>t+1).map(e=>{var t,s;const c=De[e]||[],d=Fe[e]||be,m=d.questionCount,u=Me(e),x=u+m-1,p=(null==(t=he[d.questionType])?void 0:t.icon)||I;return a.jsxs(r,{className:"bg-white border "+(qe===e?"border-amber-400 ring-2 ring-amber-200":"border-[#e0d6c7]"),children:[a.jsxs(n,{className:"pb-2 bg-amber-50/50",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(i,{className:"text-sm font-semibold text-[#2f241f] flex items-center gap-1",children:[a.jsx(p,{className:"w-3 h-3 text-amber-600"}),"Part ",e," â€¢ Q",u,"â€“",x]}),a.jsxs(_,{variant:"outline",className:"bg-white border-amber-200 text-amber-800 text-xs",children:[c.length,"/",m]})]}),a.jsx("p",{className:"text-xs text-[#5a4a3f] truncate",children:null==(s=he[d.questionType])?void 0:s.label})]}),a.jsx(l,{className:"space-y-2 max-h-[250px] overflow-y-auto p-3",children:0===c.length?a.jsx("p",{className:"text-xs text-[#5a4a3f] text-center py-4",children:"No questions yet"}):[...c].sort((e,t)=>(e.questionInPart||0)-(t.questionInPart||0)).map(e=>{var t;return a.jsx("div",{className:"p-2 rounded border border-[#e0d6c7] bg-[#fdfaf3] group",children:a.jsxs("div",{className:"flex items-start justify-between gap-2",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(_,{variant:"outline",className:"bg-white border-amber-200 text-amber-800 text-xs shrink-0",children:["Q",e.globalNumber]}),a.jsxs("span",{className:"text-xs text-[#5a4a3f] truncate",children:[null==(t=e.question_text)?void 0:t.slice(0,35),"..."]})]}),a.jsxs("p",{className:"text-xs text-green-700 mt-1 truncate",children:["Answer: ",e.correct_answer]})]}),a.jsx(o,{variant:"ghost",size:"sm",className:"opacity-0 group-hover:opacity-100 h-6 text-amber-600 shrink-0",onClick:()=>((e,t)=>{Ee({...e}),Pe(t)})(e,e.originalIndex),children:a.jsx(R,{className:"w-3 h-3"})})]})},`list-${e.globalNumber}`)})})]},e)})}),a.jsx("div",{className:"flex justify-end",children:a.jsx(o,{variant:"outline",onClick:async()=>{if(0!==_e.length)if(ee.transcriptText){ue(!0);try{console.log("ðŸ¤– Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:t}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:s,error:a}=await t.functions.invoke("generate-listening-explanations",{body:{questions:_e,transcriptText:ee.transcriptText,transcriptJson:null}});if(a)throw a;if(!s.success)throw new Error(s.error||"Failed to generate explanations");const r=_e.map((e,t)=>{const a=s.explanations.find(e=>e.questionIndex===t+1);return{...e,explanation:a?a.explanation:e.explanation}});ye(r);const n=JSON.stringify(r),i=new File([n],"questions-with-explanations.json",{type:"application/json"});ze("csvFile",i),c.success(`Generated explanations for ${s.explanations.length} questions!`)}catch(t){console.error("Error generating explanations:",t),c.error(`Failed to generate explanations: ${t.message}`)}finally{ue(!1)}}else c.error("Please provide a transcript first");else c.error("Please upload questions first")},disabled:de||!ee.transcriptText,className:"border-amber-200 text-amber-900 hover:bg-amber-50",children:de?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-500 mr-2"}),"Generating..."]}):a.jsxs(a.Fragment,{children:[a.jsx(m,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})})})]}),a.jsxs("div",{className:"bg-amber-50 rounded-lg p-4 border border-amber-200",children:[a.jsx("h4",{className:"text-sm font-semibold text-amber-900 mb-2",children:"ðŸ’¡ Tips:"}),a.jsxs("ul",{className:"text-xs text-amber-800 space-y-1 list-disc list-inside",children:[a.jsx("li",{children:"Upload audio file containing all parts"}),a.jsx("li",{children:"Use AI to extract questions from test images"}),a.jsxs("li",{children:[a.jsx("strong",{children:"Add/remove parts"})," using the +/- buttons (up to ",20," parts)"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Question types:"})," Note completion, Table, Map labeling, Multiple choice, Sentence completion, Flowchart, Plan labeling"]}),a.jsx("li",{children:"Each part has its own question count and instruction text"}),a.jsx("li",{children:"Edit questions directly - changes reflect in preview instantly"})]})]}),a.jsx("div",{className:"flex gap-3 justify-end pt-4 border-t border-[#e0d6c7]",children:a.jsx(o,{onClick:()=>(async()=>{const t=ee.audioFile;if(t||ee.existingAudioUrl||0!==_e.length){le(!0);try{let a=ee.existingAudioUrl;if(console.log("ðŸ’¾ Starting save with existingAudioUrl:",a),t){console.log("ðŸ“¤ Uploading audio to Cloudflare R2...");const e=await K(t);a=e.url,console.log("âœ… Audio uploaded successfully:",a)}let r=null;if(ee.transcriptText.trim()&&a){ce(!0);try{console.log("ðŸŽ™ï¸ Generating timestamps for transcript...");const{supabase:t}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:s,error:n}=await t.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:ee.transcriptText}});if(n)throw n;if(!s.success)throw new Error(s.error||"Failed to generate timestamps");r=s.timestamps,console.log("âœ… Timestamps generated successfully"),c.success("Transcript timestamps generated!")}catch(s){console.error("Error generating timestamps:",s),c.error("Failed to generate timestamps, but saving test anyway.")}finally{ce(!1)}}let n=null;ee.answerImageFile&&(console.log("ðŸ“¤ Uploading answer image..."),n=(await K(ee.answerImageFile)).url,console.log("âœ… Answer image uploaded:",n));const i=_e.length>0?_e:[],{supabase:l}=await e(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),o={testId:H,testData:{title:ee.title||`IELTS Listening Test ${H}`,instructions:ee.instructions,audioUrl:a,transcriptText:ee.transcriptText,transcriptJson:r,answerImageUrl:n,referenceImageUrl:ee.referenceImageUrl,totalParts:ke,partConfigs:Fe,partQuestionCounts:Ie},questions:i.map((e,t)=>{const s=e.part_number||Oe(t),a=e.question_number_in_part||$e(t),r=1===a,n=Fe[s]||be;return{...e,part_number:s,question_number_in_part:a,question_type:e.question_type||n.questionType,explanation:ge[t]||e.explanation||"",passage_text:r?n.instruction:null,section_instruction:r?n.instruction:null}})};console.log("ðŸ’¾ Saving test via Edge Function with audioUrl:",a);const{data:d,error:m}=await l.functions.invoke("save-listening-test",{body:o});if(m)throw console.error("Edge Function error:",m),new Error(`Edge Function failed: ${m.message||JSON.stringify(m)}`);if(!d||!d.success){const e=(null==d?void 0:d.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("âœ… Test saved successfully!"),c.success("Test saved successfully!"),te(e=>({...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null})),le(!1)}catch(a){console.error("Error saving test:",a),c.error(`Failed to save test: ${a.message}`),le(!1)}}else c.error("Please upload either an audio file or add questions first")})(),disabled:se||!ee.audioFile&&!ee.existingAudioUrl&&0===_e.length,className:"bg-amber-600 hover:bg-amber-700 text-white px-8",size:"lg",children:se?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx(ie,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})})]})]})]}),a.jsx(d,{open:null!==Se,onOpenChange:e=>!e&&Ee(null),children:a.jsxs(u,{className:"max-w-md bg-[#fdfaf3] border-[#e0d6c7]",children:[a.jsx(O,{children:a.jsxs(x,{className:"text-[#2f241f]",children:["Edit Question ",null==Se?void 0:Se.question_number]})}),Se&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Question Text"}),a.jsx(b,{value:Se.question_text||"",onChange:e=>Ee({...Se,question_text:e.target.value}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter question text. Use newlines for extra context/rows (e.g. 'Make Allegro')."}),a.jsx("p",{className:"text-xs text-[#5a4a3f] mt-1",children:"Tip: Use newlines to add informational rows before the question."})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Correct Answer"}),a.jsx(T,{value:Se.correct_answer||"",onChange:e=>Ee({...Se,correct_answer:e.target.value}),className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter correct answer..."})]}),Se.options&&Se.options.length>0&&a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Options (one per line)"}),a.jsx(b,{value:(Se.options||[]).join("\n"),onChange:e=>Ee({...Se,options:e.target.value.split("\n").filter(e=>e.trim())}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Section Label (Optional)"}),a.jsx(T,{value:Se.section_label||"",onChange:e=>Ee({...Se,section_label:e.target.value}),placeholder:"e.g., The Gherkin Building",className:"mt-1 bg-white border-[#e0d6c7]"})]})]}),a.jsxs($,{children:[a.jsx(o,{variant:"outline",onClick:()=>Ee(null),className:"border-[#e0d6c7]",children:"Cancel"}),a.jsxs(o,{onClick:()=>{if(null!==Ue&&Se){const e=[..._e];e[Ue]={...e[Ue],question_text:Se.question_text,question_type:Se.question_type,correct_answer:Se.correct_answer,options:Se.options,section_header:Se.section_header,section_label:Se.section_label,section_instruction:Se.section_instruction,explanation:Se.explanation},ye(e),Ee(null),Pe(null),c.success("Question updated")}},className:"bg-amber-600 hover:bg-amber-700 text-white",children:[a.jsx(ie,{className:"w-4 h-4 mr-2"}),"Save"]})]})]})})]}):null};export{ge as default};
