import{s as e,_ as s}from"./supabase-DWL4C3fA.js";import{y as t,r as a,J as r,j as n,C as i,b as l,c as o,ad as d,a as c,B as u,U as m,w as x,S as p,o as g,p as h,q as b,s as f,E as j,k as v,T as w,I as N,X as y,u as k,aq as T,v as F,f as A,bd as E,ba as C,H as q}from"./index-CKnaXPOD.js";import{A as S}from"./AdminLayout-DSM8iI2m.js";import{I as _}from"./image-D_hFAEkW.js";import{T as I}from"./trash-2-BGAhI09j.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=t("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),L=t("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]),P=({testId:s,testType:t,onQuestionsExtracted:k,initialImageFile:T,onImageSelected:F})=>{const[A,E]=a.useState(null),[C,q]=a.useState(""),[S,I]=a.useState("questions"),[L,P]=a.useState("Multiple Choice"),[R,D]=a.useState(!1),[O,Q]=a.useState([]),[$,z]=a.useState(null),[M,G]=a.useState(null),[B,J]=a.useState(!1);a.useEffect(()=>{T&&V(T)},[T]);const V=e=>{if(!e.type.startsWith("image/"))return void r.error("Please upload an image file (JPG, PNG, WebP)");if(e.size>10485760)return void r.error("Image size should be less than 10MB");E(e),F&&F(e);const s=new FileReader;s.onloadend=()=>{q(s.result)},s.readAsDataURL(e),r.success("Image uploaded successfully!")},W=()=>{z(null),G(null)},H=()=>{if(null!==$&&M){const e=[...O];e[$]=M,Q(e),z(null),G(null),r.success("Question updated")}};return n.jsxs("div",{className:"space-y-6",children:[n.jsxs(i,{className:"border-2 border-purple-200 dark:border-purple-800",children:[n.jsxs(l,{className:"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950 dark:to-blue-950",children:[n.jsxs(o,{className:"flex items-center gap-2",children:[n.jsx(d,{className:"w-5 h-5 text-purple-600"}),"AI Question Extraction (Gemini Vision)"]}),n.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Upload an image of IELTS questions and let Gemini AI extract them automatically"})]}),n.jsxs(c,{className:"pt-6 space-y-6",children:[n.jsx("div",{className:"border-2 border-dashed rounded-lg p-8 transition-all duration-200 "+(B?"border-purple-500 bg-purple-50 dark:bg-purple-900/20 scale-[1.02]":"border-border hover:border-purple-400"),onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),J(!0)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget===e.target&&J(!1)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),J(!1);const s=e.dataTransfer.files;if(s&&s.length>0){const e=s[0];V(e)}},children:C?n.jsxs("div",{className:"space-y-3",children:[n.jsx("div",{className:"relative max-h-96 overflow-hidden rounded-lg border",children:n.jsx("img",{src:C,alt:"Questions Preview",className:"w-full object-contain"})}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[n.jsx(x,{className:"w-4 h-4 text-green-500"}),null==A?void 0:A.name," (",(A.size/1024).toFixed(0)," KB)"]}),n.jsx(u,{variant:"ghost",size:"sm",onClick:()=>{E(null),q(""),Q([])},children:"Change Image"})]})]}):n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"transition-transform duration-200 "+(B?"scale-110":""),children:n.jsx(_,{className:"w-16 h-16 mx-auto mb-4 "+(B?"text-purple-600":"text-purple-400")})}),n.jsx("h4",{className:"font-medium mb-2",children:B?"üìé Drop image here!":"Upload Question Image"}),n.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:B?"Release to upload":"Drag & drop or click to browse ‚Ä¢ JPG, PNG, WebP (max 10MB)"}),!B&&n.jsxs(n.Fragment,{children:[n.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&V(t)},className:"hidden",id:"question-image-upload"}),n.jsxs(u,{onClick:()=>{var e;return null==(e=document.getElementById("question-image-upload"))?void 0:e.click()},variant:"outline",className:"border-purple-300 hover:bg-purple-50",children:[n.jsx(m,{className:"w-4 h-4 mr-2"}),"Choose Image"]}),n.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"üí° Tip: Clear, high-resolution images work best"})]})]})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx("label",{className:"text-sm font-medium",children:"Extraction Type"}),n.jsxs(p,{value:S,onValueChange:I,children:[n.jsx(g,{children:n.jsx(h,{placeholder:"Select extraction type"})}),n.jsxs(b,{children:[n.jsx(f,{value:"questions",children:"üìù Questions (Full questions with options)"}),n.jsx(f,{value:"answers",children:"‚úì Answers Only (Answer keys for 1-40)"})]})]}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"üí° Choose whether to extract full questions or just the answer keys"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("label",{className:"text-sm font-medium",children:["Question Type ",n.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),n.jsxs(p,{value:L,onValueChange:P,children:[n.jsx(g,{children:n.jsx(h,{placeholder:"AI will auto-detect type"})}),n.jsxs(b,{children:[n.jsx(f,{value:"auto",children:"ü§ñ Auto-Detect (Recommended)"}),n.jsx(f,{value:"Listening Question Type 1 ‚Äì Multiple choice",children:"Type 1 ‚Äì Multiple choice"}),n.jsx(f,{value:"Listening Question Type 2 ‚Äì Matching",children:"Type 2 ‚Äì Matching"}),n.jsx(f,{value:"Listening Question Type 3 ‚Äì Plan/map/diagram labelling",children:"Type 3 ‚Äì Plan/map/diagram labelling"}),n.jsx(f,{value:"Listening Question Type 4 ‚Äì Form/note/table/flow chart/summary completion",children:"Type 4 ‚Äì Form/note/table/flow chart/summary completion"}),n.jsx(f,{value:"Listening Question Type 5 ‚Äì Sentence completion",children:"Type 5 ‚Äì Sentence completion"}),n.jsx(f,{value:"Listening Question Type 6 ‚Äì Short-answer questions",children:"Type 6 ‚Äì Short-answer questions"})]})]}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"üí° AI analyzes the image to identify question types"})]})]}),n.jsx(u,{onClick:async()=>{if(A){D(!0);try{const a=C.split(",")[1],n="1-40",i=L&&"auto"!==L?L:"";console.log("üì§ Sending to Gemini:",{extractionType:S,questionRange:n,questionType:i||"AUTO-DETECT",imageSize:a.length});const{data:l,error:o}=await e.functions.invoke("gemini-question-extractor",{body:{imageBase64:a,questionRange:n,questionType:i,extractionType:S,testType:t,testId:s}});if(o)throw console.error("‚ùå Extraction error:",o),o;if(!l.success)throw new Error(l.error||"Extraction failed");console.log("‚úÖ Extracted questions:",l),Q(l.questions);const d=l.autoDetected?`\nDetected: ${l.range} (${l.questionType})`:`Range: ${l.range}`;r.success(`‚ú® Successfully extracted ${l.count} questions!`,{description:d})}catch(a){console.error("‚ùå Extraction failed:",a),r.error("Failed to extract questions",{description:a.message||"Please try again or check the image quality"})}finally{D(!1)}}else r.error("Please upload an image")},disabled:!A||R,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700",size:"lg",children:R?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Gemini AI is analyzing the image..."]}):n.jsxs(n.Fragment,{children:[n.jsx(d,{className:"w-5 h-5 mr-2"}),"Extract Questions with AI"]})})]})]}),O.length>0&&n.jsxs(i,{children:[n.jsx(l,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsxs(o,{className:"flex items-center gap-2",children:[n.jsx(j,{className:"w-5 h-5"}),"Extracted Questions (",O.length,")"]}),n.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and edit if needed, then save to database"})]}),n.jsx(v,{variant:"secondary",className:"text-sm",children:"questions"===S?"Questions 1-40":"Answers 1-40"})]})}),n.jsxs(c,{children:[n.jsx("div",{className:"max-h-[600px] overflow-y-auto space-y-4",children:O.map((e,s)=>n.jsx("div",{className:"border rounded-lg overflow-hidden",children:$===s?n.jsxs("div",{className:"p-4 space-y-3 bg-muted/30",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"text-xs font-medium",children:["Question ",e.question_number]}),n.jsx(w,{value:(null==M?void 0:M.question_text)||"",onChange:e=>G(s=>s?{...s,question_text:e.target.value}:null),rows:3,className:"mt-1"})]}),(null==M?void 0:M.options)&&n.jsxs("div",{children:[n.jsx("label",{className:"text-xs font-medium",children:"Options (one per line)"}),n.jsx(w,{value:M.options.join("\n"),onChange:e=>G(s=>s?{...s,options:e.target.value.split("\n")}:null),rows:4,className:"mt-1"})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-xs font-medium",children:"Correct Answer"}),n.jsx(N,{value:(null==M?void 0:M.correct_answer)||"",onChange:e=>G(s=>s?{...s,correct_answer:e.target.value}:null),className:"mt-1"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs(u,{size:"sm",onClick:H,children:[n.jsx(x,{className:"w-4 h-4 mr-1"}),"Save"]}),n.jsxs(u,{size:"sm",variant:"outline",onClick:W,children:[n.jsx(y,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]}):n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 border-b",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs(v,{variant:"outline",className:"font-mono",children:["Q",e.question_number]}),n.jsx(v,{variant:"secondary",className:"Multiple Choice"===e.question_type?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"Fill in the blank"===e.question_type?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"True/False/Not Given"===e.question_type?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:e.question_type})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(u,{size:"sm",variant:"ghost",onClick:()=>(e=>{z(e),G({...O[e]})})(s),children:n.jsx(U,{className:"w-3 h-3"})}),n.jsx(u,{size:"sm",variant:"ghost",onClick:()=>(e=>{const s=O.filter((s,t)=>t!==e);Q(s),r.success("Question removed")})(s),className:"text-red-500 hover:text-red-700",children:n.jsx(y,{className:"w-3 h-3"})})]})]}),n.jsxs("div",{className:"p-4 bg-white dark:bg-gray-900",children:[n.jsxs("div",{className:"mb-3",children:[n.jsxs("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1",children:["Question ",e.question_number]}),n.jsx("p",{className:"text-base leading-relaxed",children:e.question_text})]}),e.options&&e.options.length>0&&n.jsx("div",{className:"space-y-2 pl-2",children:e.options.map((t,a)=>n.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors "+(t===e.correct_answer?"bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[n.jsx("input",{type:"radio",name:`question-${s}`,checked:t===e.correct_answer,readOnly:!0,className:"w-4 h-4"}),n.jsx("span",{className:t===e.correct_answer?"font-medium text-green-700 dark:text-green-300":"",children:t}),t===e.correct_answer&&n.jsx(v,{variant:"default",className:"ml-auto text-xs",children:"‚úì Correct"})]},a))}),!e.options&&e.correct_answer&&n.jsx("div",{className:"space-y-2",children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("label",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Answer:"}),n.jsx(N,{value:e.correct_answer,readOnly:!0,className:"max-w-xs bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700 font-medium"}),n.jsx(v,{variant:"default",className:"text-xs",children:"‚úì Correct Answer"})]})}),e.explanation&&n.jsxs("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[n.jsx("p",{className:"text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1",children:"Explanation:"}),n.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-400",children:e.explanation})]})]})]})},s))}),n.jsxs("div",{className:"mt-6 flex gap-3",children:[n.jsxs(u,{onClick:()=>k(O),className:"flex-1 bg-green-600 hover:bg-green-700",size:"lg",children:[n.jsx(x,{className:"w-5 h-5 mr-2"}),"Save ",O.length," Questions to Database"]}),n.jsx(u,{variant:"outline",onClick:()=>Q([]),children:"Clear All"})]})]})]})]})};
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function R({audioFile:e,onTrimComplete:s}){const[t,d]=a.useState(0),[m,x]=a.useState([0,0]),[p,g]=a.useState(!1),h=a.useRef(null),b=a.useRef(null),f=a.useState(()=>URL.createObjectURL(e))[0];a.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),a.useEffect(()=>{const e=h.current;if(!e)return;const s=()=>{const s=e.duration;d(s),x([0,s])};return e.addEventListener("loadedmetadata",s),()=>e.removeEventListener("loadedmetadata",s)},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return n.jsxs(i,{className:"border-2 border-purple-200 dark:border-purple-800",children:[n.jsx(l,{children:n.jsxs(o,{className:"flex items-center gap-2",children:[n.jsx(L,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),n.jsxs(c,{className:"space-y-6",children:[n.jsx("audio",{ref:h,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const s=e.currentTarget.currentTime;s<m[0]?e.currentTarget.currentTime=m[0]:s>m[1]&&(e.currentTarget.currentTime=m[0],e.currentTarget.pause())}}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[n.jsxs("span",{children:["Start: ",j(m[0])]}),n.jsxs("span",{children:["End: ",j(m[1])]})]}),n.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[n.jsx("input",{type:"range",min:0,max:t,step:.1,value:m[0],onChange:e=>{const s=parseFloat(e.target.value);s<m[1]&&x([s,m[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),n.jsx("input",{type:"range",min:0,max:t,step:.1,value:m[1],onChange:e=>{const s=parseFloat(e.target.value);s>m[0]&&x([m[0],s])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),n.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:n.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:m[0]/t*100+"%",right:100-m[1]/t*100+"%",position:"absolute"}})})]}),n.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[n.jsxs("span",{children:["Duration: ",j(t)]}),n.jsxs("span",{children:["Trimmed Length: ",j(m[1]-m[0])]})]})]}),n.jsx("div",{className:"flex gap-2",children:n.jsx(u,{onClick:async()=>{const[t,a]=m;if(t>=a)r.error("Start time must be before end time");else{g(!0);try{const n=await e.arrayBuffer();b.current||(b.current=new(window.AudioContext||window.webkitAudioContext));const i=b.current,l=await i.decodeAudioData(n),o=Math.floor(t*l.sampleRate),d=Math.floor(a*l.sampleRate)-o,c=i.createBuffer(l.numberOfChannels,d,l.sampleRate);for(let e=0;e<l.numberOfChannels;e++){const s=l.getChannelData(e),t=c.getChannelData(e);for(let e=0;e<d;e++)t[e]=s[o+e]}const u=function(e){const s=e.length*e.numberOfChannels*2+44,t=new ArrayBuffer(s),a=new DataView(t),r=[];let n=0,i=0;const l=e=>{a.setUint16(i,e,!0),i+=2},o=e=>{a.setUint32(i,e,!0),i+=4};o(1179011410),o(s-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(s-i-4);for(let d=0;d<e.numberOfChannels;d++)r.push(e.getChannelData(d));for(;i<s;){for(let s=0;s<e.numberOfChannels;s++){let e=Math.max(-1,Math.min(1,r[s][n]));e=e<0?32768*e:32767*e,a.setInt16(i,e,!0),i+=2}n++}return t}(c),m=new Blob([u],{type:"audio/wav"}),x=new File([m],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});s(x,t,a),r.success(`Audio trimmed: ${t.toFixed(1)}s to ${a.toFixed(1)}s`)}catch(n){console.error("Trim error:",n),r.error(`Failed to trim audio: ${n.message}`)}finally{g(!1)}}},disabled:p,className:"flex-1",children:p?"Trimming...":"Apply Trim"})})]})]})}const D=()=>{const e=k(),{testType:t,testId:x}=T(),{admin:p,loading:g}=F(),h=t||"ielts",b=`/admin/${h}/listening`,{listContent:f,createContent:j,uploadAudio:y}=A(),[_,U]=a.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,saved:!1}),[D,O]=a.useState(!1),[Q,$]=a.useState(!1),[z,M]=a.useState(!1);a.useState(!1);const[G,B]=a.useState({}),[J,V]=a.useState(!1),[W,H]=a.useState([]);a.useEffect(()=>{g||p||e("/admin/login")},[p,g,e]),a.useEffect(()=>{Y()},[t,x]);const Y=async()=>{const e=t||"IELTS";if(console.log("üîÑ loadExistingData called with testType:",e,"testId:",x),x)try{const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await e.from("tests").select("*").eq("id",x).maybeSingle();if(!t)return void console.log("‚ö†Ô∏è No existing test found for testId:",x);console.log("üìã Found existing test:",t.test_name),console.log("üìº Audio URL from tests table:",t.audio_url);const{data:a}=await e.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});console.log("üìä Found",(null==a?void 0:a.length)||0,"questions for this test");const n=t.audio_url||(a&&a.length>0?a[0].audio_url:null);if(console.log("üìº Final audio URL to use:",n),a&&a.length>0){const e=a[0],s=a.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:[],correct_answer:e.correct_answer,explanation:e.explanation}));H(s);const i=JSON.stringify(s),l=new File([i],"existing-questions.json",{type:"application/json"});U({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:n||null,csvFile:l,transcriptText:e.transcription||"",answerImageFile:null,saved:!0}),n?r.success(`Existing audio loaded: ${n.split("/").pop()}`):console.warn("‚ö†Ô∏è No audio URL found in database for this test")}else console.log("‚ö†Ô∏è No questions found, loading audio from tests table"),U(e=>({...e,title:t.test_name,existingAudioUrl:n||null,saved:!0})),n?(console.log("‚úÖ Audio URL loaded from tests table:",n),r.success(`Existing audio loaded: ${n.split("/").pop()}`)):console.warn("‚ö†Ô∏è No audio URL found in tests table")}catch(a){console.error("Error loading existing data:",a),r.error("Failed to load existing data")}else console.log("‚ö†Ô∏è Skipping loadExistingData - missing testId")},K=(e,s)=>{U(t=>({...t,[e]:s,saved:!1}))},Z=async()=>{if(0!==W.length)if(_.transcriptText){M(!0);try{console.log("ü§ñ Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await e.functions.invoke("generate-listening-explanations",{body:{questions:W,transcriptText:_.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const n=W.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});H(n);const i=JSON.stringify(n),l=new File([i],"questions-with-explanations.json",{type:"application/json"});K("csvFile",l),r.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(e){console.error("Error generating explanations:",e),r.error(`Failed to generate explanations: ${e.message}`)}finally{M(!1)}}else r.error("Please provide a transcript first");else r.error("Please upload questions first")};return g?n.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),n.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):p?n.jsx(S,{title:`${h.toUpperCase()} Test ${x} - Listening Management`,showBackButton:!0,backPath:b,onBackClick:()=>e(b),children:n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:[h.toUpperCase()," Test ",x," - Listening Management"]}),n.jsx("p",{className:"text-muted-foreground mt-1",children:"Create a complete listening test with one audio file and questions for all 4 parts (40 questions total)"})]}),n.jsxs(v,{variant:"secondary",className:"text-sm",children:["Test ",x]})]}),n.jsxs(i,{className:"border border-border bg-card shadow-sm",children:[n.jsx(l,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(o,{className:"flex items-center gap-2",children:[_.saved?n.jsx(E,{className:"w-5 h-5 text-green-500"}):n.jsx(C,{className:"w-5 h-5 text-muted-foreground"}),"Listening Test - All Parts (1-4)"]}),n.jsx(v,{variant:_.saved?"default":"outline",children:_.saved?"Saved":"Not Saved"})]})}),n.jsxs(c,{className:"space-y-6",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx("label",{className:"text-sm font-medium",children:"Test Name *"}),n.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:'Give this test a descriptive name (e.g., "IELTS Listening Test 1 - Cambridge 18")'}),n.jsx(N,{placeholder:`IELTS Listening Test ${x}`,value:_.title,onChange:e=>K("title",e.target.value),className:"max-w-md"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("label",{className:"text-sm font-medium",children:"Audio File (All 4 Parts) *"}),n.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload one continuous audio file containing all 4 parts of the listening test (approximately 30 minutes)"}),n.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 bg-muted/5 rounded-lg p-6 hover:bg-muted/10 transition-colors",children:[n.jsx("div",{className:"flex items-center justify-center",children:n.jsxs("div",{className:"text-center",children:[n.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),n.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload MP3 or WAV audio file (recommended: 30-40 minutes)"}),n.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{U(s=>({...s,audioFile:e})),U(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),V(!0),r.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),n.jsxs(u,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},children:[n.jsx(m,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),_.audioFile&&n.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[n.jsxs("div",{className:"flex justify-between items-start",children:[n.jsxs("div",{children:[n.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["‚úì Audio file ready: ",_.audioFile.name]}),n.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(_.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),n.jsxs(u,{variant:"outline",size:"sm",onClick:()=>V(!0),className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-green-200 text-green-800 dark:text-green-200",children:[n.jsx(L,{className:"w-3 h-3 mr-2"}),"Trim Audio"]})]}),n.jsx("audio",{controls:!0,src:URL.createObjectURL(_.audioFile),className:"w-full mt-3 h-8"})]}),!_.audioFile&&_.existingAudioUrl&&n.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200",children:n.jsxs("div",{className:"flex justify-between items-start",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx("p",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:"‚úì Audio file already uploaded"}),n.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1 break-all",children:_.existingAudioUrl.split("/").pop()}),n.jsxs("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:[n.jsx("source",{src:_.existingAudioUrl,type:"audio/mpeg"}),"Your browser does not support the audio element."]})]}),n.jsxs("div",{className:"flex space-x-2 ml-4",children:[n.jsxs(u,{variant:"outline",size:"sm",onClick:async()=>{if(_.existingAudioUrl)try{const e=r.loading("Loading audio for editing..."),s=await fetch(_.existingAudioUrl),t=await s.blob(),a=_.existingAudioUrl.split("/").pop()||"existing-audio.mp3",n=new File([t],a,{type:t.type});U(e=>({...e,audioFile:n})),V(!0),r.dismiss(e),r.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),r.dismiss(),r.error("Failed to load audio for editing")}},className:"bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 border-blue-200 text-blue-800 dark:text-blue-200",children:[n.jsx(L,{className:"w-3 h-3 mr-2"}),"Trim / Modify"]}),n.jsxs(u,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(U(e=>({...e,existingAudioUrl:null,audioFile:null})),r.success("Audio deleted"))},className:"bg-white/50 hover:bg-red-50 dark:bg-black/20 dark:hover:bg-red-900/20 border-red-200 text-red-600 dark:text-red-400",children:[n.jsx(I,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),J&&_.audioFile&&n.jsx(R,{audioFile:_.audioFile,onTrimComplete:(e,s,t)=>{K("audioFile",e),K("audioTrimStart",s),K("audioTrimEnd",t),V(!1),r.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("label",{className:"text-sm font-medium",children:["Transcript Text ",n.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional)"})]}),n.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Paste the full transcript text here. AI will automatically sync it with the audio for the student viewer."}),n.jsx(w,{placeholder:"Paste the full transcript text here...",value:_.transcriptText,onChange:e=>K("transcriptText",e.target.value),rows:6,className:"font-mono text-sm"}),_.transcriptText&&n.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200",children:n.jsxs("p",{className:"text-xs text-purple-800 dark:text-purple-200 flex items-center gap-2",children:[n.jsx(d,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save!"]})})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("label",{className:"text-sm font-medium",children:"Answer Image & Questions (All 40 Questions) *"}),n.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload an image of the questions/answer sheet. The image will be stored as the Answer Image, and you can extract questions from it using AI."}),n.jsx(P,{testId:x||"",testType:h,initialImageFile:_.answerImageFile,onImageSelected:e=>K("answerImageFile",e),onQuestionsExtracted:e=>{console.log("‚ú® AI extracted questions:",e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});H(e),K("csvFile",t),r.success(`Ready to save ${e.length} AI-extracted questions!`)}})]}),W.length>0&&n.jsxs("div",{className:"space-y-4 border-t pt-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h3",{className:"text-lg font-semibold",children:"Review Questions & Explanations"}),n.jsxs(u,{variant:"outline",onClick:Z,disabled:z||!_.transcriptText,className:"gap-2",children:[z?n.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}):n.jsx(d,{className:"w-4 h-4 text-purple-500"}),"Generate Explanations with Gemini 3.0 Pro"]})]}),!_.transcriptText&&n.jsx("p",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded",children:"‚ö†Ô∏è You need to add a transcript above to generate AI explanations."}),n.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto pr-2",children:W.map((e,s)=>n.jsx(i,{className:"bg-card border border-border shadow-sm hover:border-primary/50 transition-colors",children:n.jsxs(c,{className:"p-4 space-y-2",children:[n.jsx("div",{className:"flex justify-between items-start gap-4",children:n.jsxs("div",{className:"space-y-1 flex-1",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs(v,{variant:"outline",children:["Q",s+1]}),n.jsx("span",{className:"font-medium",children:e.question_text})]}),n.jsxs("div",{className:"text-sm text-muted-foreground pl-10",children:["Answer: ",n.jsx("span",{className:"font-semibold text-green-600",children:e.correct_answer})]})]})}),n.jsx("div",{className:"pl-10 mt-2",children:n.jsxs("div",{className:"bg-white dark:bg-slate-800 p-3 rounded-md border border-border text-sm",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1 text-purple-600 dark:text-purple-400 font-medium text-xs uppercase tracking-wider",children:[n.jsx(d,{className:"w-3 h-3"}),"AI Explanation"]}),G[s]||e.explanation?n.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:G[s]||e.explanation}):n.jsx("p",{className:"text-muted-foreground/50 italic",children:'No explanation generated yet. Click "Generate AI Explanations" above.'})]})})]})},s))})]}),n.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200",children:[n.jsx("h4",{className:"text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"üí° How this works:"}),n.jsxs("ul",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[n.jsx("li",{children:"Upload ONE audio file containing all 4 parts (Parts 1-4)"}),n.jsx("li",{children:"Use AI to extract questions from your test images"}),n.jsx("li",{children:"Questions 1-10 = Part 1, 11-20 = Part 2, 21-30 = Part 3, 31-40 = Part 4"}),n.jsx("li",{children:"Audio will be uploaded to Cloudflare R2 for fast global delivery"})]})]}),n.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[_.csvFile&&_.transcriptText&&n.jsx(u,{variant:"outline",onClick:Z,disabled:z||!_.csvFile,className:"border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/20",size:"lg",children:z?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Generating AI Explanations..."]}):n.jsxs(n.Fragment,{children:[n.jsx(d,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})}),n.jsx(u,{onClick:()=>(async()=>{const e=_.audioFile;if(e||_.existingAudioUrl||0!==W.length){O(!0);try{let a=_.existingAudioUrl;if(console.log("üíæ Starting save with existingAudioUrl:",a),e){console.log("üì§ Uploading audio to Cloudflare R2...");const s=await y(e);a=s.url,console.log("‚úÖ Audio uploaded successfully:",a)}else console.log("‚ÑπÔ∏è No new audio file to upload, using existing URL:",a);let n=null;if(_.transcriptText.trim()&&a){$(!0);try{console.log("üéôÔ∏è Generating timestamps for transcript...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:i}=await e.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:_.transcriptText}});if(i)throw i;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");n=t.timestamps,console.log("‚úÖ Timestamps generated successfully"),r.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),r.error("Failed to generate timestamps, but saving test anyway.")}finally{$(!1)}}let i=null;_.answerImageFile&&(console.log("üì§ Uploading answer image..."),i=(await y(_.answerImageFile)).url,console.log("‚úÖ Answer image uploaded:",i));const l=W.length>0?W:[];if(0===l.length&&_.csvFile){const e=await _.csvFile.text();try{const s=JSON.parse(e);l.push(...s)}catch{const s=e.split("\n").filter(e=>e.trim()),t=s[0].split(",").map(e=>e.trim().replace(/"/g,"")),a=s.slice(1).map(e=>{const s=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return t.forEach((e,t)=>{a[e]=s[t]||""}),a}).filter(e=>e.question_text&&e.correct_answer);l.push(...a)}}const{supabase:o}=await s(async()=>{const{supabase:e}=await import("./supabase-DWL4C3fA.js").then(e=>e.b);return{supabase:e}},[]),d={testId:x,testData:{title:_.title||`IELTS Listening Test ${x}`,instructions:_.instructions,audioUrl:a,transcriptText:_.transcriptText,transcriptJson:n,answerImageUrl:i},questions:l.map((e,s)=>({...e,explanation:G[s]||e.explanation||""}))};console.log("üíæ Saving test via Edge Function with audioUrl:",a),console.log("üì¶ Data being sent to Edge Function:",JSON.stringify(d,null,2));const{data:c,error:u}=await o.functions.invoke("save-listening-test",{body:d});if(console.log("Edge Function response:",{data:c,error:u}),u)throw console.error("Edge Function error:",u),new Error(`Edge Function failed: ${u.message||JSON.stringify(u)}`);if(!c||!c.success){const e=(null==c?void 0:c.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("‚úÖ Test saved successfully!"),r.success("Test saved successfully!"),console.log("üìù About to update state with:",{saved:!0,existingAudioUrl:a,audioFile:null}),U(e=>{const s={...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null};return console.log("üìù Updated state after save:",{existingAudioUrl:s.existingAudioUrl,saved:s.saved}),s}),O(!1)}catch(a){console.error("Error saving test:",a),r.error(`Failed to save test: ${a.message}`),O(!1)}}else r.error("Please upload either an audio file or add questions first")})(),disabled:D||!_.audioFile&&!_.existingAudioUrl&&0===W.length,className:"bg-primary hover:bg-primary/90 px-8",size:"lg",children:D?n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Test..."]}):n.jsxs(n.Fragment,{children:[n.jsx(m,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})]})]})]})]})}):null};export{D as default};
