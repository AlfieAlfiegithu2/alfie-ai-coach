import{_ as e}from"./supabase-DLB9cOux.js";import{c as s,r as t,j as a,C as r,b as n,d as i,a as l,B as o,J as c,br as d,D as m,O as x,m as u,o as h,bp as b,E as p,T as g,X as f,bs as j,n as N,l as v,I as w,ax as _,u as y,G as C,w as k,g as q,L as T,bi as A,bt as F,P as I,H as S,F as U,S as E,p as P,q as O,s as M,t as L,bu as $,R}from"./index-BG8T8mQJ.js";import{A as z}from"./AdminLayout-I8js-wn1.js";import{P as D,I as Q}from"./ImageQuestionExtractor-CZQqcH9Z.js";import{S as B}from"./scroll-area-Dh5JqatV.js";import{T as V,a as W,b as H,c as G}from"./tabs-DbAY-qfG.js";import{A as J,b as X,a as Y}from"./alert-sxJX-9od.js";import{T as Z,a as K,b as ee,c as se,d as te,e as ae}from"./table-1bWhAZ_a.js";import{C as re}from"./circle-alert-LSZZPEw7.js";import{L as ne}from"./list-_0R6BA4u.js";import{U as ie}from"./upload-DVXEIS_6.js";import{T as le}from"./trash-2-BTapwe_F.js";import{I as oe}from"./image-CZjBpvhu.js";import{S as ce}from"./save-Ct6ZaDw4.js";import{L as de}from"./list-ordered-CEvWEMBN.js";import{L as me}from"./layout-grid-dNei7gm-.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=s("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]),ue=s("GitBranch",[["line",{x1:"6",x2:"6",y1:"3",y2:"15",key:"17qcm7"}],["circle",{cx:"18",cy:"6",r:"3",key:"1h7g24"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M18 9a9 9 0 0 1-9 9",key:"n2h4wq"}]]),he=s("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),be=s("Scissors",[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]]),pe=s("Table2",[["path",{d:"M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18",key:"gugj83"}]]),ge=s("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]);
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function fe({audioFile:e,onTrimComplete:s}){const[d,m]=t.useState(0),[x,u]=t.useState([0,0]),[h,b]=t.useState(!1),p=t.useRef(null),g=t.useRef(null),f=t.useState(()=>URL.createObjectURL(e))[0];t.useEffect(()=>()=>URL.revokeObjectURL(f),[f]),t.useEffect(()=>{const e=p.current;if(!e)return;const s=()=>{const s=e.duration;m(s),u([0,s])};return e.addEventListener("loadedmetadata",s),()=>e.removeEventListener("loadedmetadata",s)},[e]);const j=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;return a.jsxs(r,{className:"border-2 border-purple-200 dark:border-purple-800",children:[a.jsx(n,{children:a.jsxs(i,{className:"flex items-center gap-2",children:[a.jsx(be,{className:"w-5 h-5 text-purple-500"}),"Trim Audio"]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsx("audio",{ref:p,src:f,controls:!0,className:"w-full",onTimeUpdate:e=>{const s=e.currentTarget.currentTime;s<x[0]?e.currentTarget.currentTime=x[0]:s>x[1]&&(e.currentTarget.currentTime=x[0],e.currentTarget.pause())}}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between text-sm font-medium",children:[a.jsxs("span",{children:["Start: ",j(x[0])]}),a.jsxs("span",{children:["End: ",j(x[1])]})]}),a.jsxs("div",{className:"relative h-10 flex items-center select-none",children:[a.jsx("input",{type:"range",min:0,max:d,step:.1,value:x[0],onChange:e=>{const s=parseFloat(e.target.value);s<x[1]&&u([s,x[1]])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("input",{type:"range",min:0,max:d,step:.1,value:x[1],onChange:e=>{const s=parseFloat(e.target.value);s>x[0]&&u([x[0],s])},className:"absolute w-full h-2 bg-transparent appearance-none pointer-events-none z-30 [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-5 [&::-webkit-slider-thumb]:h-5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-purple-600 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-white [&::-webkit-slider-thumb]:shadow-md"}),a.jsx("div",{className:"absolute w-full h-2 bg-secondary rounded-full overflow-hidden z-10",children:a.jsx("div",{className:"h-full bg-purple-200 dark:bg-purple-900/50",style:{left:x[0]/d*100+"%",right:100-x[1]/d*100+"%",position:"absolute"}})})]}),a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["Duration: ",j(d)]}),a.jsxs("span",{children:["Trimmed Length: ",j(x[1]-x[0])]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx(o,{onClick:async()=>{const[t,a]=x;if(t>=a)c.error("Start time must be before end time");else{b(!0);try{const r=await e.arrayBuffer();g.current||(g.current=new(window.AudioContext||window.webkitAudioContext));const n=g.current,i=await n.decodeAudioData(r),l=Math.floor(t*i.sampleRate),o=Math.floor(a*i.sampleRate)-l,d=n.createBuffer(i.numberOfChannels,o,i.sampleRate);for(let e=0;e<i.numberOfChannels;e++){const s=i.getChannelData(e),t=d.getChannelData(e);for(let e=0;e<o;e++)t[e]=s[l+e]}const m=function(e){const s=e.length*e.numberOfChannels*2+44,t=new ArrayBuffer(s),a=new DataView(t),r=[];let n=0,i=0;const l=e=>{a.setUint16(i,e,!0),i+=2},o=e=>{a.setUint32(i,e,!0),i+=4};o(1179011410),o(s-8),o(1163280727),o(544501094),o(16),l(1),l(e.numberOfChannels),o(e.sampleRate),o(2*e.sampleRate*e.numberOfChannels),l(2*e.numberOfChannels),l(16),o(1635017060),o(s-i-4);for(let c=0;c<e.numberOfChannels;c++)r.push(e.getChannelData(c));for(;i<s;){for(let s=0;s<e.numberOfChannels;s++){let e=Math.max(-1,Math.min(1,r[s][n]));e=e<0?32768*e:32767*e,a.setInt16(i,e,!0),i+=2}n++}return t}(d),x=new Blob([m],{type:"audio/wav"}),u=new File([x],e.name.replace(/\.[^/.]+$/,"")+"_trimmed.wav",{type:"audio/wav"});s(u,t,a),c.success(`Audio trimmed: ${t.toFixed(1)}s to ${a.toFixed(1)}s`)}catch(r){console.error("Trim error:",r),c.error(`Failed to trim audio: ${r.message}`)}finally{b(!1)}}},disabled:h,className:"flex-1",children:h?"Trimming...":"Apply Trim"})})]})]})}function je({onImport:e,onUploadImage:s}){const[r,n]=t.useState(!1),[i,l]=t.useState(""),[y,C]=t.useState([]),[k,q]=t.useState("input"),[T,A]=t.useState(null),[F,I]=t.useState(!1),S=d.useRef(null),[U,E]=t.useState(!1),[P,O]=t.useState(["Item","Code","Color","Quantity"]),[M,L]=t.useState([["","","",""],["","","",""],["","","",""]]),[$,R]=t.useState(!1),[z,Q]=t.useState(""),ie=(e,s,t)=>{const a=[];let r=[];const n=[],i=e.filter(e=>e.trim().length>0);if(0===i.length)return{tableStructure:{headers:[],rows:[]},questions:[]};const l=i[0],o=l.includes("\t")?"\t":/\s{3,}/;r=l.split(o).map(e=>e.trim()).filter(Boolean);for(let c=1;c<i.length;c++){const e=i[c].split(o).map(e=>e.trim()).map((e,a)=>{const i=Array.from(e.matchAll(/\(?(\d+)\)?(?:[\s\._â€¦]+|$)/g));if(i.length>0){const l=i[0],o=parseInt(l[1]),c=r[a]||`Column ${a+1}`,d=e.substring(0,l.index).trim();return n.push({question_number:o,question_text:`${c}: ________________`,question_type:"table_completion",part_number:s,label:c,value:d,is_info_row:!1,section_header:t,table_headers:r,passage_text:null}),{type:"question",num:o,text:d,raw:e}}return{type:"text",text:e,raw:e}});a.push(e),!e.some(e=>"question"===e.type)&&e.some(e=>e.text)&&n.push({question_number:0,question_text:e.map(e=>e.text).join(" | "),question_type:"table_completion",part_number:s,is_info_row:!0,section_header:t,table_headers:r})}return{tableStructure:{headers:r,rows:a},questions:n}},le=(e,s,t)=>{const a=[];let r=null;for(const n of e){const e=n.trim();if(!e)continue;const i=e.match(/^(\d+)[.)]?\s+(.+)/),l=e.match(/^([A-Z])([.)]|\s)\s*(.+)/);i?(r&&a.push(r),r={question_number:parseInt(i[1]),question_text:i[2],question_type:"multiple_choice",options:[],part_number:s,section_header:t,correct_answer:""}):l&&r?r.options.push(l[3]):r&&!l&&(r.question_text+=" "+e)}return r&&a.push(r),a},oe=(e,s,t)=>{const a=[];for(const r of e){const e=r.trim();if(!e)continue;const n=Array.from(e.matchAll(/\((\d+)\)/g));if(n.length>0){for(const r of n){const n=parseInt(r[1]),i=e.substring(0,r.index).trim(),l=e.substring(r.index+r[0].length).trim();a.push({question_number:n,question_text:`${i} ______ ${l}`.trim(),question_type:"note_completion",part_number:s,label:"Note",value:"",section_header:t})}continue}const i=e.match(/^(\d+)[.)]\s+(.*)/);if(i){const e=parseInt(i[1]);let r=i[2].trim();/[\._â€“-]{3,}/.test(r)||(r+=" ______"),a.push({question_number:e,question_text:r,question_type:"note_completion",part_number:s,label:"Note",value:"",section_header:t});continue}const l=Array.from(e.matchAll(/(\d+)[\._â€¦]+/g));if(l.length>0)for(const r of l){const n=parseInt(r[1]),i=e.substring(0,r.index).trim(),l=e.substring(r.index+r[0].length).trim();a.push({question_number:n,question_text:`${i} ______ ${l}`.trim(),question_type:"note_completion",part_number:s,label:"Note",value:"",section_header:t})}}return a},ce=()=>{var e;null==(e=S.current)||e.click()};return a.jsx(a.Fragment,{children:a.jsxs(m,{open:r,onOpenChange:n,children:[a.jsxs(o,{onClick:()=>n(!0),className:"gap-2 bg-amber-600 hover:bg-amber-700 text-white shadow-md border-amber-500",children:[a.jsx(x,{className:"w-4 h-4"}),"Smart Paste Questions"]}),a.jsxs(u,{className:"max-w-5xl max-h-[90vh] flex flex-col p-0 gap-0 bg-[#fdfaf3]",children:[a.jsxs("div",{className:"p-6 border-b flex items-start justify-between bg-amber-50/50 border-amber-100 shrink-0",children:[a.jsxs("div",{children:[a.jsx(h,{className:"text-2xl font-bold text-amber-900 font-serif",children:"Smart Content Parser"}),a.jsx(b,{className:"mt-1 text-amber-800/80",children:"Paste your Listening Test content. The AI will preserve tables, formatting, and sections."})]}),a.jsx(o,{variant:"outline",size:"sm",className:"border-amber-200 text-amber-900 hover:bg-amber-100",onClick:()=>l("Part 1: Questions 1-10\nComplete the table below. Write NO MORE THAN ONE WORD OR A NUMBER.\n\nHOLIDAY RENTALS DATES (EXAMPLE) : 10 â€“ 22 JULY\nName of property\tLocation\tFeatures\tDisadvantages\nKingfisher\tRural\tApartment\tDistance from (1)........\nSunnybanks\tVillage\tHouse\tNo (2)........"),children:"Load Table Example"}),a.jsx(o,{variant:"outline",size:"sm",className:"border-amber-200 text-amber-900 hover:bg-amber-100",onClick:()=>l("Part 2: Questions 11-16\nComplete the notes below. Write ONE WORD AND/OR A NUMBER for each answer.\n\nStart of the project:\n11. The original plan was to build a ....................\n12. The location was chosen because of the ....................\n\nCosts:\n13. Total estimated cost: $ ....................\n14. Main expense: ...................."),children:"Load Note Example"})]}),a.jsx("div",{className:"flex-1 overflow-hidden",children:a.jsxs(V,{value:k,onValueChange:q,className:"h-full flex flex-col",children:[a.jsx("div",{className:"px-6 border-b bg-amber-50/30 border-amber-100",children:a.jsxs(W,{className:"bg-transparent p-0 h-auto gap-4",children:[a.jsxs(H,{value:"input",className:"px-0 pb-2 rounded-none border-b-2 border-transparent data-[state=active]:border-amber-600 data-[state=active]:text-amber-900 data-[state=active]:bg-transparent data-[state=active]:shadow-none font-medium text-amber-900/60 flex gap-2",children:[a.jsx(D,{className:"w-4 h-4"})," Input Text"]}),a.jsxs(H,{value:"preview",className:"px-0 pb-2 rounded-none border-b-2 border-transparent data-[state=active]:border-amber-600 data-[state=active]:text-amber-900 data-[state=active]:bg-transparent data-[state=active]:shadow-none font-medium text-amber-900/60 flex gap-2",disabled:0===y.length,children:[a.jsx(p,{className:"w-4 h-4"})," Student Preview (",y.reduce((e,s)=>e+s.questions.filter(e=>0!==e.question_number).length,0)," Qs)"]})]})}),a.jsxs(G,{value:"input",className:"flex-1 flex flex-col min-h-0 m-0 p-6 space-y-4 overflow-y-auto",children:[a.jsxs(J,{className:"bg-amber-50 border-amber-200 text-amber-900 shrink-0",children:[a.jsx(re,{className:"w-4 h-4 text-amber-600"}),a.jsx(X,{children:"Format Tips"}),a.jsx(Y,{className:"text-xs text-amber-800/80 mt-1",children:'Paste directly from PDF. Ensure "Part X" and "Questions X-Y" lines are included for best structure detection.'})]}),a.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[a.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[a.jsx("label",{className:"text-sm font-semibold text-amber-900",children:"1. Paste Questions Text"}),a.jsx(g,{value:i,onChange:e=>l(e.target.value),rows:12,placeholder:"Paste part content here...\nPart 1: Questions 1-5\nComplete the table...",className:"font-mono text-sm focus-visible:ring-amber-500 border-amber-200 bg-white text-stone-900 shadow-sm p-4 leading-relaxed min-h-[300px]"}),a.jsxs(o,{variant:"outline",onClick:()=>E(!0),className:"gap-2 border-amber-300 text-amber-900 hover:bg-amber-100 hover:text-amber-900 bg-white shadow-sm self-start mt-2",children:[a.jsx(ge,{className:"w-4 h-4"})," Open Table Builder"]})]}),a.jsxs("div",{className:"w-full md:w-[350px] flex flex-col gap-2 pt-4 md:pt-0 border-t md:border-t-0 md:border-l border-amber-100 md:pl-6",children:[a.jsx("label",{className:"text-sm font-semibold text-amber-900 block",children:"2. Attach Reference Image (Optional)"}),a.jsxs("div",{className:"bg-white rounded-lg border-2 border-dashed border-amber-200 flex flex-col items-center justify-center p-6 relative min-h-[250px] shadow-sm",children:[a.jsx("input",{type:"file",ref:S,className:"hidden",accept:"image/*",onChange:async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a)try{I(!0);const e=await s(a);A(e.url),c.success("Image uploaded!")}catch(r){console.error(r),c.error("Failed to upload image"),I(!1)}}}),T?a.jsxs("div",{className:"flex flex-col items-center w-full h-full gap-4",children:[a.jsx("div",{className:"relative w-full h-40 bg-stone-50 rounded border border-stone-200 flex items-center justify-center overflow-hidden",children:a.jsx("img",{src:T,className:"h-full object-contain",alt:"Test Preview"})}),a.jsxs("div",{className:"flex gap-2 w-full",children:[a.jsx(o,{variant:"outline",size:"sm",onClick:ce,className:"flex-1 border-amber-200 text-amber-900 bg-white hover:bg-amber-50",children:"Change"}),a.jsx(o,{variant:"destructive",size:"sm",onClick:()=>A(null),className:"px-3",children:a.jsx(f,{className:"w-4 h-4"})})]})]}):a.jsxs("div",{className:"text-center space-y-6",children:[a.jsx("div",{className:"w-20 h-20 rounded-full bg-amber-50 flex items-center justify-center mx-auto text-amber-500 border border-amber-100 shadow-sm",children:a.jsx(p,{className:"w-10 h-10"})}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"font-semibold text-amber-900 text-base",children:"Upload Map or Diagram"}),a.jsxs("p",{className:"text-xs text-stone-500 max-w-[220px] mx-auto leading-relaxed",children:["This image will be displayed alongside ",a.jsx("strong",{children:"every question"})," in this batch."]})]}),a.jsx(o,{onClick:ce,className:"bg-amber-600 hover:bg-amber-700 text-white shadow-md border-amber-500 w-full",disabled:F,children:F?a.jsx(a.Fragment,{children:"Uploading..."}):a.jsxs(a.Fragment,{children:[a.jsx(x,{className:"w-4 h-4 mr-2"})," Choose Image"]})})]})]})]})]}),a.jsx("div",{className:"shrink-0 flex justify-end pt-6 border-t border-amber-100 mt-4",children:a.jsxs(o,{onClick:()=>{if(!i.trim())return;const e=[],s=i.split("\n");let t=1;const a=/Part\s+(\d+)/i,r=/Questions\s+(\d+)[-â€“](\d+)/i;let n=0;for(;n<s.length;){let i=s[n].trim();if(!i){n++;continue}const l=i.match(a);l&&(t=parseInt(l[1]));const o=i.match(r),c=/^(Complete|Write|Choose|Label)\s+/i.test(i);if(o||c){let l=o?`Questions ${o[1]}-${o[2]}`:`Questions (Part ${t})`,d="",m=n;for(c?d=i.replace(a,"").replace(r,"").trim():m++;m<s.length;){const e=s[m].trim();if(!e){m++;continue}const t=/^(Complete|Write|Choose|Label|No more than|Look at|Read the|Circle|Tick|Match|List)/i.test(e),a=/^\d+[.)]/.test(e)||/\t/.test(e)||/\.{3,}/.test(e)||/^[A-Z]\s+[A-Z]/.test(e);if(t&&!a)d+=(d?"\n":"")+e,m++;else{if(d||e!==e.toUpperCase()||a||!(e.length<50))break;d+=(d?"\n":"")+e,m++}}const x=m;let u="notes",h=!1,b=!1;for(let e=x;e<Math.min(s.length,x+8);e++){const t=s[e].trim();if(t&&((t.includes("\t")||t.match(/\s{3,}/)&&t.match(/\(.*\)/))&&(h=!0),/^\d+[.)]/.test(t))){let t=e+1;for(;t<s.length&&t<e+5;){const e=s[t].trim();if(/^[A-C][.)\s]/.test(e)){b=!0;break}if(/^\d+[.)]/.test(e))break;t++}}}d.toLowerCase().includes("table")&&(h=!0),(d.toLowerCase().includes("multiple choice")||d.toLowerCase().includes("choose the correct letter"))&&(b=!0),b?u="mcq":h&&(u="table");const p=[];for(;m<s.length;){const e=s[m];if(e.match(a))break;if(e.match(/^Questions\s+\d+[-â€“]\d+/i))break;p.push(e),m++}let g=null,f=[];if("table"===u){const{tableStructure:e,questions:s}=ie(p,t,d);g=e,f=s}else"mcq"===u?(f=le(p,t,d),g=f):(f=oe(p,t,d),g=p.join("\n"));f.length>0&&e.push({id:Math.random().toString(36).substr(2,9),part:t,title:l,instruction:d.trim(),type:u,content:g,questions:f}),n=m;continue}n++}C(e),q("preview")},size:"lg",className:"w-full sm:w-auto gap-2 bg-amber-600 hover:bg-amber-700 text-white shadow-lg text-base px-8 py-6 h-auto",children:["Parse Content ",a.jsx(j,{className:"w-5 h-5"})]})})]}),a.jsx(m,{open:$,onOpenChange:R,children:a.jsxs(u,{className:"max-w-2xl bg-white border-stone-200 shadow-xl",children:[a.jsxs(N,{children:[a.jsx(h,{className:"text-2xl text-stone-900",children:"Import Answers"}),a.jsx(b,{className:"text-stone-500",children:'Paste the answer key list below. Format: "1. Answer" or "1 Answer".'})]}),a.jsx("div",{className:"space-y-4 py-4",children:a.jsx(g,{value:z,onChange:e=>Q(e.target.value),placeholder:"1. Saturday 25\n2. 55\n3. knives/ forks...",className:"min-h-[300px] font-mono text-sm bg-white text-stone-900 border-stone-300 focus:border-amber-500"})}),a.jsxs("div",{className:"flex justify-end gap-3",children:[a.jsx(o,{variant:"outline",onClick:()=>R(!1),children:"Cancel"}),a.jsx(o,{onClick:()=>{const e=new Map,s=z.split("\n");let t=0;if(s.forEach(s=>{const t=s.trim();if(!t)return;const a=t.match(/^(\d+)[\.\)]?\s+(.*)$/);if(a){const s=parseInt(a[1]),t=a[2].trim();e.set(s,t)}}),0===e.size)return void c.error("No valid answers found. Check format e.g. '1. Answer'");const a=y.map(s=>({...s,questions:s.questions.map(s=>{const a="number"==typeof s.question_number?s.question_number:parseInt(s.question_number);return e.has(a)?(t++,{...s,correct_answer:e.get(a)}):s})}));C(a),R(!1),Q(""),t>0?c.success(`Applied ${t} answers to questions!`):c.warning(`Parsed ${e.size} answers but found no matching Question Numbers in the current sections.`)},className:"bg-amber-600 hover:bg-amber-700 text-white",children:"Apply Answers"})]})]})}),a.jsx(m,{open:U,onOpenChange:E,children:a.jsxs(u,{className:"max-w-5xl max-h-[85vh] flex flex-col bg-white border-stone-200 shadow-xl",children:[a.jsxs(N,{className:"border-b pb-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(h,{className:"text-2xl text-stone-900",children:"Table Builder"}),a.jsxs(v,{variant:"secondary",className:"bg-amber-100 text-amber-800 border-amber-200",children:[M.flat().filter(e=>/\(?(\d+)\)?/.test(e||"")).length," Questions Detected"]})]}),a.jsx(b,{className:"text-stone-500",children:"Create a structured table for your listening test. Questions will be automatically formatted."})]}),a.jsx("div",{className:"flex-1 overflow-auto p-1 space-y-6",children:a.jsxs("div",{className:"bg-brand-50/50 p-6 rounded-lg border border-brand-100 flex flex-col h-full",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("h4",{className:"font-bold text-lg text-stone-900",children:"Interactive Table Preview"}),a.jsxs("p",{className:"text-sm text-stone-500",children:["Edit headers directly. Add rows/columns as needed. Use ",a.jsx("b",{children:"(1)"})," for questions."]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{O([...P,`Col ${P.length+1}`])},className:"border-amber-200 text-amber-700 hover:bg-amber-50 gap-2",children:[a.jsx(ne,{className:"w-4 h-4"})," Add Column"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>L([...M,Array(P.length).fill("")]),className:"border-amber-200 text-amber-700 hover:bg-amber-50 gap-2",children:[a.jsx(ge,{className:"w-4 h-4"})," Add Row"]})]})]}),a.jsxs("div",{className:"flex-1 border rounded-lg border-stone-200 overflow-auto shadow-sm bg-white",children:[a.jsxs(Z,{children:[a.jsx(K,{className:"bg-stone-50 sticky top-0 z-10 shadow-sm",children:a.jsxs(ee,{children:[P.map((e,s)=>a.jsx(se,{className:"min-w-[150px] p-2 border-r border-b border-stone-200 bg-stone-50",children:a.jsxs("div",{className:"flex items-center gap-1 group",children:[a.jsx(w,{value:e,onChange:e=>((e,s)=>{const t=[...P];t[e]=s,O(t)})(s,e.target.value),className:"h-8 text-sm font-bold bg-white border-stone-200 text-stone-900 focus-visible:ring-amber-500",placeholder:`Column ${s+1}`}),a.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 text-stone-400 hover:text-red-500 transition-opacity",onClick:()=>(e=>{if(P.length<=1)return void c.error("Table must have at least one column");const s=[...P];s.splice(e,1),O(s);const t=M.map(s=>{const t=[...s];return t.splice(e,1),t});L(t)})(s),title:"Remove Column",children:a.jsx(f,{className:"w-3 h-3"})})]})},s)),a.jsx(se,{className:"w-[50px] bg-stone-50 border-b border-stone-200"})]})}),a.jsx(te,{children:M.map((e,s)=>a.jsxs(ee,{className:"hover:bg-stone-50",children:[P.map((t,r)=>{const n=e[r]||"",i=n.match(/\(?(\d+)\)?/),l=!!i,o=i?i[1]:null;return a.jsx(ae,{className:"p-2 border-r border-stone-100 last:border-0 align-top min-w-[150px]",children:a.jsxs("div",{className:"relative group",children:[a.jsx(w,{value:n,onChange:e=>{const t=[...M];t[s]||(t[s]=Array(P.length).fill("")),t[s][r]=e.target.value,L(t)},className:"h-9 border-stone-200 bg-white text-stone-900 focus-visible:ring-amber-500 focus-visible:border-amber-500 "+(l?"pr-12 text-green-700 font-medium border-green-200 ring-1 ring-green-100":""),placeholder:0===r?"Content...":"(1)"}),l&&a.jsx("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 flex items-center pointer-events-none",children:a.jsxs(v,{className:"h-5 px-1.5 bg-green-100 text-green-700 hover:bg-green-100 border-green-200 text-[10px] font-bold shadow-none",children:["Q",o]})})]})},r)}),a.jsx(ae,{className:"p-2 align-middle text-center w-[50px]",children:a.jsx(o,{variant:"ghost",size:"icon",className:"h-8 w-8 text-stone-400 hover:text-red-500 hover:bg-red-50",onClick:()=>{const e=[...M];e.splice(s,1),L(e)},children:a.jsx(f,{className:"w-4 h-4"})})})]},s))})]}),0===M.length&&a.jsx("div",{className:"p-12 text-center text-stone-400 bg-stone-50/20 italic",children:"Start adding content to build your table."})]})]})}),a.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-stone-100 bg-stone-50/50 p-4 -mx-6 -mb-6 mt-4",children:[a.jsx(o,{variant:"outline",onClick:()=>E(!1),className:"bg-white border-stone-300 text-stone-700",children:"Cancel"}),a.jsx(o,{onClick:()=>{const e=`\n\nPart X: Questions Y-Z\nComplete the table below.\n\n${P.map(e=>e.trim()).join("\t")}\n${M.map(e=>e.map(e=>e||"").join("\t").trim()).filter(e=>e.length>0&&e.replace(/\t/g,"").length>0).join("\n")}\n`;l(s=>s+e),E(!1),c.success("Table appended to input text!")},className:"bg-amber-600 hover:bg-amber-700 text-white shadow-sm px-8",children:"Insert Table"})]})]})}),a.jsxs(G,{value:"preview",className:"flex-1 min-h-0 m-0 relative bg-[#fdfaf3] flex flex-col",children:[a.jsx(B,{className:"flex-1 w-full",children:a.jsxs("div",{className:"p-6 space-y-6 w-full",children:[T&&a.jsxs("div",{className:"rounded-lg overflow-hidden border border-amber-200 bg-white/50 shadow-sm max-w-sm mx-auto",children:[a.jsx("div",{className:"bg-amber-50/50 p-2 text-center text-xs text-amber-800 font-medium border-b border-amber-100",children:"Reference Image (Applied to all)"}),a.jsx("img",{src:T,className:"w-full h-auto max-h-[300px] object-contain p-2",alt:"Preview"})]}),0===y.length?a.jsx("div",{className:"text-center py-12 text-stone-500 italic",children:"No sections detected. Check input format."}):y.map((e,s)=>a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"border-b-2 border-amber-200 pb-2",children:[a.jsx("h3",{className:"text-xl font-bold text-amber-900",children:e.title}),e.instruction&&a.jsx("p",{className:"text-stone-800 font-medium mt-1 whitespace-pre-wrap",children:e.instruction})]}),a.jsx("div",{className:"bg-white p-6 rounded-xl border border-[#e0d6c7] shadow-sm",children:"table"===e.type?a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(Z,{children:[a.jsx(K,{children:a.jsx(ee,{className:"hover:bg-transparent border-amber-100",children:e.content.headers.map((e,s)=>a.jsx(se,{className:"text-amber-900 font-bold bg-amber-50",children:e},s))})}),a.jsx(te,{children:e.content.rows.map((e,s)=>a.jsx(ee,{className:"hover:bg-amber-50/30 border-amber-100",children:e.map((e,s)=>a.jsx(ae,{className:"align-top py-3",children:"question"===e.type?a.jsxs("div",{className:"flex items-baseline gap-2",children:[e.text&&a.jsx("span",{className:"text-stone-900",children:e.text}),a.jsxs("div",{className:"flex items-center",children:[a.jsxs("span",{className:"font-bold text-red-600 mr-1",children:["(",e.num,")"]}),a.jsx("div",{className:"w-24 h-6 border-b-2 border-dotted border-stone-400 bg-stone-50/50"})]})]}):a.jsx("span",{className:"text-stone-800",children:e.text})},s))},s))})]})}):a.jsx("div",{className:"space-y-6",children:e.questions.map((e,s)=>{var t;return a.jsxs("div",{className:"flex gap-4 group",children:[a.jsx("div",{className:"shrink-0 w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center font-bold text-amber-700 group-hover:bg-amber-200 transition-colors",children:e.question_number}),a.jsxs("div",{className:"flex-1 space-y-2",children:[a.jsx("p",{className:"text-lg text-stone-900 font-medium",children:e.question_text}),"multiple_choice"===e.question_type&&a.jsx("div",{className:"space-y-1 ml-1",children:null==(t=e.options)?void 0:t.map((e,s)=>a.jsxs("div",{className:"flex gap-2 items-center text-stone-700",children:[a.jsx("div",{className:"w-6 h-6 rounded-full border border-stone-300 flex items-center justify-center text-xs font-bold bg-white text-stone-900",children:String.fromCharCode(65+s)}),a.jsx("span",{children:e})]},s))}),"note_completion"===e.question_type&&a.jsx("div",{className:"h-8 border-b border-stone-300 bg-stone-50 w-full max-w-xs mt-2"})]})]},s)})})})]},s))]})}),a.jsxs("div",{className:"shrink-0 bg-[#fdfaf3]/95 backdrop-blur border-t border-[#e0d6c7] p-4 flex justify-end gap-2 z-10 relative",children:[a.jsxs(o,{variant:"outline",onClick:()=>R(!0),className:"absolute left-4 gap-2 border-amber-200 text-amber-900 bg-white hover:bg-amber-50 shadow-sm",children:[a.jsx(xe,{className:"w-4 h-4"})," Import Answers"]}),a.jsx(o,{variant:"ghost",onClick:()=>q("input"),className:"text-amber-900 hover:bg-amber-100",children:"Back to Input"}),a.jsxs(o,{onClick:()=>{const s=y.flatMap(e=>e.questions.map(e=>({...e,question_image_url:T||e.question_image_url})));s.sort((e,s)=>0===e.question_number||0===s.question_number?999:e.question_number-s.question_number),e(s),n(!1),A(null)},className:"bg-amber-600 hover:bg-amber-700 text-white gap-2",children:[a.jsx(_,{className:"w-4 h-4"})," Save Questions"]})]})]})]})})]})]})})}const Ne={note_completion:{label:"Note Completion",icon:U,description:"Fill in blanks in notes"},table_completion:{label:"Table/Form Completion",icon:pe,description:"Fill in table cells"},map_labeling:{label:"Map/Plan Labeling",icon:he,description:"Label locations on a map"},multiple_choice_matching:{label:"Multiple Choice Matching",icon:de,description:"Match letters A-H to items"},sentence_completion:{label:"Sentence Completion",icon:U,description:"Complete sentences"},flowchart_completion:{label:"Flowchart Completion",icon:ue,description:"Fill in flowchart boxes"},plan_labeling:{label:"Plan/Diagram Labeling",icon:me,description:"Label a plan or diagram"},multiple_choice:{label:"Multiple Choice",icon:de,description:"Choose correct answer"},fill_blank:{label:"Fill in the Blank",icon:U,description:"Generic fill-in-blank"}},ve={questionCount:5,questionType:"note_completion",instruction:"Write NO MORE THAN TWO WORDS OR A NUMBER for each answer."},we=()=>{const s=y(),{testType:j,testId:_}=C(),{admin:V,loading:W}=k(),H=j||"ielts",G=`/admin/${H}/listening`,{listContent:J,createContent:X,uploadAudio:Y,uploadFile:Z}=q(),[K,ee]=t.useState({title:"",instructions:"",audioFile:null,existingAudioUrl:null,csvFile:null,transcriptText:"",answerImageFile:null,referenceImageUrl:null,saved:!1}),[se,te]=t.useState(!1),[ae,re]=t.useState(!1),[ne,de]=t.useState(!1),[me,ue]=t.useState(!1),[he,pe]=t.useState({}),[ge,we]=t.useState(!1),[_e,ye]=t.useState(!1),[Ce,ke]=t.useState([]),[qe,Te]=t.useState(!1),[Ae,Fe]=t.useState(""),Ie=t.useMemo(()=>{const e=new Map;return Ae.split("\n").forEach(s=>{const t=s.trim();if(!t)return;const a=t.match(/^(\d+)[\.\)]?\s+(.*)$/);a&&e.set(parseInt(a[1]),a[2].trim())}),e},[Ae]),[Se,Ue]=t.useState(1),[Ee,Pe]=t.useState(8),[Oe,Me]=t.useState(()=>{const e={};for(let s=1;s<=8;s++)e[s]={...ve,questionCount:5};return e}),Le=Object.fromEntries(Object.entries(Oe).map(([e,s])=>[e,s.questionCount])),[$e,Re]=t.useState(null),[ze,De]=t.useState(null),Qe=()=>Array.from({length:Ee},(e,s)=>Le[s+1]||5),Be=e=>{const s=Qe();let t=0;for(let a=0;a<s.length;a++)if(t+=s[a],e<t)return a+1;return Ee},Ve=e=>{const s=Qe();let t=0;for(let a=0;a<s.length;a++){const r=t+s[a];if(e<r)return e-t+1;t=r}return e-s.slice(0,s.length-1).reduce((e,s)=>e+s,0)+1},We=()=>{if(Ee>=20)return void c.error("Maximum 20 parts allowed");const e=Ee+1;Pe(e),Me(s=>({...s,[e]:{...ve}})),c.success(`Part ${e} added`)},He=()=>{if(Ee<=1)return void c.error("Minimum 1 part required");const e=Ce.filter(e=>(e.part_number||Be(Ce.indexOf(e)))===Ee);if(e.length>0&&!confirm(`Part ${Ee} has ${e.length} question(s). Remove anyway?`))return;const s={...Oe};delete s[Ee],Me(s),Pe(Ee-1),Se>Ee-1&&Ue(Ee-1),c.success(`Part ${Ee} removed`)},Ge=(e,s)=>{Me(t=>({...t,[e]:{...t[e]||ve,...s}}))},Je=(()=>{let e=0,s=1;return Ce.map((t,a)=>{if(!0===t.is_info_row||0===t.question_number){const e=t.part_number||s;return{...t,globalNumber:0,part:e,questionInPart:0,originalIndex:a,is_info_row:!0}}{const r=t.part_number||Be(e);s=r;const n=t.question_number_in_part||Ve(e),i=t.question_number||(e=>Qe().slice(0,e-1).reduce((e,s)=>e+s,0)+1)(r)+n-1;return e++,{...t,globalNumber:i,part:r,questionInPart:n,originalIndex:a}}})})().reduce((e,s)=>(e[s.part]=e[s.part]?[...e[s.part],s]:[s],e),{});t.useEffect(()=>{W||V||s("/admin/login")},[V,W,s]),t.useEffect(()=>{Xe()},[j,_]);const Xe=async()=>{const s=j||"IELTS";if(console.log("ðŸ”„ loadExistingData called with testType:",s,"testId:",_),_)try{const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DLB9cOux.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await s.from("tests").select("*").eq("id",_).maybeSingle();if(!t)return void console.log("âš ï¸ No existing test found for testId:",_);console.log("ðŸ“‹ Found existing test:",t.test_name);const{data:a}=await s.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});console.log("ðŸ“Š Found",(null==a?void 0:a.length)||0,"questions for this test");const r=t.audio_url||(a&&a.length>0?a[0].audio_url:null),n=t.reference_image_url||null;if(a&&a.length>0){const e=a[0],s=a.map((e,s)=>{const t=e.part_number||Be(s),a=e.question_number_in_part||Ve(s);return{question_number:e.question_number_in_part||s+1,question_text:e.question_text,question_type:e.question_type||"fill_blank",options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:void 0,correct_answer:e.correct_answer,explanation:e.explanation,section_header:e.section_header||void 0,section_label:e.section_label||void 0,part_number:t,question_number_in_part:a}});ke(s);const i=JSON.stringify(s),l=new File([i],"existing-questions.json",{type:"application/json"});ee({title:t.test_name,instructions:e.passage_text||"",audioFile:null,existingAudioUrl:r||null,csvFile:l,transcriptText:e.transcription||"",answerImageFile:null,referenceImageUrl:n,saved:!0}),r&&c.success(`Existing audio loaded: ${r.split("/").pop()}`)}else ee(e=>({...e,title:t.test_name,existingAudioUrl:r||null,referenceImageUrl:n,saved:!0})),r&&c.success(`Existing audio loaded: ${r.split("/").pop()}`)}catch(t){console.error("Error loading existing data:",t),c.error("Failed to load existing data")}else console.log("âš ï¸ Skipping loadExistingData - missing testId")},Ye=(e,s)=>{ee(t=>({...t,[e]:s,saved:!1}))},Ze=async()=>{if(K.existingAudioUrl)try{const e=c.loading("Loading audio for editing..."),s=await fetch(K.existingAudioUrl),t=await s.blob(),a=K.existingAudioUrl.split("/").pop()||"existing-audio.mp3",r=new File([t],a,{type:t.type});ee(e=>({...e,audioFile:r})),we(!0),c.dismiss(e),c.success("Audio loaded for editing")}catch(e){console.error("Error loading audio:",e),c.dismiss(),c.error("Failed to load audio for editing")}},Ke=e=>{const s=e.question_number||e.globalNumber||e.questionInPart,t=e.question_type||"fill_blank";return"multiple_choice_matching"===t||e.options&&e.options.length>0&&"multiple_choice"!==t?a.jsx("tr",{className:"border-b border-gray-100",children:a.jsx("td",{colSpan:2,className:"py-3",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),a.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text}),a.jsx("span",{className:"flex-1 border-b-2 border-dotted border-red-500 min-w-[60px]"})]})})},`q-${s}`):"multiple_choice"===t?a.jsx("tr",{className:"border-b border-gray-100",children:a.jsxs("td",{colSpan:2,className:"py-3",children:[a.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),a.jsx("span",{className:"text-[#1a1a1a] font-medium text-lg",children:e.question_text})]}),a.jsx("div",{className:"pl-8 space-y-1",children:(e.options||[]).map((e,s)=>a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsxs("span",{className:"text-blue-600 font-semibold",children:["(",String.fromCharCode(65+s),")"]}),a.jsx("span",{className:"text-blue-600",children:e})]},s))})]})},`q-${s}`):"table_completion"===t?a.jsx(d.Fragment,{children:a.jsxs("tr",{className:"border-b border-gray-100/50",children:[a.jsxs("td",{className:"py-3 pr-8 text-[#1a1a1a] font-medium text-lg align-top whitespace-pre-wrap",children:[e.label,e.is_info_row&&e.table_headers&&a.jsx("div",{className:"text-[10px] text-stone-400 uppercase font-bold mb-1",children:e.table_headers[0]})]}),a.jsx("td",{className:"py-3 align-top",children:e.is_info_row?a.jsxs("div",{children:[e.value||e.question_text,e.is_info_row&&e.table_headers&&e.table_headers[1]&&a.jsx("div",{className:"text-[10px] text-stone-400 uppercase font-bold mb-1",children:e.table_headers[1]})]}):a.jsxs("span",{className:"inline-flex flex-col items-start",children:[e.value&&a.jsx("span",{className:"text-[#1a1a1a] font-semibold text-lg mr-2 mb-1",children:e.value}),a.jsxs("div",{className:"flex items-baseline",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg mr-1",children:["(",s,")"]}),a.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-400 bg-stone-50/50"})]})]})})]},`q-${s}`)},`frag-${s}`):"map_labeling"===t||"plan_labeling"===t?a.jsx("tr",{className:"border-b border-gray-100",children:a.jsx("td",{colSpan:2,className:"py-3",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),a.jsx("span",{className:"inline-block w-[150px] border-b-2 border-dotted border-red-500"}),e.question_text&&a.jsx("span",{className:"text-[#1a1a1a] text-lg",children:e.question_text})]})})},`q-${s}`):a.jsxs("tr",{className:"border-b border-gray-100",children:[a.jsx("td",{className:"py-3 pr-8 text-[#1a1a1a] font-semibold text-lg whitespace-nowrap",children:e.label||`Question ${s}`}),a.jsx("td",{className:"py-3",children:a.jsxs("span",{className:"inline-flex items-baseline",children:[e.value&&a.jsx("span",{className:"text-[#1a1a1a] font-semibold text-lg mr-2",children:e.value}),a.jsxs("span",{className:"text-red-600 font-bold text-lg",children:["(",s,")"]}),a.jsx("span",{className:"inline-block w-[180px] border-b-2 border-dotted border-red-400 ml-2"})]})})]},`q-${s}`)};return W?a.jsx("div",{className:"min-h-screen bg-[#fdfaf3] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600 mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-[#5a4a3f]",children:"Loading Listening Management..."})]})}):V?a.jsxs(z,{title:`${H.toUpperCase()} Test ${_} - Listening Management`,showBackButton:!0,backPath:G,onBackClick:()=>s(G),children:[a.jsxs("div",{className:"space-y-6 bg-[#fdfaf3] min-h-screen p-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-[#2f241f]",children:[H.toUpperCase()," Test ",_," - Listening Management"]}),a.jsx("p",{className:"text-sm text-[#5a4a3f] mt-1",children:"Note theme: warm paper, per-part review with student preview"})]}),a.jsxs(v,{variant:"secondary",className:"text-sm bg-amber-100 text-amber-900 border-amber-200",children:["Test ",_]})]}),a.jsxs(r,{className:"border border-[#e0d6c7] bg-[#fdfaf3] shadow-sm",children:[a.jsx(n,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(i,{className:"flex items-center gap-2 text-[#2f241f]",children:[K.saved?a.jsx(T,{className:"w-5 h-5 text-green-600"}):a.jsx(A,{className:"w-5 h-5 text-[#a89a8c]"}),"Listening Test - ",Ee," Part",Ee>1?"s":""," (",Qe().reduce((e,s)=>e+s,0)," Questions)"]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(o,{variant:"outline",size:"sm",onClick:He,disabled:Ee<=1,className:"h-8 w-8 p-0 border-amber-200",children:a.jsx(F,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium text-[#2f241f] min-w-[60px] text-center",children:[Ee," Parts"]}),a.jsx(o,{variant:"outline",size:"sm",onClick:We,disabled:Ee>=20,className:"h-8 w-8 p-0 border-amber-200",children:a.jsx(I,{className:"w-4 h-4"})})]}),a.jsx(v,{variant:K.saved?"default":"outline",className:K.saved?"bg-green-100 text-green-800 border-green-200":"border-[#e0d6c7]",children:K.saved?"Saved":"Not Saved"})]})]})}),a.jsxs(l,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Test Name *"}),a.jsx(w,{placeholder:`IELTS Listening Test ${_}`,value:K.title,onChange:e=>Ye("title",e.target.value),className:"max-w-md bg-white border-[#e0d6c7] focus:border-amber-400 focus:ring-amber-200 text-[#2f241f]"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Audio File (All Parts) *"}),a.jsxs("div",{className:"border-2 border-dashed border-[#e0d6c7] bg-white rounded-lg p-6 hover:bg-amber-50/50 transition-colors",children:[a.jsx("div",{className:"flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(S,{className:"w-12 h-12 mx-auto mb-3 text-amber-600"}),a.jsx("p",{className:"text-sm text-[#5a4a3f] mb-3",children:"Upload MP3 or WAV (30-40 minutes)"}),a.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{ee(s=>({...s,audioFile:e})),ee(e=>({...e,audioTrimStart:void 0,audioTrimEnd:void 0})),we(!0),c.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),a.jsxs(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},className:"bg-amber-50 border-amber-200 text-amber-900 hover:bg-amber-100",children:[a.jsx(ie,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:Ze,disabled:!K.existingAudioUrl,className:"text-amber-600 border-amber-200 hover:bg-amber-50",children:[a.jsx(be,{className:"w-4 h-4 mr-2"}),"Trim Audio"]}),a.jsx(o,{variant:"outline",size:"sm",onClick:async()=>{if(!K.audioFile&&!K.existingAudioUrl)return void c.error("Please upload audio first");ue(!0);const s=c.loading("AI Transcribing audio (Gemini Flash)...");try{let t=K.existingAudioUrl;if(!t&&K.audioFile){c.loading("Uploading audio for transcription...",{id:s});const e=await Y(K.audioFile);t=e.url,ee(e=>({...e,existingAudioUrl:t}))}const{supabase:a}=await e(async()=>{const{supabase:e}=await import("./supabase-DLB9cOux.js").then(e=>e.b);return{supabase:e}},[]);console.log("Calling transcribe-audio-gemini with:",t);const{data:r,error:n}=await a.functions.invoke("transcribe-audio-gemini",{body:{audioUrl:t}});if(n)throw n;if(!r.transcript)throw new Error("No transcript data returned");const i=r.transcript,l=i.map(e=>e.text).join(" ");ee(e=>({...e,transcriptJson:i,transcriptText:l})),c.success("Transcription complete!")}catch(t){console.error("Transcription error:",t),c.error("Transcription failed: "+t.message)}finally{ue(!1),c.dismiss(s)}},disabled:me||!K.audioFile&&!K.existingAudioUrl,className:"text-purple-600 border-purple-200 hover:bg-purple-50",children:me?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Transcribing..."]}):a.jsxs(a.Fragment,{children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"AI Transcribe"]})})]})}),K.audioFile&&a.jsxs("div",{className:"mt-4 p-3 bg-green-50 rounded-lg border border-green-200",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsxs("p",{className:"text-sm font-medium text-green-800",children:["âœ“ Audio file ready: ",K.audioFile.name]}),a.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Size: ",(K.audioFile.size/1024/1024).toFixed(2)," MB"]})]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>we(!0),className:"border-green-200 text-green-800",children:[a.jsx(be,{className:"w-3 h-3 mr-2"}),"Trim"]})]}),a.jsx("audio",{controls:!0,src:URL.createObjectURL(K.audioFile),className:"w-full mt-3 h-8"})]}),!K.audioFile&&K.existingAudioUrl&&a.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"text-sm font-medium text-blue-800",children:"âœ“ Audio file already uploaded"}),a.jsx("audio",{controls:!0,className:"mt-2 w-full max-w-md",children:a.jsx("source",{src:K.existingAudioUrl,type:"audio/mpeg"})})]}),a.jsxs("div",{className:"flex gap-2 ml-4",children:[a.jsxs(o,{variant:"outline",size:"sm",onClick:Ze,className:"border-blue-200 text-blue-800",children:[a.jsx(be,{className:"w-3 h-3 mr-2"}),"Trim"]}),a.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{confirm("Are you sure you want to delete this audio?")&&(ee(e=>({...e,existingAudioUrl:null,audioFile:null})),c.success("Audio deleted"))},className:"border-red-200 text-red-600",children:[a.jsx(le,{className:"w-3 h-3 mr-2"}),"Delete"]})]})]})})]})]}),ge&&K.audioFile&&a.jsx(fe,{audioFile:K.audioFile,onTrimComplete:(e,s,t)=>{Ye("audioFile",e),Ye("audioTrimStart",s),Ye("audioTrimEnd",t),we(!1),c.success(`Trim applied: ${s.toFixed(1)}s to ${t.toFixed(1)}s`)}}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Reference Image (Optional)"}),a.jsx("p",{className:"text-xs text-[#5a4a3f]",children:"Upload the original test image for reference in student preview"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(async e=>{if(e.type.startsWith("image/")){ye(!0);try{const s=await Y(e);ee(e=>({...e,referenceImageUrl:s.url})),c.success("Reference image uploaded")}catch(s){c.error("Failed to upload reference image: "+s.message)}finally{ye(!1)}}else c.error("Please upload an image file")})(t)},className:"hidden",id:"reference-image-upload"}),a.jsx(o,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("reference-image-upload"))?void 0:e.click()},disabled:_e,className:"bg-white border-[#e0d6c7] text-[#2f241f] hover:bg-amber-50",children:_e?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-600 mr-2"}),"Uploading..."]}):a.jsxs(a.Fragment,{children:[a.jsx(oe,{className:"w-4 h-4 mr-2"}),"Upload Reference Image"]})}),K.referenceImageUrl&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(T,{className:"w-4 h-4 text-green-600"}),a.jsx("span",{className:"text-sm text-green-700",children:"Reference image uploaded"}),a.jsx(o,{variant:"ghost",size:"sm",onClick:()=>Ye("referenceImageUrl",null),className:"text-red-500 h-6",children:a.jsx(f,{className:"w-3 h-3"})})]})]}),K.referenceImageUrl&&a.jsx("img",{src:K.referenceImageUrl,alt:"Reference",className:"max-w-md rounded-lg border border-[#e0d6c7] mt-2"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Transcript Text (Optional)"}),a.jsx(g,{placeholder:"Paste the full transcript text here...",value:K.transcriptText,onChange:e=>Ye("transcriptText",e.target.value),rows:6,className:"font-mono text-sm bg-white border-[#e0d6c7] text-[#2f241f]"}),K.transcriptText&&a.jsx("div",{className:"p-3 bg-amber-50 rounded-lg border border-amber-200",children:a.jsxs("p",{className:"text-xs text-amber-900 flex items-center gap-2",children:[a.jsx(x,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save."]})})]}),a.jsxs("div",{className:"space-y-4 border-t border-[#e0d6c7] pt-6",children:[a.jsx("div",{className:"flex items-center justify-between mb-4",children:a.jsx("h3",{className:"text-lg font-semibold text-[#2f241f]",children:"Add Content"})}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[a.jsxs(r,{className:"bg-white border-[#e0d6c7] shadow-sm",children:[a.jsx(n,{children:a.jsxs(i,{className:"text-base text-[#2f241f] flex gap-2",children:[a.jsx(U,{className:"w-5 h-5 text-indigo-600"}),"Paste Text / PDF"]})}),a.jsxs(l,{children:[a.jsx("p",{className:"text-sm text-[#5a4a3f] mb-4",children:"Paste text directly from IELTS PDFs. Auto-detects tables, multiple choice, and note completion formats."}),a.jsx(je,{onImport:e=>{const s=e.map((e,s)=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer||"",explanation:"",part_number:e.part_number,question_number_in_part:0,is_info_row:e.is_info_row,label:e.label,value:e.value,section_header:e.section_header,table_headers:e.table_headers}));ke(s);const t=Math.max(...e.map(e=>e.part_number||1),Ee);t>Ee&&(Pe(t),Me(e=>{const s={...e};for(let a=Ee+1;a<=t;a++)s[a]={...ve};return s}));const a={},r={},n={};e.forEach(e=>{const s=e.part_number||1;e.question_number>0&&(a[s]=(a[s]||0)+1),e.section_header&&!r[s]&&(r[s]=e.section_header),e.question_type&&!n[s]&&(n[s]=e.question_type)}),Me(e=>{const s={...e};for(let i=1;i<=t;i++)s[i]||(s[i]={...ve}),void 0!==a[i]&&(s[i].questionCount=a[i]),r[i]&&(s[i].instruction=r[i]),n[i]&&(s[i].questionType=n[i]);return s}),c.success(`Imported ${e.length} questions from text`)},onUploadImage:Z})]})]}),a.jsxs(r,{className:"bg-white border-[#e0d6c7] shadow-sm",children:[a.jsx(n,{children:a.jsxs(i,{className:"text-base text-[#2f241f] flex gap-2",children:[a.jsx(oe,{className:"w-5 h-5 text-amber-600"}),"Extract from Image"]})}),a.jsx(l,{children:a.jsxs("div",{className:"space-y-4",children:[a.jsx("p",{className:"text-sm text-[#5a4a3f]",children:"Upload a screenshot of the test. AI will identify questions and layout."}),a.jsx(Q,{testId:_||"",testType:H,initialImageFile:K.answerImageFile,onImageSelected:e=>Ye("answerImageFile",e),onQuestionsExtracted:e=>{console.log("âœ¨ AI extracted questions:",e),ke(e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});Ye("csvFile",t),c.success(`Ready to save ${e.length} items!`)}})]})})]})]})]}),a.jsxs("div",{className:"border-t border-[#e0d6c7] pt-6",children:[a.jsxs("h3",{className:"text-lg font-semibold text-[#2f241f] flex items-center gap-2 mb-4",children:[a.jsx(p,{className:"w-5 h-5"}),"Preview Comparison"]}),a.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:a.jsxs("div",{className:"space-y-3",children:[a.jsxs("h4",{className:"text-sm font-semibold text-[#5a4a3f] flex items-center gap-2",children:[a.jsx(oe,{className:"w-4 h-4"}),"Uploaded Image (Original)"]}),a.jsx(r,{className:"bg-white border-2 border-[#e0d6c7] overflow-hidden",children:K.answerImageFile?a.jsx("div",{className:"p-4",children:a.jsx("img",{src:URL.createObjectURL(K.answerImageFile),alt:"Uploaded Question Image",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):K.referenceImageUrl?a.jsx("div",{className:"p-4",children:a.jsx("img",{src:K.referenceImageUrl,alt:"Reference",className:"w-full h-auto rounded-lg border border-gray-200",style:{maxHeight:"600px",objectFit:"contain"}})}):a.jsxs("div",{className:"p-8 text-center text-[#5a4a3f]",children:[a.jsx(oe,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm",children:"No image uploaded yet"}),a.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Upload an image above to see it here"})]})})]})})]}),a.jsxs("div",{className:"space-y-8 border-t border-[#e0d6c7] pt-8",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("h3",{className:"text-xl font-bold text-[#2f241f] flex items-center gap-2",children:[a.jsx(p,{className:"w-6 h-6 text-amber-600"}),"Test Preview & Editor"]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(o,{onClick:We,variant:"outline",size:"sm",className:"border-amber-200 text-amber-900 hover:bg-amber-50",children:[a.jsx(I,{className:"w-4 h-4 mr-1"})," Add Part"]}),a.jsxs(o,{onClick:He,variant:"outline",size:"sm",className:"border-red-200 text-red-700 hover:bg-red-50",children:[a.jsx(F,{className:"w-4 h-4 mr-1"})," Remove Part"]})]})]}),Array.from({length:Ee},(e,s)=>s+1).map(e=>{var s,t,n,i;const c=Je[e]||[],m=Oe[e]||ve,x=(null==(s=Ne[m.questionType])?void 0:s.icon)||U,u=[...c].sort((e,s)=>(e.originalIndex||0)-(s.originalIndex||0));return a.jsxs(r,{className:"bg-white border text-left border-[#e0d6c7] shadow-sm overflow-hidden",children:[a.jsxs("div",{className:"bg-amber-100/50 px-6 py-4 border-b border-[#e0d6c7] flex flex-col md:flex-row md:items-center gap-4 justify-between",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsxs("h4",{className:"text-lg font-bold text-[#2f241f]",children:["Part ",e]}),a.jsxs(v,{variant:"outline",className:"bg-white border-amber-200 text-amber-800",children:[c.length," Questions"]})]}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-[#5a4a3f]",children:[a.jsx(x,{className:"w-3 h-3"}),null==(t=Ne[m.questionType])?void 0:t.label]})]}),a.jsxs("div",{className:"flex-1 flex flex-col md:flex-row gap-4 items-start md:items-center justify-end",children:[a.jsxs("div",{className:"w-full md:w-auto",children:[a.jsx("label",{className:"text-[10px] uppercase font-bold text-amber-700/60 block mb-1",children:"Type"}),a.jsxs(E,{value:(null==(n=Oe[e])?void 0:n.questionType)||"note_completion",onValueChange:s=>Ge(e,{questionType:s}),children:[a.jsx(P,{className:"h-8 text-xs w-[160px] bg-white border-amber-200",children:a.jsx(O,{})}),a.jsx(M,{children:Object.entries(Ne).map(([e,s])=>a.jsx(L,{value:e,className:"text-xs",children:s.label},e))})]})]}),a.jsxs("div",{className:"w-full md:w-[400px]",children:[a.jsx("label",{className:"text-[10px] uppercase font-bold text-amber-700/60 block mb-1",children:"Instruction"}),a.jsx(w,{value:(null==(i=Oe[e])?void 0:i.instruction)||"",onChange:s=>Ge(e,{instruction:s.target.value}),className:"h-8 text-sm bg-white border-amber-200",placeholder:"e.g. Write NO MORE THAN TWO WORDS..."})]})]})]}),a.jsx(l,{className:"p-0",children:0===u.length?a.jsx("div",{className:"p-8 text-center text-stone-400",children:a.jsxs("p",{className:"text-sm italic",children:["No questions imported for Part ",e]})}):a.jsx("div",{className:"p-6 overflow-x-auto",children:a.jsx("table",{className:"w-full max-w-4xl",children:a.jsx("tbody",{children:u.map(e=>a.jsx(d.Fragment,{children:a.jsx("tr",{className:"group",children:a.jsx("td",{colSpan:2,className:"p-0",children:a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity z-10",children:a.jsx(o,{variant:"ghost",size:"icon",className:"h-6 w-6 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-bl-lg",onClick:()=>((e,s)=>{Re({...e}),De(s)})(e,e.originalIndex),children:a.jsx(D,{className:"w-3 h-3"})})}),a.jsx("table",{className:"w-full",children:a.jsx("tbody",{children:Ke(e)})})]})})})},e.originalIndex))})})})})]},e)}),a.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4 mt-8 pt-6 border-t border-[#e0d6c7]",children:[a.jsxs("div",{className:"text-sm text-amber-800 bg-amber-50 px-4 py-2 rounded-lg border border-amber-100",children:[a.jsx("span",{className:"font-bold mr-2",children:"Status:"}),K.saved?a.jsxs("span",{className:"text-green-600 flex items-center inline-flex gap-1",children:[a.jsx(T,{className:"w-4 h-4"})," Saved"]}):a.jsx("span",{className:"text-amber-600",children:"Unsaved changes"})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsxs(o,{variant:"outline",onClick:()=>Te(!0),className:"border-amber-200 text-amber-900 hover:bg-amber-50",children:[a.jsx(xe,{className:"w-4 h-4 mr-2"})," Import Answers"]}),a.jsx(o,{variant:"outline",onClick:async()=>{if(0!==Ce.length)if(K.transcriptText){de(!0);try{console.log("ðŸ¤– Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DLB9cOux.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await s.functions.invoke("generate-listening-explanations",{body:{questions:Ce,transcriptText:K.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const r=Ce.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});ke(r);const n=JSON.stringify(r),i=new File([n],"questions-with-explanations.json",{type:"application/json"});Ye("csvFile",i),c.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(s){console.error("Error generating explanations:",s),c.error(`Failed to generate explanations: ${s.message}`)}finally{de(!1)}}else c.error("Please provide a transcript first");else c.error("Please upload questions first")},disabled:ne||!K.transcriptText,className:"border-amber-200 text-amber-900 hover:bg-amber-50",children:ne?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-amber-500 mr-2"}),"Generating..."]}):a.jsxs(a.Fragment,{children:[a.jsx(x,{className:"w-4 h-4 mr-2"}),"Generate Explanations"]})}),a.jsx(o,{onClick:()=>(async()=>{const s=K.audioFile;if(s||K.existingAudioUrl||0!==Ce.length){te(!0);try{let a=K.existingAudioUrl;if(console.log("ðŸ’¾ Starting save with existingAudioUrl:",a),s){console.log("ðŸ“¤ Uploading audio to Cloudflare R2...");const e=await Y(s);a=e.url,console.log("âœ… Audio uploaded successfully:",a)}let r=null;if(K.transcriptText.trim()&&a){re(!0);try{console.log("ðŸŽ™ï¸ Generating timestamps for transcript...");const{supabase:s}=await e(async()=>{const{supabase:e}=await import("./supabase-DLB9cOux.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:n}=await s.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:a,transcript:K.transcriptText}});if(n)throw n;if(!t.success)throw new Error(t.error||"Failed to generate timestamps");r=t.timestamps,console.log("âœ… Timestamps generated successfully"),c.success("Transcript timestamps generated!")}catch(t){console.error("Error generating timestamps:",t),c.error("Failed to generate timestamps, but saving test anyway.")}finally{re(!1)}}let n=null;K.answerImageFile&&(console.log("ðŸ“¤ Uploading answer image..."),n=(await Y(K.answerImageFile)).url,console.log("âœ… Answer image uploaded:",n));const i=Ce.length>0?Ce:[],{supabase:l}=await e(async()=>{const{supabase:e}=await import("./supabase-DLB9cOux.js").then(e=>e.b);return{supabase:e}},[]),o={testId:_,testData:{title:K.title||`IELTS Listening Test ${_}`,instructions:K.instructions,audioUrl:a,transcriptText:K.transcriptText,transcriptJson:K.transcriptJson,answerImageUrl:n,referenceImageUrl:K.referenceImageUrl,totalParts:Ee,partConfigs:Oe,partQuestionCounts:Le},questions:i.map((e,s)=>{const t=e.part_number||Be(s),a=e.question_number_in_part||Ve(s),r=1===a,n=Oe[t]||ve;return{...e,part_number:t,question_number_in_part:a,question_type:e.question_type||n.questionType,explanation:he[s]||e.explanation||"",passage_text:r?n.instruction:null,section_instruction:r?n.instruction:null}})};console.log("ðŸ’¾ Saving test via Edge Function with audioUrl:",a);const{data:d,error:m}=await l.functions.invoke("save-listening-test",{body:o});if(m)throw console.error("Edge Function error:",m),new Error(`Edge Function failed: ${m.message||JSON.stringify(m)}`);if(!d||!d.success){const e=(null==d?void 0:d.error)||"Failed to save test";throw console.error("Edge Function returned error:",e),new Error(e)}console.log("âœ… Test saved successfully!"),c.success("Test saved successfully!"),ee(e=>({...e,saved:!0,existingAudioUrl:a||e.existingAudioUrl,audioFile:null})),te(!1)}catch(a){console.error("Error saving test:",a),c.error(`Failed to save test: ${a.message}`),te(!1)}}else c.error("Please upload either an audio file or add questions first")})(),disabled:se,className:"bg-green-600 hover:bg-green-700 text-white min-w-[200px]",size:"lg",children:se?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx(ce,{className:"w-4 h-4 mr-2"}),"Save Test"]})})]})]})]})]})]})]}),a.jsx(m,{open:null!==$e,onOpenChange:e=>!e&&Re(null),children:a.jsxs(u,{className:"max-w-md bg-[#fdfaf3] border-[#e0d6c7]",children:[a.jsx(N,{children:a.jsxs(h,{className:"text-[#2f241f]",children:["Edit Question ",null==$e?void 0:$e.question_number]})}),$e&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Question Text"}),a.jsx(g,{value:$e.question_text||"",onChange:e=>Re({...$e,question_text:e.target.value}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter question text. Use newlines for extra context/rows (e.g. 'Make Allegro')."}),a.jsx("p",{className:"text-xs text-[#5a4a3f] mt-1",children:"Tip: Use newlines to add informational rows before the question."})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Correct Answer"}),a.jsx(w,{value:$e.correct_answer||"",onChange:e=>Re({...$e,correct_answer:e.target.value}),className:"mt-1 bg-white border-[#e0d6c7]",placeholder:"Enter correct answer..."})]}),$e.options&&$e.options.length>0&&a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Options (one per line)"}),a.jsx(g,{value:($e.options||[]).join("\n"),onChange:e=>Re({...$e,options:e.target.value.split("\n").filter(e=>e.trim())}),rows:3,className:"mt-1 bg-white border-[#e0d6c7]"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium text-[#2f241f]",children:"Section Label (Optional)"}),a.jsx(w,{value:$e.section_label||"",onChange:e=>Re({...$e,section_label:e.target.value}),placeholder:"e.g., The Gherkin Building",className:"mt-1 bg-white border-[#e0d6c7]"})]})]}),a.jsxs($,{children:[a.jsx(o,{variant:"outline",onClick:()=>Re(null),className:"border-[#e0d6c7]",children:"Cancel"}),a.jsxs(o,{onClick:()=>{if(null!==ze&&$e){const e=[...Ce];e[ze]={...e[ze],question_text:$e.question_text,question_type:$e.question_type,correct_answer:$e.correct_answer,options:$e.options,section_header:$e.section_header,section_label:$e.section_label,section_instruction:$e.section_instruction,explanation:$e.explanation},ke(e),Re(null),De(null),c.success("Question updated")}},className:"bg-amber-600 hover:bg-amber-700 text-white",children:[a.jsx(ce,{className:"w-4 h-4 mr-2"}),"Save"]})]})]})}),a.jsx(m,{open:qe,onOpenChange:Te,children:a.jsxs(u,{className:"max-w-4xl bg-[#fdfaf3] border-[#e0d6c7] h-[80vh] flex flex-col",children:[a.jsxs(N,{children:[a.jsx(h,{className:"text-[#2f241f]",children:"Import Answers (Bulk)"}),a.jsx(b,{children:"Paste your list on the left. Verify detected answers on the right."})]}),a.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0 py-4",children:[a.jsxs("div",{className:"flex flex-col gap-2 h-full",children:[a.jsx(R,{className:"text-stone-700 font-bold",children:"Paste Text"}),a.jsx(g,{value:Ae,onChange:e=>Fe(e.target.value),placeholder:"1. Saturday 25\n2. 55\n3. knives/ forks\n...",className:"flex-1 font-mono text-base bg-white border-[#e0d6c7] text-stone-900 resize-none focus-visible:ring-amber-500 p-4"})]}),a.jsxs("div",{className:"flex flex-col gap-2 h-full min-h-0",children:[a.jsx("div",{className:"flex justify-between items-center",children:a.jsxs(R,{className:"text-stone-700 font-bold",children:["Preview (",Ie.size," detected)"]})}),a.jsx("div",{className:"flex-1 border border-[#e0d6c7] rounded-md bg-white overflow-hidden flex flex-col",children:a.jsx(B,{className:"flex-1 p-3",children:a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[Array.from(Ie.entries()).sort((e,s)=>e[0]-s[0]).map(([e,s])=>a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded bg-amber-50 border border-amber-100",children:[a.jsx(v,{className:"bg-amber-500 hover:bg-amber-600 text-white w-6 h-6 flex items-center justify-center p-0 text-xs shrink-0",children:e}),a.jsx("span",{className:"text-sm font-medium text-stone-900 truncate",title:s,children:s})]},e)),0===Ie.size&&a.jsx("div",{className:"col-span-2 text-center text-stone-400 italic py-10",children:"No answers detected yet..."})]})})})]})]}),a.jsxs($,{children:[a.jsx(o,{variant:"outline",onClick:()=>Te(!1),className:"border-[#e0d6c7]",children:"Cancel"}),a.jsxs(o,{onClick:()=>{if(0===Ie.size)return void c.error("No valid answers found. Check format.");let e=0;const s=Ce.map(s=>{const t=Number(s.question_number);return Ie.has(t)?(e++,{...s,correct_answer:Ie.get(t)}):s});ke(s),Te(!1),Fe(""),e>0?c.success(`Applied answers to ${e} questions.`):c.warning("No questions matched the provided numbers.")},className:"bg-amber-600 hover:bg-amber-700 text-white",children:["Apply ",Ie.size," Answers"]})]})]})})]}):null};export{we as default};
