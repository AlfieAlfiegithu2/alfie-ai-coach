import{u as e,ak as s,v as t,f as i,r as a,J as n,j as r,k as l,C as o,b as d,h as c,c as m,b6 as u,b3 as p,a as x,I as h,T as b,H as g,B as v}from"./index-BIX8qkRl.js";import{C as j,a as f,b as N}from"./collapsible-B16uInj9.js";import{A as y}from"./AdminLayout-C0x8Y5g2.js";import{C as F}from"./CSVImport-CNmbyvc1.js";import{U as w}from"./upload-GkiBFZHg.js";import{I as C}from"./image-B2g8c01y.js";import"./supabase-Bqkrifq5.js";import"./alert-DgHXTk5x.js";import"./file-text-Ce-sbh9B.js";import"./circle-alert-BNwhlbyW.js";import"./circle-help-CbwSBayn.js";import"./download-CdY8vt8s.js";const _=()=>{const _=e(),{testType:$,testId:S}=s(),{admin:k,loading:I}=t(),{listContent:q,createContent:P,uploadAudio:E}=i(),[T,U]=a.useState([{number:1,title:"",instructions:"",audioFile:null,imageFile:null,csvFile:null,saved:!1},{number:2,title:"",instructions:"",audioFile:null,imageFile:null,csvFile:null,saved:!1},{number:3,title:"",instructions:"",audioFile:null,imageFile:null,csvFile:null,saved:!1},{number:4,title:"",instructions:"",audioFile:null,imageFile:null,csvFile:null,saved:!1}]),[A,B]=a.useState(new Set([1])),[L,M]=a.useState(null);a.useEffect(()=>{I||k||_("/admin/login")},[k,I,_]),a.useEffect(()=>{V()},[$,S]);const V=async()=>{var e,s;if($&&S)try{const[t,i]=await Promise.all([q("listening_sections"),q("listening_questions")]),a=(null==(e=null==t?void 0:t.data)?void 0:e.filter(e=>e.test_number===parseInt(S)&&e.cambridge_book===`${null==$?void 0:$.toUpperCase()} Test ${S}`))||[],n=(null==(s=null==i?void 0:i.data)?void 0:s.filter(e=>e.cambridge_book===`${null==$?void 0:$.toUpperCase()} Test ${S}`))||[],r=T.map(e=>{const s=a.find(s=>s.part_number===e.number),t=n.filter(s=>s.part_number===e.number);return{...e,title:(null==s?void 0:s.title)||"",instructions:(null==s?void 0:s.instructions)||"",saved:!!(s&&t.length>0)}});U(r)}catch(t){console.error("Error loading existing data:",t),n.error("Failed to load existing data")}},O=(e,s,t)=>{U(i=>i.map(i=>i.number===e?{...i,[s]:t,saved:!1}:i))};return I?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):k?r.jsx(y,{title:`${null==$?void 0:$.toUpperCase()} Test ${S} - Listening Management`,showBackButton:!0,backPath:`/admin/${$}/listening`,children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:[null==$?void 0:$.toUpperCase()," Test ",S," - Listening Management"]}),r.jsx("p",{className:"text-muted-foreground mt-1",children:"Create a complete 4-part listening test with audio, questions and optional images"})]}),r.jsxs(l,{variant:"secondary",className:"text-sm",children:["Test ",S]})]}),r.jsx("div",{className:"space-y-4",children:T.map(e=>r.jsx(o,{className:"border border-border",children:r.jsxs(j,{open:A.has(e.number),onOpenChange:()=>(e=>{const s=new Set(A);s.has(e)?s.delete(e):s.add(e),B(s)})(e.number),children:[r.jsx(f,{asChild:!0,children:r.jsx(d,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx(c,{className:"w-5 h-5 transition-transform "+(A.has(e.number)?"":"-rotate-90")}),r.jsxs(m,{className:"flex items-center gap-2",children:[e.saved?r.jsx(u,{className:"w-5 h-5 text-green-500"}):r.jsx(p,{className:"w-5 h-5 text-muted-foreground"}),"Part ",e.number]})]}),r.jsx(l,{variant:e.saved?"default":"outline",children:e.saved?"Saved":"Not Saved"})]})})}),r.jsx(N,{children:r.jsxs(x,{className:"space-y-6",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Section Title *"}),r.jsx(h,{placeholder:`Listening Section ${e.number} Title`,value:e.title,onChange:s=>O(e.number,"title",s.target.value)})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Instructions *"}),r.jsx(b,{placeholder:"Enter the instructions for this listening section...",value:e.instructions,onChange:s=>O(e.number,"instructions",s.target.value),rows:3,className:"resize-none"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Audio File *"}),r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-4",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(g,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Upload MP3 or WAV audio file"}),r.jsx("input",{type:"file",accept:"audio/*",onChange:s=>{var t;const i=null==(t=s.target.files)?void 0:t[0];i&&((e,s)=>{O(e,"audioFile",s),n.success(`Audio file uploaded for Part ${e}`)})(e.number,i)},className:"hidden",id:`audio-${e.number}`}),r.jsxs(v,{variant:"outline",onClick:()=>{var s;return null==(s=document.getElementById(`audio-${e.number}`))?void 0:s.click()},children:[r.jsx(w,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),e.audioFile&&r.jsxs("p",{className:"text-sm text-muted-foreground mt-2 text-center",children:["Audio: ",e.audioFile.name]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Image File (Optional)"}),r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-4",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(C,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Upload image for visual questions (maps, diagrams, etc.)"}),r.jsx("input",{type:"file",accept:"image/*",onChange:s=>{var t;const i=null==(t=s.target.files)?void 0:t[0];i&&((e,s)=>{O(e,"imageFile",s),n.success(`Image uploaded for Part ${e}`)})(e.number,i)},className:"hidden",id:`image-${e.number}`}),r.jsxs(v,{variant:"outline",onClick:()=>{var s;return null==(s=document.getElementById(`image-${e.number}`))?void 0:s.click()},children:[r.jsx(w,{className:"w-4 h-4 mr-2"}),"Choose Image"]})]})}),e.imageFile&&r.jsxs("p",{className:"text-sm text-muted-foreground mt-2 text-center",children:["Image: ",e.imageFile.name]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Questions CSV File *"}),r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6",children:[r.jsx(F,{onImport:s=>((e,s)=>{console.log("CSV uploaded for part",e,"with questions:",s);const t=JSON.stringify(s),i=new File([t],`part-${e}-questions.json`,{type:"application/json"});O(e,"csvFile",i)})(e.number,s),type:"listening",module:$,cambridgeBook:`${null==$?void 0:$.toUpperCase()} Test ${S}`,testNumber:parseInt(S||"1"),sectionNumber:e.number,hideDownloadSample:!0}),e.csvFile&&r.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:["File: ",e.csvFile.name]})]})]}),r.jsx("div",{className:"flex justify-end",children:r.jsx(v,{onClick:()=>(async e=>{var s;const t=T.find(s=>s.number===e);if(t)if(t.title.trim()&&t.instructions.trim()&&t.csvFile){M(e);try{let i=null,a=null;t.audioFile&&(i=(await E(t.audioFile)).url),t.imageFile&&(a=(await E(t.imageFile)).url);const r=await t.csvFile.text();let l;try{l=JSON.parse(r)}catch{const e=r.split("\n").filter(e=>e.trim()),s=e[0].split(",").map(e=>e.trim().replace(/"/g,""));l=e.slice(1).map((e,t)=>{const i=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return s.forEach((e,s)=>{a[e]=i[s]||""}),a}).filter(e=>e.question_text&&e.correct_answer)}const o={title:t.title,instructions:t.instructions,test_number:parseInt(S||"1"),cambridge_book:`${null==$?void 0:$.toUpperCase()} Test ${S}`,part_number:e,section_number:e,audio_url:i,photo_url:a},d=await P("listening_sections",o),c=null==(s=null==d?void 0:d.data)?void 0:s.id;if(!c)throw new Error("Failed to create listening section");const m=l.map((s,t)=>({question_number:10*(e-1)+(t+1),question_text:s.question_text||"",question_type:s.question_type||"Multiple Choice",options:s.options||null,correct_answer:s.correct_answer||"",explanation:s.explanation||"",section_id:c,part_number:e}));await P("listening_questions",m),U(s=>s.map(s=>s.number===e?{...s,saved:!0}:s)),n.success(`Part ${e} saved successfully with ${l.length} questions`)}catch(i){console.error("Error saving part:",i);const s=i.message||`Failed to save Part ${e}`;n.error(`Error: ${s}. Please check your data and try again.`)}finally{M(null)}}else n.error("Please fill in title, instructions and upload a CSV file")})(e.number),disabled:L===e.number||!e.title.trim()||!e.instructions.trim()||!e.csvFile,className:"bg-primary hover:bg-primary/90",children:L===e.number?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Part ",e.number,"..."]}):`Save Part ${e.number}`})})]})})]})},e.number))})]})}):null};export{_ as default};
