import{s as e,_ as s}from"./supabase-Bqkrifq5.js";import{y as t,r as a,j as r,C as n,b as i,c as l,b6 as o,a as c,B as d,w as m,I as u,S as x,o as p,p as g,q as h,s as j,E as b,k as f,T as v,X as N,J as w,u as y,ak as k,v as _,f as T,b7 as q,b3 as C,H as I}from"./index-sXG-Kkd7.js";import{T as F,a as E,b as S,c as A}from"./tabs-1LLHL_Ne.js";import{A as P}from"./AdminLayout-BTTOf-pP.js";import{C as L}from"./CSVImport-D4oqwaEo.js";import{I as Q}from"./image-C1BNoRak.js";import{U as D}from"./upload-CIDxtx5U.js";import{F as G}from"./file-text-BjUJIBsT.js";import"./alert-BwAx82xj.js";import"./circle-alert-DIAuqS5x.js";import"./circle-help-BqzfxuGV.js";import"./download-CBT-K9gh.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=t("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),O=({testId:s,testType:t,onQuestionsExtracted:y})=>{const[k,_]=a.useState(null),[T,q]=a.useState(""),[C,I]=a.useState("1-13"),[F,E]=a.useState("Multiple Choice"),[S,A]=a.useState(!1),[P,L]=a.useState([]),[G,O]=a.useState(null),[U,$]=a.useState(null),[R,M]=a.useState(!1),B=e=>{if(!e.type.startsWith("image/"))return void w.error("Please upload an image file (JPG, PNG, WebP)");if(e.size>10485760)return void w.error("Image size should be less than 10MB");_(e);const s=new FileReader;s.onloadend=()=>{q(s.result)},s.readAsDataURL(e),w.success("Image uploaded successfully!")},V=()=>{O(null),$(null)},J=()=>{if(null!==G&&U){const e=[...P];e[G]=U,L(e),O(null),$(null),w.success("Question updated")}};return r.jsxs("div",{className:"space-y-6",children:[r.jsxs(n,{className:"border-2 border-purple-200 dark:border-purple-800",children:[r.jsxs(i,{className:"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950 dark:to-blue-950",children:[r.jsxs(l,{className:"flex items-center gap-2",children:[r.jsx(o,{className:"w-5 h-5 text-purple-600"}),"AI Question Extraction (Gemini Vision)"]}),r.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Upload an image of IELTS questions and let Gemini AI extract them automatically"})]}),r.jsxs(c,{className:"pt-6 space-y-6",children:[r.jsx("div",{className:"border-2 border-dashed rounded-lg p-8 transition-all duration-200 "+(R?"border-purple-500 bg-purple-50 dark:bg-purple-900/20 scale-[1.02]":"border-border hover:border-purple-400"),onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),M(!0)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget===e.target&&M(!1)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),M(!1);const s=e.dataTransfer.files;if(s&&s.length>0){const e=s[0];B(e)}},children:T?r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"relative max-h-96 overflow-hidden rounded-lg border",children:r.jsx("img",{src:T,alt:"Questions Preview",className:"w-full object-contain"})}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[r.jsx(m,{className:"w-4 h-4 text-green-500"}),null==k?void 0:k.name," (",(k.size/1024).toFixed(0)," KB)"]}),r.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{_(null),q(""),L([])},children:"Change Image"})]})]}):r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"transition-transform duration-200 "+(R?"scale-110":""),children:r.jsx(Q,{className:"w-16 h-16 mx-auto mb-4 "+(R?"text-purple-600":"text-purple-400")})}),r.jsx("h4",{className:"font-medium mb-2",children:R?"ðŸ“Ž Drop image here!":"Upload Question Image"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:R?"Release to upload":"Drag & drop or click to browse â€¢ JPG, PNG, WebP (max 10MB)"}),!R&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&B(t)},className:"hidden",id:"question-image-upload"}),r.jsxs(d,{onClick:()=>{var e;return null==(e=document.getElementById("question-image-upload"))?void 0:e.click()},variant:"outline",className:"border-purple-300 hover:bg-purple-50",children:[r.jsx(D,{className:"w-4 h-4 mr-2"}),"Choose Image"]}),r.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"ðŸ’¡ Tip: Clear, high-resolution images work best"})]})]})}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Question Range ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),r.jsx(u,{placeholder:"Leave empty for AI auto-detect or enter like: 1-13",value:C,onChange:e=>I(e.target.value),className:"font-mono"}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI can automatically detect the question range from your image"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Question Type ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),r.jsxs(x,{value:F,onValueChange:E,children:[r.jsx(p,{children:r.jsx(g,{placeholder:"AI will auto-detect type"})}),r.jsxs(h,{children:[r.jsx(j,{value:"auto",children:"ðŸ¤– Auto-Detect (Recommended)"}),r.jsx(j,{value:"Multiple Choice",children:"Multiple Choice"}),r.jsx(j,{value:"Fill in the blank",children:"Fill in the Blank"}),r.jsx(j,{value:"True/False/Not Given",children:"True/False/Not Given"}),r.jsx(j,{value:"Matching",children:"Matching"}),r.jsx(j,{value:"Sentence Completion",children:"Sentence Completion"}),r.jsx(j,{value:"Short Answer",children:"Short Answer"}),r.jsx(j,{value:"Summary Completion",children:"Summary Completion"})]})]}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI analyzes the image to identify question types"})]})]}),r.jsx(d,{onClick:async()=>{if(k){if(C&&C.trim()){if(!/^\d+-\d+$/.test(C.trim()))return void w.error('Invalid range format. Use format: "1-13" or leave empty for auto-detect')}A(!0);try{const a=T.split(",")[1],r=C&&C.trim()?C.trim():"",n=F&&"auto"!==F?F:"";console.log("ðŸ“¤ Sending to Gemini:",{questionRange:r||"AUTO-DETECT",questionType:n||"AUTO-DETECT",imageSize:a.length});const{data:i,error:l}=await e.functions.invoke("gemini-question-extractor",{body:{imageBase64:a,questionRange:r,questionType:n,testType:t,testId:s}});if(l)throw console.error("âŒ Extraction error:",l),l;if(!i.success)throw new Error(i.error||"Extraction failed");console.log("âœ… Extracted questions:",i),L(i.questions);const o=i.autoDetected?`\nDetected: ${i.range} (${i.questionType})`:`Range: ${i.range}`;w.success(`âœ¨ Successfully extracted ${i.count} questions!`,{description:o})}catch(a){console.error("âŒ Extraction failed:",a),w.error("Failed to extract questions",{description:a.message||"Please try again or check the image quality"})}finally{A(!1)}}else w.error("Please upload an image")},disabled:!k||S,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700",size:"lg",children:S?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Gemini AI is analyzing the image..."]}):r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"w-5 h-5 mr-2"}),"Extract Questions with AI"]})})]})]}),P.length>0&&r.jsxs(n,{children:[r.jsx(i,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs(l,{className:"flex items-center gap-2",children:[r.jsx(b,{className:"w-5 h-5"}),"Extracted Questions (",P.length,")"]}),r.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and edit if needed, then save to database"})]}),r.jsx(f,{variant:"secondary",className:"text-sm",children:C})]})}),r.jsxs(c,{children:[r.jsx("div",{className:"max-h-[600px] overflow-y-auto space-y-4",children:P.map((e,s)=>r.jsx("div",{className:"border rounded-lg overflow-hidden",children:G===s?r.jsxs("div",{className:"p-4 space-y-3 bg-muted/30",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"text-xs font-medium",children:["Question ",e.question_number]}),r.jsx(v,{value:(null==U?void 0:U.question_text)||"",onChange:e=>$(s=>s?{...s,question_text:e.target.value}:null),rows:3,className:"mt-1"})]}),(null==U?void 0:U.options)&&r.jsxs("div",{children:[r.jsx("label",{className:"text-xs font-medium",children:"Options (one per line)"}),r.jsx(v,{value:U.options.join("\n"),onChange:e=>$(s=>s?{...s,options:e.target.value.split("\n")}:null),rows:4,className:"mt-1"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-xs font-medium",children:"Correct Answer"}),r.jsx(u,{value:(null==U?void 0:U.correct_answer)||"",onChange:e=>$(s=>s?{...s,correct_answer:e.target.value}:null),className:"mt-1"})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs(d,{size:"sm",onClick:J,children:[r.jsx(m,{className:"w-4 h-4 mr-1"}),"Save"]}),r.jsxs(d,{size:"sm",variant:"outline",onClick:V,children:[r.jsx(N,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]}):r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 border-b",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(f,{variant:"outline",className:"font-mono",children:["Q",e.question_number]}),r.jsx(f,{variant:"secondary",className:"Multiple Choice"===e.question_type?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"Fill in the blank"===e.question_type?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"True/False/Not Given"===e.question_type?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:e.question_type})]}),r.jsxs("div",{className:"flex gap-1",children:[r.jsx(d,{size:"sm",variant:"ghost",onClick:()=>(e=>{O(e),$({...P[e]})})(s),children:r.jsx(z,{className:"w-3 h-3"})}),r.jsx(d,{size:"sm",variant:"ghost",onClick:()=>(e=>{const s=P.filter((s,t)=>t!==e);L(s),w.success("Question removed")})(s),className:"text-red-500 hover:text-red-700",children:r.jsx(N,{className:"w-3 h-3"})})]})]}),r.jsxs("div",{className:"p-4 bg-white dark:bg-gray-900",children:[r.jsxs("div",{className:"mb-3",children:[r.jsxs("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1",children:["Question ",e.question_number]}),r.jsx("p",{className:"text-base leading-relaxed",children:e.question_text})]}),e.options&&e.options.length>0&&r.jsx("div",{className:"space-y-2 pl-2",children:e.options.map((t,a)=>r.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors "+(t===e.correct_answer?"bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[r.jsx("input",{type:"radio",name:`question-${s}`,checked:t===e.correct_answer,readOnly:!0,className:"w-4 h-4"}),r.jsx("span",{className:t===e.correct_answer?"font-medium text-green-700 dark:text-green-300":"",children:t}),t===e.correct_answer&&r.jsx(f,{variant:"default",className:"ml-auto text-xs",children:"âœ“ Correct"})]},a))}),!e.options&&e.correct_answer&&r.jsx("div",{className:"space-y-2",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("label",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Answer:"}),r.jsx(u,{value:e.correct_answer,readOnly:!0,className:"max-w-xs bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700 font-medium"}),r.jsx(f,{variant:"default",className:"text-xs",children:"âœ“ Correct Answer"})]})}),e.explanation&&r.jsxs("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[r.jsx("p",{className:"text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1",children:"Explanation:"}),r.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-400",children:e.explanation})]})]})]})},s))}),r.jsxs("div",{className:"mt-6 flex gap-3",children:[r.jsxs(d,{onClick:()=>y(P),className:"flex-1 bg-green-600 hover:bg-green-700",size:"lg",children:[r.jsx(m,{className:"w-5 h-5 mr-2"}),"Save ",P.length," Questions to Database"]}),r.jsx(d,{variant:"outline",onClick:()=>L([]),children:"Clear All"})]})]})]})]})},U=()=>{const e=y(),{testType:t,testId:m}=k(),{admin:x,loading:p}=_(),{listContent:g,createContent:h,uploadAudio:j}=T(),[b,N]=a.useState({title:"",instructions:"",audioFile:null,csvFile:null,transcriptText:"",answerImageFile:null,saved:!1}),[z,U]=a.useState(!1),[$,R]=a.useState(!1),[M,B]=a.useState(!1),[V,J]=a.useState({}),[W,H]=a.useState([]);a.useEffect(()=>{p||x||e("/admin/login")},[x,p,e]),a.useEffect(()=>{K()},[t,m]);const K=async()=>{if(t&&m)try{const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:t}=await e.from("tests").select("*").eq("test_type","IELTS").eq("module","Listening").ilike("test_name",`%Test ${m}%`).maybeSingle();if(!t)return;const{data:a}=await e.from("questions").select("*").eq("test_id",t.id).order("question_number_in_part",{ascending:!0});if(a&&a.length>0){const e=a[0],s=a.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.choices?e.choices.includes(";")?e.choices.split(";"):[e.choices]:[],correct_answer:e.correct_answer,explanation:e.explanation}));H(s);const r=JSON.stringify(s),n=new File([r],"existing-questions.json",{type:"application/json"});N({title:t.test_name,instructions:e.passage_text||"",audioFile:null,csvFile:n,transcriptText:e.transcription||"",answerImageFile:null,saved:!0})}}catch(e){console.error("Error loading existing data:",e),w.error("Failed to load existing data")}},Y=(e,s)=>{N(t=>({...t,[e]:s,saved:!1}))},X=async()=>{if(0!==W.length)if(b.transcriptText){B(!0);try{console.log("ðŸ¤– Generating AI explanations with Gemini 3.0 Pro (via Edge Function)...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:t,error:a}=await e.functions.invoke("generate-listening-explanations",{body:{questions:W,transcriptText:b.transcriptText,transcriptJson:null}});if(a)throw a;if(!t.success)throw new Error(t.error||"Failed to generate explanations");const r=W.map((e,s)=>{const a=t.explanations.find(e=>e.questionIndex===s+1);return{...e,explanation:a?a.explanation:e.explanation}});H(r);const n=JSON.stringify(r),i=new File([n],"questions-with-explanations.json",{type:"application/json"});Y("csvFile",i),w.success(`Generated explanations for ${t.explanations.length} questions!`)}catch(e){console.error("Error generating explanations:",e),w.error(`Failed to generate explanations: ${e.message}`)}finally{B(!1)}}else w.error("Please provide a transcript first");else w.error("Please upload questions first")};return p?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Listening Management..."})]})}):x?r.jsx(P,{title:`${null==t?void 0:t.toUpperCase()} Test ${m} - Listening Management`,showBackButton:!0,backPath:`/admin/${t}/listening`,children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:[null==t?void 0:t.toUpperCase()," Test ",m," - Listening Management"]}),r.jsx("p",{className:"text-muted-foreground mt-1",children:"Create a complete listening test with one audio file and questions for all 4 parts (40 questions total)"})]}),r.jsxs(f,{variant:"secondary",className:"text-sm",children:["Test ",m]})]}),r.jsxs(n,{className:"border border-border",children:[r.jsx(i,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(l,{className:"flex items-center gap-2",children:[b.saved?r.jsx(q,{className:"w-5 h-5 text-green-500"}):r.jsx(C,{className:"w-5 h-5 text-muted-foreground"}),"Listening Test - All Parts (1-4)"]}),r.jsx(f,{variant:b.saved?"default":"outline",children:b.saved?"Saved":"Not Saved"})]})}),r.jsxs(c,{className:"space-y-6",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Test Title *"}),r.jsx(u,{placeholder:"Listening Test Title (e.g., IELTS Academic Listening Practice Test 1)",value:b.title,onChange:e=>Y("title",e.target.value)})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Overall Instructions *"}),r.jsx(v,{placeholder:"Enter general instructions for the listening test (applies to all 4 parts)...",value:b.instructions,onChange:e=>Y("instructions",e.target.value),rows:4,className:"resize-none"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Audio File (All 4 Parts) *"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload one continuous audio file containing all 4 parts of the listening test (approximately 30 minutes)"}),r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(I,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload MP3 or WAV audio file (recommended: 30-40 minutes)"}),r.jsx("input",{type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(e=>{Y("audioFile",e),w.success(`Audio file uploaded: ${e.name}`)})(t)},className:"hidden",id:"audio-upload"}),r.jsxs(d,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("audio-upload"))?void 0:e.click()},children:[r.jsx(D,{className:"w-4 h-4 mr-2"}),"Choose Audio File"]})]})}),b.audioFile&&r.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[r.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["âœ“ Audio file ready: ",b.audioFile.name]}),r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(b.audioFile.size/1024/1024).toFixed(2)," MB"]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"text-sm font-medium",children:["Transcript Text ",r.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional)"})]}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Paste the full transcript text here. AI will automatically sync it with the audio for the student viewer."}),r.jsx(v,{placeholder:"Paste the full transcript text here...",value:b.transcriptText,onChange:e=>Y("transcriptText",e.target.value),rows:6,className:"font-mono text-sm"}),b.transcriptText&&r.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200",children:r.jsxs("p",{className:"text-xs text-purple-800 dark:text-purple-200 flex items-center gap-2",children:[r.jsx(o,{className:"w-3 h-3"}),"Timestamps will be auto-generated when you save!"]})})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Answer Image (Optional)"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Upload an image that represents the correct answer (e.g., diagram, map). This will be stored with the listening section."}),r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6",children:[r.jsx("div",{className:"flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx(Q,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Upload PNG/JPEG image (recommended max 2MB)"}),r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&Y("answerImageFile",t)},className:"hidden",id:"answer-image-upload"}),r.jsxs(d,{variant:"outline",onClick:()=>{var e;return null==(e=document.getElementById("answer-image-upload"))?void 0:e.click()},children:[r.jsx(D,{className:"w-4 h-4 mr-2"}),"Choose Image"]})]})}),b.answerImageFile&&r.jsxs("div",{className:"mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200",children:[r.jsxs("p",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:["âœ“ Image ready: ",b.answerImageFile.name]}),r.jsxs("p",{className:"text-xs text-green-600 dark:text-green-300 mt-1",children:["Size: ",(b.answerImageFile.size/1024/1024).toFixed(2)," MB"]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"Questions (All 40 Questions) *"}),r.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Choose your method: Upload CSV or use AI to extract from images"}),r.jsxs(F,{defaultValue:"csv",className:"w-full",children:[r.jsxs(E,{className:"grid w-full grid-cols-2",children:[r.jsxs(S,{value:"csv",className:"flex items-center gap-2",children:[r.jsx(G,{className:"w-4 h-4"}),"CSV Upload"]}),r.jsxs(S,{value:"ai",className:"flex items-center gap-2",children:[r.jsx(o,{className:"w-4 h-4"}),"AI Extraction"]})]}),r.jsxs(A,{value:"csv",className:"mt-4",children:[r.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-6",children:[r.jsx(L,{onImport:e=>(e=>{console.log("CSV uploaded with questions:",e),H(e);const s=JSON.stringify(e),t=new File([s],"listening-questions.json",{type:"application/json"});Y("csvFile",t)})(e),type:"listening",module:t,cambridgeBook:`${null==t?void 0:t.toUpperCase()} Test ${m}`,testNumber:parseInt(m||"1"),sectionNumber:1,hideDownloadSample:!0}),b.csvFile&&r.jsx("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200",children:r.jsxs("p",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:["âœ“ Questions file ready: ",b.csvFile.name]})})]}),r.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Upload a CSV with all 40 questions (Q1-10: Part 1, Q11-20: Part 2, Q21-30: Part 3, Q31-40: Part 4)"})]}),r.jsx(A,{value:"ai",className:"mt-4",children:r.jsx(O,{testId:m||"",testType:t||"ielts",onQuestionsExtracted:e=>{console.log("âœ¨ AI extracted questions:",e);const s=JSON.stringify(e),t=new File([s],"ai-extracted-questions.json",{type:"application/json"});H(e),Y("csvFile",t),w.success(`Ready to save ${e.length} AI-extracted questions!`)}})})]})]}),W.length>0&&r.jsxs("div",{className:"space-y-4 border-t pt-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h3",{className:"text-lg font-semibold",children:"Review Questions & Explanations"}),r.jsxs(d,{variant:"outline",onClick:X,disabled:M||!b.transcriptText,className:"gap-2",children:[M?r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}):r.jsx(o,{className:"w-4 h-4 text-purple-500"}),"Generate Explanations with Gemini 3.0 Pro"]})]}),!b.transcriptText&&r.jsx("p",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded",children:"âš ï¸ You need to add a transcript above to generate AI explanations."}),r.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto pr-2",children:W.map((e,s)=>r.jsx(n,{className:"bg-muted/30",children:r.jsxs(c,{className:"p-4 space-y-2",children:[r.jsx("div",{className:"flex justify-between items-start gap-4",children:r.jsxs("div",{className:"space-y-1 flex-1",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(f,{variant:"outline",children:["Q",s+1]}),r.jsx("span",{className:"font-medium",children:e.question_text})]}),r.jsxs("div",{className:"text-sm text-muted-foreground pl-10",children:["Answer: ",r.jsx("span",{className:"font-semibold text-green-600",children:e.correct_answer})]})]})}),r.jsx("div",{className:"pl-10 mt-2",children:r.jsxs("div",{className:"bg-white dark:bg-slate-800 p-3 rounded-md border border-border text-sm",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1 text-purple-600 dark:text-purple-400 font-medium text-xs uppercase tracking-wider",children:[r.jsx(o,{className:"w-3 h-3"}),"AI Explanation"]}),V[s]||e.explanation?r.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:V[s]||e.explanation}):r.jsx("p",{className:"text-muted-foreground/50 italic",children:'No explanation generated yet. Click "Generate AI Explanations" above.'})]})})]})},s))})]}),r.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200",children:[r.jsx("h4",{className:"text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"ðŸ’¡ How this works:"}),r.jsxs("ul",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1 list-disc list-inside",children:[r.jsx("li",{children:"Upload ONE audio file containing all 4 parts (Parts 1-4)"}),r.jsx("li",{children:"CSV should contain 40 questions (numbered 1-40)"}),r.jsx("li",{children:"Questions 1-10 = Part 1, 11-20 = Part 2, 21-30 = Part 3, 31-40 = Part 4"}),r.jsx("li",{children:"Audio will be uploaded to Cloudflare R2 for fast global delivery"})]})]}),r.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[b.csvFile&&b.transcriptText&&r.jsx(d,{variant:"outline",onClick:X,disabled:M||!b.csvFile,className:"border-purple-300 text-purple-700 hover:bg-purple-50 dark:border-purple-700 dark:text-purple-300 dark:hover:bg-purple-900/20",size:"lg",children:M?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"}),"Generating AI Explanations..."]}):r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"w-4 h-4 mr-2"}),"Generate AI Explanations"]})}),r.jsx(d,{onClick:async()=>{if(b.title.trim()&&b.instructions.trim()&&b.csvFile){U(!0);try{let t=null;if(b.audioFile){console.log("ðŸ“¤ Uploading audio to Cloudflare R2...");const e=await j(b.audioFile);t=e.url,console.log("âœ… Audio uploaded successfully:",t)}let a=null;if(b.transcriptText.trim()&&t){R(!0);try{console.log("ðŸŽ™ï¸ Generating timestamps for transcript...");const{supabase:e}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]),{data:r,error:n}=await e.functions.invoke("generate-transcript-timestamps",{body:{audioUrl:t,transcript:b.transcriptText}});if(n)throw n;if(!r.success)throw new Error(r.error||"Failed to generate timestamps");a=r.timestamps,console.log("âœ… Timestamps generated successfully"),w.success("Transcript timestamps generated!")}catch(e){console.error("Error generating timestamps:",e),w.error("Failed to generate timestamps, but saving test anyway.")}finally{R(!1)}}let r=null;if(b.answerImageFile){console.log("ðŸ“¤ Uploading answer image...");const e=await j(b.answerImageFile);r=e.url,console.log("âœ… Answer image uploaded:",r)}const n=W.length>0?W:[];if(0===n.length){const e=await b.csvFile.text();try{const s=JSON.parse(e);n.push(...s)}catch{const s=e.split("\n").filter(e=>e.trim()),t=s[0].split(",").map(e=>e.trim().replace(/"/g,"")),a=s.slice(1).map(e=>{const s=e.split(",").map(e=>e.trim().replace(/"/g,"")),a={};return t.forEach((e,t)=>{a[e]=s[t]||""}),a}).filter(e=>e.question_text&&e.correct_answer);n.push(...a)}}const{supabase:i}=await s(async()=>{const{supabase:e}=await import("./supabase-Bqkrifq5.js").then(e=>e.b);return{supabase:e}},[]);let l;const{data:o}=await i.from("tests").select("id").eq("test_type","IELTS").eq("module","Listening").ilike("test_name",`%Test ${m}%`).maybeSingle();if(o)l=o.id,await i.from("tests").update({test_name:b.title}).eq("id",l);else{const{data:e,error:s}=await i.from("tests").insert({test_name:b.title||`IELTS Listening Test ${m}`,test_type:"IELTS",module:"Listening"}).select().single();if(s)throw s;l=e.id}console.log("âœ… Test ID:",l);const c=e=>e<10?1:e<20?2:e<30?3:4,d=n.map((e,s)=>{const n=s+1,i=c(s);return{test_id:l,part_number:i,question_number_in_part:n,question_text:e.question_text,question_type:e.question_type||"multiple_choice",correct_answer:e.correct_answer,choices:e.options?Array.isArray(e.options)?e.options.join(";"):e.options:null,explanation:V[s]||e.explanation||"",audio_url:t,transcription:b.transcriptText||null,transcript_json:a,answer_image_url:r,passage_text:0===s||10===s||20===s||30===s?b.instructions:null}});await i.from("questions").delete().eq("test_id",l);const{error:u}=await i.from("questions").insert(d);if(u)throw u;console.log(`âœ… Saved ${d.length} questions`),w.success("Test saved successfully!"),N(e=>({...e,saved:!0})),U(!1),K()}catch(e){console.error("Error saving test:",e),w.error(`Failed to save test: ${e.message}`),U(!1)}}else w.error("Please fill in title, instructions and upload a CSV file")},disabled:z||!b.title.trim()||!b.instructions.trim()||!b.csvFile,className:"bg-primary hover:bg-primary/90 px-8",size:"lg",children:z?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving Test..."]}):r.jsxs(r.Fragment,{children:[r.jsx(D,{className:"w-4 h-4 mr-2"}),"Save Complete Listening Test"]})})]})]})]})]})}):null};export{U as default};
