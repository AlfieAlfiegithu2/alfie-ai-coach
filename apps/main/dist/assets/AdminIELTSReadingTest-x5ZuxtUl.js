import{ar as e,u as s,g as t,r as a,j as n,C as r,b as i,c as o,a as l,B as d,d as c,k as u,ae as m,T as x}from"./index-BPnIJTll.js";import{S as h}from"./separator-lrqJmuBX.js";import{A as g}from"./AdminLayout-C8nfmQ7X.js";import{s as p}from"./supabase-DUkWVuqu.js";import{S as j}from"./save-CNA25kTi.js";const f=()=>{const{testId:f}=e(),v=s(),{toast:b}=t(),[N,_]=a.useState(null),[y,w]=a.useState([]),[q,T]=a.useState(!0),[I,k]=a.useState(!1),[S,E]=a.useState(!1);a.useEffect(()=>{f&&C()},[f]);const C=async()=>{try{if(console.log("ðŸ“– Loading reading test data for testId:",f),!f)return console.error("âŒ No testId provided!"),void T(!1);T(!0);const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",s=p.supabaseUrl,t=new AbortController,a=setTimeout(()=>t.abort(),5e3);try{console.log("ðŸ“– Fetching test details via REST API...");const a=await fetch(`${s}/rest/v1/tests?id=eq.${f}`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(!a.ok)throw new Error(`Test fetch failed: ${a.status}`);const n=await a.json(),r=null==n?void 0:n[0];if(!r)return console.error("âŒ Test not found:",f),T(!1),void _({});console.log("âœ… Test loaded:",r),_(r),console.log("ðŸ“– Fetching reading questions via REST API...");let i=[];const o=await fetch(`${s}/rest/v1/questions?test_id=eq.${f}&order=part_number.asc&order=question_number_in_part.asc&limit=1000`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(o.ok)i=await o.json();else{console.warn("REST questions fetch failed with status",o.status,"- falling back to supabase client");const{data:e,error:s}=await p.from("questions").select("*").eq("test_id",f).order("part_number",{ascending:!0}).order("question_number_in_part",{ascending:!0});s&&console.error("Fallback questions query error:",s),i=e||[]}if(i&&i.length>=0){console.log("âœ… Questions loaded:",(null==i?void 0:i.length)||0);const e=new Map;null==i||i.forEach(s=>{e.has(s.part_number)||e.set(s.part_number,{part_number:s.part_number,passage_text:s.passage_text||"",questions:[]}),e.get(s.part_number).questions.push(s)}),w(Array.from(e.values()));const s=i&&i.length>0&&i.some(e=>e.passage_text);k(Boolean(s))}console.log("âœ… Test data loading complete")}finally{clearTimeout(a),T(!1)}}catch(e){console.error("âŒ Error loading test data:",e)}};return q?n.jsx(g,{title:"Loading Reading Test...",showBackButton:!0,children:n.jsx("div",{className:"flex items-center justify-center min-h-96",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),n.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading reading test data..."})]})})}):N?n.jsx(g,{title:`Reading Test: ${N.test_name}`,showBackButton:!0,backPath:"/admin/ielts/reading",children:n.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[n.jsx(c,{className:"w-8 h-8"}),N.test_name]}),n.jsx("p",{className:"text-muted-foreground mt-2",children:"Manage reading passages and questions"})]}),n.jsxs("div",{className:"flex gap-2",children:[I&&!S&&n.jsx(d,{onClick:()=>{E(!0),k(!1)},variant:"outline",children:"Modify"}),(S||!I)&&n.jsx(d,{onClick:()=>{E(!1),k(!0)},variant:"default",children:"Lock"})]})]}),n.jsx(h,{}),0===y.length?n.jsx(r,{children:n.jsxs(l,{className:"pt-6 text-center",children:[n.jsx("p",{className:"text-muted-foreground",children:"No reading passages have been added yet."}),n.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Add passages through the questions interface."})]})}):n.jsx("div",{className:"space-y-6",children:y.map((e,s)=>n.jsxs(r,{children:[n.jsx(i,{children:n.jsx("div",{className:"flex items-center justify-between",children:n.jsxs("div",{children:[n.jsx(o,{className:"flex items-center gap-2",children:n.jsxs(u,{variant:"outline",children:["Passage ",e.part_number]})}),n.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:[e.questions.length," question",1!==e.questions.length?"s":""]})]})})}),n.jsxs(l,{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx(m,{children:"Passage Text"}),n.jsx(x,{value:e.passage_text,onChange:e=>{const t=[...y];t[s].passage_text=e.target.value,w(t)},placeholder:"Enter the reading passage text...",className:"min-h-40 font-mono text-sm",disabled:I&&!S})]}),n.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[n.jsx("p",{className:"font-medium mb-2",children:"Questions in this passage:"}),n.jsx("ul",{className:"space-y-1 text-sm",children:e.questions.map((e,s)=>{var t;return n.jsxs("li",{className:"text-muted-foreground",children:["Q",s+1,": ",null==(t=e.question_text)?void 0:t.substring(0,50),"..."]},s)})})]}),!I||S?n.jsxs(d,{onClick:()=>(async e=>{try{const s=y.find(s=>s.part_number===e);if(!s)return;console.log(`ðŸ’¾ Saving reading passage ${e}...`);for(const e of s.questions){const{error:t}=await p.from("questions").update({passage_text:s.passage_text}).eq("id",e.id);if(t)throw t}b({title:"Success",description:`Passage ${e} saved successfully`}),k(!0)}catch(s){console.error("Error saving passage:",s),b({title:"Error",description:"Failed to save passage",variant:"destructive"})}})(e.part_number),className:"w-full gap-2",children:[n.jsx(j,{className:"w-4 h-4"}),"Save Passage ",e.part_number]}):null]})]},s))})]})}):n.jsx(g,{title:"Reading Test Not Found",showBackButton:!0,children:n.jsxs(r,{className:"max-w-md mx-auto mt-8",children:[n.jsx(i,{children:n.jsx(o,{children:"Test Not Found"})}),n.jsxs(l,{children:[n.jsx("p",{className:"text-muted-foreground mb-4",children:"The reading test you're looking for doesn't exist."}),n.jsx(d,{onClick:()=>v("/admin/ielts/reading"),variant:"outline",className:"w-full",children:"Back to Reading Tests"})]})]})})};export{f as default};
