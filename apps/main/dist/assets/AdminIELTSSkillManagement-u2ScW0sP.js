import{G as e,u as s,w as t,r as a,J as i,j as n,l as r,C as l,b as o,d as c,P as d,y as m,a as h,I as x,B as g,x as u,X as j,e as p,H as f,f as y,M as w}from"./index-CFsndfmK.js";import{A as k,a as N,b as I,c as b,d as C,e as T,f as v,g as $,h as S}from"./alert-dialog-D8T91og8.js";import{A as E}from"./AdminLayout-B_ugDz-T.js";import{a as J}from"./supabase-DWL4C3fA.js";import{P as M}from"./pen-line-DMTa6pL-.js";import{T as O}from"./trash-2-B9_C-s2W.js";const L={listening:f,reading:p,writing:y,speaking:w},z=()=>{const{skill:f}=e(),y=s(),{admin:w,loading:z}=t(),[F,_]=a.useState([]),[A,Z]=a.useState(!1),[Y,P]=a.useState(""),[R,X]=a.useState(null),[U,q]=a.useState(""),B=["listening","reading","writing","speaking"];if(a.useEffect(()=>{if(!f||!B.includes(f.toLowerCase()))return console.log("Invalid or missing skill parameter:",f,"Redirecting to /admin/ielts"),void y("/admin/ielts")},[f,y]),!f||!B.includes(f.toLowerCase()))return null;const W=f?f.charAt(0).toUpperCase()+f.slice(1):"",D=null==f?void 0:f.toLowerCase(),V=D&&L[D]||p;a.useEffect(()=>{z||(w?K():y("/admin/login"))},[w,z,y,f]);const K=async()=>{if(f)try{console.log(`ğŸ” Loading ${W} tests...`);const s=f.charAt(0).toUpperCase()+f.slice(1),t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",a="https://cuumxmfzhwljylbdlflj.supabase.co",i=new AbortController,n=setTimeout(()=>i.abort(),5e3);try{const e=await fetch(`${a}/rest/v1/tests?test_type=eq.IELTS&order=created_at.asc`,{headers:{apikey:t,Authorization:`Bearer ${t}`,"Content-Type":"application/json"},signal:i.signal});if(clearTimeout(n),!e.ok)throw new Error(`Failed to fetch tests: ${e.status}`);const r=await e.json(),l=(null==r?void 0:r.filter(e=>e.module===s||e.skill_category===s))||[];console.log(`âœ… Found ${l.length} ${W} tests:`,l),_(l)}catch(e){throw clearTimeout(n),console.error("âŒ Fetch error:",e),e}}catch(s){console.error("âŒ Error loading skill tests:",s),i.error(`Failed to load ${W} tests`)}},G=async()=>{if(Y.trim()){Z(!0);try{console.log(`ğŸ“ Creating new ${W} test: "${Y}"`);const e=f?f.charAt(0).toUpperCase()+f.slice(1):"";let s={test_name:Y,test_type:"IELTS",module:e,skill_category:e};"writing"===f?(s.module="Writing",s.skill_category="Writing"):"speaking"===f?(s.module="Speaking",s.skill_category="Speaking"):"reading"===f?(s.module="Reading",s.skill_category="Reading"):"listening"===f&&(s.module="Listening",s.skill_category="Listening"),console.log("ğŸ’¾ Creating test via edge function:",s);const t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",a=`${"https://cuumxmfzhwljylbdlflj.supabase.co"}/functions/v1/create-test`,n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",apikey:t,Authorization:`Bearer ${t}`},body:JSON.stringify(s)});if(!n.ok){const e=await n.text();throw console.error("Create function error response:",e),new Error(`Failed to create test: ${n.status} - ${e}`)}const r=(await n.json()).data;switch(console.log("âœ… Test created successfully:",r),i.success(`${W} test created successfully`),P(""),await K(),f){case"speaking":y(`/admin/ielts/test/${r.id}/speaking`);break;case"writing":y(`/admin/ielts/test/${r.id}/writing`);break;case"reading":y(`/admin/ielts/test/${r.id}/reading`);break;case"listening":y(`/admin/ielts/test/${r.id}/listening`);break;default:y(`/admin/ielts/test/${r.id}`)}}catch(e){console.error("âŒ Full error:",e),i.error(`Failed to create ${W} test: ${(null==e?void 0:e.message)||"Unknown error"}`)}finally{Z(!1)}}else i.error("Please enter a test name")},H=()=>{X(null),q("")},Q=async()=>{if(U.trim())try{const{error:e}=await J.from("tests").update({test_name:U}).eq("id",R);if(e)throw e;i.success("Test name updated successfully"),X(null),q(""),K()}catch(e){console.error("Error updating test name:",e),i.error("Failed to update test name")}else i.error("Test name cannot be empty")},ee=e=>{if(!R)switch(f){case"speaking":y(`/admin/ielts/test/${e.id}/speaking`);break;case"writing":y(`/admin/ielts/test/${e.id}/writing`);break;case"reading":y(`/admin/ielts/test/${e.id}/reading`);break;case"listening":y(`/admin/ielts/test/${e.id}/listening`);break;default:y(`/admin/ielts/test/${e.id}`)}};return z?n.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),n.jsxs("p",{className:"mt-2 text-sm text-muted-foreground",children:["Loading ",W," Admin..."]})]})}):w?n.jsx(E,{title:`IELTS ${W} Tests`,showBackButton:!0,backPath:"/admin/ielts",children:n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center space-x-3",children:[n.jsx(V,{className:"h-8 w-8 text-primary"}),n.jsxs("div",{children:[n.jsxs("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:["IELTS ",W," Tests"]}),n.jsxs("p",{className:"text-muted-foreground",children:["Manage ",W.toLowerCase()," test content and questions"]})]})]}),n.jsxs(r,{variant:"secondary",className:"text-sm",children:[W," Management"]})]}),n.jsxs(l,{children:[n.jsxs(o,{children:[n.jsxs(c,{className:"flex items-center space-x-2",children:[n.jsx(d,{className:"h-5 w-5"}),n.jsxs("span",{children:["Create New ",W," Test"]})]}),n.jsxs(m,{children:["Add a new IELTS ",W.toLowerCase()," test to your collection"]})]}),n.jsxs(h,{className:"flex gap-3 items-end",children:[n.jsx("div",{className:"flex-1",children:n.jsx(x,{placeholder:`Test name (e.g., ${W} Test 1)`,value:Y,onChange:e=>P(e.target.value),onKeyPress:e=>"Enter"===e.key&&G()})}),n.jsx(g,{onClick:G,disabled:A,children:A?"Creating...":"Create Test"})]})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("h3",{className:"text-xl font-semibold",children:["Existing ",W," Tests"]}),n.jsxs(r,{variant:"outline",children:[F.length," tests"]})]}),F.length>0?n.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:F.map(e=>n.jsxs(l,{className:"cursor-pointer hover:shadow-lg transition-shadow",onClick:()=>ee(e),children:[n.jsxs(o,{children:[n.jsxs(c,{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx(V,{className:"w-5 h-5 text-primary"}),R===e.id?n.jsxs("div",{className:"flex items-center space-x-2",onClick:e=>e.stopPropagation(),children:[n.jsx(x,{value:U,onChange:e=>q(e.target.value),className:"text-lg font-semibold h-8",onKeyPress:e=>"Enter"===e.key&&Q()}),n.jsx(g,{size:"sm",variant:"ghost",onClick:Q,children:n.jsx(u,{className:"w-4 h-4 text-green-600"})}),n.jsx(g,{size:"sm",variant:"ghost",onClick:H,children:n.jsx(j,{className:"w-4 h-4 text-red-600"})})]}):n.jsx("span",{children:e.test_name})]}),R!==e.id&&n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(g,{size:"sm",variant:"ghost",onClick:s=>{s.stopPropagation(),(e=>{X(e.id),q(e.test_name)})(e)},children:n.jsx(M,{className:"w-4 h-4"})}),n.jsxs(k,{children:[n.jsx(N,{asChild:!0,children:n.jsx(g,{size:"sm",variant:"ghost",onClick:e=>e.stopPropagation(),children:n.jsx(O,{className:"w-4 h-4 text-red-600"})})}),n.jsxs(I,{className:"z-50",children:[n.jsxs(b,{children:[n.jsx(C,{children:"Delete Test"}),n.jsxs(T,{children:['Are you sure you want to delete "',e.test_name,'"? This will also delete all questions associated with this test. This action cannot be undone.']})]}),n.jsxs(v,{children:[n.jsx($,{children:"Cancel"}),n.jsx(S,{onClick:()=>(async(e,s)=>{try{console.log(`ğŸ—‘ï¸ Deleting test: ${s} (${e})`);const t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",a="https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/delete-test",n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",apikey:t,Authorization:`Bearer ${t}`},body:JSON.stringify({testId:e})});if(!n.ok){const e=await n.text();throw console.error("Delete function error response:",e),new Error(`Failed to delete test: ${n.status} - ${e}`)}const r=await n.json();console.log("âœ… Test deleted successfully:",r),i.success(`Test "${s}" deleted successfully`),K()}catch(t){console.error("âŒ Full error:",t),i.error(`Failed to delete test: ${(null==t?void 0:t.message)||"Unknown error"}`)}})(e.id,e.test_name),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]}),n.jsxs(m,{children:["Created: ",new Date(e.created_at).toLocaleDateString()]})]}),n.jsxs(h,{children:[n.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[n.jsxs("span",{children:["Type: ",e.test_type]}),n.jsxs("span",{children:["Skill: ",e.module]})]}),n.jsxs(g,{size:"sm",className:"w-full mt-3",onClick:s=>{s.stopPropagation(),ee(e)},disabled:R===e.id,children:["Manage ",W," Content"]})]})]},e.id))}):n.jsxs("div",{className:"text-center py-12",children:[n.jsx(V,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),n.jsxs("h3",{className:"text-lg font-semibold mb-2",children:["No ",W," tests found"]}),n.jsxs("p",{className:"text-muted-foreground mb-4",children:["Create your first ",W.toLowerCase()," test to get started"]}),n.jsx(g,{onClick:()=>P(`${W} Test 1`),children:"Create First Test"})]})]})]})}):null};export{z as default};
