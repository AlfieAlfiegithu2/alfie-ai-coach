import{u as e,r as s,j as t}from"./vendor-react-JN_hy__U.js";import{n as a,B as n,C as i,b as r,c as l,a as o,L as c,I as d,S as m,i as x,j as u,k as g,l as h,e as p,J as j,s as y}from"./index-DXpPY1B7.js";import{A as b,a as f,b as N,c as w,d as I,e as v,f as T,g as k,h as _}from"./alert-dialog-BwGJZs3W.js";import{A as C}from"./AdminLayout-D3lPYw5Y.js";import{av as S,ax as E,N as J,aZ as A,q as O,X as M,a_ as W,aY as F}from"./vendor-ui-DG51EGkO.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const Z="https://cuumxmfzhwljylbdlflj.supabase.co",L=()=>{const L=e(),{admin:z,loading:R}=a(),[$,Y]=s.useState([]),[G,P]=s.useState(!0),[X,q]=s.useState(null),[U,B]=s.useState(""),[D,V]=s.useState(""),[K,H]=s.useState("Academic"),Q=async()=>{try{P(!0),console.log("ðŸ“ Loading writing tests..."),console.log("ðŸ”— Using Supabase URL:",Z);const e=`${Z}/rest/v1/tests?test_type=eq.IELTS`,s={apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI","Content-Type":"application/json"};console.log("ðŸ”„ Fetching from REST API:",e);const t=await fetch(e,{headers:s});if(console.log("ðŸ“Š REST API Response status:",t.status),!t.ok)throw new Error(`REST API error: ${t.status} ${t.statusText}`);const a=await t.json();console.log("âœ… REST API returned",(null==a?void 0:a.length)||0,"tests");const n=(null==a?void 0:a.filter(e=>{var s;return"Writing"===e.module||"Writing"===e.skill_category||(null==(s=e.test_name)?void 0:s.includes("Writing"))}))||[];console.log(`âœ… Found ${n.length} writing tests:`,n),Y(n)}catch(e){console.error("âŒ Error loading tests:",e),console.error("Error details:",{message:null==e?void 0:e.message,stack:null==e?void 0:e.stack}),j.error(`Failed to load writing tests: ${(null==e?void 0:e.message)||"Unknown error"}`),Y([])}finally{P(!1)}};s.useEffect(()=>{(async()=>{R||(z?(console.log("âœ… Admin authenticated - loading tests"),await Q()):(console.log("âŒ No admin - redirecting to login"),L("/admin/login")))})()},[z,R,L]);const ee=async()=>{if(D.trim())try{P(!0),console.log("ðŸ“ Creating new writing test..."),console.log("ðŸŽ¯ Selected trainingType:",K);const e={test_name:D.trim(),test_type:"IELTS",module:"Writing",skill_category:"Writing",test_subtype:K};console.log("ðŸ“¤ Sending to edge function:",e),console.log("âœ… test_subtype value:",e.test_subtype);const s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",t=`${Z}/functions/v1/create-test`,a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",apikey:s,Authorization:`Bearer ${s}`},body:JSON.stringify(e)});if(console.log("Edge function response status:",a.status),!a.ok){const e=await a.text();throw console.error("Create function error response:",e),new Error(`Failed to create test: ${a.status} - ${e}`)}const n=(await a.json()).data;console.log("âœ… Test created successfully:",n),console.log("ðŸ“‹ Created test test_subtype:",null==n?void 0:n.test_subtype,"(type:",typeof(null==n?void 0:n.test_subtype),")"),console.log("ðŸ“‹ Expected test_subtype:",K,"(type:",typeof K,")"),console.log("ðŸ“‹ Full test object keys:",Object.keys(n||{}));const i=String((null==n?void 0:n.test_subtype)||"").trim(),r=String(K||"").trim();i!==r&&""!==i?(console.warn("âš ï¸ WARNING: Created test test_subtype does not match selected type!"),console.warn(`âš ï¸ Actual: "${i}" !== Expected: "${r}"`),console.warn("âš ï¸ This may mean the migration has not been applied yet."),console.warn("âš ï¸ Please apply migration: 20251113221619_add_test_subtype_to_tests.sql")):""===i?(console.warn("âš ï¸ WARNING: test_subtype is empty/null - migration may not be applied"),console.warn("âš ï¸ Please apply migration: 20251113221619_add_test_subtype_to_tests.sql")):console.log("âœ… test_subtype matches correctly!"),j.success("Test created successfully"+((null==n?void 0:n.test_subtype)?` (${n.test_subtype})`:"")),V(""),H("Academic"),await Q(),L(`/admin/ielts/test/${n.id}/writing`)}catch(e){console.error("âŒ Create test error:",e),j.error(`Failed to create test: ${(null==e?void 0:e.message)||"Unknown error"}`)}finally{P(!1)}else j.error("Please enter a test name")},se=()=>{q(null),B("")},te=async()=>{if(U.trim())try{const{error:e}=await y.from("tests").update({test_name:U}).eq("id",X);if(e)throw e;j.success("Test name updated successfully"),q(null),B(""),Q()}catch(e){console.error("Error updating test name:",e),j.error("Failed to update test name")}else j.error("Test name cannot be empty")};return R||G?t.jsx(C,{title:"IELTS Writing",showBackButton:!0,backPath:"/admin/ielts",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),t.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Writing tests..."})]})}):z?t.jsx(C,{title:"IELTS Writing",showBackButton:!0,backPath:"/admin/ielts",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent",children:"IELTS Writing Tests"}),t.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage writing test content and questions"})]}),t.jsx(n,{onClick:()=>L("/admin/ielts"),variant:"outline",children:"Writing Management"})]}),t.jsxs(i,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[t.jsxs(r,{children:[t.jsxs(l,{className:"flex items-center gap-2",children:[t.jsx(S,{className:"w-5 h-5"}),"Create New Writing Test"]}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Add a new IELTS writing test to your collection"})]}),t.jsxs(o,{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs(c,{htmlFor:"test-name",className:"text-base font-medium",children:["Test Name ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx(d,{id:"test-name",value:D,onChange:e=>V(e.target.value),placeholder:"Test name (e.g., Writing Test 1)",disabled:G,className:"h-11"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(c,{htmlFor:"training-type",className:"text-base font-semibold text-foreground block",children:["Training Type ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsxs(m,{value:K,onValueChange:e=>{console.log("Training type changed to:",e),H(e)},disabled:G,children:[t.jsx(x,{id:"training-type",className:"w-full h-12 border-2 border-primary/40 focus:ring-2 focus:ring-primary bg-background font-semibold text-foreground shadow-md hover:border-primary/60 transition-colors",children:t.jsx(u,{})}),t.jsxs(g,{className:"z-[100]",children:[t.jsx(h,{value:"Academic",children:"Academic Training"}),t.jsx(h,{value:"General",children:"General Training"})]})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose Academic for data description tasks or General for letter writing tasks"}),t.jsxs("p",{className:"text-sm text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded",children:["Selected: ","Academic"===K?"Academic Training":"General Training"]})]})]}),t.jsx("div",{className:"flex justify-end pt-2",children:t.jsxs(n,{onClick:ee,disabled:G||!D.trim(),className:"bg-primary hover:bg-primary/90 w-full md:w-auto min-w-[140px] h-11",children:[t.jsx(S,{className:"w-4 h-4 mr-2"}),"Create Test"]})})]})]}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[t.jsxs(i,{children:[t.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[t.jsx(l,{className:"text-sm font-medium",children:"Total Tests"}),t.jsx(E,{className:"h-4 w-4 text-muted-foreground"})]}),t.jsxs(o,{children:[t.jsx("div",{className:"text-2xl font-bold",children:$.length}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"IELTS Writing tests created"})]})]}),t.jsxs(i,{children:[t.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[t.jsx(l,{className:"text-sm font-medium",children:"Active Tests"}),t.jsx(J,{className:"h-4 w-4 text-muted-foreground"})]}),t.jsxs(o,{children:[t.jsx("div",{className:"text-2xl font-bold",children:$.length}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Available for students"})]})]}),t.jsxs(i,{children:[t.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[t.jsx(l,{className:"text-sm font-medium",children:"Completion Rate"}),t.jsx(A,{className:"h-4 w-4 text-muted-foreground"})]}),t.jsxs(o,{children:[t.jsx("div",{className:"text-2xl font-bold",children:"85%"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Student completion rate"})]})]})]}),t.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:[$.map(e=>t.jsxs(i,{className:"hover:shadow-lg transition-all duration-200 cursor-pointer border-border/40 bg-card/50 backdrop-blur-sm",onClick:()=>!X&&L(`/admin/ielts/test/${e.id}/writing`),children:[t.jsxs(r,{className:"pb-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center space-x-2 flex-1 mr-2",children:X===e.id?t.jsxs("div",{className:"flex items-center space-x-2 flex-1",onClick:e=>e.stopPropagation(),children:[t.jsx(d,{value:U,onChange:e=>B(e.target.value),className:"text-lg font-semibold h-8",onKeyPress:e=>"Enter"===e.key&&te()}),t.jsx(n,{size:"sm",variant:"ghost",onClick:te,children:t.jsx(O,{className:"w-4 h-4 text-green-600"})}),t.jsx(n,{size:"sm",variant:"ghost",onClick:se,children:t.jsx(M,{className:"w-4 h-4 text-red-600"})})]}):t.jsx(l,{className:"text-lg font-semibold text-foreground",children:e.test_name})}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(p,{variant:"secondary",children:"Writing"}),t.jsx(p,{variant:"General"===(e.test_subtype||e.training_type)?"default":"outline",className:"General"===(e.test_subtype||e.training_type)?"bg-green-600 text-white":"",children:"General"===(e.test_subtype||e.training_type)?"General":"Academic"}),X!==e.id&&t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[t.jsx(n,{size:"sm",variant:"ghost",onClick:s=>{s.stopPropagation(),(e=>{q(e.id),B(e.test_name)})(e)},children:t.jsx(W,{className:"w-4 h-4"})}),t.jsxs(b,{children:[t.jsx(f,{asChild:!0,children:t.jsx(n,{size:"sm",variant:"ghost",onClick:e=>e.stopPropagation(),children:t.jsx(F,{className:"w-4 h-4 text-red-600"})})}),t.jsxs(N,{className:"z-50",children:[t.jsxs(w,{children:[t.jsx(I,{children:"Delete Test"}),t.jsxs(v,{children:['Are you sure you want to delete "',e.test_name,'"? This will also delete all questions associated with this test. This action cannot be undone.']})]}),t.jsxs(T,{children:[t.jsx(k,{children:"Cancel"}),t.jsx(_,{onClick:s=>{s.stopPropagation(),(async(e,s)=>{try{console.log("ðŸ—‘ï¸ Deleting test via edge function:",e);const t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",a=`${Z}/functions/v1/delete-test`;console.log("ðŸ”— Edge Function URL:",a),console.log("ðŸ“¤ Sending testId:",e);const n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",apikey:t,Authorization:`Bearer ${t}`},body:JSON.stringify({testId:e})});console.log("ðŸ“Š Delete response status:",n.status),console.log("ðŸ“Š Delete response ok:",n.ok);const i=await n.text();if(console.log("ðŸ“„ Delete response body:",i),!n.ok)throw console.error("âŒ Delete function returned error status:",n.status),new Error(`Failed to delete test: ${n.status} - ${i}`);const r=JSON.parse(i);console.log("âœ… Test deleted successfully:",r),j.success(`Test "${s}" deleted successfully`),await Q()}catch(t){console.error("âŒ Delete test error:",t),console.error("Error details:",{message:null==t?void 0:t.message,stack:null==t?void 0:t.stack}),j.error(`Failed to delete test: ${(null==t?void 0:t.message)||"Unknown error"}`)}})(e.id,e.test_name)},className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Task 1 & Task 2 â€¢ 60 minutes total"}),t.jsx(p,{variant:"General"===(e.test_subtype||e.training_type)?"default":"outline",className:"General"===(e.test_subtype||e.training_type)?"bg-green-600 text-white text-xs":"text-xs",children:"General"===(e.test_subtype||e.training_type)?"General":"Academic"})]})]}),t.jsxs(o,{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(J,{className:"w-3 h-3"}),t.jsxs("span",{children:["Created ",new Date(e.created_at).toLocaleDateString()]})]}),t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(E,{className:"w-3 h-3"}),t.jsx("span",{children:"2 tasks"})]})]}),t.jsx(n,{className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground",onClick:s=>{s.stopPropagation(),L(`/admin/ielts/test/${e.id}/writing`)},disabled:X===e.id,children:"Manage Writing Content"})]})]},e.id)),0===$.length&&t.jsxs("div",{className:"col-span-full text-center py-12",children:[t.jsx(E,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No writing tests created yet"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:"Create your first IELTS Writing test to get started"}),t.jsxs(n,{onClick:ee,disabled:G,children:[t.jsx(S,{className:"w-4 h-4 mr-2"}),"Create First Test"]})]})]})]})}):null};export{L as default};
