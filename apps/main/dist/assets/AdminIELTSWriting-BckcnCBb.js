import{u as e,w as s,r as t,j as a,B as n,C as i,b as r,d as l,P as o,a as c,R as d,I as m,S as x,p as u,q as g,s as h,t as p,f as j,ap as y,x as f,X as b,l as N,J as w}from"./index-B-HVUhJA.js";import{A as I,a as T,b as v,c as k,d as _,e as C,f as S,g as E,h as J}from"./alert-dialog-BJgB-Dzl.js";import{A}from"./AdminLayout-BoqMqyoN.js";import{s as O}from"./supabase-DWL4C3fA.js";import{U as M}from"./users-DJgCSdu1.js";import{P as W}from"./pen-line-Lwe3_9rY.js";import{T as F}from"./trash-2-VdOzOS9O.js";const Z="https://cuumxmfzhwljylbdlflj.supabase.co",R=()=>{const R=e(),{admin:z,loading:L}=s(),[$,Y]=t.useState([]),[P,G]=t.useState(!0),[X,q]=t.useState(null),[U,B]=t.useState(""),[D,V]=t.useState(""),[K,H]=t.useState("Academic"),Q=async()=>{try{G(!0),console.log("ðŸ“ Loading writing tests..."),console.log("ðŸ”— Using Supabase URL:",Z);const e=`${Z}/rest/v1/tests?test_type=eq.IELTS`,s={apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI","Content-Type":"application/json"};console.log("ðŸ”„ Fetching from REST API:",e);const t=await fetch(e,{headers:s});if(console.log("ðŸ“Š REST API Response status:",t.status),!t.ok)throw new Error(`REST API error: ${t.status} ${t.statusText}`);const a=await t.json();console.log("âœ… REST API returned",(null==a?void 0:a.length)||0,"tests");const n=(null==a?void 0:a.filter(e=>{var s;return"Writing"===e.module||"Writing"===e.skill_category||(null==(s=e.test_name)?void 0:s.includes("Writing"))}))||[];console.log(`âœ… Found ${n.length} writing tests:`,n),Y(n)}catch(e){console.error("âŒ Error loading tests:",e),console.error("Error details:",{message:null==e?void 0:e.message,stack:null==e?void 0:e.stack}),w.error(`Failed to load writing tests: ${(null==e?void 0:e.message)||"Unknown error"}`),Y([])}finally{G(!1)}};t.useEffect(()=>{(async()=>{L||(z?(console.log("âœ… Admin authenticated - loading tests"),await Q()):(console.log("âŒ No admin - redirecting to login"),R("/admin/login")))})()},[z,L,R]);const ee=async()=>{if(D.trim())try{G(!0),console.log("ðŸ“ Creating new writing test..."),console.log("ðŸŽ¯ Selected trainingType:",K);const e={test_name:D.trim(),test_type:"IELTS",module:"Writing",skill_category:"Writing",test_subtype:K};console.log("ðŸ“¤ Sending to edge function:",e),console.log("âœ… test_subtype value:",e.test_subtype);const s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",t=`${Z}/functions/v1/create-test`,a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",apikey:s,Authorization:`Bearer ${s}`},body:JSON.stringify(e)});if(console.log("Edge function response status:",a.status),!a.ok){const e=await a.text();throw console.error("Create function error response:",e),new Error(`Failed to create test: ${a.status} - ${e}`)}const n=(await a.json()).data;console.log("âœ… Test created successfully:",n),console.log("ðŸ“‹ Created test test_subtype:",null==n?void 0:n.test_subtype,"(type:",typeof(null==n?void 0:n.test_subtype),")"),console.log("ðŸ“‹ Expected test_subtype:",K,"(type:",typeof K,")"),console.log("ðŸ“‹ Full test object keys:",Object.keys(n||{}));const i=String((null==n?void 0:n.test_subtype)||"").trim(),r=String(K||"").trim();i!==r&&""!==i?(console.warn("âš ï¸ WARNING: Created test test_subtype does not match selected type!"),console.warn(`âš ï¸ Actual: "${i}" !== Expected: "${r}"`),console.warn("âš ï¸ This may mean the migration has not been applied yet."),console.warn("âš ï¸ Please apply migration: 20251113221619_add_test_subtype_to_tests.sql")):""===i?(console.warn("âš ï¸ WARNING: test_subtype is empty/null - migration may not be applied"),console.warn("âš ï¸ Please apply migration: 20251113221619_add_test_subtype_to_tests.sql")):console.log("âœ… test_subtype matches correctly!"),w.success("Test created successfully"+((null==n?void 0:n.test_subtype)?` (${n.test_subtype})`:"")),V(""),H("Academic"),await Q(),R(`/admin/ielts/test/${n.id}/writing`)}catch(e){console.error("âŒ Create test error:",e),w.error(`Failed to create test: ${(null==e?void 0:e.message)||"Unknown error"}`)}finally{G(!1)}else w.error("Please enter a test name")},se=()=>{q(null),B("")},te=async()=>{if(U.trim())try{const{error:e}=await O.from("tests").update({test_name:U}).eq("id",X);if(e)throw e;w.success("Test name updated successfully"),q(null),B(""),Q()}catch(e){console.error("Error updating test name:",e),w.error("Failed to update test name")}else w.error("Test name cannot be empty")};return L||P?a.jsx(A,{title:"IELTS Writing",showBackButton:!0,backPath:"/admin/ielts",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading Writing tests..."})]})}):z?a.jsx(A,{title:"IELTS Writing",showBackButton:!0,backPath:"/admin/ielts",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent",children:"IELTS Writing Tests"}),a.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage writing test content and questions"})]}),a.jsx(n,{onClick:()=>R("/admin/ielts"),variant:"outline",children:"Writing Management"})]}),a.jsxs(i,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[a.jsxs(r,{children:[a.jsxs(l,{className:"flex items-center gap-2",children:[a.jsx(o,{className:"w-5 h-5"}),"Create New Writing Test"]}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Add a new IELTS writing test to your collection"})]}),a.jsxs(c,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsxs(d,{htmlFor:"test-name",className:"text-base font-medium",children:["Test Name ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(m,{id:"test-name",value:D,onChange:e=>V(e.target.value),placeholder:"Test name (e.g., Writing Test 1)",disabled:P,className:"h-11"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs(d,{htmlFor:"training-type",className:"text-base font-semibold text-foreground block",children:["Training Type ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs(x,{value:K,onValueChange:e=>{console.log("Training type changed to:",e),H(e)},disabled:P,children:[a.jsx(u,{id:"training-type",className:"w-full h-12 border-2 border-primary/40 focus:ring-2 focus:ring-primary bg-background font-semibold text-foreground shadow-md hover:border-primary/60 transition-colors",children:a.jsx(g,{})}),a.jsxs(h,{className:"z-[100]",children:[a.jsx(p,{value:"Academic",children:"Academic Training"}),a.jsx(p,{value:"General",children:"General Training"})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose Academic for data description tasks or General for letter writing tasks"}),a.jsxs("p",{className:"text-sm text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded",children:["Selected: ","Academic"===K?"Academic Training":"General Training"]})]})]}),a.jsx("div",{className:"flex justify-end pt-2",children:a.jsxs(n,{onClick:ee,disabled:P||!D.trim(),className:"bg-primary hover:bg-primary/90 w-full md:w-auto min-w-[140px] h-11",children:[a.jsx(o,{className:"w-4 h-4 mr-2"}),"Create Test"]})})]})]}),a.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[a.jsxs(i,{children:[a.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(l,{className:"text-sm font-medium",children:"Total Tests"}),a.jsx(j,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(c,{children:[a.jsx("div",{className:"text-2xl font-bold",children:$.length}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"IELTS Writing tests created"})]})]}),a.jsxs(i,{children:[a.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(l,{className:"text-sm font-medium",children:"Active Tests"}),a.jsx(y,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(c,{children:[a.jsx("div",{className:"text-2xl font-bold",children:$.length}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Available for students"})]})]}),a.jsxs(i,{children:[a.jsxs(r,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[a.jsx(l,{className:"text-sm font-medium",children:"Completion Rate"}),a.jsx(M,{className:"h-4 w-4 text-muted-foreground"})]}),a.jsxs(c,{children:[a.jsx("div",{className:"text-2xl font-bold",children:"85%"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Student completion rate"})]})]})]}),a.jsxs("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:[$.map(e=>a.jsxs(i,{className:"hover:shadow-lg transition-all duration-200 cursor-pointer border-border/40 bg-card/50 backdrop-blur-sm",onClick:()=>!X&&R(`/admin/ielts/test/${e.id}/writing`),children:[a.jsxs(r,{className:"pb-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex items-center space-x-2 flex-1 mr-2",children:X===e.id?a.jsxs("div",{className:"flex items-center space-x-2 flex-1",onClick:e=>e.stopPropagation(),children:[a.jsx(m,{value:U,onChange:e=>B(e.target.value),className:"text-lg font-semibold h-8",onKeyPress:e=>"Enter"===e.key&&te()}),a.jsx(n,{size:"sm",variant:"ghost",onClick:te,children:a.jsx(f,{className:"w-4 h-4 text-green-600"})}),a.jsx(n,{size:"sm",variant:"ghost",onClick:se,children:a.jsx(b,{className:"w-4 h-4 text-red-600"})})]}):a.jsx(l,{className:"text-lg font-semibold text-foreground",children:e.test_name})}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(N,{variant:"secondary",children:"Writing"}),a.jsx(N,{variant:"General"===(e.test_subtype||e.training_type)?"default":"outline",className:"General"===(e.test_subtype||e.training_type)?"bg-green-600 text-white":"",children:"General"===(e.test_subtype||e.training_type)?"General":"Academic"}),X!==e.id&&a.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[a.jsx(n,{size:"sm",variant:"ghost",onClick:s=>{s.stopPropagation(),(e=>{q(e.id),B(e.test_name)})(e)},children:a.jsx(W,{className:"w-4 h-4"})}),a.jsxs(I,{children:[a.jsx(T,{asChild:!0,children:a.jsx(n,{size:"sm",variant:"ghost",onClick:e=>e.stopPropagation(),children:a.jsx(F,{className:"w-4 h-4 text-red-600"})})}),a.jsxs(v,{className:"z-50",children:[a.jsxs(k,{children:[a.jsx(_,{children:"Delete Test"}),a.jsxs(C,{children:['Are you sure you want to delete "',e.test_name,'"? This will also delete all questions associated with this test. This action cannot be undone.']})]}),a.jsxs(S,{children:[a.jsx(E,{children:"Cancel"}),a.jsx(J,{onClick:s=>{s.stopPropagation(),(async(e,s)=>{try{console.log("ðŸ—‘ï¸ Deleting test via edge function:",e);const t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",a=`${Z}/functions/v1/delete-test`;console.log("ðŸ”— Edge Function URL:",a),console.log("ðŸ“¤ Sending testId:",e);const n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",apikey:t,Authorization:`Bearer ${t}`},body:JSON.stringify({testId:e})});console.log("ðŸ“Š Delete response status:",n.status),console.log("ðŸ“Š Delete response ok:",n.ok);const i=await n.text();if(console.log("ðŸ“„ Delete response body:",i),!n.ok)throw console.error("âŒ Delete function returned error status:",n.status),new Error(`Failed to delete test: ${n.status} - ${i}`);const r=JSON.parse(i);console.log("âœ… Test deleted successfully:",r),w.success(`Test "${s}" deleted successfully`),await Q()}catch(t){console.error("âŒ Delete test error:",t),console.error("Error details:",{message:null==t?void 0:t.message,stack:null==t?void 0:t.stack}),w.error(`Failed to delete test: ${(null==t?void 0:t.message)||"Unknown error"}`)}})(e.id,e.test_name)},className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Task 1 & Task 2 â€¢ 60 minutes total"}),a.jsx(N,{variant:"General"===(e.test_subtype||e.training_type)?"default":"outline",className:"General"===(e.test_subtype||e.training_type)?"bg-green-600 text-white text-xs":"text-xs",children:"General"===(e.test_subtype||e.training_type)?"General":"Academic"})]})]}),a.jsxs(c,{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:[a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(y,{className:"w-3 h-3"}),a.jsxs("span",{children:["Created ",new Date(e.created_at).toLocaleDateString()]})]}),a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(j,{className:"w-3 h-3"}),a.jsx("span",{children:"2 tasks"})]})]}),a.jsx(n,{className:"w-full bg-primary hover:bg-primary/90 text-primary-foreground",onClick:s=>{s.stopPropagation(),R(`/admin/ielts/test/${e.id}/writing`)},disabled:X===e.id,children:"Manage Writing Content"})]})]},e.id)),0===$.length&&a.jsxs("div",{className:"col-span-full text-center py-12",children:[a.jsx(j,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No writing tests created yet"}),a.jsx("p",{className:"text-muted-foreground mb-4",children:"Create your first IELTS Writing test to get started"}),a.jsxs(n,{onClick:ee,disabled:P,children:[a.jsx(o,{className:"w-4 h-4 mr-2"}),"Create First Test"]})]})]})]})}):null};export{R as default};
