import{G as e,u as s,g as t,h as a,r as i,j as n,B as r,l,C as o,a as c,S as d,p as m,q as u,s as h,t as g,b as x,d as p,F as j,O as f,T as b,I as v}from"./index-CbHGm2wy.js";import{S as y}from"./separator-BzX02cz3.js";import{A as w}from"./AdminLayout-DXUTYLMQ.js";import{s as k}from"./supabase-DWL4C3fA.js";import{A as N,d as T}from"./cloudflare-r2-Bg99fdQ0.js";import{I as C}from"./image-BniWLEnL.js";import{U as I}from"./upload-DcMBuW1v.js";import{T as A}from"./trash-2-BIGXYqpk.js";import{S as _}from"./save-c-WOBokR.js";const E=()=>{const{testId:E}=e(),S=s(),{createContent:q,updateContent:U,loading:F}=t(),{toast:$}=a(),[M,L]=i.useState(null),[O,B]=i.useState("Academic"),[G,W]=i.useState({id:null,instructions:"",imageUrl:"",imageContext:"",modelAnswer:""}),[R,D]=i.useState(null),[z,J]=i.useState(!1),[P,Z]=i.useState({id:null,instructions:"",modelAnswer:""}),[V,Y]=i.useState(!1),[X,Q]=i.useState(!1),[H,K]=i.useState(!0);i.useEffect(()=>{E&&ee()},[E]),i.useEffect(()=>{if(M){const e=M.test_subtype||M.training_type;if(e){const s="General"===e?"General":"Academic";console.log("ðŸ”„ Syncing trainingType from test data:",s,"Current:",O),B(s)}}},[null==M?void 0:M.test_subtype,null==M?void 0:M.training_type]);const ee=async()=>{try{if(console.log("ðŸ“ Loading test data for testId:",E),!E)return console.error("âŒ No testId provided!"),void K(!1);K(!0);const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",s="https://cuumxmfzhwljylbdlflj.supabase.co",t=new AbortController,a=setTimeout(()=>t.abort(),5e3);try{console.log("ðŸ“ Fetching test details via REST API...");const a=await fetch(`${s}/rest/v1/tests?id=eq.${E}&select=*`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(!a.ok)throw new Error(`Test fetch failed: ${a.status}`);const i=await a.json(),n=null==i?void 0:i[0];if(!n)return console.error("âŒ Test not found:",E),K(!1),void L({});console.log("âœ… Test loaded:",n),console.log("ðŸ“‹ Test subtype from test data:",n.test_subtype,"Training type:",n.training_type),L(n);const r="General"===n.test_subtype||"General"===n.training_type?"General":"Academic";console.log("ðŸŽ¯ Setting training type to:",r),B(r),console.log("ðŸ“ Fetching questions via REST API...");const l=await fetch(`${s}/rest/v1/questions?test_id=eq.${E}&question_type=in.("Task 1","Task 2")&order=part_number.asc`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(l.ok){const e=await l.json();if(console.log("âœ… Questions loaded:",(null==e?void 0:e.length)||0),e&&e.length>0){const s=e.find(e=>1===e.part_number),t=e.find(e=>2===e.part_number);s&&W({id:s.id,instructions:s.passage_text||"",imageUrl:s.image_url||"",imageContext:s.explanation||"",modelAnswer:s.transcription||""}),t&&Z({id:t.id,instructions:t.passage_text||"",modelAnswer:t.transcription||""});const a=s&&t&&s.question_text&&t.question_text;Y(Boolean(a))}}console.log("âœ… Test data loading complete")}finally{clearTimeout(a)}}catch(e){console.error("âŒ Error loading test data:",e)}finally{K(!1)}},se=async e=>{try{const s=1===e?G:P,t={test_id:E,part_number:e,question_number_in_part:1,question_text:`Task ${e}`,passage_text:s.instructions,question_type:`Task ${e}`,correct_answer:"N/A",transcription:s.modelAnswer};if(1===e&&("Academic"===O?(t.image_url=G.imageUrl||null,t.explanation=G.imageContext||null):(t.image_url=null,t.explanation=null)),s.id){const{error:e}=await k.from("questions").update(t).eq("id",s.id);if(e)throw e}else{const{data:s,error:a}=await k.from("questions").insert(t).select().single();if(a)throw a;1===e?W(e=>({...e,id:s.id})):Z(e=>({...e,id:s.id}))}const{data:a}=await k.from("questions").select("*").eq("test_id",E).in("question_type",["Task 1","Task 2"]);a&&2===a.length&&(Y(!0),Q(!1)),$({title:"Success",description:`Task ${e} saved successfully`})}catch(s){console.error(`Error saving Task ${e}:`,s),$({title:"Error",description:s.message||`Failed to save Task ${e}`,variant:"destructive"})}};return H?n.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),n.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading test data..."})]})}):M&&0!==Object.keys(M).length?n.jsx(w,{title:`Writing Test - ${M.test_name}`,showBackButton:!0,backPath:"/admin/ielts/writing",children:n.jsxs("div",{className:"space-y-8",children:[n.jsx("div",{className:"flex items-center justify-between",children:n.jsxs("div",{children:[n.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent",children:M.test_name}),n.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage Task 1 and Task 2 content for this IELTS Writing test"}),V&&!X&&n.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[n.jsx(l,{variant:"default",className:"bg-green-600",children:"Locked & Complete"}),n.jsx(r,{onClick:()=>Q(!0),variant:"outline",size:"sm",children:"Modify Content"})]})]})}),n.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:n.jsx(c,{className:"pt-6",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"text-lg font-semibold",children:"Training Type"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose the training type for this test"})]}),n.jsxs(d,{value:O,onValueChange:e=>{console.log("Training type manually changed to:",e),B(e)},children:[n.jsx(m,{className:"w-[180px]",children:n.jsx(u,{})}),n.jsxs(h,{children:[n.jsx(g,{value:"Academic",children:"Academic Training"}),n.jsx(g,{value:"General",children:"General Training"})]})]})]})})}),!1,n.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[n.jsxs(x,{children:[n.jsxs(p,{className:"flex items-center gap-2",children:["Academic"===O?n.jsx(C,{className:"w-5 h-5"}):n.jsx(j,{className:"w-5 h-5"}),"Task 1 - ","Academic"===O?"Data Description":"Task Instructions"]}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Academic"===O?"Task 1 requires students to describe visual information (graphs, charts, tables, etc.)":"Task 1 requires students to follow the given instructions to complete the writing task"})]}),n.jsxs(c,{className:"space-y-6",children:[n.jsxs("div",{style:{background:"red",color:"white",padding:"10px",margin:"10px 0"},children:['DEBUG: trainingType = "',O,'" | test.test_subtype = "',null==M?void 0:M.test_subtype,'" | test.training_type = "',null==M?void 0:M.training_type,'"']}),"Academic"===O&&n.jsxs("div",{style:{background:"green",color:"white",padding:"10px",margin:"10px 0"},children:["ACADEMIC MODE ACTIVE",n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-instructions",children:"Task Instructions"}),n.jsx(b,{id:"task1-instructions",rows:6,value:G.instructions,onChange:e=>W(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:V&&!X,className:"text-black"})]})]}),"Academic"===O&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-image",children:"Upload Image"}),n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx(v,{id:"task1-image",type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(D(t),(async e=>{if(E){J(!0);try{const s=await N.uploadWritingImage(e,E);if(!s.success||!s.url)throw new Error(s.error||"Upload failed");W(e=>({...e,imageUrl:s.url})),D(null),$({title:"Success",description:"Image uploaded successfully to Cloudflare R2"})}catch(s){console.error("Error uploading file:",s),$({title:"Error",description:s.message||"Failed to upload image",variant:"destructive"})}finally{J(!1)}}else $({title:"Error",description:"Test ID is required for image upload",variant:"destructive"})})(t))},disabled:z||V&&!X}),n.jsxs(r,{type:"button",variant:"outline",size:"sm",disabled:z||V&&!X,onClick:()=>{var e;return null==(e=document.getElementById("task1-image"))?void 0:e.click()},children:[n.jsx(I,{className:"w-4 h-4 mr-2"}),z?"Uploading...":"Choose File"]})]}),G.imageUrl&&n.jsxs("div",{className:"mt-2",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Current image:"}),n.jsxs(r,{type:"button",variant:"destructive",size:"sm",onClick:async()=>{try{if(G.imageUrl){let e="";if(G.imageUrl.includes("r2.dev")||G.imageUrl.includes("cloudflarestorage.com")){const s=new URL(G.imageUrl);e=s.pathname.startsWith("/")?s.pathname.slice(1):s.pathname}else if(G.imageUrl.includes("ielts-writing/")){const s=G.imageUrl.match(/ielts-writing\/[^/]+\/(.+)$/);s&&E&&(e=`ielts-writing/${E}/${s[1]}`)}if(e){await T(e)||console.warn("Failed to delete file from R2, but continuing...")}else console.warn("Could not extract R2 key from URL, skipping deletion");W(e=>({...e,imageUrl:""})),$({title:"Success",description:"Image deleted successfully"})}}catch(e){console.error("Error deleting image:",e),$({title:"Error",description:e.message||"Failed to delete image",variant:"destructive"})}},disabled:V&&!X,children:[n.jsx(A,{className:"w-4 h-4 mr-2"}),"Delete Image"]})]}),n.jsx("img",{src:G.imageUrl,alt:"Task 1 chart/graph",className:"max-w-full h-48 object-contain border rounded-md"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-context",children:"Image Context Description"}),n.jsx(b,{id:"task1-context",rows:4,value:G.imageContext,onChange:e=>W(s=>({...s,imageContext:e.target.value})),placeholder:"Detailed description of the image/chart for accessibility and context...",disabled:V&&!X,className:"text-black"})]})]}),"General"===O&&n.jsxs("div",{style:{background:"blue",color:"white",padding:"10px",margin:"10px 0"},children:["GENERAL MODE ACTIVE",n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-instructions-general",children:"Task Instructions"}),n.jsx(b,{id:"task1-instructions-general",rows:8,value:G.instructions,onChange:e=>W(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:V&&!X,className:"text-black"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-model-answer",children:"Model Answer (Optional)"}),n.jsx(b,{id:"task1-model-answer",rows:6,value:G.modelAnswer,onChange:e=>W(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample answer for Task 1 that students can view after completing the test...",disabled:V&&!X,className:"text-black"}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),n.jsxs(r,{onClick:()=>se(1),disabled:F||V&&!X,className:"w-full",children:[n.jsx(_,{className:"w-4 h-4 mr-2"}),"Save Task 1"]})]})]}),n.jsx(y,{}),n.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[n.jsxs(x,{children:[n.jsxs(p,{className:"flex items-center gap-2",children:[n.jsx(j,{className:"w-5 h-5"}),"Task 2 - Essay Writing"]}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Task 2 requires students to write an argumentative essay on a given topic"})]}),n.jsxs(c,{className:"space-y-6",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task2-instructions",children:"Essay Question & Instructions"}),n.jsx(b,{id:"task2-instructions",rows:8,value:P.instructions,onChange:e=>Z(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete essay question and instructions here...",disabled:V&&!X})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task2-model-answer",children:"Model Answer (Optional)"}),n.jsx(b,{id:"task2-model-answer",rows:8,value:P.modelAnswer,onChange:e=>Z(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample essay for Task 2 that students can view after completing the test...",disabled:V&&!X}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),n.jsxs(r,{onClick:()=>se(2),disabled:F||V&&!X,className:"w-full",children:[n.jsx(_,{className:"w-4 h-4 mr-2"}),"Save Task 2"]})]})]}),n.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:n.jsx(c,{className:"pt-6",children:n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Total Time"}),n.jsx("p",{className:"font-medium",children:"60 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Task 1 Time"}),n.jsx("p",{className:"font-medium",children:"20 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Task 2 Time"}),n.jsx("p",{className:"font-medium",children:"40 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Test Type"}),n.jsx("p",{className:"font-medium",children:"IELTS Writing"})]})]})})})]})}):n.jsx(w,{title:"Writing Test",showBackButton:!0,backPath:"/admin/ielts/writing",children:n.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:n.jsxs("div",{className:"text-center",children:[n.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Error Loading Test"}),n.jsx("p",{className:"text-muted-foreground mb-4",children:"Could not load the test data. Please try again."}),n.jsx(r,{onClick:()=>S("/admin/ielts/writing"),children:"Back to Tests"})]})})})};export{E as default};
