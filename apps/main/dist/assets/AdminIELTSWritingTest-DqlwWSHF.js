import{c as e,u as s,r as t,j as a}from"./vendor-react-rLLBBC7n.js";import{u as i,d as n,B as r,e as l,C as o,a as c,S as d,i as m,j as u,k as h,l as g,b as x,c as p,L as j,T as f,I as v,s as b}from"./index-KxDfHqNJ.js";import{S as y}from"./separator-DByOkGf1.js";import{A as w}from"./AdminLayout-DGXoIbe0.js";import{A as k,d as N}from"./cloudflare-r2-NK5E1VTl.js";import{aS as T,ap as C,aV as I,aY as A,b5 as _}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const E=()=>{const{testId:E}=e(),S=s(),{createContent:q,updateContent:U,loading:F}=i(),{toast:$}=n(),[M,L]=t.useState(null),[B,O]=t.useState("Academic"),[W,G]=t.useState({id:null,instructions:"",imageUrl:"",imageContext:"",modelAnswer:""}),[R,D]=t.useState(null),[z,J]=t.useState(!1),[P,V]=t.useState({id:null,instructions:"",modelAnswer:""}),[Y,Z]=t.useState(!1),[X,Q]=t.useState(!1),[H,K]=t.useState(!0);t.useEffect(()=>{E&&ee()},[E]),t.useEffect(()=>{if(M){const e=M.test_subtype||M.training_type;if(e){const s="General"===e?"General":"Academic";console.log("ðŸ”„ Syncing trainingType from test data:",s,"Current:",B),O(s)}}},[null==M?void 0:M.test_subtype,null==M?void 0:M.training_type]);const ee=async()=>{try{if(console.log("ðŸ“ Loading test data for testId:",E),!E)return console.error("âŒ No testId provided!"),void K(!1);K(!0);const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",s="https://cuumxmfzhwljylbdlflj.supabase.co",t=new AbortController,a=setTimeout(()=>t.abort(),5e3);try{console.log("ðŸ“ Fetching test details via REST API...");const a=await fetch(`${s}/rest/v1/tests?id=eq.${E}&select=*`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(!a.ok)throw new Error(`Test fetch failed: ${a.status}`);const i=await a.json(),n=null==i?void 0:i[0];if(!n)return console.error("âŒ Test not found:",E),K(!1),void L({});console.log("âœ… Test loaded:",n),console.log("ðŸ“‹ Test subtype from test data:",n.test_subtype,"Training type:",n.training_type),L(n);const r="General"===n.test_subtype||"General"===n.training_type?"General":"Academic";console.log("ðŸŽ¯ Setting training type to:",r),O(r),console.log("ðŸ“ Fetching questions via REST API...");const l=await fetch(`${s}/rest/v1/questions?test_id=eq.${E}&question_type=in.("Task 1","Task 2")&order=part_number.asc`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(l.ok){const e=await l.json();if(console.log("âœ… Questions loaded:",(null==e?void 0:e.length)||0),e&&e.length>0){const s=e.find(e=>1===e.part_number),t=e.find(e=>2===e.part_number);s&&G({id:s.id,instructions:s.passage_text||"",imageUrl:s.image_url||"",imageContext:s.explanation||"",modelAnswer:s.transcription||""}),t&&V({id:t.id,instructions:t.passage_text||"",modelAnswer:t.transcription||""});const a=s&&t&&s.question_text&&t.question_text;Z(Boolean(a))}}console.log("âœ… Test data loading complete")}finally{clearTimeout(a)}}catch(e){console.error("âŒ Error loading test data:",e)}finally{K(!1)}},se=async e=>{try{const s=1===e?W:P,t={test_id:E,part_number:e,question_number_in_part:1,question_text:`Task ${e}`,passage_text:s.instructions,question_type:`Task ${e}`,correct_answer:"N/A",transcription:s.modelAnswer};if(1===e&&("Academic"===B?(t.image_url=W.imageUrl||null,t.explanation=W.imageContext||null):(t.image_url=null,t.explanation=null)),s.id){const{error:e}=await b.from("questions").update(t).eq("id",s.id);if(e)throw e}else{const{data:s,error:a}=await b.from("questions").insert(t).select().single();if(a)throw a;1===e?G(e=>({...e,id:s.id})):V(e=>({...e,id:s.id}))}const{data:a}=await b.from("questions").select("*").eq("test_id",E).in("question_type",["Task 1","Task 2"]);a&&2===a.length&&(Z(!0),Q(!1)),$({title:"Success",description:`Task ${e} saved successfully`})}catch(s){console.error(`Error saving Task ${e}:`,s),$({title:"Error",description:s.message||`Failed to save Task ${e}`,variant:"destructive"})}};return H?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading test data..."})]})}):M&&0!==Object.keys(M).length?a.jsx(w,{title:`Writing Test - ${M.test_name}`,showBackButton:!0,backPath:"/admin/ielts/writing",children:a.jsxs("div",{className:"space-y-8",children:[a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent",children:M.test_name}),a.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage Task 1 and Task 2 content for this IELTS Writing test"}),Y&&!X&&a.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[a.jsx(l,{variant:"default",className:"bg-green-600",children:"Locked & Complete"}),a.jsx(r,{onClick:()=>Q(!0),variant:"outline",size:"sm",children:"Modify Content"})]})]})}),a.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:a.jsx(c,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold",children:"Training Type"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose the training type for this test"})]}),a.jsxs(d,{value:B,onValueChange:e=>{console.log("Training type manually changed to:",e),O(e)},children:[a.jsx(m,{className:"w-[180px]",children:a.jsx(u,{})}),a.jsxs(h,{children:[a.jsx(g,{value:"Academic",children:"Academic Training"}),a.jsx(g,{value:"General",children:"General Training"})]})]})]})})}),!1,a.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[a.jsxs(x,{children:[a.jsxs(p,{className:"flex items-center gap-2",children:["Academic"===B?a.jsx(T,{className:"w-5 h-5"}):a.jsx(C,{className:"w-5 h-5"}),"Task 1 - ","Academic"===B?"Data Description":"Task Instructions"]}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Academic"===B?"Task 1 requires students to describe visual information (graphs, charts, tables, etc.)":"Task 1 requires students to follow the given instructions to complete the writing task"})]}),a.jsxs(c,{className:"space-y-6",children:[a.jsxs("div",{style:{background:"red",color:"white",padding:"10px",margin:"10px 0"},children:['DEBUG: trainingType = "',B,'" | test.test_subtype = "',null==M?void 0:M.test_subtype,'" | test.training_type = "',null==M?void 0:M.training_type,'"']}),"Academic"===B&&a.jsxs("div",{style:{background:"green",color:"white",padding:"10px",margin:"10px 0"},children:["ACADEMIC MODE ACTIVE",a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task1-instructions",children:"Task Instructions"}),a.jsx(f,{id:"task1-instructions",rows:6,value:W.instructions,onChange:e=>G(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:Y&&!X,className:"text-black"})]})]}),"Academic"===B&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task1-image",children:"Upload Image"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(v,{id:"task1-image",type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(D(t),(async e=>{if(E){J(!0);try{const s=await k.uploadWritingImage(e,E);if(!s.success||!s.url)throw new Error(s.error||"Upload failed");G(e=>({...e,imageUrl:s.url})),D(null),$({title:"Success",description:"Image uploaded successfully to Cloudflare R2"})}catch(s){console.error("Error uploading file:",s),$({title:"Error",description:s.message||"Failed to upload image",variant:"destructive"})}finally{J(!1)}}else $({title:"Error",description:"Test ID is required for image upload",variant:"destructive"})})(t))},disabled:z||Y&&!X}),a.jsxs(r,{type:"button",variant:"outline",size:"sm",disabled:z||Y&&!X,onClick:()=>{var e;return null==(e=document.getElementById("task1-image"))?void 0:e.click()},children:[a.jsx(I,{className:"w-4 h-4 mr-2"}),z?"Uploading...":"Choose File"]})]}),W.imageUrl&&a.jsxs("div",{className:"mt-2",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Current image:"}),a.jsxs(r,{type:"button",variant:"destructive",size:"sm",onClick:async()=>{try{if(W.imageUrl){let e="";if(W.imageUrl.includes("r2.dev")||W.imageUrl.includes("cloudflarestorage.com")){const s=new URL(W.imageUrl);e=s.pathname.startsWith("/")?s.pathname.slice(1):s.pathname}else if(W.imageUrl.includes("ielts-writing/")){const s=W.imageUrl.match(/ielts-writing\/[^/]+\/(.+)$/);s&&E&&(e=`ielts-writing/${E}/${s[1]}`)}if(e){await N(e)||console.warn("Failed to delete file from R2, but continuing...")}else console.warn("Could not extract R2 key from URL, skipping deletion");G(e=>({...e,imageUrl:""})),$({title:"Success",description:"Image deleted successfully"})}}catch(e){console.error("Error deleting image:",e),$({title:"Error",description:e.message||"Failed to delete image",variant:"destructive"})}},disabled:Y&&!X,children:[a.jsx(A,{className:"w-4 h-4 mr-2"}),"Delete Image"]})]}),a.jsx("img",{src:W.imageUrl,alt:"Task 1 chart/graph",className:"max-w-full h-48 object-contain border rounded-md"})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task1-context",children:"Image Context Description"}),a.jsx(f,{id:"task1-context",rows:4,value:W.imageContext,onChange:e=>G(s=>({...s,imageContext:e.target.value})),placeholder:"Detailed description of the image/chart for accessibility and context...",disabled:Y&&!X,className:"text-black"})]})]}),"General"===B&&a.jsxs("div",{style:{background:"blue",color:"white",padding:"10px",margin:"10px 0"},children:["GENERAL MODE ACTIVE",a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task1-instructions-general",children:"Task Instructions"}),a.jsx(f,{id:"task1-instructions-general",rows:8,value:W.instructions,onChange:e=>G(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:Y&&!X,className:"text-black"})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task1-model-answer",children:"Model Answer (Optional)"}),a.jsx(f,{id:"task1-model-answer",rows:6,value:W.modelAnswer,onChange:e=>G(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample answer for Task 1 that students can view after completing the test...",disabled:Y&&!X,className:"text-black"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),a.jsxs(r,{onClick:()=>se(1),disabled:F||Y&&!X,className:"w-full",children:[a.jsx(_,{className:"w-4 h-4 mr-2"}),"Save Task 1"]})]})]}),a.jsx(y,{}),a.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[a.jsxs(x,{children:[a.jsxs(p,{className:"flex items-center gap-2",children:[a.jsx(C,{className:"w-5 h-5"}),"Task 2 - Essay Writing"]}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Task 2 requires students to write an argumentative essay on a given topic"})]}),a.jsxs(c,{className:"space-y-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task2-instructions",children:"Essay Question & Instructions"}),a.jsx(f,{id:"task2-instructions",rows:8,value:P.instructions,onChange:e=>V(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete essay question and instructions here...",disabled:Y&&!X})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(j,{htmlFor:"task2-model-answer",children:"Model Answer (Optional)"}),a.jsx(f,{id:"task2-model-answer",rows:8,value:P.modelAnswer,onChange:e=>V(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample essay for Task 2 that students can view after completing the test...",disabled:Y&&!X}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),a.jsxs(r,{onClick:()=>se(2),disabled:F||Y&&!X,className:"w-full",children:[a.jsx(_,{className:"w-4 h-4 mr-2"}),"Save Task 2"]})]})]}),a.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:a.jsx(c,{className:"pt-6",children:a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-muted-foreground",children:"Total Time"}),a.jsx("p",{className:"font-medium",children:"60 minutes"})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-muted-foreground",children:"Task 1 Time"}),a.jsx("p",{className:"font-medium",children:"20 minutes"})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-muted-foreground",children:"Task 2 Time"}),a.jsx("p",{className:"font-medium",children:"40 minutes"})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-muted-foreground",children:"Test Type"}),a.jsx("p",{className:"font-medium",children:"IELTS Writing"})]})]})})})]})}):a.jsx(w,{title:"Writing Test",showBackButton:!0,backPath:"/admin/ielts/writing",children:a.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:a.jsxs("div",{className:"text-center",children:[a.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Error Loading Test"}),a.jsx("p",{className:"text-muted-foreground mb-4",children:"Could not load the test data. Please try again."}),a.jsx(r,{onClick:()=>S("/admin/ielts/writing"),children:"Back to Tests"})]})})})};export{E as default};
