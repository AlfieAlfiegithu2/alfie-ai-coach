import{G as e,u as s,g as t,h as a,r as i,j as n,B as r,l,C as o,a as c,S as d,p as m,q as u,s as h,t as g,b as x,d as p,F as j,R as f,T as w,I as b,av as v,O as y}from"./index-CueKeSri.js";import{S as k}from"./separator-CeDTRGF2.js";import{A as N}from"./AdminLayout-FMQOp4pR.js";import{s as T}from"./supabase-DWL4C3fA.js";import{A as C,d as A}from"./cloudflare-r2-Bg99fdQ0.js";import{I}from"./image-wxePJSdf.js";import{U as _}from"./upload-DkRK0Xfo.js";import{T as E}from"./trash-2-tdc7ypsp.js";import{S}from"./save-D4x7baEM.js";const F=()=>{const{testId:F}=e(),q=s(),{createContent:U,updateContent:G,loading:$}=t(),{toast:M}=a(),[O,R]=i.useState(null),[B,L]=i.useState("Academic"),[W,z]=i.useState({id:null,instructions:"",imageUrl:"",imageContext:"",modelAnswer:""}),[D,P]=i.useState(null),[J,Z]=i.useState(!1),[V,Y]=i.useState({id:null,instructions:"",modelAnswer:""}),[X,Q]=i.useState(!1),[H,K]=i.useState(!1),[ee,se]=i.useState(!0),[te,ae]=i.useState(!1),[ie,ne]=i.useState(!1);i.useEffect(()=>{F&&re()},[F]),i.useEffect(()=>{if(O){const e=O.test_subtype||O.training_type;if(e){const s="General"===e?"General":"Academic";console.log("ðŸ”„ Syncing trainingType from test data:",s,"Current:",B),L(s)}}},[null==O?void 0:O.test_subtype,null==O?void 0:O.training_type]);const re=async()=>{try{if(console.log("ðŸ“ Loading test data for testId:",F),!F)return console.error("âŒ No testId provided!"),void se(!1);se(!0);const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dW14bWZ6aHdsanlsYmRsZmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTkxMjEsImV4cCI6MjA2OTA5NTEyMX0.8jqO_ciOttSxSLZnKY0i5oJmEn79ROF53TjUMYhNemI",s="https://cuumxmfzhwljylbdlflj.supabase.co",t=new AbortController,a=setTimeout(()=>t.abort(),5e3);try{console.log("ðŸ“ Fetching test details via REST API...");const a=await fetch(`${s}/rest/v1/tests?id=eq.${F}&select=*`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(!a.ok)throw new Error(`Test fetch failed: ${a.status}`);const i=await a.json(),n=null==i?void 0:i[0];if(!n)return console.error("âŒ Test not found:",F),se(!1),void R({});console.log("âœ… Test loaded:",n),console.log("ðŸ“‹ Test subtype from test data:",n.test_subtype,"Training type:",n.training_type),R(n);const r="General"===n.test_subtype||"General"===n.training_type?"General":"Academic";console.log("ðŸŽ¯ Setting training type to:",r),L(r),console.log("ðŸ“ Fetching questions via REST API...");const l=await fetch(`${s}/rest/v1/questions?test_id=eq.${F}&question_type=in.("Task 1","Task 2")&order=part_number.asc`,{headers:{apikey:e,Authorization:`Bearer ${e}`,"Content-Type":"application/json"},signal:t.signal});if(l.ok){const e=await l.json();if(console.log("âœ… Questions loaded:",(null==e?void 0:e.length)||0),e&&e.length>0){const s=e.find(e=>1===e.part_number),t=e.find(e=>2===e.part_number);s&&z({id:s.id,instructions:s.passage_text||"",imageUrl:s.image_url||"",imageContext:s.explanation||"",modelAnswer:s.transcription||""}),t&&Y({id:t.id,instructions:t.passage_text||"",modelAnswer:t.transcription||""});const a=s&&t&&s.question_text&&t.question_text;Q(Boolean(a))}}console.log("âœ… Test data loading complete")}finally{clearTimeout(a)}}catch(e){console.error("âŒ Error loading test data:",e)}finally{se(!1)}},le=async e=>{try{const s=1===e?W:V,t={test_id:F,part_number:e,question_number_in_part:1,question_text:`Task ${e}`,passage_text:s.instructions,question_type:`Task ${e}`,correct_answer:"N/A",transcription:s.modelAnswer};if(1===e&&("Academic"===B?(t.image_url=W.imageUrl||null,t.explanation=W.imageContext||null):(t.image_url=null,t.explanation=null)),s.id){const{error:e}=await T.from("questions").update(t).eq("id",s.id);if(e)throw e}else{const{data:s,error:a}=await T.from("questions").insert(t).select().single();if(a)throw a;1===e?z(e=>({...e,id:s.id})):Y(e=>({...e,id:s.id}))}const{data:a}=await T.from("questions").select("*").eq("test_id",F).in("question_type",["Task 1","Task 2"]);a&&2===a.length&&(Q(!0),K(!1)),M({title:"Success",description:`Task ${e} saved successfully`})}catch(s){console.error(`Error saving Task ${e}:`,s),M({title:"Error",description:s.message||`Failed to save Task ${e}`,variant:"destructive"})}},oe=async e=>{const s=1===e?ae:ne,t=1===e?W:V,a=1===e?z:Y;if(t.instructions.trim()){s(!0);try{console.log(`ðŸ¤– Generating Task ${e} model answer with Gemini...`);const{data:s,error:i}=await T.functions.invoke("generate-writing-model-answer",{body:{taskNumber:e,instructions:t.instructions,imageUrl:1===e&&"Academic"===B?W.imageUrl:null,trainingType:B}});if(i)throw new Error(i.message||"Failed to generate model answer");if(!(null==s?void 0:s.success)||!(null==s?void 0:s.modelAnswer))throw new Error((null==s?void 0:s.error)||"No model answer returned");a(e=>({...e,modelAnswer:s.modelAnswer})),M({title:"Model Answer Generated!",description:`Generated ${s.wordCount} words. Review and edit as needed before saving.`})}catch(i){console.error(`âŒ Error generating Task ${e} model answer:`,i),M({title:"Generation Failed",description:i.message||"Could not generate model answer. Please try again.",variant:"destructive"})}finally{s(!1)}}else M({title:"Missing Instructions",description:"Please add task instructions before generating a model answer.",variant:"destructive"})};return ee?n.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),n.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Loading test data..."})]})}):O&&0!==Object.keys(O).length?n.jsx(N,{title:`Writing Test - ${O.test_name}`,showBackButton:!0,backPath:"/admin/ielts/writing",children:n.jsxs("div",{className:"space-y-8",children:[n.jsx("div",{className:"flex items-center justify-between",children:n.jsxs("div",{children:[n.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent",children:O.test_name}),n.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage Task 1 and Task 2 content for this IELTS Writing test"}),X&&!H&&n.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[n.jsx(l,{variant:"default",className:"bg-green-600",children:"Locked & Complete"}),n.jsx(r,{onClick:()=>K(!0),variant:"outline",size:"sm",children:"Modify Content"})]})]})}),n.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:n.jsx(c,{className:"pt-6",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"text-lg font-semibold",children:"Training Type"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose the training type for this test"})]}),n.jsxs(d,{value:B,onValueChange:e=>{console.log("Training type manually changed to:",e),L(e)},children:[n.jsx(m,{className:"w-[180px]",children:n.jsx(u,{})}),n.jsxs(h,{children:[n.jsx(g,{value:"Academic",children:"Academic Training"}),n.jsx(g,{value:"General",children:"General Training"})]})]})]})})}),!1,n.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[n.jsxs(x,{children:[n.jsxs(p,{className:"flex items-center gap-2",children:["Academic"===B?n.jsx(I,{className:"w-5 h-5"}):n.jsx(j,{className:"w-5 h-5"}),"Task 1 - ","Academic"===B?"Data Description":"Task Instructions"]}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Academic"===B?"Task 1 requires students to describe visual information (graphs, charts, tables, etc.)":"Task 1 requires students to follow the given instructions to complete the writing task"})]}),n.jsxs(c,{className:"space-y-6",children:[n.jsxs("div",{style:{background:"red",color:"white",padding:"10px",margin:"10px 0"},children:['DEBUG: trainingType = "',B,'" | test.test_subtype = "',null==O?void 0:O.test_subtype,'" | test.training_type = "',null==O?void 0:O.training_type,'"']}),"Academic"===B&&n.jsxs("div",{style:{background:"green",color:"white",padding:"10px",margin:"10px 0"},children:["ACADEMIC MODE ACTIVE",n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-instructions",children:"Task Instructions"}),n.jsx(w,{id:"task1-instructions",rows:6,value:W.instructions,onChange:e=>z(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:X&&!H,className:"text-black"})]})]}),"Academic"===B&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-image",children:"Upload Image"}),n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx(b,{id:"task1-image",type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(P(t),(async e=>{if(F){Z(!0);try{const s=await C.uploadWritingImage(e,F);if(!s.success||!s.url)throw new Error(s.error||"Upload failed");z(e=>({...e,imageUrl:s.url})),P(null),M({title:"Success",description:"Image uploaded successfully to Cloudflare R2"})}catch(s){console.error("Error uploading file:",s),M({title:"Error",description:s.message||"Failed to upload image",variant:"destructive"})}finally{Z(!1)}}else M({title:"Error",description:"Test ID is required for image upload",variant:"destructive"})})(t))},disabled:J||X&&!H}),n.jsxs(r,{type:"button",variant:"outline",size:"sm",disabled:J||X&&!H,onClick:()=>{var e;return null==(e=document.getElementById("task1-image"))?void 0:e.click()},children:[n.jsx(_,{className:"w-4 h-4 mr-2"}),J?"Uploading...":"Choose File"]})]}),W.imageUrl&&n.jsxs("div",{className:"mt-2",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Current image:"}),n.jsxs(r,{type:"button",variant:"destructive",size:"sm",onClick:async()=>{try{if(W.imageUrl){let e="";if(W.imageUrl.includes("r2.dev")||W.imageUrl.includes("cloudflarestorage.com")){const s=new URL(W.imageUrl);e=s.pathname.startsWith("/")?s.pathname.slice(1):s.pathname}else if(W.imageUrl.includes("ielts-writing/")){const s=W.imageUrl.match(/ielts-writing\/[^/]+\/(.+)$/);s&&F&&(e=`ielts-writing/${F}/${s[1]}`)}if(e){await A(e)||console.warn("Failed to delete file from R2, but continuing...")}else console.warn("Could not extract R2 key from URL, skipping deletion");z(e=>({...e,imageUrl:""})),M({title:"Success",description:"Image deleted successfully"})}}catch(e){console.error("Error deleting image:",e),M({title:"Error",description:e.message||"Failed to delete image",variant:"destructive"})}},disabled:X&&!H,children:[n.jsx(E,{className:"w-4 h-4 mr-2"}),"Delete Image"]})]}),n.jsx("img",{src:W.imageUrl,alt:"Task 1 chart/graph",className:"max-w-full h-48 object-contain border rounded-md"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-context",children:"Image Context Description"}),n.jsx(w,{id:"task1-context",rows:4,value:W.imageContext,onChange:e=>z(s=>({...s,imageContext:e.target.value})),placeholder:"Detailed description of the image/chart for accessibility and context...",disabled:X&&!H,className:"text-black"})]})]}),"General"===B&&n.jsxs("div",{style:{background:"blue",color:"white",padding:"10px",margin:"10px 0"},children:["GENERAL MODE ACTIVE",n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task1-instructions-general",children:"Task Instructions"}),n.jsx(w,{id:"task1-instructions-general",rows:8,value:W.instructions,onChange:e=>z(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete task instructions here...",disabled:X&&!H,className:"text-black"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx(f,{htmlFor:"task1-model-answer",children:"Model Answer (Optional)"}),n.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>oe(1),disabled:te||X&&!H||!W.instructions.trim(),className:"text-purple-600 border-purple-300 hover:bg-purple-50",children:te?n.jsxs(n.Fragment,{children:[n.jsx(v,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):n.jsxs(n.Fragment,{children:[n.jsx(y,{className:"w-4 h-4 mr-2"}),"Generate with AI"]})})]}),n.jsx(w,{id:"task1-model-answer",rows:6,value:W.modelAnswer,onChange:e=>z(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample answer for Task 1 that students can view after completing the test...",disabled:X&&!H,className:"text-black"}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),n.jsxs(r,{onClick:()=>le(1),disabled:$||X&&!H,className:"w-full",children:[n.jsx(S,{className:"w-4 h-4 mr-2"}),"Save Task 1"]})]})]}),n.jsx(k,{}),n.jsxs(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:[n.jsxs(x,{children:[n.jsxs(p,{className:"flex items-center gap-2",children:[n.jsx(j,{className:"w-5 h-5"}),"Task 2 - Essay Writing"]}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Task 2 requires students to write an argumentative essay on a given topic"})]}),n.jsxs(c,{className:"space-y-6",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(f,{htmlFor:"task2-instructions",children:"Essay Question & Instructions"}),n.jsx(w,{id:"task2-instructions",rows:8,value:V.instructions,onChange:e=>Y(s=>({...s,instructions:e.target.value})),placeholder:"Write the complete essay question and instructions here...",disabled:X&&!H})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx(f,{htmlFor:"task2-model-answer",children:"Model Answer (Optional)"}),n.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>oe(2),disabled:ie||X&&!H||!V.instructions.trim(),className:"text-purple-600 border-purple-300 hover:bg-purple-50",children:ie?n.jsxs(n.Fragment,{children:[n.jsx(v,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):n.jsxs(n.Fragment,{children:[n.jsx(y,{className:"w-4 h-4 mr-2"}),"Generate with AI"]})})]}),n.jsx(w,{id:"task2-model-answer",rows:8,value:V.modelAnswer,onChange:e=>Y(s=>({...s,modelAnswer:e.target.value})),placeholder:"Provide a high-band sample essay for Task 2 that students can view after completing the test...",disabled:X&&!H}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"This model answer will be shown to students after they complete the test"})]}),n.jsxs(r,{onClick:()=>le(2),disabled:$||X&&!H,className:"w-full",children:[n.jsx(S,{className:"w-4 h-4 mr-2"}),"Save Task 2"]})]})]}),n.jsx(o,{className:"border-border/40 bg-card/50 backdrop-blur-sm",children:n.jsx(c,{className:"pt-6",children:n.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Total Time"}),n.jsx("p",{className:"font-medium",children:"60 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Task 1 Time"}),n.jsx("p",{className:"font-medium",children:"20 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Task 2 Time"}),n.jsx("p",{className:"font-medium",children:"40 minutes"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-muted-foreground",children:"Test Type"}),n.jsx("p",{className:"font-medium",children:"IELTS Writing"})]})]})})})]})}):n.jsx(N,{title:"Writing Test",showBackButton:!0,backPath:"/admin/ielts/writing",children:n.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:n.jsxs("div",{className:"text-center",children:[n.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Error Loading Test"}),n.jsx("p",{className:"text-muted-foreground mb-4",children:"Could not load the test data. Please try again."}),n.jsx(r,{onClick:()=>q("/admin/ielts/writing"),children:"Back to Tests"})]})})})};export{F as default};
