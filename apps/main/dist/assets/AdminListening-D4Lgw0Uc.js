import{g as e,h as s,r as t,j as a,B as n,C as i,a as r,I as l,b as o,i as c,k as d,V as m,d as u,l as x,P as h,D as j,v as b,E as p,m as g,n as v,o as N,S as f,p as C,q as y,s as w,t as _,T as S}from"./index-CFsndfmK.js";import{C as k,a as q,b as A}from"./collapsible-hs0lD1vn.js";import{C as I}from"./CSVImport-D22uM8pa.js";import{s as E}from"./supabase-DWL4C3fA.js";import{A as P}from"./AdminLayout-B_ugDz-T.js";import{U as L}from"./upload-D36hkAC5.js";import{S as O}from"./search-C4godM_9.js";import"./alert-D9Hx_pxS.js";import"./circle-alert-CLOmiy4J.js";import"./circle-help-DnTqs8vB.js";import"./download-6dHFqT6E.js";const T=()=>{const{listContent:T,createContent:U,deleteContent:F,updateContent:V,uploadAudio:$,loading:Q}=e(),{toast:z}=s(),[B,M]=t.useState({}),[D,R]=t.useState(""),[G,H]=t.useState(new Set),[J,K]=t.useState(!1),[W,X]=t.useState(20),[Y,Z]=t.useState(1),[ee,se]=t.useState(1),[te,ae]=t.useState(null),[ne,ie]=t.useState(""),[re,le]=t.useState(""),[oe,ce]=t.useState(!1),[de,me]=t.useState(""),[ue,xe]=t.useState(!1),he=t.useRef(null),je=t.useRef(null),[be,pe]=t.useState(!1);t.useEffect(()=>{ge()},[]);const ge=async()=>{try{const[e,s]=await Promise.all([T("listening_sections"),T("listening_questions")]),t=e.data||[],a=s.data||[],n={};for(let i=1;i<=20;i++){n[i]={number:i,sections:{}};for(let e=1;e<=4;e++){n[i].sections[e]={number:e,parts:{},hasContent:!1};for(let s=1;s<=4;s++)n[i].sections[e].parts[s]={number:s,section:null,questions:[],hasContent:!1}}}t.forEach(e=>{var s;const t=null==(s=e.cambridge_book)?void 0:s.match(/\d+/),a=t?parseInt(t[0]):1,i=e.section_number||1,r=e.part_number||1;n[a]&&n[a].sections[i]&&n[a].sections[i].parts[r]&&(n[a].sections[i].parts[r].section=e,n[a].sections[i].parts[r].hasContent=!0,n[a].sections[i].hasContent=!0)}),a.forEach(e=>{var s;if(e.section_id){const a=t.find(s=>s.id===e.section_id);if(a){const t=null==(s=a.cambridge_book)?void 0:s.match(/\d+/),i=t?parseInt(t[0]):1,r=a.section_number||1,l=a.part_number||1;n[i]&&n[i].sections[r]&&n[i].sections[r].parts[l]&&(n[i].sections[r].parts[l].questions.push(e),n[i].sections[r].parts[l].hasContent=!0,n[i].sections[r].hasContent=!0)}}else if(e.cambridge_book&&e.section_number){const s=e.cambridge_book.match(/\d+/),t=s?parseInt(s[0]):1,a=e.section_number,i=e.part_number||1;n[t]&&n[t].sections[a]&&n[t].sections[a].parts[i]&&(n[t].sections[a].parts[i].questions.push(e),n[t].sections[a].parts[i].hasContent=!0,n[t].sections[a].hasContent=!0)}}),M(n)}catch(e){z({title:"Error",description:"Failed to load Cambridge books structure",variant:"destructive"})}},ve=Object.values(B).filter(e=>{if(!D)return!0;const s=D.toLowerCase();return`cambridge ${e.number}`.includes(s)||Object.values(e.sections).some(e=>{var t,a;return null==(a=null==(t=e.section)?void 0:t.title)?void 0:a.toLowerCase().includes(s)})}).sort((e,s)=>s.number-e.number);return a.jsx(P,{title:"Cambridge IELTS Listening",children:a.jsxs("div",{className:"max-w-6xl mx-auto",children:[a.jsxs("div",{className:"flex justify-between items-center mb-8",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-4xl font-georgia font-bold text-foreground mb-2",children:"Cambridge IELTS Listening"}),a.jsx("p",{className:"text-warm-gray",children:"Manage listening content organized by Cambridge books 1-20"})]}),a.jsxs(n,{onClick:()=>K(!0),className:"rounded-xl",style:{background:"var(--gradient-button)",border:"none"},children:[a.jsx(L,{className:"w-4 h-4 mr-2"}),"Upload Content"]})]}),a.jsx(i,{className:"mb-6 rounded-2xl border-light-border",style:{background:"var(--gradient-card)"},children:a.jsx(r,{className:"p-4",children:a.jsxs("div",{className:"relative",children:[a.jsx(O,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-warm-gray w-4 h-4"}),a.jsx(l,{placeholder:"Search books or sections...",value:D,onChange:e=>R(e.target.value),className:"pl-10 rounded-xl border-light-border"})]})})}),a.jsx("div",{className:"space-y-4",children:ve.map(e=>a.jsx(i,{className:"rounded-2xl border-light-border shadow-soft",style:{background:"var(--gradient-card)"},children:a.jsxs(k,{open:G.has(e.number),onOpenChange:()=>(e=>{const s=new Set(G);s.has(e)?s.delete(e):s.add(e),H(s)})(e.number),children:[a.jsx(q,{asChild:!0,children:a.jsx(o,{className:"cursor-pointer hover:bg-white/50 transition-colors",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[G.has(e.number)?a.jsx(c,{className:"w-5 h-5"}):a.jsx(d,{className:"w-5 h-5"}),a.jsx(m,{className:"w-5 h-5"}),a.jsxs(u,{className:"text-xl font-georgia",children:["Cambridge IELTS ",e.number]})]}),a.jsx("div",{className:"flex gap-2",children:Object.values(e.sections).map(e=>a.jsxs(x,{variant:e.hasContent?"default":"outline",className:"text-xs",children:["S",e.number]},e.number))})]})})}),a.jsx(A,{children:a.jsx(r,{className:"pt-0",children:a.jsx("div",{className:"grid gap-4",children:Object.values(e.sections).map(s=>a.jsxs(i,{className:"border-light-border bg-white",children:[a.jsx(o,{className:"pb-3",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(m,{className:"w-4 h-4"}),a.jsxs("h4",{className:"font-medium",children:["Section ",s.number]}),s.hasContent&&a.jsxs(x,{variant:"outline",className:"text-xs",children:[Object.values(s.parts).reduce((e,s)=>e+s.questions.length,0)," questions"]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{X(e.number),Z(s.number),pe(!0)},className:"rounded-xl h-7 px-2 text-xs",children:[a.jsx(h,{className:"w-3 h-3 mr-1"}),"Add Part"]})})]})}),a.jsx(r,{children:a.jsx("div",{className:"space-y-4",children:Object.values(s.parts).map(t=>a.jsxs(i,{className:"border-light-border bg-gray-50",children:[a.jsx(o,{className:"pb-2",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("h5",{className:"text-sm font-medium",children:["Part ",t.number]}),t.hasContent&&a.jsxs(x,{variant:"outline",className:"text-xs",children:[t.questions.length," questions"]})]}),a.jsx("div",{className:"flex gap-2",children:t.hasContent&&a.jsxs(j,{children:[a.jsx(b,{asChild:!0,children:a.jsx(n,{size:"sm",variant:"outline",className:"rounded-xl h-6 px-2",children:a.jsx(p,{className:"w-3 h-3"})})}),a.jsxs(g,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[a.jsx(v,{children:a.jsxs(N,{children:["Cambridge ",e.number," - Section ",s.number," - Part ",t.number]})}),a.jsxs("div",{className:"space-y-6",children:[t.section&&a.jsxs(i,{className:"p-4",children:[a.jsx("h5",{className:"font-medium mb-3",children:"Listening Section"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("h6",{className:"font-medium mb-2",children:"Instructions"}),a.jsx("p",{className:"text-sm",children:t.section.instructions})]}),t.section.audio_url&&a.jsxs("div",{children:[a.jsx("h6",{className:"font-medium mb-2",children:"Audio"}),a.jsx("audio",{controls:!0,className:"w-full",children:a.jsx("source",{src:t.section.audio_url,type:"audio/mpeg"})})]}),t.section.transcript&&a.jsxs("div",{children:[a.jsx("h6",{className:"font-medium mb-2",children:"Transcript"}),a.jsx("div",{className:"text-sm bg-gray-50 p-3 rounded-lg max-h-32 overflow-y-auto",children:t.section.transcript})]})]})]}),a.jsxs(i,{className:"p-4",children:[a.jsxs("h5",{className:"font-medium mb-3",children:["Questions (",t.questions.length,")"]}),a.jsx("div",{className:"space-y-4",children:t.questions.sort((e,s)=>parseInt(e.question_number)-parseInt(s.question_number)).map(e=>a.jsx("div",{className:"border-b border-light-border pb-4 last:border-b-0",children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(x,{variant:"outline",children:e.question_number}),a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-medium mb-2",children:e.question_text}),e.options&&a.jsx("div",{className:"text-sm space-y-1 mb-2",children:Array.isArray(e.options)?e.options.map((s,t)=>a.jsxs("div",{className:"p-2 rounded "+(s===e.correct_answer?"bg-green-50 text-green-800 font-medium":"bg-gray-50"),children:[String.fromCharCode(65+t),". ",s]},t)):a.jsxs("div",{className:"bg-green-50 text-green-800 font-medium p-2 rounded",children:["Answer: ",e.correct_answer]})}),a.jsxs("p",{className:"text-sm text-warm-gray",children:[a.jsx("span",{className:"font-medium",children:"Explanation:"})," ",e.explanation]})]})]})},e.id))})]})]})]})]})})]})}),a.jsx(r,{className:"pt-0",children:t.hasContent?a.jsx("div",{className:"text-sm text-warm-gray",children:t.section?a.jsxs("p",{children:["Section: ",t.section.title]}):a.jsx("p",{children:"Questions without section"})}):a.jsxs("div",{className:"text-center py-4 text-warm-gray",children:[a.jsx(m,{className:"w-6 h-6 mx-auto mb-2 opacity-50"}),a.jsx("p",{className:"text-xs",children:"No content yet"})]})})]},t.number))})})]},s.number))})})})]})},e.number))}),a.jsx(j,{open:J,onOpenChange:K,children:a.jsxs(g,{className:"max-w-5xl max-h-[85vh] overflow-y-auto",children:[a.jsx(v,{children:a.jsxs(N,{children:["Upload Content to Cambridge ",W,", Section ",Y]})}),a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Cambridge Book"}),a.jsxs(f,{value:W.toString(),onValueChange:e=>X(parseInt(e)),children:[a.jsx(C,{className:"rounded-xl border-light-border",children:a.jsx(y,{})}),a.jsx(w,{className:"rounded-xl border-light-border bg-card",children:Array.from({length:20},(e,s)=>20-s).map(e=>a.jsxs(_,{value:e.toString(),children:["Cambridge ",e]},e))})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Section"}),a.jsxs(f,{value:Y.toString(),onValueChange:e=>Z(parseInt(e)),children:[a.jsx(C,{className:"rounded-xl border-light-border",children:a.jsx(y,{})}),a.jsx(w,{className:"rounded-xl border-light-border bg-card",children:Array.from({length:4},(e,s)=>s+1).map(e=>a.jsxs(_,{value:e.toString(),children:["Section ",e]},e))})]})]})]}),a.jsxs(i,{className:"rounded-2xl border-light-border",style:{background:"white"},children:[a.jsx(o,{children:a.jsxs(u,{className:"flex items-center gap-2 text-foreground",children:[a.jsx(m,{className:"w-5 h-5"}),"Listening Section"]})}),a.jsxs(r,{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Audio File"}),a.jsxs("div",{className:"flex gap-3 items-center",children:[a.jsx("input",{ref:he,type:"file",accept:"audio/*",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t){ce(!0);try{const e=await $(t);le(e.url),z({title:"Success",description:"Audio uploaded successfully"})}catch(a){z({title:"Error",description:"Failed to upload audio",variant:"destructive"})}finally{ce(!1)}}},className:"hidden"}),a.jsxs(n,{type:"button",variant:"outline",onClick:()=>{var e;return null==(e=he.current)?void 0:e.click()},disabled:oe,className:"rounded-xl border-light-border",children:[a.jsx(L,{className:"w-4 h-4 mr-2"}),oe?"Uploading...":"Upload Audio"]}),re&&a.jsx("span",{className:"text-sm text-green-600 font-medium",children:"Audio uploaded ✓"})]}),re&&a.jsx("audio",{controls:!0,className:"w-full mt-2",children:a.jsx("source",{src:re,type:"audio/mpeg"})})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Photo (Optional - for visual questions)"}),a.jsxs("div",{className:"flex gap-3 items-center",children:[a.jsx("input",{ref:je,type:"file",accept:"image/*",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t){xe(!0);try{const e=`${Date.now()}-${t.name}`,{data:s,error:a}=await E.storage.from("audio-files").upload(e,t);if(a)throw a;const{data:n}=E.storage.from("audio-files").getPublicUrl(e);me(n.publicUrl),z({title:"Success",description:"Photo uploaded successfully"})}catch(a){z({title:"Error",description:"Failed to upload photo",variant:"destructive"})}finally{xe(!1)}}},className:"hidden"}),a.jsxs(n,{type:"button",variant:"outline",onClick:()=>{var e;return null==(e=je.current)?void 0:e.click()},disabled:ue,className:"rounded-xl border-light-border",children:[a.jsx(L,{className:"w-4 h-4 mr-2"}),ue?"Uploading...":"Upload Photo"]}),de&&a.jsx("span",{className:"text-sm text-green-600 font-medium",children:"Photo uploaded ✓"})]}),de&&a.jsx("img",{src:de,alt:"Listening question visual",className:"w-full max-w-md mt-2 rounded-lg border"})]}),a.jsx(S,{placeholder:"Audio transcript (optional, for admin reference)",value:ne,onChange:e=>ie(e.target.value),rows:6,className:"rounded-xl border-light-border font-mono text-sm"})]})]}),a.jsx(I,{onImport:async e=>{try{const s={transcript:ne,audio_url:re,photo_url:de,section_number:Y,part_number:ee,test_number:W,cambridge_book:`C${W}`},t=(await U("listening_sections",s)).data.id;for(let a=0;a<e.length;a++){const s=e[a],n={question_number:s.question_number||a+1,question_type:s.question_type||"multiple_choice",question_text:s.question_text||"",correct_answer:s.correct_answer||"",explanation:s.explanation||"",options:s.options||null,section_id:t};await U("listening_questions",n)}z({title:"Success",description:`Listening section uploaded to Cambridge ${W}, Section ${Y}`}),ie(""),le(""),me(""),K(!1),ge()}catch(s){z({title:"Error",description:s.message||"Failed to upload section",variant:"destructive"})}},type:"listening"})]})]})}),te&&a.jsx(j,{open:!!te,onOpenChange:()=>ae(null),children:a.jsxs(g,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[a.jsx(v,{children:a.jsxs(N,{children:["Edit Cambridge ",te.bookNumber," - Section ",te.number]})}),a.jsxs("div",{className:"space-y-6",children:[te.section&&a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Section Title"}),a.jsx(l,{value:te.section.title,onChange:e=>ae({...te,section:{...te.section,title:e.target.value}}),className:"mb-4"}),a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Instructions"}),a.jsx(S,{value:te.section.instructions,onChange:e=>ae({...te,section:{...te.section,instructions:e.target.value}}),rows:3,className:"mb-4"}),a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Transcript"}),a.jsx(S,{value:te.section.transcript,onChange:e=>ae({...te,section:{...te.section,transcript:e.target.value}}),rows:6,className:"mb-4"})]}),a.jsxs("div",{children:[a.jsx("h5",{className:"font-medium mb-4",children:"Questions"}),te.questions.map((e,s)=>a.jsx(i,{className:"p-4 mb-4",children:a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium",children:"Question Text"}),a.jsx(S,{value:e.question_text,onChange:e=>{const t={...te};t.questions[s].question_text=e.target.value,ae(t)},className:"mt-1"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium",children:"Correct Answer"}),a.jsx(l,{value:e.correct_answer,onChange:e=>{const t={...te};t.questions[s].correct_answer=e.target.value,ae(t)},className:"mt-1"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium",children:"Question Type"}),a.jsxs(f,{value:e.question_type,onValueChange:e=>{const t={...te};t.questions[s].question_type=e,ae(t)},children:[a.jsx(C,{className:"mt-1",children:a.jsx(y,{})}),a.jsxs(w,{children:[a.jsx(_,{value:"multiple_choice",children:"Multiple Choice"}),a.jsx(_,{value:"fill_in_blank",children:"Fill in the Blank"}),a.jsx(_,{value:"true_false",children:"True/False"}),a.jsx(_,{value:"matching",children:"Matching"})]})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-sm font-medium",children:"Explanation"}),a.jsx(S,{value:e.explanation,onChange:e=>{const t={...te};t.questions[s].explanation=e.target.value,ae(t)},className:"mt-1"})]})]})},e.id))]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx(n,{onClick:async()=>{if(te)try{te.section&&await V("listening_sections",{id:te.section.id,title:te.section.title,instructions:te.section.instructions,transcript:te.section.transcript});for(const e of te.questions)await V("listening_questions",{id:e.id,question_text:e.question_text,correct_answer:e.correct_answer,explanation:e.explanation,options:e.options});z({title:"Success",description:"Section updated successfully"}),ae(null),ge()}catch(e){z({title:"Error",description:"Failed to update section",variant:"destructive"})}},disabled:Q,className:"rounded-xl",style:{background:"var(--gradient-button)",border:"none"},children:"Save Changes"}),a.jsx(n,{variant:"outline",onClick:()=>ae(null),className:"rounded-xl",children:"Cancel"})]})]})]})}),a.jsx(j,{open:be,onOpenChange:pe,children:a.jsxs(g,{className:"rounded-2xl bg-card max-w-md",children:[a.jsx(v,{children:a.jsxs(N,{className:"text-xl font-georgia font-bold text-foreground",children:["Add Part to Cambridge ",W," - Section ",Y]})}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Select Part"}),a.jsxs(f,{value:ee.toString(),onValueChange:e=>se(parseInt(e)),children:[a.jsx(C,{className:"rounded-xl border-light-border",children:a.jsx(y,{})}),a.jsx(w,{className:"rounded-xl border-light-border bg-card",children:[1,2,3,4].map(e=>a.jsxs(_,{value:e.toString(),children:["Part ",e]},e))})]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(n,{onClick:()=>{K(!0),pe(!1)},className:"flex-1 rounded-xl",style:{background:"var(--gradient-button)",border:"none"},children:"Upload Content"}),a.jsx(n,{variant:"outline",onClick:()=>pe(!1),className:"rounded-xl border-light-border",children:"Cancel"})]})]})]})})]})})};export{T as default};
