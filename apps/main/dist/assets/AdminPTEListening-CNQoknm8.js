import{u as e,G as s,w as t,r as a,J as i,j as r,B as n,l,C as c,b as o,d,H as m,a as h,Y as u,Z as p,K as x,R as g,T as _,I as j,X as f,P as v,F as w,f as N}from"./index-B5_U6aUC.js";import{T as y,a as b,b as C,c as k}from"./tabs-DlcjrKZK.js";import{A as S,a as E,b as q,c as A,d as T,e as I,f as P,g as Q,h as L}from"./alert-dialog-P3mFE_jN.js";import{A as z}from"./AdminLayout-Dt7dRDeg.js";import{I as F}from"./ImageQuestionExtractor-B2lIGOo0.js";import{s as B}from"./supabase-DWL4C3fA.js";import{T as M}from"./trash-2-Ct1ZbMUc.js";import{S as $}from"./save-_a1zglCD.js";import{U as D}from"./upload-DiGBbQYC.js";import{P as O}from"./pen-line-D-GG8bHS.js";import{S as U}from"./square-check-big-DLEFvFnD.js";import{T as W,H}from"./type-BnSaxyAc.js";import{C as R}from"./circle-alert-CLl-Xr-q.js";import"./image-DHxHGBbL.js";const K=[{id:"summarize_spoken_text",name:"Summarize Spoken Text",icon:w,description:"Write a 50-70 word summary"},{id:"listening_mcq_multiple",name:"MCQ Multiple Answers",icon:U,description:"Select all correct answers"},{id:"fill_blanks_type_in",name:"Fill in Blanks",icon:W,description:"Type the missing words"},{id:"highlight_correct_summary",name:"Highlight Correct Summary",icon:H,description:"Select best summary"},{id:"listening_mcq_single",name:"MCQ Single Answer",icon:U,description:"Select one correct answer"},{id:"select_missing_word",name:"Select Missing Word",icon:R,description:"Select word that completes audio"},{id:"highlight_incorrect_words",name:"Highlight Incorrect Words",icon:H,description:"Click words that differ"},{id:"write_from_dictation",name:"Write from Dictation",icon:N,description:"Type the sentence you hear"}],V=()=>{const w=e(),{testId:N}=s(),{admin:U,loading:W}=t(),H=a.useRef(null),R=a.useRef(null),[V,G]=a.useState(null),[J,Y]=a.useState([]),[Z,X]=a.useState(!0),[ee,se]=a.useState(!1),[te,ae]=a.useState(!1),[ie,re]=a.useState(0),[ne,le]=a.useState(0),[ce,oe]=a.useState("summarize_spoken_text"),[de,me]=a.useState(!1),[he,ue]=a.useState(null),[pe,xe]=a.useState({prompt_text:"",passage_text:"",correct_answer:"",explanation:"",audio_start_time:"",audio_end_time:""}),[ge,_e]=a.useState(["","","",""]),[je,fe]=a.useState([]);a.useEffect(()=>{W||U||w("/admin/login")},[U,W,w]),a.useEffect(()=>{N&&U&&(ve(),we())},[N,U]),a.useEffect(()=>{const e=H.current;if(!e)return;const s=()=>re(e.currentTime),t=()=>le(e.duration),a=()=>ae(!1);return e.addEventListener("timeupdate",s),e.addEventListener("loadedmetadata",t),e.addEventListener("ended",a),()=>{e.removeEventListener("timeupdate",s),e.removeEventListener("loadedmetadata",t),e.removeEventListener("ended",a)}},[null==V?void 0:V.audio_url]);const ve=async()=>{if(N)try{const{data:e,error:s}=await B.from("pte_listening_tests").select("*").eq("id",N).single();if(s)throw s;G(e)}catch(e){console.error("Error loading test:",e),i.error("Failed to load test")}},we=async()=>{if(N){X(!0);try{const{data:e,error:s}=await B.from("pte_listening_items").select("*").eq("listening_test_id",N).order("question_number",{ascending:!0});if(s)throw s;Y(e||[])}catch(e){console.error("Error loading items:",e),i.error("Failed to load items")}finally{X(!1)}}},Ne=async()=>{if(N){se(!0);try{K.find(e=>e.id===ce);const e={listening_test_id:N,pte_section_type:ce,question_number:J.filter(e=>e.pte_section_type===ce).length+1,prompt_text:pe.prompt_text||null,passage_text:pe.passage_text||null,correct_answer:pe.correct_answer||null,explanation:pe.explanation||null,audio_start_time:pe.audio_start_time?parseInt(pe.audio_start_time):null,audio_end_time:pe.audio_end_time?parseInt(pe.audio_end_time):null};if(["listening_mcq_multiple","listening_mcq_single","highlight_correct_summary","select_missing_word"].includes(ce)&&(e.options=ge.filter(e=>e.trim())),"highlight_incorrect_words"===ce&&(e.highlight_words=je),he){const{error:s}=await B.from("pte_listening_items").update(e).eq("id",he);if(s)throw s;i.success("Item updated")}else{const{error:s}=await B.from("pte_listening_items").insert(e);if(s)throw s;i.success("Item created")}ye(),we()}catch(e){console.error("Error saving item:",e),i.error("Failed to save item")}finally{se(!1)}}},ye=()=>{xe({prompt_text:"",passage_text:"",correct_answer:"",explanation:"",audio_start_time:"",audio_end_time:""}),_e(["","","",""]),fe([]),ue(null),me(!1)},be=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`,Ce=async e=>{console.log("Extracted questions:",e);for(const t of e){const e={listening_test_id:N,pte_section_type:ce,question_number:J.filter(e=>e.pte_section_type===ce).length+1,prompt_text:t.question_text,correct_answer:t.correct_answer||null,explanation:t.explanation||null};t.options&&(e.options=t.options);try{const{error:s}=await B.from("pte_listening_items").insert(e);if(s)throw s}catch(s){console.error("Error saving extracted question:",s)}}i.success(`${e.length} questions extracted and saved`),we()},ke=e=>J.filter(s=>s.pte_section_type===e);return W||Z?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):V?r.jsx(z,{title:`PTE Listening: ${V.test_name}`,showBackButton:!0,backPath:"/admin/pte",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold",children:V.test_name}),r.jsx("p",{className:"text-muted-foreground",children:"Manage listening audio and questions"})]}),r.jsxs(l,{variant:"secondary",className:"bg-green-100 text-green-700",children:[J.length," questions"]})]}),r.jsxs(c,{children:[r.jsx(o,{children:r.jsxs(d,{className:"flex items-center gap-2",children:[r.jsx(m,{className:"w-5 h-5"}),"Audio File"]})}),r.jsx(h,{className:"space-y-4",children:V.audio_url?r.jsxs("div",{className:"space-y-4",children:[r.jsx("audio",{ref:H,src:V.audio_url,className:"hidden"}),r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx(n,{variant:"outline",size:"icon",onClick:()=>{H.current&&(te?H.current.pause():H.current.play(),ae(!te))},children:te?r.jsx(u,{className:"w-4 h-4"}):r.jsx(p,{className:"w-4 h-4"})}),r.jsxs("div",{className:"flex-1 space-y-1",children:[r.jsx(x,{value:ie/ne*100,className:"h-2"}),r.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[r.jsx("span",{children:be(ie)}),r.jsx("span",{children:be(ne)})]})]}),r.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{G(e=>e?{...e,audio_url:null}:null)},children:[r.jsx(M,{className:"w-4 h-4 mr-1"}),"Remove"]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"Transcript (Optional)"}),r.jsx(_,{value:V.transcript||"",onChange:e=>G(s=>s?{...s,transcript:e.target.value}:null),placeholder:"Enter the audio transcript...",rows:4}),r.jsxs(n,{variant:"outline",size:"sm",onClick:()=>(async e=>{if(N)try{const{error:s}=await B.from("pte_listening_tests").update({transcript:e}).eq("id",N);if(s)throw s;i.success("Transcript saved"),ve()}catch(s){console.error("Error saving transcript:",s),i.error("Failed to save transcript")}})(V.transcript||""),children:[r.jsx($,{className:"w-4 h-4 mr-1"}),"Save Transcript"]})]})]}):r.jsxs("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[r.jsx(D,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Upload audio file for this listening test"}),r.jsx("input",{ref:R,type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(async e=>{if(N)try{const s=`pte/listening/${N}/${Date.now()}_${e.name}`,{data:t,error:a}=await B.storage.from("audio").upload(s,e,{upsert:!0});if(a)throw a;const{data:{publicUrl:r}}=B.storage.from("audio").getPublicUrl(s),{error:n}=await B.from("pte_listening_tests").update({audio_url:r}).eq("id",N);if(n)throw n;i.success("Audio uploaded successfully"),ve()}catch(s){console.error("Error uploading audio:",s),i.error("Failed to upload audio")}})(t)},className:"hidden"}),r.jsx(n,{variant:"outline",onClick:()=>{var e;return null==(e=R.current)?void 0:e.click()},children:"Choose Audio File"})]})})]}),r.jsxs(c,{children:[r.jsx(o,{children:r.jsx(d,{children:"Question Types Progress"})}),r.jsx(h,{children:r.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:K.map(e=>{const s=ke(e.id),t=e.icon;return r.jsxs("div",{className:"p-3 rounded-lg border cursor-pointer transition-colors "+(ce===e.id?"border-green-500 bg-green-50 dark:bg-green-950/20":"hover:border-green-300"),onClick:()=>oe(e.id),children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx(t,{className:"w-4 h-4 text-green-600"}),r.jsx("span",{className:"text-sm font-medium",children:e.name})]}),r.jsxs(l,{variant:"secondary",className:"text-xs",children:[s.length," items"]})]},e.id)})})})]}),r.jsxs(y,{value:ce,onValueChange:oe,children:[r.jsx(b,{className:"flex flex-wrap h-auto gap-1",children:K.map(e=>{const s=e.icon;return r.jsxs(C,{value:e.id,className:"flex items-center gap-1 text-xs",children:[r.jsx(s,{className:"w-3 h-3"}),r.jsx("span",{className:"hidden md:inline",children:e.name}),r.jsx("span",{className:"md:hidden",children:e.name.split(" ")[0]})]},e.id)})}),K.map(e=>{const s=ke(e.id),t=e.icon;return r.jsxs(k,{value:e.id,className:"space-y-4 mt-4",children:[r.jsx(c,{className:"bg-green-50 dark:bg-green-950/20 border-green-200",children:r.jsx(h,{className:"pt-4",children:r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/30 rounded-lg",children:r.jsx(t,{className:"w-5 h-5 text-green-600"})}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold",children:e.name}),r.jsx("p",{className:"text-sm text-muted-foreground",children:e.description})]})]})})}),de&&ce===e.id?r.jsxs(c,{children:[r.jsx(o,{children:r.jsx(d,{children:he?"Edit Question":"Add New Question"})}),r.jsx(h,{className:"space-y-4",children:r.jsxs(y,{defaultValue:"manual",children:[r.jsxs(b,{className:"grid w-full grid-cols-2",children:[r.jsx(C,{value:"manual",children:"Manual Entry"}),r.jsx(C,{value:"ai",children:"AI Extract"})]}),r.jsxs(k,{value:"manual",className:"space-y-4 pt-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"Question / Prompt"}),r.jsx(_,{value:pe.prompt_text,onChange:e=>xe(s=>({...s,prompt_text:e.target.value})),placeholder:"Enter the question or instructions",rows:2})]}),["fill_blanks_type_in","highlight_incorrect_words"].includes(e.id)&&r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"fill_blanks_type_in"===e.id?"Passage (use [BLANK] for blanks)":"Transcript (words to highlight)"}),r.jsx(_,{value:pe.passage_text,onChange:e=>xe(s=>({...s,passage_text:e.target.value})),placeholder:"fill_blanks_type_in"===e.id?"The speaker mentioned that [BLANK] was important...":"Enter the transcript text",rows:4})]}),["listening_mcq_multiple","listening_mcq_single","highlight_correct_summary","select_missing_word"].includes(e.id)&&r.jsxs("div",{className:"space-y-3",children:[r.jsx(g,{children:"Answer Options"}),ge.map((e,s)=>r.jsxs("div",{className:"flex gap-2 items-center",children:[r.jsx(l,{variant:"outline",className:"w-8 h-8 flex items-center justify-center",children:String.fromCharCode(65+s)}),r.jsx(j,{value:e,onChange:e=>{const t=[...ge];t[s]=e.target.value,_e(t)},placeholder:`Option ${String.fromCharCode(65+s)}`,className:"flex-1"}),ge.length>2&&r.jsx(n,{variant:"ghost",size:"icon",onClick:()=>_e(ge.filter((e,t)=>t!==s)),children:r.jsx(f,{className:"w-4 h-4"})})]},s)),r.jsxs(n,{variant:"outline",size:"sm",onClick:()=>_e([...ge,""]),children:[r.jsx(v,{className:"w-4 h-4 mr-1"}),"Add Option"]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(g,{children:["Correct Answer","listening_mcq_multiple"===e.id&&" (comma-separated)","fill_blanks_type_in"===e.id&&" (comma-separated in blank order)","highlight_incorrect_words"===e.id&&" (comma-separated incorrect words)"]}),r.jsx(j,{value:pe.correct_answer,onChange:e=>xe(s=>({...s,correct_answer:e.target.value})),placeholder:"listening_mcq_multiple"===e.id?"A, C, D":"fill_blanks_type_in"===e.id?"word1, word2":"highlight_incorrect_words"===e.id?"wrong1, wrong2":"write_from_dictation"===e.id?"The complete sentence":"A"})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"Audio Start (seconds)"}),r.jsx(j,{type:"number",value:pe.audio_start_time,onChange:e=>xe(s=>({...s,audio_start_time:e.target.value})),placeholder:"0"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"Audio End (seconds)"}),r.jsx(j,{type:"number",value:pe.audio_end_time,onChange:e=>xe(s=>({...s,audio_end_time:e.target.value})),placeholder:"60"})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(g,{children:"Explanation (Optional)"}),r.jsx(_,{value:pe.explanation,onChange:e=>xe(s=>({...s,explanation:e.target.value})),placeholder:"Why is this the correct answer?",rows:2})]}),r.jsxs("div",{className:"flex gap-3 justify-end",children:[r.jsx(n,{variant:"outline",onClick:ye,children:"Cancel"}),r.jsxs(n,{onClick:Ne,disabled:ee,className:"bg-green-600 hover:bg-green-700",children:[r.jsx($,{className:"w-4 h-4 mr-2"}),ee?"Saving...":he?"Update":"Save"]})]})]}),r.jsxs(k,{value:"ai",className:"pt-4",children:[r.jsx(F,{testId:N||"",testType:"PTE",onQuestionsExtracted:Ce}),r.jsx("div",{className:"flex justify-end mt-4",children:r.jsx(n,{variant:"outline",onClick:ye,children:"Close"})})]})]})})]}):r.jsxs(n,{onClick:()=>me(!0),className:"bg-green-600 hover:bg-green-700",children:[r.jsx(v,{className:"w-4 h-4 mr-2"}),"Add ",e.name," Question"]}),r.jsxs("div",{className:"space-y-4",children:[r.jsxs("h4",{className:"font-medium",children:["Questions (",s.length,")"]}),0===s.length?r.jsx(c,{className:"border-dashed",children:r.jsx(h,{className:"flex flex-col items-center justify-center py-8",children:r.jsx("p",{className:"text-muted-foreground",children:"No questions for this type yet"})})}):r.jsx("div",{className:"grid gap-3",children:s.map((e,s)=>r.jsx(c,{className:"hover:shadow-md transition-shadow",children:r.jsx(h,{className:"pt-4",children:r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"flex-1 space-y-1",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(l,{variant:"outline",children:["Q",s+1]}),e.audio_start_time&&r.jsxs("span",{className:"text-xs text-muted-foreground",children:[be(e.audio_start_time)," - ",be(e.audio_end_time||0)]})]}),r.jsx("p",{className:"text-sm line-clamp-2",children:e.prompt_text}),e.correct_answer&&r.jsxs("p",{className:"text-xs",children:[r.jsx("span",{className:"font-medium text-green-600",children:"Answer: "}),e.correct_answer]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx(n,{variant:"ghost",size:"icon",onClick:()=>(e=>{var s,t;ue(e.id),oe(e.pte_section_type),xe({prompt_text:e.prompt_text||"",passage_text:e.passage_text||"",correct_answer:e.correct_answer||"",explanation:e.explanation||"",audio_start_time:(null==(s=e.audio_start_time)?void 0:s.toString())||"",audio_end_time:(null==(t=e.audio_end_time)?void 0:t.toString())||""}),e.options&&_e(e.options.length>=4?e.options:[...e.options,"","","",""].slice(0,4)),e.highlight_words&&fe(e.highlight_words),me(!0)})(e),children:r.jsx(O,{className:"w-4 h-4"})}),r.jsxs(S,{children:[r.jsx(E,{asChild:!0,children:r.jsx(n,{variant:"ghost",size:"icon",children:r.jsx(M,{className:"w-4 h-4 text-red-500"})})}),r.jsxs(q,{children:[r.jsxs(A,{children:[r.jsx(T,{children:"Delete Question"}),r.jsx(I,{children:"Are you sure? This action cannot be undone."})]}),r.jsxs(P,{children:[r.jsx(Q,{children:"Cancel"}),r.jsx(L,{onClick:()=>(async e=>{try{const{error:s}=await B.from("pte_listening_items").delete().eq("id",e);if(s)throw s;i.success("Item deleted"),we()}catch(s){console.error("Error deleting item:",s),i.error("Failed to delete item")}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})})},e.id))})]})]},e.id)})]})]})}):r.jsx(z,{title:"PTE Listening",showBackButton:!0,backPath:"/admin/pte",children:r.jsxs("div",{className:"text-center py-12",children:[r.jsx("p",{className:"text-muted-foreground",children:"Test not found"}),r.jsx(n,{onClick:()=>w("/admin/pte"),className:"mt-4",children:"Back to PTE Admin"})]})})};export{V as default};
