import{u as e,c as s,r as t,j as a}from"./vendor-react-JN_hy__U.js";import{n as i,s as r,J as n,B as l,e as c,C as o,b as d,c as m,a as h,P as u,L as x,T as p,I as g}from"./index-DXpPY1B7.js";import{T as _,a as j,b as f,c as v}from"./tabs-CUO_kQ2m.js";import{A as w,a as N,b as y,c as b,d as C,e as k,f as S,g as E,h as q}from"./alert-dialog-BwGJZs3W.js";import{A}from"./AdminLayout-D3lPYw5Y.js";import{I as T}from"./ImageQuestionExtractor-66fJ2WkK.js";import{aJ as L,aK as I,aL as Q,aY as P,b5 as z,aV as B,X as F,av as M,a_ as $,ap as D,b0 as O,b2 as W,b3 as U,b4 as K,ax as R}from"./vendor-ui-DG51EGkO.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const V=[{id:"summarize_spoken_text",name:"Summarize Spoken Text",icon:D,description:"Write a 50-70 word summary"},{id:"listening_mcq_multiple",name:"MCQ Multiple Answers",icon:O,description:"Select all correct answers"},{id:"fill_blanks_type_in",name:"Fill in Blanks",icon:W,description:"Type the missing words"},{id:"highlight_correct_summary",name:"Highlight Correct Summary",icon:U,description:"Select best summary"},{id:"listening_mcq_single",name:"MCQ Single Answer",icon:O,description:"Select one correct answer"},{id:"select_missing_word",name:"Select Missing Word",icon:K,description:"Select word that completes audio"},{id:"highlight_incorrect_words",name:"Highlight Incorrect Words",icon:U,description:"Click words that differ"},{id:"write_from_dictation",name:"Write from Dictation",icon:R,description:"Type the sentence you hear"}],H=()=>{const D=e(),{testId:O}=s(),{admin:W,loading:U}=i(),K=t.useRef(null),R=t.useRef(null),[H,J]=t.useState(null),[Y,G]=t.useState([]),[X,Z]=t.useState(!0),[ee,se]=t.useState(!1),[te,ae]=t.useState(!1),[ie,re]=t.useState(0),[ne,le]=t.useState(0),[ce,oe]=t.useState("summarize_spoken_text"),[de,me]=t.useState(!1),[he,ue]=t.useState(null),[xe,pe]=t.useState({prompt_text:"",passage_text:"",correct_answer:"",explanation:"",audio_start_time:"",audio_end_time:""}),[ge,_e]=t.useState(["","","",""]),[je,fe]=t.useState([]);t.useEffect(()=>{U||W||D("/admin/login")},[W,U,D]),t.useEffect(()=>{O&&W&&(ve(),we())},[O,W]),t.useEffect(()=>{const e=K.current;if(!e)return;const s=()=>re(e.currentTime),t=()=>le(e.duration),a=()=>ae(!1);return e.addEventListener("timeupdate",s),e.addEventListener("loadedmetadata",t),e.addEventListener("ended",a),()=>{e.removeEventListener("timeupdate",s),e.removeEventListener("loadedmetadata",t),e.removeEventListener("ended",a)}},[null==H?void 0:H.audio_url]);const ve=async()=>{if(O)try{const{data:e,error:s}=await r.from("pte_listening_tests").select("*").eq("id",O).single();if(s)throw s;J(e)}catch(e){console.error("Error loading test:",e),n.error("Failed to load test")}},we=async()=>{if(O){Z(!0);try{const{data:e,error:s}=await r.from("pte_listening_items").select("*").eq("listening_test_id",O).order("question_number",{ascending:!0});if(s)throw s;G(e||[])}catch(e){console.error("Error loading items:",e),n.error("Failed to load items")}finally{Z(!1)}}},Ne=async()=>{if(O){se(!0);try{V.find(e=>e.id===ce);const e={listening_test_id:O,pte_section_type:ce,question_number:Y.filter(e=>e.pte_section_type===ce).length+1,prompt_text:xe.prompt_text||null,passage_text:xe.passage_text||null,correct_answer:xe.correct_answer||null,explanation:xe.explanation||null,audio_start_time:xe.audio_start_time?parseInt(xe.audio_start_time):null,audio_end_time:xe.audio_end_time?parseInt(xe.audio_end_time):null};if(["listening_mcq_multiple","listening_mcq_single","highlight_correct_summary","select_missing_word"].includes(ce)&&(e.options=ge.filter(e=>e.trim())),"highlight_incorrect_words"===ce&&(e.highlight_words=je),he){const{error:s}=await r.from("pte_listening_items").update(e).eq("id",he);if(s)throw s;n.success("Item updated")}else{const{error:s}=await r.from("pte_listening_items").insert(e);if(s)throw s;n.success("Item created")}ye(),we()}catch(e){console.error("Error saving item:",e),n.error("Failed to save item")}finally{se(!1)}}},ye=()=>{pe({prompt_text:"",passage_text:"",correct_answer:"",explanation:"",audio_start_time:"",audio_end_time:""}),_e(["","","",""]),fe([]),ue(null),me(!1)},be=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`,Ce=async e=>{console.log("Extracted questions:",e);for(const t of e){const e={listening_test_id:O,pte_section_type:ce,question_number:Y.filter(e=>e.pte_section_type===ce).length+1,prompt_text:t.question_text,correct_answer:t.correct_answer||null,explanation:t.explanation||null};t.options&&(e.options=t.options);try{const{error:s}=await r.from("pte_listening_items").insert(e);if(s)throw s}catch(s){console.error("Error saving extracted question:",s)}}n.success(`${e.length} questions extracted and saved`),we()},ke=e=>Y.filter(s=>s.pte_section_type===e);return U||X?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):H?a.jsx(A,{title:`PTE Listening: ${H.test_name}`,showBackButton:!0,backPath:"/admin/pte",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold",children:H.test_name}),a.jsx("p",{className:"text-muted-foreground",children:"Manage listening audio and questions"})]}),a.jsxs(c,{variant:"secondary",className:"bg-green-100 text-green-700",children:[Y.length," questions"]})]}),a.jsxs(o,{children:[a.jsx(d,{children:a.jsxs(m,{className:"flex items-center gap-2",children:[a.jsx(L,{className:"w-5 h-5"}),"Audio File"]})}),a.jsx(h,{className:"space-y-4",children:H.audio_url?a.jsxs("div",{className:"space-y-4",children:[a.jsx("audio",{ref:K,src:H.audio_url,className:"hidden"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(l,{variant:"outline",size:"icon",onClick:()=>{K.current&&(te?K.current.pause():K.current.play(),ae(!te))},children:te?a.jsx(I,{className:"w-4 h-4"}):a.jsx(Q,{className:"w-4 h-4"})}),a.jsxs("div",{className:"flex-1 space-y-1",children:[a.jsx(u,{value:ie/ne*100,className:"h-2"}),a.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[a.jsx("span",{children:be(ie)}),a.jsx("span",{children:be(ne)})]})]}),a.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{J(e=>e?{...e,audio_url:null}:null)},children:[a.jsx(P,{className:"w-4 h-4 mr-1"}),"Remove"]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"Transcript (Optional)"}),a.jsx(p,{value:H.transcript||"",onChange:e=>J(s=>s?{...s,transcript:e.target.value}:null),placeholder:"Enter the audio transcript...",rows:4}),a.jsxs(l,{variant:"outline",size:"sm",onClick:()=>(async e=>{if(O)try{const{error:s}=await r.from("pte_listening_tests").update({transcript:e}).eq("id",O);if(s)throw s;n.success("Transcript saved"),ve()}catch(s){console.error("Error saving transcript:",s),n.error("Failed to save transcript")}})(H.transcript||""),children:[a.jsx(z,{className:"w-4 h-4 mr-1"}),"Save Transcript"]})]})]}):a.jsxs("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[a.jsx(B,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),a.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Upload audio file for this listening test"}),a.jsx("input",{ref:R,type:"file",accept:"audio/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(async e=>{if(O)try{const s=`pte/listening/${O}/${Date.now()}_${e.name}`,{data:t,error:a}=await r.storage.from("audio").upload(s,e,{upsert:!0});if(a)throw a;const{data:{publicUrl:i}}=r.storage.from("audio").getPublicUrl(s),{error:l}=await r.from("pte_listening_tests").update({audio_url:i}).eq("id",O);if(l)throw l;n.success("Audio uploaded successfully"),ve()}catch(s){console.error("Error uploading audio:",s),n.error("Failed to upload audio")}})(t)},className:"hidden"}),a.jsx(l,{variant:"outline",onClick:()=>{var e;return null==(e=R.current)?void 0:e.click()},children:"Choose Audio File"})]})})]}),a.jsxs(o,{children:[a.jsx(d,{children:a.jsx(m,{children:"Question Types Progress"})}),a.jsx(h,{children:a.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:V.map(e=>{const s=ke(e.id),t=e.icon;return a.jsxs("div",{className:"p-3 rounded-lg border cursor-pointer transition-colors "+(ce===e.id?"border-green-500 bg-green-50 dark:bg-green-950/20":"hover:border-green-300"),onClick:()=>oe(e.id),children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx(t,{className:"w-4 h-4 text-green-600"}),a.jsx("span",{className:"text-sm font-medium",children:e.name})]}),a.jsxs(c,{variant:"secondary",className:"text-xs",children:[s.length," items"]})]},e.id)})})})]}),a.jsxs(_,{value:ce,onValueChange:oe,children:[a.jsx(j,{className:"flex flex-wrap h-auto gap-1",children:V.map(e=>{const s=e.icon;return a.jsxs(f,{value:e.id,className:"flex items-center gap-1 text-xs",children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{className:"hidden md:inline",children:e.name}),a.jsx("span",{className:"md:hidden",children:e.name.split(" ")[0]})]},e.id)})}),V.map(e=>{const s=ke(e.id),t=e.icon;return a.jsxs(v,{value:e.id,className:"space-y-4 mt-4",children:[a.jsx(o,{className:"bg-green-50 dark:bg-green-950/20 border-green-200",children:a.jsx(h,{className:"pt-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/30 rounded-lg",children:a.jsx(t,{className:"w-5 h-5 text-green-600"})}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold",children:e.name}),a.jsx("p",{className:"text-sm text-muted-foreground",children:e.description})]})]})})}),de&&ce===e.id?a.jsxs(o,{children:[a.jsx(d,{children:a.jsx(m,{children:he?"Edit Question":"Add New Question"})}),a.jsx(h,{className:"space-y-4",children:a.jsxs(_,{defaultValue:"manual",children:[a.jsxs(j,{className:"grid w-full grid-cols-2",children:[a.jsx(f,{value:"manual",children:"Manual Entry"}),a.jsx(f,{value:"ai",children:"AI Extract"})]}),a.jsxs(v,{value:"manual",className:"space-y-4 pt-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"Question / Prompt"}),a.jsx(p,{value:xe.prompt_text,onChange:e=>pe(s=>({...s,prompt_text:e.target.value})),placeholder:"Enter the question or instructions",rows:2})]}),["fill_blanks_type_in","highlight_incorrect_words"].includes(e.id)&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"fill_blanks_type_in"===e.id?"Passage (use [BLANK] for blanks)":"Transcript (words to highlight)"}),a.jsx(p,{value:xe.passage_text,onChange:e=>pe(s=>({...s,passage_text:e.target.value})),placeholder:"fill_blanks_type_in"===e.id?"The speaker mentioned that [BLANK] was important...":"Enter the transcript text",rows:4})]}),["listening_mcq_multiple","listening_mcq_single","highlight_correct_summary","select_missing_word"].includes(e.id)&&a.jsxs("div",{className:"space-y-3",children:[a.jsx(x,{children:"Answer Options"}),ge.map((e,s)=>a.jsxs("div",{className:"flex gap-2 items-center",children:[a.jsx(c,{variant:"outline",className:"w-8 h-8 flex items-center justify-center",children:String.fromCharCode(65+s)}),a.jsx(g,{value:e,onChange:e=>{const t=[...ge];t[s]=e.target.value,_e(t)},placeholder:`Option ${String.fromCharCode(65+s)}`,className:"flex-1"}),ge.length>2&&a.jsx(l,{variant:"ghost",size:"icon",onClick:()=>_e(ge.filter((e,t)=>t!==s)),children:a.jsx(F,{className:"w-4 h-4"})})]},s)),a.jsxs(l,{variant:"outline",size:"sm",onClick:()=>_e([...ge,""]),children:[a.jsx(M,{className:"w-4 h-4 mr-1"}),"Add Option"]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs(x,{children:["Correct Answer","listening_mcq_multiple"===e.id&&" (comma-separated)","fill_blanks_type_in"===e.id&&" (comma-separated in blank order)","highlight_incorrect_words"===e.id&&" (comma-separated incorrect words)"]}),a.jsx(g,{value:xe.correct_answer,onChange:e=>pe(s=>({...s,correct_answer:e.target.value})),placeholder:"listening_mcq_multiple"===e.id?"A, C, D":"fill_blanks_type_in"===e.id?"word1, word2":"highlight_incorrect_words"===e.id?"wrong1, wrong2":"write_from_dictation"===e.id?"The complete sentence":"A"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"Audio Start (seconds)"}),a.jsx(g,{type:"number",value:xe.audio_start_time,onChange:e=>pe(s=>({...s,audio_start_time:e.target.value})),placeholder:"0"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"Audio End (seconds)"}),a.jsx(g,{type:"number",value:xe.audio_end_time,onChange:e=>pe(s=>({...s,audio_end_time:e.target.value})),placeholder:"60"})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(x,{children:"Explanation (Optional)"}),a.jsx(p,{value:xe.explanation,onChange:e=>pe(s=>({...s,explanation:e.target.value})),placeholder:"Why is this the correct answer?",rows:2})]}),a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsx(l,{variant:"outline",onClick:ye,children:"Cancel"}),a.jsxs(l,{onClick:Ne,disabled:ee,className:"bg-green-600 hover:bg-green-700",children:[a.jsx(z,{className:"w-4 h-4 mr-2"}),ee?"Saving...":he?"Update":"Save"]})]})]}),a.jsxs(v,{value:"ai",className:"pt-4",children:[a.jsx(T,{testId:O||"",testType:"PTE",onQuestionsExtracted:Ce}),a.jsx("div",{className:"flex justify-end mt-4",children:a.jsx(l,{variant:"outline",onClick:ye,children:"Close"})})]})]})})]}):a.jsxs(l,{onClick:()=>me(!0),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(M,{className:"w-4 h-4 mr-2"}),"Add ",e.name," Question"]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("h4",{className:"font-medium",children:["Questions (",s.length,")"]}),0===s.length?a.jsx(o,{className:"border-dashed",children:a.jsx(h,{className:"flex flex-col items-center justify-center py-8",children:a.jsx("p",{className:"text-muted-foreground",children:"No questions for this type yet"})})}):a.jsx("div",{className:"grid gap-3",children:s.map((e,s)=>a.jsx(o,{className:"hover:shadow-md transition-shadow",children:a.jsx(h,{className:"pt-4",children:a.jsxs("div",{className:"flex items-start justify-between gap-4",children:[a.jsxs("div",{className:"flex-1 space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(c,{variant:"outline",children:["Q",s+1]}),e.audio_start_time&&a.jsxs("span",{className:"text-xs text-muted-foreground",children:[be(e.audio_start_time)," - ",be(e.audio_end_time||0)]})]}),a.jsx("p",{className:"text-sm line-clamp-2",children:e.prompt_text}),e.correct_answer&&a.jsxs("p",{className:"text-xs",children:[a.jsx("span",{className:"font-medium text-green-600",children:"Answer: "}),e.correct_answer]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(l,{variant:"ghost",size:"icon",onClick:()=>(e=>{var s,t;ue(e.id),oe(e.pte_section_type),pe({prompt_text:e.prompt_text||"",passage_text:e.passage_text||"",correct_answer:e.correct_answer||"",explanation:e.explanation||"",audio_start_time:(null==(s=e.audio_start_time)?void 0:s.toString())||"",audio_end_time:(null==(t=e.audio_end_time)?void 0:t.toString())||""}),e.options&&_e(e.options.length>=4?e.options:[...e.options,"","","",""].slice(0,4)),e.highlight_words&&fe(e.highlight_words),me(!0)})(e),children:a.jsx($,{className:"w-4 h-4"})}),a.jsxs(w,{children:[a.jsx(N,{asChild:!0,children:a.jsx(l,{variant:"ghost",size:"icon",children:a.jsx(P,{className:"w-4 h-4 text-red-500"})})}),a.jsxs(y,{children:[a.jsxs(b,{children:[a.jsx(C,{children:"Delete Question"}),a.jsx(k,{children:"Are you sure? This action cannot be undone."})]}),a.jsxs(S,{children:[a.jsx(E,{children:"Cancel"}),a.jsx(q,{onClick:()=>(async e=>{try{const{error:s}=await r.from("pte_listening_items").delete().eq("id",e);if(s)throw s;n.success("Item deleted"),we()}catch(s){console.error("Error deleting item:",s),n.error("Failed to delete item")}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})})},e.id))})]})]},e.id)})]})]})}):a.jsx(A,{title:"PTE Listening",showBackButton:!0,backPath:"/admin/pte",children:a.jsxs("div",{className:"text-center py-12",children:[a.jsx("p",{className:"text-muted-foreground",children:"Test not found"}),a.jsx(l,{onClick:()=>D("/admin/pte"),className:"mt-4",children:"Back to PTE Admin"})]})})};export{H as default};
