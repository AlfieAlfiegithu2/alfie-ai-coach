import{r as e,j as n,c as r}from"./vendor-react-rLLBBC7n.js";import{A as s}from"./AdminLayout-DwaN-V0p.js";import{C as t,b as a,c as i,a as o,B as c,J as l,s as d,P as h,D as u,f as m,g,h as p,L as x,I as w,T as f}from"./index-BDl0jLJK.js";import{S as j}from"./separator-C0bogF69.js";import{A as v,a as _}from"./alert-DtyL8j6a.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-ui-BGi_EvHx.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const y=["QuestionFormat","original_sentence","WordOrSentence","CorrectAnswer","IncorrectAnswer1","IncorrectAnswer2","IncorrectAnswer3","Explanation"];function N(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const n=e.slice(0,180),r=Math.max(n.lastIndexOf("."),n.lastIndexOf(","),n.lastIndexOf(";"),n.lastIndexOf(":"));return(r>60?n.slice(0,r):n).trim()}function k(e){const n=[];let r="",s=!1;for(let t=0;t<e.length;t++){const a=e[t];'"'===a?s&&'"'===e[t+1]?(r+='"',t++):s=!s:","!==a||s?r+=a:(n.push(r),r="")}return n.push(r),n.map(e=>e.trim())}function b({skillTestId:r,onImported:s}){const[h,u]=e.useState(null),[m,g]=e.useState([]),[p,x]=e.useState(null),[w,f]=e.useState(!1),j=e.useRef(null),b=async e=>{var n;try{u(null),g([]),x(null);const s=function(e,n,r){const s=[],t=[],a=[];let i=(e||"").replace(/^\uFEFF/,"");o=i,i=o.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'"),i=function(e){const n=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",r=(n.match(/,/g)||[]).length;return(n.match(/;/g)||[]).length>0&&0===r?e.replace(/;/g,","):e}(i);var o;const c=i.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===c.length)return{ok:!1,skill_type:n,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${y.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const l=k(c[0]).map(e=>e.replace(/^"|"$/g,"").trim()),d={};l.forEach((e,n)=>d[e]=n);const h=y.filter(e=>void 0===d[e]);if(h.length>0)return{ok:!1,skill_type:n,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${h.join("; ")}. Expected: ${y.join(",")}`,raw:Object.fromEntries(l.map((e,n)=>[n.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=c.slice(1);u.forEach((e,i)=>{const o=i+1,c=k(e),l=e=>N(function(e){return e.replace(/<[^>]*>/g,"")}(c[d[e]]||"")),h=l("QuestionFormat"),u=C(l("original_sentence")),m=C(l("WordOrSentence")),g=C(l("CorrectAnswer")),p=C(l("IncorrectAnswer1")),x=C(l("IncorrectAnswer2")),w=C(l("IncorrectAnswer3")),f=C(l("Explanation")),j={QuestionFormat:h,original_sentence:u,WordOrSentence:m,CorrectAnswer:g,IncorrectAnswer1:p,IncorrectAnswer2:x,IncorrectAnswer3:w,Explanation:f};if(!h||!m||!g)return void t.push({row:o,message:"Missing critical fields",raw:j});if(!function(e){const n=e.replace(/[^a-z]/gi,"").toLowerCase();return["paraphrasingwordreplacement","paraphrasingsentenceremodeling","paraphrasingexpert"].includes(n)}(h))return void t.push({row:o,message:`Unrecognized QuestionFormat: ${h}`,raw:j});const v=[g,...[p,x,w].filter(e=>null!=e)].map(e=>N(e)).filter(Boolean),_=new Set;let y=v.filter(e=>{const n=e.toLowerCase();return!_.has(n)&&(_.add(n),!0)});if(y.length<4){const e=new Set(y.map(e=>e.toLowerCase())),n=4-y.length;for(let r=0;r<n;r++){let n=1;for(;e.has(`Distractor ${n}`.toLowerCase());)n++;const r=`Distractor ${n}`;y.push(r),e.add(r.toLowerCase()),s.push({row:o,message:"Added placeholder distractor to ensure 4 options"})}}const b=y[0],S=y.slice(1,4);a.push({skill_type:n,skill_test_id:r,question_format:h,content:m,correct_answer:b,incorrect_answers:S,explanation:f||void 0,original_sentence:u||null})});const m=new Set(s.map(e=>e.row)).size;return{ok:a.length>0,skill_type:n,skill_test_id:r,insert:a,warnings:s,errors:t,summary:{rows_received:u.length,rows_valid:a.length,rows_with_warnings:m,rows_with_errors:t.length}}}(await e.text(),"Paraphrasing Challenge",r);if(x(s),0===s.insert.length){const e=(null==(n=s.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void u(e)}s.errors.length>0&&l.warning(`${s.errors.length} row(s) have errors and will be skipped`),s.warnings.length>0&&l.message(`${s.warnings.length} warning(s) during normalization`),g(s.insert)}catch(s){u(s.message||"Failed to parse CSV")}};return n.jsxs(t,{children:[n.jsx(a,{children:n.jsx(i,{className:"text-base",children:"Upload Paraphrasing CSV"})}),n.jsxs(o,{className:"space-y-3",children:[n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{ref:j,type:"file",accept:".csv",className:"hidden",onChange:e=>{var n;const r=null==(n=e.target.files)?void 0:n[0];r&&b(r)}}),n.jsx(c,{onClick:()=>{var e;return null==(e=j.current)?void 0:e.click()},children:"Choose CSV"}),n.jsx(c,{variant:"secondary",onClick:()=>{const e=['Paraphrasing_WordReplacement,"The project was very difficult.","Which word is the best synonym for "difficult" in the sentence above?","challenging","easy","minor","optional","Challenging is the closest synonym in this context."','Paraphrasing_SentenceRemodeling,"The company\'s profits grew.","Which word correctly completes: "There was a _______ in the company\'s profits."","growth","grow","growing","grown","Growth is the correct noun form for the remodeled sentence."','Paraphrasing_Expert,"The rapid development of technology has transformed how we communicate.","Which of the following is the best paraphrase of the sentence above?","Communication methods have been transformed by the swift advancement of technology.","Technology has quickly changed and we talk now.","People communicate faster with tech.","Technology is developing rapidly.","The correct option preserves meaning, tone, and grammatical accuracy."'].join("\n"),n=new Blob(["QuestionFormat,original_sentence,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download="paraphrasing-challenge-template.csv",s.click(),URL.revokeObjectURL(r)},children:"Download Template"})]}),h&&n.jsx(v,{variant:"destructive",children:n.jsx(_,{children:h})}),m.length>0&&n.jsxs("div",{className:"space-y-2",children:[p&&n.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",m.length," valid row(s)",p.warnings.length>0&&` • ${p.warnings.length} warning(s)`,p.errors.length>0&&` • ${p.errors.length} error row(s) skipped`]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(c,{onClick:async()=>{if(p&&0!==p.insert.length){f(!0);try{const{error:e}=await d.from("skill_practice_questions").insert(p.insert);if(e)throw e;l.success(`Imported ${p.insert.length} questions`),g([]),x(null),null==s||s()}catch(e){console.error(e),l.error(e.message||"Import failed")}finally{f(!1)}}},disabled:w,children:w?"Importing...":"Import"}),n.jsx(c,{variant:"secondary",onClick:()=>{g([]),x(null)},children:"Cancel"})]}),n.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[m.slice(0,10).map((e,r)=>n.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[n.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),n.jsxs("div",{className:"text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence||"(none)"]}),n.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},r)),m.length>10&&n.jsxs("div",{className:"text-muted-foreground",children:["...and ",m.length-10," more"]})]})]})]})]})}function S(e){const n=[...e];for(let r=n.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[n[r],n[e]]=[n[e],n[r]]}return n}function q(e){if(!e)return"";let n=e.trim();return n=n.replace(/^[\-•]\s*/,""),n=n.replace(/\*\*(.*?)\*\*/g,"$1"),n=n.replace(/\*(.*?)\*/g,"$1"),n=n.replace(/_(.*?)_/g,"$1"),n=n.replace(/`(.*?)`/g,"$1"),n}const I=r=>{const{skillTestId:s,selectedQuestionId:a,limit:i=6}=r,l=r.questions,[u,m]=e.useState([]),[g,p]=e.useState(0),[x,w]=e.useState(null),[f,j]=e.useState(0),[v,_]=e.useState(!1);e.useEffect(()=>{(async()=>{if(l&&l.length)return m(l),p(0),w(null),j(0),void _(!1);if(!s)return;const{data:e,error:n}=await d.from("skill_practice_questions").select("id,original_sentence,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",s);if(!n){const n=S(e??[]).slice(0,i);m(n),p(0),w(null),j(0),_(!1)}})()},[l,s,i]),e.useEffect(()=>{if(!a||!u.length)return;const e=u.findIndex(e=>e.id===a);e>=0&&(p(e),w(null),_(!1))},[a,u]);const y=u[g],N=e.useMemo(()=>y?S([y.correct_answer,...y.incorrect_answers||[]]):[],[y]),C=u.length?g/u.length*100:0;return s||l&&l.length?n.jsxs("div",{className:"space-y-4",children:[n.jsx(h,{value:C}),v?n.jsx(t,{children:n.jsxs(o,{className:"p-6 text-center space-y-3",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Preview complete"}),n.jsxs("div",{className:"text-muted-foreground",children:["Score: ",f," / ",u.length]}),n.jsx(c,{onClick:()=>{p(0),j(0),w(null),_(!1)},children:"Restart preview"})]})}):y?n.jsx(t,{className:"border-light-border",children:n.jsxs(o,{className:"p-6 space-y-4",children:[n.jsxs("div",{className:"text-xs text-muted-foreground",children:["Question ",g+1," of ",u.length]}),y.original_sentence&&n.jsxs("div",{className:"rounded-md border p-3 bg-muted/30",children:[n.jsx("div",{className:"text-xs text-muted-foreground font-medium mb-1",children:"Original Sentence:"}),n.jsx("div",{className:"text-sm whitespace-pre-wrap",children:y.original_sentence})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-lg mb-4 whitespace-pre-wrap",children:y.content}),n.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:N.map(e=>{const r=x&&e===y.correct_answer,s=x===e&&e!==y.correct_answer;return n.jsx(c,{variant:r?"success":s?"destructive":"outline",className:"justify-start h-auto py-3",onClick:()=>(e=>{x||(w(e),y&&e===y.correct_answer&&j(e=>e+1))})(e),children:e},e)})})]}),x&&n.jsxs("div",{className:"pt-2 space-y-3",children:[y.explanation&&n.jsxs("div",{className:"rounded-md border p-3",children:[n.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:q(y.explanation)})]}),n.jsx(c,{onClick:()=>{g+1>=u.length?_(!0):(p(e=>e+1),w(null))},children:"Continue"})]})]})}):n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Use the CSV import above."})]}):null},A=()=>{const{id:l}=r(),[h,v]=e.useState(null),[_,y]=e.useState([]),[N,C]=e.useState(null),[k,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:"",original_sentence:""}),[q,A]=e.useState(null),E=e.useRef(null),F=async()=>{if(!l)return;const{data:e}=await d.from("skill_tests").select("id,title").eq("id",l).maybeSingle();v(e??null);const{data:n}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",l).order("created_at",{ascending:!1});y(n??[])};return e.useEffect(()=>{F()},[l]),n.jsxs(s,{title:h?`Manage: ${h.title}`:"Manage Paraphrasing Test",showBackButton:!0,children:[n.jsxs("section",{className:"space-y-6",children:[l&&n.jsx(b,{skillTestId:l,onImported:F}),n.jsx(j,{}),n.jsx("div",{ref:E,children:n.jsxs(t,{children:[n.jsx(a,{children:n.jsx(i,{className:"text-base",children:"Student Preview"})}),n.jsx(o,{children:n.jsx(I,{questions:_,selectedQuestionId:q||void 0})})]})}),n.jsxs(t,{children:[n.jsx(a,{children:n.jsx(i,{className:"text-base",children:"Questions"})}),n.jsx(o,{className:"space-y-3",children:0===_.length?n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):_.map(e=>n.jsx("div",{className:"p-3 border rounded-md space-y-2",children:n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{onClick:()=>{return n=e.id,A(n),void requestAnimationFrame(()=>{var e;null==(e=E.current)||e.scrollIntoView({behavior:"smooth",block:"start"})});var n},className:"cursor-pointer",children:[n.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),e.original_sentence&&n.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),n.jsxs("div",{className:"flex gap-2 shrink-0",children:[n.jsx(c,{size:"sm",onClick:()=>(e=>{var n,r,s;C(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(n=e.incorrect_answers)?void 0:n[0])||"",incorrect2:(null==(r=e.incorrect_answers)?void 0:r[1])||"",incorrect3:(null==(s=e.incorrect_answers)?void 0:s[2])||"",explanation:e.explanation||"",original_sentence:e.original_sentence||""})})(e),children:"Edit"}),n.jsx(c,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await d.from("skill_practice_questions").delete().eq("id",e),await F())})(e.id),children:"Delete"})]})]})},e.id))})]})]}),n.jsx(u,{open:!!N,onOpenChange:e=>{e||C(null)},children:n.jsxs(m,{className:"sm:max-w-lg",children:[n.jsx(g,{children:n.jsx(p,{children:"Edit Question"})}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx(x,{htmlFor:"question_format",children:"Format"}),n.jsx(w,{id:"question_format",value:k.question_format,onChange:e=>S({...k,question_format:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"original_sentence",children:"Original Sentence"}),n.jsx(f,{id:"original_sentence",value:k.original_sentence,onChange:e=>S({...k,original_sentence:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"content",children:"Content"}),n.jsx(f,{id:"content",value:k.content,onChange:e=>S({...k,content:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"correct_answer",children:"Correct Answer"}),n.jsx(w,{id:"correct_answer",value:k.correct_answer,onChange:e=>S({...k,correct_answer:e.target.value})})]}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx(x,{children:"Incorrect 1"}),n.jsx(w,{value:k.incorrect1,onChange:e=>S({...k,incorrect1:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{children:"Incorrect 2"}),n.jsx(w,{value:k.incorrect2,onChange:e=>S({...k,incorrect2:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{children:"Incorrect 3"}),n.jsx(w,{value:k.incorrect3,onChange:e=>S({...k,incorrect3:e.target.value})})]})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"explanation",children:"Explanation"}),n.jsx(f,{id:"explanation",value:k.explanation,onChange:e=>S({...k,explanation:e.target.value})})]})]}),n.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[n.jsx(c,{variant:"outline",onClick:()=>C(null),children:"Cancel"}),n.jsx(c,{onClick:async()=>{if(!N)return;const e=[k.incorrect1,k.incorrect2,k.incorrect3].filter(Boolean),{error:n}=await d.from("skill_practice_questions").update({content:k.content,question_format:k.question_format,correct_answer:k.correct_answer,incorrect_answers:e,explanation:k.explanation,original_sentence:k.original_sentence||null}).eq("id",N.id);n||(C(null),await F())},children:"Save"})]})]})})]})};export{A as default};
