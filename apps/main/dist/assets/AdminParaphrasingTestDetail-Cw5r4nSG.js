import{r as e,j as n,C as r,b as s,c as t,a,B as i,J as o,W as c,ak as l,D as d,l as h,m as u,n as m,a8 as g,I as x,T as p}from"./index-BmiLTbvw.js";import{A as w}from"./AdminLayout-KodGO2y3.js";import{S as f}from"./separator-BIGwKUEK.js";import{s as j}from"./supabase-Bqkrifq5.js";import{A as _,a as v}from"./alert-C76gQ464.js";const y=["QuestionFormat","original_sentence","WordOrSentence","CorrectAnswer","IncorrectAnswer1","IncorrectAnswer2","IncorrectAnswer3","Explanation"];function N(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const n=e.slice(0,180),r=Math.max(n.lastIndexOf("."),n.lastIndexOf(","),n.lastIndexOf(";"),n.lastIndexOf(":"));return(r>60?n.slice(0,r):n).trim()}function k(e){const n=[];let r="",s=!1;for(let t=0;t<e.length;t++){const a=e[t];'"'===a?s&&'"'===e[t+1]?(r+='"',t++):s=!s:","!==a||s?r+=a:(n.push(r),r="")}return n.push(r),n.map(e=>e.trim())}function S({skillTestId:c,onImported:l}){const[d,h]=e.useState(null),[u,m]=e.useState([]),[g,x]=e.useState(null),[p,w]=e.useState(!1),f=e.useRef(null),S=async e=>{var n;try{h(null),m([]),x(null);const r=function(e,n,r){const s=[],t=[],a=[];let i=(e||"").replace(/^\uFEFF/,"");o=i,i=o.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'"),i=function(e){const n=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",r=(n.match(/,/g)||[]).length;return(n.match(/;/g)||[]).length>0&&0===r?e.replace(/;/g,","):e}(i);var o;const c=i.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===c.length)return{ok:!1,skill_type:n,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${y.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const l=k(c[0]).map(e=>e.replace(/^"|"$/g,"").trim()),d={};l.forEach((e,n)=>d[e]=n);const h=y.filter(e=>void 0===d[e]);if(h.length>0)return{ok:!1,skill_type:n,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${h.join("; ")}. Expected: ${y.join(",")}`,raw:Object.fromEntries(l.map((e,n)=>[n.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=c.slice(1);u.forEach((e,i)=>{const o=i+1,c=k(e),l=e=>N(function(e){return e.replace(/<[^>]*>/g,"")}(c[d[e]]||"")),h=l("QuestionFormat"),u=C(l("original_sentence")),m=C(l("WordOrSentence")),g=C(l("CorrectAnswer")),x=C(l("IncorrectAnswer1")),p=C(l("IncorrectAnswer2")),w=C(l("IncorrectAnswer3")),f=C(l("Explanation")),j={QuestionFormat:h,original_sentence:u,WordOrSentence:m,CorrectAnswer:g,IncorrectAnswer1:x,IncorrectAnswer2:p,IncorrectAnswer3:w,Explanation:f};if(!h||!m||!g)return void t.push({row:o,message:"Missing critical fields",raw:j});if(!function(e){const n=e.replace(/[^a-z]/gi,"").toLowerCase();return["paraphrasingwordreplacement","paraphrasingsentenceremodeling","paraphrasingexpert"].includes(n)}(h))return void t.push({row:o,message:`Unrecognized QuestionFormat: ${h}`,raw:j});const _=[g,...[x,p,w].filter(e=>null!=e)].map(e=>N(e)).filter(Boolean),v=new Set;let y=_.filter(e=>{const n=e.toLowerCase();return!v.has(n)&&(v.add(n),!0)});if(y.length<4){const e=new Set(y.map(e=>e.toLowerCase())),n=4-y.length;for(let r=0;r<n;r++){let n=1;for(;e.has(`Distractor ${n}`.toLowerCase());)n++;const r=`Distractor ${n}`;y.push(r),e.add(r.toLowerCase()),s.push({row:o,message:"Added placeholder distractor to ensure 4 options"})}}const S=y[0],b=y.slice(1,4);a.push({skill_type:n,skill_test_id:r,question_format:h,content:m,correct_answer:S,incorrect_answers:b,explanation:f||void 0,original_sentence:u||null})});const m=new Set(s.map(e=>e.row)).size;return{ok:a.length>0,skill_type:n,skill_test_id:r,insert:a,warnings:s,errors:t,summary:{rows_received:u.length,rows_valid:a.length,rows_with_warnings:m,rows_with_errors:t.length}}}(await e.text(),"Paraphrasing Challenge",c);if(x(r),0===r.insert.length){const e=(null==(n=r.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void h(e)}r.errors.length>0&&o.warning(`${r.errors.length} row(s) have errors and will be skipped`),r.warnings.length>0&&o.message(`${r.warnings.length} warning(s) during normalization`),m(r.insert)}catch(r){h(r.message||"Failed to parse CSV")}};return n.jsxs(r,{children:[n.jsx(s,{children:n.jsx(t,{className:"text-base",children:"Upload Paraphrasing CSV"})}),n.jsxs(a,{className:"space-y-3",children:[n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{ref:f,type:"file",accept:".csv",className:"hidden",onChange:e=>{var n;const r=null==(n=e.target.files)?void 0:n[0];r&&S(r)}}),n.jsx(i,{onClick:()=>{var e;return null==(e=f.current)?void 0:e.click()},children:"Choose CSV"}),n.jsx(i,{variant:"secondary",onClick:()=>{const e=['Paraphrasing_WordReplacement,"The project was very difficult.","Which word is the best synonym for "difficult" in the sentence above?","challenging","easy","minor","optional","Challenging is the closest synonym in this context."','Paraphrasing_SentenceRemodeling,"The company\'s profits grew.","Which word correctly completes: "There was a _______ in the company\'s profits."","growth","grow","growing","grown","Growth is the correct noun form for the remodeled sentence."','Paraphrasing_Expert,"The rapid development of technology has transformed how we communicate.","Which of the following is the best paraphrase of the sentence above?","Communication methods have been transformed by the swift advancement of technology.","Technology has quickly changed and we talk now.","People communicate faster with tech.","Technology is developing rapidly.","The correct option preserves meaning, tone, and grammatical accuracy."'].join("\n"),n=new Blob(["QuestionFormat,original_sentence,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download="paraphrasing-challenge-template.csv",s.click(),URL.revokeObjectURL(r)},children:"Download Template"})]}),d&&n.jsx(_,{variant:"destructive",children:n.jsx(v,{children:d})}),u.length>0&&n.jsxs("div",{className:"space-y-2",children:[g&&n.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",u.length," valid row(s)",g.warnings.length>0&&` • ${g.warnings.length} warning(s)`,g.errors.length>0&&` • ${g.errors.length} error row(s) skipped`]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(i,{onClick:async()=>{if(g&&0!==g.insert.length){w(!0);try{const{error:e}=await j.from("skill_practice_questions").insert(g.insert);if(e)throw e;o.success(`Imported ${g.insert.length} questions`),m([]),x(null),null==l||l()}catch(e){console.error(e),o.error(e.message||"Import failed")}finally{w(!1)}}},disabled:p,children:p?"Importing...":"Import"}),n.jsx(i,{variant:"secondary",onClick:()=>{m([]),x(null)},children:"Cancel"})]}),n.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[u.slice(0,10).map((e,r)=>n.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[n.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),n.jsxs("div",{className:"text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence||"(none)"]}),n.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},r)),u.length>10&&n.jsxs("div",{className:"text-muted-foreground",children:["...and ",u.length-10," more"]})]})]})]})]})}function b(e){const n=[...e];for(let r=n.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[n[r],n[e]]=[n[e],n[r]]}return n}function q(e){if(!e)return"";let n=e.trim();return n=n.replace(/^[\-•]\s*/,""),n=n.replace(/\*\*(.*?)\*\*/g,"$1"),n=n.replace(/\*(.*?)\*/g,"$1"),n=n.replace(/_(.*?)_/g,"$1"),n=n.replace(/`(.*?)`/g,"$1"),n}const I=s=>{const{skillTestId:t,selectedQuestionId:o,limit:l=6}=s,d=s.questions,[h,u]=e.useState([]),[m,g]=e.useState(0),[x,p]=e.useState(null),[w,f]=e.useState(0),[_,v]=e.useState(!1);e.useEffect(()=>{(async()=>{if(d&&d.length)return u(d),g(0),p(null),f(0),void v(!1);if(!t)return;const{data:e,error:n}=await j.from("skill_practice_questions").select("id,original_sentence,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",t);if(!n){const n=b(e??[]).slice(0,l);u(n),g(0),p(null),f(0),v(!1)}})()},[d,t,l]),e.useEffect(()=>{if(!o||!h.length)return;const e=h.findIndex(e=>e.id===o);e>=0&&(g(e),p(null),v(!1))},[o,h]);const y=h[m],N=e.useMemo(()=>y?b([y.correct_answer,...y.incorrect_answers||[]]):[],[y]),C=h.length?m/h.length*100:0;return t||d&&d.length?n.jsxs("div",{className:"space-y-4",children:[n.jsx(c,{value:C}),_?n.jsx(r,{children:n.jsxs(a,{className:"p-6 text-center space-y-3",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Preview complete"}),n.jsxs("div",{className:"text-muted-foreground",children:["Score: ",w," / ",h.length]}),n.jsx(i,{onClick:()=>{g(0),f(0),p(null),v(!1)},children:"Restart preview"})]})}):y?n.jsx(r,{className:"border-light-border",children:n.jsxs(a,{className:"p-6 space-y-4",children:[n.jsxs("div",{className:"text-xs text-muted-foreground",children:["Question ",m+1," of ",h.length]}),y.original_sentence&&n.jsxs("div",{className:"rounded-md border p-3 bg-muted/30",children:[n.jsx("div",{className:"text-xs text-muted-foreground font-medium mb-1",children:"Original Sentence:"}),n.jsx("div",{className:"text-sm whitespace-pre-wrap",children:y.original_sentence})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-lg mb-4 whitespace-pre-wrap",children:y.content}),n.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:N.map(e=>{const r=x&&e===y.correct_answer,s=x===e&&e!==y.correct_answer;return n.jsx(i,{variant:r?"success":s?"destructive":"outline",className:"justify-start h-auto py-3",onClick:()=>(e=>{x||(p(e),y&&e===y.correct_answer&&f(e=>e+1))})(e),children:e},e)})})]}),x&&n.jsxs("div",{className:"pt-2 space-y-3",children:[y.explanation&&n.jsxs("div",{className:"rounded-md border p-3",children:[n.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:q(y.explanation)})]}),n.jsx(i,{onClick:()=>{m+1>=h.length?v(!0):(g(e=>e+1),p(null))},children:"Continue"})]})]})}):n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Use the CSV import above."})]}):null},A=()=>{const{id:o}=l(),[c,_]=e.useState(null),[v,y]=e.useState([]),[N,C]=e.useState(null),[k,b]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:"",original_sentence:""}),[q,A]=e.useState(null),E=e.useRef(null),F=async()=>{if(!o)return;const{data:e}=await j.from("skill_tests").select("id,title").eq("id",o).maybeSingle();_(e??null);const{data:n}=await j.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",o).order("created_at",{ascending:!1});y(n??[])};return e.useEffect(()=>{F()},[o]),n.jsxs(w,{title:c?`Manage: ${c.title}`:"Manage Paraphrasing Test",showBackButton:!0,children:[n.jsxs("section",{className:"space-y-6",children:[o&&n.jsx(S,{skillTestId:o,onImported:F}),n.jsx(f,{}),n.jsx("div",{ref:E,children:n.jsxs(r,{children:[n.jsx(s,{children:n.jsx(t,{className:"text-base",children:"Student Preview"})}),n.jsx(a,{children:n.jsx(I,{questions:v,selectedQuestionId:q||void 0})})]})}),n.jsxs(r,{children:[n.jsx(s,{children:n.jsx(t,{className:"text-base",children:"Questions"})}),n.jsx(a,{className:"space-y-3",children:0===v.length?n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):v.map(e=>n.jsx("div",{className:"p-3 border rounded-md space-y-2",children:n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{onClick:()=>{return n=e.id,A(n),void requestAnimationFrame(()=>{var e;null==(e=E.current)||e.scrollIntoView({behavior:"smooth",block:"start"})});var n},className:"cursor-pointer",children:[n.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),e.original_sentence&&n.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),n.jsxs("div",{className:"flex gap-2 shrink-0",children:[n.jsx(i,{size:"sm",onClick:()=>(e=>{var n,r,s;C(e),b({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(n=e.incorrect_answers)?void 0:n[0])||"",incorrect2:(null==(r=e.incorrect_answers)?void 0:r[1])||"",incorrect3:(null==(s=e.incorrect_answers)?void 0:s[2])||"",explanation:e.explanation||"",original_sentence:e.original_sentence||""})})(e),children:"Edit"}),n.jsx(i,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await j.from("skill_practice_questions").delete().eq("id",e),await F())})(e.id),children:"Delete"})]})]})},e.id))})]})]}),n.jsx(d,{open:!!N,onOpenChange:e=>{e||C(null)},children:n.jsxs(h,{className:"sm:max-w-lg",children:[n.jsx(u,{children:n.jsx(m,{children:"Edit Question"})}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx(g,{htmlFor:"question_format",children:"Format"}),n.jsx(x,{id:"question_format",value:k.question_format,onChange:e=>b({...k,question_format:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(g,{htmlFor:"original_sentence",children:"Original Sentence"}),n.jsx(p,{id:"original_sentence",value:k.original_sentence,onChange:e=>b({...k,original_sentence:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(g,{htmlFor:"content",children:"Content"}),n.jsx(p,{id:"content",value:k.content,onChange:e=>b({...k,content:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(g,{htmlFor:"correct_answer",children:"Correct Answer"}),n.jsx(x,{id:"correct_answer",value:k.correct_answer,onChange:e=>b({...k,correct_answer:e.target.value})})]}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx(g,{children:"Incorrect 1"}),n.jsx(x,{value:k.incorrect1,onChange:e=>b({...k,incorrect1:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(g,{children:"Incorrect 2"}),n.jsx(x,{value:k.incorrect2,onChange:e=>b({...k,incorrect2:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(g,{children:"Incorrect 3"}),n.jsx(x,{value:k.incorrect3,onChange:e=>b({...k,incorrect3:e.target.value})})]})]}),n.jsxs("div",{children:[n.jsx(g,{htmlFor:"explanation",children:"Explanation"}),n.jsx(p,{id:"explanation",value:k.explanation,onChange:e=>b({...k,explanation:e.target.value})})]})]}),n.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[n.jsx(i,{variant:"outline",onClick:()=>C(null),children:"Cancel"}),n.jsx(i,{onClick:async()=>{if(!N)return;const e=[k.incorrect1,k.incorrect2,k.incorrect3].filter(Boolean),{error:n}=await j.from("skill_practice_questions").update({content:k.content,question_format:k.question_format,correct_answer:k.correct_answer,incorrect_answers:e,explanation:k.explanation,original_sentence:k.original_sentence||null}).eq("id",N.id);n||(C(null),await F())},children:"Save"})]})]})})]})};export{A as default};
