import{c as e,r as s,j as t}from"./vendor-react-JN_hy__U.js";import{A as a}from"./AdminLayout-D3lPYw5Y.js";import{d as i,C as r,b as n,c as d,a as l,B as c,L as o,T as u,s as m}from"./index-DXpPY1B7.js";import{S as x}from"./separator-Bv0Pudil.js";import{y as h,aY as f,q as p,aL as j,aw as g}from"./vendor-ui-DG51EGkO.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const _=()=>{const{id:_}=e(),{toast:v}=i(),[N,w]=s.useState([]),[b,y]=s.useState(!1),[k,S]=s.useState({reference_text:""}),[C,A]=s.useState(""),[U,P]=s.useState(!1),[T,z]=s.useState(!1),[q,E]=s.useState(null),[G,B]=s.useState(null),[D,F]=s.useState(null),L=N.length>=10,$=async()=>{if(!_)return;const{data:e,error:s}=await m.from("pronunciation_items").select("id,reference_text,audio_url_uk,audio_url_us,order_index").eq("test_id",_).order("order_index",{ascending:!0}).order("created_at",{ascending:!0});s&&v({title:"Failed to load items",description:s.message,variant:"destructive"}),w(e??[]);const{data:t,error:a}=await m.from("pronunciation_tests").select("title,is_published").eq("id",_).maybeSingle();a?console.error(a):t&&(A(t.title),P(!!t.is_published))};s.useEffect(()=>{document.title="Pronunciation Items | Admin",$()},[_]);const K=async(e,s,t)=>{if(!_)return;const a="uk"===t?E:B;a(e);try{const{data:a,error:i}=await m.functions.invoke("pronunciation-generate-audio",{body:{text:s,accent:t,test_id:_,item_id:e}});if(i)throw i;if(!(null==a?void 0:a.success))throw new Error((null==a?void 0:a.error)||"Generation failed");v({title:`${t.toUpperCase()} Audio Generated`,description:"Audio has been saved successfully."}),await $()}catch(i){console.error(i),v({title:`${t.toUpperCase()} Audio Generation Failed`,description:i.message,variant:"destructive"})}finally{a(null)}},R=(e,s,t)=>{const a=`${s}-${t}`;if(D===a)return void F(null);F(a);const i=new Audio(e);i.play(),i.onended=()=>F(null)};return t.jsx(a,{title:"PTE Repeat Sentence",showBackButton:!0,backPath:"/admin/skills/pronunciation-repeat-after-me",children:t.jsxs("section",{className:"space-y-6",children:[t.jsxs(r,{children:[t.jsx(n,{children:t.jsxs(d,{className:"text-base flex items-center gap-2",children:["Test: ",C||"Untitled",t.jsx("span",{className:"text-xs px-2 py-1 rounded "+(U?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"),children:U?"Published":"Draft"})]})}),t.jsxs(l,{className:"flex items-center gap-2",children:[t.jsxs(c,{size:"sm",onClick:async()=>{if(_)try{z(!0);const{error:e}=await m.from("pronunciation_tests").update({is_published:!U}).eq("id",_);if(e)throw e;P(!U),v({title:U?"Unpublished":"Published",description:U?"Test hidden from students.":"Students can now see this test."})}catch(e){console.error(e),v({title:"Update failed",description:e.message,variant:"destructive"})}finally{z(!1)}},disabled:T,children:[T?t.jsx(h,{className:"w-4 h-4 animate-spin mr-1"}):null,U?"Unpublish":"Publish"]}),t.jsx("p",{className:"text-sm text-muted-foreground",children:U?"Visible to students":"Hidden from students"})]})]}),t.jsxs(r,{children:[t.jsx(n,{children:t.jsxs(d,{className:"text-base",children:["Add Sentence â€” ",N.length,"/10"]})}),t.jsx(l,{className:"space-y-4",children:L?t.jsx("p",{className:"text-sm text-muted-foreground",children:"Maximum 10 sentences reached. Delete one to add more."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx(o,{htmlFor:"sentence",children:"Sentence Text (PTE difficulty)"}),t.jsx(u,{id:"sentence",rows:3,value:k.reference_text,onChange:e=>S({reference_text:e.target.value}),disabled:b,placeholder:"Enter a PTE-difficulty sentence that students will repeat..."}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Tip: Use complex academic or professional sentences, 10-20 words in length."})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(c,{onClick:async()=>{if(_)if(N.length>=10)v({title:"Limit reached (10 items max)",variant:"destructive"});else if(k.reference_text.trim())try{y(!0);const e=N.length+1,{data:s,error:t}=await m.from("pronunciation_items").insert({test_id:_,reference_text:k.reference_text.trim(),order_index:e}).select("id").single();if(t)throw t;S({reference_text:""}),v({title:"Sentence added",description:"Now generate audio for UK and US accents."}),await $()}catch(e){console.error(e),v({title:"Add failed",description:e.message,variant:"destructive"})}finally{y(!1)}else v({title:"Sentence text required",variant:"destructive"})},disabled:b||!k.reference_text.trim(),children:[b?t.jsx(h,{className:"w-4 h-4 animate-spin mr-1"}):null,b?"Adding...":"Add Sentence"]}),t.jsx(c,{variant:"secondary",onClick:()=>S({reference_text:""}),children:"Clear"})]})]})})]}),t.jsx(x,{}),t.jsxs(r,{children:[t.jsx(n,{children:t.jsxs(d,{className:"text-base",children:["Sentences (",N.length,"/10)"]})}),t.jsx(l,{className:"space-y-4",children:0===N.length?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No sentences yet. Add the first one above."}):N.map((e,s)=>t.jsxs("div",{className:"p-4 border rounded-lg space-y-3 bg-muted/30",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["#",s+1]}),t.jsx("p",{className:"text-sm mt-1",children:e.reference_text})]}),t.jsx(c,{size:"sm",variant:"ghost",className:"text-destructive hover:text-destructive",onClick:()=>(async e=>{if(!confirm("Delete this sentence and its audio files?"))return;const{error:s}=await m.from("pronunciation_items").delete().eq("id",e);s?v({title:"Delete failed",description:s.message,variant:"destructive"}):(v({title:"Sentence deleted"}),await $())})(e.id),children:t.jsx(f,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded bg-background",children:[t.jsx("div",{className:"flex-1",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-medium",children:"ðŸ‡¬ðŸ‡§ UK"}),e.audio_url_uk?t.jsx(p,{className:"w-4 h-4 text-green-500"}):t.jsx("span",{className:"text-xs text-muted-foreground",children:"Not generated"})]})}),e.audio_url_uk?t.jsxs(c,{size:"sm",variant:"outline",onClick:()=>R(e.audio_url_uk,e.id,"uk"),children:[t.jsx(j,{className:"w-4 h-4 mr-1"}),"Play"]}):t.jsxs(c,{size:"sm",onClick:()=>K(e.id,e.reference_text,"uk"),disabled:q===e.id,children:[q===e.id?t.jsx(h,{className:"w-4 h-4 animate-spin mr-1"}):t.jsx(g,{className:"w-4 h-4 mr-1"}),"Generate"]})]}),t.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded bg-background",children:[t.jsx("div",{className:"flex-1",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-medium",children:"ðŸ‡ºðŸ‡¸ US"}),e.audio_url_us?t.jsx(p,{className:"w-4 h-4 text-green-500"}):t.jsx("span",{className:"text-xs text-muted-foreground",children:"Not generated"})]})}),e.audio_url_us?t.jsxs(c,{size:"sm",variant:"outline",onClick:()=>R(e.audio_url_us,e.id,"us"),children:[t.jsx(j,{className:"w-4 h-4 mr-1"}),"Play"]}):t.jsxs(c,{size:"sm",onClick:()=>K(e.id,e.reference_text,"us"),disabled:G===e.id,children:[G===e.id?t.jsx(h,{className:"w-4 h-4 animate-spin mr-1"}):t.jsx(g,{className:"w-4 h-4 mr-1"}),"Generate"]})]})]}),(!e.audio_url_uk||!e.audio_url_us)&&t.jsxs(c,{size:"sm",variant:"secondary",className:"w-full",onClick:()=>(async(e,s)=>{await K(e,s,"uk"),await K(e,s,"us")})(e.id,e.reference_text),disabled:q===e.id||G===e.id,children:[q===e.id||G===e.id?t.jsx(h,{className:"w-4 h-4 animate-spin mr-1"}):null,"Generate Both UK & US Audio"]}),e.audio_url_uk&&e.audio_url_us&&t.jsxs("div",{className:"flex items-center gap-1 text-xs text-green-600",children:[t.jsx(p,{className:"w-3 h-3"}),"Ready for students"]})]},e.id))})]})]})})};export{_ as default};
