import{G as e,h as s,r as t,j as a,C as i,b as n,d as r,a as d,B as l,av as c,R as o,T as u,x as m,Z as x,V as h}from"./index-DYtCQA4x.js";import{A as f}from"./AdminLayout-94XAx6uV.js";import{S as p}from"./separator-DWLkqyZK.js";import{s as j}from"./supabase-DWL4C3fA.js";import{T as g}from"./trash-2-BcOSImvv.js";const _=()=>{const{id:_}=e(),{toast:N}=s(),[v,w]=t.useState([]),[b,y]=t.useState(!1),[k,S]=t.useState({reference_text:""}),[C,A]=t.useState(""),[U,P]=t.useState(!1),[T,z]=t.useState(!1),[G,E]=t.useState(null),[q,B]=t.useState(null),[D,F]=t.useState(null),$=v.length>=10,K=async()=>{if(!_)return;const{data:e,error:s}=await j.from("pronunciation_items").select("id,reference_text,audio_url_uk,audio_url_us,order_index").eq("test_id",_).order("order_index",{ascending:!0}).order("created_at",{ascending:!0});s&&N({title:"Failed to load items",description:s.message,variant:"destructive"}),w(e??[]);const{data:t,error:a}=await j.from("pronunciation_tests").select("title,is_published").eq("id",_).maybeSingle();a?console.error(a):t&&(A(t.title),P(!!t.is_published))};t.useEffect(()=>{document.title="Pronunciation Items | Admin",K()},[_]);const R=async(e,s,t)=>{if(!_)return;const a="uk"===t?E:B;a(e);try{const{data:a,error:i}=await j.functions.invoke("pronunciation-generate-audio",{body:{text:s,accent:t,test_id:_,item_id:e}});if(i)throw i;if(!(null==a?void 0:a.success))throw new Error((null==a?void 0:a.error)||"Generation failed");N({title:`${t.toUpperCase()} Audio Generated`,description:"Audio has been saved successfully."}),await K()}catch(i){console.error(i),N({title:`${t.toUpperCase()} Audio Generation Failed`,description:i.message,variant:"destructive"})}finally{a(null)}},L=(e,s,t)=>{const a=`${s}-${t}`;if(D===a)return void F(null);F(a);const i=new Audio(e);i.play(),i.onended=()=>F(null)};return a.jsx(f,{title:"PTE Repeat Sentence",showBackButton:!0,backPath:"/admin/skills/pronunciation-repeat-after-me",children:a.jsxs("section",{className:"space-y-6",children:[a.jsxs(i,{children:[a.jsx(n,{children:a.jsxs(r,{className:"text-base flex items-center gap-2",children:["Test: ",C||"Untitled",a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(U?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"),children:U?"Published":"Draft"})]})}),a.jsxs(d,{className:"flex items-center gap-2",children:[a.jsxs(l,{size:"sm",onClick:async()=>{if(_)try{z(!0);const{error:e}=await j.from("pronunciation_tests").update({is_published:!U}).eq("id",_);if(e)throw e;P(!U),N({title:U?"Unpublished":"Published",description:U?"Test hidden from students.":"Students can now see this test."})}catch(e){console.error(e),N({title:"Update failed",description:e.message,variant:"destructive"})}finally{z(!1)}},disabled:T,children:[T?a.jsx(c,{className:"w-4 h-4 animate-spin mr-1"}):null,U?"Unpublish":"Publish"]}),a.jsx("p",{className:"text-sm text-muted-foreground",children:U?"Visible to students":"Hidden from students"})]})]}),a.jsxs(i,{children:[a.jsx(n,{children:a.jsxs(r,{className:"text-base",children:["Add Sentence â€” ",v.length,"/10"]})}),a.jsx(d,{className:"space-y-4",children:$?a.jsx("p",{className:"text-sm text-muted-foreground",children:"Maximum 10 sentences reached. Delete one to add more."}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:[a.jsx(o,{htmlFor:"sentence",children:"Sentence Text (PTE difficulty)"}),a.jsx(u,{id:"sentence",rows:3,value:k.reference_text,onChange:e=>S({reference_text:e.target.value}),disabled:b,placeholder:"Enter a PTE-difficulty sentence that students will repeat..."}),a.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Tip: Use complex academic or professional sentences, 10-20 words in length."})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(l,{onClick:async()=>{if(_)if(v.length>=10)N({title:"Limit reached (10 items max)",variant:"destructive"});else if(k.reference_text.trim())try{y(!0);const e=v.length+1,{data:s,error:t}=await j.from("pronunciation_items").insert({test_id:_,reference_text:k.reference_text.trim(),order_index:e}).select("id").single();if(t)throw t;S({reference_text:""}),N({title:"Sentence added",description:"Now generate audio for UK and US accents."}),await K()}catch(e){console.error(e),N({title:"Add failed",description:e.message,variant:"destructive"})}finally{y(!1)}else N({title:"Sentence text required",variant:"destructive"})},disabled:b||!k.reference_text.trim(),children:[b?a.jsx(c,{className:"w-4 h-4 animate-spin mr-1"}):null,b?"Adding...":"Add Sentence"]}),a.jsx(l,{variant:"secondary",onClick:()=>S({reference_text:""}),children:"Clear"})]})]})})]}),a.jsx(p,{}),a.jsxs(i,{children:[a.jsx(n,{children:a.jsxs(r,{className:"text-base",children:["Sentences (",v.length,"/10)"]})}),a.jsx(d,{className:"space-y-4",children:0===v.length?a.jsx("p",{className:"text-sm text-muted-foreground",children:"No sentences yet. Add the first one above."}):v.map((e,s)=>a.jsxs("div",{className:"p-4 border rounded-lg space-y-3 bg-muted/30",children:[a.jsxs("div",{className:"flex items-start justify-between gap-2",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["#",s+1]}),a.jsx("p",{className:"text-sm mt-1",children:e.reference_text})]}),a.jsx(l,{size:"sm",variant:"ghost",className:"text-destructive hover:text-destructive",onClick:()=>(async e=>{if(!confirm("Delete this sentence and its audio files?"))return;const{error:s}=await j.from("pronunciation_items").delete().eq("id",e);s?N({title:"Delete failed",description:s.message,variant:"destructive"}):(N({title:"Sentence deleted"}),await K())})(e.id),children:a.jsx(g,{className:"w-4 h-4"})})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[a.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded bg-background",children:[a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium",children:"ðŸ‡¬ðŸ‡§ UK"}),e.audio_url_uk?a.jsx(m,{className:"w-4 h-4 text-green-500"}):a.jsx("span",{className:"text-xs text-muted-foreground",children:"Not generated"})]})}),e.audio_url_uk?a.jsxs(l,{size:"sm",variant:"outline",onClick:()=>L(e.audio_url_uk,e.id,"uk"),children:[a.jsx(x,{className:"w-4 h-4 mr-1"}),"Play"]}):a.jsxs(l,{size:"sm",onClick:()=>R(e.id,e.reference_text,"uk"),disabled:G===e.id,children:[G===e.id?a.jsx(c,{className:"w-4 h-4 animate-spin mr-1"}):a.jsx(h,{className:"w-4 h-4 mr-1"}),"Generate"]})]}),a.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded bg-background",children:[a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium",children:"ðŸ‡ºðŸ‡¸ US"}),e.audio_url_us?a.jsx(m,{className:"w-4 h-4 text-green-500"}):a.jsx("span",{className:"text-xs text-muted-foreground",children:"Not generated"})]})}),e.audio_url_us?a.jsxs(l,{size:"sm",variant:"outline",onClick:()=>L(e.audio_url_us,e.id,"us"),children:[a.jsx(x,{className:"w-4 h-4 mr-1"}),"Play"]}):a.jsxs(l,{size:"sm",onClick:()=>R(e.id,e.reference_text,"us"),disabled:q===e.id,children:[q===e.id?a.jsx(c,{className:"w-4 h-4 animate-spin mr-1"}):a.jsx(h,{className:"w-4 h-4 mr-1"}),"Generate"]})]})]}),(!e.audio_url_uk||!e.audio_url_us)&&a.jsxs(l,{size:"sm",variant:"secondary",className:"w-full",onClick:()=>(async(e,s)=>{await R(e,s,"uk"),await R(e,s,"us")})(e.id,e.reference_text),disabled:G===e.id||q===e.id,children:[G===e.id||q===e.id?a.jsx(c,{className:"w-4 h-4 animate-spin mr-1"}):null,"Generate Both UK & US Audio"]}),e.audio_url_uk&&e.audio_url_us&&a.jsxs("div",{className:"flex items-center gap-1 text-xs text-green-600",children:[a.jsx(m,{className:"w-3 h-3"}),"Ready for students"]})]},e.id))})]})]})})};export{_ as default};
