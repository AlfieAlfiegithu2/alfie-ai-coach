import{ao as e,h as t,r as s,j as i,A as a,C as r,b as n,c as d,a as l,B as c,ap as o,G as u,I as m,_ as h}from"./index-BgpWJ842.js";import{s as x}from"./supabase-Bqkrifq5.js";const f=()=>{const{id:f}=e(),{toast:p}=t(),[j,v]=s.useState([]),[g,b]=s.useState(!1),_=s.useRef(null),[y,w]=s.useState({reference_text:""}),[N,A]=s.useState(null),[C,S]=s.useState(""),[U,k]=s.useState(!1),[I,P]=s.useState(!1),q=j.length>=10,D=async()=>{if(!f)return;const{data:e,error:t}=await x.from("pronunciation_items").select("id,reference_text,audio_url,order_index,accent").eq("test_id",f).order("order_index",{ascending:!0}).order("created_at",{ascending:!0});t&&p({title:"Failed to load items",description:t.message,variant:"destructive"}),v(e??[]);const{data:s,error:i}=await x.from("pronunciation_tests").select("title,is_published").eq("id",f).maybeSingle();i?console.error(i):s&&(S(s.title),k(!!s.is_published))};s.useEffect(()=>{document.title="Pronunciation Items | Admin",D()},[f]);const[R,B]=s.useState("american");return i.jsx(a,{title:"Pronunciation: Repeat After Me",showBackButton:!0,backPath:"/admin/skills/pronunciation-repeat-after-me",children:i.jsxs("section",{className:"space-y-6",children:[i.jsxs(r,{children:[i.jsx(n,{children:i.jsxs(d,{className:"text-base",children:["Test: ",C||"Untitled"," — ",U?"Published":"Unpublished"]})}),i.jsxs(l,{className:"flex items-center gap-2",children:[i.jsx(c,{size:"sm",onClick:async()=>{if(f)try{P(!0);const{error:e}=await x.from("pronunciation_tests").update({is_published:!U}).eq("id",f);if(e)throw e;k(!U),p({title:U?"Unpublished":"Published",description:U?"Test hidden from students.":"Students can now see this test."})}catch(e){console.error(e),p({title:"Update failed",description:e.message,variant:"destructive"})}finally{P(!1)}},disabled:I,children:U?"Unpublish":"Publish"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:U?"Visible to students":"Hidden from students"})]})]}),i.jsxs(r,{children:[i.jsx(n,{children:i.jsxs(d,{className:"text-base",children:["Add Item (Reference Text + Voice-over) — ",j.length,"/10"]})}),i.jsxs(l,{className:"space-y-3",children:[q&&i.jsx("p",{className:"text-sm text-muted-foreground",children:"You have reached the maximum of 10 items. Delete an item to add another."}),i.jsxs("div",{children:[i.jsx(o,{htmlFor:"ref",children:"Reference text (what students should say)"}),i.jsx(u,{id:"ref",rows:3,value:y.reference_text,onChange:e=>w({reference_text:e.target.value}),disabled:q||g})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(o,{children:"Voice-over file (mp3, wav, m4a...)"}),i.jsx(m,{ref:_,type:"file",accept:"audio/*",onChange:e=>{var t;return A((null==(t=e.target.files)?void 0:t[0])??null)},disabled:q||g})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(o,{children:"Accent"}),i.jsxs("select",{className:"border rounded-md px-2 py-2",value:R,onChange:e=>B(e.target.value),disabled:q||g,children:[i.jsx("option",{value:"american",children:"American"}),i.jsx("option",{value:"british",children:"British"})]})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx(c,{onClick:async()=>{var e;if(f)if(j.length>=10)p({title:"Limit reached (10 items max)",variant:"destructive"});else if(y.reference_text.trim())if(N)try{b(!0);const t=(null==(e=N.name.split(".").pop())?void 0:e.toLowerCase())||"mp3",s=`pronunciation/${f}/${Date.now()}.${t}`,{error:i}=await x.storage.from("audio-files").upload(s,N,{upsert:!1});if(i)throw i;const{data:a}=x.storage.from("audio-files").getPublicUrl(s),r=a.publicUrl,n=j.length+1,{error:d}=await x.from("pronunciation_items").insert({test_id:f,reference_text:y.reference_text.trim(),audio_url:r,order_index:n,accent:R});if(d)throw d;w({reference_text:""}),A(null),_.current&&(_.current.value=""),p({title:"Item added"}),await D()}catch(t){console.error(t),p({title:"Add failed",description:t.message,variant:"destructive"})}finally{b(!1)}else p({title:"Audio file required",variant:"destructive"});else p({title:"Reference text required",variant:"destructive"})},disabled:g||q,children:g?"Uploading...":"Add Item"}),i.jsx(c,{variant:"secondary",onClick:()=>{w({reference_text:""}),A(null),_.current&&(_.current.value="")},children:"Clear"})]})]})]}),i.jsx(h,{}),i.jsxs(r,{children:[i.jsx(n,{children:i.jsxs(d,{className:"text-base",children:["Items (",j.length,"/10)"]})}),i.jsx(l,{className:"space-y-3",children:0===j.length?i.jsx("p",{className:"text-sm text-muted-foreground",children:"No items yet. Add the first one above."}):j.map(e=>i.jsxs("div",{className:"p-3 border rounded-md space-y-2",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.reference_text}),i.jsx("audio",{src:e.audio_url,controls:!0,preload:"none"}),i.jsxs("p",{className:"text-xs text-muted-foreground",children:["Accent: ",e.accent||"american"]})]}),i.jsx("div",{className:"flex gap-2",children:i.jsx(c,{size:"sm",variant:"destructive",onClick:()=>(async e=>{if(!confirm("Delete this item?"))return;const{error:t}=await x.from("pronunciation_items").delete().eq("id",e);t?p({title:"Delete failed",description:t.message,variant:"destructive"}):(p({title:"Item deleted"}),await D())})(e.id),children:"Delete"})})]},e.id))})]})]})})};export{f as default};
