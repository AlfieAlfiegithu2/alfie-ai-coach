import{r as e,j as n,C as s,b as r,c as t,a as i,B as a,J as c,W as l,ak as o,D as d,l as m,m as u,n as h,a8 as x,I as g,T as p}from"./index-BIX8qkRl.js";import{A as j}from"./AdminLayout-C0x8Y5g2.js";import{S as f}from"./separator-DYgl_PVY.js";import{s as w}from"./supabase-Bqkrifq5.js";import{A as v,a as _}from"./alert-DgHXTk5x.js";const N=["QuestionFormat","original_sentence","WordOrSentence","CorrectAnswer","Explanation"];function b(e){return e.replace(/<[^>]*>/g,"")}function k(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const n=e.slice(0,180),s=Math.max(n.lastIndexOf("."),n.lastIndexOf(","),n.lastIndexOf(";"),n.lastIndexOf(":"));return(s>60?n.slice(0,s):n).trim()}function S(e){const n=[];let s="",r=!1;for(let t=0;t<e.length;t++){const i=e[t];'"'===i?r&&'"'===e[t+1]?(s+='"',t++):r=!r:","!==i||r?s+=i:(n.push(s),s="")}return n.push(s),n.map(e=>e.trim())}function y({skillTestId:l,onImported:o}){const[d,m]=e.useState(null),[u,h]=e.useState([]),[x,g]=e.useState(null),[p,j]=e.useState(!1),f=e.useRef(null),y=async e=>{var n;try{m(null),h([]),g(null);const s=function(e,n,s){const r=[],t=[],i=[];let a=(e||"").replace(/^\uFEFF/,"");c=a,a=c.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'"),a=function(e){const n=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",s=(n.match(/,/g)||[]).length;return(n.match(/;/g)||[]).length>0&&0===s?e.replace(/;/g,","):e}(a);var c;const l=a.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===l.length)return{ok:!1,skill_type:n,skill_test_id:s,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${N.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const o=S(l[0]).map(e=>e.replace(/^"|"$/g,"").trim()),d={};o.forEach((e,n)=>d[e]=n);const m=N.filter(e=>void 0===d[e]);if(m.length>0)return{ok:!1,skill_type:n,skill_test_id:s,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${m.join("; ")}. Expected: ${N.join(",")}`,raw:Object.fromEntries(o.map((e,n)=>[n.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=l.slice(1);u.forEach((e,a)=>{const c=a+1,l=S(e),o=e=>k(b(l[d[e]]||"")),m=e=>k(b(l[d[e]]||"")),u=o("QuestionFormat"),h=C(o("original_sentence"));let x=C(o("WordOrSentence"));const g=C(o("CorrectAnswer")),p=C(o("Explanation")),j=[];for(let n=1;n<=20;n++){const e=C(m(`IncorrectAnswer${n}`));e&&j.push(e)}const f={QuestionFormat:u,original_sentence:h,WordOrSentence:x,CorrectAnswer:g,Explanation:p,...j.reduce((e,n,s)=>({...e,[`IncorrectAnswer${s+1}`]:n}),{})};if(!u||!h||!g)return void t.push({row:c,message:"Missing critical fields (QuestionFormat, original_sentence, or CorrectAnswer)",raw:f});if(!function(e){const n=e.replace(/[^a-z]/gi,"").toLowerCase();return["sentencescramble","sentencestructure","sentencestructure scramble".replace(/\s/g,"")].includes(n)}(u))return void t.push({row:c,message:`Unrecognized QuestionFormat: ${u} (expected SentenceScramble)`,raw:f});const w=[g,...j].filter(Boolean);w.length<2?r.push({row:c,message:"Fewer than 2 chunks provided; skipping"}):(x||(x="Unscramble the sentence."),i.push({skill_type:n,skill_test_id:s,question_format:"SentenceScramble",content:x,correct_answer:w[0],incorrect_answers:w.slice(1),explanation:p||void 0,original_sentence:h}))});const h=new Set(r.map(e=>e.row)).size;return{ok:i.length>0,skill_type:n,skill_test_id:s,insert:i,warnings:r,errors:t,summary:{rows_received:u.length,rows_valid:i.length,rows_with_warnings:h,rows_with_errors:t.length}}}(await e.text(),"Sentence Structure Scramble",l);if(g(s),0===s.insert.length){const e=(null==(n=s.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void m(e)}s.errors.length>0&&c.warning(`${s.errors.length} row(s) have errors and will be skipped`),s.warnings.length>0&&c.message(`${s.warnings.length} warning(s) during normalization`),h(s.insert)}catch(s){m(s.message||"Failed to parse CSV")}};return n.jsxs(s,{children:[n.jsx(r,{children:n.jsx(t,{className:"text-base",children:"Upload Sentence Scramble CSV"})}),n.jsxs(i,{className:"space-y-3",children:[n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{ref:f,type:"file",accept:".csv",className:"hidden",onChange:e=>{var n;const s=null==(n=e.target.files)?void 0:n[0];s&&y(s)}}),n.jsx(a,{onClick:()=>{var e;return null==(e=f.current)?void 0:e.click()},children:"Choose CSV"}),n.jsx(a,{variant:"secondary",onClick:()=>{const e=['SentenceScramble,"The company will launch a new product next month.","Unscramble the sentence.","The company","will launch","a new product","next month.","This order follows Subject + Modal/Verb + Object + Time."'].join("\n"),n=new Blob(["QuestionFormat,original_sentence,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download="sentence-scramble-template.csv",r.click(),URL.revokeObjectURL(s)},children:"Download Template"})]}),d&&n.jsx(v,{variant:"destructive",children:n.jsx(_,{children:d})}),u.length>0&&n.jsxs("div",{className:"space-y-2",children:[x&&n.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",u.length," valid row(s)",x.warnings.length>0&&` • ${x.warnings.length} warning(s)`,x.errors.length>0&&` • ${x.errors.length} error row(s) skipped`]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(a,{onClick:async()=>{if(x&&0!==x.insert.length){j(!0);try{const{error:e}=await w.from("skill_practice_questions").insert(x.insert);if(e)throw e;c.success(`Imported ${x.insert.length} questions`),h([]),g(null),null==o||o()}catch(e){console.error(e),c.error(e.message||"Import failed")}finally{j(!1)}}},disabled:p,children:p?"Importing...":"Import"}),n.jsx(a,{variant:"secondary",onClick:()=>{h([]),g(null)},children:"Cancel"})]}),n.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[u.slice(0,10).map((e,s)=>n.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[n.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),n.jsxs("div",{className:"text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},s)),u.length>10&&n.jsxs("div",{className:"text-muted-foreground",children:["...and ",u.length-10," more"]})]})]})]})]})}function q(e){const n=[...e];for(let s=n.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[n[s],n[e]]=[n[e],n[s]]}return n}function I(e){if(!e)return"";let n=e.trim();return n=n.replace(/^[-•]\s*/,""),n=n.replace(/\*\*(.*?)\*\*/g,"$1"),n=n.replace(/\*(.*?)\*/g,"$1"),n=n.replace(/_(.*?)_/g,"$1"),n=n.replace(/`(.*?)`/g,"$1"),n}const $=r=>{const{skillTestId:t,selectedQuestionId:c,limit:o=20}=r,d=r.questions,[m,u]=e.useState([]),[h,x]=e.useState(0),[g,p]=e.useState([]),[j,f]=e.useState(!1),[v,_]=e.useState(0),[N,b]=e.useState(!1);e.useEffect(()=>{(async()=>{if(d&&d.length)return u(d),x(0),p([]),_(0),f(!1),void b(!1);if(!t)return;const{data:e,error:n}=await w.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",t);if(!n){const n=q(e??[]).slice(0,o);u(n),x(0),p([]),_(0),f(!1),b(!1)}})()},[d,t,o]),e.useEffect(()=>{if(!c||!m.length)return;const e=m.findIndex(e=>e.id===c);e>=0&&(x(e),p([]),b(!1),f(!1))},[c,m]);const k=m[h],C=e.useMemo(()=>{if(!k)return[];return q([k.correct_answer,...k.incorrect_answers||[]].filter(Boolean).map(e=>e.toLowerCase()))},[k]),S=m.length?h/m.length*100:0,y=()=>{if(!k)return!1;const e=[k.correct_answer,...k.incorrect_answers||[]].map(e=>e.toLowerCase());return g.length===e.length&&g.every((n,s)=>n===e[s])};return t||d&&d.length?n.jsxs("div",{className:"space-y-4",children:[n.jsx(l,{value:S}),j?n.jsx(s,{children:n.jsxs(i,{className:"p-6 text-center space-y-3",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Preview complete"}),n.jsxs("div",{className:"text-muted-foreground",children:["Score: ",v," / ",m.length]}),n.jsx(a,{onClick:()=>{x(0),_(0),p([]),b(!1),f(!1)},children:"Restart preview"})]})}):k?n.jsx(s,{className:"border-light-border",children:n.jsxs(i,{className:"p-6 space-y-4",children:[n.jsxs("div",{className:"text-xs text-muted-foreground",children:["Question ",h+1," of ",m.length]}),k.original_sentence&&n.jsxs("div",{className:"bg-muted/50 p-3 rounded-md",children:[n.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Original sentence:"}),n.jsx("div",{className:"text-sm",children:k.original_sentence})]}),n.jsx("div",{className:"text-lg font-medium",children:k.content||"Unscramble the sentence:"}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium",children:"Available chunks:"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:C.map((e,s)=>n.jsx(a,{variant:"outline",size:"sm",className:""+(g.includes(e)?"opacity-50":""),onClick:()=>(e=>{N||g.includes(e)||p([...g,e])})(e),disabled:N,children:e},`${e}-${s}`))})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium",children:"Your sentence:"}),n.jsx("div",{className:"min-h-[3rem] p-3 border-2 border-dashed border-border rounded-md bg-muted/20",children:0===g.length?n.jsx("div",{className:"text-sm text-muted-foreground italic",children:"Click chunks above to build your sentence"}):n.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((e,s)=>n.jsx(a,{variant:"secondary",size:"sm",onClick:()=>(e=>{N||p(g.filter(n=>n!==e))})(e),disabled:N,className:N?y()?"bg-green-100 text-green-800":"bg-red-100 text-red-800":"",children:e},`selected-${e}-${s}`))})})]}),!N&&g.length>0&&n.jsx(a,{onClick:()=>{if(!k||N)return;b(!0);const e=[k.correct_answer,...k.incorrect_answers||[]].map(e=>e.toLowerCase());g.length===e.length&&g.every((n,s)=>n===e[s])&&_(e=>e+1)},className:"w-full",children:"Check Answer"}),N&&n.jsxs("div",{className:"pt-2 space-y-3",children:[n.jsx("div",{className:"text-sm font-medium "+(y()?"text-green-600":"text-red-600"),children:y()?"✓ Correct!":"✗ Incorrect"}),!y()&&n.jsxs("div",{className:"bg-green-50 p-3 rounded-md",children:[n.jsx("div",{className:"text-sm font-medium text-green-800 mb-1",children:"Correct order:"}),n.jsx("div",{className:"text-sm text-green-700",children:[k.correct_answer,...k.incorrect_answers||[]].join(" ")})]}),k.explanation&&n.jsxs("div",{className:"rounded-md border p-3",children:[n.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:I(k.explanation)})]}),n.jsx(a,{onClick:()=>{h+1>=m.length?f(!0):(x(e=>e+1),p([]),b(!1))},children:"Continue"})]})]})}):n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Use the CSV import above."})]}):null},E=()=>{const{id:c}=o(),[l,v]=e.useState(null),[_,N]=e.useState([]),[b,k]=e.useState(null),[C,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:"",original_sentence:""}),[q,I]=e.useState(null),E=async()=>{if(!c)return;const{data:e}=await w.from("skill_tests").select("id,title").eq("id",c).maybeSingle();v(e??null);const{data:n}=await w.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",c).order("created_at",{ascending:!1});N(n??[])};return e.useEffect(()=>{E()},[c]),n.jsx(j,{title:l?`Manage: ${l.title}`:"Manage Sentence Scramble Test",showBackButton:!0,children:n.jsxs("section",{className:"space-y-6",children:[c&&n.jsx(y,{skillTestId:c,onImported:E}),n.jsx(f,{}),_.length>0&&n.jsxs(s,{children:[n.jsx(r,{children:n.jsx(t,{className:"text-base",children:"Student Preview"})}),n.jsx(i,{children:n.jsx($,{skillTestId:c,selectedQuestionId:q||void 0})})]}),n.jsx(f,{}),n.jsxs(s,{children:[n.jsx(r,{children:n.jsx(t,{className:"text-base",children:"Question Library"})}),n.jsx(i,{className:"space-y-3",children:0===_.length?n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):_.map(e=>n.jsx("div",{id:`question-${e.id}`,className:"p-3 border rounded-md space-y-2",children:n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{children:[n.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),e.original_sentence&&n.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),n.jsxs("div",{className:"flex gap-2 shrink-0",children:[n.jsx(a,{size:"sm",variant:"outline",onClick:()=>I(e.id),children:"Preview"}),n.jsx(a,{size:"sm",onClick:()=>(e=>{var n,s,r;k(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(n=e.incorrect_answers)?void 0:n[0])||"",incorrect2:(null==(s=e.incorrect_answers)?void 0:s[1])||"",incorrect3:(null==(r=e.incorrect_answers)?void 0:r[2])||"",explanation:e.explanation||"",original_sentence:e.original_sentence||""})})(e),children:"Edit"}),n.jsx(a,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await w.from("skill_practice_questions").delete().eq("id",e),await E())})(e.id),children:"Delete"})]})]})},e.id))})]}),n.jsx(d,{open:!!b,onOpenChange:e=>{e||k(null)},children:n.jsxs(m,{className:"sm:max-w-lg",children:[n.jsx(u,{children:n.jsx(h,{children:"Edit Question"})}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx(x,{htmlFor:"question_format",children:"Format"}),n.jsx(g,{id:"question_format",value:C.question_format,onChange:e=>S({...C,question_format:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"original_sentence",children:"Original Sentence"}),n.jsx(p,{id:"original_sentence",value:C.original_sentence,onChange:e=>S({...C,original_sentence:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"content",children:"Content"}),n.jsx(p,{id:"content",value:C.content,onChange:e=>S({...C,content:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"correct_answer",children:"Chunk 1 (first)"}),n.jsx(g,{id:"correct_answer",value:C.correct_answer,onChange:e=>S({...C,correct_answer:e.target.value})})]}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx(x,{children:"Chunk 2"}),n.jsx(g,{value:C.incorrect1,onChange:e=>S({...C,incorrect1:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{children:"Chunk 3"}),n.jsx(g,{value:C.incorrect2,onChange:e=>S({...C,incorrect2:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(x,{children:"Chunk 4"}),n.jsx(g,{value:C.incorrect3,onChange:e=>S({...C,incorrect3:e.target.value})})]})]}),n.jsxs("div",{children:[n.jsx(x,{htmlFor:"explanation",children:"Explanation"}),n.jsx(p,{id:"explanation",value:C.explanation,onChange:e=>S({...C,explanation:e.target.value})})]})]}),n.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[n.jsx(a,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),n.jsx(a,{onClick:async()=>{if(!b)return;const e=[C.incorrect1,C.incorrect2,C.incorrect3].filter(Boolean),{error:n}=await w.from("skill_practice_questions").update({content:C.content||"Unscramble the sentence.",question_format:C.question_format||"SentenceScramble",correct_answer:C.correct_answer,incorrect_answers:e,explanation:C.explanation,original_sentence:C.original_sentence||null}).eq("id",b.id);n||(k(null),await E())},children:"Save"})]})]})})]})})};export{E as default};
