import{r as e,j as n,c as s}from"./vendor-react-JN_hy__U.js";import{A as r}from"./AdminLayout-D3lPYw5Y.js";import{C as t,b as i,c as a,a as c,B as l,J as o,s as d,P as m,D as u,f as h,g as x,h as g,L as p,I as j,T as f}from"./index-DXpPY1B7.js";import{S as v}from"./separator-Bv0Pudil.js";import{A as w,a as _}from"./alert-BV1wokst.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-ui-DG51EGkO.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const N=["QuestionFormat","original_sentence","WordOrSentence","CorrectAnswer","Explanation"];function b(e){return e.replace(/<[^>]*>/g,"")}function k(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const n=e.slice(0,180),s=Math.max(n.lastIndexOf("."),n.lastIndexOf(","),n.lastIndexOf(";"),n.lastIndexOf(":"));return(s>60?n.slice(0,s):n).trim()}function S(e){const n=[];let s="",r=!1;for(let t=0;t<e.length;t++){const i=e[t];'"'===i?r&&'"'===e[t+1]?(s+='"',t++):r=!r:","!==i||r?s+=i:(n.push(s),s="")}return n.push(s),n.map(e=>e.trim())}function y({skillTestId:s,onImported:r}){const[m,u]=e.useState(null),[h,x]=e.useState([]),[g,p]=e.useState(null),[j,f]=e.useState(!1),v=e.useRef(null),y=async e=>{var n;try{u(null),x([]),p(null);const r=function(e,n,s){const r=[],t=[],i=[];let a=(e||"").replace(/^\uFEFF/,"");c=a,a=c.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'"),a=function(e){const n=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",s=(n.match(/,/g)||[]).length;return(n.match(/;/g)||[]).length>0&&0===s?e.replace(/;/g,","):e}(a);var c;const l=a.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===l.length)return{ok:!1,skill_type:n,skill_test_id:s,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${N.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const o=S(l[0]).map(e=>e.replace(/^"|"$/g,"").trim()),d={};o.forEach((e,n)=>d[e]=n);const m=N.filter(e=>void 0===d[e]);if(m.length>0)return{ok:!1,skill_type:n,skill_test_id:s,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${m.join("; ")}. Expected: ${N.join(",")}`,raw:Object.fromEntries(o.map((e,n)=>[n.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=l.slice(1);u.forEach((e,a)=>{const c=a+1,l=S(e),o=e=>k(b(l[d[e]]||"")),m=e=>k(b(l[d[e]]||"")),u=o("QuestionFormat"),h=C(o("original_sentence"));let x=C(o("WordOrSentence"));const g=C(o("CorrectAnswer")),p=C(o("Explanation")),j=[];for(let n=1;n<=20;n++){const e=C(m(`IncorrectAnswer${n}`));e&&j.push(e)}const f={QuestionFormat:u,original_sentence:h,WordOrSentence:x,CorrectAnswer:g,Explanation:p,...j.reduce((e,n,s)=>({...e,[`IncorrectAnswer${s+1}`]:n}),{})};if(!u||!h||!g)return void t.push({row:c,message:"Missing critical fields (QuestionFormat, original_sentence, or CorrectAnswer)",raw:f});if(!function(e){const n=e.replace(/[^a-z]/gi,"").toLowerCase();return["sentencescramble","sentencestructure","sentencestructure scramble".replace(/\s/g,"")].includes(n)}(u))return void t.push({row:c,message:`Unrecognized QuestionFormat: ${u} (expected SentenceScramble)`,raw:f});const v=[g,...j].filter(Boolean);v.length<2?r.push({row:c,message:"Fewer than 2 chunks provided; skipping"}):(x||(x="Unscramble the sentence."),i.push({skill_type:n,skill_test_id:s,question_format:"SentenceScramble",content:x,correct_answer:v[0],incorrect_answers:v.slice(1),explanation:p||void 0,original_sentence:h}))});const h=new Set(r.map(e=>e.row)).size;return{ok:i.length>0,skill_type:n,skill_test_id:s,insert:i,warnings:r,errors:t,summary:{rows_received:u.length,rows_valid:i.length,rows_with_warnings:h,rows_with_errors:t.length}}}(await e.text(),"Sentence Structure Scramble",s);if(p(r),0===r.insert.length){const e=(null==(n=r.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void u(e)}r.errors.length>0&&o.warning(`${r.errors.length} row(s) have errors and will be skipped`),r.warnings.length>0&&o.message(`${r.warnings.length} warning(s) during normalization`),x(r.insert)}catch(r){u(r.message||"Failed to parse CSV")}};return n.jsxs(t,{children:[n.jsx(i,{children:n.jsx(a,{className:"text-base",children:"Upload Sentence Scramble CSV"})}),n.jsxs(c,{className:"space-y-3",children:[n.jsxs("div",{className:"flex gap-2",children:[n.jsx("input",{ref:v,type:"file",accept:".csv",className:"hidden",onChange:e=>{var n;const s=null==(n=e.target.files)?void 0:n[0];s&&y(s)}}),n.jsx(l,{onClick:()=>{var e;return null==(e=v.current)?void 0:e.click()},children:"Choose CSV"}),n.jsx(l,{variant:"secondary",onClick:()=>{const e=['SentenceScramble,"The company will launch a new product next month.","Unscramble the sentence.","The company","will launch","a new product","next month.","This order follows Subject + Modal/Verb + Object + Time."'].join("\n"),n=new Blob(["QuestionFormat,original_sentence,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download="sentence-scramble-template.csv",r.click(),URL.revokeObjectURL(s)},children:"Download Template"})]}),m&&n.jsx(w,{variant:"destructive",children:n.jsx(_,{children:m})}),h.length>0&&n.jsxs("div",{className:"space-y-2",children:[g&&n.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",h.length," valid row(s)",g.warnings.length>0&&` • ${g.warnings.length} warning(s)`,g.errors.length>0&&` • ${g.errors.length} error row(s) skipped`]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(l,{onClick:async()=>{if(g&&0!==g.insert.length){f(!0);try{const{error:e}=await d.from("skill_practice_questions").insert(g.insert);if(e)throw e;o.success(`Imported ${g.insert.length} questions`),x([]),p(null),null==r||r()}catch(e){console.error(e),o.error(e.message||"Import failed")}finally{f(!1)}}},disabled:j,children:j?"Importing...":"Import"}),n.jsx(l,{variant:"secondary",onClick:()=>{x([]),p(null)},children:"Cancel"})]}),n.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[h.slice(0,10).map((e,s)=>n.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[n.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),n.jsxs("div",{className:"text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},s)),h.length>10&&n.jsxs("div",{className:"text-muted-foreground",children:["...and ",h.length-10," more"]})]})]})]})]})}function q(e){const n=[...e];for(let s=n.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[n[s],n[e]]=[n[e],n[s]]}return n}function I(e){if(!e)return"";let n=e.trim();return n=n.replace(/^[-•]\s*/,""),n=n.replace(/\*\*(.*?)\*\*/g,"$1"),n=n.replace(/\*(.*?)\*/g,"$1"),n=n.replace(/_(.*?)_/g,"$1"),n=n.replace(/`(.*?)`/g,"$1"),n}const $=s=>{const{skillTestId:r,selectedQuestionId:i,limit:a=20}=s,o=s.questions,[u,h]=e.useState([]),[x,g]=e.useState(0),[p,j]=e.useState([]),[f,v]=e.useState(!1),[w,_]=e.useState(0),[N,b]=e.useState(!1);e.useEffect(()=>{(async()=>{if(o&&o.length)return h(o),g(0),j([]),_(0),v(!1),void b(!1);if(!r)return;const{data:e,error:n}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",r);if(!n){const n=q(e??[]).slice(0,a);h(n),g(0),j([]),_(0),v(!1),b(!1)}})()},[o,r,a]),e.useEffect(()=>{if(!i||!u.length)return;const e=u.findIndex(e=>e.id===i);e>=0&&(g(e),j([]),b(!1),v(!1))},[i,u]);const k=u[x],C=e.useMemo(()=>{if(!k)return[];return q([k.correct_answer,...k.incorrect_answers||[]].filter(Boolean).map(e=>e.toLowerCase()))},[k]),S=u.length?x/u.length*100:0,y=()=>{if(!k)return!1;const e=[k.correct_answer,...k.incorrect_answers||[]].map(e=>e.toLowerCase());return p.length===e.length&&p.every((n,s)=>n===e[s])};return r||o&&o.length?n.jsxs("div",{className:"space-y-4",children:[n.jsx(m,{value:S}),f?n.jsx(t,{children:n.jsxs(c,{className:"p-6 text-center space-y-3",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Preview complete"}),n.jsxs("div",{className:"text-muted-foreground",children:["Score: ",w," / ",u.length]}),n.jsx(l,{onClick:()=>{g(0),_(0),j([]),b(!1),v(!1)},children:"Restart preview"})]})}):k?n.jsx(t,{className:"border-light-border",children:n.jsxs(c,{className:"p-6 space-y-4",children:[n.jsxs("div",{className:"text-xs text-muted-foreground",children:["Question ",x+1," of ",u.length]}),k.original_sentence&&n.jsxs("div",{className:"bg-muted/50 p-3 rounded-md",children:[n.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Original sentence:"}),n.jsx("div",{className:"text-sm",children:k.original_sentence})]}),n.jsx("div",{className:"text-lg font-medium",children:k.content||"Unscramble the sentence:"}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium",children:"Available chunks:"}),n.jsx("div",{className:"flex flex-wrap gap-2",children:C.map((e,s)=>n.jsx(l,{variant:"outline",size:"sm",className:""+(p.includes(e)?"opacity-50":""),onClick:()=>(e=>{N||p.includes(e)||j([...p,e])})(e),disabled:N,children:e},`${e}-${s}`))})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"text-sm font-medium",children:"Your sentence:"}),n.jsx("div",{className:"min-h-[3rem] p-3 border-2 border-dashed border-border rounded-md bg-muted/20",children:0===p.length?n.jsx("div",{className:"text-sm text-muted-foreground italic",children:"Click chunks above to build your sentence"}):n.jsx("div",{className:"flex flex-wrap gap-2",children:p.map((e,s)=>n.jsx(l,{variant:"secondary",size:"sm",onClick:()=>(e=>{N||j(p.filter(n=>n!==e))})(e),disabled:N,className:N?y()?"bg-green-100 text-green-800":"bg-red-100 text-red-800":"",children:e},`selected-${e}-${s}`))})})]}),!N&&p.length>0&&n.jsx(l,{onClick:()=>{if(!k||N)return;b(!0);const e=[k.correct_answer,...k.incorrect_answers||[]].map(e=>e.toLowerCase());p.length===e.length&&p.every((n,s)=>n===e[s])&&_(e=>e+1)},className:"w-full",children:"Check Answer"}),N&&n.jsxs("div",{className:"pt-2 space-y-3",children:[n.jsx("div",{className:"text-sm font-medium "+(y()?"text-green-600":"text-red-600"),children:y()?"✓ Correct!":"✗ Incorrect"}),!y()&&n.jsxs("div",{className:"bg-green-50 p-3 rounded-md",children:[n.jsx("div",{className:"text-sm font-medium text-green-800 mb-1",children:"Correct order:"}),n.jsx("div",{className:"text-sm text-green-700",children:[k.correct_answer,...k.incorrect_answers||[]].join(" ")})]}),k.explanation&&n.jsxs("div",{className:"rounded-md border p-3",children:[n.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:I(k.explanation)})]}),n.jsx(l,{onClick:()=>{x+1>=u.length?v(!0):(g(e=>e+1),j([]),b(!1))},children:"Continue"})]})]})}):n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Use the CSV import above."})]}):null},E=()=>{const{id:o}=s(),[m,w]=e.useState(null),[_,N]=e.useState([]),[b,k]=e.useState(null),[C,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:"",original_sentence:""}),[q,I]=e.useState(null),E=async()=>{if(!o)return;const{data:e}=await d.from("skill_tests").select("id,title").eq("id",o).maybeSingle();w(e??null);const{data:n}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence").eq("skill_test_id",o).order("created_at",{ascending:!1});N(n??[])};return e.useEffect(()=>{E()},[o]),n.jsx(r,{title:m?`Manage: ${m.title}`:"Manage Sentence Scramble Test",showBackButton:!0,children:n.jsxs("section",{className:"space-y-6",children:[o&&n.jsx(y,{skillTestId:o,onImported:E}),n.jsx(v,{}),_.length>0&&n.jsxs(t,{children:[n.jsx(i,{children:n.jsx(a,{className:"text-base",children:"Student Preview"})}),n.jsx(c,{children:n.jsx($,{skillTestId:o,selectedQuestionId:q||void 0})})]}),n.jsx(v,{}),n.jsxs(t,{children:[n.jsx(i,{children:n.jsx(a,{className:"text-base",children:"Question Library"})}),n.jsx(c,{className:"space-y-3",children:0===_.length?n.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):_.map(e=>n.jsx("div",{id:`question-${e.id}`,className:"p-3 border rounded-md space-y-2",children:n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{children:[n.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),e.original_sentence&&n.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.jsx("span",{className:"font-medium",children:"Original:"})," ",e.original_sentence]}),n.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),n.jsxs("div",{className:"flex gap-2 shrink-0",children:[n.jsx(l,{size:"sm",variant:"outline",onClick:()=>I(e.id),children:"Preview"}),n.jsx(l,{size:"sm",onClick:()=>(e=>{var n,s,r;k(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(n=e.incorrect_answers)?void 0:n[0])||"",incorrect2:(null==(s=e.incorrect_answers)?void 0:s[1])||"",incorrect3:(null==(r=e.incorrect_answers)?void 0:r[2])||"",explanation:e.explanation||"",original_sentence:e.original_sentence||""})})(e),children:"Edit"}),n.jsx(l,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await d.from("skill_practice_questions").delete().eq("id",e),await E())})(e.id),children:"Delete"})]})]})},e.id))})]}),n.jsx(u,{open:!!b,onOpenChange:e=>{e||k(null)},children:n.jsxs(h,{className:"sm:max-w-lg",children:[n.jsx(x,{children:n.jsx(g,{children:"Edit Question"})}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx(p,{htmlFor:"question_format",children:"Format"}),n.jsx(j,{id:"question_format",value:C.question_format,onChange:e=>S({...C,question_format:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(p,{htmlFor:"original_sentence",children:"Original Sentence"}),n.jsx(f,{id:"original_sentence",value:C.original_sentence,onChange:e=>S({...C,original_sentence:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(p,{htmlFor:"content",children:"Content"}),n.jsx(f,{id:"content",value:C.content,onChange:e=>S({...C,content:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(p,{htmlFor:"correct_answer",children:"Chunk 1 (first)"}),n.jsx(j,{id:"correct_answer",value:C.correct_answer,onChange:e=>S({...C,correct_answer:e.target.value})})]}),n.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[n.jsxs("div",{children:[n.jsx(p,{children:"Chunk 2"}),n.jsx(j,{value:C.incorrect1,onChange:e=>S({...C,incorrect1:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(p,{children:"Chunk 3"}),n.jsx(j,{value:C.incorrect2,onChange:e=>S({...C,incorrect2:e.target.value})})]}),n.jsxs("div",{children:[n.jsx(p,{children:"Chunk 4"}),n.jsx(j,{value:C.incorrect3,onChange:e=>S({...C,incorrect3:e.target.value})})]})]}),n.jsxs("div",{children:[n.jsx(p,{htmlFor:"explanation",children:"Explanation"}),n.jsx(f,{id:"explanation",value:C.explanation,onChange:e=>S({...C,explanation:e.target.value})})]})]}),n.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[n.jsx(l,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),n.jsx(l,{onClick:async()=>{if(!b)return;const e=[C.incorrect1,C.incorrect2,C.incorrect3].filter(Boolean),{error:n}=await d.from("skill_practice_questions").update({content:C.content||"Unscramble the sentence.",question_format:C.question_format||"SentenceScramble",correct_answer:C.correct_answer,incorrect_answers:e,explanation:C.explanation,original_sentence:C.original_sentence||null}).eq("id",b.id);n||(k(null),await E())},children:"Save"})]})]})})]})})};export{E as default};
