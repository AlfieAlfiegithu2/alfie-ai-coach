import{c as e,u as s,G as a,w as n,r as t,J as r,j as i,l as o,C as l,b as c,d as u,a as d,K as m,L as x,y as p,H as h,B as j,N as g,O as b,T as v,I as f,z as _,M as q}from"./index-dBOUR_pf.js";import{T as N,a as w,b as y,c as C}from"./tabs-22QgqEjD.js";import{A as k}from"./AdminLayout-BKN4Sab2.js";import{I as E}from"./ImageQuestionExtractor-RZcXeA5u.js";import{s as U}from"./supabase-DWL4C3fA.js";import{T as I}from"./trash-2-DLIMBasM.js";import{U as S}from"./upload-CkNfULoO.js";import{S as T}from"./save-B1xh_LCn.js";import{U as P}from"./users-BiGeK6EQ.js";import"./image-DgGOlntb.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=[{number:1,name:"Photos",questions:6,description:"Look at a photo and choose the statement that best describes it",icon:e("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]])},{number:2,name:"Question-Response",questions:25,description:"Listen to a question and choose the best response",icon:_},{number:3,name:"Conversations",questions:39,description:"Listen to conversations and answer questions",icon:P},{number:4,name:"Talks",questions:30,description:"Listen to talks and answer questions",icon:q}],F=()=>{const e=s(),{testId:_}=a(),{admin:q,loading:P}=n(),F=t.useRef(null),[L,$]=t.useState(""),[O,Q]=t.useState("1"),[z,B]=t.useState(!1);t.useState(!1);const[G,J]=t.useState(!1),[M,R]=t.useState({1:{questions:[],audioFile:null,audioUrl:null,saved:!1},2:{questions:[],audioFile:null,audioUrl:null,saved:!1},3:{questions:[],audioFile:null,audioUrl:null,saved:!1},4:{questions:[],audioFile:null,audioUrl:null,saved:!1}});t.useEffect(()=>{P||q||e("/admin/login")},[q,P,e]),t.useEffect(()=>{_&&D()},[_]);const D=async()=>{if(_)try{const{data:e,error:s}=await U.from("tests").select("*").eq("id",_).single();if(s)throw s;$(e.test_name);const{data:a,error:n}=await U.from("questions").select("*").eq("test_id",_).order("question_number_in_part",{ascending:!0});if(n)throw n;const t={1:[],2:[],3:[],4:[]};null==a||a.forEach(e=>{const s=e.toeic_part||1;t[s]&&t[s].push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,explanation:e.explanation||"",ai_explanation:e.ai_explanation,toeic_part:s,image_url:e.image_url,audio_url:e.audio_url})}),R(e=>{var s,n,r,i;return{1:{...e[1],questions:t[1],audioUrl:(null==(s=null==a?void 0:a.find(e=>1===e.toeic_part))?void 0:s.audio_url)||null},2:{...e[2],questions:t[2],audioUrl:(null==(n=null==a?void 0:a.find(e=>2===e.toeic_part))?void 0:n.audio_url)||null},3:{...e[3],questions:t[3],audioUrl:(null==(r=null==a?void 0:a.find(e=>3===e.toeic_part))?void 0:r.audio_url)||null},4:{...e[4],questions:t[4],audioUrl:(null==(i=null==a?void 0:a.find(e=>4===e.toeic_part))?void 0:i.audio_url)||null}}})}catch(e){console.error("Error loading test data:",e),r.error("Failed to load test data")}},H=e=>{switch(e){case 1:return"photo_description";case 2:return"question_response";case 3:return"conversation";case 4:return"talk";default:return"multiple_choice"}},V=(e,s,a,n)=>{R(t=>{const r=[...t[e].questions];return r[s]={...r[s],[a]:n},{...t,[e]:{...t[e],questions:r,saved:!1}}})},K=e=>{var s;const a=(null==(s=A.find(s=>s.number===e))?void 0:s.questions)||0,n=M[e].questions.length;return{current:n,expected:a,percentage:a>0?n/a*100:0}};return P?i.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:i.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):i.jsx(k,{title:"TOEIC Listening Test",showBackButton:!0,backPath:"/admin/toeic",children:i.jsxs("div",{className:"space-y-6",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-2xl font-bold",children:L||"TOEIC Listening Test"}),i.jsx("p",{className:"text-muted-foreground",children:"Manage Parts 1-4 (100 questions total)"})]}),i.jsx("div",{className:"flex gap-2",children:i.jsx(o,{variant:"outline",className:"bg-orange-50 text-orange-700",children:"TOEIC Listening"})})]}),i.jsxs(l,{children:[i.jsx(c,{children:i.jsx(u,{className:"text-lg",children:"Question Progress"})}),i.jsx(d,{children:i.jsx("div",{className:"grid grid-cols-4 gap-4",children:A.map(e=>{const s=K(e.number),a=e.icon;return i.jsxs("div",{className:"space-y-2",children:[i.jsxs("div",{className:"flex items-center justify-between text-sm",children:[i.jsxs("span",{className:"flex items-center gap-1",children:[i.jsx(a,{className:"w-4 h-4"}),"Part ",e.number]}),i.jsxs("span",{className:"text-muted-foreground",children:[s.current,"/",s.expected]})]}),i.jsx(m,{value:s.percentage,className:"h-2"})]},e.number)})})})]}),i.jsxs(N,{value:O,onValueChange:Q,children:[i.jsx(w,{className:"grid grid-cols-4 w-full",children:A.map(e=>{const s=K(e.number),a=e.icon;return i.jsxs(y,{value:String(e.number),className:"flex items-center gap-2",children:[i.jsx(a,{className:"w-4 h-4"}),i.jsxs("span",{className:"hidden sm:inline",children:["Part ",e.number]}),i.jsxs("span",{className:"sm:hidden",children:["P",e.number]}),s.current===s.expected&&s.expected>0&&i.jsx(x,{className:"w-3 h-3 text-green-500"})]},e.number)})}),A.map(e=>i.jsxs(C,{value:String(e.number),className:"space-y-6",children:[i.jsxs(l,{className:"bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-950/20 dark:to-amber-950/20",children:[i.jsxs(c,{children:[i.jsxs(u,{className:"flex items-center gap-2",children:[i.jsx(e.icon,{className:"w-5 h-5"}),"Part ",e.number,": ",e.name]}),i.jsx(p,{children:e.description})]}),i.jsx(d,{children:i.jsxs("p",{className:"text-sm text-muted-foreground",children:["Expected questions: ",i.jsx("span",{className:"font-semibold",children:e.questions})]})})]}),i.jsxs(l,{children:[i.jsx(c,{children:i.jsxs(u,{className:"flex items-center gap-2",children:[i.jsx(h,{className:"w-5 h-5"}),"Audio for Part ",e.number]})}),i.jsx(d,{className:"space-y-4",children:M[e.number].audioUrl?i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsx("audio",{ref:F,src:M[e.number].audioUrl,className:"flex-1",controls:!0}),i.jsxs(j,{variant:"outline",size:"sm",onClick:()=>R(s=>({...s,[e.number]:{...s[e.number],audioUrl:null,audioFile:null}})),children:[i.jsx(I,{className:"w-4 h-4 mr-1"}),"Remove"]})]}):i.jsxs("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[i.jsx(S,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),i.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["Upload audio file for Part ",e.number]}),i.jsx("input",{type:"file",accept:"audio/*",onChange:s=>{var a;const n=null==(a=s.target.files)?void 0:a[0];n&&(async(e,s)=>{try{const a=`toeic-listening/${_}/part${e}/${Date.now()}_${s.name}`,{data:n,error:t}=await U.storage.from("audio").upload(a,s,{upsert:!0});if(t)throw t;const{data:{publicUrl:i}}=U.storage.from("audio").getPublicUrl(a);R(a=>({...a,[e]:{...a[e],audioFile:s,audioUrl:i}})),r.success(`Audio uploaded for Part ${e}`)}catch(a){console.error("Error uploading audio:",a),r.error("Failed to upload audio")}})(e.number,n)},className:"hidden",id:`audio-upload-${e.number}`}),i.jsx(j,{variant:"outline",onClick:()=>{var s;return null==(s=document.getElementById(`audio-upload-${e.number}`))?void 0:s.click()},children:"Choose Audio File"})]})})]}),i.jsx(E,{testId:_||"",testType:"TOEIC",onQuestionsExtracted:s=>((e,s)=>{const a=s.map((s,a)=>({question_number:s.question_number||a+1,question_text:s.question_text,question_type:s.question_type||H(e),options:s.options,correct_answer:s.correct_answer||"",explanation:s.explanation||"",toeic_part:e}));R(s=>({...s,[e]:{...s[e],questions:a,saved:!1}})),r.success(`${s.length} questions extracted for Part ${e}`)})(e.number,s)}),M[e.number].questions.length>0&&i.jsxs(l,{children:[i.jsx(c,{children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs(u,{children:["Questions (",M[e.number].questions.length,")"]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs(j,{variant:"outline",size:"sm",onClick:()=>(async e=>{J(!0);try{const s=M[e].questions,{data:a,error:n}=await U.functions.invoke("toeic-generate-explanations",{body:{questions:s.map(s=>({question_number:s.question_number,question_text:s.question_text,options:s.options,correct_answer:s.correct_answer,part:e})),testType:"TOEIC Listening",part:e}});if(n)throw n;if(a.explanations){const n=s.map((e,s)=>({...e,ai_explanation:a.explanations[s]||e.ai_explanation}));R(s=>({...s,[e]:{...s[e],questions:n,saved:!1}})),r.success("AI explanations generated!")}}catch(s){console.error("Error generating explanations:",s),r.error("Failed to generate AI explanations")}finally{J(!1)}})(e.number),disabled:G,children:[i.jsx(g,{className:"w-4 h-4 mr-1"}),G?"Generating...":"Generate AI Explanations"]}),i.jsxs(j,{size:"sm",onClick:()=>(async e=>{if(_){B(!0);try{const s=M[e].questions,a=M[e].audioUrl;await U.from("questions").delete().eq("test_id",_).eq("toeic_part",e);const n=s.map((s,n)=>({test_id:_,question_number_in_part:s.question_number||n+1,part_number:e,toeic_part:e,question_text:s.question_text,question_type:s.question_type,choices:s.options?JSON.stringify(s.options):null,correct_answer:s.correct_answer,explanation:s.explanation,ai_explanation:s.ai_explanation,audio_url:a,image_url:s.image_url})),{error:t}=await U.from("questions").insert(n);if(t)throw t;R(s=>({...s,[e]:{...s[e],saved:!0}})),r.success(`Part ${e} saved successfully!`)}catch(s){console.error("Error saving questions:",s),r.error("Failed to save questions")}finally{B(!1)}}})(e.number),disabled:z||M[e.number].saved,className:"bg-orange-600 hover:bg-orange-700",children:[i.jsx(T,{className:"w-4 h-4 mr-1"}),z?"Saving...":M[e.number].saved?"Saved":"Save Questions"]})]})]})}),i.jsx(d,{children:i.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto",children:M[e.number].questions.map((s,a)=>i.jsx(l,{className:"border",children:i.jsxs(d,{className:"pt-4",children:[i.jsxs("div",{className:"flex items-start justify-between mb-3",children:[i.jsxs(o,{variant:"outline",children:["Q",s.question_number]}),i.jsx(j,{variant:"ghost",size:"sm",onClick:()=>((e,s)=>{R(a=>{const n=a[e].questions.filter((e,a)=>a!==s);return{...a,[e]:{...a[e],questions:n,saved:!1}}})})(e.number,a),children:i.jsx(I,{className:"w-4 h-4 text-red-500"})})]}),i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{children:[i.jsx(b,{children:"Question Text"}),i.jsx(v,{value:s.question_text,onChange:s=>V(e.number,a,"question_text",s.target.value),rows:2})]}),s.options&&i.jsxs("div",{children:[i.jsx(b,{children:"Options"}),i.jsx("div",{className:"grid grid-cols-2 gap-2 mt-1",children:s.options.map((n,t)=>i.jsx(f,{value:n,onChange:n=>{const r=[...s.options];r[t]=n.target.value,V(e.number,a,"options",r)},placeholder:`Option ${String.fromCharCode(65+t)}`},t))})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx(b,{children:"Correct Answer"}),i.jsx(f,{value:s.correct_answer,onChange:s=>V(e.number,a,"correct_answer",s.target.value),placeholder:"A, B, C, or D"})]}),i.jsxs("div",{children:[i.jsx(b,{children:"Question Type"}),i.jsx(f,{value:s.question_type,onChange:s=>V(e.number,a,"question_type",s.target.value)})]})]}),s.ai_explanation&&i.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/20 p-3 rounded-lg",children:[i.jsx(b,{className:"text-blue-700 dark:text-blue-400",children:"AI Explanation"}),i.jsx("p",{className:"text-sm mt-1",children:s.ai_explanation})]})]})]})},a))})})]})]},e.number))]})]})})};export{F as default};
