import{u as e,c as s,r as t,j as a}from"./vendor-react-rLLBBC7n.js";import{n,s as r,J as i,e as o,C as l,b as c,c as d,a as u,P as m,o as x,B as h,L as p,T as b,I as j}from"./index-KxDfHqNJ.js";import{T as g,a as v,b as N,c as f}from"./tabs-BVz_B7Kx.js";import{A as _}from"./AdminLayout-DGXoIbe0.js";import{I as E}from"./ImageQuestionExtractor-CyDub9QF.js";import{at as q,aJ as w,aY as D,aV as y,aM as A,aN as B,ak as C,b5 as F,a9 as k,aa as S,b6 as P,as as U,aZ as I,aO as T}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const $=[{number:1,name:"Photos",questions:6,description:"Look at a photo and choose the statement that best describes it",icon:P},{number:2,name:"Question-Response",questions:25,description:"Listen to a question and choose the best response",icon:U},{number:3,name:"Conversations",questions:39,description:"Listen to conversations and answer questions",icon:I},{number:4,name:"Talks",questions:30,description:"Listen to talks and answer questions",icon:T}],L=()=>{const P=e(),{testId:U}=s(),{admin:I,loading:T}=n(),L=t.useRef(null),[O,Q]=t.useState(""),[z,J]=t.useState("1"),[M,R]=t.useState(!1);t.useState(!1);const[V,G]=t.useState(!1),[Y,Z]=t.useState(!1),[H,K]=t.useState(0),[W,X]=t.useState({1:{questions:[],audioFile:null,audioUrl:null,saved:!1},2:{questions:[],audioFile:null,audioUrl:null,saved:!1},3:{questions:[],audioFile:null,audioUrl:null,saved:!1},4:{questions:[],audioFile:null,audioUrl:null,saved:!1}});t.useEffect(()=>{T||I||P("/admin/login")},[I,T,P]),t.useEffect(()=>{U&&ee()},[U]);const ee=async()=>{if(U)try{const{data:e,error:s}=await r.from("tests").select("*").eq("id",U).single();if(s)throw s;Q(e.test_name);const{data:t,error:a}=await r.from("questions").select("*").eq("test_id",U).order("question_number_in_part",{ascending:!0});if(a)throw a;const n={1:[],2:[],3:[],4:[]};null==t||t.forEach(e=>{const s=e.toeic_part||1;n[s]&&n[s].push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,explanation:e.explanation||"",ai_explanation:e.ai_explanation,toeic_part:s,image_url:e.image_url,audio_url:e.audio_url})}),X(e=>{var s,a,r,i;return{1:{...e[1],questions:n[1],audioUrl:(null==(s=null==t?void 0:t.find(e=>1===e.toeic_part))?void 0:s.audio_url)||null},2:{...e[2],questions:n[2],audioUrl:(null==(a=null==t?void 0:t.find(e=>2===e.toeic_part))?void 0:a.audio_url)||null},3:{...e[3],questions:n[3],audioUrl:(null==(r=null==t?void 0:t.find(e=>3===e.toeic_part))?void 0:r.audio_url)||null},4:{...e[4],questions:n[4],audioUrl:(null==(i=null==t?void 0:t.find(e=>4===e.toeic_part))?void 0:i.audio_url)||null}}})}catch(e){console.error("Error loading test data:",e),i.error("Failed to load test data")}},se=e=>{switch(e){case 1:return"photo_description";case 2:return"question_response";case 3:return"conversation";case 4:return"talk";default:return"multiple_choice"}},te=(e,s,t,a)=>{X(n=>{const r=[...n[e].questions];return r[s]={...r[s],[t]:a},{...n,[e]:{...n[e],questions:r,saved:!1}}})},ae=e=>{var s;const t=(null==(s=$.find(s=>s.number===e))?void 0:s.questions)||0,a=W[e].questions.length;return{current:a,expected:t,percentage:t>0?a/t*100:0}};return T?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):a.jsx(_,{title:"TOEIC Listening Test",showBackButton:!0,backPath:"/admin/toeic",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-[#5D4E37]",children:O||"TOEIC Listening Test"}),a.jsx("p",{className:"text-[#8B6914]",children:"Manage Parts 1-4 (100 questions total)"})]}),a.jsx("div",{className:"flex gap-2",children:a.jsx(o,{variant:"outline",className:"bg-[#FEF9E7] text-[#8B6914] border-[#E8D5A3]",children:"TOEIC Listening"})})]}),a.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsx(c,{children:a.jsx(d,{className:"text-lg text-[#5D4E37]",children:"Question Progress"})}),a.jsx(u,{children:a.jsx("div",{className:"grid grid-cols-4 gap-4",children:$.map(e=>{const s=ae(e.number),t=e.icon;return a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsxs("span",{className:"flex items-center gap-1 text-[#5D4E37]",children:[a.jsx(t,{className:"w-4 h-4 text-[#8B6914]"}),"Part ",e.number]}),a.jsxs("span",{className:"text-[#8B6914]",children:[s.current,"/",s.expected]})]}),a.jsx(m,{value:s.percentage,className:"h-2 bg-[#E8D5A3]"})]},e.number)})})})]}),a.jsxs(g,{value:z,onValueChange:J,children:[a.jsx(v,{className:"grid grid-cols-4 w-full bg-[#E8D5A3]/20 border border-[#E8D5A3]",children:$.map(e=>{const s=ae(e.number),t=e.icon;return a.jsxs(N,{value:String(e.number),className:"flex items-center gap-2 data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[a.jsx(t,{className:"w-4 h-4"}),a.jsxs("span",{className:"hidden sm:inline",children:["Part ",e.number]}),a.jsxs("span",{className:"sm:hidden",children:["P",e.number]}),s.current===s.expected&&s.expected>0&&a.jsx(q,{className:"w-3 h-3 text-green-500"})]},e.number)})}),$.map(e=>{var s,t,n,m;return a.jsxs(f,{value:String(e.number),className:"space-y-6",children:[a.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsxs(c,{children:[a.jsxs(d,{className:"flex items-center gap-2 text-[#5D4E37]",children:[a.jsx(e.icon,{className:"w-5 h-5 text-[#8B6914]"}),"Part ",e.number,": ",e.name]}),a.jsx(x,{className:"text-[#8B6914]",children:e.description})]}),a.jsx(u,{children:a.jsxs("p",{className:"text-sm text-[#8B6914]",children:["Expected questions: ",a.jsx("span",{className:"font-semibold text-[#5D4E37]",children:e.questions})]})})]}),a.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsx(c,{children:a.jsxs(d,{className:"flex items-center gap-2 text-[#5D4E37]",children:[a.jsx(w,{className:"w-5 h-5 text-[#8B6914]"}),"Audio for Part ",e.number]})}),a.jsx(u,{className:"space-y-4",children:W[e.number].audioUrl?a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("audio",{ref:L,src:W[e.number].audioUrl,className:"flex-1",controls:!0}),a.jsxs(h,{variant:"outline",size:"sm",className:"border-[#E8D5A3] text-[#5D4E37] hover:bg-[#E8D5A3]/20",onClick:()=>X(s=>({...s,[e.number]:{...s[e.number],audioUrl:null,audioFile:null}})),children:[a.jsx(D,{className:"w-4 h-4 mr-1"}),"Remove"]})]}):a.jsxs("div",{className:"border-2 border-dashed border-[#E8D5A3] rounded-lg p-8 text-center bg-white/30",children:[a.jsx(y,{className:"w-8 h-8 mx-auto mb-2 text-[#8B6914]"}),a.jsxs("p",{className:"text-sm text-[#8B6914] mb-2",children:["Upload audio file for Part ",e.number]}),a.jsx("input",{type:"file",accept:"audio/*",onChange:s=>{var t;const a=null==(t=s.target.files)?void 0:t[0];a&&(async(e,s)=>{try{const t=`toeic-listening/${U}/part${e}/${Date.now()}_${s.name}`,{data:a,error:n}=await r.storage.from("audio").upload(t,s,{upsert:!0});if(n)throw n;const{data:{publicUrl:o}}=r.storage.from("audio").getPublicUrl(t);X(t=>({...t,[e]:{...t[e],audioFile:s,audioUrl:o}})),i.success(`Audio uploaded for Part ${e}`)}catch(t){console.error("Error uploading audio:",t),i.error("Failed to upload audio")}})(e.number,a)},className:"hidden",id:`audio-upload-${e.number}`}),a.jsx(h,{variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37] hover:bg-[#E8D5A3]/20",onClick:()=>{var s;return null==(s=document.getElementById(`audio-upload-${e.number}`))?void 0:s.click()},children:"Choose Audio File"})]})})]}),a.jsx(E,{testId:U||"",testType:"TOEIC",onQuestionsExtracted:s=>((e,s)=>{const t=s.map((s,t)=>({question_number:s.question_number||t+1,question_text:s.question_text,question_type:s.question_type||se(e),options:s.options,correct_answer:s.correct_answer||"",explanation:s.explanation||"",toeic_part:e}));X(s=>({...s,[e]:{...s[e],questions:t,saved:!1}})),i.success(`${s.length} questions extracted for Part ${e}`)})(e.number,s)}),W[e.number].questions.length>0&&a.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsx(c,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(d,{className:"text-[#5D4E37]",children:["Questions (",W[e.number].questions.length,")"]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(h,{variant:"outline",size:"sm",onClick:()=>{Z(!Y),K(0)},className:`border-[#E8D5A3] ${Y?"bg-[#A68B5B] text-white":"text-[#5D4E37]"} hover:bg-[#E8D5A3]/20`,children:[Y?a.jsx(A,{className:"w-4 h-4 mr-1"}):a.jsx(B,{className:"w-4 h-4 mr-1"}),Y?"Exit Preview":"Student Preview"]}),a.jsxs(h,{variant:"outline",size:"sm",onClick:()=>(async e=>{G(!0);try{const s=W[e].questions,{data:t,error:a}=await r.functions.invoke("toeic-generate-explanations",{body:{questions:s.map(s=>({question_number:s.question_number,question_text:s.question_text,options:s.options,correct_answer:s.correct_answer,part:e})),testType:"TOEIC Listening",part:e}});if(a)throw a;if(t.explanations){const a=s.map((e,s)=>({...e,ai_explanation:t.explanations[s]||e.ai_explanation}));X(s=>({...s,[e]:{...s[e],questions:a,saved:!1}})),i.success("AI explanations generated!")}}catch(s){console.error("Error generating explanations:",s),i.error("Failed to generate AI explanations")}finally{G(!1)}})(e.number),disabled:V,className:"border-[#E8D5A3] text-[#5D4E37] hover:bg-[#E8D5A3]/20",children:[a.jsx(C,{className:"w-4 h-4 mr-1"}),V?"Generating...":"AI Explanations"]}),a.jsxs(h,{size:"sm",onClick:()=>(async e=>{if(U){R(!0);try{const s=W[e].questions,t=W[e].audioUrl;await r.from("questions").delete().eq("test_id",U).eq("toeic_part",e);const a=s.map((s,a)=>({test_id:U,question_number_in_part:s.question_number||a+1,part_number:e,toeic_part:e,question_text:s.question_text,question_type:s.question_type,choices:s.options?JSON.stringify(s.options):null,correct_answer:s.correct_answer,explanation:s.explanation,ai_explanation:s.ai_explanation,audio_url:t,image_url:s.image_url})),{error:n}=await r.from("questions").insert(a);if(n)throw n;X(s=>({...s,[e]:{...s[e],saved:!0}})),i.success(`Part ${e} saved successfully!`)}catch(s){console.error("Error saving questions:",s),i.error("Failed to save questions")}finally{R(!1)}}})(e.number),disabled:M||W[e.number].saved,className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[a.jsx(F,{className:"w-4 h-4 mr-1"}),M?"Saving...":W[e.number].saved?"Saved":"Save Questions"]})]})]})}),a.jsx(u,{children:Y?a.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 border border-[#E8D5A3]",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs(o,{className:"bg-[#A68B5B] text-white text-sm px-3 py-1",children:["Question ",(null==(s=W[e.number].questions[H])?void 0:s.question_number)||H+1]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(h,{variant:"outline",size:"sm",onClick:()=>K(Math.max(0,H-1)),disabled:0===H,className:"border-[#E8D5A3]",children:a.jsx(k,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm text-[#5D4E37] font-medium",children:[H+1," / ",W[e.number].questions.length]}),a.jsx(h,{variant:"outline",size:"sm",onClick:()=>K(Math.min(W[e.number].questions.length-1,H+1)),disabled:H>=W[e.number].questions.length-1,className:"border-[#E8D5A3]",children:a.jsx(S,{className:"w-4 h-4"})})]})]}),a.jsx("div",{className:"mb-6",children:a.jsx("p",{className:"text-lg text-[#5D4E37] leading-relaxed",children:(null==(t=W[e.number].questions[H])?void 0:t.question_text)||"No question text"})}),a.jsx("div",{className:"space-y-3",children:((null==(n=W[e.number].questions[H])?void 0:n.options)||[]).map((s,t)=>{var n;const r=String.fromCharCode(65+t),i=(null==(n=W[e.number].questions[H])?void 0:n.correct_answer)===r;return a.jsxs("div",{className:"flex items-center gap-3 p-4 rounded-lg border-2 transition-all cursor-pointer\n                                  "+(i?"bg-green-50 border-green-400":"bg-[#FEF9E7] border-[#E8D5A3] hover:border-[#A68B5B]"),children:[a.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm\n                                  "+(i?"bg-green-500 text-white":"bg-[#A68B5B] text-white"),children:r}),a.jsx("span",{className:"text-base "+(i?"text-green-700 font-medium":"text-[#5D4E37]"),children:s}),i&&a.jsx(q,{className:"w-5 h-5 text-green-500 ml-auto"})]},t)})}),!(null==(m=W[e.number].questions[H])?void 0:m.correct_answer)&&a.jsx("p",{className:"text-amber-600 text-sm mt-4 text-center",children:"⚠️ No correct answer set for this question"})]}):a.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto pr-2",children:W[e.number].questions.map((s,t)=>a.jsx(l,{className:"border border-[#E8D5A3] bg-white/50",children:a.jsxs(u,{className:"pt-4",children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsxs(o,{variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37]",children:["Q",s.question_number]}),a.jsxs("div",{className:"flex items-center gap-2",children:[s.correct_answer&&a.jsxs(o,{variant:"secondary",className:"bg-green-100 text-green-700",children:["Answer: ",s.correct_answer]}),a.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{K(t),Z(!0)},children:a.jsx(B,{className:"w-4 h-4 text-[#8B6914]"})}),a.jsx(h,{variant:"ghost",size:"sm",onClick:()=>((e,s)=>{X(t=>{const a=t[e].questions.filter((e,t)=>t!==s);return{...t,[e]:{...t[e],questions:a,saved:!1}}})})(e.number,t),children:a.jsx(D,{className:"w-4 h-4 text-red-500"})})]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx(p,{className:"text-[#5D4E37]",children:"Question Text"}),a.jsx(b,{value:s.question_text,onChange:s=>te(e.number,t,"question_text",s.target.value),rows:2,className:"bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),s.options&&a.jsxs("div",{children:[a.jsx(p,{className:"text-[#5D4E37]",children:"Options"}),a.jsx("div",{className:"grid grid-cols-2 gap-2 mt-1",children:s.options.map((n,r)=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-sm font-medium w-6 text-[#5D4E37]",children:["(",String.fromCharCode(65+r),")"]}),a.jsx(j,{value:n,onChange:a=>{const n=[...s.options];n[r]=a.target.value,te(e.number,t,"options",n)},placeholder:`Option ${String.fromCharCode(65+r)}`,className:"bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]},r))})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx(p,{className:"text-[#5D4E37]",children:"Correct Answer"}),a.jsx(j,{value:s.correct_answer,onChange:s=>te(e.number,t,"correct_answer",s.target.value),placeholder:"A, B, C, or D",className:"bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),a.jsxs("div",{children:[a.jsx(p,{className:"text-[#5D4E37]",children:"Question Type"}),a.jsx(j,{value:s.question_type,onChange:s=>te(e.number,t,"question_type",s.target.value),className:"bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]})]}),s.ai_explanation&&a.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/20 p-3 rounded-lg",children:[a.jsx(p,{className:"text-blue-700 dark:text-blue-400",children:"AI Explanation"}),a.jsx("p",{className:"text-sm mt-1",children:s.ai_explanation})]})]})]})},t))})})]})]},e.number)})]})]})})};export{L as default};
