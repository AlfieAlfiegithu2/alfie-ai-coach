import{c as e,u as s,G as t,w as a,r as n,J as r,j as i,l as o,C as c,b as l,d,a as u,K as m,L as p,y as x,Q as h,F as g,O as j,T as _,B as q,P as b,N as f,I as v,S as w,p as y,q as N,s as C,t as k,e as A}from"./index-BcRn0esQ.js";import{T as E,a as P,b as S,c as I}from"./tabs-BczLKDaC.js";import{A as T}from"./AdminLayout-D4bmPAJw.js";import{I as O}from"./ImageQuestionExtractor-IJqBY4DY.js";import{s as Q}from"./supabase-DWL4C3fA.js";import{I as M}from"./image-D4wnaRjk.js";import{W as B}from"./wand-sparkles-D6E14AwR.js";import{S as D}from"./save-C6vq5wpT.js";import{T as R}from"./trash-2-B7VCZ8Z0.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=e("AlignLeft",[["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M17 18H3",key:"1amg6g"}],["path",{d:"M21 6H3",key:"1jwq7v"}]]),$=e("Newspaper",[["path",{d:"M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2",key:"7pis2x"}],["path",{d:"M18 14h-8",key:"sponae"}],["path",{d:"M15 18h-5",key:"95g1m2"}],["path",{d:"M10 6h8v4h-8V6Z",key:"smlsk5"}]]),z=[{number:5,name:"Incomplete Sentences",questions:40,description:"Choose the word or phrase that best completes the sentence",icon:F,hasPassages:!1},{number:6,name:"Text Completion",questions:12,description:"Complete passages with missing words or sentences",icon:g,hasPassages:!0},{number:7,name:"Reading Comprehension",questions:48,description:"Read passages and answer questions about them",icon:$,hasPassages:!0}],V=()=>{const e=s(),{testId:F}=t(),{admin:$,loading:V}=a(),[H,U]=n.useState(""),[G,J]=n.useState("5"),[K,L]=n.useState("paste"),[Z,W]=n.useState(!1),[X,Y]=n.useState(!1),[ee,se]=n.useState(!1),[te,ae]=n.useState(""),[ne,re]=n.useState(""),[ie,oe]=n.useState({5:{questions:[],passages:[],saved:!1},6:{questions:[],passages:[],saved:!1},7:{questions:[],passages:[],saved:!1}});n.useEffect(()=>{V||$||e("/admin/login")},[$,V,e]),n.useEffect(()=>{F&&ce()},[F]);const ce=async()=>{if(F)try{const{data:e,error:s}=await Q.from("tests").select("*").eq("id",F).single();if(s)throw s;U(e.test_name);const{data:t,error:a}=await Q.from("questions").select("*").eq("test_id",F).order("question_number_in_part",{ascending:!0});if(a)throw a;const{data:n,error:r}=await Q.from("toeic_passages").select("*").eq("test_id",F).order("question_range_start",{ascending:!0}),i={5:{questions:[],passages:[],saved:!1},6:{questions:[],passages:[],saved:!1},7:{questions:[],passages:[],saved:!1}};null==t||t.forEach(e=>{const s=e.toeic_part||5;i[s]&&i[s].questions.push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,explanation:e.explanation||"",ai_explanation:e.ai_explanation,toeic_part:s,passage_context:e.passage_context,related_passage_id:e.related_passage_id})}),null==n||n.forEach(e=>{const s=e.part_number;i[s]&&i[s].passages.push({id:e.id,title:e.passage_title,content:e.passage_content,type:e.passage_type,imageUrl:e.passage_image_url,questionStart:e.question_range_start,questionEnd:e.question_range_end})}),oe(i)}catch(e){console.error("Error loading test data:",e),r.error("Failed to load test data")}},le=e=>{switch(e){case 5:return"incomplete_sentence";case 6:return"text_completion";case 7:return"reading_comprehension";default:return"multiple_choice"}},de=(e,s,t,a)=>{oe(n=>{const r=[...n[e].questions];return r[s]={...r[s],[t]:a},{...n,[e]:{...n[e],questions:r,saved:!1}}})},ue=e=>{var s;const t=(null==(s=z.find(s=>s.number===e))?void 0:s.questions)||0,a=ie[e].questions.length;return{current:a,expected:t,percentage:t>0?a/t*100:0}};return V?i.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:i.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):i.jsx(T,{title:"TOEIC Reading Test",showBackButton:!0,backPath:"/admin/toeic",children:i.jsxs("div",{className:"space-y-6",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("h1",{className:"text-2xl font-bold",children:H||"TOEIC Reading Test"}),i.jsx("p",{className:"text-muted-foreground",children:"Manage Parts 5-7 (100 questions total)"})]}),i.jsx(o,{variant:"outline",className:"bg-orange-50 text-orange-700",children:"TOEIC Reading"})]}),i.jsxs(c,{children:[i.jsx(l,{children:i.jsx(d,{className:"text-lg",children:"Question Progress"})}),i.jsx(u,{children:i.jsx("div",{className:"grid grid-cols-3 gap-4",children:z.map(e=>{const s=ue(e.number),t=e.icon;return i.jsxs("div",{className:"space-y-2",children:[i.jsxs("div",{className:"flex items-center justify-between text-sm",children:[i.jsxs("span",{className:"flex items-center gap-1",children:[i.jsx(t,{className:"w-4 h-4"}),"Part ",e.number]}),i.jsxs("span",{className:"text-muted-foreground",children:[s.current,"/",s.expected]})]}),i.jsx(m,{value:s.percentage,className:"h-2"})]},e.number)})})})]}),i.jsxs(E,{value:G,onValueChange:J,children:[i.jsx(P,{className:"grid grid-cols-3 w-full",children:z.map(e=>{const s=ue(e.number),t=e.icon;return i.jsxs(S,{value:String(e.number),className:"flex items-center gap-2",children:[i.jsx(t,{className:"w-4 h-4"}),i.jsxs("span",{className:"hidden sm:inline",children:["Part ",e.number]}),i.jsxs("span",{className:"sm:hidden",children:["P",e.number]}),s.current===s.expected&&s.expected>0&&i.jsx(p,{className:"w-3 h-3 text-green-500"})]},e.number)})}),z.map(e=>i.jsxs(I,{value:String(e.number),className:"space-y-6",children:[i.jsxs(c,{className:"bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-950/20 dark:to-amber-950/20",children:[i.jsxs(l,{children:[i.jsxs(d,{className:"flex items-center gap-2",children:[i.jsx(e.icon,{className:"w-5 h-5"}),"Part ",e.number,": ",e.name]}),i.jsx(x,{children:e.description})]}),i.jsx(u,{children:i.jsxs("p",{className:"text-sm text-muted-foreground",children:["Expected questions: ",i.jsx("span",{className:"font-semibold",children:e.questions})]})})]}),i.jsxs(c,{children:[i.jsx(l,{children:i.jsx(d,{className:"text-lg",children:"Add Questions"})}),i.jsx(u,{children:i.jsxs(E,{value:K,onValueChange:e=>L(e),children:[i.jsxs(P,{className:"grid grid-cols-3 w-full mb-4",children:[i.jsxs(S,{value:"paste",className:"flex items-center gap-2",children:[i.jsx(h,{className:"w-4 h-4"}),"Paste Text"]}),i.jsxs(S,{value:"image",className:"flex items-center gap-2",children:[i.jsx(M,{className:"w-4 h-4"}),"Upload Image"]}),i.jsxs(S,{value:"answers",className:"flex items-center gap-2",children:[i.jsx(g,{className:"w-4 h-4"}),"Answer Key"]})]}),i.jsxs(I,{value:"paste",className:"space-y-4",children:[i.jsxs("div",{children:[i.jsx(j,{children:"Paste TOEIC Questions"}),i.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Paste questions in TOEIC format. AI will automatically parse the structure."}),i.jsx(_,{value:te,onChange:e=>ae(e.target.value),placeholder:"101. The Technical Department is currently formulating written guidelines ------- the use of our micro-publishing facilities.\n(A) in\n(B) for\n(C) at\n(D) with\n\n102. Company strategists ------- predicted that conditions in the Middle East would eventually stabilize...",rows:12,className:"font-mono text-sm"})]}),i.jsxs(q,{onClick:()=>(async e=>{if(te.trim()){Y(!0);try{const{data:s,error:t}=await Q.functions.invoke("toeic-parse-questions",{body:{text:te,part:e,testType:"TOEIC Reading"}});if(t)throw t;if(s.questions&&s.questions.length>0){const t=s.questions.map(s=>({question_number:s.question_number,question_text:s.question_text,question_type:s.question_type||le(e),options:s.options,correct_answer:s.correct_answer||"",explanation:"",toeic_part:e,passage_context:s.passage_context}));oe(a=>({...a,[e]:{...a[e],questions:[...a[e].questions,...t],passages:s.passages||a[e].passages,saved:!1}})),ae(""),r.success(`${t.length} questions parsed successfully!`)}else r.error("No questions could be parsed from the text")}catch(s){console.error("Error parsing questions:",s),r.error("Failed to parse questions")}finally{Y(!1)}}else r.error("Please enter question text to parse")})(e.number),disabled:X||!te.trim(),className:"bg-orange-600 hover:bg-orange-700",children:[i.jsx(B,{className:"w-4 h-4 mr-2"}),X?"Parsing...":"Parse Questions with AI"]})]}),i.jsx(I,{value:"image",children:i.jsx(O,{testId:F||"",testType:"TOEIC",onQuestionsExtracted:s=>((e,s)=>{const t=s.map((s,t)=>({question_number:s.question_number||ie[e].questions.length+t+1,question_text:s.question_text,question_type:s.question_type||le(e),options:s.options,correct_answer:s.correct_answer||"",explanation:s.explanation||"",toeic_part:e,passage_context:s.passage_context}));oe(s=>({...s,[e]:{...s[e],questions:[...s[e].questions,...t],saved:!1}})),r.success(`${s.length} questions extracted for Part ${e}`)})(e.number,s)})}),i.jsxs(I,{value:"answers",className:"space-y-4",children:[i.jsxs("div",{children:[i.jsx(j,{children:"Paste Answer Key"}),i.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:'Paste answer key in format: "101. (A) 102. (B) 103. (C)..."'}),i.jsx(_,{value:ne,onChange:e=>re(e.target.value),placeholder:"101. (A) 102. (A) 103. (C) 104. (C) 105. (D) 106. (A) 107. (D) 108. (B) 109. (A) 110. (B)\n111. (A) 112. (C) 113. (A) 114. (D) 115. (B) 116. (A) 117. (A) 118. (C) 119. (A) 120. (C)",rows:6,className:"font-mono text-sm"})]}),i.jsxs(q,{onClick:()=>(async e=>{if(ne.trim()){Y(!0);try{const{data:s,error:t}=await Q.functions.invoke("toeic-parse-answers",{body:{text:ne,part:e}});if(t)throw t;if(s.answers){const t=ie[e].questions.map(e=>{const t=s.answers.find(s=>s.question_number===e.question_number);return t?{...e,correct_answer:t.answer}:e});oe(s=>({...s,[e]:{...s[e],questions:t,saved:!1}})),re(""),r.success(`${Object.keys(s.answers).length} answers matched!`)}}catch(s){console.error("Error parsing answers:",s),r.error("Failed to parse answer key")}finally{Y(!1)}}else r.error("Please enter answer key text")})(e.number),disabled:X||!ne.trim()||0===ie[e.number].questions.length,className:"bg-orange-600 hover:bg-orange-700",children:[i.jsx(p,{className:"w-4 h-4 mr-2"}),X?"Matching...":"Match Answers"]}),0===ie[e.number].questions.length&&i.jsx("p",{className:"text-sm text-amber-600",children:"Add questions first before matching answer keys."})]})]})})]}),i.jsxs(c,{children:[i.jsx(l,{children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs(d,{children:["Questions (",ie[e.number].questions.length,")"]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs(q,{variant:"outline",size:"sm",onClick:()=>(e=>{const s={question_number:ie[e].questions.length+1,question_text:"",question_type:le(e),options:["","","",""],correct_answer:"",explanation:"",toeic_part:e};oe(t=>({...t,[e]:{...t[e],questions:[...t[e].questions,s],saved:!1}}))})(e.number),children:[i.jsx(b,{className:"w-4 h-4 mr-1"}),"Add Question"]}),i.jsxs(q,{variant:"outline",size:"sm",onClick:()=>(async e=>{se(!0);try{const s=ie[e].questions,{data:t,error:a}=await Q.functions.invoke("toeic-generate-explanations",{body:{questions:s.map(s=>({question_number:s.question_number,question_text:s.question_text,options:s.options,correct_answer:s.correct_answer,passage_context:s.passage_context,part:e})),testType:"TOEIC Reading",part:e}});if(a)throw a;if(t.explanations){const a=s.map((e,s)=>({...e,ai_explanation:t.explanations[s]||e.ai_explanation}));oe(s=>({...s,[e]:{...s[e],questions:a,saved:!1}})),r.success("AI explanations generated!")}}catch(s){console.error("Error generating explanations:",s),r.error("Failed to generate AI explanations")}finally{se(!1)}})(e.number),disabled:ee||0===ie[e.number].questions.length,children:[i.jsx(f,{className:"w-4 h-4 mr-1"}),ee?"Generating...":"Generate AI Explanations"]}),i.jsxs(q,{size:"sm",onClick:()=>(async e=>{if(F){W(!0);try{const s=ie[e].questions,t=ie[e].passages;if(await Q.from("questions").delete().eq("test_id",F).eq("toeic_part",e),await Q.from("toeic_passages").delete().eq("test_id",F).eq("part_number",e),t.length>0){const s=t.map(s=>({test_id:F,part_number:e,passage_type:s.type,passage_title:s.title,passage_content:s.content,passage_image_url:s.imageUrl,question_range_start:s.questionStart,question_range_end:s.questionEnd}));await Q.from("toeic_passages").insert(s)}const a=s.map((s,t)=>({test_id:F,question_number_in_part:s.question_number||t+1,part_number:e,toeic_part:e,question_text:s.question_text,question_type:s.question_type,choices:s.options?JSON.stringify(s.options):null,correct_answer:s.correct_answer,explanation:s.explanation,ai_explanation:s.ai_explanation,passage_context:s.passage_context,related_passage_id:s.related_passage_id})),{error:n}=await Q.from("questions").insert(a);if(n)throw n;oe(s=>({...s,[e]:{...s[e],saved:!0}})),r.success(`Part ${e} saved successfully!`)}catch(s){console.error("Error saving questions:",s),r.error("Failed to save questions")}finally{W(!1)}}})(e.number),disabled:Z||ie[e.number].saved||0===ie[e.number].questions.length,className:"bg-orange-600 hover:bg-orange-700",children:[i.jsx(D,{className:"w-4 h-4 mr-1"}),Z?"Saving...":ie[e.number].saved?"Saved":"Save Questions"]})]})]})}),i.jsx(u,{children:ie[e.number].questions.length>0?i.jsx("div",{className:"space-y-4 max-h-[600px] overflow-y-auto",children:ie[e.number].questions.map((s,t)=>i.jsx(c,{className:"border",children:i.jsxs(u,{className:"pt-4",children:[i.jsxs("div",{className:"flex items-start justify-between mb-3",children:[i.jsxs(o,{variant:"outline",children:["Q",s.question_number]}),i.jsxs("div",{className:"flex items-center gap-2",children:[s.correct_answer&&i.jsxs(o,{variant:"secondary",className:"bg-green-100 text-green-700",children:["Answer: ",s.correct_answer]}),i.jsx(q,{variant:"ghost",size:"sm",onClick:()=>((e,s)=>{oe(t=>{const a=t[e].questions.filter((e,t)=>t!==s);return{...t,[e]:{...t[e],questions:a,saved:!1}}})})(e.number,t),children:i.jsx(R,{className:"w-4 h-4 text-red-500"})})]})]}),i.jsxs("div",{className:"space-y-3",children:[e.hasPassages&&s.passage_context&&i.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded-lg mb-3",children:[i.jsx(j,{className:"text-xs text-muted-foreground",children:"Passage Context"}),i.jsx("p",{className:"text-sm mt-1 whitespace-pre-wrap",children:s.passage_context})]}),i.jsxs("div",{children:[i.jsx(j,{children:"Question Text"}),i.jsx(_,{value:s.question_text,onChange:s=>de(e.number,t,"question_text",s.target.value),rows:2})]}),s.options&&i.jsxs("div",{children:[i.jsx(j,{children:"Options"}),i.jsx("div",{className:"grid grid-cols-2 gap-2 mt-1",children:s.options.map((a,n)=>i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:"text-sm font-medium w-6",children:["(",String.fromCharCode(65+n),")"]}),i.jsx(v,{value:a,onChange:a=>{const r=[...s.options];r[n]=a.target.value,de(e.number,t,"options",r)},placeholder:`Option ${String.fromCharCode(65+n)}`})]},n))})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[i.jsxs("div",{children:[i.jsx(j,{children:"Correct Answer"}),i.jsxs(w,{value:s.correct_answer,onValueChange:s=>de(e.number,t,"correct_answer",s),children:[i.jsx(y,{children:i.jsx(N,{placeholder:"Select answer"})}),i.jsxs(C,{children:[i.jsx(k,{value:"A",children:"A"}),i.jsx(k,{value:"B",children:"B"}),i.jsx(k,{value:"C",children:"C"}),i.jsx(k,{value:"D",children:"D"})]})]})]}),i.jsxs("div",{children:[i.jsx(j,{children:"Question Type"}),i.jsx(v,{value:s.question_type,onChange:s=>de(e.number,t,"question_type",s.target.value)})]})]}),s.ai_explanation&&i.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/20 p-3 rounded-lg",children:[i.jsx(j,{className:"text-blue-700 dark:text-blue-400",children:"AI Explanation"}),i.jsx("p",{className:"text-sm mt-1",children:s.ai_explanation})]})]})]})},t))}):i.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[i.jsx(A,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),i.jsx("p",{children:"No questions added yet."}),i.jsx("p",{className:"text-sm",children:"Use the methods above to add questions."})]})})]})]},e.number))]})]})})};
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */export{V as default};
