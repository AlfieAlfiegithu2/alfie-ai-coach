import{u as e,c as s,r as t,j as a}from"./vendor-react-rLLBBC7n.js";import{n as r,s as n,J as i,e as l,C as o,a as c,B as d,P as x,b as m,c as h,L as g,I as u,T as p,S as b,i as j,j as v,k as w,l as N}from"./index-KxDfHqNJ.js";import{T as f,a as E,b as _,c as y}from"./tabs-BVz_B7Kx.js";import{A as q}from"./AdminLayout-DGXoIbe0.js";import{I as A}from"./ImageQuestionExtractor-CyDub9QF.js";import{q as D,b4 as C,b5 as B,aS as S,E as k,b7 as P,at as F,aV as $,av as I,aY as U,b8 as Q,b9 as T,aM as z,aN as M,ak as O,a9 as R,aa as L,ao as V}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const J={Part5:{number:5,name:"Incomplete Sentences",questions:30,questionRange:"101-130",description:"Choose the word or phrase that best completes the sentence",hasPassages:!1},Part6:{number:6,name:"Text Completion",questions:16,questionRange:"131-146",description:"Complete passages with missing words or sentences (4 passages Ã— 4 questions)",hasPassages:!0},Part7:{number:7,name:"Reading Comprehension",questions:54,questionRange:"147-200",description:"Read passages and answer questions about them",hasPassages:!0}},G=()=>{var G,K,W,Y,H,X,Z,ee,se;const te=e(),{testId:ae}=s(),{admin:re,loading:ne}=r(),[ie,le]=t.useState(""),[oe,ce]=t.useState("Part5"),[de,xe]=t.useState("paste"),[me,he]=t.useState(!1),[ge,ue]=t.useState(!1),[pe,be]=t.useState(!1),[je,ve]=t.useState(!1),[we,Ne]=t.useState(0),[fe,Ee]=t.useState("list"),[_e,ye]=t.useState(3),[qe,Ae]=t.useState(""),[De,Ce]=t.useState(""),[Be,Se]=t.useState(!1),[ke,Pe]=t.useState([]),[Fe,$e]=t.useState([]),[Ie,Ue]=t.useState(!1),[Qe,Te]=t.useState(!1),ze="Part6"===oe?4:3,Me=()=>"Part6"===oe?131:147,Oe=()=>{const e=(Fe.length>0?Fe[Fe.length-1].questionEnd:Me()-1)+1;return{start:e,end:e+ze-1}},[Re,Le]=t.useState({title:"",content:"",type:"single",imageUrl:"",questionStart:Me(),questionEnd:Me()+ze-1,mode:"text"}),Ve=J[oe];t.useEffect(()=>{ne||re||te("/admin/login")},[re,ne,te]),t.useEffect(()=>{ae&&Je()},[ae]);const Je=async()=>{if(ae)try{const{data:e,error:s}=await n.from("tests").select("*").eq("id",ae).single();if(s)throw s;le(e.test_name),e.test_subtype&&["Part5","Part6","Part7"].includes(e.test_subtype)&&ce(e.test_subtype);const{data:t,error:a}=await n.from("questions").select("*").eq("test_id",ae).order("question_number_in_part",{ascending:!0});if(a)throw a;const r=(t||[]).map(e=>({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,explanation:e.explanation||"",ai_explanation:e.ai_explanation,toeic_part:e.toeic_part||5,passage_context:e.passage_context,related_passage_id:e.related_passage_id}));Pe(r);r.some(e=>e.correct_answer)&&Te(!0);const{data:i}=await n.from("toeic_passages").select("*").eq("test_id",ae).order("question_range_start",{ascending:!0});i&&$e(i.map(e=>({id:e.id,title:e.passage_title,content:e.passage_content,type:e.passage_type,imageUrl:e.passage_image_url,questionStart:e.question_range_start,questionEnd:e.question_range_end})))}catch(e){console.error("Error loading test data:",e),i.error("Failed to load test data")}},Ge=()=>5===Ve.number?"incomplete_sentence":6===Ve.number?"text_completion":"reading_comprehension",Ke=e=>{const s=Fe.find(s=>e>=s.questionStart&&e<=s.questionEnd);return s?s.content?s.content:s.title?s.title:"":""},We=()=>{const e=Oe();Le({title:"",content:"",type:"single",imageUrl:"",questionStart:e.start,questionEnd:e.end,mode:"text"})};t.useEffect(()=>{We()},[oe,Fe.length]);const Ye=e=>({"Ð":"A","Ð’":"B","Ð¡":"C","Ð”":"D"}[e]||e),He=(e,s,t)=>{Pe(a=>{const r=[...a];return r[e]={...r[e],[s]:t},r}),Ue(!1)},Xe=e=>{Pe(s=>s.filter((s,t)=>t!==e)),Ue(!1),we>=ke.length-1&&Ne(Math.max(0,we-1))},Ze=async()=>{if(ae){he(!0);try{const{data:e,error:s}=await n.functions.invoke("save-reading-test",{body:{mode:"toeic",testId:ae,part:Ve.number,questions:ke.map((e,s)=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer,explanation:e.explanation,ai_explanation:e.ai_explanation,passage_context:e.passage_context,related_passage_id:e.related_passage_id})),passages:Fe.map(e=>({type:e.type,title:e.title,content:e.content,imageUrl:e.imageUrl,questionStart:e.questionStart,questionEnd:e.questionEnd}))}});if(s)throw s;if(!(null==e?void 0:e.success))throw new Error((null==e?void 0:e.error)||"Failed to save questions");Ue(!0),Te(!0),i.success(`Saved ${e.questionsCount} questions!`)}catch(e){console.error("Error saving questions:",e),i.error("Failed to save questions")}finally{he(!1)}}},es=(e,s=!1)=>{var t;const r=(null==(t=e.content)?void 0:t.trim().length)>0,n=!!e.imageUrl;return a.jsxs("div",{className:"border-2 border-[#E8D5A3] rounded-lg bg-white shadow-sm overflow-hidden",children:[a.jsxs("div",{className:"bg-[#F6F0DC] border-b border-[#E8D5A3] px-4 py-2 flex items-center justify-between text-xs uppercase tracking-wide text-[#5D4E37]/80",children:[a.jsxs("span",{children:["Questions ",e.questionStart||"?","-",e.questionEnd||"?"]}),a.jsx("span",{children:Ve.name})]}),a.jsxs("div",{className:"p-4 space-y-3",children:[a.jsx("h3",{className:"text-lg font-semibold text-[#2F2A1F]",children:e.title||(s?"Passage title":"Untitled passage")}),n?a.jsx("img",{src:e.imageUrl,alt:"Passage",className:"w-full rounded border border-[#E8D5A3]"}):a.jsx("p",{className:"text-sm leading-relaxed text-[#2F2A1F] whitespace-pre-wrap",children:r?e.content:s?"Add passage text or upload an image to preview the TOEIC-style layout.":"No passage text provided."})]})]})},ss=(()=>{const e=Ve.questions,s=ke.length;return{current:s,expected:e,answered:ke.filter(e=>e.correct_answer).length,percentage:e>0?s/e*100:0}})();return ne?a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):a.jsx(q,{title:`TOEIC ${Ve.name}`,showBackButton:!0,backPath:"/admin/toeic",children:a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-[#5D4E37]",children:ie||`TOEIC ${Ve.name}`}),a.jsxs("p",{className:"text-[#8B6914]",children:[Ve.description," â€¢ Questions ",Ve.questionRange]})]}),a.jsxs(l,{variant:"outline",className:"bg-[#FEF9E7] text-[#8B6914] border-[#E8D5A3] text-lg px-4 py-2",children:["Part ",Ve.number]})]}),a.jsx(o,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:a.jsxs(c,{className:"pt-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("span",{className:"text-[#5D4E37] font-medium",children:"Questions Added:"}),a.jsxs(l,{className:"bg-[#A68B5B] text-white text-lg px-3",children:[ss.current," / ",ss.expected]}),ss.answered>0&&a.jsxs(l,{variant:"outline",className:"border-green-500 text-green-600",children:[a.jsx(D,{className:"w-3 h-3 mr-1"}),ss.answered," answered"]}),ss.current>0&&ss.current-ss.answered>0&&a.jsxs(l,{variant:"outline",className:"border-amber-500 text-amber-600",children:[a.jsx(C,{className:"w-3 h-3 mr-1"}),ss.current-ss.answered," missing answers"]})]}),a.jsxs(d,{onClick:Ze,disabled:me||Ie||0===ke.length,className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[a.jsx(B,{className:"w-4 h-4 mr-2"}),me?"Saving...":Ie?"Saved âœ“":"Save All Questions"]})]}),a.jsx(x,{value:ss.percentage,className:"h-3 bg-[#E8D5A3]"})]})}),a.jsxs(o,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsx(m,{children:a.jsx(h,{className:"text-lg text-[#5D4E37]",children:"Add Questions"})}),a.jsx(c,{children:a.jsxs(f,{value:de,onValueChange:e=>xe(e),children:[a.jsxs(E,{className:"grid w-full mb-4 bg-[#E8D5A3]/20 border border-[#E8D5A3] "+(Ve.hasPassages?"grid-cols-4":"grid-cols-3"),children:[Ve.hasPassages&&a.jsxs(_,{value:"passage",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[a.jsx(S,{className:"w-4 h-4 mr-2"}),"Upload Passage"]}),a.jsxs(_,{value:"paste",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[a.jsx(k,{className:"w-4 h-4 mr-2"}),"Paste Questions"]}),a.jsxs(_,{value:"image",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[a.jsx(P,{className:"w-4 h-4 mr-2"}),"Extract from Image"]}),a.jsxs(_,{value:"answers",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[a.jsx(F,{className:"w-4 h-4 mr-2"}),"Answer Key"]})]}),a.jsx("div",{className:"flex justify-end mb-3",children:a.jsx(d,{onClick:Ze,disabled:me||Ie||0===ke.length,variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37]",children:me?"Saving...":Ie?"Saved âœ“":"Save Questions"})}),Ve.hasPassages&&a.jsxs(y,{value:"passage",className:"space-y-6",children:[a.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Passage Title (optional)"}),a.jsx(u,{value:Re.title||"",onChange:e=>Le(s=>({...s,title:e.target.value})),placeholder:"Bank Mortgage Rates Will Fall",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]}),a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Passage Text"}),a.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:"Paste the passage exactly as in the booklet. If you upload an image, you can still paste the text for accessibility."}),a.jsx(p,{value:Re.content,onChange:e=>Le(s=>({...s,content:e.target.value,mode:"text"})),rows:8,placeholder:"Several of Canada's largest banks ------- to decrease their mortgage rates...\n\nBank Mortgage Rates Will Fall\n\nSeveral of Canada's largest banks have decided to decrease their mortgage rates.",className:"font-mono text-sm bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Question Start"}),a.jsx(u,{type:"number",value:Re.questionStart,onChange:e=>Le(s=>({...s,questionStart:Number(e.target.value)})),className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]}),a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Question End"}),a.jsx(u,{type:"number",value:Re.questionEnd,onChange:e=>Le(s=>({...s,questionEnd:Number(e.target.value)})),className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]})]}),a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Passage Type"}),a.jsxs(b,{value:Re.type,onValueChange:e=>Le(s=>({...s,type:e})),children:[a.jsx(j,{className:"bg-white border-[#E8D5A3] text-[#5D4E37]",children:a.jsx(v,{})}),a.jsxs(w,{children:[a.jsx(N,{value:"single",children:"Single (Part 6 default)"}),a.jsx(N,{value:"double",children:"Double passage"}),a.jsx(N,{value:"triple",children:"Triple passage"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Upload Passage Image (optional)"}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("label",{className:"cursor-pointer inline-block",children:[a.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t){Se(!0);try{const e=new FileReader;e.onloadend=()=>{const s=e.result,t=Oe();Le(e=>({...e,imageUrl:s,mode:"image",questionStart:t.start,questionEnd:t.end})),i.success("Passage image ready! Adjust question range then click Add Passage.")},e.readAsDataURL(t)}catch(a){console.error("Error uploading image:",a),i.error("Failed to upload image")}finally{Se(!1)}}},disabled:Be}),a.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-[#A68B5B] hover:bg-[#8B6914] text-white rounded-lg transition-colors",children:[a.jsx($,{className:"w-4 h-4"}),Be?"Uploading...":"Select Image"]})]}),Re.imageUrl&&a.jsx(l,{className:"bg-[#A68B5B] text-white",children:"Image attached"})]}),Re.imageUrl&&a.jsx("img",{src:Re.imageUrl,alt:"Passage preview",className:"max-h-48 rounded border border-[#E8D5A3]"})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs(d,{onClick:()=>{var e;const s=Re.content.trim().length>0,t=!!Re.imageUrl;if(!s&&!t)return void i.error("Add passage text or upload an image first");if(Re.questionStart>Re.questionEnd)return void i.error("Question start must be before end");const a={title:(null==(e=Re.title)?void 0:e.trim())||"",content:Re.content.trim(),type:Re.type,imageUrl:Re.imageUrl,questionStart:Re.questionStart,questionEnd:Re.questionEnd,mode:Re.mode||(Re.imageUrl?"image":"text")};$e(e=>[...e,a]),Ue(!1),i.success(`Passage added for Q${a.questionStart}-${a.questionEnd}`),We()},className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[a.jsx(I,{className:"w-4 h-4 mr-2"}),"Add Passage"]}),a.jsx(d,{variant:"outline",onClick:We,className:"border-[#E8D5A3] text-[#5D4E37]",children:"Reset"})]}),a.jsx("p",{className:"text-xs text-[#8B6914]",children:"Upload, paste, or extractâ€”everything feeds the same passage preview so it matches the TOEIC booklet layout."})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Passage Preview"}),a.jsx("p",{className:"text-sm text-[#8B6914]",children:"Preview mimics the official TOEIC Reading booklet (see sample). Question range and title are pinned to the header."}),es(Re,!0)]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Passages in this test"}),0===Fe.length?a.jsxs("p",{className:"text-sm text-[#8B6914]",children:["No passages yet. Add one to attach questions ",Ve.questionRange,"."]}):a.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Fe.map((e,s)=>a.jsxs("div",{className:"border border-[#E8D5A3] rounded-lg bg-white shadow-sm p-3 space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(l,{className:"bg-[#A68B5B] text-white",children:["Passage ",s+1,": Q",e.questionStart,"-",e.questionEnd]}),a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{$e(e=>e.filter((e,t)=>t!==s)),Ue(!1),We()},className:"text-red-500 hover:text-red-700",children:a.jsx(U,{className:"w-4 h-4"})})]}),a.jsx(u,{value:e.title||"",onChange:e=>{const t=e.target.value;$e(e=>e.map((e,a)=>a===s?{...e,title:t}:e)),Ue(!1)},placeholder:"Passage title",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsx(u,{type:"number",value:e.questionStart,onChange:e=>{const t=Number(e.target.value);$e(e=>e.map((e,a)=>a===s?{...e,questionStart:t}:e)),Ue(!1)},className:"bg-white border-[#E8D5A3] text-[#5D4E37]",placeholder:"Start #"}),a.jsx(u,{type:"number",value:e.questionEnd,onChange:e=>{const t=Number(e.target.value);$e(e=>e.map((e,a)=>a===s?{...e,questionEnd:t}:e)),Ue(!1)},className:"bg-white border-[#E8D5A3] text-[#5D4E37]",placeholder:"End #"})]}),a.jsxs(b,{value:e.type,onValueChange:e=>{$e(t=>t.map((t,a)=>a===s?{...t,type:e}:t)),Ue(!1)},children:[a.jsx(j,{className:"bg-white border-[#E8D5A3] text-[#5D4E37]",children:a.jsx(v,{})}),a.jsxs(w,{children:[a.jsx(N,{value:"single",children:"Single"}),a.jsx(N,{value:"double",children:"Double"}),a.jsx(N,{value:"triple",children:"Triple"})]})]}),!e.imageUrl&&a.jsx(p,{value:e.content,onChange:e=>{const t=e.target.value;$e(e=>e.map((e,a)=>a===s?{...e,content:t,mode:"text"}:e)),Ue(!1)},rows:4,placeholder:"Passage text...",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"}),e.imageUrl&&a.jsx("img",{src:e.imageUrl,alt:`Passage ${s+1}`,className:"max-h-48 rounded border"}),es(e)]},s))})]})]}),a.jsxs(y,{value:"paste",className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Paste TOEIC Questions"}),a.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:"Paste all questions with their options. Format: 101. question text (A) opt (B) opt (C) opt (D) opt"}),a.jsx(p,{value:qe,onChange:e=>Ae(e.target.value),placeholder:"101. The new employee was asked to ------- all documents before submitting them to the supervisor.\n(A) review\n(B) reviews\n(C) reviewing\n(D) reviewed\n\n102. Ms. Johnson's presentation was ------- received by the board members.\n(A) favorable\n(B) favorably\n(C) favor\n(D) favoring",rows:14,className:"font-mono text-sm bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),a.jsxs(d,{onClick:()=>{if(qe.trim()){ue(!0);try{const e=qe.trim(),s=[],t=e.split(/(?=\b\d{3}\b\.)/);for(const a of t){const e=a.trim();if(!e)continue;const t=e.match(/^(\d{3})\.\s*/);if(!t)continue;const r=parseInt(t[1]),n=e.slice(t[0].length),i=n.match(/\(A\)\s*([^(]+)\s*\(B\)\s*([^(]+)\s*\(C\)\s*([^(]+)\s*\(D\)\s*([^(]*?)(?=\d{3}\.|$)/s);if(!i){console.log(`Q${r}: Could not find all options`);continue}const l=n.indexOf("(A)"),o=n.slice(0,l).replace(/\s+/g," ").trim(),[,c,d,x,m]=i,h=e=>e.replace(/\s+/g," ").trim().replace(/\d{3}\.$/,"").trim();o&&s.push({question_number:r,question_text:o,question_type:Ge(),options:[h(c),h(d),h(x),h(m)],correct_answer:"",explanation:"",toeic_part:Ve.number,passage_context:Ke(r)})}s.length>0?(Pe(e=>[...e,...s]),Ue(!1),Ae(""),i.success(`${s.length} questions parsed successfully!`)):i.error("No questions could be parsed. Check format: 101. question text (A) opt (B) opt (C) opt (D) opt")}catch(e){console.error("Error parsing questions:",e),i.error("Failed to parse questions")}finally{ue(!1)}}else i.error("Please enter question text to parse")},disabled:ge||!qe.trim(),className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[a.jsx(P,{className:"w-4 h-4 mr-2"}),ge?"Parsing...":"Parse Questions"]})]}),a.jsx(y,{value:"image",children:a.jsx(A,{testId:ae||"",testType:"TOEIC",onQuestionsExtracted:e=>{const s=e.map((e,s)=>({question_number:e.question_number||ke.length+s+101,question_text:e.question_text,question_type:e.question_type||Ge(),options:e.options,correct_answer:e.correct_answer||"",explanation:e.explanation||"",toeic_part:Ve.number,passage_context:e.passage_context||Ke(e.question_number||ke.length+s+101)}));Pe(e=>[...e,...s]),Ue(!1),i.success(`${s.length} questions extracted!`)}})}),a.jsxs(y,{value:"answers",className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx(g,{className:"text-[#5D4E37]",children:"Paste Answer Key"}),a.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:'Paste answer key in format: "101. (A) 102. (B) 103. (C)..."'}),a.jsx(p,{value:De,onChange:e=>Ce(e.target.value),placeholder:"101. (A) 102. (B) 103. (C) 104. (D) 105. (A) 106. (B) 107. (C) 108. (D) 109. (A) 110. (B)",rows:6,className:"font-mono text-sm bg-white border-[#E8D5A3]"})]}),a.jsxs(d,{onClick:()=>{if(De.trim()){ue(!0);try{const e=De.replace(/[\{\}\[\]\+]/g," ").replace(/[,;:]/g," ").replace(/\s+/g," "),s=/(\d{3})\s*[\.\-]?\s*\(?\s*([A-DÐ-Ð“])\s*\)?/gi,t={};let a;for(;null!==(a=s.exec(e));){const e=parseInt(a[1]),s=a[2].toUpperCase(),r=Ye(s);["A","B","C","D"].includes(r)&&(t[e]=r)}const r=Object.keys(t).length;r>0?(Pe(e=>e.map(e=>t[e.question_number]?{...e,correct_answer:t[e.question_number]}:e)),Ue(!1),Ce(""),Te(!0),i.success(`${r} answers matched! Answers are now locked.`)):i.error("No answers could be parsed. Format: 101. (A) 102. (B) ...")}catch(e){console.error("Error parsing answers:",e),i.error("Failed to parse answer key")}finally{ue(!1)}}else i.error("Please enter answer key text")},disabled:ge||!De.trim()||0===ke.length,className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[a.jsx(F,{className:"w-4 h-4 mr-2"}),ge?"Matching...":"Match Answers"]}),0===ke.length&&a.jsx("p",{className:"text-sm text-amber-600",children:"Add questions first before matching answers."})]})]})})]}),a.jsxs(o,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[a.jsx(m,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(h,{className:"text-[#5D4E37]",children:"Questions"}),a.jsx(l,{className:"bg-[#A68B5B] text-white",children:ke.length})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex items-center border border-[#E8D5A3] rounded-lg overflow-hidden",children:[a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ee("list"),ve(!1)},className:"rounded-none px-3 "+("list"!==fe||je?"text-[#5D4E37]":"bg-[#A68B5B] text-white"),children:a.jsx(Q,{className:"w-4 h-4"})}),a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ee("grid"),ve(!1)},className:"rounded-none px-3 "+("grid"!==fe||je?"text-[#5D4E37]":"bg-[#A68B5B] text-white"),children:a.jsx(T,{className:"w-4 h-4"})})]}),"grid"===fe&&!je&&a.jsxs(b,{value:String(_e),onValueChange:e=>ye(Number(e)),children:[a.jsx(j,{className:"w-24 h-8 bg-white border-[#E8D5A3]",children:a.jsx(v,{})}),a.jsxs(w,{children:[a.jsx(N,{value:"2",children:"2 cols"}),a.jsx(N,{value:"3",children:"3 cols"}),a.jsx(N,{value:"4",children:"4 cols"}),a.jsx(N,{value:"5",children:"5 cols"}),a.jsx(N,{value:"6",children:"6 cols"})]})]}),a.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{ve(!je),Ne(0)},className:"border-[#E8D5A3] "+(je?"bg-[#A68B5B] text-white":"text-[#5D4E37]"),disabled:0===ke.length,children:[je?a.jsx(z,{className:"w-4 h-4 mr-1"}):a.jsx(M,{className:"w-4 h-4 mr-1"}),je?"Exit Preview":"Preview"]}),a.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{const e="Part5"===oe?101:"Part6"===oe?131:147,s=ke.length>0?Math.max(...ke.map(e=>e.question_number))+1:e,t={question_number:s,question_text:"",question_type:Ge(),options:["","","",""],correct_answer:"",explanation:"",toeic_part:Ve.number,passage_context:Ke(s)};Pe(e=>[...e,t]),Ue(!1),Ne(ke.length),ve(!0),i.success(`Question ${s} added - ready to edit!`)},className:"border-[#E8D5A3] text-[#5D4E37]",children:[a.jsx(I,{className:"w-4 h-4 mr-1"}),"Add"]}),a.jsxs(d,{variant:"outline",size:"sm",onClick:async()=>{var e;const s=ke.filter(e=>e.correct_answer);if(0!==s.length){console.log(`ðŸ§  Generating explanations for ${s.length} questions...`),be(!0);try{const t=10,a=[];for(let r=0;r<s.length;r+=t){const l=s.slice(r,r+t),o=Math.floor(r/t)+1,c=Math.ceil(s.length/t);console.log(`ðŸ“¦ Processing batch ${o}/${c} (${l.length} questions)`),c>1&&i.info(`Processing batch ${o}/${c}...`);const{data:d,error:x}=await n.functions.invoke("toeic-generate-explanations",{body:{questions:l.map(e=>{var s;return{question_number:e.question_number,question_text:e.question_text,options:e.options,correct_answer:e.correct_answer,passage_context:null==(s=e.passage_context)?void 0:s.substring(0,200),part:Ve.number}}),testType:"TOEIC Reading",part:Ve.number}});if(x)throw console.error(`âŒ Batch ${o} error:`,x),x;if(!(null==d?void 0:d.success))throw console.error(`âŒ Batch ${o} failed:`,null==d?void 0:d.error),new Error((null==d?void 0:d.error)||"Failed to generate explanations");console.log(`âœ… Batch ${o} complete: ${(null==(e=d.explanations)?void 0:e.length)||0} explanations`),a.push(...d.explanations||[])}if(a.length>0){let e=0;Pe(s=>s.map(s=>{if(s.correct_answer&&e<a.length){let t=a[e];return e++,"object"==typeof t&&null!==t&&(t=t.text||t.content||t.explanation||JSON.stringify(t)),{...s,ai_explanation:String(t)}}return s})),Ue(!1),i.success(`Generated ${a.length} AI explanations!`)}else i.error("No explanations returned. Please try again.")}catch(t){console.error("Error generating explanations:",t),i.error("Failed to generate AI explanations. Check console for details.")}finally{be(!1)}}else i.error("Please set correct answers first before generating explanations")},disabled:pe||0===ke.filter(e=>e.correct_answer).length,className:"border-[#E8D5A3] text-[#5D4E37]",children:[a.jsx(O,{className:"w-4 h-4 mr-1"}),pe?"Generating...":"AI Explain"]}),ke.some(e=>e.ai_explanation)&&a.jsxs(d,{variant:"outline",size:"sm",onClick:async()=>{if(!ae)return;const e=ke.filter(e=>e.ai_explanation);if(0!==e.length){he(!0);try{const{data:s,error:t}=await n.functions.invoke("save-reading-test",{body:{mode:"toeic",testId:ae,part:Ve.number,questions:ke.map(e=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer,explanation:e.explanation,ai_explanation:e.ai_explanation,passage_context:e.passage_context,related_passage_id:e.related_passage_id})),passages:Fe.map(e=>({type:e.type,title:e.title,content:e.content,imageUrl:e.imageUrl,questionStart:e.questionStart,questionEnd:e.questionEnd}))}});if(t)throw t;if(!(null==s?void 0:s.success))throw new Error((null==s?void 0:s.error)||"Failed to save explanations");Ue(!0),i.success(`Saved ${e.length} explanations!`)}catch(s){console.error("Error saving explanations:",s),i.error("Failed to save explanations")}finally{he(!1)}}else i.error("No explanations to save")},disabled:me,className:"border-green-300 text-green-700 hover:bg-green-50",children:[a.jsx(B,{className:"w-4 h-4 mr-1"}),me?"Saving...":"Save Explanations"]})]})]})}),a.jsx(c,{children:ke.length>0?je?a.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-[#E8D5A3] overflow-hidden",children:[a.jsxs("div",{className:"bg-[#5D4E37] px-6 py-3 flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(d,{variant:"ghost",size:"icon",onClick:()=>Ne(Math.max(0,we-1)),disabled:0===we,className:"text-white/80 hover:text-white hover:bg-white/20 disabled:opacity-30",children:a.jsx(R,{className:"w-5 h-5"})}),a.jsxs(l,{className:"bg-[#A68B5B] text-white px-4 py-1.5 font-semibold",children:["Q",null==(G=ke[we])?void 0:G.question_number]}),a.jsxs("span",{className:"text-white/80 text-sm",children:[we+1," of ",ke.length]}),a.jsx(d,{variant:"ghost",size:"icon",onClick:()=>Ne(Math.min(ke.length-1,we+1)),disabled:we>=ke.length-1,className:"text-white/80 hover:text-white hover:bg-white/20 disabled:opacity-30",children:a.jsx(L,{className:"w-5 h-5"})})]}),a.jsx("div",{className:"flex items-center gap-2",children:a.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>{Xe(we)},className:"text-red-300 hover:text-red-100 hover:bg-red-500/20",children:[a.jsx(U,{className:"w-4 h-4 mr-1"}),"Delete"]})})]}),a.jsxs("div",{className:"p-6 bg-[#FEF9E7]",children:[a.jsxs("div",{className:"mb-6",children:[a.jsx(g,{className:"text-xs text-[#8B6914] uppercase tracking-wide mb-2 block",children:"Question Text"}),a.jsx(p,{value:(null==(K=ke[we])?void 0:K.question_text)||"",onChange:e=>He(we,"question_text",e.target.value),className:"text-lg text-[#5D4E37] bg-white border border-[#E8D5A3] min-h-[80px] placeholder:text-gray-400",placeholder:"Enter question text..."})]}),a.jsxs("div",{className:"space-y-3 mb-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(g,{className:"text-xs text-[#8B6914] uppercase tracking-wide",children:["Options ",Qe?"(Locked)":"(click to set correct)"]}),Qe&&(null==(W=ke[we])?void 0:W.correct_answer)&&a.jsx(d,{variant:"outline",size:"sm",onClick:()=>Te(!1),className:"text-xs border-amber-400 text-amber-600 hover:bg-amber-50",children:"ðŸ”“ Modify Answer"})]}),((null==(Y=ke[we])?void 0:Y.options)||["","","",""]).map((e,s)=>{var t;const r=String.fromCharCode(65+s),n=(null==(t=ke[we])?void 0:t.correct_answer)===r;return a.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg border-2 ${n?"border-green-400 bg-green-50":"border-gray-200 bg-white"} ${Qe?"opacity-90":""}`,children:[a.jsx("button",{onClick:()=>!Qe&&He(we,"correct_answer",r),disabled:Qe,className:"w-10 h-10 rounded-full font-bold transition-all "+(n?"bg-green-500 text-white scale-110":Qe?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-gray-100 text-[#5D4E37] hover:bg-[#A68B5B] hover:text-white"),children:r}),a.jsx(u,{value:e,onChange:e=>{var t;const a=[...(null==(t=ke[we])?void 0:t.options)||["","","",""]];a[s]=e.target.value,He(we,"options",a)},disabled:Qe,className:"flex-1 border border-gray-200 bg-white text-[#5D4E37] placeholder:text-gray-400 "+(Qe?"bg-gray-50":""),placeholder:`Option ${r}...`}),n&&a.jsx(F,{className:"w-5 h-5 text-green-500"})]},s)})]}),!(null==(H=ke[we])?void 0:H.correct_answer)&&!Qe&&a.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 text-sm flex items-center gap-2",children:[a.jsx(C,{className:"w-4 h-4"}),"Click a letter to set the correct answer"]}),Qe&&(null==(X=ke[we])?void 0:X.correct_answer)&&a.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm flex items-center gap-2",children:[a.jsx(F,{className:"w-4 h-4"}),"Answer locked: ",null==(Z=ke[we])?void 0:Z.correct_answer,'. Click "Modify Answer" to change.']}),a.jsxs("div",{className:"space-y-2 pt-4 border-t border-[#E8D5A3]",children:[a.jsxs(g,{className:"text-xs text-[#8B6914] uppercase tracking-wide flex items-center gap-2",children:[a.jsx(O,{className:"w-3 h-3"}),"AI Explanation"]}),a.jsx(p,{value:(null==(ee=ke[we])?void 0:ee.ai_explanation)||"",onChange:e=>He(we,"ai_explanation",e.target.value),placeholder:"Click 'AI Explain' button above to generate explanation, or type manually...",rows:3,className:"text-sm bg-white border border-[#E8D5A3] text-[#5D4E37] placeholder:text-gray-400"}),(null==(se=ke[we])?void 0:se.ai_explanation)&&a.jsxs("p",{className:"text-xs text-green-600 flex items-center gap-1",children:[a.jsx(F,{className:"w-3 h-3"})," Explanation saved"]})]})]}),a.jsxs("div",{className:"bg-[#FEF9E7] px-6 py-3 border-t border-[#E8D5A3] flex items-center justify-center gap-2",children:[a.jsx("span",{className:"text-sm text-[#8B6914]",children:"Jump to:"}),a.jsxs(b,{value:String(we),onValueChange:e=>Ne(Number(e)),children:[a.jsx(j,{className:"w-32 h-8 bg-white border-[#E8D5A3]",children:a.jsx(v,{})}),a.jsx(w,{children:ke.map((e,s)=>a.jsxs(N,{value:String(s),children:["Q",e.question_number," ",e.correct_answer?"âœ“":"?"]},s))})]})]}),a.jsxs("div",{className:"bg-white border-t border-[#E8D5A3] px-6 py-4 space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("h4",{className:"text-sm font-semibold text-[#5D4E37]",children:"Answer Sheet"}),a.jsxs(l,{className:"bg-[#A68B5B] text-white",children:[ke.filter(e=>e.correct_answer).length," / ",ke.length," answered"]}),Qe&&a.jsx(l,{className:"bg-green-600 text-white",children:"ðŸ”’ Locked"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[Qe?a.jsx(d,{onClick:()=>Te(!1),size:"sm",variant:"outline",className:"border-amber-400 text-amber-600 hover:bg-amber-50",children:"ðŸ”“ Modify Answers"}):a.jsx(d,{onClick:()=>Te(!0),size:"sm",variant:"outline",className:"border-green-400 text-green-600 hover:bg-green-50",disabled:0===ke.filter(e=>e.correct_answer).length,children:"ðŸ”’ Lock Answers"}),a.jsx(d,{onClick:Ze,disabled:me||Ie||0===ke.length,size:"sm",className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:me?"Saving...":Ie?"Saved âœ“":"Save Answers"})]})]}),0===ke.length?a.jsx("p",{className:"text-sm text-[#8B6914]",children:"No questions yet."}):a.jsx("div",{className:"grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:ke.map((e,s)=>a.jsxs("div",{className:"rounded-md border px-3 py-2 text-sm space-y-2 "+(e.correct_answer?"border-green-200 bg-green-50 text-green-700":"border-amber-200 bg-amber-50 text-amber-700"),children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"font-semibold",children:["Q",e.question_number]}),a.jsx(l,{variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37] bg-white",children:e.correct_answer||"?"})]}),a.jsx("div",{className:"flex items-center gap-2",children:["A","B","C","D"].map(t=>{const r=e.correct_answer===t;return a.jsx(d,{type:"button",size:"sm",variant:r?"default":"outline",className:r?"bg-green-600 text-white":Qe?"border-gray-200 text-gray-400 cursor-not-allowed":"border-[#E8D5A3] text-[#5D4E37]",onClick:()=>!Qe&&He(s,"correct_answer",t),disabled:Qe,children:t},t)})})]},e.question_number))})]})]}):"grid"===fe?a.jsx("div",{className:"grid gap-3 max-h-[600px] overflow-y-auto",style:{gridTemplateColumns:`repeat(${_e}, minmax(0, 1fr))`},children:ke.map((e,s)=>a.jsxs("div",{onClick:()=>{Ne(s),ve(!0)},className:"p-3 rounded-lg border-2 cursor-pointer hover:shadow-md transition-all "+(e.correct_answer?"border-green-300 bg-green-50":"border-amber-300 bg-amber-50"),children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs(l,{className:(e.correct_answer?"bg-green-500":"bg-amber-500")+" text-white text-xs",children:["Q",e.question_number]}),e.correct_answer?a.jsx(l,{className:"bg-green-600 text-white text-xs",children:e.correct_answer}):a.jsx(l,{variant:"outline",className:"border-amber-400 text-amber-600 text-xs",children:"?"})]}),a.jsx("p",{className:"text-xs text-gray-700 line-clamp-2",children:e.question_text||"No text"})]},s))}):a.jsx("div",{className:"space-y-3 max-h-[600px] overflow-y-auto",children:ke.map((e,s)=>a.jsx(o,{className:"border border-[#E8D5A3] bg-white",children:a.jsxs(c,{className:"p-4",children:[a.jsxs("div",{className:"flex items-start justify-between mb-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(l,{variant:"outline",className:"border-[#E8D5A3]",children:["Q",e.question_number]}),e.correct_answer?a.jsxs(l,{className:"bg-green-500 text-white",children:["Answer: ",e.correct_answer]}):a.jsx(l,{variant:"outline",className:"border-amber-400 text-amber-600",children:"No answer"})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ne(s),ve(!0)},children:a.jsx(M,{className:"w-4 h-4 text-[#8B6914]"})}),a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>Xe(s),children:a.jsx(U,{className:"w-4 h-4 text-red-500"})})]})]}),a.jsx("p",{className:"text-sm text-[#5D4E37] line-clamp-2",children:e.question_text||"No question text"}),e.options&&a.jsx("div",{className:"flex gap-2 mt-2",children:e.options.map((s,t)=>a.jsxs("span",{className:"text-xs px-2 py-1 rounded "+(e.correct_answer===String.fromCharCode(65+t)?"bg-green-100 text-green-700":"bg-gray-100"),children:["(",String.fromCharCode(65+t),") ",s.slice(0,20),s.length>20?"...":""]},t))})]})},s))}):a.jsxs("div",{className:"text-center py-12 text-[#8B6914]",children:[a.jsx(V,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),a.jsx("p",{children:"No questions added yet."}),a.jsx("p",{className:"text-sm",children:"Use the methods above to add questions."})]})})]})]})})};export{G as default};
