import{u as e,G as s,w as t,r as a,J as r,j as n,l as i,C as l,a as o,x as c,B as d,K as x,b as m,d as h,U as g,L as u,R as p,I as b,T as j,S as v,p as w,q as N,s as f,t as E,P as _,N as y,E as q,O as A,Q as D,k as C,e as B}from"./index-DsPg4zpT.js";import{T as S,a as k,b as P,c as F}from"./tabs-DQIRCZUw.js";import{A as U}from"./AdminLayout-IhV4fV1i.js";import{I}from"./ImageQuestionExtractor-DbrGj-Pi.js";import{s as $}from"./supabase-DWL4C3fA.js";import{C as Q}from"./circle-alert-fGiMDAUJ.js";import{S as T}from"./save-BM3Xb5pu.js";import{I as z}from"./image-_A13RlCT.js";import{W as O}from"./wand-sparkles-C9ObF7yq.js";import{U as R}from"./upload-omnEG4fH.js";import{T as M}from"./trash-2-Dj85UBI0.js";import{L}from"./list-h86Ge00t.js";import{L as J}from"./layout-grid-DpjTyEih.js";const V={Part5:{number:5,name:"Incomplete Sentences",questions:30,questionRange:"101-130",description:"Choose the word or phrase that best completes the sentence",hasPassages:!1},Part6:{number:6,name:"Text Completion",questions:16,questionRange:"131-146",description:"Complete passages with missing words or sentences (4 passages Ã— 4 questions)",hasPassages:!0},Part7:{number:7,name:"Reading Comprehension",questions:54,questionRange:"147-200",description:"Read passages and answer questions about them",hasPassages:!0}},G=()=>{var G,K,W,H,X,Y,Z,ee,se;const te=e(),{testId:ae}=s(),{admin:re,loading:ne}=t(),[ie,le]=a.useState(""),[oe,ce]=a.useState("Part5"),[de,xe]=a.useState("paste"),[me,he]=a.useState(!1),[ge,ue]=a.useState(!1),[pe,be]=a.useState(!1),[je,ve]=a.useState(!1),[we,Ne]=a.useState(0),[fe,Ee]=a.useState("list"),[_e,ye]=a.useState(3),[qe,Ae]=a.useState(""),[De,Ce]=a.useState(""),[Be,Se]=a.useState(!1),[ke,Pe]=a.useState([]),[Fe,Ue]=a.useState([]),[Ie,$e]=a.useState(!1),[Qe,Te]=a.useState(!1),ze="Part6"===oe?4:3,Oe=()=>"Part6"===oe?131:147,Re=()=>{const e=(Fe.length>0?Fe[Fe.length-1].questionEnd:Oe()-1)+1;return{start:e,end:e+ze-1}},[Me,Le]=a.useState({title:"",content:"",type:"single",imageUrl:"",questionStart:Oe(),questionEnd:Oe()+ze-1,mode:"text"}),Je=V[oe];a.useEffect(()=>{ne||re||te("/admin/login")},[re,ne,te]),a.useEffect(()=>{ae&&Ve()},[ae]);const Ve=async()=>{if(ae)try{const{data:e,error:s}=await $.from("tests").select("*").eq("id",ae).single();if(s)throw s;le(e.test_name),e.test_subtype&&["Part5","Part6","Part7"].includes(e.test_subtype)&&ce(e.test_subtype);const{data:t,error:a}=await $.from("questions").select("*").eq("test_id",ae).order("question_number_in_part",{ascending:!0});if(a)throw a;const r=(t||[]).map(e=>({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,explanation:e.explanation||"",ai_explanation:e.ai_explanation,toeic_part:e.toeic_part||5,passage_context:e.passage_context,related_passage_id:e.related_passage_id}));Pe(r);r.some(e=>e.correct_answer)&&Te(!0);const{data:n}=await $.from("toeic_passages").select("*").eq("test_id",ae).order("question_range_start",{ascending:!0});n&&Ue(n.map(e=>({id:e.id,title:e.passage_title,content:e.passage_content,type:e.passage_type,imageUrl:e.passage_image_url,questionStart:e.question_range_start,questionEnd:e.question_range_end})))}catch(e){console.error("Error loading test data:",e),r.error("Failed to load test data")}},Ge=()=>5===Je.number?"incomplete_sentence":6===Je.number?"text_completion":"reading_comprehension",Ke=e=>{const s=Fe.find(s=>e>=s.questionStart&&e<=s.questionEnd);return s?s.content?s.content:s.title?s.title:"":""},We=()=>{const e=Re();Le({title:"",content:"",type:"single",imageUrl:"",questionStart:e.start,questionEnd:e.end,mode:"text"})};a.useEffect(()=>{We()},[oe,Fe.length]);const He=e=>({"Ð":"A","Ð’":"B","Ð¡":"C","Ð”":"D"}[e]||e),Xe=(e,s,t)=>{Pe(a=>{const r=[...a];return r[e]={...r[e],[s]:t},r}),$e(!1)},Ye=e=>{Pe(s=>s.filter((s,t)=>t!==e)),$e(!1),we>=ke.length-1&&Ne(Math.max(0,we-1))},Ze=async()=>{if(ae){he(!0);try{const{data:e,error:s}=await $.functions.invoke("save-reading-test",{body:{mode:"toeic",testId:ae,part:Je.number,questions:ke.map((e,s)=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer,explanation:e.explanation,ai_explanation:e.ai_explanation,passage_context:e.passage_context,related_passage_id:e.related_passage_id})),passages:Fe.map(e=>({type:e.type,title:e.title,content:e.content,imageUrl:e.imageUrl,questionStart:e.questionStart,questionEnd:e.questionEnd}))}});if(s)throw s;if(!(null==e?void 0:e.success))throw new Error((null==e?void 0:e.error)||"Failed to save questions");$e(!0),Te(!0),r.success(`Saved ${e.questionsCount} questions!`)}catch(e){console.error("Error saving questions:",e),r.error("Failed to save questions")}finally{he(!1)}}},es=(e,s=!1)=>{var t;const a=(null==(t=e.content)?void 0:t.trim().length)>0,r=!!e.imageUrl;return n.jsxs("div",{className:"border-2 border-[#E8D5A3] rounded-lg bg-white shadow-sm overflow-hidden",children:[n.jsxs("div",{className:"bg-[#F6F0DC] border-b border-[#E8D5A3] px-4 py-2 flex items-center justify-between text-xs uppercase tracking-wide text-[#5D4E37]/80",children:[n.jsxs("span",{children:["Questions ",e.questionStart||"?","-",e.questionEnd||"?"]}),n.jsx("span",{children:Je.name})]}),n.jsxs("div",{className:"p-4 space-y-3",children:[n.jsx("h3",{className:"text-lg font-semibold text-[#2F2A1F]",children:e.title||(s?"Passage title":"Untitled passage")}),r?n.jsx("img",{src:e.imageUrl,alt:"Passage",className:"w-full rounded border border-[#E8D5A3]"}):n.jsx("p",{className:"text-sm leading-relaxed text-[#2F2A1F] whitespace-pre-wrap",children:a?e.content:s?"Add passage text or upload an image to preview the TOEIC-style layout.":"No passage text provided."})]})]})},ss=(()=>{const e=Je.questions,s=ke.length;return{current:s,expected:e,answered:ke.filter(e=>e.correct_answer).length,percentage:e>0?s/e*100:0}})();return ne?n.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):n.jsx(U,{title:`TOEIC ${Je.name}`,showBackButton:!0,backPath:"/admin/toeic",children:n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-2xl font-bold text-[#5D4E37]",children:ie||`TOEIC ${Je.name}`}),n.jsxs("p",{className:"text-[#8B6914]",children:[Je.description," â€¢ Questions ",Je.questionRange]})]}),n.jsxs(i,{variant:"outline",className:"bg-[#FEF9E7] text-[#8B6914] border-[#E8D5A3] text-lg px-4 py-2",children:["Part ",Je.number]})]}),n.jsx(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:n.jsxs(o,{className:"pt-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("span",{className:"text-[#5D4E37] font-medium",children:"Questions Added:"}),n.jsxs(i,{className:"bg-[#A68B5B] text-white text-lg px-3",children:[ss.current," / ",ss.expected]}),ss.answered>0&&n.jsxs(i,{variant:"outline",className:"border-green-500 text-green-600",children:[n.jsx(c,{className:"w-3 h-3 mr-1"}),ss.answered," answered"]}),ss.current>0&&ss.current-ss.answered>0&&n.jsxs(i,{variant:"outline",className:"border-amber-500 text-amber-600",children:[n.jsx(Q,{className:"w-3 h-3 mr-1"}),ss.current-ss.answered," missing answers"]})]}),n.jsxs(d,{onClick:Ze,disabled:me||Ie||0===ke.length,className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[n.jsx(T,{className:"w-4 h-4 mr-2"}),me?"Saving...":Ie?"Saved âœ“":"Save All Questions"]})]}),n.jsx(x,{value:ss.percentage,className:"h-3 bg-[#E8D5A3]"})]})}),n.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[n.jsx(m,{children:n.jsx(h,{className:"text-lg text-[#5D4E37]",children:"Add Questions"})}),n.jsx(o,{children:n.jsxs(S,{value:de,onValueChange:e=>xe(e),children:[n.jsxs(k,{className:"grid w-full mb-4 bg-[#E8D5A3]/20 border border-[#E8D5A3] "+(Je.hasPassages?"grid-cols-4":"grid-cols-3"),children:[Je.hasPassages&&n.jsxs(P,{value:"passage",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[n.jsx(z,{className:"w-4 h-4 mr-2"}),"Upload Passage"]}),n.jsxs(P,{value:"paste",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[n.jsx(g,{className:"w-4 h-4 mr-2"}),"Paste Questions"]}),n.jsxs(P,{value:"image",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[n.jsx(O,{className:"w-4 h-4 mr-2"}),"Extract from Image"]}),n.jsxs(P,{value:"answers",className:"data-[state=active]:bg-[#FEF9E7] data-[state=active]:text-[#5D4E37] text-[#8B6914]",children:[n.jsx(u,{className:"w-4 h-4 mr-2"}),"Answer Key"]})]}),n.jsx("div",{className:"flex justify-end mb-3",children:n.jsx(d,{onClick:Ze,disabled:me||Ie||0===ke.length,variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37]",children:me?"Saving...":Ie?"Saved âœ“":"Save Questions"})}),Je.hasPassages&&n.jsxs(F,{value:"passage",className:"space-y-6",children:[n.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Passage Title (optional)"}),n.jsx(b,{value:Me.title||"",onChange:e=>Le(s=>({...s,title:e.target.value})),placeholder:"Bank Mortgage Rates Will Fall",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]}),n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Passage Text"}),n.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:"Paste the passage exactly as in the booklet. If you upload an image, you can still paste the text for accessibility."}),n.jsx(j,{value:Me.content,onChange:e=>Le(s=>({...s,content:e.target.value,mode:"text"})),rows:8,placeholder:"Several of Canada's largest banks ------- to decrease their mortgage rates...\n\nBank Mortgage Rates Will Fall\n\nSeveral of Canada's largest banks have decided to decrease their mortgage rates.",className:"font-mono text-sm bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Question Start"}),n.jsx(b,{type:"number",value:Me.questionStart,onChange:e=>Le(s=>({...s,questionStart:Number(e.target.value)})),className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]}),n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Question End"}),n.jsx(b,{type:"number",value:Me.questionEnd,onChange:e=>Le(s=>({...s,questionEnd:Number(e.target.value)})),className:"bg-white border-[#E8D5A3] text-[#5D4E37]"})]})]}),n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Passage Type"}),n.jsxs(v,{value:Me.type,onValueChange:e=>Le(s=>({...s,type:e})),children:[n.jsx(w,{className:"bg-white border-[#E8D5A3] text-[#5D4E37]",children:n.jsx(N,{})}),n.jsxs(f,{children:[n.jsx(E,{value:"single",children:"Single (Part 6 default)"}),n.jsx(E,{value:"double",children:"Double passage"}),n.jsx(E,{value:"triple",children:"Triple passage"})]})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Upload Passage Image (optional)"}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("label",{className:"cursor-pointer inline-block",children:[n.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t){Se(!0);try{const e=new FileReader;e.onloadend=()=>{const s=e.result,t=Re();Le(e=>({...e,imageUrl:s,mode:"image",questionStart:t.start,questionEnd:t.end})),r.success("Passage image ready! Adjust question range then click Add Passage.")},e.readAsDataURL(t)}catch(a){console.error("Error uploading image:",a),r.error("Failed to upload image")}finally{Se(!1)}}},disabled:Be}),n.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-[#A68B5B] hover:bg-[#8B6914] text-white rounded-lg transition-colors",children:[n.jsx(R,{className:"w-4 h-4"}),Be?"Uploading...":"Select Image"]})]}),Me.imageUrl&&n.jsx(i,{className:"bg-[#A68B5B] text-white",children:"Image attached"})]}),Me.imageUrl&&n.jsx("img",{src:Me.imageUrl,alt:"Passage preview",className:"max-h-48 rounded border border-[#E8D5A3]"})]}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs(d,{onClick:()=>{var e;const s=Me.content.trim().length>0,t=!!Me.imageUrl;if(!s&&!t)return void r.error("Add passage text or upload an image first");if(Me.questionStart>Me.questionEnd)return void r.error("Question start must be before end");const a={title:(null==(e=Me.title)?void 0:e.trim())||"",content:Me.content.trim(),type:Me.type,imageUrl:Me.imageUrl,questionStart:Me.questionStart,questionEnd:Me.questionEnd,mode:Me.mode||(Me.imageUrl?"image":"text")};Ue(e=>[...e,a]),$e(!1),r.success(`Passage added for Q${a.questionStart}-${a.questionEnd}`),We()},className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[n.jsx(_,{className:"w-4 h-4 mr-2"}),"Add Passage"]}),n.jsx(d,{variant:"outline",onClick:We,className:"border-[#E8D5A3] text-[#5D4E37]",children:"Reset"})]}),n.jsx("p",{className:"text-xs text-[#8B6914]",children:"Upload, paste, or extractâ€”everything feeds the same passage preview so it matches the TOEIC booklet layout."})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Passage Preview"}),n.jsx("p",{className:"text-sm text-[#8B6914]",children:"Preview mimics the official TOEIC Reading booklet (see sample). Question range and title are pinned to the header."}),es(Me,!0)]})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Passages in this test"}),0===Fe.length?n.jsxs("p",{className:"text-sm text-[#8B6914]",children:["No passages yet. Add one to attach questions ",Je.questionRange,"."]}):n.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Fe.map((e,s)=>n.jsxs("div",{className:"border border-[#E8D5A3] rounded-lg bg-white shadow-sm p-3 space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(i,{className:"bg-[#A68B5B] text-white",children:["Passage ",s+1,": Q",e.questionStart,"-",e.questionEnd]}),n.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ue(e=>e.filter((e,t)=>t!==s)),$e(!1),We()},className:"text-red-500 hover:text-red-700",children:n.jsx(M,{className:"w-4 h-4"})})]}),n.jsx(b,{value:e.title||"",onChange:e=>{const t=e.target.value;Ue(e=>e.map((e,a)=>a===s?{...e,title:t}:e)),$e(!1)},placeholder:"Passage title",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsx(b,{type:"number",value:e.questionStart,onChange:e=>{const t=Number(e.target.value);Ue(e=>e.map((e,a)=>a===s?{...e,questionStart:t}:e)),$e(!1)},className:"bg-white border-[#E8D5A3] text-[#5D4E37]",placeholder:"Start #"}),n.jsx(b,{type:"number",value:e.questionEnd,onChange:e=>{const t=Number(e.target.value);Ue(e=>e.map((e,a)=>a===s?{...e,questionEnd:t}:e)),$e(!1)},className:"bg-white border-[#E8D5A3] text-[#5D4E37]",placeholder:"End #"})]}),n.jsxs(v,{value:e.type,onValueChange:e=>{Ue(t=>t.map((t,a)=>a===s?{...t,type:e}:t)),$e(!1)},children:[n.jsx(w,{className:"bg-white border-[#E8D5A3] text-[#5D4E37]",children:n.jsx(N,{})}),n.jsxs(f,{children:[n.jsx(E,{value:"single",children:"Single"}),n.jsx(E,{value:"double",children:"Double"}),n.jsx(E,{value:"triple",children:"Triple"})]})]}),!e.imageUrl&&n.jsx(j,{value:e.content,onChange:e=>{const t=e.target.value;Ue(e=>e.map((e,a)=>a===s?{...e,content:t,mode:"text"}:e)),$e(!1)},rows:4,placeholder:"Passage text...",className:"bg-white border-[#E8D5A3] text-[#5D4E37]"}),e.imageUrl&&n.jsx("img",{src:e.imageUrl,alt:`Passage ${s+1}`,className:"max-h-48 rounded border"}),es(e)]},s))})]})]}),n.jsxs(F,{value:"paste",className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Paste TOEIC Questions"}),n.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:"Paste all questions with their options. Format: 101. question text (A) opt (B) opt (C) opt (D) opt"}),n.jsx(j,{value:qe,onChange:e=>Ae(e.target.value),placeholder:"101. The new employee was asked to ------- all documents before submitting them to the supervisor.\n(A) review\n(B) reviews\n(C) reviewing\n(D) reviewed\n\n102. Ms. Johnson's presentation was ------- received by the board members.\n(A) favorable\n(B) favorably\n(C) favor\n(D) favoring",rows:14,className:"font-mono text-sm bg-white border-[#E8D5A3] focus:border-[#8B6914] focus:ring-[#8B6914] text-[#5D4E37]"})]}),n.jsxs(d,{onClick:()=>{if(qe.trim()){ue(!0);try{const e=qe.trim(),s=[],t=e.split(/(?=\b\d{3}\b\.)/);for(const a of t){const e=a.trim();if(!e)continue;const t=e.match(/^(\d{3})\.\s*/);if(!t)continue;const r=parseInt(t[1]),n=e.slice(t[0].length),i=n.match(/\(A\)\s*([^(]+)\s*\(B\)\s*([^(]+)\s*\(C\)\s*([^(]+)\s*\(D\)\s*([^(]*?)(?=\d{3}\.|$)/s);if(!i){console.log(`Q${r}: Could not find all options`);continue}const l=n.indexOf("(A)"),o=n.slice(0,l).replace(/\s+/g," ").trim(),[,c,d,x,m]=i,h=e=>e.replace(/\s+/g," ").trim().replace(/\d{3}\.$/,"").trim();o&&s.push({question_number:r,question_text:o,question_type:Ge(),options:[h(c),h(d),h(x),h(m)],correct_answer:"",explanation:"",toeic_part:Je.number,passage_context:Ke(r)})}s.length>0?(Pe(e=>[...e,...s]),$e(!1),Ae(""),r.success(`${s.length} questions parsed successfully!`)):r.error("No questions could be parsed. Check format: 101. question text (A) opt (B) opt (C) opt (D) opt")}catch(e){console.error("Error parsing questions:",e),r.error("Failed to parse questions")}finally{ue(!1)}}else r.error("Please enter question text to parse")},disabled:ge||!qe.trim(),className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[n.jsx(O,{className:"w-4 h-4 mr-2"}),ge?"Parsing...":"Parse Questions"]})]}),n.jsx(F,{value:"image",children:n.jsx(I,{testId:ae||"",testType:"TOEIC",onQuestionsExtracted:e=>{const s=e.map((e,s)=>({question_number:e.question_number||ke.length+s+101,question_text:e.question_text,question_type:e.question_type||Ge(),options:e.options,correct_answer:e.correct_answer||"",explanation:e.explanation||"",toeic_part:Je.number,passage_context:e.passage_context||Ke(e.question_number||ke.length+s+101)}));Pe(e=>[...e,...s]),$e(!1),r.success(`${s.length} questions extracted!`)}})}),n.jsxs(F,{value:"answers",className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx(p,{className:"text-[#5D4E37]",children:"Paste Answer Key"}),n.jsx("p",{className:"text-sm text-[#8B6914] mb-2",children:'Paste answer key in format: "101. (A) 102. (B) 103. (C)..."'}),n.jsx(j,{value:De,onChange:e=>Ce(e.target.value),placeholder:"101. (A) 102. (B) 103. (C) 104. (D) 105. (A) 106. (B) 107. (C) 108. (D) 109. (A) 110. (B)",rows:6,className:"font-mono text-sm bg-white border-[#E8D5A3]"})]}),n.jsxs(d,{onClick:()=>{if(De.trim()){ue(!0);try{const e=De.replace(/[\{\}\[\]\+]/g," ").replace(/[,;:]/g," ").replace(/\s+/g," "),s=/(\d{3})\s*[\.\-]?\s*\(?\s*([A-DÐ-Ð“])\s*\)?/gi,t={};let a;for(;null!==(a=s.exec(e));){const e=parseInt(a[1]),s=a[2].toUpperCase(),r=He(s);["A","B","C","D"].includes(r)&&(t[e]=r)}const n=Object.keys(t).length;n>0?(Pe(e=>e.map(e=>t[e.question_number]?{...e,correct_answer:t[e.question_number]}:e)),$e(!1),Ce(""),Te(!0),r.success(`${n} answers matched! Answers are now locked.`)):r.error("No answers could be parsed. Format: 101. (A) 102. (B) ...")}catch(e){console.error("Error parsing answers:",e),r.error("Failed to parse answer key")}finally{ue(!1)}}else r.error("Please enter answer key text")},disabled:ge||!De.trim()||0===ke.length,className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:[n.jsx(u,{className:"w-4 h-4 mr-2"}),ge?"Matching...":"Match Answers"]}),0===ke.length&&n.jsx("p",{className:"text-sm text-amber-600",children:"Add questions first before matching answers."})]})]})})]}),n.jsxs(l,{className:"bg-[#FEF9E7] border-[#E8D5A3]",children:[n.jsx(m,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx(h,{className:"text-[#5D4E37]",children:"Questions"}),n.jsx(i,{className:"bg-[#A68B5B] text-white",children:ke.length})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("div",{className:"flex items-center border border-[#E8D5A3] rounded-lg overflow-hidden",children:[n.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ee("list"),ve(!1)},className:"rounded-none px-3 "+("list"!==fe||je?"text-[#5D4E37]":"bg-[#A68B5B] text-white"),children:n.jsx(L,{className:"w-4 h-4"})}),n.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ee("grid"),ve(!1)},className:"rounded-none px-3 "+("grid"!==fe||je?"text-[#5D4E37]":"bg-[#A68B5B] text-white"),children:n.jsx(J,{className:"w-4 h-4"})})]}),"grid"===fe&&!je&&n.jsxs(v,{value:String(_e),onValueChange:e=>ye(Number(e)),children:[n.jsx(w,{className:"w-24 h-8 bg-white border-[#E8D5A3]",children:n.jsx(N,{})}),n.jsxs(f,{children:[n.jsx(E,{value:"2",children:"2 cols"}),n.jsx(E,{value:"3",children:"3 cols"}),n.jsx(E,{value:"4",children:"4 cols"}),n.jsx(E,{value:"5",children:"5 cols"}),n.jsx(E,{value:"6",children:"6 cols"})]})]}),n.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{ve(!je),Ne(0)},className:"border-[#E8D5A3] "+(je?"bg-[#A68B5B] text-white":"text-[#5D4E37]"),disabled:0===ke.length,children:[je?n.jsx(y,{className:"w-4 h-4 mr-1"}):n.jsx(q,{className:"w-4 h-4 mr-1"}),je?"Exit Preview":"Preview"]}),n.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{const e="Part5"===oe?101:"Part6"===oe?131:147,s=ke.length>0?Math.max(...ke.map(e=>e.question_number))+1:e,t={question_number:s,question_text:"",question_type:Ge(),options:["","","",""],correct_answer:"",explanation:"",toeic_part:Je.number,passage_context:Ke(s)};Pe(e=>[...e,t]),$e(!1),Ne(ke.length),ve(!0),r.success(`Question ${s} added - ready to edit!`)},className:"border-[#E8D5A3] text-[#5D4E37]",children:[n.jsx(_,{className:"w-4 h-4 mr-1"}),"Add"]}),n.jsxs(d,{variant:"outline",size:"sm",onClick:async()=>{var e;const s=ke.filter(e=>e.correct_answer);if(0!==s.length){console.log(`ðŸ§  Generating explanations for ${s.length} questions...`),be(!0);try{const t=10,a=[];for(let n=0;n<s.length;n+=t){const i=s.slice(n,n+t),l=Math.floor(n/t)+1,o=Math.ceil(s.length/t);console.log(`ðŸ“¦ Processing batch ${l}/${o} (${i.length} questions)`),o>1&&r.info(`Processing batch ${l}/${o}...`);const{data:c,error:d}=await $.functions.invoke("toeic-generate-explanations",{body:{questions:i.map(e=>{var s;return{question_number:e.question_number,question_text:e.question_text,options:e.options,correct_answer:e.correct_answer,passage_context:null==(s=e.passage_context)?void 0:s.substring(0,200),part:Je.number}}),testType:"TOEIC Reading",part:Je.number}});if(d)throw console.error(`âŒ Batch ${l} error:`,d),d;if(!(null==c?void 0:c.success))throw console.error(`âŒ Batch ${l} failed:`,null==c?void 0:c.error),new Error((null==c?void 0:c.error)||"Failed to generate explanations");console.log(`âœ… Batch ${l} complete: ${(null==(e=c.explanations)?void 0:e.length)||0} explanations`),a.push(...c.explanations||[])}if(a.length>0){let e=0;Pe(s=>s.map(s=>{if(s.correct_answer&&e<a.length){let t=a[e];return e++,"object"==typeof t&&null!==t&&(t=t.text||t.content||t.explanation||JSON.stringify(t)),{...s,ai_explanation:String(t)}}return s})),$e(!1),r.success(`Generated ${a.length} AI explanations!`)}else r.error("No explanations returned. Please try again.")}catch(t){console.error("Error generating explanations:",t),r.error("Failed to generate AI explanations. Check console for details.")}finally{be(!1)}}else r.error("Please set correct answers first before generating explanations")},disabled:pe||0===ke.filter(e=>e.correct_answer).length,className:"border-[#E8D5A3] text-[#5D4E37]",children:[n.jsx(A,{className:"w-4 h-4 mr-1"}),pe?"Generating...":"AI Explain"]}),ke.some(e=>e.ai_explanation)&&n.jsxs(d,{variant:"outline",size:"sm",onClick:async()=>{if(!ae)return;const e=ke.filter(e=>e.ai_explanation);if(0!==e.length){he(!0);try{const{data:s,error:t}=await $.functions.invoke("save-reading-test",{body:{mode:"toeic",testId:ae,part:Je.number,questions:ke.map(e=>({question_number:e.question_number,question_text:e.question_text,question_type:e.question_type,options:e.options,correct_answer:e.correct_answer,explanation:e.explanation,ai_explanation:e.ai_explanation,passage_context:e.passage_context,related_passage_id:e.related_passage_id})),passages:Fe.map(e=>({type:e.type,title:e.title,content:e.content,imageUrl:e.imageUrl,questionStart:e.questionStart,questionEnd:e.questionEnd}))}});if(t)throw t;if(!(null==s?void 0:s.success))throw new Error((null==s?void 0:s.error)||"Failed to save explanations");$e(!0),r.success(`Saved ${e.length} explanations!`)}catch(s){console.error("Error saving explanations:",s),r.error("Failed to save explanations")}finally{he(!1)}}else r.error("No explanations to save")},disabled:me,className:"border-green-300 text-green-700 hover:bg-green-50",children:[n.jsx(T,{className:"w-4 h-4 mr-1"}),me?"Saving...":"Save Explanations"]})]})]})}),n.jsx(o,{children:ke.length>0?je?n.jsxs("div",{className:"bg-white rounded-xl shadow-md border border-[#E8D5A3] overflow-hidden",children:[n.jsxs("div",{className:"bg-[#5D4E37] px-6 py-3 flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(d,{variant:"ghost",size:"icon",onClick:()=>Ne(Math.max(0,we-1)),disabled:0===we,className:"text-white/80 hover:text-white hover:bg-white/20 disabled:opacity-30",children:n.jsx(D,{className:"w-5 h-5"})}),n.jsxs(i,{className:"bg-[#A68B5B] text-white px-4 py-1.5 font-semibold",children:["Q",null==(G=ke[we])?void 0:G.question_number]}),n.jsxs("span",{className:"text-white/80 text-sm",children:[we+1," of ",ke.length]}),n.jsx(d,{variant:"ghost",size:"icon",onClick:()=>Ne(Math.min(ke.length-1,we+1)),disabled:we>=ke.length-1,className:"text-white/80 hover:text-white hover:bg-white/20 disabled:opacity-30",children:n.jsx(C,{className:"w-5 h-5"})})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs(d,{variant:"ghost",size:"sm",onClick:()=>{Ye(we)},className:"text-red-300 hover:text-red-100 hover:bg-red-500/20",children:[n.jsx(M,{className:"w-4 h-4 mr-1"}),"Delete"]})})]}),n.jsxs("div",{className:"p-6 bg-[#FEF9E7]",children:[n.jsxs("div",{className:"mb-6",children:[n.jsx(p,{className:"text-xs text-[#8B6914] uppercase tracking-wide mb-2 block",children:"Question Text"}),n.jsx(j,{value:(null==(K=ke[we])?void 0:K.question_text)||"",onChange:e=>Xe(we,"question_text",e.target.value),className:"text-lg text-[#5D4E37] bg-white border border-[#E8D5A3] min-h-[80px] placeholder:text-gray-400",placeholder:"Enter question text..."})]}),n.jsxs("div",{className:"space-y-3 mb-6",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(p,{className:"text-xs text-[#8B6914] uppercase tracking-wide",children:["Options ",Qe?"(Locked)":"(click to set correct)"]}),Qe&&(null==(W=ke[we])?void 0:W.correct_answer)&&n.jsx(d,{variant:"outline",size:"sm",onClick:()=>Te(!1),className:"text-xs border-amber-400 text-amber-600 hover:bg-amber-50",children:"ðŸ”“ Modify Answer"})]}),((null==(H=ke[we])?void 0:H.options)||["","","",""]).map((e,s)=>{var t;const a=String.fromCharCode(65+s),r=(null==(t=ke[we])?void 0:t.correct_answer)===a;return n.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg border-2 ${r?"border-green-400 bg-green-50":"border-gray-200 bg-white"} ${Qe?"opacity-90":""}`,children:[n.jsx("button",{onClick:()=>!Qe&&Xe(we,"correct_answer",a),disabled:Qe,className:"w-10 h-10 rounded-full font-bold transition-all "+(r?"bg-green-500 text-white scale-110":Qe?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-gray-100 text-[#5D4E37] hover:bg-[#A68B5B] hover:text-white"),children:a}),n.jsx(b,{value:e,onChange:e=>{var t;const a=[...(null==(t=ke[we])?void 0:t.options)||["","","",""]];a[s]=e.target.value,Xe(we,"options",a)},disabled:Qe,className:"flex-1 border border-gray-200 bg-white text-[#5D4E37] placeholder:text-gray-400 "+(Qe?"bg-gray-50":""),placeholder:`Option ${a}...`}),r&&n.jsx(u,{className:"w-5 h-5 text-green-500"})]},s)})]}),!(null==(X=ke[we])?void 0:X.correct_answer)&&!Qe&&n.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 text-sm flex items-center gap-2",children:[n.jsx(Q,{className:"w-4 h-4"}),"Click a letter to set the correct answer"]}),Qe&&(null==(Y=ke[we])?void 0:Y.correct_answer)&&n.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm flex items-center gap-2",children:[n.jsx(u,{className:"w-4 h-4"}),"Answer locked: ",null==(Z=ke[we])?void 0:Z.correct_answer,'. Click "Modify Answer" to change.']}),n.jsxs("div",{className:"space-y-2 pt-4 border-t border-[#E8D5A3]",children:[n.jsxs(p,{className:"text-xs text-[#8B6914] uppercase tracking-wide flex items-center gap-2",children:[n.jsx(A,{className:"w-3 h-3"}),"AI Explanation"]}),n.jsx(j,{value:(null==(ee=ke[we])?void 0:ee.ai_explanation)||"",onChange:e=>Xe(we,"ai_explanation",e.target.value),placeholder:"Click 'AI Explain' button above to generate explanation, or type manually...",rows:3,className:"text-sm bg-white border border-[#E8D5A3] text-[#5D4E37] placeholder:text-gray-400"}),(null==(se=ke[we])?void 0:se.ai_explanation)&&n.jsxs("p",{className:"text-xs text-green-600 flex items-center gap-1",children:[n.jsx(u,{className:"w-3 h-3"})," Explanation saved"]})]})]}),n.jsxs("div",{className:"bg-[#FEF9E7] px-6 py-3 border-t border-[#E8D5A3] flex items-center justify-center gap-2",children:[n.jsx("span",{className:"text-sm text-[#8B6914]",children:"Jump to:"}),n.jsxs(v,{value:String(we),onValueChange:e=>Ne(Number(e)),children:[n.jsx(w,{className:"w-32 h-8 bg-white border-[#E8D5A3]",children:n.jsx(N,{})}),n.jsx(f,{children:ke.map((e,s)=>n.jsxs(E,{value:String(s),children:["Q",e.question_number," ",e.correct_answer?"âœ“":"?"]},s))})]})]}),n.jsxs("div",{className:"bg-white border-t border-[#E8D5A3] px-6 py-4 space-y-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("h4",{className:"text-sm font-semibold text-[#5D4E37]",children:"Answer Sheet"}),n.jsxs(i,{className:"bg-[#A68B5B] text-white",children:[ke.filter(e=>e.correct_answer).length," / ",ke.length," answered"]}),Qe&&n.jsx(i,{className:"bg-green-600 text-white",children:"ðŸ”’ Locked"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[Qe?n.jsx(d,{onClick:()=>Te(!1),size:"sm",variant:"outline",className:"border-amber-400 text-amber-600 hover:bg-amber-50",children:"ðŸ”“ Modify Answers"}):n.jsx(d,{onClick:()=>Te(!0),size:"sm",variant:"outline",className:"border-green-400 text-green-600 hover:bg-green-50",disabled:0===ke.filter(e=>e.correct_answer).length,children:"ðŸ”’ Lock Answers"}),n.jsx(d,{onClick:Ze,disabled:me||Ie||0===ke.length,size:"sm",className:"bg-[#A68B5B] hover:bg-[#8B6914] text-white",children:me?"Saving...":Ie?"Saved âœ“":"Save Answers"})]})]}),0===ke.length?n.jsx("p",{className:"text-sm text-[#8B6914]",children:"No questions yet."}):n.jsx("div",{className:"grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4",children:ke.map((e,s)=>n.jsxs("div",{className:"rounded-md border px-3 py-2 text-sm space-y-2 "+(e.correct_answer?"border-green-200 bg-green-50 text-green-700":"border-amber-200 bg-amber-50 text-amber-700"),children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("span",{className:"font-semibold",children:["Q",e.question_number]}),n.jsx(i,{variant:"outline",className:"border-[#E8D5A3] text-[#5D4E37] bg-white",children:e.correct_answer||"?"})]}),n.jsx("div",{className:"flex items-center gap-2",children:["A","B","C","D"].map(t=>{const a=e.correct_answer===t;return n.jsx(d,{type:"button",size:"sm",variant:a?"default":"outline",className:a?"bg-green-600 text-white":Qe?"border-gray-200 text-gray-400 cursor-not-allowed":"border-[#E8D5A3] text-[#5D4E37]",onClick:()=>!Qe&&Xe(s,"correct_answer",t),disabled:Qe,children:t},t)})})]},e.question_number))})]})]}):"grid"===fe?n.jsx("div",{className:"grid gap-3 max-h-[600px] overflow-y-auto",style:{gridTemplateColumns:`repeat(${_e}, minmax(0, 1fr))`},children:ke.map((e,s)=>n.jsxs("div",{onClick:()=>{Ne(s),ve(!0)},className:"p-3 rounded-lg border-2 cursor-pointer hover:shadow-md transition-all "+(e.correct_answer?"border-green-300 bg-green-50":"border-amber-300 bg-amber-50"),children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs(i,{className:(e.correct_answer?"bg-green-500":"bg-amber-500")+" text-white text-xs",children:["Q",e.question_number]}),e.correct_answer?n.jsx(i,{className:"bg-green-600 text-white text-xs",children:e.correct_answer}):n.jsx(i,{variant:"outline",className:"border-amber-400 text-amber-600 text-xs",children:"?"})]}),n.jsx("p",{className:"text-xs text-gray-700 line-clamp-2",children:e.question_text||"No text"})]},s))}):n.jsx("div",{className:"space-y-3 max-h-[600px] overflow-y-auto",children:ke.map((e,s)=>n.jsx(l,{className:"border border-[#E8D5A3] bg-white",children:n.jsxs(o,{className:"p-4",children:[n.jsxs("div",{className:"flex items-start justify-between mb-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs(i,{variant:"outline",className:"border-[#E8D5A3]",children:["Q",e.question_number]}),e.correct_answer?n.jsxs(i,{className:"bg-green-500 text-white",children:["Answer: ",e.correct_answer]}):n.jsx(i,{variant:"outline",className:"border-amber-400 text-amber-600",children:"No answer"})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{Ne(s),ve(!0)},children:n.jsx(q,{className:"w-4 h-4 text-[#8B6914]"})}),n.jsx(d,{variant:"ghost",size:"sm",onClick:()=>Ye(s),children:n.jsx(M,{className:"w-4 h-4 text-red-500"})})]})]}),n.jsx("p",{className:"text-sm text-[#5D4E37] line-clamp-2",children:e.question_text||"No question text"}),e.options&&n.jsx("div",{className:"flex gap-2 mt-2",children:e.options.map((s,t)=>n.jsxs("span",{className:"text-xs px-2 py-1 rounded "+(e.correct_answer===String.fromCharCode(65+t)?"bg-green-100 text-green-700":"bg-gray-100"),children:["(",String.fromCharCode(65+t),") ",s.slice(0,20),s.length>20?"...":""]},t))})]})},s))}):n.jsxs("div",{className:"text-center py-12 text-[#8B6914]",children:[n.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),n.jsx("p",{children:"No questions added yet."}),n.jsx("p",{className:"text-sm",children:"Use the methods above to add questions."})]})})]})]})})};export{G as default};
