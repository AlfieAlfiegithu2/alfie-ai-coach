import{u as e,w as s,r as a,J as l,j as t,av as r,D as i,v as n,B as c,P as d,m as o,n as m,o as h,bp as x,R as u,X as p,I as j,T as g,S as f,p as v,q as N,s as b,t as w,C as y,cf as C,b as k,a as S,l as T,N as F,E as _,d as U,y as L}from"./index-BG8T8mQJ.js";import{S as P}from"./switch-S3fKVrd9.js";import{A,a as z,b as B,c as G,d as $,e as D,f as E,g as I,h as R}from"./alert-dialog-CjZ1L7D9.js";import{A as O}from"./AdminLayout-I8js-wn1.js";import{s as q}from"./supabase-DLB9cOux.js";import{U as W}from"./upload-DVXEIS_6.js";import{S as H}from"./search-cBST7AZc.js";import{F as J}from"./filter-VQ861hvz.js";import{I as M}from"./image-CZjBpvhu.js";import{T as V}from"./trash-2-BTapwe_F.js";const K=[{value:"writing-task1",label:"Writing Task 1 (Charts/Graphs)"},{value:"writing-task2",label:"Writing Task 2 (Essays)"},{value:"speaking",label:"Speaking"},{value:"reading",label:"Reading"},{value:"listening",label:"Listening"},{value:"general",label:"General"}],Z=()=>{const Z=e(),{admin:Q,loading:X}=s(),Y=a.useRef(null),[ee,se]=a.useState([]),[ae,le]=a.useState(!0),[te,re]=a.useState(""),[ie,ne]=a.useState("all"),[ce,de]=a.useState(!1),[oe,me]=a.useState(!1),[he,xe]=a.useState(null),[ue,pe]=a.useState(null),[je,ge]=a.useState(""),[fe,ve]=a.useState(""),[Ne,be]=a.useState("general"),[we,ye]=a.useState(""),[Ce,ke]=a.useState(!0),[Se,Te]=a.useState(null);a.useEffect(()=>{X||Q?Q&&Fe():Z("/admin/login")},[Q,X,Z]);const Fe=async()=>{le(!0);try{const{data:e,error:s}=await q.from("templates").select("*").order("created_at",{ascending:!1});if(s)throw s;se(e||[])}catch(e){console.error("Error loading templates:",e),l.error("Failed to load templates")}finally{le(!1)}},_e=()=>{xe(null),pe(null),ge(""),ve(""),be("general"),ye(""),ke(!0),Y.current&&(Y.current.value="")},Ue=e=>{var s;return(null==(s=K.find(s=>s.value===e))?void 0:s.label)||e},Le=ee.filter(e=>{var s;const a=e.title.toLowerCase().includes(te.toLowerCase())||(null==(s=e.description)?void 0:s.toLowerCase().includes(te.toLowerCase()))||e.tags.some(e=>e.includes(te.toLowerCase())),l="all"===ie||e.category===ie;return a&&l});return X?t.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:t.jsx(r,{className:"w-8 h-8 animate-spin"})}):Q?t.jsx(O,{title:"Templates",showBackButton:!0,backPath:"/admin/ielts",children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent",children:"Templates"}),t.jsx("p",{className:"text-muted-foreground",children:"Upload and manage template images for students"})]}),t.jsxs(i,{open:ce,onOpenChange:de,children:[t.jsx(n,{asChild:!0,children:t.jsxs(c,{children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"Upload Template"]})}),t.jsxs(o,{className:"sm:max-w-lg",children:[t.jsxs(m,{children:[t.jsx(h,{children:"Upload New Template"}),t.jsx(x,{children:"Upload an image to the templates library. Images are stored on Cloudflare for fast global delivery."})]}),t.jsxs("div",{className:"space-y-4 py-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{children:"Image *"}),t.jsx("input",{ref:Y,type:"file",accept:"image/*",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(a){if(!a.type.startsWith("image/"))return void l.error("Please select an image file");if(a.size>10485760)return void l.error("Image must be less than 10MB");xe(a),pe(URL.createObjectURL(a))}},className:"hidden"}),ue?t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:ue,alt:"Preview",className:"w-full h-48 object-contain rounded-lg border bg-muted"}),t.jsx(c,{size:"sm",variant:"secondary",className:"absolute top-2 right-2",onClick:()=>{xe(null),pe(null)},children:t.jsx(p,{className:"w-4 h-4"})})]}):t.jsxs("div",{className:"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>{var e;return null==(e=Y.current)?void 0:e.click()},children:[t.jsx(W,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to upload image"}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"PNG, JPG, GIF up to 10MB"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"title",children:"Title *"}),t.jsx(j,{id:"title",placeholder:"e.g., Line Graph - Population Growth",value:je,onChange:e=>ge(e.target.value)})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"description",children:"Description"}),t.jsx(g,{id:"description",placeholder:"Brief description of the template...",value:fe,onChange:e=>ve(e.target.value),rows:2})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{children:"Category"}),t.jsxs(f,{value:Ne,onValueChange:be,children:[t.jsx(v,{children:t.jsx(N,{})}),t.jsx(b,{children:K.map(e=>t.jsx(w,{value:e.value,children:e.label},e.value))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"tags",children:"Tags (comma-separated)"}),t.jsx(j,{id:"tags",placeholder:"e.g., chart, graph, statistics",value:we,onChange:e=>ye(e.target.value)})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(u,{htmlFor:"published",children:"Publish immediately"}),t.jsx(P,{id:"published",checked:Ce,onCheckedChange:ke})]})]}),t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx(c,{variant:"outline",onClick:()=>{_e(),de(!1)},children:"Cancel"}),t.jsx(c,{onClick:async()=>{if(he&&je.trim()){me(!0);try{const e=await(async e=>{var s;const{data:a}=await q.auth.getSession(),l=`templates/${Date.now()}-${e.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,t=new FormData;t.append("file",e),t.append("path",l),t.append("contentType",e.type);const r=await fetch("https://cuumxmfzhwljylbdlflj.supabase.co/functions/v1/r2-upload",{method:"POST",headers:{Authorization:`Bearer ${null==(s=null==a?void 0:a.session)?void 0:s.access_token}`},body:t});if(!r.ok){const e=await r.json();throw new Error(e.error||"Failed to upload image")}return(await r.json()).url})(he),s=we.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0),{error:a}=await q.from("templates").insert({title:je.trim(),description:fe.trim()||null,category:Ne,image_url:e,tags:s,is_published:Ce});if(a)throw a;l.success("Template uploaded successfully!"),_e(),de(!1),Fe()}catch(e){console.error("Error uploading template:",e),l.error(`Upload failed: ${e.message}`)}finally{me(!1)}}else l.error("Please provide a title and select an image")},disabled:oe||!he||!je.trim(),children:oe?t.jsxs(t.Fragment,{children:[t.jsx(r,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):t.jsxs(t.Fragment,{children:[t.jsx(W,{className:"w-4 h-4 mr-2"}),"Upload"]})})]})]})]})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(H,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),t.jsx(j,{placeholder:"Search templates...",value:te,onChange:e=>re(e.target.value),className:"pl-10"})]}),t.jsxs(f,{value:ie,onValueChange:ne,children:[t.jsxs(v,{className:"w-full sm:w-[200px]",children:[t.jsx(J,{className:"w-4 h-4 mr-2"}),t.jsx(N,{placeholder:"Filter by category"})]}),t.jsxs(b,{children:[t.jsx(w,{value:"all",children:"All Categories"}),K.map(e=>t.jsx(w,{value:e.value,children:e.label},e.value))]})]})]}),t.jsxs("div",{className:"flex gap-4 text-sm text-muted-foreground",children:[t.jsxs("span",{children:[ee.length," total templates"]}),t.jsx("span",{children:"•"}),t.jsxs("span",{children:[ee.filter(e=>e.is_published).length," published"]}),t.jsx("span",{children:"•"}),t.jsxs("span",{children:[Le.length," showing"]})]}),ae?t.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[...Array(8)].map((e,s)=>t.jsxs(y,{className:"overflow-hidden",children:[t.jsx(C,{className:"h-40 w-full"}),t.jsx(k,{className:"pb-2",children:t.jsx(C,{className:"h-5 w-3/4"})}),t.jsx(S,{children:t.jsx(C,{className:"h-4 w-1/2"})})]},s))}):0===Le.length?t.jsx(y,{children:t.jsxs(S,{className:"py-16 text-center",children:[t.jsx(M,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground/50"}),te||"all"!==ie?t.jsxs(t.Fragment,{children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No templates found"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:"Try adjusting your search or filters"}),t.jsx(c,{variant:"outline",onClick:()=>{re(""),ne("all")},children:"Clear filters"})]}):t.jsxs(t.Fragment,{children:[t.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No templates yet"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:"Upload your first template to get started"}),t.jsxs(c,{onClick:()=>de(!0),children:[t.jsx(d,{className:"w-4 h-4 mr-2"}),"Upload Template"]})]})]})}):t.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:Le.map(e=>t.jsxs(y,{className:"overflow-hidden group",children:[t.jsxs("div",{className:"h-40 bg-muted relative cursor-pointer overflow-hidden",onClick:()=>Te(e),children:[t.jsx("img",{src:e.image_url,alt:e.title,className:"w-full h-full object-contain group-hover:scale-105 transition-transform duration-300"}),!e.is_published&&t.jsxs(T,{variant:"secondary",className:"absolute top-2 left-2",children:[t.jsx(F,{className:"w-3 h-3 mr-1"}),"Hidden"]}),t.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center",children:t.jsx(_,{className:"w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]}),t.jsxs(k,{className:"pb-2",children:[t.jsx(U,{className:"text-sm line-clamp-1",children:e.title}),t.jsx(L,{className:"text-xs",children:Ue(e.category)})]}),t.jsxs(S,{className:"space-y-3",children:[e.tags.length>0&&t.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.tags.slice(0,3).map(e=>t.jsx(T,{variant:"outline",className:"text-xs",children:e},e)),e.tags.length>3&&t.jsxs(T,{variant:"outline",className:"text-xs",children:["+",e.tags.length-3]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(c,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>(async e=>{try{const{error:s}=await q.from("templates").update({is_published:!e.is_published}).eq("id",e.id);if(s)throw s;l.success(e.is_published?"Template hidden":"Template published"),Fe()}catch(s){l.error(`Failed to update: ${s.message}`)}})(e),children:e.is_published?t.jsxs(t.Fragment,{children:[t.jsx(F,{className:"w-3 h-3 mr-1"}),"Hide"]}):t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"w-3 h-3 mr-1"}),"Publish"]})}),t.jsxs(A,{children:[t.jsx(z,{asChild:!0,children:t.jsx(c,{size:"sm",variant:"ghost",children:t.jsx(V,{className:"w-4 h-4 text-red-500"})})}),t.jsxs(B,{children:[t.jsxs(G,{children:[t.jsx($,{children:"Delete Template"}),t.jsxs(D,{children:['Are you sure you want to delete "',e.title,'"? This action cannot be undone.']})]}),t.jsxs(E,{children:[t.jsx(I,{children:"Cancel"}),t.jsx(R,{onClick:()=>(async e=>{try{const{error:s}=await q.from("templates").delete().eq("id",e);if(s)throw s;l.success("Template deleted"),Fe()}catch(s){l.error(`Failed to delete: ${s.message}`)}})(e.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]},e.id))}),t.jsx(i,{open:!!Se,onOpenChange:()=>Te(null),children:t.jsx(o,{className:"sm:max-w-3xl",children:Se&&t.jsxs(t.Fragment,{children:[t.jsxs(m,{children:[t.jsx(h,{children:Se.title}),t.jsxs(x,{children:[Ue(Se.category),Se.description&&` • ${Se.description}`]})]}),t.jsx("div",{className:"py-4",children:t.jsx("img",{src:Se.image_url,alt:Se.title,className:"w-full max-h-[70vh] object-contain rounded-lg"})}),Se.tags.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:Se.tags.map(e=>t.jsx(T,{variant:"secondary",children:e},e))})]})})})]})}):null};export{Z as default};
