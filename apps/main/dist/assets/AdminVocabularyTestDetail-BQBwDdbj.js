import{r as e,j as t,c as r}from"./vendor-react-JN_hy__U.js";import{A as n}from"./AdminLayout-D3lPYw5Y.js";import{C as s,b as i,c as o,a,B as c,J as l,s as d,D as u,f as h,g as m,h as p,L as f,I as w,T as g}from"./index-DXpPY1B7.js";import{S as x}from"./separator-Bv0Pudil.js";import{A as v,a as _}from"./alert-BV1wokst.js";import{V as j}from"./VocabularyQuizPreview-DUT6ZHr6.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-ui-DG51EGkO.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const y=["QuestionFormat","WordOrSentence","CorrectAnswer","IncorrectAnswer1","IncorrectAnswer2","IncorrectAnswer3","Explanation"];function b(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const t=e.slice(0,180),r=Math.max(t.lastIndexOf("."),t.lastIndexOf(","),t.lastIndexOf(";"),t.lastIndexOf(":"));return(r>60?t.slice(0,r):t).trim()}function k(e){const t=[];let r="",n=!1;for(let s=0;s<e.length;s++){const i=e[s];'"'===i?n&&'"'===e[s+1]?(r+='"',s++):n=!n:","!==i||n?r+=i:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function I(e){return/^[A-Za-z][A-Za-z\-']*$/.test(e.trim())}function S(e){const t=e.toLowerCase();return/ly$/.test(t)?"adverb":/(tion|ment|ness|ity|ance|ence|ship|ism)$/.test(t)?"noun":/(ous|ive|able|ible|al|ic|ical|ary|ory)$/.test(t)?"adjective":"verb"}const q={verb:["mitigate","undermine","amplify","circumvent","invalidate","corroborate","repudiate"],noun:["anomaly","paradigm","tenet","conjecture","impetus","nuance","rebuttal"],adjective:["pervasive","tentative","redundant","spurious","intrinsic","ambiguous","salient"],adverb:["ostensibly","tangentially","inadvertently","inherently","predominantly","marginally"]};function A(e,t){const r=q[e]||q.verb;for(const s of r)if(!t.has(s))return s;let n=1;for(;t.has(`option${n}`);)n++;return`option${n}`}const N=["A temporary or short-lived occurrence","An idea that lacks practical application","Something rare or infrequently encountered","A minor detail with little significance","A device used to measure performance"];function $(e,t){for(const n of N)if(!t.has(n)&&n.toLowerCase()!==e.toLowerCase())return n;let r=1;for(;t.has(`Unrelated definition ${r}`);)r++;return`Unrelated definition ${r}`}function F(e,t,r){const n=[],s=[],i=[];let o=(e||"").replace(/^\uFEFF/,"");o=function(e){return e.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'")}(o),o=function(e){const t=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",r=(t.match(/,/g)||[]).length;return(t.match(/;/g)||[]).length>0&&0===r?e.replace(/;/g,","):e}(o);const a=o.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===a.length)return{ok:!1,skill_type:t,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${y.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const c=k(a[0]).map(e=>e.replace(/^"|"$/g,"").trim()),l={};c.forEach((e,t)=>l[e]=t);const d=y.filter(e=>void 0===l[e]);if(d.length>0)return{ok:!1,skill_type:t,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${d.join("; ")}. Expected: ${y.join(",")}`,raw:Object.fromEntries(c.map((e,t)=>[t.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=a.slice(1);u.forEach((e,o)=>{const a=o+1,c=k(e),d=e=>b(function(e){return e.replace(/<[^>]*>/g,"")}(c[l[e]]||""));let u=d("QuestionFormat");const h=C(d("WordOrSentence"));let m=C(d("CorrectAnswer")),p=C(d("IncorrectAnswer1")),f=C(d("IncorrectAnswer2")),w=C(d("IncorrectAnswer3")),g=C(d("Explanation"));const x={QuestionFormat:u,WordOrSentence:h,CorrectAnswer:m,IncorrectAnswer1:p,IncorrectAnswer2:f,IncorrectAnswer3:w,Explanation:g};if(!u||!h||!m)return void s.push({row:a,message:"Missing critical fields",raw:x});if("DefinitionMatch"!==u&&"SentenceFillIn"!==u){const e=function(e){const t=e.replace(/[^a-z]/gi,"").toLowerCase();return["definitionmatch","definitionmatching","defmatch"].includes(t)?"DefinitionMatch":["sentencefillin","sentencefill","fillintheblank"].includes(t)?"SentenceFillIn":null}(u);if(!e)return void s.push({row:a,message:`Unrecognized QuestionFormat: ${u}`,raw:x});n.push({row:a,message:`Corrected QuestionFormat to ${e}`}),u=e}let v=h,_=m,j=[p,f,w].filter(e=>null!=e);if("DefinitionMatch"===u){if(!I(v)){const e=v.split(/[^A-Za-z\-']/).filter(Boolean)[0]||v.split(" ")[0];e&&I(e)?(n.push({row:a,message:`Extracted headword '${e}' from phrase`}),v=e):n.push({row:a,message:"Content appears to be a phrase; accepted as-is"})}const e=new Set([_.toLowerCase(),...j.map(e=>e.toLowerCase())]);j=j.map(e=>e||"");for(let t=0;t<j.length;t++){let r=j[t];if(!r||r.length<2){const r=$(_,e);j[t]=r,e.add(r.toLowerCase()),n.push({row:a,message:"Replaced trivial/empty distractor with plausible definition"})}}}else if("SentenceFillIn"===u){const e=function(e,t,r){const n=(e.match(/_+/g)||[]).filter(e=>e.length>=2);if(n.length>1)return{content:e,error:"Multiple blanks detected"};if(0===n.length){const n=new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i");if(n.test(e))return r.push("Inserted blank by replacing the correct answer occurrence"),{content:e.replace(n,"_______")};const s=Math.max(e.lastIndexOf(" "),0);return r.push("Inserted a blank at a natural position"),{content:e.slice(0,s)+" _______"+e.slice(s)}}return{content:e.replace(/_+/g,"_______")}}(v,_,[]);if(e.error)return void s.push({row:a,message:e.error,raw:x});if(v=e.content,!I(_)){const e=_.split(/[^A-Za-z\-']/).filter(Boolean)[0]||_.split(" ")[0];if(!e||!I(e))return void s.push({row:a,message:"CorrectAnswer must be a single word",raw:x});n.push({row:a,message:`Reduced correct answer to headword '${e}'`}),_=e}const t=S(_);let r=j.map(e=>I(e)?e:"");const i=new Set([_.toLowerCase(),...r.map(e=>e.toLowerCase()).filter(Boolean)]);for(let s=0;s<r.length;s++)if(!r[s]){const e=A(t,i);r[s]=e,i.add(e.toLowerCase()),n.push({row:a,message:"Replaced non-word distractor with POS-matched alternative"})}j=r}const y=[_,...j].map(e=>b(e)),q=new Set;let N=y.filter(e=>{const t=e.toLowerCase();return!q.has(t)&&(q.add(t),!0)});if(N.length<4){const e=new Set(N.map(e=>e.toLowerCase())),t=4-N.length;for(let r=0;r<t;r++){if("SentenceFillIn"===u){const t=A(S(_),e);N.push(t),e.add(t.toLowerCase())}else{const t=$(_,e);N.push(t),e.add(t.toLowerCase())}n.push({row:a,message:"Added synthesized distractor to ensure 4 unique options"})}}const F=N[0],L=N.slice(1,4);i.push({skill_type:t,skill_test_id:r,question_format:u,content:C(v),correct_answer:C(F),incorrect_answers:L.map(C),explanation:C(g||"")})});const h=new Set(n.map(e=>e.row)).size;return{ok:i.length>0,skill_type:t,skill_test_id:r,insert:i,warnings:n,errors:s,summary:{rows_received:u.length,rows_valid:i.length,rows_with_warnings:h,rows_with_errors:s.length}}}function L({skillTestId:r,onImported:n}){const[u,h]=e.useState(null),[m,p]=e.useState([]),[f,w]=e.useState(null),[g,x]=e.useState(!1),j=e.useRef(null);return t.jsxs(s,{children:[t.jsx(i,{children:t.jsx(o,{className:"text-base",children:"Upload Vocabulary CSV"})}),t.jsxs(a,{className:"space-y-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{ref:j,type:"file",accept:".csv",className:"hidden",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];n&&(async t=>{var n;try{h(null),p([]),w(null);const e=F(await t.text(),"Vocabulary Builder",r);if(w(e),0===e.insert.length){const t=(null==(n=e.errors[0])?void 0:n.message)||"No valid rows found in CSV";return void h(t)}e.errors.length>0&&l.warning(`${e.errors.length} row(s) have errors and will be skipped`),e.warnings.length>0&&l.message(`${e.warnings.length} warning(s) during normalization`),p(e.insert)}catch(e){h(e.message||"Failed to parse CSV")}})(n)}}),t.jsx(c,{onClick:()=>{var e;return null==(e=j.current)?void 0:e.click()},children:"Choose CSV"}),t.jsx(c,{variant:"secondary",onClick:()=>{const e=['DefinitionMatch,"Ubiquitous","Present, appearing, or found everywhere","Rare","Obscure","Fleeting","Used to describe something that is found everywhere; e.g., smartphones are ubiquitous."','SentenceFillIn,"The new evidence will _______ the detective\'s theory.","corroborate","refute","ignore","confuse","Corroborate means to confirm or support; the evidence supports the theory."'].join("\n"),t=new Blob(["QuestionFormat,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="vocabulary-smart-template.csv",n.click(),URL.revokeObjectURL(r)},children:"Download Template"})]}),u&&t.jsx(v,{variant:"destructive",children:t.jsx(_,{children:u})}),m.length>0&&t.jsxs("div",{className:"space-y-2",children:[f&&t.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",m.length," valid row(s)",f.warnings.length>0&&` • ${f.warnings.length} warning(s)`,f.errors.length>0&&` • ${f.errors.length} error row(s) skipped`]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(c,{onClick:async()=>{if(f&&0!==f.insert.length){x(!0);try{const{error:e}=await d.from("skill_practice_questions").insert(f.insert);if(e)throw e;l.success(`Imported ${f.insert.length} questions`),p([]),w(null),null==n||n()}catch(e){console.error(e),l.error(e.message||"Import failed")}finally{x(!1)}}},disabled:g,children:g?"Importing...":"Import"}),t.jsx(c,{variant:"secondary",onClick:()=>{p([]),w(null)},children:"Cancel"})]}),t.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[m.slice(0,10).map((e,r)=>t.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[t.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),t.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},r)),m.length>10&&t.jsxs("div",{className:"text-muted-foreground",children:["...and ",m.length-10," more"]})]})]})]})]})}const E=()=>{const{id:l}=r(),[v,_]=e.useState(null),[y,b]=e.useState([]),[C,k]=e.useState(null),[I,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:""}),[q,A]=e.useState(null),N=e.useRef(null),$=async()=>{if(!l)return;const{data:e}=await d.from("skill_tests").select("id,title").eq("id",l).maybeSingle();_(e??null);const{data:t}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",l).order("created_at",{ascending:!1});b(t??[])};return e.useEffect(()=>{$()},[l]),t.jsxs(n,{title:v?`Manage: ${v.title}`:"Manage Vocabulary Test",showBackButton:!0,children:[t.jsxs("section",{className:"space-y-6",children:[l&&t.jsx(L,{skillTestId:l,onImported:$}),t.jsx(x,{}),t.jsx("div",{ref:N,children:t.jsxs(s,{children:[t.jsx(i,{children:t.jsx(o,{className:"text-base",children:"Student Preview"})}),t.jsx(a,{children:t.jsx(j,{questions:y,selectedQuestionId:q||void 0})})]})}),t.jsxs(s,{children:[t.jsx(i,{children:t.jsx(o,{className:"text-base",children:"Questions"})}),t.jsx(a,{className:"space-y-3",children:0===y.length?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):y.map(e=>t.jsx("div",{className:"p-3 border rounded-md space-y-2",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{onClick:()=>{return t=e.id,A(t),void requestAnimationFrame(()=>{var e;null==(e=N.current)||e.scrollIntoView({behavior:"smooth",block:"start"})});var t},className:"cursor-pointer",children:[t.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),t.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),t.jsxs("div",{className:"flex gap-2 shrink-0",children:[t.jsx(c,{size:"sm",onClick:()=>(e=>{var t,r,n;k(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(t=e.incorrect_answers)?void 0:t[0])||"",incorrect2:(null==(r=e.incorrect_answers)?void 0:r[1])||"",incorrect3:(null==(n=e.incorrect_answers)?void 0:n[2])||"",explanation:e.explanation||""})})(e),children:"Edit"}),t.jsx(c,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await d.from("skill_practice_questions").delete().eq("id",e),await $())})(e.id),children:"Delete"})]})]})},e.id))})]})]}),t.jsx(u,{open:!!C,onOpenChange:e=>{e||k(null)},children:t.jsxs(h,{className:"sm:max-w-lg",children:[t.jsx(m,{children:t.jsx(p,{children:"Edit Question"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx(f,{htmlFor:"question_format",children:"Format"}),t.jsx(w,{id:"question_format",value:I.question_format,onChange:e=>S({...I,question_format:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(f,{htmlFor:"content",children:"Content"}),t.jsx(g,{id:"content",value:I.content,onChange:e=>S({...I,content:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(f,{htmlFor:"correct_answer",children:"Correct Answer"}),t.jsx(w,{id:"correct_answer",value:I.correct_answer,onChange:e=>S({...I,correct_answer:e.target.value})})]}),t.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[t.jsxs("div",{children:[t.jsx(f,{children:"Incorrect 1"}),t.jsx(w,{value:I.incorrect1,onChange:e=>S({...I,incorrect1:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(f,{children:"Incorrect 2"}),t.jsx(w,{value:I.incorrect2,onChange:e=>S({...I,incorrect2:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(f,{children:"Incorrect 3"}),t.jsx(w,{value:I.incorrect3,onChange:e=>S({...I,incorrect3:e.target.value})})]})]}),t.jsxs("div",{children:[t.jsx(f,{htmlFor:"explanation",children:"Explanation"}),t.jsx(g,{id:"explanation",value:I.explanation,onChange:e=>S({...I,explanation:e.target.value})})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx(c,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),t.jsx(c,{onClick:async()=>{if(!C)return;const e=[I.incorrect1,I.incorrect2,I.incorrect3].filter(Boolean),{error:t}=await d.from("skill_practice_questions").update({content:I.content,question_format:I.question_format,correct_answer:I.correct_answer,incorrect_answers:e,explanation:I.explanation}).eq("id",C.id);t||(k(null),await $())},children:"Save"})]})]})})]})};export{E as default};
