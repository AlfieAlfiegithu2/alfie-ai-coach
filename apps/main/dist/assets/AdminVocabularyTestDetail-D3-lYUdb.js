import{r as e,j as t,C as r,b as n,c as s,a as i,B as a,ai as o,aj as c,ag as l,ao as d,A as u,_ as h,D as m,q as p,s as w,t as f,ap as g,I as x,G as v}from"./index-BltDaFbN.js";import{s as _}from"./supabase-rhP1-bIs.js";import{V as j}from"./VocabularyQuizPreview-CVAxfDj3.js";const y=["QuestionFormat","WordOrSentence","CorrectAnswer","IncorrectAnswer1","IncorrectAnswer2","IncorrectAnswer3","Explanation"];function b(e){return e.replace(/[\r\n]+/g," ").replace(/\s+/g," ").trim()}function C(e){if(e.length<=180)return e;const t=e.slice(0,180),r=Math.max(t.lastIndexOf("."),t.lastIndexOf(","),t.lastIndexOf(";"),t.lastIndexOf(":"));return(r>60?t.slice(0,r):t).trim()}function k(e){const t=[];let r="",n=!1;for(let s=0;s<e.length;s++){const i=e[s];'"'===i?n&&'"'===e[s+1]?(r+='"',s++):n=!n:","!==i||n?r+=i:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function I(e){return/^[A-Za-z][A-Za-z\-']*$/.test(e.trim())}function S(e){const t=e.toLowerCase();return/ly$/.test(t)?"adverb":/(tion|ment|ness|ity|ance|ence|ship|ism)$/.test(t)?"noun":/(ous|ive|able|ible|al|ic|ical|ary|ory)$/.test(t)?"adjective":"verb"}const q={verb:["mitigate","undermine","amplify","circumvent","invalidate","corroborate","repudiate"],noun:["anomaly","paradigm","tenet","conjecture","impetus","nuance","rebuttal"],adjective:["pervasive","tentative","redundant","spurious","intrinsic","ambiguous","salient"],adverb:["ostensibly","tangentially","inadvertently","inherently","predominantly","marginally"]};function A(e,t){const r=q[e]||q.verb;for(const s of r)if(!t.has(s))return s;let n=1;for(;t.has(`option${n}`);)n++;return`option${n}`}const N=["A temporary or short-lived occurrence","An idea that lacks practical application","Something rare or infrequently encountered","A minor detail with little significance","A device used to measure performance"];function $(e,t){for(const n of N)if(!t.has(n)&&n.toLowerCase()!==e.toLowerCase())return n;let r=1;for(;t.has(`Unrelated definition ${r}`);)r++;return`Unrelated definition ${r}`}function F(e,t,r){const n=[],s=[],i=[];let a=(e||"").replace(/^\uFEFF/,"");a=function(e){return e.replace(/[\u201C\u201D]/g,'"').replace(/[\u2018\u2019]/g,"'")}(a),a=function(e){const t=e.split(/\r?\n/).find(e=>e.trim().length>0)||"",r=(t.match(/,/g)||[]).length;return(t.match(/;/g)||[]).length>0&&0===r?e.replace(/;/g,","):e}(a);const o=a.split(/\r?\n/).map(e=>e.trim()).filter(e=>e.length>0);if(0===o.length)return{ok:!1,skill_type:t,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing headers. Expected: ${y.join(",")}`,raw:{}}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const c=k(o[0]).map(e=>e.replace(/^"|"$/g,"").trim()),l={};c.forEach((e,t)=>l[e]=t);const d=y.filter(e=>void 0===l[e]);if(d.length>0)return{ok:!1,skill_type:t,skill_test_id:r,insert:[],warnings:[],errors:[{row:0,message:`Missing required headers: ${d.join("; ")}. Expected: ${y.join(",")}`,raw:Object.fromEntries(c.map((e,t)=>[t.toString(),e]))}],summary:{rows_received:0,rows_valid:0,rows_with_warnings:0,rows_with_errors:0}};const u=o.slice(1);u.forEach((e,a)=>{const o=a+1,c=k(e),d=e=>b(function(e){return e.replace(/<[^>]*>/g,"")}(c[l[e]]||""));let u=d("QuestionFormat");const h=C(d("WordOrSentence"));let m=C(d("CorrectAnswer")),p=C(d("IncorrectAnswer1")),w=C(d("IncorrectAnswer2")),f=C(d("IncorrectAnswer3")),g=C(d("Explanation"));const x={QuestionFormat:u,WordOrSentence:h,CorrectAnswer:m,IncorrectAnswer1:p,IncorrectAnswer2:w,IncorrectAnswer3:f,Explanation:g};if(!u||!h||!m)return void s.push({row:o,message:"Missing critical fields",raw:x});if("DefinitionMatch"!==u&&"SentenceFillIn"!==u){const e=function(e){const t=e.replace(/[^a-z]/gi,"").toLowerCase();return["definitionmatch","definitionmatching","defmatch"].includes(t)?"DefinitionMatch":["sentencefillin","sentencefill","fillintheblank"].includes(t)?"SentenceFillIn":null}(u);if(!e)return void s.push({row:o,message:`Unrecognized QuestionFormat: ${u}`,raw:x});n.push({row:o,message:`Corrected QuestionFormat to ${e}`}),u=e}let v=h,_=m,j=[p,w,f].filter(e=>null!=e);if("DefinitionMatch"===u){if(!I(v)){const e=v.split(/[^A-Za-z\-']/).filter(Boolean)[0]||v.split(" ")[0];e&&I(e)?(n.push({row:o,message:`Extracted headword '${e}' from phrase`}),v=e):n.push({row:o,message:"Content appears to be a phrase; accepted as-is"})}const e=new Set([_.toLowerCase(),...j.map(e=>e.toLowerCase())]);j=j.map(e=>e||"");for(let t=0;t<j.length;t++){let r=j[t];if(!r||r.length<2){const r=$(_,e);j[t]=r,e.add(r.toLowerCase()),n.push({row:o,message:"Replaced trivial/empty distractor with plausible definition"})}}}else if("SentenceFillIn"===u){const e=function(e,t,r){const n=(e.match(/_+/g)||[]).filter(e=>e.length>=2);if(n.length>1)return{content:e,error:"Multiple blanks detected"};if(0===n.length){const n=new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i");if(n.test(e))return r.push("Inserted blank by replacing the correct answer occurrence"),{content:e.replace(n,"_______")};const s=Math.max(e.lastIndexOf(" "),0);return r.push("Inserted a blank at a natural position"),{content:e.slice(0,s)+" _______"+e.slice(s)}}return{content:e.replace(/_+/g,"_______")}}(v,_,[]);if(e.error)return void s.push({row:o,message:e.error,raw:x});if(v=e.content,!I(_)){const e=_.split(/[^A-Za-z\-']/).filter(Boolean)[0]||_.split(" ")[0];if(!e||!I(e))return void s.push({row:o,message:"CorrectAnswer must be a single word",raw:x});n.push({row:o,message:`Reduced correct answer to headword '${e}'`}),_=e}const t=S(_);let r=j.map(e=>I(e)?e:"");const i=new Set([_.toLowerCase(),...r.map(e=>e.toLowerCase()).filter(Boolean)]);for(let s=0;s<r.length;s++)if(!r[s]){const e=A(t,i);r[s]=e,i.add(e.toLowerCase()),n.push({row:o,message:"Replaced non-word distractor with POS-matched alternative"})}j=r}const y=[_,...j].map(e=>b(e)),q=new Set;let N=y.filter(e=>{const t=e.toLowerCase();return!q.has(t)&&(q.add(t),!0)});if(N.length<4){const e=new Set(N.map(e=>e.toLowerCase())),t=4-N.length;for(let r=0;r<t;r++){if("SentenceFillIn"===u){const t=A(S(_),e);N.push(t),e.add(t.toLowerCase())}else{const t=$(_,e);N.push(t),e.add(t.toLowerCase())}n.push({row:o,message:"Added synthesized distractor to ensure 4 unique options"})}}const F=N[0],L=N.slice(1,4);i.push({skill_type:t,skill_test_id:r,question_format:u,content:C(v),correct_answer:C(F),incorrect_answers:L.map(C),explanation:C(g||"")})});const h=new Set(n.map(e=>e.row)).size;return{ok:i.length>0,skill_type:t,skill_test_id:r,insert:i,warnings:n,errors:s,summary:{rows_received:u.length,rows_valid:i.length,rows_with_warnings:h,rows_with_errors:s.length}}}function L({skillTestId:d,onImported:u}){const[h,m]=e.useState(null),[p,w]=e.useState([]),[f,g]=e.useState(null),[x,v]=e.useState(!1),j=e.useRef(null);return t.jsxs(r,{children:[t.jsx(n,{children:t.jsx(s,{className:"text-base",children:"Upload Vocabulary CSV"})}),t.jsxs(i,{className:"space-y-3",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{ref:j,type:"file",accept:".csv",className:"hidden",onChange:e=>{var t;const r=null==(t=e.target.files)?void 0:t[0];r&&(async t=>{var r;try{m(null),w([]),g(null);const e=F(await t.text(),"Vocabulary Builder",d);if(g(e),0===e.insert.length){const t=(null==(r=e.errors[0])?void 0:r.message)||"No valid rows found in CSV";return void m(t)}e.errors.length>0&&l.warning(`${e.errors.length} row(s) have errors and will be skipped`),e.warnings.length>0&&l.message(`${e.warnings.length} warning(s) during normalization`),w(e.insert)}catch(e){m(e.message||"Failed to parse CSV")}})(r)}}),t.jsx(a,{onClick:()=>{var e;return null==(e=j.current)?void 0:e.click()},children:"Choose CSV"}),t.jsx(a,{variant:"secondary",onClick:()=>{const e=['DefinitionMatch,"Ubiquitous","Present, appearing, or found everywhere","Rare","Obscure","Fleeting","Used to describe something that is found everywhere; e.g., smartphones are ubiquitous."','SentenceFillIn,"The new evidence will _______ the detective\'s theory.","corroborate","refute","ignore","confuse","Corroborate means to confirm or support; the evidence supports the theory."'].join("\n"),t=new Blob(["QuestionFormat,WordOrSentence,CorrectAnswer,IncorrectAnswer1,IncorrectAnswer2,IncorrectAnswer3,Explanation\n"+e],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="vocabulary-smart-template.csv",n.click(),URL.revokeObjectURL(r)},children:"Download Template"})]}),h&&t.jsx(o,{variant:"destructive",children:t.jsx(c,{children:h})}),p.length>0&&t.jsxs("div",{className:"space-y-2",children:[f&&t.jsxs("p",{className:"text-sm text-muted-foreground",children:["Parsed: ",p.length," valid row(s)",f.warnings.length>0&&` • ${f.warnings.length} warning(s)`,f.errors.length>0&&` • ${f.errors.length} error row(s) skipped`]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(a,{onClick:async()=>{if(f&&0!==f.insert.length){v(!0);try{const{error:e}=await _.from("skill_practice_questions").insert(f.insert);if(e)throw e;l.success(`Imported ${f.insert.length} questions`),w([]),g(null),null==u||u()}catch(e){console.error(e),l.error(e.message||"Import failed")}finally{v(!1)}}},disabled:x,children:x?"Importing...":"Import"}),t.jsx(a,{variant:"secondary",onClick:()=>{w([]),g(null)},children:"Cancel"})]}),t.jsxs("div",{className:"max-h-60 overflow-auto rounded border p-2 text-xs",children:[p.slice(0,10).map((e,r)=>t.jsxs("div",{className:"py-1 border-b last:border-b-0",children:[t.jsx("div",{className:"font-medium",children:e.question_format??e.QuestionFormat}),t.jsx("div",{className:"text-muted-foreground",children:e.content??e.WordOrSentence})]},r)),p.length>10&&t.jsxs("div",{className:"text-muted-foreground",children:["...and ",p.length-10," more"]})]})]})]})]})}const E=()=>{const{id:o}=d(),[c,l]=e.useState(null),[y,b]=e.useState([]),[C,k]=e.useState(null),[I,S]=e.useState({content:"",question_format:"",correct_answer:"",incorrect1:"",incorrect2:"",incorrect3:"",explanation:""}),[q,A]=e.useState(null),N=e.useRef(null),$=async()=>{if(!o)return;const{data:e}=await _.from("skill_tests").select("id,title").eq("id",o).maybeSingle();l(e??null);const{data:t}=await _.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",o).order("created_at",{ascending:!1});b(t??[])};return e.useEffect(()=>{$()},[o]),t.jsxs(u,{title:c?`Manage: ${c.title}`:"Manage Vocabulary Test",showBackButton:!0,children:[t.jsxs("section",{className:"space-y-6",children:[o&&t.jsx(L,{skillTestId:o,onImported:$}),t.jsx(h,{}),t.jsx("div",{ref:N,children:t.jsxs(r,{children:[t.jsx(n,{children:t.jsx(s,{className:"text-base",children:"Student Preview"})}),t.jsx(i,{children:t.jsx(j,{questions:y,selectedQuestionId:q||void 0})})]})}),t.jsxs(r,{children:[t.jsx(n,{children:t.jsx(s,{className:"text-base",children:"Questions"})}),t.jsx(i,{className:"space-y-3",children:0===y.length?t.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions yet. Upload a CSV to add questions."}):y.map(e=>t.jsx("div",{className:"p-3 border rounded-md space-y-2",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{onClick:()=>{return t=e.id,A(t),void requestAnimationFrame(()=>{var e;null==(e=N.current)||e.scrollIntoView({behavior:"smooth",block:"start"})});var t},className:"cursor-pointer",children:[t.jsx("div",{className:"text-xs text-muted-foreground",children:e.question_format}),t.jsx("div",{className:"whitespace-pre-wrap",children:e.content})]}),t.jsxs("div",{className:"flex gap-2 shrink-0",children:[t.jsx(a,{size:"sm",onClick:()=>(e=>{var t,r,n;k(e),S({content:e.content||"",question_format:e.question_format||"",correct_answer:e.correct_answer||"",incorrect1:(null==(t=e.incorrect_answers)?void 0:t[0])||"",incorrect2:(null==(r=e.incorrect_answers)?void 0:r[1])||"",incorrect3:(null==(n=e.incorrect_answers)?void 0:n[2])||"",explanation:e.explanation||""})})(e),children:"Edit"}),t.jsx(a,{size:"sm",variant:"destructive",onClick:()=>(async e=>{confirm("Delete this question?")&&(await _.from("skill_practice_questions").delete().eq("id",e),await $())})(e.id),children:"Delete"})]})]})},e.id))})]})]}),t.jsx(m,{open:!!C,onOpenChange:e=>{e||k(null)},children:t.jsxs(p,{className:"sm:max-w-lg",children:[t.jsx(w,{children:t.jsx(f,{children:"Edit Question"})}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx(g,{htmlFor:"question_format",children:"Format"}),t.jsx(x,{id:"question_format",value:I.question_format,onChange:e=>S({...I,question_format:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"content",children:"Content"}),t.jsx(v,{id:"content",value:I.content,onChange:e=>S({...I,content:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"correct_answer",children:"Correct Answer"}),t.jsx(x,{id:"correct_answer",value:I.correct_answer,onChange:e=>S({...I,correct_answer:e.target.value})})]}),t.jsxs("div",{className:"grid sm:grid-cols-3 gap-3",children:[t.jsxs("div",{children:[t.jsx(g,{children:"Incorrect 1"}),t.jsx(x,{value:I.incorrect1,onChange:e=>S({...I,incorrect1:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(g,{children:"Incorrect 2"}),t.jsx(x,{value:I.incorrect2,onChange:e=>S({...I,incorrect2:e.target.value})})]}),t.jsxs("div",{children:[t.jsx(g,{children:"Incorrect 3"}),t.jsx(x,{value:I.incorrect3,onChange:e=>S({...I,incorrect3:e.target.value})})]})]}),t.jsxs("div",{children:[t.jsx(g,{htmlFor:"explanation",children:"Explanation"}),t.jsx(v,{id:"explanation",value:I.explanation,onChange:e=>S({...I,explanation:e.target.value})})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx(a,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),t.jsx(a,{onClick:async()=>{if(!C)return;const e=[I.incorrect1,I.incorrect2,I.incorrect3].filter(Boolean),{error:t}=await _.from("skill_practice_questions").update({content:I.content,question_format:I.question_format,correct_answer:I.correct_answer,incorrect_answers:e,explanation:I.explanation}).eq("id",C.id);t||(k(null),await $())},children:"Save"})]})]})})]})};export{E as default};
