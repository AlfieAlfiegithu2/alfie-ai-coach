import{G as e,u as s,r as t,j as a,B as r,aa as n,K as i,C as l,a as c,Q as o,k as d}from"./index-C7_FyMei.js";import{s as m}from"./supabase-DWL4C3fA.js";import{C as x}from"./CelebrationLottieAnimation-BaRPcNOB.js";import{P as u}from"./PenguinClapAnimation-Cs3vkEaE.js";function h(e){const s=[...e];for(let t=s.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[s[t],s[e]]=[s[e],s[t]]}return s}function f(e){if(!e)return"";let s=e.trim();return s=s.replace(/^[-â€¢]\s*/,""),s=s.replace(/\*\*(.*?)\*\*/g,"$1"),s=s.replace(/\*(.*?)\*/g,"$1"),s=s.replace(/_(.*?)_/g,"$1"),s=s.replace(/`(.*?)`/g,"$1"),s}const j=()=>{const{testId:j}=e(),p=s(),[g,v]=t.useState([]),[w,N]=t.useState(0),[b,y]=t.useState(null),[k,_]=t.useState(0),[C,T]=t.useState(!1),[q,A]=t.useState(!1),[S,Y]=t.useState([]);t.useEffect(()=>{(async()=>{if(!j)return;const{data:e,error:s}=await m.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",j);if(!s){v(h(e??[]))}})()},[j]);const $=g[w],B=t.useMemo(()=>$?h([$.correct_answer,...$.incorrect_answers||[]]):[],[$]),G=g.length?w/g.length*100:0,M=e=>{if(b)return;if(y(e),!$)return;const s=e===$.correct_answer;s&&(_(e=>e+1),(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),s=e.createOscillator(),t=e.createGain();s.type="sine",s.frequency.value=880,s.connect(t),t.connect(e.destination),t.gain.setValueAtTime(1e-4,e.currentTime),t.gain.exponentialRampToValueAtTime(.2,e.currentTime+.01),s.start(),setTimeout(()=>{s.frequency.setValueAtTime(660,e.currentTime),t.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{s.stop(),e.close()},180)},120)}catch(e){}})(),A(!0),setTimeout(()=>A(!1),1200)),Y(t=>[...t,{id:$.id,question:$.content,chosen:e,correct:$.correct_answer,isCorrect:s}])};return j?a.jsx(n,{title:"Grammar Fix-it",showBackButton:!0,backPath:"/ielts-portal",children:a.jsx("section",{className:"mx-auto px-4",children:a.jsxs("div",{className:"min-h-[70vh] flex flex-col items-center justify-center gap-4",children:[a.jsx("div",{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"absolute -top-10 h-10 flex items-center justify-center -translate-x-1/2 transition-[left] duration-300 ease-out",style:{left:`${G}%`},"aria-label":"Progress mascot",title:"Keep going!",children:a.jsx("img",{src:"/lovable-uploads/27e74cd0-58d8-4b55-b31a-fdb162f21e8b.png",alt:"Grammar progress turtle mascot",className:"w-12 h-12 object-contain drop-shadow animate-[turtle-legs_900ms_ease-in-out_infinite]",loading:"lazy"})}),a.jsx("style",{children:"@keyframes turtle-legs { 0% { transform: translateY(0) rotate(0deg) } 25% { transform: translateY(-1px) rotate(-2deg) } 50% { transform: translateY(0) rotate(0deg) } 75% { transform: translateY(-1px) rotate(2deg) } 100% { transform: translateY(0) rotate(0deg) } }"}),a.jsx(i,{value:G})]})}),C?a.jsx(l,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:a.jsxs(c,{className:"p-6 space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-center gap-3",children:[a.jsx("div",{className:"text-2xl font-semibold",children:"Great job!"}),a.jsx(u,{size:"sm",speed:1.1})]}),a.jsxs("div",{className:"text-center text-muted-foreground",children:["Your score: ",k," / ",g.length]})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm font-medium mb-2",children:"Review"}),a.jsx("div",{className:"max-h-[50vh] overflow-auto space-y-3",children:S.map((e,s)=>a.jsxs("div",{className:"rounded-md border p-3",children:[a.jsxs("div",{className:"flex items-start justify-between gap-3",children:[a.jsx("div",{className:"text-sm font-medium",children:e.question}),a.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+(e.isCorrect?"bg-soft-green":"bg-destructive/10 text-destructive"),children:e.isCorrect?"Correct":"Incorrect"})]}),!e.isCorrect&&a.jsxs("div",{className:"mt-2 text-sm space-y-1",children:[a.jsxs("div",{className:"text-muted-foreground",children:["Your answer: ",e.chosen]}),a.jsxs("div",{className:"text-muted-foreground",children:["Correct answer: ",e.correct]})]})]},e.id+String(s)))})]}),a.jsxs("div",{className:"flex gap-2 justify-center",children:[a.jsx(r,{onClick:()=>{N(0),_(0),y(null),T(!1),Y([])},children:"Retry"}),a.jsx(r,{variant:"secondary",onClick:()=>p("/ielts-portal"),children:"Back"})]})]})}):a.jsx(a.Fragment,{children:$?a.jsx(l,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl border-light-border",children:a.jsxs(c,{className:"relative p-6 space-y-4",children:[q&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:a.jsx(x,{size:"sm",speed:1.2})}),a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs(r,{variant:"ghost",size:"sm",onClick:()=>{N(e=>Math.max(0,e-1)),y(null)},disabled:0===w,className:"text-muted-foreground hover:text-foreground",children:[a.jsx(o,{className:"w-4 h-4 mr-1"}),"Previous"]}),a.jsxs("div",{className:"text-sm text-muted-foreground",children:["Question ",w+1," of ",g.length]}),a.jsx("div",{className:"w-[85px]"})," "]}),"DefinitionMatch"===$.question_format?a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-semibold mb-4",children:$.content}),a.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:B.map(e=>{const s=b&&e===$.correct_answer,t=b===e&&e!==$.correct_answer;return a.jsx(r,{variant:s?"success":t?"destructive":"outline",className:"w-full justify-start text-left h-auto py-3 text-sm md:text-base whitespace-normal break-words break-all md:break-words",onClick:()=>M(e),children:e},e)})})]}):a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-semibold mb-4 whitespace-pre-wrap",children:$.content}),a.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:B.map(e=>{const s=b&&e===$.correct_answer,t=b===e&&e!==$.correct_answer;return a.jsx(r,{variant:s?"success":t?"destructive":"outline",className:"w-full justify-start text-left h-auto py-3 text-sm md:text-base whitespace-normal break-words break-all md:break-words",onClick:()=>M(e),children:e},e)})})]}),b&&a.jsxs("div",{className:"pt-2 space-y-3",children:[$.explanation&&a.jsxs("div",{className:"rounded-md border p-3",children:[a.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:f($.explanation)})]}),a.jsx("div",{className:"flex justify-center",children:a.jsxs(r,{onClick:()=>{w+1>=g.length?T(!0):(N(e=>e+1),y(null))},children:[w+1>=g.length?"Finish":"Continue",a.jsx(d,{className:"w-4 h-4 ml-1"})]})})]})]})}):a.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading questions..."})})]})})}):a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsx(r,{onClick:()=>p("/ielts-portal"),children:"Back"})})};export{j as default};
