import{y as e,an as t,r,at as o,ay as n,j as a,aq as s,as as l,ar as i,aX as c,au as d,bq as u,am as m,aP as p,ao as h,b5 as f,b4 as g,ak as b,u as x,A as v,g as y,af as w,bo as k,Z as j,ai as S,a as _,B as C,k as N,C as E,M as P,b as T,c as R,av as M,bb as A,bc as L,E as $,a1 as D,bd as I,$ as z,P as q,br as B,bp as F,ac as U,V as H,S as W,o as O,p as Y,q as X,s as V,_ as K,bs as G,d as Q,a7 as J}from"./index-BmiLTbvw.js";import{s as Z}from"./supabase-Bqkrifq5.js";import{A as ee}from"./cloudflare-r2-DEyY8hXO.js";import"./dropdown-menu-fNN0bXqz.js";import{F as te,C as re,a as oe,b as ne,O as ae,M as se,c as le,R as ie,S as ce}from"./shimmering-text-CpxMgutH.js";import{S as de}from"./sparkles-B7s79X3v.js";import{F as ue}from"./file-text-czy7akzg.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=e("ListTree",[["path",{d:"M21 12h-8",key:"1bmf0i"}],["path",{d:"M21 6H8",key:"1pqkrb"}],["path",{d:"M21 18h-8",key:"1tm79t"}],["path",{d:"M3 6v4c0 1.1.9 2 2 2h3",key:"1ywdgy"}],["path",{d:"M3 10v6c0 1.1.9 2 2 2h3",key:"2wc746"}]]);var pe="ScrollArea",[he,fe]=t(pe),[ge,be]=he(pe),xe=r.forwardRef((e,t)=>{const{__scopeScrollArea:l,type:i="hover",dir:c,scrollHideDelay:d=600,...u}=e,[m,p]=r.useState(null),[h,f]=r.useState(null),[g,b]=r.useState(null),[x,v]=r.useState(null),[y,w]=r.useState(null),[k,j]=r.useState(0),[S,_]=r.useState(0),[C,N]=r.useState(!1),[E,P]=r.useState(!1),T=o(t,e=>p(e)),R=n(c);return a.jsx(ge,{scope:l,type:i,dir:R,scrollHideDelay:d,scrollArea:m,viewport:h,onViewportChange:f,content:g,onContentChange:b,scrollbarX:x,onScrollbarXChange:v,scrollbarXEnabled:C,onScrollbarXEnabledChange:N,scrollbarY:y,onScrollbarYChange:w,scrollbarYEnabled:E,onScrollbarYEnabledChange:P,onCornerWidthChange:j,onCornerHeightChange:_,children:a.jsx(s.div,{dir:R,...u,ref:T,style:{position:"relative","--radix-scroll-area-corner-width":k+"px","--radix-scroll-area-corner-height":S+"px",...e.style}})})});xe.displayName=pe;var ve="ScrollAreaViewport",ye=r.forwardRef((e,t)=>{const{__scopeScrollArea:n,children:l,asChild:i,nonce:c,...d}=e,u=be(ve,n),m=r.useRef(null),p=o(t,m,u.onViewportChange);return a.jsxs(a.Fragment,{children:[a.jsx("style",{dangerouslySetInnerHTML:{__html:"\n[data-radix-scroll-area-viewport] {\n  scrollbar-width: none;\n  -ms-overflow-style: none;\n  -webkit-overflow-scrolling: touch;\n}\n[data-radix-scroll-area-viewport]::-webkit-scrollbar {\n  display: none;\n}\n:where([data-radix-scroll-area-viewport]) {\n  display: flex;\n  flex-direction: column;\n  align-items: stretch;\n}\n:where([data-radix-scroll-area-content]) {\n  flex-grow: 1;\n}\n"},nonce:c}),a.jsx(s.div,{"data-radix-scroll-area-viewport":"",...d,asChild:i,ref:p,style:{overflowX:u.scrollbarXEnabled?"scroll":"hidden",overflowY:u.scrollbarYEnabled?"scroll":"hidden",...e.style},children:Xe({asChild:i,children:l},e=>a.jsx("div",{"data-radix-scroll-area-content":"",ref:u.onContentChange,style:{minWidth:u.scrollbarXEnabled?"fit-content":void 0},children:e}))})]})});ye.displayName=ve;var we="ScrollAreaScrollbar",ke=r.forwardRef((e,t)=>{const{forceMount:o,...n}=e,s=be(we,e.__scopeScrollArea),{onScrollbarXEnabledChange:l,onScrollbarYEnabledChange:i}=s,c="horizontal"===e.orientation;return r.useEffect(()=>(c?l(!0):i(!0),()=>{c?l(!1):i(!1)}),[c,l,i]),"hover"===s.type?a.jsx(je,{...n,ref:t,forceMount:o}):"scroll"===s.type?a.jsx(Se,{...n,ref:t,forceMount:o}):"auto"===s.type?a.jsx(_e,{...n,ref:t,forceMount:o}):"always"===s.type?a.jsx(Ce,{...n,ref:t}):null});ke.displayName=we;var je=r.forwardRef((e,t)=>{const{forceMount:o,...n}=e,s=be(we,e.__scopeScrollArea),[i,c]=r.useState(!1);return r.useEffect(()=>{const e=s.scrollArea;let t=0;if(e){const r=()=>{window.clearTimeout(t),c(!0)},o=()=>{t=window.setTimeout(()=>c(!1),s.scrollHideDelay)};return e.addEventListener("pointerenter",r),e.addEventListener("pointerleave",o),()=>{window.clearTimeout(t),e.removeEventListener("pointerenter",r),e.removeEventListener("pointerleave",o)}}},[s.scrollArea,s.scrollHideDelay]),a.jsx(l,{present:o||i,children:a.jsx(_e,{"data-state":i?"visible":"hidden",...n,ref:t})})}),Se=r.forwardRef((e,t)=>{const{forceMount:o,...n}=e,s=be(we,e.__scopeScrollArea),c="horizontal"===e.orientation,d=Oe(()=>m("SCROLL_END"),100),[u,m]=(p="hidden",h={hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}},r.useReducer((e,t)=>h[e][t]??e,p));var p,h;return r.useEffect(()=>{if("idle"===u){const e=window.setTimeout(()=>m("HIDE"),s.scrollHideDelay);return()=>window.clearTimeout(e)}},[u,s.scrollHideDelay,m]),r.useEffect(()=>{const e=s.viewport,t=c?"scrollLeft":"scrollTop";if(e){let r=e[t];const o=()=>{const o=e[t];r!==o&&(m("SCROLL"),d()),r=o};return e.addEventListener("scroll",o),()=>e.removeEventListener("scroll",o)}},[s.viewport,c,m,d]),a.jsx(l,{present:o||"hidden"!==u,children:a.jsx(Ce,{"data-state":"hidden"===u?"hidden":"visible",...n,ref:t,onPointerEnter:i(e.onPointerEnter,()=>m("POINTER_ENTER")),onPointerLeave:i(e.onPointerLeave,()=>m("POINTER_LEAVE"))})})}),_e=r.forwardRef((e,t)=>{const o=be(we,e.__scopeScrollArea),{forceMount:n,...s}=e,[i,c]=r.useState(!1),d="horizontal"===e.orientation,u=Oe(()=>{if(o.viewport){const e=o.viewport.offsetWidth<o.viewport.scrollWidth,t=o.viewport.offsetHeight<o.viewport.scrollHeight;c(d?e:t)}},10);return Ye(o.viewport,u),Ye(o.content,u),a.jsx(l,{present:n||i,children:a.jsx(Ce,{"data-state":i?"visible":"hidden",...s,ref:t})})}),Ce=r.forwardRef((e,t)=>{const{orientation:o="vertical",...n}=e,s=be(we,e.__scopeScrollArea),l=r.useRef(null),i=r.useRef(0),[c,d]=r.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),u=qe(c.viewport,c.content),m={...n,sizes:c,onSizesChange:d,hasThumb:Boolean(u>0&&u<1),onThumbChange:e=>l.current=e,onThumbPointerUp:()=>i.current=0,onThumbPointerDown:e=>i.current=e};function p(e,t){return function(e,t,r,o="ltr"){const n=Be(r),a=n/2,s=t||a,l=n-s,i=r.scrollbar.paddingStart+s,c=r.scrollbar.size-r.scrollbar.paddingEnd-l,d=r.content-r.viewport,u="ltr"===o?[0,d]:[-1*d,0];return Ue([i,c],u)(e)}(e,i.current,c,t)}return"horizontal"===o?a.jsx(Ne,{...m,ref:t,onThumbPositionChange:()=>{if(s.viewport&&l.current){const e=Fe(s.viewport.scrollLeft,c,s.dir);l.current.style.transform=`translate3d(${e}px, 0, 0)`}},onWheelScroll:e=>{s.viewport&&(s.viewport.scrollLeft=e)},onDragScroll:e=>{s.viewport&&(s.viewport.scrollLeft=p(e,s.dir))}}):"vertical"===o?a.jsx(Ee,{...m,ref:t,onThumbPositionChange:()=>{if(s.viewport&&l.current){const e=Fe(s.viewport.scrollTop,c);l.current.style.transform=`translate3d(0, ${e}px, 0)`}},onWheelScroll:e=>{s.viewport&&(s.viewport.scrollTop=e)},onDragScroll:e=>{s.viewport&&(s.viewport.scrollTop=p(e))}}):null}),Ne=r.forwardRef((e,t)=>{const{sizes:n,onSizesChange:s,...l}=e,i=be(we,e.__scopeScrollArea),[c,d]=r.useState(),u=r.useRef(null),m=o(t,u,i.onScrollbarXChange);return r.useEffect(()=>{u.current&&d(getComputedStyle(u.current))},[u]),a.jsx(Re,{"data-orientation":"horizontal",...l,ref:m,sizes:n,style:{bottom:0,left:"rtl"===i.dir?"var(--radix-scroll-area-corner-width)":0,right:"ltr"===i.dir?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":Be(n)+"px",...e.style},onThumbPointerDown:t=>e.onThumbPointerDown(t.x),onDragScroll:t=>e.onDragScroll(t.x),onWheelScroll:(t,r)=>{if(i.viewport){const o=i.viewport.scrollLeft+t.deltaX;e.onWheelScroll(o),He(o,r)&&t.preventDefault()}},onResize:()=>{u.current&&i.viewport&&c&&s({content:i.viewport.scrollWidth,viewport:i.viewport.offsetWidth,scrollbar:{size:u.current.clientWidth,paddingStart:ze(c.paddingLeft),paddingEnd:ze(c.paddingRight)}})}})}),Ee=r.forwardRef((e,t)=>{const{sizes:n,onSizesChange:s,...l}=e,i=be(we,e.__scopeScrollArea),[c,d]=r.useState(),u=r.useRef(null),m=o(t,u,i.onScrollbarYChange);return r.useEffect(()=>{u.current&&d(getComputedStyle(u.current))},[u]),a.jsx(Re,{"data-orientation":"vertical",...l,ref:m,sizes:n,style:{top:0,right:"ltr"===i.dir?0:void 0,left:"rtl"===i.dir?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":Be(n)+"px",...e.style},onThumbPointerDown:t=>e.onThumbPointerDown(t.y),onDragScroll:t=>e.onDragScroll(t.y),onWheelScroll:(t,r)=>{if(i.viewport){const o=i.viewport.scrollTop+t.deltaY;e.onWheelScroll(o),He(o,r)&&t.preventDefault()}},onResize:()=>{u.current&&i.viewport&&c&&s({content:i.viewport.scrollHeight,viewport:i.viewport.offsetHeight,scrollbar:{size:u.current.clientHeight,paddingStart:ze(c.paddingTop),paddingEnd:ze(c.paddingBottom)}})}})}),[Pe,Te]=he(we),Re=r.forwardRef((e,t)=>{const{__scopeScrollArea:n,sizes:l,hasThumb:d,onThumbChange:u,onThumbPointerUp:m,onThumbPointerDown:p,onThumbPositionChange:h,onDragScroll:f,onWheelScroll:g,onResize:b,...x}=e,v=be(we,n),[y,w]=r.useState(null),k=o(t,e=>w(e)),j=r.useRef(null),S=r.useRef(""),_=v.viewport,C=l.content-l.viewport,N=c(g),E=c(h),P=Oe(b,10);function T(e){if(j.current){const t=e.clientX-j.current.left,r=e.clientY-j.current.top;f({x:t,y:r})}}return r.useEffect(()=>{const e=e=>{const t=e.target;(null==y?void 0:y.contains(t))&&N(e,C)};return document.addEventListener("wheel",e,{passive:!1}),()=>document.removeEventListener("wheel",e,{passive:!1})},[_,y,C,N]),r.useEffect(E,[l,E]),Ye(y,P),Ye(v.content,P),a.jsx(Pe,{scope:n,scrollbar:y,hasThumb:d,onThumbChange:c(u),onThumbPointerUp:c(m),onThumbPositionChange:E,onThumbPointerDown:c(p),children:a.jsx(s.div,{...x,ref:k,style:{position:"absolute",...x.style},onPointerDown:i(e.onPointerDown,e=>{if(0===e.button){e.target.setPointerCapture(e.pointerId),j.current=y.getBoundingClientRect(),S.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",v.viewport&&(v.viewport.style.scrollBehavior="auto"),T(e)}}),onPointerMove:i(e.onPointerMove,T),onPointerUp:i(e.onPointerUp,e=>{const t=e.target;t.hasPointerCapture(e.pointerId)&&t.releasePointerCapture(e.pointerId),document.body.style.webkitUserSelect=S.current,v.viewport&&(v.viewport.style.scrollBehavior=""),j.current=null})})})}),Me="ScrollAreaThumb",Ae=r.forwardRef((e,t)=>{const{forceMount:r,...o}=e,n=Te(Me,e.__scopeScrollArea);return a.jsx(l,{present:r||n.hasThumb,children:a.jsx(Le,{ref:t,...o})})}),Le=r.forwardRef((e,t)=>{const{__scopeScrollArea:n,style:l,...c}=e,d=be(Me,n),u=Te(Me,n),{onThumbPositionChange:m}=u,p=o(t,e=>u.onThumbChange(e)),h=r.useRef(),f=Oe(()=>{h.current&&(h.current(),h.current=void 0)},100);return r.useEffect(()=>{const e=d.viewport;if(e){const t=()=>{if(f(),!h.current){const t=We(e,m);h.current=t,m()}};return m(),e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)}},[d.viewport,f,m]),a.jsx(s.div,{"data-state":u.hasThumb?"visible":"hidden",...c,ref:p,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...l},onPointerDownCapture:i(e.onPointerDownCapture,e=>{const t=e.target.getBoundingClientRect(),r=e.clientX-t.left,o=e.clientY-t.top;u.onThumbPointerDown({x:r,y:o})}),onPointerUp:i(e.onPointerUp,u.onThumbPointerUp)})});Ae.displayName=Me;var $e="ScrollAreaCorner",De=r.forwardRef((e,t)=>{const r=be($e,e.__scopeScrollArea),o=Boolean(r.scrollbarX&&r.scrollbarY);return"scroll"!==r.type&&o?a.jsx(Ie,{...e,ref:t}):null});De.displayName=$e;var Ie=r.forwardRef((e,t)=>{const{__scopeScrollArea:o,...n}=e,l=be($e,o),[i,c]=r.useState(0),[d,u]=r.useState(0),m=Boolean(i&&d);return Ye(l.scrollbarX,()=>{var e;const t=(null==(e=l.scrollbarX)?void 0:e.offsetHeight)||0;l.onCornerHeightChange(t),u(t)}),Ye(l.scrollbarY,()=>{var e;const t=(null==(e=l.scrollbarY)?void 0:e.offsetWidth)||0;l.onCornerWidthChange(t),c(t)}),m?a.jsx(s.div,{...n,ref:t,style:{width:i,height:d,position:"absolute",right:"ltr"===l.dir?0:void 0,left:"rtl"===l.dir?0:void 0,bottom:0,...e.style}}):null});function ze(e){return e?parseInt(e,10):0}function qe(e,t){const r=e/t;return isNaN(r)?0:r}function Be(e){const t=qe(e.viewport,e.content),r=e.scrollbar.paddingStart+e.scrollbar.paddingEnd,o=(e.scrollbar.size-r)*t;return Math.max(o,18)}function Fe(e,t,r="ltr"){const o=Be(t),n=t.scrollbar.paddingStart+t.scrollbar.paddingEnd,a=t.scrollbar.size-n,s=t.content-t.viewport,l=a-o,i=u(e,"ltr"===r?[0,s]:[-1*s,0]);return Ue([0,s],[0,l])(i)}function Ue(e,t){return r=>{if(e[0]===e[1]||t[0]===t[1])return t[0];const o=(t[1]-t[0])/(e[1]-e[0]);return t[0]+o*(r-e[0])}}function He(e,t){return e>0&&e<t}var We=(e,t=()=>{})=>{let r={left:e.scrollLeft,top:e.scrollTop},o=0;return function n(){const a={left:e.scrollLeft,top:e.scrollTop},s=r.left!==a.left,l=r.top!==a.top;(s||l)&&t(),r=a,o=window.requestAnimationFrame(n)}(),()=>window.cancelAnimationFrame(o)};function Oe(e,t){const o=c(e),n=r.useRef(0);return r.useEffect(()=>()=>window.clearTimeout(n.current),[]),r.useCallback(()=>{window.clearTimeout(n.current),n.current=window.setTimeout(o,t)},[o,t])}function Ye(e,t){const r=c(t);d(()=>{let t=0;if(e){const o=new ResizeObserver(()=>{cancelAnimationFrame(t),t=window.requestAnimationFrame(r)});return o.observe(e),()=>{window.cancelAnimationFrame(t),o.unobserve(e)}}},[e,r])}function Xe(e,t){const{asChild:o,children:n}=e;if(!o)return"function"==typeof t?t(n):t;const a=r.Children.only(n);return r.cloneElement(a,{children:"function"==typeof t?t(a.props.children):t})}var Ve=xe,Ke=ye,Ge=De;r.forwardRef(({className:e,children:t,...r},o)=>a.jsxs(Ve,{ref:o,className:m("relative overflow-hidden",e),...r,children:[a.jsx(Ke,{className:"h-full w-full rounded-[inherit]",children:t}),a.jsx(Qe,{}),a.jsx(Ge,{})]})).displayName=Ve.displayName;const Qe=r.forwardRef(({className:e,orientation:t="vertical",...r},o)=>a.jsx(ke,{ref:o,orientation:t,className:m("flex touch-none select-none transition-colors","vertical"===t&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===t&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",e),...r,children:a.jsx(Ae,{className:"relative flex-1 rounded-full bg-border"})}));Qe.displayName=ke.displayName,r.createContext(null);var Je=["PageUp","PageDown"],Ze=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],et={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},tt="Slider",[rt,ot,nt]=p(tt),[at,st]=t(tt,[nt]),[lt,it]=at(tt),ct=r.forwardRef((e,t)=>{const{name:o,min:n=0,max:s=100,step:l=1,orientation:c="horizontal",disabled:d=!1,minStepsBetweenThumbs:m=0,defaultValue:p=[n],value:f,onValueChange:g=()=>{},onValueCommit:b=()=>{},inverted:x=!1,form:v,...y}=e,w=r.useRef(new Set),k=r.useRef(0),j="horizontal"===c?mt:pt,[S=[],_]=h({prop:f,defaultProp:p,onChange:e=>{var t;null==(t=[...w.current][k.current])||t.focus(),g(e)}}),C=r.useRef(S);function N(e,t,{commit:r}={commit:!1}){const o=function(e){return(String(e).split(".")[1]||"").length}(l),a=function(e,t){const r=Math.pow(10,t);return Math.round(e*r)/r}(Math.round((e-n)/l)*l+n,o),i=u(a,[n,s]);_((e=[])=>{const o=function(e=[],t,r){const o=[...e];return o[r]=t,o.sort((e,t)=>e-t)}(e,i,t);if(function(e,t){if(t>0){const r=function(e){return e.slice(0,-1).map((t,r)=>e[r+1]-t)}(e);return Math.min(...r)>=t}return!0}(o,m*l)){k.current=o.indexOf(i);const t=String(o)!==String(e);return t&&r&&b(o),t?o:e}return e})}return a.jsx(lt,{scope:e.__scopeSlider,name:o,disabled:d,min:n,max:s,valueIndexToChangeRef:k,thumbs:w.current,values:S,orientation:c,form:v,children:a.jsx(rt.Provider,{scope:e.__scopeSlider,children:a.jsx(rt.Slot,{scope:e.__scopeSlider,children:a.jsx(j,{"aria-disabled":d,"data-disabled":d?"":void 0,...y,ref:t,onPointerDown:i(y.onPointerDown,()=>{d||(C.current=S)}),min:n,max:s,inverted:x,onSlideStart:d?void 0:function(e){const t=function(e,t){if(1===e.length)return 0;const r=e.map(e=>Math.abs(e-t)),o=Math.min(...r);return r.indexOf(o)}(S,e);N(e,t)},onSlideMove:d?void 0:function(e){N(e,k.current)},onSlideEnd:d?void 0:function(){const e=C.current[k.current];S[k.current]!==e&&b(S)},onHomeKeyDown:()=>!d&&N(n,0,{commit:!0}),onEndKeyDown:()=>!d&&N(s,S.length-1,{commit:!0}),onStepKeyDown:({event:e,direction:t})=>{if(!d){const r=Je.includes(e.key)||e.shiftKey&&Ze.includes(e.key)?10:1,o=k.current;N(S[o]+l*r*t,o,{commit:!0})}}})})})})});ct.displayName=tt;var[dt,ut]=at(tt,{startEdge:"left",endEdge:"right",size:"width",direction:1}),mt=r.forwardRef((e,t)=>{const{min:s,max:l,dir:i,inverted:c,onSlideStart:d,onSlideMove:u,onSlideEnd:m,onStepKeyDown:p,...h}=e,[f,g]=r.useState(null),b=o(t,e=>g(e)),x=r.useRef(),v=n(i),y="ltr"===v,w=y&&!c||!y&&c;function k(e){const t=x.current||f.getBoundingClientRect(),r=St([0,t.width],w?[s,l]:[l,s]);return x.current=t,r(e-t.left)}return a.jsx(dt,{scope:e.__scopeSlider,startEdge:w?"left":"right",endEdge:w?"right":"left",direction:w?1:-1,size:"width",children:a.jsx(ht,{dir:v,"data-orientation":"horizontal",...h,ref:b,style:{...h.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:e=>{const t=k(e.clientX);null==d||d(t)},onSlideMove:e=>{const t=k(e.clientX);null==u||u(t)},onSlideEnd:()=>{x.current=void 0,null==m||m()},onStepKeyDown:e=>{const t=et[w?"from-left":"from-right"].includes(e.key);null==p||p({event:e,direction:t?-1:1})}})})}),pt=r.forwardRef((e,t)=>{const{min:n,max:s,inverted:l,onSlideStart:i,onSlideMove:c,onSlideEnd:d,onStepKeyDown:u,...m}=e,p=r.useRef(null),h=o(t,p),f=r.useRef(),g=!l;function b(e){const t=f.current||p.current.getBoundingClientRect(),r=St([0,t.height],g?[s,n]:[n,s]);return f.current=t,r(e-t.top)}return a.jsx(dt,{scope:e.__scopeSlider,startEdge:g?"bottom":"top",endEdge:g?"top":"bottom",size:"height",direction:g?1:-1,children:a.jsx(ht,{"data-orientation":"vertical",...m,ref:h,style:{...m.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:e=>{const t=b(e.clientY);null==i||i(t)},onSlideMove:e=>{const t=b(e.clientY);null==c||c(t)},onSlideEnd:()=>{f.current=void 0,null==d||d()},onStepKeyDown:e=>{const t=et[g?"from-bottom":"from-top"].includes(e.key);null==u||u({event:e,direction:t?-1:1})}})})}),ht=r.forwardRef((e,t)=>{const{__scopeSlider:r,onSlideStart:o,onSlideMove:n,onSlideEnd:l,onHomeKeyDown:c,onEndKeyDown:d,onStepKeyDown:u,...m}=e,p=it(tt,r);return a.jsx(s.span,{...m,ref:t,onKeyDown:i(e.onKeyDown,e=>{"Home"===e.key?(c(e),e.preventDefault()):"End"===e.key?(d(e),e.preventDefault()):Je.concat(Ze).includes(e.key)&&(u(e),e.preventDefault())}),onPointerDown:i(e.onPointerDown,e=>{const t=e.target;t.setPointerCapture(e.pointerId),e.preventDefault(),p.thumbs.has(t)?t.focus():o(e)}),onPointerMove:i(e.onPointerMove,e=>{e.target.hasPointerCapture(e.pointerId)&&n(e)}),onPointerUp:i(e.onPointerUp,e=>{const t=e.target;t.hasPointerCapture(e.pointerId)&&(t.releasePointerCapture(e.pointerId),l(e))})})}),ft="SliderTrack",gt=r.forwardRef((e,t)=>{const{__scopeSlider:r,...o}=e,n=it(ft,r);return a.jsx(s.span,{"data-disabled":n.disabled?"":void 0,"data-orientation":n.orientation,...o,ref:t})});gt.displayName=ft;var bt="SliderRange",xt=r.forwardRef((e,t)=>{const{__scopeSlider:n,...l}=e,i=it(bt,n),c=ut(bt,n),d=r.useRef(null),u=o(t,d),m=i.values.length,p=i.values.map(e=>jt(e,i.min,i.max)),h=m>1?Math.min(...p):0,f=100-Math.max(...p);return a.jsx(s.span,{"data-orientation":i.orientation,"data-disabled":i.disabled?"":void 0,...l,ref:u,style:{...e.style,[c.startEdge]:h+"%",[c.endEdge]:f+"%"}})});xt.displayName=bt;var vt="SliderThumb",yt=r.forwardRef((e,t)=>{const n=ot(e.__scopeSlider),[s,l]=r.useState(null),i=o(t,e=>l(e)),c=r.useMemo(()=>s?n().findIndex(e=>e.ref.current===s):-1,[n,s]);return a.jsx(wt,{...e,ref:i,index:c})}),wt=r.forwardRef((e,t)=>{const{__scopeSlider:n,index:l,name:c,...d}=e,u=it(vt,n),m=ut(vt,n),[p,h]=r.useState(null),g=o(t,e=>h(e)),b=!p||(u.form||!!p.closest("form")),x=f(p),v=u.values[l],y=void 0===v?0:jt(v,u.min,u.max),w=function(e,t){return t>2?`Value ${e+1} of ${t}`:2===t?["Minimum","Maximum"][e]:void 0}(l,u.values.length),k=null==x?void 0:x[m.size],j=k?function(e,t,r){const o=e/2,n=St([0,50],[0,o]);return(o-n(t)*r)*r}(k,y,m.direction):0;return r.useEffect(()=>{if(p)return u.thumbs.add(p),()=>{u.thumbs.delete(p)}},[p,u.thumbs]),a.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[m.startEdge]:`calc(${y}% + ${j}px)`},children:[a.jsx(rt.ItemSlot,{scope:e.__scopeSlider,children:a.jsx(s.span,{role:"slider","aria-label":e["aria-label"]||w,"aria-valuemin":u.min,"aria-valuenow":v,"aria-valuemax":u.max,"aria-orientation":u.orientation,"data-orientation":u.orientation,"data-disabled":u.disabled?"":void 0,tabIndex:u.disabled?void 0:0,...d,ref:g,style:void 0===v?{display:"none"}:e.style,onFocus:i(e.onFocus,()=>{u.valueIndexToChangeRef.current=l})})}),b&&a.jsx(kt,{name:c??(u.name?u.name+(u.values.length>1?"[]":""):void 0),form:u.form,value:v},l)]})});yt.displayName=vt;var kt=e=>{const{value:t,...o}=e,n=r.useRef(null),s=g(t);return r.useEffect(()=>{const e=n.current,r=window.HTMLInputElement.prototype,o=Object.getOwnPropertyDescriptor(r,"value").set;if(s!==t&&o){const r=new Event("input",{bubbles:!0});o.call(e,t),e.dispatchEvent(r)}},[s,t]),a.jsx("input",{style:{display:"none"},...o,ref:n,defaultValue:t})};function jt(e,t,r){return u(100/(r-t)*(e-t),[0,100])}function St(e,t){return r=>{if(e[0]===e[1]||t[0]===t[1])return t[0];const o=(t[1]-t[0])/(e[1]-e[0]);return t[0]+o*(r-e[0])}}var _t=ct,Ct=gt,Nt=xt,Et=yt;r.forwardRef(({className:e,...t},r)=>a.jsxs(_t,{ref:r,className:m("relative flex w-full touch-none select-none items-center",e),...t,children:[a.jsx(Ct,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:a.jsx(Nt,{className:"absolute h-full bg-primary"})}),a.jsx(Et,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]})).displayName=_t.displayName;const Pt=({active:e=!1,processing:t=!1,deviceId:o,barWidth:n=3,barGap:s=1,barRadius:l=1.5,barColor:i,fadeEdges:c=!0,fadeWidth:d=24,height:u=64,sensitivity:p=1,smoothingTimeConstant:h=.8,fftSize:f=256,historySize:g=60,updateRate:b=30,mode:x="static",onError:v,onStreamReady:y,onStreamEnd:w,className:k,...j})=>{const S=r.useRef(null),_=r.useRef(null),C=r.useRef([]),N=r.useRef(null),E=r.useRef(null),P=r.useRef(null),T=r.useRef(0),R=r.useRef(0),M=r.useRef(null),A=r.useRef([]),L=r.useRef(0),$=r.useRef([]),D=r.useRef(!0),I=r.useRef(null),z=r.useRef(0),q="number"==typeof u?`${u}px`:u;return r.useEffect(()=>{const e=S.current,t=_.current;if(!e||!t)return;const r=new ResizeObserver(()=>{const r=t.getBoundingClientRect(),o=window.devicePixelRatio||1;e.width=r.width*o,e.height=r.height*o,e.style.width=`${r.width}px`,e.style.height=`${r.height}px`;const n=e.getContext("2d");n&&n.scale(o,o),I.current=null,z.current=r.width,D.current=!0});return r.observe(t),()=>r.disconnect()},[]),r.useEffect(()=>{if(t&&!e){let e=0;L.current=0;const t=()=>{var r;e+=.03,L.current=Math.min(1,L.current+.02);const o=[],a=Math.floor(((null==(r=_.current)?void 0:r.getBoundingClientRect().width)||200)/(n+s));if("static"===x){const t=Math.floor(a/2);for(let r=0;r<a;r++){const n=(r-t)/t,a=1-.4*Math.abs(n),s=(.2+(.25*Math.sin(1.5*e+3*n)+.2*Math.sin(.8*e-2*n)+.15*Math.cos(2*e+n)))*a;let l=s;if(A.current.length>0&&L.current<1){const e=Math.min(r,A.current.length-1);l=(A.current[e]||0)*(1-L.current)+s*L.current}o.push(Math.max(.05,Math.min(1,l)))}}else for(let t=0;t<a;t++){const r=(t-a/2)/(a/2),n=1-.4*Math.abs(r),s=(.2+(.25*Math.sin(1.5*e+.15*t)+.2*Math.sin(.8*e-.1*t)+.15*Math.cos(2*e+.05*t)))*n;let l=s;if(A.current.length>0&&L.current<1){const e=Math.floor(t/a*A.current.length);l=(A.current[e]||0)*(1-L.current)+s*L.current}o.push(Math.max(.05,Math.min(1,l)))}"static"===x?$.current=o:C.current=o,D.current=!0,M.current=requestAnimationFrame(t)};return t(),()=>{M.current&&cancelAnimationFrame(M.current)}}if(!e&&!t){if("static"===x?$.current.length>0:C.current.length>0){let e=0;const t=()=>{e+=.03,e<1?("static"===x?$.current=$.current.map(t=>t*(1-e)):C.current=C.current.map(t=>t*(1-e)),D.current=!0,requestAnimationFrame(t)):"static"===x?$.current=[]:C.current=[]};t()}}},[t,e,n,s,x]),r.useEffect(()=>{if(!e)return P.current&&(P.current.getTracks().forEach(e=>e.stop()),P.current=null,null==w||w()),E.current&&"closed"!==E.current.state&&(E.current.close(),E.current=null),void(T.current&&(cancelAnimationFrame(T.current),T.current=0));return(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:o?{deviceId:{exact:o},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});P.current=e,null==y||y(e);const t=new(window.AudioContext||window.webkitAudioContext),r=t.createAnalyser();r.fftSize=f,r.smoothingTimeConstant=h;t.createMediaStreamSource(e).connect(r),E.current=t,N.current=r,C.current=[]}catch(e){null==v||v(e)}})(),()=>{P.current&&(P.current.getTracks().forEach(e=>e.stop()),P.current=null,null==w||w()),E.current&&"closed"!==E.current.state&&(E.current.close(),E.current=null),T.current&&(cancelAnimationFrame(T.current),T.current=0)}},[e,o,f,h,v,y,w]),r.useEffect(()=>{const r=S.current;if(!r)return;const o=r.getContext("2d");if(!o)return;let a;const u=m=>{const h=r.getBoundingClientRect();if(e&&m-R.current>b&&(R.current=m,N.current)){const e=new Uint8Array(N.current.frequencyBinCount);if(N.current.getByteFrequencyData(e),"static"===x){const t=Math.floor(.05*e.length),r=Math.floor(.4*e.length),o=e.slice(t,r),a=Math.floor(h.width/(n+s)),l=Math.floor(a/2),i=[];for(let e=l-1;e>=0;e--){const t=Math.floor(e/l*o.length),r=Math.min(1,o[t]/255*p);i.push(Math.max(.05,r))}for(let e=0;e<l;e++){const t=Math.floor(e/l*o.length),r=Math.min(1,o[t]/255*p);i.push(Math.max(.05,r))}$.current=i,A.current=i}else{let t=0;const r=Math.floor(.05*e.length),o=Math.floor(.4*e.length),n=e.slice(r,o);for(let e=0;e<n.length;e++)t+=n[e];const a=t/n.length/255*p;C.current.push(Math.min(1,Math.max(.05,a))),A.current=[...C.current],C.current.length>g&&C.current.shift()}D.current=!0}if(!D.current&&!e)return void(a=requestAnimationFrame(u));D.current=e,o.clearRect(0,0,h.width,h.height);const f=i||getComputedStyle(r).color||"#000",v=n+s,y=Math.floor(h.width/v),w=h.height/2;if("static"===x){const r=t||e||$.current.length>0?$.current:[];for(let e=0;e<y&&e<r.length;e++){const t=r[e]||.1,a=e*v,s=Math.max(4,t*h.height*.8),i=w-s/2;o.fillStyle=f,o.globalAlpha=.4+.6*t,l>0?(o.beginPath(),o.roundRect(a,i,n,s,l),o.fill()):o.fillRect(a,i,n,s)}}else for(let e=0;e<y&&e<C.current.length;e++){const t=C.current.length-1-e,r=C.current[t]||.1,a=h.width-(e+1)*v,s=Math.max(4,r*h.height*.8),i=w-s/2;o.fillStyle=f,o.globalAlpha=.4+.6*r,l>0?(o.beginPath(),o.roundRect(a,i,n,s,l),o.fill()):o.fillRect(a,i,n,s)}if(c&&d>0&&h.width>0){if(!I.current||z.current!==h.width){const e=o.createLinearGradient(0,0,h.width,0),t=Math.min(.3,d/h.width);e.addColorStop(0,"rgba(255,255,255,1)"),e.addColorStop(t,"rgba(255,255,255,0)"),e.addColorStop(1-t,"rgba(255,255,255,0)"),e.addColorStop(1,"rgba(255,255,255,1)"),I.current=e,z.current=h.width}o.globalCompositeOperation="destination-out",o.fillStyle=I.current,o.fillRect(0,0,h.width,h.height),o.globalCompositeOperation="source-over"}o.globalAlpha=1,a=requestAnimationFrame(u)};return a=requestAnimationFrame(u),()=>{a&&cancelAnimationFrame(a)}},[e,t,p,b,g,n,s,l,i,c,d,x]),a.jsxs("div",{className:m("relative h-full w-full",k),ref:_,style:{height:q},"aria-label":e?"Live audio waveform":t?"Processing audio":"Audio waveform idle",role:"img",...j,children:[!e&&!t&&a.jsx("div",{className:"border-muted-foreground/20 absolute top-1/2 right-0 left-0 -translate-y-1/2 border-t-2 border-dotted"}),a.jsx("canvas",{className:"block h-full w-full",ref:S,"aria-hidden":"true"})]})},Tt=()=>{var e;const t=b(),o=t.testId||t.testName,n=x(),{profile:s}=v(),{toast:l}=y(),i=w(),[c,d]=r.useState(null),[u,m]=r.useState([]),[p,h]=r.useState(1),[f,g]=r.useState(0),[pe,he]=r.useState(!0),[fe,ge]=r.useState(!1),[be,xe]=r.useState(!1),[ve,ye]=r.useState(!1),[we,ke]=r.useState(null),[je,Se]=r.useState(null),[_e,Ce]=r.useState(0),[Ne,Ee]=r.useState(60),[Pe,Te]=r.useState({}),[Re,Me]=r.useState("");r.useState(!1),r.useState("");const[Ae,Le]=r.useState(!1),[$e,De]=r.useState("en");r.useEffect(()=>{(async()=>{if(null==s?void 0:s.id)try{const{data:e}=await Z.from("user_preferences").select("preferred_feedback_language, native_language").eq("user_id",s.id).maybeSingle(),t=e,r=(null==t?void 0:t.preferred_feedback_language)||(null==t?void 0:t.native_language);r&&te.find(e=>e.value===r)&&De(r)}catch(e){console.warn("Error loading user preferred language:",e)}})()},[null==s?void 0:s.id]);const[Ie,ze]=r.useState(!1),[qe,Be]=r.useState(!1),[Fe,Ue]=r.useState(!1),[He,We]=r.useState(!1),[Oe,Ye]=r.useState(!1),[Xe,Ve]=r.useState([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}]),[Ke,Ge]=r.useState(""),[Qe,Je]=r.useState(!1),Ze=r.useRef(null),et=r.useRef(null),tt=r.useRef(null),rt=r.useRef([]),ot=r.useRef(null),nt=r.useRef(null),at=(()=>{try{const e="undefined"!=typeof window?window.localStorage.getItem("appAudioVolume"):null,t=(e?parseInt(e,10):100)/100;return Number.isFinite(t)?Math.min(1,Math.max(0,t)):1}catch{return 1}})(),st=r.useRef(at);r.useEffect(()=>(o?(lt(),Ve([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}])):it(),()=>{tt.current&&clearInterval(tt.current)}),[o]),r.useEffect(()=>(_e>0?tt.current=setTimeout(()=>Ce(_e-1),1e3):0===_e&&fe&&dt(),()=>{tt.current&&clearTimeout(tt.current)}),[_e,fe]),r.useEffect(()=>{const e=e=>{var t;const r=null==(t=null==e?void 0:e.detail)?void 0:t.volume;"number"==typeof r&&(st.current=r,et.current&&(et.current.volume=r))};return window.addEventListener("app:volume-change",e),()=>window.removeEventListener("app:volume-change",e)},[]),r.useEffect(()=>{Xe.length>0&&setTimeout(()=>{const e=document.querySelector("[data-conversation-content]");e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},100)},[Xe]),r.useEffect(()=>{Ue(!1)},[f,p]),r.useEffect(()=>{if(ot.current){const e=ot.current;e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("transition","none","important");const t=t=>{e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("box-shadow","0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1)","important"),e.style.setProperty("transition","none","important")};return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",t),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",t)}}},[c,p,f]);const lt=async()=>{if(o){he(!0);try{console.log(`üîç Loading speaking test data for test ID: ${o}`);const e=o.includes("-")&&36===o.length,[t,r]=await Promise.all([e?Z.from("tests").select("id, test_name").eq("id",o).single():Z.from("tests").select("id, test_name").eq("test_name",o).eq("test_type","IELTS").eq("module","Speaking").maybeSingle(),Z.from("speaking_prompts").select("*").eq("test_id",o).order("part_number",{ascending:!0})]);if(t.error)throw t.error;const a=t.data;if(!a)return l({title:"Test Not Found",description:"This speaking test doesn't exist. Please check the test ID.",variant:"destructive"}),void n(-1);console.log("‚úÖ Test loaded:",a.test_name);let s=r.data||[];if(0===s.length&&a.id!==o){const{data:e}=await Z.from("speaking_prompts").select("*").eq("test_id",a.id).order("part_number",{ascending:!0});s=e||[]}console.log(`üìù Loaded ${s.length} total speaking prompts`);const i=[];let c=null;const u=[];s.forEach(e=>{1===e.part_number?i.push(e):2===e.part_number?c=e:3===e.part_number&&u.push(e)}),d({id:a.id,test_name:a.test_name,part1_prompts:i,part2_prompt:c,part3_prompts:u}),console.log(`‚úÖ Test ready: Part 1 (${i.length}), Part 2 (${c?1:0}), Part 3 (${u.length})`)}catch(e){console.error("‚ùå Error:",e),o&&d({id:o,test_name:"Speaking Test",part1_prompts:[],part2_prompt:null,part3_prompts:[]})}finally{he(!1)}}},it=async()=>{he(!0);try{console.log("üìã Loading available speaking tests...");const[e,t]=await Promise.all([Z.from("tests").select("id, test_name, module, skill_category, created_at").eq("test_type","IELTS").or("module.ilike.Speaking,skill_category.ilike.Speaking").order("created_at",{ascending:!1}).limit(100),Z.from("speaking_prompts").select("test_id").limit(1e3)]);if(e.error)throw console.error("‚ùå Error loading tests:",e.error),e.error;const r=e.data||[],o=t.data||[],n=new Set(o.map(e=>e.test_id)),a=new Set,s=new Set,l=new Set(["test ?","another test?",""]),i=r.filter(e=>{if(!e.id||a.has(e.id))return!1;if(!n.has(e.id))return!1;const t=(e.test_name||"").trim();if(!t||t.length<2)return!1;if(l.has(t))return!1;if(t.toLowerCase().includes("quick test"))return!1;const r=t.toLowerCase();return!s.has(r)&&(a.add(e.id),s.add(r),!0)});console.log(`‚úÖ Found ${i.length} valid speaking tests`),m(i)}catch(e){console.error("‚ùå Error loading tests:",e),l({title:"Error",description:"Failed to load available speaking tests",variant:"destructive"}),m([])}finally{he(!1)}},ct=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),r=e.createOscillator(),o=e.createGain();t.type="sine",t.frequency.value=523,r.type="sine",r.frequency.value=659,t.connect(o),r.connect(o),o.connect(e.destination),o.gain.setValueAtTime(1e-4,e.currentTime),o.gain.exponentialRampToValueAtTime(.05,e.currentTime+.01),t.start(),r.start(),setTimeout(()=>{o.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{t.stop(),r.stop(),e.close()},200)},120)}catch{}},dt=()=>{if(2===p&&nt.current){const e=Math.floor((Date.now()-nt.current)/1e3),t=60;if(e<t){const r=t-e;return void l({title:"Minimum Recording Time Required",description:`For IELTS Part 2, you should speak for at least 1 minute to receive a good score. Please continue recording for ${r} more second${1!==r?"s":""}.`,variant:"destructive",duration:5e3})}}ct(),Ze.current&&fe&&(Ze.current.stop(),ge(!1),Ce(0),nt.current=null)},ut=()=>{if(je)try{je.pause(),je.currentTime=0,console.log("üõë Stopped recording playback")}catch(e){console.error("Error stopping recording playback:",e)}ye(!1),ke(null),Se(null)},mt=()=>{if(1===p)if(f<((null==c?void 0:c.part1_prompts.length)||0)-1)g(f+1),console.log(`‚û°Ô∏è Moving to Part 1, Question ${f+2}`);else{const e=!!(null==c?void 0:c.part2_prompt),t=!!((null==c?void 0:c.part3_prompts)&&c.part3_prompts.length>0);e||t?e?(h(2),g(0),Ee(60),console.log("‚û°Ô∏è Moving to Part 2 - Long Turn"),pt()):t&&(h(3),g(0),console.log("‚û°Ô∏è Moving to Part 3 - Discussion (no Part 2 for this test)")):(console.log("üèÅ Part 1-only test completed - prompting for feedback language (AI analysis after Part 1)."),Le(!0))}else 2===p?(null==c?void 0:c.part3_prompts)&&c.part3_prompts.length>0?(h(3),g(0),console.log("‚û°Ô∏è Moving to Part 3 - Discussion")):(console.log("üèÅ Part 2 completed - no Part 3 available, prompting for feedback language"),Le(!0)):3===p&&(f<((null==c?void 0:c.part3_prompts.length)||0)-1?(g(f+1),console.log(`‚û°Ô∏è Moving to Part 3, Question ${f+2}`)):(console.log("üèÅ Last question completed - prompting for feedback language"),Le(!0)))},pt=()=>{const e=setInterval(()=>{Ee(t=>t<=1?(clearInterval(e),l({title:"Preparation Time Complete",description:"You may now start recording your response.",duration:5e3}),0):t-1)},1e3)},ht=e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;if(pe)return a.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"dark"===i.theme.name?i.theme.colors.background:"transparent"},children:a.jsx(k,{size:"lg",message:"Loading speaking tests..."})});if(!o)return a.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===i.theme.name?i.theme.colors.background:"transparent"},children:[a.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===i.theme.name||"minimalist"===i.theme.name||"dark"===i.theme.name?"none":"url('https://raw.githubusercontent.com/AlfieAlfiegithu2/alfie-ai-coach/main/public/1000031207.png')",backgroundColor:i.backgroundImageColor}}),a.jsx("div",{className:"relative z-10",children:a.jsx(j,{title:"Available Speaking Tests",children:a.jsx("div",{className:"min-h-screen py-12",children:a.jsx("div",{className:"container mx-auto px-4",children:a.jsxs("div",{className:"max-w-4xl mx-auto",children:[a.jsx("div",{className:"mb-8 text-center",children:a.jsx("h1",{className:"text-4xl font-bold mb-2",style:{color:i.textPrimary},children:"IELTS speaking tests"})}),u.length>0?a.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:u.map(e=>a.jsx(S,{className:"cursor-pointer h-[140px] hover:scale-105 transition-all duration-300 hover:shadow-lg flex items-center justify-center",onClick:()=>n(`/ielts-speaking-test/${e.id}`),style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.8)":"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,borderColor:i.border,...i.cardStyle},children:a.jsx(_,{className:"p-3 md:p-4 text-center flex items-center justify-center h-full",children:a.jsx("h3",{className:"font-semibold text-sm",style:{color:i.textPrimary},children:e.test_name})})},e.id))}):a.jsxs("div",{className:"text-center py-12",children:[a.jsx("p",{className:"text-lg mb-4",style:{color:i.textSecondary},children:"No speaking tests available yet"}),a.jsx(C,{onClick:()=>n("/ielts-portal"),variant:"outline",style:{borderColor:i.border,color:i.textPrimary,backgroundColor:"glassmorphism"===i.theme.name||"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground},onMouseEnter:e=>e.currentTarget.style.backgroundColor=i.hoverBg,onMouseLeave:e=>e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name||"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,children:"Back to Portal"})]})]})})})})})]});if(!c)return a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-lg text-muted-foreground",children:"Test not found"}),a.jsx(C,{onClick:()=>n("/ielts-portal"),className:"mt-4",children:"Back to Portal"})]})});if(0===c.part1_prompts.length&&!c.part2_prompt&&0===c.part3_prompts.length)return a.jsx(j,{title:`IELTS Speaking - ${c.test_name}`,showBackButton:!0,children:a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[a.jsxs("div",{className:"text-center",children:[a.jsx(N,{variant:"outline",className:"mb-4 px-4 py-1 text-primary border-primary/20",children:"IELTS SPEAKING TEST"}),a.jsx("h1",{className:"text-heading-2 mb-2",children:c.test_name})]}),a.jsx(E,{className:"card-modern",children:a.jsxs(_,{className:"p-8 text-center",children:[a.jsx(P,{className:"w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-500"}),a.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Speaking Content Available"}),a.jsx("p",{className:"text-muted-foreground mb-6",children:"This test doesn't have speaking content created yet. Please contact your administrator or try another test."}),a.jsxs("div",{className:"flex gap-4 justify-center",children:[a.jsx(C,{onClick:()=>n("/ielts-portal"),variant:"outline",children:"Back to Portal"}),a.jsx(C,{onClick:()=>n("/speaking"),children:"Try General Speaking Practice"})]})]})})]})});const ft=()=>1===p?c.part1_prompts[f]:2===p?c.part2_prompt:3===p?c.part3_prompts[f]:null,gt=()=>{const e=ft();return e?2===p?e.prompt_text||"":e.transcription||e.title||"":""},bt=async e=>{const t=e||Ke.trim();if(!t||Qe)return;const r={id:Date.now().toString(),type:"user",content:t,timestamp:new Date};Ve(e=>[...e,r]),e||Ge(""),Je(!0);try{const e=gt(),r=`CONTEXT: The student is practicing IELTS Speaking Part ${p}.\n\nQuestion: "${e}"\n\nPlease provide concise, practical speaking guidance (ideas, vocabulary, structure). Do NOT write a full answer.`,o=Xe.filter(e=>"user"===e.type||"bot"===e.type).map(e=>({role:"user"===e.type?"user":"assistant",content:e.content}));o.push({role:"user",content:t});const{data:n,error:a}=await Z.functions.invoke("openai-chat",{body:{skipCache:!0,messages:[{role:"system",content:r},...o],context:"catbot"}});if(a)throw a;const s={id:(Date.now()+1).toString(),type:"bot",content:n.response,timestamp:new Date};Ve(e=>[...e,s])}catch(o){console.error("Error sending chat message:",o),l({title:"Error",description:"Failed to get response from Catie",variant:"destructive"})}finally{Je(!1)}},xt=e=>{bt(e)},vt=ft(),yt=gt(),wt=1===p?"Part 1":2===p?"Part 2":3===p?"Part 3":"Unknown Part";return a.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===i.theme.name?i.theme.colors.background:"transparent"},children:[a.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===i.theme.name||"minimalist"===i.theme.name||"dark"===i.theme.name?"none":"url('https://raw.githubusercontent.com/AlfieAlfiegithu2/alfie-ai-coach/main/public/1000031207.png')",backgroundColor:i.backgroundImageColor}}),a.jsx("div",{className:"relative z-10 min-h-screen flex flex-col",style:{backgroundColor:"dark"===i.theme.name?i.theme.colors.background:"transparent"},children:a.jsx(j,{title:`IELTS Speaking - ${c.test_name}`,showBackButton:!0,children:a.jsx("div",{className:"flex-1 flex justify-center min-h-[calc(100vh-120px)] py-8 sm:items-center sm:py-8",children:a.jsxs("div",{className:"w-full max-w-4xl mx-auto space-y-4 px-4 flex flex-col",children:[a.jsx("div",{className:"text-center py-2 sm:py-2 sm:mb-0 mb-0",children:a.jsxs("span",{className:"text-lg font-semibold",style:{color:i.textPrimary},children:["Part ",p]})}),a.jsxs(E,{ref:ot,className:"backdrop-blur-sm shadow-lg rounded-2xl flex flex-col relative",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,borderColor:i.border,backdropFilter:"glassmorphism"===i.theme.name?"blur(12px)":"dark"===i.theme.name?"blur(8px)":"none",boxShadow:"dark"===i.theme.name?"0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1)":"note"===i.theme.name?null==(e=i.theme.styles.cardStyle)?void 0:e.boxShadow:"0 8px 32px rgba(15, 23, 42, 0.16), 0 0 0 1px rgba(148, 163, 253, 0.06)",...i.cardStyle},children:[a.jsx(T,{children:a.jsxs(R,{className:"flex items-center justify-between",children:[a.jsx("span",{}),a.jsxs("div",{className:"flex items-center gap-3",children:[(1===p||3===p)&&a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx("div",{onClick:()=>Ue(!Fe),className:"relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background",style:{backgroundColor:Fe?i.buttonPrimary:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.2)":"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#e5e7eb":i.border},"data-state":Fe?"checked":"unchecked",children:a.jsx("div",{className:"pointer-events-none flex h-5 w-5 rounded-full shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0 items-center justify-center",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.95)":"dark"===i.theme.name?"rgba(255,255,255,0.9)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground},"data-state":Fe?"checked":"unchecked",children:Fe?a.jsx($,{className:"w-3 h-3",style:{color:"white"}}):a.jsx(D,{className:"w-3 h-3",style:{color:i.textSecondary}})})})}),a.jsx(I,{children:a.jsx("p",{children:Fe?"Hide question":"Show question"})})]})}),_e>0&&a.jsxs(N,{variant:"outline",className:"flex items-center gap-2",style:{borderColor:i.border,backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,color:i.textPrimary},children:[a.jsx(z,{className:"w-4 h-4",style:{color:i.textPrimary}}),ht(_e)]})]})]})}),a.jsxs(_,{className:"space-y-4 flex flex-col relative",children:[2===p&&Ne>0&&a.jsx("div",{className:"text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-2",children:[a.jsx(z,{className:"w-5 h-5",style:{color:i.buttonPrimary}}),a.jsx("p",{className:"text-xl font-bold",style:{color:i.buttonPrimary},children:ht(Ne)})]})}),1===p&&c.part1_prompts.length>0&&a.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:a.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:Fe&&a.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:i.textPrimary},children:gt()})})}),3===p&&c.part3_prompts.length>0&&a.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:a.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:Fe&&a.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:i.textPrimary},children:gt()})})}),2===p&&vt&&a.jsxs("div",{className:"p-6 rounded-lg",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:i.border,borderWidth:"1px",borderStyle:"solid"},children:[a.jsx("h3",{className:"font-semibold mb-3",style:{color:i.textPrimary},children:"Cue Card"}),a.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",style:{color:i.textSecondary},children:vt.prompt_text})]}),2===p&&a.jsxs(a.Fragment,{children:[Ne>0&&a.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#fef3c7":"#FEF9E7",borderColor:i.border,borderWidth:"1px",borderStyle:"solid"},children:[a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"ghost",size:"icon",onClick:()=>{Ee(e=>e+60)},className:"absolute top-2 right-2 h-8 w-8",style:{color:i.buttonPrimary},children:a.jsx(q,{className:"w-4 h-4"})})}),a.jsx(I,{children:a.jsx("p",{children:"Add 1 minute for notes"})})]})}),a.jsx("textarea",{placeholder:"Write your preparation notes here...",value:Re,onChange:e=>Me(e.target.value),className:"w-full h-32 p-3 bg-transparent resize-none focus:outline-none",style:{color:i.textPrimary}}),a.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      textarea[placeholder="Write your preparation notes here..."]::placeholder {\n                        color: ${i.textSecondary};\n                      }\n                    `}})]}),0===Ne&&Re&&a.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#fef3c7":"#FEF9E7",borderColor:i.border,borderWidth:"1px",borderStyle:"solid"},children:[!fe&&a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"ghost",size:"icon",onClick:()=>{Ee(60),pt()},className:"absolute top-2 right-2 h-8 w-8 text-primary",children:a.jsx(q,{className:"w-4 h-4"})})}),a.jsx(I,{children:a.jsx("p",{children:"Add 1 minute for notes"})})]})}),a.jsx("div",{className:"p-3 text-sm whitespace-pre-wrap",children:Re})]})]}),(2===p&&0===Ne||2!==p)&&a.jsx("div",{className:"text-center h-[80px] flex items-center justify-center relative",children:fe?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 w-[130px] sm:w-[180px]",children:a.jsx(Pt,{active:!0,height:55,barWidth:6,barGap:2,barRadius:3,mode:"static",fadeEdges:!1,barColor:"#2563eb",sensitivity:1.2,fftSize:256,historySize:60,updateRate:30})}),a.jsx(C,{onClick:dt,variant:"outline",size:"icon",className:"rounded-xl h-8 w-8 absolute bottom-0 left-1/2 transform -translate-x-1/2",style:{borderColor:i.border,color:i.buttonPrimary,backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},children:a.jsx(B,{className:"w-4 h-4",style:{color:i.buttonPrimary||"#2563eb"}})})]}):a.jsx(M,{children:a.jsxs("div",{className:"flex items-center justify-center gap-3",children:[a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{onClick:async()=>{try{ct(),await new Promise(e=>setTimeout(e,100));const e=await navigator.mediaDevices.getUserMedia({audio:!0});Ze.current=new MediaRecorder(e),rt.current=[],Ze.current.ondataavailable=e=>{e.data.size>0&&rt.current.push(e.data)},Ze.current.onstop=()=>{const t=new Blob(rt.current,{type:"audio/webm"}),r=`part${p}_q${f}`;console.log(`üíæ Saving recording for ${r}, blob size: ${t.size}`),Te(e=>{const o={...e,[r]:t};return console.log("üì± Recordings updated:",Object.keys(o)),o}),e.getTracks().forEach(e=>e.stop())},Ze.current.start(),ge(!0),nt.current=Date.now(),(1===p||3===p||2===p)&&Ce(120)}catch(e){console.error("Error starting recording:",e),l({title:"Recording Error",description:"Failed to start recording. Please check microphone permissions.",variant:"destructive"})}},variant:"outline",className:"rounded-xl shadow-sm h-12 w-12",size:"icon",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.8)":"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,borderColor:i.border,color:i.textPrimary},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg,e.currentTarget.style.color=i.buttonPrimary},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.8)":"dark"===i.theme.name?"rgba(255,255,255,0.1)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,e.currentTarget.style.color=i.textPrimary},children:a.jsx(P,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:"Start recording your answer"})})]}),(null==vt?void 0:vt.audio_url)&&a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{onClick:()=>{const e=ft();(null==e?void 0:e.audio_url)&&(console.log(`üîÅ Repeating audio for Part ${p}`),(async e=>{var t;if(e){He||(We(!0),Ye(!1));try{xe(!0),et.current&&(et.current.pause(),et.current.currentTime=0,et.current=null);const t=new Audio(e);t.preload="auto",t.volume=st.current,t.onended=()=>{xe(!1),console.log("‚úÖ Audio playback completed"),et.current=null},t.onerror=e=>{xe(!1),console.error("Audio playback error:",e),et.current=null,l({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable.",variant:"destructive"})},t.onloadstart=()=>{console.log("Audio loading started")},t.oncanplay=()=>{console.log("Audio can play")},t.oncanplaythrough=()=>{console.log("Audio can play through")},et.current=t,console.log(`‚ñ∂Ô∏è Playing audio: ${e}`),t.load(),await new Promise(e=>setTimeout(e,100));const r=t.play();void 0!==r&&(await r,console.log("Audio started playing successfully"))}catch(r){console.error("Error playing audio:",r),xe(!1),"NotAllowedError"===r.name||(null==(t=r.message)?void 0:t.includes("user didn't interact"))?(He||Ye(!0),console.log("Autoplay blocked - user needs to interact first")):l({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable. Please try again.",variant:"destructive"}),et.current&&(et.current=null)}}})(e.audio_url))},disabled:be,variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:i.border,color:i.buttonPrimary,backgroundColor:"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:be?a.jsx(F,{className:"w-5 h-5"}):a.jsx(U,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:be?"Pause question audio":"Play question audio"})})]}),Pe[`part${p}_q${f}`]&&a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{onClick:()=>{ve&&we===`part${p}_q${f}`?ut():(async e=>{const t=Pe[e];if(t)try{je&&ut();const r=URL.createObjectURL(t),o=new Audio(r);o.volume=st.current,Se(o),o.onended=()=>{URL.revokeObjectURL(r),ye(!1),ke(null),Se(null),console.log(`‚úÖ Recording playback ended: ${e}`)},o.onerror=()=>{URL.revokeObjectURL(r),ye(!1),ke(null),Se(null),console.error(`‚ùå Recording playback error: ${e}`),l({title:"Playback Error",description:"Failed to play your recording. The audio may be inaudible or corrupted.",variant:"destructive"})},await o.play(),ye(!0),ke(e),console.log(`üéµ Started recording playback: ${e}`)}catch(r){console.error("Error playing recording:",r),ye(!1),ke(null),Se(null),l({title:"Playback Error",description:"Failed to play your recording",variant:"destructive"})}})(`part${p}_q${f}`)},variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:i.border,color:i.buttonPrimary,backgroundColor:"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:ve&&we===`part${p}_q${f}`?a.jsx(F,{className:"w-5 h-5"}):a.jsx(H,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:ve&&we===`part${p}_q${f}`?"Stop listening to your recording":"Listen to your recorded answer"})})]})]})})}),Ae&&a.jsx("div",{className:"flex justify-center mt-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs(W,{value:$e,onValueChange:De,children:[a.jsx(O,{className:"w-[90px] h-8 text-sm border-0 bg-transparent shadow-none p-0 focus:ring-0",style:{color:i.textPrimary,"--tw-ring-color":i.buttonPrimary},children:a.jsx(Y,{placeholder:"Language"})}),a.jsx(X,{children:te.map(e=>a.jsx(V,{value:e.value,children:e.label},e.value))})]}),a.jsx(C,{type:"button",onClick:()=>{try{localStorage.setItem("ielts_speaking_feedback_language",$e||"en")}catch(e){console.warn("Unable to persist feedback language preference",e)}(async()=>{var e,t,r,o,a,s;try{const d=Object.entries(Pe);if(0===d.length)return void l({title:"No recordings found",description:"Please record answers before submitting.",variant:"destructive"});console.log("üìù Preparing speaking uploads:",{count:d.length,keys:d.map(([e])=>e)});const u=d.map(async([e,t],r)=>{var o,n,a,s,i,u,m,p,h,f,g,b,x,v,y,w;const k=(null==c?void 0:c.id)||"unknown",j=Date.now(),S=`speaking_${k}_${e}_${j}.webm`,_=new File([t],S,{type:"audio/webm"});try{console.log(`üì§ Uploading speaking recording [${r+1}/${d.length}]:`,{fileName:S,key:e,size:t.size});const l=await ee.uploadSpeaking(_,k,e);if(!l.success)throw console.error(`‚ùå R2 upload reported failure for ${S}:`,l.error),new Error(l.error||"Upload failed");l.url||console.warn(`‚ö†Ô∏è R2 upload returned success but no URL for ${S}. Falling back to deterministic URL.`);const h=l.url||`https://placeholder-r2/${k}/speaking/${encodeURIComponent(e)}/${j}.webm`;console.log(`‚úÖ Speaking recording uploaded successfully: ${h}`);let f="";const g=e.match(/^part(\d+)_q(\d+)$/);if(g){const e=parseInt(g[1],10),t=parseInt(g[2],10);1===e&&(null==(o=null==c?void 0:c.part1_prompts)?void 0:o[t])?f=(null==(n=c.part1_prompts[t])?void 0:n.prompt_text)||(null==(a=c.part1_prompts[t])?void 0:a.transcription)||(null==(s=c.part1_prompts[t])?void 0:s.title)||"":2===e&&(null==c?void 0:c.part2_prompt)?f=c.part2_prompt.prompt_text||c.part2_prompt.transcription||c.part2_prompt.title||"":3===e&&(null==(i=null==c?void 0:c.part3_prompts)?void 0:i[t])&&(f=(null==(u=c.part3_prompts[t])?void 0:u.prompt_text)||(null==(m=c.part3_prompts[t])?void 0:m.transcription)||(null==(p=c.part3_prompts[t])?void 0:p.title)||"")}return{part:e,audio_url:h,question_text:f,upload_error:!1}}catch(C){const t=(null==C?void 0:C.message)||("string"==typeof C?C:"Unknown upload error");console.error(`‚ùå Hard failure uploading ${S}:`,t),l({title:"Upload Warning",description:`We could not upload your recording for ${e}. We will still save your test and run analysis using available audio.`,variant:"destructive"});const r=`https://mock-r2-fallback.local/speaking/${encodeURIComponent(k)}/${encodeURIComponent(e)}/${j}.webm`;let o="";const n=e.match(/^part(\d+)_q(\d+)$/);if(n){const e=parseInt(n[1],10),t=parseInt(n[2],10);1===e&&(null==(h=null==c?void 0:c.part1_prompts)?void 0:h[t])?o=(null==(f=c.part1_prompts[t])?void 0:f.prompt_text)||(null==(g=c.part1_prompts[t])?void 0:g.transcription)||(null==(b=c.part1_prompts[t])?void 0:b.title)||"":2===e&&(null==c?void 0:c.part2_prompt)?o=c.part2_prompt.prompt_text||c.part2_prompt.transcription||c.part2_prompt.title||"":3===e&&(null==(x=null==c?void 0:c.part3_prompts)?void 0:x[t])&&(o=(null==(v=c.part3_prompts[t])?void 0:v.prompt_text)||(null==(y=c.part3_prompts[t])?void 0:y.transcription)||(null==(w=c.part3_prompts[t])?void 0:w.title)||"")}return{part:e,audio_url:r,question_text:o,upload_error:!0,error_message:t}}}),m=await Promise.all(u);if(!m||0===m.length)return console.error("‚ùå No speaking upload results returned"),void l({title:"Upload error",description:"We could not process your recordings. Please try again.",variant:"destructive"});const p=m.filter(e=>!e.upload_error).length,h=m.filter(e=>e.upload_error).length;console.log("üìä Speaking upload summary:",{total:m.length,successfulCount:p,failedCount:h});try{const{data:{user:l}}=await Z.auth.getUser();if(!l)throw new Error("User not authenticated while submitting speaking test");const i=m.map(e=>e.audio_url),{data:u,error:f}=await Z.from("test_results").insert({user_id:l.id,test_type:"speaking",total_questions:m.length,correct_answers:null,score_percentage:0,time_taken:900,audio_urls:i,audio_retention_expires_at:null,test_data:{recordings_count:m.length,parts_completed:[1,2,3],r2_upload_summary:{total:m.length,successful:p,failed:h},retention_policy:"no_auto_expiry_r2_persistent"}}).select().single();if(f||!u)throw f||new Error("Failed to create speaking test result");console.log("‚úÖ Speaking test base records saved. AI scoring will be handled by backend using stored metadata and URLs.");const g=[];for(const n of m){const i=n.part.match(/^part(\d+)/),d=i?parseInt(i[1],10):NaN;if(isNaN(d)||d<1||d>3){console.error(`Invalid part number for recording: ${n.part}`);continue}let m="";if(1===d&&(null==(e=null==c?void 0:c.part1_prompts)?void 0:e.length)){const e=n.part.match(/_q(\d+)/),o=e?parseInt(e[1],10):0;o>=0&&o<c.part1_prompts.length&&(m=(null==(t=c.part1_prompts[o])?void 0:t.prompt_text)||(null==(r=c.part1_prompts[o])?void 0:r.transcription)||"")}else if(2===d&&(null==c?void 0:c.part2_prompt))m=c.part2_prompt.prompt_text||"";else if(3===d&&(null==(o=null==c?void 0:c.part3_prompts)?void 0:o.length)){const e=n.part.match(/_q(\d+)/),t=e?parseInt(e[1],10):0;t>=0&&t<c.part3_prompts.length&&(m=(null==(a=c.part3_prompts[t])?void 0:a.prompt_text)||(null==(s=c.part3_prompts[t])?void 0:s.transcription)||"")}g.push({user_id:l.id,test_result_id:u.id,part_number:d,question_text:m,audio_url:n.audio_url,transcription:"",band_scores:{},detailed_feedback:"",duration_seconds:120})}const{error:b}=await Z.from("speaking_test_results").insert(g);if(b)throw b;console.log("‚úÖ Speaking test base records saved. Running AI scoring..."),console.log("‚ÑπÔ∏è Skipping inline AI scoring for speaking test; base records saved for backend evaluation."),Te({}),n("/ielts-speaking-results",{state:{testData:c,recordings:m,audioBlobs:Object.fromEntries(d),testResultId:u.id}})}catch(i){console.error("Error saving or scoring speaking results:",i),l({title:"Save error",description:"Failed to save or score speaking results. Your recordings may not be fully processed.",variant:"destructive"})}}catch(d){console.error("Error submitting test:",d),l({title:"Submission Error",description:"Failed to submit test. Please try again.",variant:"destructive"})}})()},className:"font-medium",style:{backgroundColor:i.buttonPrimary,color:"#ffffff"},children:"Submit"})]})}),(1===p||3===p)&&!Ae&&a.jsx(M,{children:a.jsxs(a.Fragment,{children:[a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"ghost",onClick:()=>{f>0&&(g(f-1),Ue(!1))},disabled:0===f,size:"icon",className:"absolute bottom-0 left-0 h-12 w-12",style:{color:i.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=i.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=i.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:a.jsx(K,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:"Previous question"})})]}),a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"ghost",onClick:()=>{Ue(!1),mt()},disabled:void 0===Pe[`part${p}_q${f}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12",style:{color:i.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=i.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=i.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:a.jsx(G,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:void 0===Pe[`part${p}_q${f}`]?"Please record your answer first":f!==((null==c?void 0:c.part1_prompts.length)||0)-1||1!==p||(null==c?void 0:c.part2_prompt)||(null==c?void 0:c.part3_prompts)&&0!==c.part3_prompts.length?"Next question":"Complete test"})})]})]})}),2===p&&!Ae&&a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"ghost",onClick:()=>{mt()},disabled:void 0===Pe[`part${p}_q${f}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12 hover:bg-transparent hover:text-foreground",children:a.jsx(G,{className:"w-5 h-5"})})}),a.jsx(I,{children:a.jsx("p",{children:void 0===Pe[`part${p}_q${f}`]?"Please record your answer first":(null==c?void 0:c.part3_prompts)&&c.part3_prompts.length>0?"Go to Part 3":"Complete test"})})]})})]})]}),a.jsx("div",{className:"fixed bottom-6 left-6 z-40 flex items-center gap-4",children:a.jsx("button",{onClick:()=>n("/ielts-portal"),className:"text-lg cursor-pointer transition-colors",style:{color:i.textSecondary},onMouseEnter:e=>e.currentTarget.style.color=i.buttonPrimary,onMouseLeave:e=>e.currentTarget.style.color=i.textSecondary,children:"Exit Test"})}),Ie&&a.jsxs("div",{className:"fixed bottom-12 right-4 sm:bottom-20 sm:right-[420px] z-50 flex flex-col gap-2 sm:gap-3",children:[a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"outline",size:"icon",onClick:()=>xt("Help with Speaking Structure"),disabled:Qe,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:i.border||"#e5e7eb",backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff",color:i.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},children:a.jsx(me,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:i.buttonPrimary||"#2563eb"}})})}),a.jsx(I,{side:"left",children:a.jsx("p",{children:"Get help with speaking structure"})})]})}),a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"outline",size:"icon",onClick:()=>xt("Suggest Some Speaking Vocabulary"),disabled:Qe,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:i.border||"#e5e7eb",backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff",color:i.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},children:a.jsx(Q,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:i.buttonPrimary||"#2563eb"}})})}),a.jsx(I,{side:"left",children:a.jsx("p",{children:"Get vocabulary suggestions"})})]})}),a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"outline",size:"icon",onClick:()=>xt("Give me 2-3 straightforward band 7+ example answers for this exact IELTS Speaking question. Just show the actual answers, no explanations."),disabled:Qe,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:i.border||"#e5e7eb",backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff",color:i.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},children:a.jsx(de,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:i.buttonPrimary||"#2563eb"}})})}),a.jsx(I,{side:"left",children:a.jsx("p",{children:"View band 7+ example answers"})})]})}),a.jsx(M,{children:a.jsxs(A,{children:[a.jsx(L,{asChild:!0,children:a.jsx(C,{variant:"outline",size:"icon",onClick:()=>xt("Help me with grammar for this speaking question"),disabled:Qe,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:i.border||"#e5e7eb",backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff",color:i.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=i.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===i.theme.name?"rgba(255,255,255,0.9)":"dark"===i.theme.name?"rgba(255,255,255,0.15)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground||"#ffffff"},children:a.jsx(ue,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:i.buttonPrimary||"#2563eb"}})})}),a.jsx(I,{side:"left",children:a.jsx("p",{children:"Get grammar help"})})]})})]}),a.jsxs("div",{className:"fixed bottom-6 right-3 sm:bottom-6 sm:right-6 z-50",children:[Ie&&a.jsxs(E,{className:"backdrop-blur-md rounded-3xl w-[260px] h-[360px] sm:w-96 sm:h-[500px] shadow-2xl flex flex-col transform-gpu origin-bottom-right transition-all duration-260 ease-in-out "+(qe?"opacity-100 scale-100 translate-y-0":"opacity-0 scale-75 translate-y-8"),style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.95)":"dark"===i.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,borderColor:i.border,backdropFilter:"glassmorphism"===i.theme.name?"blur(12px)":"dark"===i.theme.name?"blur(8px)":"none",...i.cardStyle},children:[a.jsx(T,{className:"pb-1 sm:pb-2 rounded-t-3xl relative",children:a.jsx("div",{className:"absolute top-1.5 right-1.5 sm:top-2 sm:right-2",children:a.jsx(C,{variant:"ghost",size:"icon",onClick:()=>{Be(!1),setTimeout(()=>{ze(!1)},260)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:i.textPrimary},children:"‚úï"})})}),a.jsxs(_,{className:"flex-1 flex flex-col px-2.5 py-2 sm:p-4 overflow-hidden",children:[a.jsx(re,{className:"flex-1 min-h-0",children:a.jsx(oe,{className:"flex-1 min-h-0",children:0!==Xe.length||Qe?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"rounded-lg p-3 mb-4",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:i.border,borderWidth:"1px",borderStyle:"solid"},children:[a.jsx("div",{className:"text-xs uppercase tracking-wide mb-1",style:{color:i.textSecondary},children:"Question"}),a.jsx("div",{className:"text-xs sm:text-sm font-medium",style:{color:i.textPrimary},children:wt}),a.jsx("div",{className:"text-[10px] sm:text-sm whitespace-pre-wrap mt-1",style:{color:i.textSecondary},children:yt||"No question available."})]}),Xe.map(e=>a.jsxs(se,{from:"user"===e.type?"user":"assistant",children:["bot"===e.type&&a.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:a.jsx("img",{src:"https://raw.githubusercontent.com/AlfieAlfiegithu2/alfie-ai-coach/main/public/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})}),a.jsx(le,{children:a.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:i.border,borderWidth:"1px",borderStyle:"solid",color:i.textPrimary},children:a.jsx(ie,{dangerouslySetInnerHTML:{__html:e.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^‚Ä¢ (.*)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}})})}),"user"===e.type&&(null==s?void 0:s.avatar_url)&&a.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:a.jsx("img",{src:s.avatar_url,alt:"Your avatar",style:{width:"100%",height:"100%",objectFit:"cover"}})})]},e.id)),Qe&&a.jsxs(se,{from:"assistant",children:[a.jsx(le,{children:a.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:i.border,borderWidth:"1px",borderStyle:"solid"},children:a.jsx(ce,{text:"Thinking..."})})}),a.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px"},children:a.jsx("img",{src:"https://raw.githubusercontent.com/AlfieAlfiegithu2/alfie-ai-coach/main/public/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]}):a.jsx(ne,{icon:a.jsx(ae,{className:"size-9 sm:size-12",style:{color:i.textSecondary}}),title:"Start a conversation",description:"Ask for help with your IELTS speaking practice"})})}),a.jsx("div",{className:"flex-shrink-0 mt-2.5 sm:mt-4",children:a.jsxs("div",{className:"flex gap-1.5 sm:gap-2",children:[a.jsx("input",{type:"text",value:Ke,onChange:e=>Ge(e.target.value),onKeyPress:e=>"Enter"===e.key&&!Qe&&Ke.trim()&&bt(),placeholder:"Ask for speaking help...",className:"flex-1 px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg text-[10px] sm:text-sm focus:outline-none focus:ring-0 resize-none",style:{backgroundColor:"glassmorphism"===i.theme.name?"rgba(255,255,255,0.1)":"dark"===i.theme.name?"rgba(255,255,255,0.05)":"minimalist"===i.theme.name?"#ffffff":i.theme.colors.cardBackground,borderColor:i.border,borderWidth:"1px",borderStyle:"solid",color:i.textPrimary},disabled:Qe}),a.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      input[placeholder="Ask for speaking help..."]::placeholder {\n                        color: ${i.textSecondary};\n                      }\n                    `}}),a.jsx(C,{onClick:()=>bt(),disabled:Qe||!Ke.trim(),variant:"ghost",size:"icon",className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:i.textPrimary},children:Qe?a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2",style:{borderColor:i.textPrimary}}):a.jsx(J,{className:"w-4 h-4"})})]})})]})]}),!Ie&&a.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"64px",height:"64px",cursor:"pointer",boxShadow:"0 8px 20px rgba(0,0,0,0.18)",transition:"transform 0.22s ease-out, box-shadow 0.22s ease-out"},onClick:()=>{ze(!0),requestAnimationFrame(()=>Be(!0))},onMouseEnter:e=>{const t=e.currentTarget;t.style.transform="scale(1.06) translateY(-2px)",t.style.boxShadow="0 14px 30px rgba(0,0,0,0.24)"},onMouseLeave:e=>{const t=e.currentTarget;t.style.transform="scale(1.0) translateY(0px)",t.style.boxShadow="0 10px 25px rgba(0,0,0,0.15)"},children:a.jsx("img",{src:"https://raw.githubusercontent.com/AlfieAlfiegithu2/alfie-ai-coach/main/public/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]})})})})]})};export{Tt as default};
