import{c as e,bH as t,bI as r,bJ as n,bK as a,bL as o,bM as s,bN as i,bO as l,bP as c,bQ as d,bR as u,bS as m,bT as p,bU as h,r as f,bV as g,bW as b,bX as y,bY as x,bE as v,bZ as j,b_ as k,b$ as w,c0 as N,c1 as P,c2 as C,j as S,by as _,aA as E,G as O,u as A,ae as T,h as M,a1 as R,bF as L,aa as I,ad as $,a as F,B,l as q,C as D,M as z,b as U,d as W,aJ as V,bv as G,bw as H,E as K,N as Y,bx as Q,W as Z,P as J,c3 as X,Y as ee,Z as te,V as re,O as ne,X as ae,F as oe,z as se,an as ie,S as le,p as ce,q as de,s as ue,t as me,ar as pe,c4 as he,e as fe,a0 as ge}from"./index-CgS2SMUD.js";import{S as be}from"./separator-oV_khGX1.js";import"./scroll-area-C6t7Z38y.js";import{C as ye}from"./CustomAudioPlayer-CZJEbjob.js";import{g as xe,s as ve}from"./supabase-DWL4C3fA.js";import{A as je}from"./cloudflare-r2-Bg99fdQ0.js";import"./slider-CFndXLwZ.js";import"./dropdown-menu-BZ17Uruj.js";import{C as ke,a as we,b as Ne,O as Pe,M as Ce,c as Se,R as _e,S as Ee}from"./shimmering-text-DlPBOnth.js";import{F as Oe}from"./languages-CfEi4KMq.js";import{C as Ae}from"./circle-alert-wejo28ip.js";import"./volume-x-4lFbfTaL.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=e("ListTree",[["path",{d:"M21 12h-8",key:"1bmf0i"}],["path",{d:"M21 6H8",key:"1pqkrb"}],["path",{d:"M21 18h-8",key:"1tm79t"}],["path",{d:"M3 6v4c0 1.1.9 2 2 2h3",key:"1ywdgy"}],["path",{d:"M3 10v6c0 1.1.9 2 2 2h3",key:"2wc746"}]]);var Me=["points","className","baseLinePoints","connectNulls"];function Re(){return Re=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},Re.apply(this,arguments)}function Le(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function Ie(e){return function(e){if(Array.isArray(e))return $e(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return $e(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return $e(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $e(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Fe=function(e){return e&&e.x===+e.x&&e.y===+e.y},Be=function(e,t){var r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[[]];return e.forEach(function(e){Fe(e)?t[t.length-1].push(e):t[t.length-1].length>0&&t.push([])}),Fe(e[0])&&t[t.length-1].push(e[0]),t[t.length-1].length<=0&&(t=t.slice(0,-1)),t}(e);t&&(r=[r.reduce(function(e,t){return[].concat(Ie(e),Ie(t))},[])]);var n=r.map(function(e){return e.reduce(function(e,t,r){return"".concat(e).concat(0===r?"M":"L").concat(t.x,",").concat(t.y)},"")}).join("");return 1===r.length?"".concat(n,"Z"):n},qe=function(e){var a=e.points,o=e.className,s=e.baseLinePoints,i=e.connectNulls,l=Le(e,Me);if(!a||!a.length)return null;var c=t("recharts-polygon",o);if(s&&s.length){var d=l.stroke&&"none"!==l.stroke,u=function(e,t,r){var n=Be(e,r);return"".concat("Z"===n.slice(-1)?n.slice(0,-1):n,"L").concat(Be(t.reverse(),r).slice(1))}(a,s,i);return r.createElement("g",{className:c},r.createElement("path",Re({},n(l,!0),{fill:"Z"===u.slice(-1)?l.fill:"none",stroke:"none",d:u})),d?r.createElement("path",Re({},n(l,!0),{fill:"none",d:Be(a,i)})):null,d?r.createElement("path",Re({},n(l,!0),{fill:"none",d:Be(s,i)})):null)}var m=Be(a,i);return r.createElement("path",Re({},n(l,!0),{fill:"Z"===m.slice(-1)?l.fill:"none",className:c,d:m}))},De=["cx","cy","innerRadius","outerRadius","gridType","radialLines"];function ze(e){return(ze="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ue(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function We(){return We=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},We.apply(this,arguments)}function Ve(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ge(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ve(Object(r),!0).forEach(function(t){He(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ve(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function He(e,t,r){var n;return n=function(e,t){if("object"!=ze(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=ze(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"),(t="symbol"==ze(n)?n:n+"")in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Ke=function(e,t,r,n){var o="";return n.forEach(function(n,s){var i=a(t,r,e,n);o+=s?"L ".concat(i.x,",").concat(i.y):"M ".concat(i.x,",").concat(i.y)}),o+="Z"},Ye=function(e){var t=e.cx,o=e.cy,s=e.innerRadius,i=e.outerRadius,l=e.polarAngles,c=e.radialLines;if(!l||!l.length||!c)return null;var d=Ge({stroke:"#ccc"},n(e,!1));return r.createElement("g",{className:"recharts-polar-grid-angle"},l.map(function(e){var n=a(t,o,s,e),l=a(t,o,i,e);return r.createElement("line",We({},d,{key:"line-".concat(e),x1:n.x,y1:n.y,x2:l.x,y2:l.y}))}))},Qe=function(e){var a=e.cx,o=e.cy,s=e.radius,i=e.index,l=Ge(Ge({stroke:"#ccc"},n(e,!1)),{},{fill:"none"});return r.createElement("circle",We({},l,{className:t("recharts-polar-grid-concentric-circle",e.className),key:"circle-".concat(i),cx:a,cy:o,r:s}))},Ze=function(e){var a=e.radius,o=e.index,s=Ge(Ge({stroke:"#ccc"},n(e,!1)),{},{fill:"none"});return r.createElement("path",We({},s,{className:t("recharts-polar-grid-concentric-polygon",e.className),key:"path-".concat(o),d:Ke(a,e.cx,e.cy,e.polarAngles)}))},Je=function(e){var t=e.polarRadius,n=e.gridType;return t&&t.length?r.createElement("g",{className:"recharts-polar-grid-concentric"},t.map(function(t,a){var o=a;return"circle"===n?r.createElement(Qe,We({key:o},e,{radius:t,index:a})):r.createElement(Ze,We({key:o},e,{radius:t,index:a}))})):null},Xe=function(e){var t=e.cx,n=void 0===t?0:t,a=e.cy,o=void 0===a?0:a,s=e.innerRadius,i=void 0===s?0:s,l=e.outerRadius,c=void 0===l?0:l,d=e.gridType,u=void 0===d?"polygon":d,m=e.radialLines,p=void 0===m||m,h=Ue(e,De);return c<=0?null:r.createElement("g",{className:"recharts-polar-grid"},r.createElement(Ye,We({cx:n,cy:o,innerRadius:i,outerRadius:c,gridType:u,radialLines:p},h)),r.createElement(Je,We({cx:n,cy:o,innerRadius:i,outerRadius:c,gridType:u,radialLines:p},h)))};Xe.displayName="PolarGrid";var et=o,tt=i,rt=s;const nt=xe(function(e,t){return e&&e.length?et(e,rt(t),tt):void 0});var at=o,ot=s,st=l;const it=xe(function(e,t){return e&&e.length?at(e,ot(t),st):void 0});var lt=["cx","cy","angle","ticks","axisLine"],ct=["ticks","tick","angle","tickFormatter","stroke"];function dt(e){return(dt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ut(){return ut=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},ut.apply(this,arguments)}function mt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function pt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?mt(Object(r),!0).forEach(function(t){vt(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):mt(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function ht(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function ft(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,jt(n.key),n)}}function gt(e,t,r){return t=yt(t),function(e,t){if(t&&("object"===dt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,bt()?Reflect.construct(t,r||[],yt(e).constructor):t.apply(e,r))}function bt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(bt=function(){return!!e})()}function yt(e){return(yt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xt(e,t){return(xt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function vt(e,t,r){return(t=jt(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function jt(e){var t=function(e,t){if("object"!=dt(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=dt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==dt(t)?t:t+""}var kt=function(){function e(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),gt(this,e,arguments)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&xt(e,t)}(e,f.PureComponent),o=e,i=[{key:"renderTickItem",value:function(e,t,n){return r.isValidElement(e)?r.cloneElement(e,t):c(e)?e(t):r.createElement(d,ut({},t,{className:"recharts-polar-radius-axis-tick-value"}),n)}}],(s=[{key:"getTickValueCoord",value:function(e){var t=e.coordinate,r=this.props,n=r.angle,o=r.cx,s=r.cy;return a(o,s,t,n)}},{key:"getTickTextAnchor",value:function(){var e;switch(this.props.orientation){case"left":e="end";break;case"right":e="start";break;default:e="middle"}return e}},{key:"getViewBox",value:function(){var e=this.props,t=e.cx,r=e.cy,n=e.angle,a=e.ticks,o=nt(a,function(e){return e.coordinate||0});return{cx:t,cy:r,startAngle:n,endAngle:n,innerRadius:it(a,function(e){return e.coordinate||0}).coordinate||0,outerRadius:o.coordinate||0}}},{key:"renderAxisLine",value:function(){var e=this.props,t=e.cx,o=e.cy,s=e.angle,i=e.ticks,l=e.axisLine,c=ht(e,lt),d=i.reduce(function(e,t){return[Math.min(e[0],t.coordinate),Math.max(e[1],t.coordinate)]},[1/0,-1/0]),u=a(t,o,d[0],s),m=a(t,o,d[1],s),p=pt(pt(pt({},n(c,!1)),{},{fill:"none"},n(l,!1)),{},{x1:u.x,y1:u.y,x2:m.x,y2:m.y});return r.createElement("line",ut({className:"recharts-polar-radius-axis-line"},p))}},{key:"renderTicks",value:function(){var a=this,o=this.props,s=o.ticks,i=o.tick,l=o.angle,c=o.tickFormatter,d=o.stroke,h=ht(o,ct),f=this.getTickTextAnchor(),g=n(h,!1),b=n(i,!1),y=s.map(function(n,o){var s=a.getTickValueCoord(n),h=pt(pt(pt(pt({textAnchor:f,transform:"rotate(".concat(90-l,", ").concat(s.x,", ").concat(s.y,")")},g),{},{stroke:"none",fill:d},b),{},{index:o},s),{},{payload:n});return r.createElement(u,ut({className:t("recharts-polar-radius-axis-tick",m(i)),key:"tick-".concat(n.coordinate)},p(a.props,n,o)),e.renderTickItem(i,h,c?c(n.value,o):n.value))});return r.createElement(u,{className:"recharts-polar-radius-axis-ticks"},y)}},{key:"render",value:function(){var e=this.props,n=e.ticks,a=e.axisLine,o=e.tick;return n&&n.length?r.createElement(u,{className:t("recharts-polar-radius-axis",this.props.className)},a&&this.renderAxisLine(),o&&this.renderTicks(),h.renderCallByParent(this.props,this.getViewBox())):null}}])&&ft(o.prototype,s),i&&ft(o,i),Object.defineProperty(o,"prototype",{writable:!1}),o;var o,s,i}();function wt(e){return(wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Nt(){return Nt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},Nt.apply(this,arguments)}function Pt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ct(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Pt(Object(r),!0).forEach(function(t){Tt(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Pt(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function St(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Mt(n.key),n)}}function _t(e,t,r){return t=Ot(t),function(e,t){if(t&&("object"===wt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Et()?Reflect.construct(t,r||[],Ot(e).constructor):t.apply(e,r))}function Et(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(Et=function(){return!!e})()}function Ot(e){return(Ot=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function At(e,t){return(At=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Tt(e,t,r){return(t=Mt(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Mt(e){var t=function(e,t){if("object"!=wt(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=wt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==wt(t)?t:t+""}vt(kt,"displayName","PolarRadiusAxis"),vt(kt,"axisType","radiusAxis"),vt(kt,"defaultProps",{type:"number",radiusAxisId:0,cx:0,cy:0,angle:0,orientation:"right",stroke:"#ccc",axisLine:!0,tick:!0,tickCount:5,allowDataOverflow:!1,scale:"auto",allowDuplicatedCategory:!0});var Rt=Math.PI/180,Lt=1e-5,It=function(){function e(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),_t(this,e,arguments)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&At(e,t)}(e,f.PureComponent),o=e,i=[{key:"renderTickItem",value:function(e,t,n){return r.isValidElement(e)?r.cloneElement(e,t):c(e)?e(t):r.createElement(d,Nt({},t,{className:"recharts-polar-angle-axis-tick-value"}),n)}}],(s=[{key:"getTickLineCoord",value:function(e){var t=this.props,r=t.cx,n=t.cy,o=t.radius,s=t.orientation,i=t.tickSize||8,l=a(r,n,o,e.coordinate),c=a(r,n,o+("inner"===s?-1:1)*i,e.coordinate);return{x1:l.x,y1:l.y,x2:c.x,y2:c.y}}},{key:"getTickTextAnchor",value:function(e){var t=this.props.orientation,r=Math.cos(-e.coordinate*Rt);return r>Lt?"outer"===t?"start":"end":r<-Lt?"outer"===t?"end":"start":"middle"}},{key:"renderAxisLine",value:function(){var e=this.props,t=e.cx,o=e.cy,s=e.radius,i=e.axisLine,l=e.axisLineType,c=Ct(Ct({},n(this.props,!1)),{},{fill:"none"},n(i,!1));if("circle"===l)return r.createElement(g,Nt({className:"recharts-polar-angle-axis-line"},c,{cx:t,cy:o,r:s}));var d=this.props.ticks.map(function(e){return a(t,o,s,e.coordinate)});return r.createElement(qe,Nt({className:"recharts-polar-angle-axis-line"},c,{points:d}))}},{key:"renderTicks",value:function(){var a=this,o=this.props,s=o.ticks,i=o.tick,l=o.tickLine,c=o.tickFormatter,d=o.stroke,h=n(this.props,!1),f=n(i,!1),g=Ct(Ct({},h),{},{fill:"none"},n(l,!1)),b=s.map(function(n,o){var s=a.getTickLineCoord(n),b=Ct(Ct(Ct({textAnchor:a.getTickTextAnchor(n)},h),{},{stroke:"none",fill:d},f),{},{index:o,payload:n,x:s.x2,y:s.y2});return r.createElement(u,Nt({className:t("recharts-polar-angle-axis-tick",m(i)),key:"tick-".concat(n.coordinate)},p(a.props,n,o)),l&&r.createElement("line",Nt({className:"recharts-polar-angle-axis-tick-line"},g,s)),i&&e.renderTickItem(i,b,c?c(n.value,o):n.value))});return r.createElement(u,{className:"recharts-polar-angle-axis-ticks"},b)}},{key:"render",value:function(){var e=this.props,n=e.ticks,a=e.radius,o=e.axisLine;return a<=0||!n||!n.length?null:r.createElement(u,{className:t("recharts-polar-angle-axis",this.props.className)},o&&this.renderAxisLine(),this.renderTicks())}}])&&St(o.prototype,s),i&&St(o,i),Object.defineProperty(o,"prototype",{writable:!1}),o;var o,s,i}();Tt(It,"displayName","PolarAngleAxis"),Tt(It,"axisType","angleAxis"),Tt(It,"defaultProps",{type:"category",angleAxisId:0,scale:"auto",cx:0,cy:0,orientation:"outer",axisLine:!0,tickLine:!0,tickSize:8,tick:!0,hide:!1,allowDuplicatedCategory:!0});const $t=xe(function(e){return e&&e.length?e[0]:void 0});var Ft=["key"];function Bt(e){return(Bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qt(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r={};for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function Dt(){return Dt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},Dt.apply(this,arguments)}function zt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ut(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?zt(Object(r),!0).forEach(function(t){Yt(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):zt(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function Wt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Qt(n.key),n)}}function Vt(e,t,r){return t=Ht(t),function(e,t){if(t&&("object"===Bt(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Gt()?Reflect.construct(t,r||[],Ht(e).constructor):t.apply(e,r))}function Gt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(Gt=function(){return!!e})()}function Ht(e){return(Ht=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Kt(e,t){return(Kt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Yt(e,t,r){return(t=Qt(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Qt(e){var t=function(e,t){if("object"!=Bt(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=Bt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Bt(t)?t:t+""}var Zt=function(){function e(){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);for(var r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return Yt(t=Vt(this,e,[].concat(n)),"state",{isAnimationFinished:!1}),Yt(t,"handleAnimationEnd",function(){var e=t.props.onAnimationEnd;t.setState({isAnimationFinished:!0}),c(e)&&e()}),Yt(t,"handleAnimationStart",function(){var e=t.props.onAnimationStart;t.setState({isAnimationFinished:!1}),c(e)&&e()}),Yt(t,"handleMouseEnter",function(e){var r=t.props.onMouseEnter;r&&r(t.props,e)}),Yt(t,"handleMouseLeave",function(e){var r=t.props.onMouseLeave;r&&r(t.props,e)}),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Kt(e,t)}(e,f.PureComponent),a=e,s=[{key:"getDerivedStateFromProps",value:function(e,t){return e.animationId!==t.prevAnimationId?{prevAnimationId:e.animationId,curPoints:e.points,prevPoints:t.curPoints}:e.points!==t.curPoints?{curPoints:e.points}:null}},{key:"renderDotItem",value:function(e,n){var a;if(r.isValidElement(e))a=r.cloneElement(e,n);else if(c(e))a=e(n);else{var o=n.key,s=qt(n,Ft);a=r.createElement(g,Dt({},s,{key:o,className:t("recharts-radar-dot","boolean"!=typeof e?e.className:"")}))}return a}}],(o=[{key:"renderDots",value:function(t){var a=this.props,o=a.dot,s=a.dataKey,i=n(this.props,!1),l=n(o,!0),c=t.map(function(t,r){var n=Ut(Ut(Ut({key:"dot-".concat(r),r:3},i),l),{},{dataKey:s,cx:t.x,cy:t.y,index:r,payload:t});return e.renderDotItem(o,n)});return r.createElement(u,{className:"recharts-radar-dots"},c)}},{key:"renderPolygonStatically",value:function(e){var t,a=this.props,o=a.shape,s=a.dot,i=a.isRange,l=a.baseLinePoints,d=a.connectNulls;return t=r.isValidElement(o)?r.cloneElement(o,Ut(Ut({},this.props),{},{points:e})):c(o)?o(Ut(Ut({},this.props),{},{points:e})):r.createElement(qe,Dt({},n(this.props,!0),{onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,points:e,baseLinePoints:i?l:null,connectNulls:d})),r.createElement(u,{className:"recharts-radar-polygon"},t,s?this.renderDots(e):null)}},{key:"renderPolygonWithAnimation",value:function(){var e=this,t=this.props,n=t.points,a=t.isAnimationActive,o=t.animationBegin,s=t.animationDuration,i=t.animationEasing,l=t.animationId,c=this.state.prevPoints;return r.createElement(b,{begin:o,duration:s,isActive:a,easing:i,from:{t:0},to:{t:1},key:"radar-".concat(l),onAnimationEnd:this.handleAnimationEnd,onAnimationStart:this.handleAnimationStart},function(t){var r=t.t,a=c&&c.length/n.length,o=n.map(function(e,t){var n=c&&c[Math.floor(t*a)];if(n){var o=y(n.x,e.x),s=y(n.y,e.y);return Ut(Ut({},e),{},{x:o(r),y:s(r)})}var i=y(e.cx,e.x),l=y(e.cy,e.y);return Ut(Ut({},e),{},{x:i(r),y:l(r)})});return e.renderPolygonStatically(o)})}},{key:"renderPolygon",value:function(){var e=this.props,t=e.points,r=e.isAnimationActive,n=e.isRange,a=this.state.prevPoints;return!(r&&t&&t.length)||n||a&&x(a,t)?this.renderPolygonStatically(t):this.renderPolygonWithAnimation()}},{key:"render",value:function(){var e=this.props,n=e.hide,a=e.className,o=e.points,s=e.isAnimationActive;if(n||!o||!o.length)return null;var i=this.state.isAnimationFinished,l=t("recharts-radar",a);return r.createElement(u,{className:l},this.renderPolygon(),(!s||i)&&v.renderCallByParent(this.props,o))}}])&&Wt(a.prototype,o),s&&Wt(a,s),Object.defineProperty(a,"prototype",{writable:!1}),a;var a,o,s}();Yt(Zt,"displayName","Radar"),Yt(Zt,"defaultProps",{angleAxisId:0,radiusAxisId:0,hide:!1,activeDot:!0,dot:!1,legendType:"rect",isAnimationActive:!j.isSsr,animationBegin:0,animationDuration:1500,animationEasing:"ease"}),Yt(Zt,"getComposedData",function(e){var t=e.radiusAxis,r=e.angleAxis,n=e.displayedData,o=e.dataKey,s=e.bandSize,i=r.cx,l=r.cy,c=!1,d=[],u="number"!==r.type&&null!=s?s:0;n.forEach(function(e,n){var s=k(e,r.dataKey,n),m=k(e,o),p=r.scale(s)+u,h=Array.isArray(m)?w(m):m,f=N(h)?void 0:t.scale(h);Array.isArray(m)&&m.length>=2&&(c=!0),d.push(Ut(Ut({},a(i,l,f,p)),{},{name:s,value:m,cx:i,cy:l,radius:f,angle:p,payload:e}))});var m=[];return c&&d.forEach(function(e){if(Array.isArray(e.value)){var r=$t(e.value),n=N(r)?void 0:t.scale(r);m.push(Ut(Ut({},e),{},{radius:n},a(i,l,n,e.angle)))}else m.push(e)}),{points:d,isRange:c,baseLinePoints:m}});var Jt=P({chartName:"RadarChart",GraphicalChild:Zt,axisComponents:[{axisType:"angleAxis",AxisComp:It},{axisType:"radiusAxis",AxisComp:kt}],formatAxisMap:C,defaultProps:{layout:"centric",startAngle:90,endAngle:-270,cx:"50%",cy:"50%",innerRadius:0,outerRadius:"80%"}});const Xt=({score:e,label:t="Score",subLabel:r,size:n=120,strokeWidth:a=8,color:o="#3b82f6"})=>{const s=(n-a)/2,i=2*s*Math.PI,l=i-e/100*i;return S.jsxs("div",{className:"relative flex flex-col items-center justify-center",style:{width:n,height:n},children:[S.jsxs("svg",{width:n,height:n,className:"transform -rotate-90",children:[S.jsx("circle",{cx:n/2,cy:n/2,r:s,stroke:"currentColor",strokeWidth:a,fill:"transparent",className:"text-slate-100 dark:text-slate-800"}),S.jsx("circle",{cx:n/2,cy:n/2,r:s,stroke:o,strokeWidth:a,fill:"transparent",strokeDasharray:i,strokeDashoffset:l,strokeLinecap:"round",className:"transition-all duration-1000 ease-out"})]}),S.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-center",children:[S.jsxs("span",{className:"text-2xl font-bold",style:{color:o},children:[e,"%"]}),t&&S.jsx("span",{className:"text-xs text-slate-500 font-medium uppercase tracking-wider",children:t}),r&&S.jsx("span",{className:"text-[10px] text-slate-400",children:r})]})]})},er=({metrics:e,width:t=300,height:r=250})=>{const n={pronunciation:Math.max(0,Math.min(100,e.pronunciation||0)),vocabulary:Math.max(0,Math.min(100,e.vocabulary||0)),grammar:Math.max(0,Math.min(100,e.grammar||0)),intonation:Math.max(0,Math.min(100,e.intonation||0)),fluency:Math.max(0,Math.min(100,e.fluency||0))},a=[{subject:"Pronunciation",A:n.pronunciation,fullMark:100},{subject:"Vocabulary",A:n.vocabulary,fullMark:100},{subject:"Grammar",A:n.grammar,fullMark:100},{subject:"Intonation",A:n.intonation,fullMark:100},{subject:"Fluency",A:n.fluency,fullMark:100}],o=Object.values(n).some(e=>e>0);return S.jsx("div",{className:"w-full h-full flex items-center justify-center",children:S.jsx("div",{style:{width:t,height:r,minWidth:200,minHeight:180},children:S.jsx(_,{width:"100%",height:"100%",children:S.jsxs(Jt,{cx:"50%",cy:"50%",outerRadius:"55%",data:a,children:[S.jsx(Xe,{stroke:"#e2e8f0",strokeDasharray:"3 3"}),S.jsx(It,{dataKey:"subject",tick:{fill:"#64748b",fontSize:9,fontWeight:600},tickLine:!1}),S.jsx(kt,{angle:90,domain:[0,100],tick:!1,axisLine:!1,tickCount:5}),S.jsx(Zt,{name:"Metrics",dataKey:"A",stroke:"#3b82f6",strokeWidth:2,fill:"#3b82f6",fillOpacity:o?.3:.05,animationDuration:800,animationEasing:"ease-out"})]})})})})};f.createContext(null);const tr=({active:e=!1,processing:t=!1,deviceId:r,barWidth:n=3,barGap:a=1,barRadius:o=1.5,barColor:s,fadeEdges:i=!0,fadeWidth:l=24,height:c=64,sensitivity:d=1,smoothingTimeConstant:u=.8,fftSize:m=256,historySize:p=60,updateRate:h=30,mode:g="static",onError:b,onStreamReady:y,onStreamEnd:x,className:v,...j})=>{const k=f.useRef(null),w=f.useRef(null),N=f.useRef([]),P=f.useRef(null),C=f.useRef(null),_=f.useRef(null),O=f.useRef(0),A=f.useRef(0),T=f.useRef(null),M=f.useRef([]),R=f.useRef(0),L=f.useRef([]),I=f.useRef(!0),$=f.useRef(null),F=f.useRef(0),B="number"==typeof c?`${c}px`:c;return f.useEffect(()=>{const e=k.current,t=w.current;if(!e||!t)return;const r=new ResizeObserver(()=>{const r=t.getBoundingClientRect(),n=window.devicePixelRatio||1;e.width=r.width*n,e.height=r.height*n,e.style.width=`${r.width}px`,e.style.height=`${r.height}px`;const a=e.getContext("2d");a&&a.scale(n,n),$.current=null,F.current=r.width,I.current=!0});return r.observe(t),()=>r.disconnect()},[]),f.useEffect(()=>{if(t&&!e){let e=0;R.current=0;const t=()=>{var r;e+=.03,R.current=Math.min(1,R.current+.02);const o=[],s=Math.floor(((null==(r=w.current)?void 0:r.getBoundingClientRect().width)||200)/(n+a));if("static"===g){const t=Math.floor(s/2);for(let r=0;r<s;r++){const n=(r-t)/t,a=1-.4*Math.abs(n),s=(.2+(.25*Math.sin(1.5*e+3*n)+.2*Math.sin(.8*e-2*n)+.15*Math.cos(2*e+n)))*a;let i=s;if(M.current.length>0&&R.current<1){const e=Math.min(r,M.current.length-1);i=(M.current[e]||0)*(1-R.current)+s*R.current}o.push(Math.max(.05,Math.min(1,i)))}}else for(let t=0;t<s;t++){const r=(t-s/2)/(s/2),n=1-.4*Math.abs(r),a=(.2+(.25*Math.sin(1.5*e+.15*t)+.2*Math.sin(.8*e-.1*t)+.15*Math.cos(2*e+.05*t)))*n;let i=a;if(M.current.length>0&&R.current<1){const e=Math.floor(t/s*M.current.length);i=(M.current[e]||0)*(1-R.current)+a*R.current}o.push(Math.max(.05,Math.min(1,i)))}"static"===g?L.current=o:N.current=o,I.current=!0,T.current=requestAnimationFrame(t)};return t(),()=>{T.current&&cancelAnimationFrame(T.current)}}if(!e&&!t){if("static"===g?L.current.length>0:N.current.length>0){let e=0;const t=()=>{e+=.03,e<1?("static"===g?L.current=L.current.map(t=>t*(1-e)):N.current=N.current.map(t=>t*(1-e)),I.current=!0,requestAnimationFrame(t)):"static"===g?L.current=[]:N.current=[]};t()}}},[t,e,n,a,g]),f.useEffect(()=>{if(!e)return _.current&&(_.current.getTracks().forEach(e=>e.stop()),_.current=null,null==x||x()),C.current&&"closed"!==C.current.state&&(C.current.close(),C.current=null),void(O.current&&(cancelAnimationFrame(O.current),O.current=0));return(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:r?{deviceId:{exact:r},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});_.current=e,null==y||y(e);const t=new(window.AudioContext||window.webkitAudioContext),n=t.createAnalyser();n.fftSize=m,n.smoothingTimeConstant=u;t.createMediaStreamSource(e).connect(n),C.current=t,P.current=n,N.current=[]}catch(e){null==b||b(e)}})(),()=>{_.current&&(_.current.getTracks().forEach(e=>e.stop()),_.current=null,null==x||x()),C.current&&"closed"!==C.current.state&&(C.current.close(),C.current=null),O.current&&(cancelAnimationFrame(O.current),O.current=0)}},[e,r,m,u,b,y,x]),f.useEffect(()=>{const r=k.current;if(!r)return;const c=r.getContext("2d");if(!c)return;let u;const m=f=>{const b=r.getBoundingClientRect();if(e&&f-A.current>h&&(A.current=f,P.current)){const e=new Uint8Array(P.current.frequencyBinCount);if(P.current.getByteFrequencyData(e),"static"===g){const t=Math.floor(.05*e.length),r=Math.floor(.4*e.length),o=e.slice(t,r),s=Math.floor(b.width/(n+a)),i=Math.floor(s/2),l=[];for(let e=i-1;e>=0;e--){const t=Math.floor(e/i*o.length),r=Math.min(1,o[t]/255*d);l.push(Math.max(.05,r))}for(let e=0;e<i;e++){const t=Math.floor(e/i*o.length),r=Math.min(1,o[t]/255*d);l.push(Math.max(.05,r))}L.current=l,M.current=l}else{let t=0;const r=Math.floor(.05*e.length),n=Math.floor(.4*e.length),a=e.slice(r,n);for(let e=0;e<a.length;e++)t+=a[e];const o=t/a.length/255*d;N.current.push(Math.min(1,Math.max(.05,o))),M.current=[...N.current],N.current.length>p&&N.current.shift()}I.current=!0}if(!I.current&&!e)return void(u=requestAnimationFrame(m));I.current=e,c.clearRect(0,0,b.width,b.height);const y=s||getComputedStyle(r).color||"#000",x=n+a,v=Math.floor(b.width/x),j=b.height/2;if("static"===g){const r=t||e||L.current.length>0?L.current:[];for(let e=0;e<v&&e<r.length;e++){const t=r[e]||.1,a=e*x,s=Math.max(4,t*b.height*.8),i=j-s/2;c.fillStyle=y,c.globalAlpha=.4+.6*t,o>0?(c.beginPath(),c.roundRect(a,i,n,s,o),c.fill()):c.fillRect(a,i,n,s)}}else for(let e=0;e<v&&e<N.current.length;e++){const t=N.current.length-1-e,r=N.current[t]||.1,a=b.width-(e+1)*x,s=Math.max(4,r*b.height*.8),i=j-s/2;c.fillStyle=y,c.globalAlpha=.4+.6*r,o>0?(c.beginPath(),c.roundRect(a,i,n,s,o),c.fill()):c.fillRect(a,i,n,s)}if(i&&l>0&&b.width>0){if(!$.current||F.current!==b.width){const e=c.createLinearGradient(0,0,b.width,0),t=Math.min(.3,l/b.width);e.addColorStop(0,"rgba(255,255,255,1)"),e.addColorStop(t,"rgba(255,255,255,0)"),e.addColorStop(1-t,"rgba(255,255,255,0)"),e.addColorStop(1,"rgba(255,255,255,1)"),$.current=e,F.current=b.width}c.globalCompositeOperation="destination-out",c.fillStyle=$.current,c.fillRect(0,0,b.width,b.height),c.globalCompositeOperation="source-over"}c.globalAlpha=1,u=requestAnimationFrame(m)};return u=requestAnimationFrame(m),()=>{u&&cancelAnimationFrame(u)}},[e,t,d,h,p,n,a,o,s,i,l,g]),S.jsxs("div",{className:E("relative h-full w-full",v),ref:w,style:{height:B},"aria-label":e?"Live audio waveform":t?"Processing audio":"Audio waveform idle",role:"img",...j,children:[!e&&!t&&S.jsx("div",{className:"border-muted-foreground/20 absolute top-1/2 right-0 left-0 -translate-y-1/2 border-t-2 border-dotted"}),S.jsx("canvas",{className:"block h-full w-full",ref:k,"aria-hidden":"true"})]})},rr=()=>{var e,t,r,n,a,o,s,i,l,c,d;const u=O(),m=u.testId||u.testName,p=A(),{profile:h}=T(),{toast:g}=M(),b=R(),[y,x]=f.useState(null),[v,j]=f.useState([]),[k,w]=f.useState(1),[N,P]=f.useState(0),[C,_]=f.useState(!0),[E,xe]=f.useState(!1),[Me,Re]=f.useState(!1),[Le,Ie]=f.useState(!1),[$e,Fe]=f.useState(null),[Be,qe]=f.useState(null),[De,ze]=f.useState(0),[Ue,We]=f.useState(60),[Ve,Ge]=f.useState({}),[He,Ke]=f.useState("");f.useState(!1),f.useState("");const[Ye,Qe]=f.useState(!1),[Ze,Je]=f.useState("en");f.useEffect(()=>{(async()=>{if(null==h?void 0:h.id)try{const{data:e}=await ve.from("user_preferences").select("preferred_feedback_language, native_language").eq("user_id",h.id).maybeSingle(),t=e,r=(null==t?void 0:t.preferred_feedback_language)||(null==t?void 0:t.native_language);r&&Oe.find(e=>e.value===r)&&Je(r)}catch(e){console.warn("Error loading user preferred language:",e)}})()},[null==h?void 0:h.id]);const[Xe,et]=f.useState(!1),[tt,rt]=f.useState(!1),[nt,at]=f.useState(!1),[ot,st]=f.useState(!1),[it,lt]=f.useState(!1),[ct,dt]=f.useState([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}]),[ut,mt]=f.useState(""),[pt,ht]=f.useState(!1),[ft,gt]=f.useState(!1),[bt,yt]=f.useState(null),[xt,vt]=f.useState(!1),jt=f.useRef(null),kt=f.useRef(null),wt=f.useRef(null),Nt=f.useRef([]),Pt=f.useRef(null),Ct=f.useRef(null),St=f.useMemo(()=>{const e=Ve[`part${k}_q${N}`];return e?URL.createObjectURL(e):null},[Ve,k,N]);f.useEffect(()=>()=>{St&&URL.revokeObjectURL(St)},[St]);const _t=(()=>{try{const e="undefined"!=typeof window?window.localStorage.getItem("appAudioVolume"):null,t=(e?parseInt(e,10):100)/100;return Number.isFinite(t)?Math.min(1,Math.max(0,t)):1}catch{return 1}})(),Et=f.useRef(_t);f.useEffect(()=>(m?(Ot(),dt([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}])):At(),()=>{wt.current&&clearInterval(wt.current)}),[m]),f.useEffect(()=>(De>0?wt.current=setTimeout(()=>ze(De-1),1e3):0===De&&E&&Mt(),()=>{wt.current&&clearTimeout(wt.current)}),[De,E]),f.useEffect(()=>{const e=e=>{var t;const r=null==(t=null==e?void 0:e.detail)?void 0:t.volume;"number"==typeof r&&(Et.current=r,kt.current&&(kt.current.volume=r))};return window.addEventListener("app:volume-change",e),()=>window.removeEventListener("app:volume-change",e)},[]),f.useEffect(()=>{ct.length>0&&setTimeout(()=>{const e=document.querySelector("[data-conversation-content]");e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},100)},[ct]),f.useEffect(()=>{at(!1),vt(!1)},[N,k]),f.useEffect(()=>{var e,t,r,n,a;if(y&&!C){let o=!0;if(1===k){const t=(null==(e=y.part1_prompts)?void 0:e.length)||0;(N>=t||N<0)&&(console.warn("‚ö†Ô∏è Invalid Part 1 state detected, resetting..."),o=!1)}else if(2===k){if(!y.part2_prompt)return console.warn("‚ö†Ô∏è Part 2 accessed but no Part 2 prompt available, going to Part 3 or completion..."),(null==(t=y.part3_prompts)?void 0:t.length)>0?(w(3),void P(0)):void Qe(!0)}else if(3===k){const e=(null==(r=y.part3_prompts)?void 0:r.length)||0;(N>=e||N<0)&&(console.warn("‚ö†Ô∏è Invalid Part 3 state detected, resetting..."),o=!1)}o||((null==(n=y.part1_prompts)?void 0:n.length)>0?(w(1),P(0)):y.part2_prompt?(w(2),P(0)):(null==(a=y.part3_prompts)?void 0:a.length)>0?(w(3),P(0)):(console.error("‚ùå No valid test parts available"),p("/ielts-portal")))}},[y,k,N,C,p]),f.useEffect(()=>{if(Pt.current){const e=Pt.current;e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("transition","none","important");const t=t=>{e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("box-shadow","0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1)","important"),e.style.setProperty("transition","none","important")};return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",t),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",t)}}},[y,k,N]);const Ot=async()=>{if(m){_(!0);try{console.log(`üîç Loading speaking test data for test ID: ${m}`);const e=m.includes("-")&&36===m.length,[t,r]=await Promise.all([e?ve.from("tests").select("id, test_name").eq("id",m).single():ve.from("tests").select("id, test_name").eq("test_name",m).eq("test_type","IELTS").eq("module","Speaking").maybeSingle(),ve.from("speaking_prompts").select("*").eq("test_id",m).order("part_number",{ascending:!0})]);if(t.error)throw t.error;const n=t.data;if(!n)return g({title:"Test Not Found",description:"This speaking test doesn't exist. Please check the test ID.",variant:"destructive"}),void p(-1);console.log("‚úÖ Test loaded:",n.test_name);let a=r.data||[];if(0===a.length&&n.id!==m){const{data:e}=await ve.from("speaking_prompts").select("*").eq("test_id",n.id).order("part_number",{ascending:!0});a=e||[]}console.log(`üìù Loaded ${a.length} total speaking prompts`);const o=[];let s=null;const i=[];a.forEach(e=>{1===e.part_number?o.push(e):2===e.part_number?s=e:3===e.part_number&&i.push(e)}),x({id:n.id,test_name:n.test_name,part1_prompts:o,part2_prompt:s,part3_prompts:i}),console.log(`‚úÖ Test ready: Part 1 (${o.length}), Part 2 (${s?1:0}), Part 3 (${i.length})`)}catch(e){console.error("‚ùå Error:",e),m&&x({id:m,test_name:"Speaking Test",part1_prompts:[],part2_prompt:null,part3_prompts:[]})}finally{_(!1)}}},At=async()=>{_(!0);try{console.log("üìã Loading available speaking tests...");const{data:e,error:t}=await ve.from("tests").select("id, test_name, module, skill_category, created_at, speaking_prompts!inner(id)").eq("test_type","IELTS").order("created_at",{ascending:!1}).limit(50);if(t)throw console.error("‚ùå Error loading tests:",t),t;const r=(e||[]).filter(e=>{const t=(e.test_name||"").trim();return t&&t.length>=2&&!t.toLowerCase().includes("quick test")&&!["test ?","another test?",""].includes(t.toLowerCase())});console.log(`‚úÖ Found ${r.length} valid speaking tests`),j(r)}catch(e){console.error("‚ùå Error loading tests:",e),g({title:"Error",description:"Failed to load available speaking tests",variant:"destructive"}),j([])}finally{_(!1)}},Tt=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),r=e.createOscillator(),n=e.createGain();t.type="sine",t.frequency.value=523,r.type="sine",r.frequency.value=659,t.connect(n),r.connect(n),n.connect(e.destination),n.gain.setValueAtTime(1e-4,e.currentTime),n.gain.exponentialRampToValueAtTime(.05,e.currentTime+.01),t.start(),r.start(),setTimeout(()=>{n.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{t.stop(),r.stop(),e.close()},200)},120)}catch{}},Mt=()=>{if(2===k&&Ct.current){const e=Math.floor((Date.now()-Ct.current)/1e3),t=60;if(e<t){const r=t-e;return void g({title:"Minimum Recording Time Required",description:`For IELTS Part 2, you should speak for at least 1 minute to receive a good score. Please continue recording for ${r} more second${1!==r?"s":""}.`,variant:"destructive",duration:5e3})}}Tt(),jt.current&&E&&(jt.current.stop(),ze(0),Ct.current=null)},Rt=()=>{var e,t,r,n;try{if(console.log(`üîÑ Navigation attempt: Part ${k}, Question ${N}`,{testDataExists:!!y,part1Prompts:(null==(e=null==y?void 0:y.part1_prompts)?void 0:e.length)||0,part2Prompt:!!(null==y?void 0:y.part2_prompt),part3Prompts:(null==(t=null==y?void 0:y.part3_prompts)?void 0:t.length)||0}),!y)return console.error("‚ùå Navigation failed: No test data available"),void g({title:"Navigation Error",description:"Test data not available. Please refresh the page.",variant:"destructive"});if(1===k){const e=(null==(r=y.part1_prompts)?void 0:r.length)||0;if(N<e-1){const e=N+1;P(e),at(!1),yt(null),vt(!1),console.log(`‚û°Ô∏è Moving to Part 1, Question ${e+1}`)}else{const e=!!y.part2_prompt,t=!!(y.part3_prompts&&y.part3_prompts.length>0);e||t?e?(w(2),P(0),We(60),at(!1),yt(null),vt(!1),console.log("‚û°Ô∏è Moving to Part 2 - Long Turn"),Lt()):t&&(w(3),P(0),at(!1),yt(null),vt(!1),console.log("‚û°Ô∏è Moving to Part 3 - Discussion (no Part 2 for this test)")):(console.log("üèÅ Part 1-only test completed - prompting for feedback language"),Qe(!0))}}else if(2===k){y.part3_prompts&&y.part3_prompts.length>0?(w(3),P(0),at(!1),yt(null),vt(!1),console.log("‚û°Ô∏è Moving to Part 3 - Discussion")):(console.log("üèÅ Part 2 completed - no Part 3 available, prompting for feedback language"),Qe(!0))}else if(3===k){const e=(null==(n=y.part3_prompts)?void 0:n.length)||0;if(N<e-1){const e=N+1;P(e),at(!1),yt(null),vt(!1),console.log(`‚û°Ô∏è Moving to Part 3, Question ${e+1}`)}else console.log("üèÅ Last question completed - prompting for feedback language"),Qe(!0)}}catch(a){console.error("‚ùå Navigation error:",a),g({title:"Navigation Error",description:"Failed to navigate. Please try again.",variant:"destructive"})}},Lt=()=>{const e=setInterval(()=>{We(t=>t<=1?(clearInterval(e),g({title:"Preparation Time Complete",description:"You may now start recording your response.",duration:5e3}),0):t-1)},1e3)},It=e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;if(C)return S.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"dark"===b.theme.name?b.theme.colors.background:"transparent"},children:S.jsx(L,{size:"lg",message:"Loading speaking tests..."})});if(!m)return S.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===b.theme.name?b.theme.colors.background:"transparent"},children:[S.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===b.theme.name||"minimalist"===b.theme.name||"dark"===b.theme.name?"none":"url('/1000031207.png')",backgroundColor:b.backgroundImageColor}}),S.jsx("div",{className:"relative z-10",children:S.jsx(I,{title:"Available Speaking Tests",children:S.jsx("div",{className:"min-h-screen py-12",children:S.jsx("div",{className:"container mx-auto px-4",children:S.jsxs("div",{className:"max-w-4xl mx-auto",children:[S.jsx("div",{className:"mb-8 text-center",children:S.jsx("h1",{className:"text-4xl font-bold mb-2",style:{color:b.textPrimary},children:"IELTS speaking tests"})}),v.length>0?S.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:v.map(e=>S.jsx($,{className:"cursor-pointer h-[140px] hover:scale-105 transition-all duration-300 hover:shadow-lg flex items-center justify-center",onClick:()=>p(`/ielts-speaking-test/${e.id}`),style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.8)":"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,borderColor:b.border,...b.cardStyle},children:S.jsx(F,{className:"p-3 md:p-4 text-center flex items-center justify-center h-full",children:S.jsx("h3",{className:"font-semibold text-sm",style:{color:b.textPrimary},children:e.test_name})})},e.id))}):S.jsxs("div",{className:"text-center py-12",children:[S.jsx("p",{className:"text-lg mb-4",style:{color:b.textSecondary},children:"No speaking tests available yet"}),S.jsx(B,{onClick:()=>p("/ielts-portal"),variant:"outline",style:{borderColor:b.border,color:b.textPrimary,backgroundColor:"glassmorphism"===b.theme.name||"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground},onMouseEnter:e=>e.currentTarget.style.backgroundColor=b.hoverBg,onMouseLeave:e=>e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name||"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,children:"Back to Portal"})]})]})})})})})]});if(!y)return S.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:S.jsxs("div",{className:"text-center",children:[S.jsx("p",{className:"text-lg text-muted-foreground",children:"Test not found"}),S.jsx(B,{onClick:()=>p("/ielts-portal"),className:"mt-4",children:"Back to Portal"})]})});if(0===y.part1_prompts.length&&!y.part2_prompt&&0===y.part3_prompts.length)return S.jsx(I,{title:`IELTS Speaking - ${y.test_name}`,showBackButton:!0,children:S.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[S.jsxs("div",{className:"text-center",children:[S.jsx(q,{variant:"outline",className:"mb-4 px-4 py-1 text-primary border-primary/20",children:"IELTS SPEAKING TEST"}),S.jsx("h1",{className:"text-heading-2 mb-2",children:y.test_name})]}),S.jsx(D,{className:"card-modern",children:S.jsxs(F,{className:"p-8 text-center",children:[S.jsx(z,{className:"w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-500"}),S.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Speaking Content Available"}),S.jsx("p",{className:"text-muted-foreground mb-6",children:"This test doesn't have speaking content created yet. Please contact your administrator or try another test."}),S.jsxs("div",{className:"flex gap-4 justify-center",children:[S.jsx(B,{onClick:()=>p("/ielts-portal"),variant:"outline",children:"Back to Portal"}),S.jsx(B,{onClick:()=>p("/speaking"),children:"Try General Speaking Practice"})]})]})})]})});const $t=()=>1===k?y.part1_prompts[N]:2===k?y.part2_prompt:3===k?y.part3_prompts[N]:null,Ft=()=>{const e=$t();return e?2===k?e.prompt_text||"":e.transcription||e.title||"":""},Bt=async e=>{const t=e||ut.trim();if(!t||pt)return;const r={id:Date.now().toString(),type:"user",content:t,timestamp:new Date};dt(e=>[...e,r]),e||mt(""),ht(!0);try{const e=Ft(),r=`CONTEXT: The student is practicing IELTS Speaking Part ${k}.\n\nQuestion: "${e}"\n\nPlease provide concise, practical speaking guidance (ideas, vocabulary, structure). Do NOT write a full answer.`,n=ct.filter(e=>"user"===e.type||"bot"===e.type).map(e=>({role:"user"===e.type?"user":"assistant",content:e.content}));n.push({role:"user",content:t});const{data:a,error:o}=await ve.functions.invoke("openai-chat",{body:{skipCache:!0,messages:[{role:"system",content:r},...n],context:"catbot"}});if(o)throw o;const s={id:(Date.now()+1).toString(),type:"bot",content:a.response,timestamp:new Date};dt(e=>[...e,s])}catch(n){console.error("Error sending chat message:",n),g({title:"Error",description:"Failed to get response from Catie",variant:"destructive"})}finally{ht(!1)}},qt=e=>{Bt(e)},Dt=$t(),zt=Ft(),Ut=1===k?"Part 1":2===k?"Part 2":3===k?"Part 3":"Unknown Part";return S.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===b.theme.name?b.theme.colors.background:"transparent"},children:[S.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===b.theme.name||"minimalist"===b.theme.name||"dark"===b.theme.name?"none":"url('/1000031207.png')",backgroundColor:b.backgroundImageColor}}),S.jsx("div",{className:"relative z-10 min-h-screen flex flex-col",style:{backgroundColor:"dark"===b.theme.name?b.theme.colors.background:"transparent"},children:S.jsx(I,{title:`IELTS Speaking - ${y.test_name}`,showBackButton:!0,children:S.jsx("div",{className:"flex-1 flex justify-center min-h-[calc(100vh-120px)] py-8 sm:items-center sm:py-8",children:S.jsxs("div",{className:"w-full max-w-4xl mx-auto space-y-4 px-4 flex flex-col",children:[S.jsx("div",{className:"text-center py-2 sm:py-2 sm:mb-0 mb-0",children:S.jsxs("span",{className:"text-lg font-semibold",style:{color:b.textPrimary},children:["Part ",k]})}),S.jsxs(D,{ref:Pt,className:"backdrop-blur-sm shadow-lg rounded-2xl flex flex-col relative",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,borderColor:b.border,backdropFilter:"glassmorphism"===b.theme.name?"blur(12px)":"dark"===b.theme.name?"blur(8px)":"none",boxShadow:"dark"===b.theme.name?"0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1)":"note"===b.theme.name?null==(e=b.theme.styles.cardStyle)?void 0:e.boxShadow:"0 8px 32px rgba(15, 23, 42, 0.16), 0 0 0 1px rgba(148, 163, 253, 0.06)",...b.cardStyle},children:[S.jsx(U,{children:S.jsxs(W,{className:"flex items-center justify-between",children:[S.jsx("span",{}),S.jsxs("div",{className:"flex items-center gap-3",children:[(1===k||3===k)&&S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx("div",{onClick:()=>at(!nt),className:"relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background",style:{backgroundColor:nt?b.buttonPrimary:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.2)":"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#e5e7eb":b.border},"data-state":nt?"checked":"unchecked",children:S.jsx("div",{className:"pointer-events-none flex h-5 w-5 rounded-full shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0 items-center justify-center",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.95)":"dark"===b.theme.name?"rgba(255,255,255,0.9)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground},"data-state":nt?"checked":"unchecked",children:nt?S.jsx(K,{className:"w-3 h-3",style:{color:"white"}}):S.jsx(Y,{className:"w-3 h-3",style:{color:b.textSecondary}})})})}),S.jsx(Q,{children:S.jsx("p",{children:nt?"Hide question":"Show question"})})]})}),De>0&&S.jsxs(q,{variant:"outline",className:"flex items-center gap-2",style:{borderColor:b.border,backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,color:b.textPrimary},children:[S.jsx(Z,{className:"w-4 h-4",style:{color:b.textPrimary}}),It(De)]})]})]})}),S.jsxs(F,{className:"space-y-4 flex flex-col relative",children:[2===k&&Ue>0&&S.jsx("div",{className:"text-center",children:S.jsxs("div",{className:"flex items-center justify-center gap-2",children:[S.jsx(Z,{className:"w-5 h-5",style:{color:b.buttonPrimary}}),S.jsx("p",{className:"text-xl font-bold",style:{color:b.buttonPrimary},children:It(Ue)})]})}),1===k&&y.part1_prompts.length>0&&S.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:S.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:nt&&S.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:b.textPrimary},children:Ft()})})}),3===k&&y.part3_prompts.length>0&&S.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:S.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:nt&&S.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:b.textPrimary},children:Ft()})})}),2===k&&Dt&&S.jsxs("div",{className:"p-6 rounded-lg",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:b.border,borderWidth:"1px",borderStyle:"solid"},children:[S.jsx("h3",{className:"font-semibold mb-3",style:{color:b.textPrimary},children:"Cue Card"}),S.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",style:{color:b.textSecondary},children:Dt.prompt_text})]}),2===k&&S.jsxs(S.Fragment,{children:[Ue>0&&S.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#fef3c7":"#FEF9E7",borderColor:b.border,borderWidth:"1px",borderStyle:"solid"},children:[S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"ghost",size:"icon",onClick:()=>{We(e=>e+60)},className:"absolute top-2 right-2 h-8 w-8",style:{color:b.buttonPrimary},children:S.jsx(J,{className:"w-4 h-4"})})}),S.jsx(Q,{children:S.jsx("p",{children:"Add 1 minute for notes"})})]})}),S.jsx("textarea",{placeholder:"Write your preparation notes here...",value:He,onChange:e=>Ke(e.target.value),className:"w-full h-32 p-3 bg-transparent resize-none focus:outline-none",style:{color:b.textPrimary}}),S.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      textarea[placeholder="Write your preparation notes here..."]::placeholder {\n                        color: ${b.textSecondary};\n                      }\n                    `}})]}),(0===Ue||E)&&He&&S.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#fef3c7":"#FEF9E7",borderColor:b.border,borderWidth:"1px",borderStyle:"solid"},children:[!E&&S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"ghost",size:"icon",onClick:()=>{We(60),Lt()},className:"absolute top-2 right-2 h-8 w-8 text-primary",children:S.jsx(J,{className:"w-4 h-4"})})}),S.jsx(Q,{children:S.jsx("p",{children:"Add 1 minute for notes"})})]})}),S.jsx("div",{className:"p-3 text-sm whitespace-pre-wrap",style:{color:b.textPrimary},children:He})]})]}),(2===k&&0===Ue||2!==k)&&S.jsx("div",{className:"text-center min-h-[80px] flex items-center justify-center relative",children:E?S.jsxs(S.Fragment,{children:[S.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 w-[130px] sm:w-[180px]",children:S.jsx(tr,{active:!0,height:55,barWidth:6,barGap:2,barRadius:3,mode:"static",fadeEdges:!1,barColor:"#2563eb",sensitivity:1.2,fftSize:256,historySize:60,updateRate:30})}),S.jsx(B,{onClick:Mt,variant:"outline",size:"icon",className:"rounded-xl h-8 w-8 absolute bottom-0 left-1/2 transform -translate-x-1/2",style:{borderColor:b.border,color:b.buttonPrimary,backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},children:S.jsx(X,{className:"w-4 h-4",style:{color:b.buttonPrimary||"#2563eb"}})})]}):S.jsx(V,{children:S.jsxs("div",{className:"flex items-center justify-center gap-3",children:[S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{onClick:async()=>{try{Tt(),await new Promise(e=>setTimeout(e,100));const e=await navigator.mediaDevices.getUserMedia({audio:!0});jt.current=new MediaRecorder(e),Nt.current=[],jt.current.ondataavailable=e=>{e.data.size>0&&Nt.current.push(e.data)},jt.current.onstop=()=>{const t=new Blob(Nt.current,{type:"audio/webm"}),r=`part${k}_q${N}`;console.log(`üíæ Saving recording for ${r}, blob size: ${t.size}`),Ge(e=>{const n={...e,[r]:t};return console.log("üì± Recordings updated:",Object.keys(n)),n}),xe(!1),e.getTracks().forEach(e=>e.stop())},jt.current.start(),xe(!0),Ct.current=Date.now(),(1===k||3===k||2===k)&&ze(120)}catch(e){console.error("Error starting recording:",e),g({title:"Recording Error",description:"Failed to start recording. Please check microphone permissions.",variant:"destructive"})}},variant:"outline",className:"rounded-xl shadow-sm h-12 w-12",size:"icon",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.8)":"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,borderColor:b.border,color:b.textPrimary},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg,e.currentTarget.style.color=b.buttonPrimary},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.8)":"dark"===b.theme.name?"rgba(255,255,255,0.1)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,e.currentTarget.style.color=b.textPrimary},children:S.jsx(z,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:"Start recording your answer"})})]}),(null==Dt?void 0:Dt.audio_url)&&S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{onClick:()=>{const e=$t();(null==e?void 0:e.audio_url)&&(console.log(`üîÅ Repeating audio for Part ${k}`),(async e=>{var t;if(e){ot||(st(!0),lt(!1));try{Re(!0),kt.current&&(kt.current.pause(),kt.current.currentTime=0,kt.current=null);const t=new Audio(e);t.preload="auto",t.volume=Et.current,t.onended=()=>{Re(!1),console.log("‚úÖ Audio playback completed"),kt.current=null},t.onerror=e=>{Re(!1),console.error("Audio playback error:",e),kt.current=null,g({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable.",variant:"destructive"})},t.onloadstart=()=>{console.log("Audio loading started")},t.oncanplay=()=>{console.log("Audio can play")},t.oncanplaythrough=()=>{console.log("Audio can play through")},kt.current=t,console.log(`‚ñ∂Ô∏è Playing audio: ${e}`),t.load(),await new Promise(e=>setTimeout(e,100));const r=t.play();void 0!==r&&(await r,console.log("Audio started playing successfully"))}catch(r){console.error("Error playing audio:",r),Re(!1),"NotAllowedError"===r.name||(null==(t=r.message)?void 0:t.includes("user didn't interact"))?(ot||lt(!0),console.log("Autoplay blocked - user needs to interact first")):g({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable. Please try again.",variant:"destructive"}),kt.current&&(kt.current=null)}}})(e.audio_url))},disabled:Me,variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:b.border,color:b.buttonPrimary,backgroundColor:"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:Me?S.jsx(ee,{className:"w-5 h-5"}):S.jsx(te,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:Me?"Pause question audio":"Play question audio"})})]}),Ve[`part${k}_q${N}`]&&S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{onClick:()=>{vt(!xt),xt&&Le&&(()=>{if(Be)try{Be.pause(),Be.currentTime=0,console.log("üõë Stopped recording playback")}catch(e){console.error("Error stopping recording playback:",e)}Ie(!1),Fe(null),qe(null)})()},variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:b.border,color:b.buttonPrimary,backgroundColor:xt?"dark"===b.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=xt?"dark"===b.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},children:S.jsx(re,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:xt?"Hide audio player":"Listen to your recorded answer"})})]}),(console.log("üîç DEBUG: Checking evaluate button condition",{currentPart:k,currentQuestion:N,key:`part${k}_q${N}`,hasRecording:!!Ve[`part${k}_q${N}`],allRecordingKeys:Object.keys(Ve),recordingValue:Ve[`part${k}_q${N}`]}),null),Ve[`part${k}_q${N}`]&&S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{onClick:async()=>{var e,t;const r=`part${k}_q${N}`,n=Ve[r];if(console.log("üéØ EVALUATE: Current part:",k),console.log("üéØ EVALUATE: Current question:",N),console.log("üéØ EVALUATE: Recording key:",r),console.log("üéØ EVALUATE: Recording exists:",!!n),console.log("üéØ EVALUATE: Recording size:",null==n?void 0:n.size),console.log("üéØ EVALUATE: All recording keys:",Object.keys(Ve)),!n)return console.error("‚ùå No recording found for",r),void g({title:"No Recording Found",description:"Please record your answer first before evaluating.",variant:"destructive"});const a=n.size/1048576;if(console.log(`üì¶ Audio file size: ${a.toFixed(2)} MB`),a>15)g({title:"Recording Too Large",description:"Your recording is too large to process. Try keeping your response shorter.",variant:"destructive"});else{gt(!0),yt(null);try{const e=await new Promise((e,t)=>{const r=new FileReader;r.onloadend=()=>{const t=r.result;e(t.split(",")[1])},r.onerror=()=>t(new Error("Failed to read audio file")),r.readAsDataURL(n)});console.log(`üì§ Base64 audio length: ${(e.length/1024).toFixed(0)} KB`);const t=Ft();console.log("üì§ Sending to Edge Function:",{audioLength:e.length,prompt:t,recordingKey:r});const a=2===k?9e4:6e4,o=new AbortController,s=setTimeout(()=>o.abort(),a),{data:i,error:l}=await ve.functions.invoke("ielts-speaking-evaluator",{body:{audio:e,prompt:t}});if(clearTimeout(s),l){const e=l.message||"";if(e.includes("FunctionsFetchError")||e.includes("Failed to send a request"))throw new Error("AI evaluation service is currently unavailable. Please try again in a moment.");throw l}if(null==i?void 0:i.error)throw console.error("‚ùå API returned error:",i.error),new Error(i.error);if(!i||!i.metrics||"object"!=typeof i.metrics)throw console.error("‚ùå Invalid response structure:",i),new Error("Invalid response from evaluation service. Please try again.");const c={...i,metrics:{pronunciation:Number(i.metrics.pronunciation)||0,vocabulary:Number(i.metrics.vocabulary)||0,grammar:Number(i.metrics.grammar)||0,intonation:Number(i.metrics.intonation)||0,fluency:Number(i.metrics.fluency)||0}};console.log("‚úÖ Evaluation received:",c),console.log("üìä Validated metrics:",c.metrics),yt(c)}catch(o){console.error("Evaluation error:",o);let r="Could not evaluate the recording. Please try again.";(null==(e=null==o?void 0:o.message)?void 0:e.includes("unavailable"))||(null==(t=null==o?void 0:o.message)?void 0:t.includes("FunctionsFetchError"))?r="AI evaluation service is temporarily unavailable. Please try again in a few moments.":(null==o?void 0:o.message)&&(r=o.message),g({title:"Evaluation Failed",description:r,variant:"destructive",duration:6e3})}finally{gt(!1)}}},disabled:ft,variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl relative",style:{borderColor:b.border,color:b.buttonPrimary,backgroundColor:ft?"dark"===b.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},onMouseEnter:e=>{ft||(e.currentTarget.style.backgroundColor=b.hoverBg)},onMouseLeave:e=>{ft||(e.currentTarget.style.backgroundColor="transparent")},children:ft?S.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-current border-t-transparent"}):S.jsx(ne,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:ft?"Evaluating your answer...":"Evaluate with AI"})})]})]})})}),xt&&Ve[`part${k}_q${N}`]&&!bt&&S.jsx("div",{className:"mt-4 p-4 rounded-xl border animate-in fade-in slide-in-from-top-4 duration-300",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"#ffffff"},children:S.jsxs("div",{className:"space-y-3",children:[S.jsxs("h4",{className:"font-medium flex items-center gap-2 text-sm uppercase tracking-wider opacity-80",style:{color:b.textPrimary},children:[S.jsx(re,{className:"w-4 h-4"}),"Your Recorded Answer"]}),St&&S.jsx("div",{className:"p-2 rounded-xl border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(0,0,0,0.2)":"rgba(255,255,255,0.5)"},children:S.jsx(ye,{src:St,accentColor:b.buttonPrimary,style:{backgroundColor:"transparent"}})}),S.jsx("div",{className:"flex justify-end",children:S.jsx(B,{variant:"ghost",size:"sm",onClick:()=>vt(!1),className:"h-8 px-3 text-xs",style:{color:b.textSecondary},children:"Hide Player"})})]})}),ft&&S.jsx("div",{className:"mt-4 flex items-center justify-center animate-in fade-in slide-in-from-top-2 duration-300",children:S.jsxs("div",{className:"flex items-center gap-3 px-5 py-3 rounded-full shadow-lg border",style:{backgroundColor:"dark"===b.theme.name?"rgba(30, 41, 59, 0.95)":"rgba(255, 255, 255, 0.98)",borderColor:b.border,boxShadow:`0 4px 20px -4px ${b.buttonPrimary}30`},children:[S.jsx("div",{className:"w-8 h-8",children:S.jsx(L,{size:"sm",message:""})}),S.jsxs("div",{className:"flex flex-col",children:[S.jsx("p",{className:"text-sm font-medium",style:{color:b.textPrimary},children:"Catie is evaluating..."}),S.jsx("p",{className:"text-xs",style:{color:b.textSecondary},children:"You can continue practicing"})]})]})}),bt&&S.jsxs("div",{className:"mt-8 p-6 rounded-2xl border animate-in fade-in slide-in-from-top-4 duration-500 max-w-3xl mx-auto text-left shadow-lg relative overflow-hidden",style:{borderColor:b.border,backgroundColor:b.theme.colors.cardBackground||"#ffffff",color:b.textPrimary},children:[S.jsxs("div",{className:"flex items-center justify-between mb-6 relative z-10",children:[S.jsxs("div",{className:"flex items-center gap-3",children:[S.jsxs("div",{className:"relative",children:[S.jsx("img",{src:"/1000031289.png",alt:"Catie AI",className:"w-14 h-14 rounded-full shadow-md object-cover ring-2 ring-offset-2",style:{ringColor:b.buttonPrimary}}),S.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center shadow-sm border-2 border-white",style:{backgroundColor:b.buttonPrimary},children:S.jsx(ne,{className:"w-2.5 h-2.5 text-white"})})]}),S.jsx("div",{children:S.jsx("h3",{className:"font-bold text-lg",style:{color:b.textPrimary},children:"Catie's Feedback"})})]}),S.jsx(B,{variant:"ghost",size:"sm",onClick:()=>yt(null),className:"h-8 w-8 p-0 opacity-60 hover:opacity-100",children:S.jsx(ae,{className:"w-4 h-4"})})]}),S.jsx("div",{className:"mb-6 space-y-4 relative z-10",children:S.jsxs("div",{className:"rounded-xl p-4 space-y-3 border",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"#ffffff",borderColor:b.border},children:[S.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2 text-xs uppercase tracking-wider opacity-80",style:{color:b.textPrimary},children:[S.jsx(re,{className:"w-3.5 h-3.5"}),"Your Response"]}),St?S.jsx("div",{className:"p-2 rounded-xl border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(0,0,0,0.2)":"rgba(255,255,255,0.5)"},children:S.jsx(ye,{src:St,accentColor:b.buttonPrimary,style:{backgroundColor:"transparent"}})}):S.jsxs("div",{className:"text-xs italic p-3 rounded-lg border flex items-center gap-2",style:{borderColor:b.border,color:b.textSecondary},children:[S.jsx(Ae,{className:"w-4 h-4"}),"Audio recording not available"]}),S.jsx("div",{className:"mt-4",children:S.jsxs("div",{className:"rounded-xl p-4 border shadow-sm relative group",style:{backgroundColor:"dark"===b.theme.name?"rgba(0,0,0,0.2)":"#ffffff",borderColor:b.border},children:[S.jsx("div",{className:"absolute top-3 right-3 opacity-20 group-hover:opacity-50 transition-opacity",children:S.jsx(oe,{className:"w-4 h-4"})}),S.jsxs("p",{className:"text-sm leading-relaxed italic",style:{color:b.textPrimary},children:['"',bt.transcription,'"']})]})})]})}),S.jsx("div",{className:"mb-8",children:S.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6 items-center",children:[S.jsx("div",{className:"flex flex-col items-center justify-center p-4 rounded-2xl border",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.03)":"minimalist"===b.theme.name?"#ffffff":"rgba(255,255,255,0.5)",borderColor:b.border},children:S.jsx(Xt,{score:Math.round(Object.values(bt.metrics||{}).reduce((e,t)=>e+t,0)/(Object.keys(bt.metrics||{}).length||1)),label:"Overall",subLabel:"Speaking Score",size:160,color:b.buttonPrimary})}),S.jsx("div",{className:"flex items-center justify-center p-4 rounded-2xl border min-h-[240px]",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.03)":"minimalist"===b.theme.name?"#ffffff":"rgba(255,255,255,0.5)",borderColor:b.border},children:S.jsx(er,{metrics:{pronunciation:(null==(t=bt.metrics)?void 0:t.pronunciation)||0,vocabulary:(null==(r=bt.metrics)?void 0:r.vocabulary)||0,grammar:(null==(n=bt.metrics)?void 0:n.grammar)||0,intonation:(null==(a=bt.metrics)?void 0:a.intonation)||0,fluency:(null==(o=bt.metrics)?void 0:o.fluency)||0},width:240,height:220})})]})}),S.jsx(be,{className:"my-6",style:{backgroundColor:b.border}}),S.jsxs("div",{className:"space-y-2 mb-6",children:[S.jsxs("h3",{className:"font-semibold text-base flex items-center gap-2",style:{color:b.textPrimary},children:[S.jsx(se,{className:"w-4 h-4",style:{color:b.buttonPrimary}}),"Feedback"]}),S.jsx("p",{className:"text-sm leading-relaxed",style:{color:b.textSecondary},children:bt.feedback})]}),S.jsxs("div",{className:"p-4 rounded-xl space-y-2 mb-6 border-2",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.05)":"glassmorphism"===b.theme.name?"rgba(255,255,255,0.7)":"minimalist"===b.theme.name?"#f0f9ff":"rgba(255,255,255,0.4)",borderColor:`${b.buttonPrimary}40`},children:[S.jsxs("h3",{className:"font-semibold flex items-center gap-2 text-xs uppercase tracking-wide",style:{color:b.buttonPrimary},children:[S.jsx(ne,{className:"w-3 h-3"}),"Try saying it like this"]}),S.jsxs("p",{className:"text-base italic font-medium",style:{color:b.textPrimary},children:['"',bt.enhancedSentence,'"']})]}),bt.detailedAnalysis&&S.jsxs("div",{className:"space-y-3",children:[S.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2",style:{color:b.textPrimary},children:[S.jsx(ie,{className:"w-4 h-4",style:{color:b.textSecondary}}),"Detailed Analysis"]}),S.jsxs("div",{className:"grid gap-2",children:[bt.detailedAnalysis.pronunciation&&S.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[S.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[S.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:b.textPrimary},children:"Pronunciation"}),S.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:b.textSecondary},children:[(null==(s=bt.metrics)?void 0:s.pronunciation)||0,"%"]})]}),S.jsx("p",{className:"text-xs leading-relaxed",style:{color:b.textSecondary},children:bt.detailedAnalysis.pronunciation})]}),bt.detailedAnalysis.vocabulary&&S.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[S.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[S.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:b.textPrimary},children:"Vocabulary"}),S.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:b.textSecondary},children:[(null==(i=bt.metrics)?void 0:i.vocabulary)||0,"%"]})]}),S.jsx("p",{className:"text-xs leading-relaxed",style:{color:b.textSecondary},children:bt.detailedAnalysis.vocabulary})]}),bt.detailedAnalysis.grammar&&S.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[S.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[S.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:b.textPrimary},children:"Grammar"}),S.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:b.textSecondary},children:[(null==(l=bt.metrics)?void 0:l.grammar)||0,"%"]})]}),S.jsx("p",{className:"text-xs leading-relaxed",style:{color:b.textSecondary},children:bt.detailedAnalysis.grammar})]}),bt.detailedAnalysis.intonation&&S.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[S.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[S.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:b.textPrimary},children:"Intonation"}),S.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:b.textSecondary},children:[(null==(c=bt.metrics)?void 0:c.intonation)||0,"%"]})]}),S.jsx("p",{className:"text-xs leading-relaxed",style:{color:b.textSecondary},children:bt.detailedAnalysis.intonation})]}),bt.detailedAnalysis.fluency&&S.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:b.border,backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[S.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[S.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:b.textPrimary},children:"Fluency"}),S.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===b.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:b.textSecondary},children:[(null==(d=bt.metrics)?void 0:d.fluency)||0,"%"]})]}),S.jsx("p",{className:"text-xs leading-relaxed",style:{color:b.textSecondary},children:bt.detailedAnalysis.fluency})]})]})]})]}),Ye&&S.jsx("div",{className:"flex justify-center mt-4",children:S.jsxs("div",{className:"flex items-center gap-3",children:[S.jsxs(le,{value:Ze,onValueChange:Je,children:[S.jsx(ce,{className:"w-[90px] h-8 text-sm border-0 bg-transparent shadow-none p-0 focus:ring-0",style:{color:b.textPrimary,"--tw-ring-color":b.buttonPrimary},children:S.jsx(de,{placeholder:"Language"})}),S.jsx(ue,{children:Oe.map(e=>S.jsx(me,{value:e.value,children:e.label},e.value))})]}),S.jsx(B,{type:"button",onClick:()=>{try{localStorage.setItem("ielts_speaking_feedback_language",Ze||"en")}catch(e){console.warn("Unable to persist feedback language preference",e)}(async()=>{var e,t,r,n,a,o;try{const i=Object.entries(Ve);if(0===i.length)return void g({title:"No recordings found",description:"Please record answers before submitting.",variant:"destructive"});console.log("üìù Preparing speaking uploads:",{count:i.length,keys:i.map(([e])=>e)});const l=i.map(async([e,t],r)=>{var n,a,o,s,l,c,d,u,m,p,h,f,b,x,v,j;const k=(null==y?void 0:y.id)||"unknown",w=Date.now(),N=`speaking_${k}_${e}_${w}.webm`,P=new File([t],N,{type:"audio/webm"});try{console.log(`üì§ Uploading speaking recording [${r+1}/${i.length}]:`,{fileName:N,key:e,size:t.size});const m=await je.uploadSpeaking(P,k,e);if(!m.success)throw console.error(`‚ùå R2 upload reported failure for ${N}:`,m.error),new Error(m.error||"Upload failed");m.url||console.warn(`‚ö†Ô∏è R2 upload returned success but no URL for ${N}. Falling back to deterministic URL.`);const p=m.url||`https://placeholder-r2/${k}/speaking/${encodeURIComponent(e)}/${w}.webm`;console.log(`‚úÖ Speaking recording uploaded successfully: ${p}`);let h="";const f=e.match(/^part(\d+)_q(\d+)$/);if(f){const e=parseInt(f[1],10),t=parseInt(f[2],10);1===e&&(null==(n=null==y?void 0:y.part1_prompts)?void 0:n[t])?h=(null==(a=y.part1_prompts[t])?void 0:a.prompt_text)||(null==(o=y.part1_prompts[t])?void 0:o.transcription)||(null==(s=y.part1_prompts[t])?void 0:s.title)||"":2===e&&(null==y?void 0:y.part2_prompt)?h=y.part2_prompt.prompt_text||y.part2_prompt.transcription||y.part2_prompt.title||"":3===e&&(null==(l=null==y?void 0:y.part3_prompts)?void 0:l[t])&&(h=(null==(c=y.part3_prompts[t])?void 0:c.prompt_text)||(null==(d=y.part3_prompts[t])?void 0:d.transcription)||(null==(u=y.part3_prompts[t])?void 0:u.title)||"")}return{part:e,audio_url:p,question_text:h,upload_error:!1}}catch(C){const t=(null==C?void 0:C.message)||("string"==typeof C?C:"Unknown upload error");console.error(`‚ùå Hard failure uploading ${N}:`,t),g({title:"Upload Warning",description:`We could not upload your recording for ${e}. We will still save your test and run analysis using available audio.`,variant:"destructive"});const r=`https://mock-r2-fallback.local/speaking/${encodeURIComponent(k)}/${encodeURIComponent(e)}/${w}.webm`;let n="";const a=e.match(/^part(\d+)_q(\d+)$/);if(a){const e=parseInt(a[1],10),t=parseInt(a[2],10);1===e&&(null==(m=null==y?void 0:y.part1_prompts)?void 0:m[t])?n=(null==(p=y.part1_prompts[t])?void 0:p.prompt_text)||(null==(h=y.part1_prompts[t])?void 0:h.transcription)||(null==(f=y.part1_prompts[t])?void 0:f.title)||"":2===e&&(null==y?void 0:y.part2_prompt)?n=y.part2_prompt.prompt_text||y.part2_prompt.transcription||y.part2_prompt.title||"":3===e&&(null==(b=null==y?void 0:y.part3_prompts)?void 0:b[t])&&(n=(null==(x=y.part3_prompts[t])?void 0:x.prompt_text)||(null==(v=y.part3_prompts[t])?void 0:v.transcription)||(null==(j=y.part3_prompts[t])?void 0:j.title)||"")}return{part:e,audio_url:r,question_text:n,upload_error:!0,error_message:t}}}),c=await Promise.all(l);if(!c||0===c.length)return console.error("‚ùå No speaking upload results returned"),void g({title:"Upload error",description:"We could not process your recordings. Please try again.",variant:"destructive"});const d=c.filter(e=>!e.upload_error).length,u=c.filter(e=>e.upload_error).length;console.log("üìä Speaking upload summary:",{total:c.length,successfulCount:d,failedCount:u});try{const{data:{user:s}}=await ve.auth.getUser();if(!s)throw new Error("User not authenticated while submitting speaking test");const l=c.map(e=>e.audio_url),{data:m,error:h}=await ve.from("test_results").insert({user_id:s.id,test_type:"speaking",total_questions:c.length,correct_answers:null,score_percentage:0,time_taken:900,audio_urls:l,audio_retention_expires_at:null,test_data:{recordings_count:c.length,parts_completed:[1,2,3],r2_upload_summary:{total:c.length,successful:d,failed:u},retention_policy:"no_auto_expiry_r2_persistent"}}).select().single();if(h||!m)throw h||new Error("Failed to create speaking test result");console.log("‚úÖ Speaking test base records saved. AI scoring will be handled by backend using stored metadata and URLs.");const f=[];for(const i of c){const l=i.part.match(/^part(\d+)/),c=l?parseInt(l[1],10):NaN;if(isNaN(c)||c<1||c>3){console.error(`Invalid part number for recording: ${i.part}`);continue}let d="";if(1===c&&(null==(e=null==y?void 0:y.part1_prompts)?void 0:e.length)){const e=i.part.match(/_q(\d+)/),n=e?parseInt(e[1],10):0;n>=0&&n<y.part1_prompts.length&&(d=(null==(t=y.part1_prompts[n])?void 0:t.prompt_text)||(null==(r=y.part1_prompts[n])?void 0:r.transcription)||"")}else if(2===c&&(null==y?void 0:y.part2_prompt))d=y.part2_prompt.prompt_text||"";else if(3===c&&(null==(n=null==y?void 0:y.part3_prompts)?void 0:n.length)){const e=i.part.match(/_q(\d+)/),t=e?parseInt(e[1],10):0;t>=0&&t<y.part3_prompts.length&&(d=(null==(a=y.part3_prompts[t])?void 0:a.prompt_text)||(null==(o=y.part3_prompts[t])?void 0:o.transcription)||"")}f.push({user_id:s.id,test_result_id:m.id,part_number:c,question_text:d,audio_url:i.audio_url,transcription:"",band_scores:{},detailed_feedback:"",duration_seconds:120})}const{error:g}=await ve.from("speaking_test_results").insert(f);if(g)throw g;console.log("‚úÖ Speaking test base records saved. Running AI scoring..."),console.log("‚ÑπÔ∏è Skipping inline AI scoring for speaking test; base records saved for backend evaluation."),Ge({}),p("/ielts-speaking-results",{state:{testData:y,recordings:c,audioBlobs:Object.fromEntries(i),testResultId:m.id}})}catch(s){console.error("Error saving or scoring speaking results:",s),g({title:"Save error",description:"Failed to save or score speaking results. Your recordings may not be fully processed.",variant:"destructive"})}}catch(i){console.error("Error submitting test:",i),g({title:"Submission Error",description:"Failed to submit test. Please try again.",variant:"destructive"})}})()},className:"font-medium",style:{backgroundColor:b.buttonPrimary,color:"#ffffff"},children:"Submit"})]})}),(1===k||3===k)&&!Ye&&S.jsx(V,{children:S.jsxs(S.Fragment,{children:[S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"ghost",onClick:()=>{console.log("üîô Previous question button clicked"),N>0&&(P(N-1),at(!1),yt(null),vt(!1))},disabled:0===N,size:"icon",className:"absolute bottom-0 left-0 h-12 w-12",style:{color:b.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=b.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=b.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:S.jsx(pe,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:"Previous question"})})]}),S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"ghost",onClick:()=>{console.log("üîò Next question button clicked"),at(!1),Rt()},disabled:!Ve[`part${k}_q${N}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12",style:{color:b.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=b.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=b.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:S.jsx(he,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:Ve[`part${k}_q${N}`]?N!==((null==y?void 0:y.part1_prompts.length)||0)-1||1!==k||(null==y?void 0:y.part2_prompt)||(null==y?void 0:y.part3_prompts)&&0!==y.part3_prompts.length?"Next question":"Complete test":"Please record your answer first"})})]})]})}),2===k&&!Ye&&S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"ghost",onClick:()=>{console.log("üîò Part 2 navigation button clicked"),Rt()},disabled:!Ve[`part${k}_q${N}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12 hover:bg-transparent hover:text-foreground",style:{color:b.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=b.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=b.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:S.jsx(he,{className:"w-5 h-5"})})}),S.jsx(Q,{children:S.jsx("p",{children:Ve[`part${k}_q${N}`]?(null==y?void 0:y.part3_prompts)&&y.part3_prompts.length>0?"Go to Part 3":"Complete test":"Please record your answer first"})})]})})]})]}),S.jsx("div",{className:"fixed bottom-6 left-6 z-40 flex items-center gap-4",children:S.jsx("button",{onClick:()=>p("/ielts-portal"),className:"text-lg cursor-pointer transition-colors",style:{color:b.textSecondary},onMouseEnter:e=>e.currentTarget.style.color=b.buttonPrimary,onMouseLeave:e=>e.currentTarget.style.color=b.textSecondary,children:"Exit Test"})}),Xe&&S.jsxs("div",{className:"fixed bottom-12 right-4 sm:bottom-20 sm:right-[420px] z-50 flex flex-col gap-2 sm:gap-3",children:[S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"outline",size:"icon",onClick:()=>qt("Help with Speaking Structure"),disabled:pt,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:b.border||"#e5e7eb",backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff",color:b.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},children:S.jsx(Te,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:b.buttonPrimary||"#2563eb"}})})}),S.jsx(Q,{side:"left",children:S.jsx("p",{children:"Get help with speaking structure"})})]})}),S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"outline",size:"icon",onClick:()=>qt("Suggest Some Speaking Vocabulary"),disabled:pt,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:b.border||"#e5e7eb",backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff",color:b.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},children:S.jsx(fe,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:b.buttonPrimary||"#2563eb"}})})}),S.jsx(Q,{side:"left",children:S.jsx("p",{children:"Get vocabulary suggestions"})})]})}),S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"outline",size:"icon",onClick:()=>qt("Give me 2-3 straightforward band 7+ example answers for this exact IELTS Speaking question. Just show the actual answers, no explanations."),disabled:pt,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:b.border||"#e5e7eb",backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff",color:b.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},children:S.jsx(ne,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:b.buttonPrimary||"#2563eb"}})})}),S.jsx(Q,{side:"left",children:S.jsx("p",{children:"View band 7+ example answers"})})]})}),S.jsx(V,{children:S.jsxs(G,{children:[S.jsx(H,{asChild:!0,children:S.jsx(B,{variant:"outline",size:"icon",onClick:()=>qt("Help me with grammar for this speaking question"),disabled:pt,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:b.border||"#e5e7eb",backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff",color:b.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=b.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===b.theme.name?"rgba(255,255,255,0.9)":"dark"===b.theme.name?"rgba(255,255,255,0.15)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground||"#ffffff"},children:S.jsx(oe,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:b.buttonPrimary||"#2563eb"}})})}),S.jsx(Q,{side:"left",children:S.jsx("p",{children:"Get grammar help"})})]})})]}),S.jsxs("div",{className:"fixed bottom-6 right-3 sm:bottom-6 sm:right-6 z-50",children:[Xe&&S.jsxs(D,{className:"backdrop-blur-md rounded-3xl w-[260px] h-[360px] sm:w-96 sm:h-[500px] shadow-2xl flex flex-col transform-gpu origin-bottom-right transition-all duration-260 ease-in-out "+(tt?"opacity-100 scale-100 translate-y-0":"opacity-0 scale-75 translate-y-8"),style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.95)":"dark"===b.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,borderColor:b.border,backdropFilter:"glassmorphism"===b.theme.name?"blur(12px)":"dark"===b.theme.name?"blur(8px)":"none",...b.cardStyle},children:[S.jsx(U,{className:"pb-1 sm:pb-2 rounded-t-3xl relative",children:S.jsx("div",{className:"absolute top-1.5 right-1.5 sm:top-2 sm:right-2",children:S.jsx(B,{variant:"ghost",size:"icon",onClick:()=>{rt(!1),setTimeout(()=>{et(!1)},260)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:b.textPrimary},children:"‚úï"})})}),S.jsxs(F,{className:"flex-1 flex flex-col px-2.5 py-2 sm:p-4 overflow-hidden",children:[S.jsx(ke,{className:"flex-1 min-h-0",children:S.jsx(we,{className:"flex-1 min-h-0",children:0!==ct.length||pt?S.jsxs(S.Fragment,{children:[S.jsxs("div",{className:"rounded-lg p-3 mb-4",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:b.border,borderWidth:"1px",borderStyle:"solid"},children:[S.jsx("div",{className:"text-xs uppercase tracking-wide mb-1",style:{color:b.textSecondary},children:"Question"}),S.jsx("div",{className:"text-xs sm:text-sm font-medium",style:{color:b.textPrimary},children:Ut}),S.jsx("div",{className:"text-[10px] sm:text-sm whitespace-pre-wrap mt-1",style:{color:b.textSecondary},children:zt||"No question available."})]}),ct.map(e=>S.jsxs(Ce,{from:"user"===e.type?"user":"assistant",children:["bot"===e.type&&S.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:S.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})}),S.jsx(Se,{children:S.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:b.border,borderWidth:"1px",borderStyle:"solid",color:b.textPrimary},children:S.jsx(_e,{dangerouslySetInnerHTML:{__html:e.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^‚Ä¢ (.*)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}})})}),"user"===e.type&&(null==h?void 0:h.avatar_url)&&S.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:S.jsx("img",{src:h.avatar_url,alt:"Your avatar",style:{width:"100%",height:"100%",objectFit:"cover"}})})]},e.id)),pt&&S.jsxs(Ce,{from:"assistant",children:[S.jsx(Se,{children:S.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:b.border,borderWidth:"1px",borderStyle:"solid"},children:S.jsx(Ee,{text:"Thinking..."})})}),S.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px"},children:S.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]}):S.jsx(Ne,{icon:S.jsx(Pe,{className:"size-9 sm:size-12",style:{color:b.textSecondary}}),title:"Start a conversation",description:"Ask for help with your IELTS speaking practice"})})}),S.jsx("div",{className:"flex-shrink-0 mt-2.5 sm:mt-4",children:S.jsxs("div",{className:"flex gap-1.5 sm:gap-2",children:[S.jsx("input",{type:"text",value:ut,onChange:e=>mt(e.target.value),onKeyPress:e=>"Enter"===e.key&&!pt&&ut.trim()&&Bt(),placeholder:"Ask for speaking help...",className:"flex-1 px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg text-[10px] sm:text-sm focus:outline-none focus:ring-0 resize-none",style:{backgroundColor:"glassmorphism"===b.theme.name?"rgba(255,255,255,0.1)":"dark"===b.theme.name?"rgba(255,255,255,0.05)":"minimalist"===b.theme.name?"#ffffff":b.theme.colors.cardBackground,borderColor:b.border,borderWidth:"1px",borderStyle:"solid",color:b.textPrimary},disabled:pt}),S.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      input[placeholder="Ask for speaking help..."]::placeholder {\n                        color: ${b.textSecondary};\n                      }\n                    `}}),S.jsx(B,{onClick:()=>Bt(),disabled:pt||!ut.trim(),variant:"ghost",size:"icon",className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:b.textPrimary},children:pt?S.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2",style:{borderColor:b.textPrimary}}):S.jsx(ge,{className:"w-4 h-4"})})]})})]})]}),!Xe&&S.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"64px",height:"64px",cursor:"pointer",boxShadow:"0 8px 20px rgba(0,0,0,0.18)",transition:"transform 0.22s ease-out, box-shadow 0.22s ease-out"},onClick:()=>{et(!0),requestAnimationFrame(()=>rt(!0))},onMouseEnter:e=>{const t=e.currentTarget;t.style.transform="scale(1.06) translateY(-2px)",t.style.boxShadow="0 14px 30px rgba(0,0,0,0.24)"},onMouseLeave:e=>{const t=e.currentTarget;t.style.transform="scale(1.0) translateY(0px)",t.style.boxShadow="0 10px 25px rgba(0,0,0,0.15)"},children:S.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]})})})})]})};export{rr as default};
