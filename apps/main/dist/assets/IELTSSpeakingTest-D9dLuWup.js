import{j as e,r,c as t,u as a}from"./vendor-react-rLLBBC7n.js";import{N as s,E as o,d as n,q as l,s as i,a1 as c,y as d,A as m,a as u,B as p,e as h,C as g,O as x,Z as f,_ as b,$ as y,b as v,c as j,S as k,i as w,j as N,k as C,l as _}from"./index-BDl0jLJK.js";import{S}from"./separator-C0bogF69.js";import"./scroll-area-DzIX_ywb.js";import{C as P}from"./CustomAudioPlayer-CDBRrhfP.js";import{R as E,h as T,P as M,i as A,j as $,k as R}from"./vendor-charts-0DeywwxG.js";import{A as L}from"./cloudflare-r2-_AvHNt83.js";import"./slider-BZdCL2PQ.js";import"./dropdown-menu-DF6eZyHV.js";import{C as I,a as q,b as F,O as z,M as B,c as U,R as D,S as W}from"./shimmering-text-bR3LtDD_.js";import{F as O}from"./languages-qPB6CivY.js";import{aO as V,bc as G,aN as H,aM as Y,aA as K,av as Q,aP as J,aK as X,aL as Z,aw as ee,ak as re,X as te,b4 as ae,ap as se,as as oe,H as ne,az as le,Y as ie,ca as ce,ao as de,x as me}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const ue=({score:r,label:t="Score",subLabel:a,size:s=120,strokeWidth:o=8,color:n="#3b82f6"})=>{const l=(s-o)/2,i=2*l*Math.PI,c=i-r/100*i;return e.jsxs("div",{className:"relative flex flex-col items-center justify-center",style:{width:s,height:s},children:[e.jsxs("svg",{width:s,height:s,className:"transform -rotate-90",children:[e.jsx("circle",{cx:s/2,cy:s/2,r:l,stroke:"currentColor",strokeWidth:o,fill:"transparent",className:"text-slate-100 dark:text-slate-800"}),e.jsx("circle",{cx:s/2,cy:s/2,r:l,stroke:n,strokeWidth:o,fill:"transparent",strokeDasharray:i,strokeDashoffset:c,strokeLinecap:"round",className:"transition-all duration-1000 ease-out"})]}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-center",children:[e.jsxs("span",{className:"text-2xl font-bold",style:{color:n},children:[r,"%"]}),t&&e.jsx("span",{className:"text-xs text-slate-500 font-medium uppercase tracking-wider",children:t}),a&&e.jsx("span",{className:"text-[10px] text-slate-400",children:a})]})]})},pe=({metrics:r,width:t=300,height:a=250})=>{const s={pronunciation:Math.max(0,Math.min(100,r.pronunciation||0)),vocabulary:Math.max(0,Math.min(100,r.vocabulary||0)),grammar:Math.max(0,Math.min(100,r.grammar||0)),intonation:Math.max(0,Math.min(100,r.intonation||0)),fluency:Math.max(0,Math.min(100,r.fluency||0))},o=[{subject:"Pronunciation",A:s.pronunciation,fullMark:100},{subject:"Vocabulary",A:s.vocabulary,fullMark:100},{subject:"Grammar",A:s.grammar,fullMark:100},{subject:"Intonation",A:s.intonation,fullMark:100},{subject:"Fluency",A:s.fluency,fullMark:100}],n=Object.values(s).some(e=>e>0);return e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{style:{width:t,height:a,minWidth:200,minHeight:180},children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(T,{cx:"50%",cy:"50%",outerRadius:"55%",data:o,children:[e.jsx(M,{stroke:"#e2e8f0",strokeDasharray:"3 3"}),e.jsx(A,{dataKey:"subject",tick:{fill:"#64748b",fontSize:9,fontWeight:600},tickLine:!1}),e.jsx($,{angle:90,domain:[0,100],tick:!1,axisLine:!1,tickCount:5}),e.jsx(R,{name:"Metrics",dataKey:"A",stroke:"#3b82f6",strokeWidth:2,fill:"#3b82f6",fillOpacity:n?.3:.05,animationDuration:800,animationEasing:"ease-out"})]})})})})};r.createContext(null);const he=({active:t=!1,processing:a=!1,deviceId:o,barWidth:n=3,barGap:l=1,barRadius:i=1.5,barColor:c,fadeEdges:d=!0,fadeWidth:m=24,height:u=64,sensitivity:p=1,smoothingTimeConstant:h=.8,fftSize:g=256,historySize:x=60,updateRate:f=30,mode:b="static",onError:y,onStreamReady:v,onStreamEnd:j,className:k,...w})=>{const N=r.useRef(null),C=r.useRef(null),_=r.useRef([]),S=r.useRef(null),P=r.useRef(null),E=r.useRef(null),T=r.useRef(0),M=r.useRef(0),A=r.useRef(null),$=r.useRef([]),R=r.useRef(0),L=r.useRef([]),I=r.useRef(!0),q=r.useRef(null),F=r.useRef(0),z="number"==typeof u?`${u}px`:u;return r.useEffect(()=>{const e=N.current,r=C.current;if(!e||!r)return;const t=new ResizeObserver(()=>{const t=r.getBoundingClientRect(),a=window.devicePixelRatio||1;e.width=t.width*a,e.height=t.height*a,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`;const s=e.getContext("2d");s&&s.scale(a,a),q.current=null,F.current=t.width,I.current=!0});return t.observe(r),()=>t.disconnect()},[]),r.useEffect(()=>{if(a&&!t){let e=0;R.current=0;const r=()=>{var t;e+=.03,R.current=Math.min(1,R.current+.02);const a=[],s=Math.floor(((null==(t=C.current)?void 0:t.getBoundingClientRect().width)||200)/(n+l));if("static"===b){const r=Math.floor(s/2);for(let t=0;t<s;t++){const s=(t-r)/r,o=1-.4*Math.abs(s),n=(.2+(.25*Math.sin(1.5*e+3*s)+.2*Math.sin(.8*e-2*s)+.15*Math.cos(2*e+s)))*o;let l=n;if($.current.length>0&&R.current<1){const e=Math.min(t,$.current.length-1);l=($.current[e]||0)*(1-R.current)+n*R.current}a.push(Math.max(.05,Math.min(1,l)))}}else for(let r=0;r<s;r++){const t=(r-s/2)/(s/2),o=1-.4*Math.abs(t),n=(.2+(.25*Math.sin(1.5*e+.15*r)+.2*Math.sin(.8*e-.1*r)+.15*Math.cos(2*e+.05*r)))*o;let l=n;if($.current.length>0&&R.current<1){const e=Math.floor(r/s*$.current.length);l=($.current[e]||0)*(1-R.current)+n*R.current}a.push(Math.max(.05,Math.min(1,l)))}"static"===b?L.current=a:_.current=a,I.current=!0,A.current=requestAnimationFrame(r)};return r(),()=>{A.current&&cancelAnimationFrame(A.current)}}if(!t&&!a){if("static"===b?L.current.length>0:_.current.length>0){let e=0;const r=()=>{e+=.03,e<1?("static"===b?L.current=L.current.map(r=>r*(1-e)):_.current=_.current.map(r=>r*(1-e)),I.current=!0,requestAnimationFrame(r)):"static"===b?L.current=[]:_.current=[]};r()}}},[a,t,n,l,b]),r.useEffect(()=>{if(!t)return E.current&&(E.current.getTracks().forEach(e=>e.stop()),E.current=null,null==j||j()),P.current&&"closed"!==P.current.state&&(P.current.close(),P.current=null),void(T.current&&(cancelAnimationFrame(T.current),T.current=0));return(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:o?{deviceId:{exact:o},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});E.current=e,null==v||v(e);const r=new(window.AudioContext||window.webkitAudioContext),t=r.createAnalyser();t.fftSize=g,t.smoothingTimeConstant=h;r.createMediaStreamSource(e).connect(t),P.current=r,S.current=t,_.current=[]}catch(e){null==y||y(e)}})(),()=>{E.current&&(E.current.getTracks().forEach(e=>e.stop()),E.current=null,null==j||j()),P.current&&"closed"!==P.current.state&&(P.current.close(),P.current=null),T.current&&(cancelAnimationFrame(T.current),T.current=0)}},[t,o,g,h,y,v,j]),r.useEffect(()=>{const e=N.current;if(!e)return;const r=e.getContext("2d");if(!r)return;let s;const o=u=>{const h=e.getBoundingClientRect();if(t&&u-M.current>f&&(M.current=u,S.current)){const e=new Uint8Array(S.current.frequencyBinCount);if(S.current.getByteFrequencyData(e),"static"===b){const r=Math.floor(.05*e.length),t=Math.floor(.4*e.length),a=e.slice(r,t),s=Math.floor(h.width/(n+l)),o=Math.floor(s/2),i=[];for(let e=o-1;e>=0;e--){const r=Math.floor(e/o*a.length),t=Math.min(1,a[r]/255*p);i.push(Math.max(.05,t))}for(let e=0;e<o;e++){const r=Math.floor(e/o*a.length),t=Math.min(1,a[r]/255*p);i.push(Math.max(.05,t))}L.current=i,$.current=i}else{let r=0;const t=Math.floor(.05*e.length),a=Math.floor(.4*e.length),s=e.slice(t,a);for(let e=0;e<s.length;e++)r+=s[e];const o=r/s.length/255*p;_.current.push(Math.min(1,Math.max(.05,o))),$.current=[..._.current],_.current.length>x&&_.current.shift()}I.current=!0}if(!I.current&&!t)return void(s=requestAnimationFrame(o));I.current=t,r.clearRect(0,0,h.width,h.height);const g=c||getComputedStyle(e).color||"#000",y=n+l,v=Math.floor(h.width/y),j=h.height/2;if("static"===b){const e=a||t||L.current.length>0?L.current:[];for(let t=0;t<v&&t<e.length;t++){const a=e[t]||.1,s=t*y,o=Math.max(4,a*h.height*.8),l=j-o/2;r.fillStyle=g,r.globalAlpha=.4+.6*a,i>0?(r.beginPath(),r.roundRect(s,l,n,o,i),r.fill()):r.fillRect(s,l,n,o)}}else for(let e=0;e<v&&e<_.current.length;e++){const t=_.current.length-1-e,a=_.current[t]||.1,s=h.width-(e+1)*y,o=Math.max(4,a*h.height*.8),l=j-o/2;r.fillStyle=g,r.globalAlpha=.4+.6*a,i>0?(r.beginPath(),r.roundRect(s,l,n,o,i),r.fill()):r.fillRect(s,l,n,o)}if(d&&m>0&&h.width>0){if(!q.current||F.current!==h.width){const e=r.createLinearGradient(0,0,h.width,0),t=Math.min(.3,m/h.width);e.addColorStop(0,"rgba(255,255,255,1)"),e.addColorStop(t,"rgba(255,255,255,0)"),e.addColorStop(1-t,"rgba(255,255,255,0)"),e.addColorStop(1,"rgba(255,255,255,1)"),q.current=e,F.current=h.width}r.globalCompositeOperation="destination-out",r.fillStyle=q.current,r.fillRect(0,0,h.width,h.height),r.globalCompositeOperation="source-over"}r.globalAlpha=1,s=requestAnimationFrame(o)};return s=requestAnimationFrame(o),()=>{s&&cancelAnimationFrame(s)}},[t,a,p,f,x,n,l,i,c,d,m,b]),e.jsxs("div",{className:s("relative h-full w-full",k),ref:C,style:{height:z},"aria-label":t?"Live audio waveform":a?"Processing audio":"Audio waveform idle",role:"img",...w,children:[!t&&!a&&e.jsx("div",{className:"border-muted-foreground/20 absolute top-1/2 right-0 left-0 -translate-y-1/2 border-t-2 border-dotted"}),e.jsx("canvas",{className:"block h-full w-full",ref:N,"aria-hidden":"true"})]})},ge=()=>{var s,E,T,M,A,$,R,ge,xe,fe,be;const ye=t(),ve=ye.testId||ye.testName,je=a(),{profile:ke}=o(),{toast:we}=n(),Ne=l(),[Ce,_e]=r.useState(null),[Se,Pe]=r.useState([]),[Ee,Te]=r.useState(1),[Me,Ae]=r.useState(0),[$e,Re]=r.useState(!0),[Le,Ie]=r.useState(!1),[qe,Fe]=r.useState(!1),[ze,Be]=r.useState(!1),[Ue,De]=r.useState(null),[We,Oe]=r.useState(null),[Ve,Ge]=r.useState(0),[He,Ye]=r.useState(60),[Ke,Qe]=r.useState({}),[Je,Xe]=r.useState(new Set),[Ze,er]=r.useState("");r.useState(!1),r.useState("");const[rr,tr]=r.useState(!1),[ar,sr]=r.useState("en");r.useEffect(()=>{(async()=>{if(null==ke?void 0:ke.id)try{const{data:e}=await i.from("user_preferences").select("preferred_feedback_language, native_language").eq("user_id",ke.id).maybeSingle(),r=e,t=(null==r?void 0:r.preferred_feedback_language)||(null==r?void 0:r.native_language);t&&O.find(e=>e.value===t)&&sr(t)}catch(e){console.warn("Error loading user preferred language:",e)}})()},[null==ke?void 0:ke.id]);const[or,nr]=r.useState(!1),[lr,ir]=r.useState(!1),[cr,dr]=r.useState(!1),[mr,ur]=r.useState(!1),[pr,hr]=r.useState(!1),[gr,xr]=r.useState([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}]),[fr,br]=r.useState(""),[yr,vr]=r.useState(!1),[jr,kr]=r.useState(!1),[wr,Nr]=r.useState(null),[Cr,_r]=r.useState(!1),Sr=r.useRef(null),Pr=r.useRef(null),Er=r.useRef(null),Tr=r.useRef([]),Mr=r.useRef(null),Ar=r.useRef(null),$r=r.useMemo(()=>{const e=Ke[`part${Ee}_q${Me}`];return e?URL.createObjectURL(e):null},[Ke,Ee,Me]);r.useEffect(()=>()=>{$r&&URL.revokeObjectURL($r)},[$r]);const Rr=(()=>{try{const e="undefined"!=typeof window?window.localStorage.getItem("appAudioVolume"):null,r=(e?parseInt(e,10):100)/100;return Number.isFinite(r)?Math.min(1,Math.max(0,r)):1}catch{return 1}})(),Lr=r.useRef(Rr);r.useEffect(()=>(ve?(Ir(),xr([{id:"1",type:"bot",content:"Hello! I'm Catie, your expert IELTS Speaking tutor. I'm here to guide you through strategic speaking techniques, structure, and vocabulary enhancement. What specific aspect of your speaking would you like to work on?",timestamp:new Date}])):qr(),()=>{Er.current&&clearInterval(Er.current)}),[ve]),r.useEffect(()=>(Ve>0?Er.current=setTimeout(()=>Ge(Ve-1),1e3):0===Ve&&Le&&zr(),()=>{Er.current&&clearTimeout(Er.current)}),[Ve,Le]),r.useEffect(()=>{const e=e=>{var r;const t=null==(r=null==e?void 0:e.detail)?void 0:r.volume;"number"==typeof t&&(Lr.current=t,Pr.current&&(Pr.current.volume=t))};return window.addEventListener("app:volume-change",e),()=>window.removeEventListener("app:volume-change",e)},[]),r.useEffect(()=>{gr.length>0&&setTimeout(()=>{const e=document.querySelector("[data-conversation-content]");e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},100)},[gr]),r.useEffect(()=>{dr(!1),_r(!1)},[Me,Ee]),r.useEffect(()=>{var e,r,t,a,s;if(Ce&&!$e){let o=!0;if(1===Ee){const r=(null==(e=Ce.part1_prompts)?void 0:e.length)||0;(Me>=r||Me<0)&&(console.warn("‚ö†Ô∏è Invalid Part 1 state detected, resetting..."),o=!1)}else if(2===Ee){if(!Ce.part2_prompt)return console.warn("‚ö†Ô∏è Part 2 accessed but no Part 2 prompt available, going to Part 3 or completion..."),(null==(r=Ce.part3_prompts)?void 0:r.length)>0?(Te(3),void Ae(0)):void tr(!0)}else if(3===Ee){const e=(null==(t=Ce.part3_prompts)?void 0:t.length)||0;(Me>=e||Me<0)&&(console.warn("‚ö†Ô∏è Invalid Part 3 state detected, resetting..."),o=!1)}o||((null==(a=Ce.part1_prompts)?void 0:a.length)>0?(Te(1),Ae(0)):Ce.part2_prompt?(Te(2),Ae(0)):(null==(s=Ce.part3_prompts)?void 0:s.length)>0?(Te(3),Ae(0)):(console.error("‚ùå No valid test parts available"),je("/ielts-portal")))}},[Ce,Ee,Me,$e,je]),r.useEffect(()=>{if(Mr.current){const e=Mr.current;e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("transition","none","important");const r=r=>{e.style.setProperty("transform","scale(1)","important"),e.style.setProperty("box-shadow","0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1)","important"),e.style.setProperty("transition","none","important")};return e.addEventListener("mouseenter",r),e.addEventListener("mouseleave",r),()=>{e.removeEventListener("mouseenter",r),e.removeEventListener("mouseleave",r)}}},[Ce,Ee,Me]);const Ir=async()=>{if(ve){Re(!0);try{console.log(`üîç Loading speaking test data for test ID: ${ve}`);const e=ve.includes("-")&&36===ve.length,[r,t]=await Promise.all([e?i.from("tests").select("id, test_name").eq("id",ve).single():i.from("tests").select("id, test_name").eq("test_name",ve).eq("test_type","IELTS").eq("module","Speaking").maybeSingle(),i.from("speaking_prompts").select("*").eq("test_id",ve).order("part_number",{ascending:!0})]);if(r.error)throw r.error;const a=r.data;if(!a)return we({title:"Test Not Found",description:"This speaking test doesn't exist. Please check the test ID.",variant:"destructive"}),void je(-1);console.log("‚úÖ Test loaded:",a.test_name);let s=t.data||[];if(0===s.length&&a.id!==ve){const{data:e}=await i.from("speaking_prompts").select("*").eq("test_id",a.id).order("part_number",{ascending:!0});s=e||[]}console.log(`üìù Loaded ${s.length} total speaking prompts`);const o=[];let n=null;const l=[];s.forEach(e=>{1===e.part_number?o.push(e):2===e.part_number?n=e:3===e.part_number&&l.push(e)}),_e({id:a.id,test_name:a.test_name,part1_prompts:o,part2_prompt:n,part3_prompts:l}),console.log(`‚úÖ Test ready: Part 1 (${o.length}), Part 2 (${n?1:0}), Part 3 (${l.length})`)}catch(e){console.error("‚ùå Error:",e),ve&&_e({id:ve,test_name:"Speaking Test",part1_prompts:[],part2_prompt:null,part3_prompts:[]})}finally{Re(!1)}}},qr=async()=>{Re(!0);try{console.log("üìã Loading available speaking tests...");const{data:e,error:r}=await i.from("tests").select("id, test_name, module, skill_category, created_at, speaking_prompts!inner(id)").eq("test_type","IELTS").order("created_at",{ascending:!1}).limit(50);if(r)throw console.error("‚ùå Error loading tests:",r),r;const t=(e||[]).filter(e=>{const r=(e.test_name||"").trim();return r&&r.length>=2&&!r.toLowerCase().includes("quick test")&&!["test ?","another test?",""].includes(r.toLowerCase())});console.log(`‚úÖ Found ${t.length} valid speaking tests`),Pe(t)}catch(e){console.error("‚ùå Error loading tests:",e),we({title:"Error",description:"Failed to load available speaking tests",variant:"destructive"}),Pe([])}finally{Re(!1)}},Fr=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),r=e.createOscillator(),t=e.createOscillator(),a=e.createGain();r.type="sine",r.frequency.value=523,t.type="sine",t.frequency.value=659,r.connect(a),t.connect(a),a.connect(e.destination),a.gain.setValueAtTime(1e-4,e.currentTime),a.gain.exponentialRampToValueAtTime(.05,e.currentTime+.01),r.start(),t.start(),setTimeout(()=>{a.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{r.stop(),t.stop(),e.close()},200)},120)}catch{}},zr=()=>{if(2===Ee&&Ar.current){const e=Math.floor((Date.now()-Ar.current)/1e3);e<60&&we({title:"Short Recording",description:`Your recording is ${e} seconds. In the real IELTS exam, you should speak for 1-2 minutes for Part 2.`,variant:"default",duration:4e3})}Fr(),Sr.current&&Le&&(Sr.current.stop(),Ge(0),Ar.current=null)},Br=()=>{var e,r,t,a;try{if(console.log(`üîÑ Navigation attempt: Part ${Ee}, Question ${Me}`,{testDataExists:!!Ce,part1Prompts:(null==(e=null==Ce?void 0:Ce.part1_prompts)?void 0:e.length)||0,part2Prompt:!!(null==Ce?void 0:Ce.part2_prompt),part3Prompts:(null==(r=null==Ce?void 0:Ce.part3_prompts)?void 0:r.length)||0}),!Ce)return console.error("‚ùå Navigation failed: No test data available"),void we({title:"Navigation Error",description:"Test data not available. Please refresh the page.",variant:"destructive"});if(1===Ee){const e=(null==(t=Ce.part1_prompts)?void 0:t.length)||0;if(Me<e-1){const e=Me+1;Ae(e),dr(!1),Nr(null),_r(!1),console.log(`‚û°Ô∏è Moving to Part 1, Question ${e+1}`)}else{const e=!!Ce.part2_prompt,r=!!(Ce.part3_prompts&&Ce.part3_prompts.length>0);e||r?e?(Te(2),Ae(0),Ye(60),dr(!1),Nr(null),_r(!1),console.log("‚û°Ô∏è Moving to Part 2 - Long Turn"),Ur()):r&&(Te(3),Ae(0),dr(!1),Nr(null),_r(!1),console.log("‚û°Ô∏è Moving to Part 3 - Discussion (no Part 2 for this test)")):(console.log("üèÅ Part 1-only test completed - prompting for feedback language"),tr(!0))}}else if(2===Ee){Ce.part3_prompts&&Ce.part3_prompts.length>0?(Te(3),Ae(0),dr(!1),Nr(null),_r(!1),console.log("‚û°Ô∏è Moving to Part 3 - Discussion")):(console.log("üèÅ Part 2 completed - no Part 3 available, prompting for feedback language"),tr(!0))}else if(3===Ee){const e=(null==(a=Ce.part3_prompts)?void 0:a.length)||0;if(Me<e-1){const e=Me+1;Ae(e),dr(!1),Nr(null),_r(!1),console.log(`‚û°Ô∏è Moving to Part 3, Question ${e+1}`)}else console.log("üèÅ Last question completed - prompting for feedback language"),tr(!0)}}catch(s){console.error("‚ùå Navigation error:",s),we({title:"Navigation Error",description:"Failed to navigate. Please try again.",variant:"destructive"})}},Ur=()=>{const e=setInterval(()=>{Ye(r=>r<=1?(clearInterval(e),we({title:"Preparation Time Complete",description:"You may now start recording your response.",duration:5e3}),0):r-1)},1e3)},Dr=e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;if($e)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"dark"===Ne.theme.name?Ne.theme.colors.background:"transparent"},children:e.jsx(c,{size:"lg",message:"Loading speaking tests..."})});if(!ve)return e.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===Ne.theme.name?Ne.theme.colors.background:"transparent"},children:[e.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===Ne.theme.name||"minimalist"===Ne.theme.name||"dark"===Ne.theme.name?"none":"url('/1000031207.png')",backgroundColor:Ne.backgroundImageColor}}),e.jsx("div",{className:"relative z-10",children:e.jsx(d,{title:"Available Speaking Tests",children:e.jsx("div",{className:"min-h-screen py-12",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("div",{className:"mb-8 text-center",children:e.jsx("h1",{className:"text-4xl font-bold mb-2",style:{color:Ne.textPrimary},children:"IELTS speaking tests"})}),Se.length>0?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:Se.map(r=>e.jsx(m,{className:"cursor-pointer h-[140px] hover:scale-105 transition-all duration-300 hover:shadow-lg flex items-center justify-center",onClick:()=>je(`/ielts-speaking-test/${r.id}`),style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.8)":"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,borderColor:Ne.border,...Ne.cardStyle},children:e.jsx(u,{className:"p-3 md:p-4 text-center flex items-center justify-center h-full",children:e.jsx("h3",{className:"font-semibold text-sm",style:{color:Ne.textPrimary},children:r.test_name})})},r.id))}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-lg mb-4",style:{color:Ne.textSecondary},children:"No speaking tests available yet"}),e.jsx(p,{onClick:()=>je("/ielts-portal"),variant:"outline",style:{borderColor:Ne.border,color:Ne.textPrimary,backgroundColor:"glassmorphism"===Ne.theme.name||"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground},onMouseEnter:e=>e.currentTarget.style.backgroundColor=Ne.hoverBg,onMouseLeave:e=>e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name||"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,children:"Back to Portal"})]})]})})})})})]});if(!Ce)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg text-muted-foreground",children:"Test not found"}),e.jsx(p,{onClick:()=>je("/ielts-portal"),className:"mt-4",children:"Back to Portal"})]})});if(0===Ce.part1_prompts.length&&!Ce.part2_prompt&&0===Ce.part3_prompts.length)return e.jsx(d,{title:`IELTS Speaking - ${Ce.test_name}`,showBackButton:!0,children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(h,{variant:"outline",className:"mb-4 px-4 py-1 text-primary border-primary/20",children:"IELTS SPEAKING TEST"}),e.jsx("h1",{className:"text-heading-2 mb-2",children:Ce.test_name})]}),e.jsx(g,{className:"card-modern",children:e.jsxs(u,{className:"p-8 text-center",children:[e.jsx(V,{className:"w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-500"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Speaking Content Available"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"This test doesn't have speaking content created yet. Please contact your administrator or try another test."}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx(p,{onClick:()=>je("/ielts-portal"),variant:"outline",children:"Back to Portal"}),e.jsx(p,{onClick:()=>je("/speaking"),children:"Try General Speaking Practice"})]})]})})]})});const Wr=()=>1===Ee?Ce.part1_prompts[Me]:2===Ee?Ce.part2_prompt:3===Ee?Ce.part3_prompts[Me]:null,Or=()=>{const e=Wr();return e?2===Ee?e.prompt_text||"":e.transcription||e.title||"":""},Vr=async e=>{const r=e||fr.trim();if(!r||yr)return;const t={id:Date.now().toString(),type:"user",content:r,timestamp:new Date};xr(e=>[...e,t]),e||br(""),vr(!0);try{const e=Or(),t=`CONTEXT: The student is practicing IELTS Speaking Part ${Ee}.\n\nQuestion: "${e}"\n\nPlease provide concise, practical speaking guidance (ideas, vocabulary, structure). Do NOT write a full answer.`,a=gr.filter(e=>"user"===e.type||"bot"===e.type).map(e=>({role:"user"===e.type?"user":"assistant",content:e.content}));a.push({role:"user",content:r});const{data:s,error:o}=await i.functions.invoke("openai-chat",{body:{skipCache:!0,messages:[{role:"system",content:t},...a],context:"catbot"}});if(o)throw o;const n={id:(Date.now()+1).toString(),type:"bot",content:s.response,timestamp:new Date};xr(e=>[...e,n])}catch(a){console.error("Error sending chat message:",a),we({title:"Error",description:"Failed to get response from Catie",variant:"destructive"})}finally{vr(!1)}},Gr=e=>{Vr(e)},Hr=Wr(),Yr=Or(),Kr=1===Ee?"Part 1":2===Ee?"Part 2":3===Ee?"Part 3":"Unknown Part";return e.jsxs("div",{className:"min-h-screen relative",style:{backgroundColor:"dark"===Ne.theme.name?Ne.theme.colors.background:"transparent"},children:[e.jsx("div",{className:"absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed",style:{backgroundImage:"note"===Ne.theme.name||"minimalist"===Ne.theme.name||"dark"===Ne.theme.name?"none":"url('/1000031207.png')",backgroundColor:Ne.backgroundImageColor}}),e.jsx("div",{className:"relative z-10 min-h-screen flex flex-col",style:{backgroundColor:"dark"===Ne.theme.name?Ne.theme.colors.background:"transparent"},children:e.jsx(d,{title:`IELTS Speaking - ${Ce.test_name}`,showBackButton:!0,children:e.jsx("div",{className:"flex-1 flex justify-center min-h-[calc(100vh-120px)] py-8 sm:items-center sm:py-8",children:e.jsxs("div",{className:"w-full max-w-4xl mx-auto space-y-4 px-4 flex flex-col",children:[e.jsxs("div",{className:"text-center py-2 sm:py-2 sm:mb-0 mb-0 flex items-center justify-center gap-2",children:[e.jsxs("span",{className:"text-lg font-semibold",style:{color:Ne.textPrimary},children:["Part ",Ee]}),(1===Ee||2===Ee)&&!rr&&e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx("button",{onClick:()=>{if(!Ce)return;Xe(e=>new Set([...e,Ee])),Le&&Sr.current&&(Sr.current.stop(),Ie(!1),Ge(0));const e=`part${Ee}_`;if(Qe(r=>{const t={};return Object.entries(r).forEach(([r,a])=>{r.startsWith(e)||(t[r]=a)}),t}),1===Ee){const e=!!Ce.part2_prompt,r=Ce.part3_prompts&&Ce.part3_prompts.length>0;e?(Te(2),Ae(0),Ye(60),dr(!1),Nr(null),_r(!1),console.log("‚è≠Ô∏è Skipped Part 1 - Moving to Part 2"),Ur()):r?(Te(3),Ae(0),dr(!1),Nr(null),_r(!1),console.log("‚è≠Ô∏è Skipped Part 1 - Moving to Part 3")):(console.log("‚è≠Ô∏è Skipped Part 1 - No other parts available"),we({title:"Cannot Skip",description:"This is the only part in the test. Please complete it or exit.",variant:"destructive"}),Xe(e=>{const r=new Set(e);return r.delete(1),r}))}else if(2===Ee){if(Ce.part3_prompts&&Ce.part3_prompts.length>0)Te(3),Ae(0),dr(!1),Nr(null),_r(!1),console.log("‚è≠Ô∏è Skipped Part 2 - Moving to Part 3");else{Object.keys(Ke).some(e=>e.startsWith("part1_"))?(console.log("‚è≠Ô∏è Skipped Part 2 - Completing test with Part 1 recordings"),tr(!0)):(console.log("‚è≠Ô∏è Skipped Part 2 - No recordings available"),we({title:"Cannot Complete Test",description:"You need at least one recording to submit the test.",variant:"destructive"}),Xe(e=>{const r=new Set(e);return r.delete(2),r}))}}we({title:`Part ${Ee} Skipped`,description:"This part won't be included in your evaluation.",duration:3e3})},className:"p-1 rounded-full transition-colors hover:bg-amber-100",style:{color:Ne.textSecondary},children:e.jsx(G,{className:"w-4 h-4"})})}),e.jsx(y,{children:e.jsxs("p",{children:["Skip Part ",Ee]})})]})})]}),e.jsxs(g,{ref:Mr,className:"backdrop-blur-sm shadow-lg rounded-2xl flex flex-col relative",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,borderColor:Ne.border,backdropFilter:"glassmorphism"===Ne.theme.name?"blur(12px)":"dark"===Ne.theme.name?"blur(8px)":"none",boxShadow:"dark"===Ne.theme.name?"0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1)":"note"===Ne.theme.name?null==(s=Ne.theme.styles.cardStyle)?void 0:s.boxShadow:"0 8px 32px rgba(15, 23, 42, 0.16), 0 0 0 1px rgba(148, 163, 253, 0.06)",...Ne.cardStyle},children:[e.jsx(v,{children:e.jsxs(j,{className:"flex items-center justify-between",children:[e.jsx("span",{}),e.jsxs("div",{className:"flex items-center gap-3",children:[(1===Ee||3===Ee)&&e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx("div",{onClick:()=>dr(!cr),className:"relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background",style:{backgroundColor:cr?Ne.buttonPrimary:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.2)":"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#e5e7eb":Ne.border},"data-state":cr?"checked":"unchecked",children:e.jsx("div",{className:"pointer-events-none flex h-5 w-5 rounded-full shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0 items-center justify-center",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.95)":"dark"===Ne.theme.name?"rgba(255,255,255,0.9)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground},"data-state":cr?"checked":"unchecked",children:cr?e.jsx(H,{className:"w-3 h-3",style:{color:"white"}}):e.jsx(Y,{className:"w-3 h-3",style:{color:Ne.textSecondary}})})})}),e.jsx(y,{children:e.jsx("p",{children:cr?"Hide question":"Show question"})})]})}),Ve>0&&e.jsxs(h,{variant:"outline",className:"flex items-center gap-2",style:{borderColor:Ne.border,backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,color:Ne.textPrimary},children:[e.jsx(K,{className:"w-4 h-4",style:{color:Ne.textPrimary}}),Dr(Ve)]})]})]})}),e.jsxs(u,{className:"space-y-4 flex flex-col relative",children:[2===Ee&&He>0&&e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(K,{className:"w-5 h-5",style:{color:Ne.buttonPrimary}}),e.jsx("p",{className:"text-xl font-bold",style:{color:Ne.buttonPrimary},children:Dr(He)})]})}),1===Ee&&Ce.part1_prompts.length>0&&e.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:e.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:cr&&e.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:Ne.textPrimary},children:Or()})})}),3===Ee&&Ce.part3_prompts.length>0&&e.jsx("div",{className:"space-y-6 relative flex flex-col min-h-[200px]",children:e.jsx("div",{className:"min-h-[200px] flex items-center justify-center flex-1",children:cr&&e.jsx("div",{className:"text-lg font-medium text-center select-none",style:{color:Ne.textPrimary},children:Or()})})}),2===Ee&&Hr&&e.jsxs("div",{className:"p-6 rounded-lg",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid"},children:[e.jsx("h3",{className:"font-semibold mb-3",style:{color:Ne.textPrimary},children:"Cue Card"}),e.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",style:{color:Ne.textSecondary},children:Hr.prompt_text})]}),2===Ee&&e.jsxs(e.Fragment,{children:[He>0&&e.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#fef3c7":"#FEF9E7",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid"},children:[e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{Ye(e=>e+60)},className:"absolute top-2 right-2 h-8 w-8",style:{color:Ne.buttonPrimary},children:e.jsx(Q,{className:"w-4 h-4"})})}),e.jsx(y,{children:e.jsx("p",{children:"Add 1 minute for notes"})})]})}),e.jsx("textarea",{placeholder:"Write your preparation notes here...",value:Ze,onChange:e=>er(e.target.value),className:"w-full h-32 p-3 bg-transparent resize-none focus:outline-none",style:{color:Ne.textPrimary}}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      textarea[placeholder="Write your preparation notes here..."]::placeholder {\n                        color: ${Ne.textSecondary};\n                      }\n                    `}})]}),(0===He||Le)&&Ze&&e.jsxs("div",{className:"relative rounded-lg p-4",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#fef3c7":"#FEF9E7",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid"},children:[!Le&&e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{Ye(60),Ur()},className:"absolute top-2 right-2 h-8 w-8 text-primary",children:e.jsx(Q,{className:"w-4 h-4"})})}),e.jsx(y,{children:e.jsx("p",{children:"Add 1 minute for notes"})})]})}),e.jsx("div",{className:"p-3 text-sm whitespace-pre-wrap",style:{color:Ne.textPrimary},children:Ze})]})]}),e.jsx("div",{className:"text-center min-h-[80px] flex items-center justify-center relative",children:Le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 w-[130px] sm:w-[180px]",children:e.jsx(he,{active:!0,height:55,barWidth:6,barGap:2,barRadius:3,mode:"static",fadeEdges:!1,barColor:"#2563eb",sensitivity:1.2,fftSize:256,historySize:60,updateRate:30})}),e.jsx(p,{onClick:zr,variant:"outline",size:"icon",className:"rounded-xl h-8 w-8 absolute bottom-0 left-1/2 transform -translate-x-1/2",style:{borderColor:Ne.border,color:Ne.buttonPrimary,backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},children:e.jsx(J,{className:"w-4 h-4",style:{color:Ne.buttonPrimary||"#2563eb"}})})]}):e.jsx(x,{children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{onClick:async()=>{try{Fr(),await new Promise(e=>setTimeout(e,100));const e=await navigator.mediaDevices.getUserMedia({audio:!0});Sr.current=new MediaRecorder(e),Tr.current=[],Sr.current.ondataavailable=e=>{e.data.size>0&&Tr.current.push(e.data)},Sr.current.onstop=()=>{const r=new Blob(Tr.current,{type:"audio/webm"}),t=`part${Ee}_q${Me}`;console.log(`üíæ Saving recording for ${t}, blob size: ${r.size}`),Qe(e=>{const a={...e,[t]:r};return console.log("üì± Recordings updated:",Object.keys(a)),a}),Ie(!1),e.getTracks().forEach(e=>e.stop())},Sr.current.start(),Ie(!0),Ar.current=Date.now(),(1===Ee||3===Ee||2===Ee)&&Ge(120)}catch(e){console.error("Error starting recording:",e),we({title:"Recording Error",description:"Failed to start recording. Please check microphone permissions.",variant:"destructive"})}},variant:"outline",className:"rounded-xl shadow-sm h-12 w-12",size:"icon",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.8)":"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,borderColor:Ne.border,color:Ne.textPrimary},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg,e.currentTarget.style.color=Ne.buttonPrimary},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.8)":"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,e.currentTarget.style.color=Ne.textPrimary},children:e.jsx(V,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:"Start recording your answer"})})]}),(null==Hr?void 0:Hr.audio_url)&&e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{onClick:()=>{const e=Wr();(null==e?void 0:e.audio_url)&&(console.log(`üîÅ Repeating audio for Part ${Ee}`),(async e=>{var r;if(e){mr||(ur(!0),hr(!1));try{Fe(!0),Pr.current&&(Pr.current.pause(),Pr.current.currentTime=0,Pr.current=null);const r=new Audio(e);r.preload="auto",r.volume=Lr.current,r.onended=()=>{Fe(!1),console.log("‚úÖ Audio playback completed"),Pr.current=null},r.onerror=e=>{Fe(!1),console.error("Audio playback error:",e),Pr.current=null,we({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable.",variant:"destructive"})},r.onloadstart=()=>{console.log("Audio loading started")},r.oncanplay=()=>{console.log("Audio can play")},r.oncanplaythrough=()=>{console.log("Audio can play through")},Pr.current=r,console.log(`‚ñ∂Ô∏è Playing audio: ${e}`),r.load(),await new Promise(e=>setTimeout(e,100));const t=r.play();void 0!==t&&(await t,console.log("Audio started playing successfully"))}catch(t){console.error("Error playing audio:",t),Fe(!1),"NotAllowedError"===t.name||(null==(r=t.message)?void 0:r.includes("user didn't interact"))?(mr||hr(!0),console.log("Autoplay blocked - user needs to interact first")):we({title:"Audio Error",description:"Failed to play audio prompt. The audio may be inaudible or unavailable. Please try again.",variant:"destructive"}),Pr.current&&(Pr.current=null)}}})(e.audio_url))},disabled:qe,variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:Ne.border,color:Ne.buttonPrimary,backgroundColor:"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:qe?e.jsx(X,{className:"w-5 h-5"}):e.jsx(Z,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:qe?"Pause question audio":"Play question audio"})})]}),Ke[`part${Ee}_q${Me}`]&&e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{onClick:()=>{_r(!Cr),Cr&&ze&&(()=>{if(We)try{We.pause(),We.currentTime=0,console.log("üõë Stopped recording playback")}catch(e){console.error("Error stopping recording playback:",e)}Be(!1),De(null),Oe(null)})()},variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl",style:{borderColor:Ne.border,color:Ne.buttonPrimary,backgroundColor:Cr?"dark"===Ne.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=Cr?"dark"===Ne.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},children:e.jsx(ee,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:Cr?"Hide audio player":"Listen to your recorded answer"})})]}),(console.log("üîç DEBUG: Checking evaluate button condition",{currentPart:Ee,currentQuestion:Me,key:`part${Ee}_q${Me}`,hasRecording:!!Ke[`part${Ee}_q${Me}`],allRecordingKeys:Object.keys(Ke),recordingValue:Ke[`part${Ee}_q${Me}`]}),null),Ke[`part${Ee}_q${Me}`]&&e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{onClick:async()=>{var e,r;const t=`part${Ee}_q${Me}`,a=Ke[t];if(console.log("üéØ EVALUATE: Current part:",Ee),console.log("üéØ EVALUATE: Current question:",Me),console.log("üéØ EVALUATE: Recording key:",t),console.log("üéØ EVALUATE: Recording exists:",!!a),console.log("üéØ EVALUATE: Recording size:",null==a?void 0:a.size),console.log("üéØ EVALUATE: All recording keys:",Object.keys(Ke)),!a)return console.error("‚ùå No recording found for",t),void we({title:"No Recording Found",description:"Please record your answer first before evaluating.",variant:"destructive"});const s=a.size/1048576;if(console.log(`üì¶ Audio file size: ${s.toFixed(2)} MB`),s>15)we({title:"Recording Too Large",description:"Your recording is too large to process. Try keeping your response shorter.",variant:"destructive"});else{kr(!0),Nr(null);try{const e=await new Promise((e,r)=>{const t=new FileReader;t.onloadend=()=>{const r=t.result;e(r.split(",")[1])},t.onerror=()=>r(new Error("Failed to read audio file")),t.readAsDataURL(a)});console.log(`üì§ Base64 audio length: ${(e.length/1024).toFixed(0)} KB`);const r=Or();console.log("üì§ Sending to Edge Function:",{audioLength:e.length,prompt:r,recordingKey:t});const s=2===Ee?9e4:6e4,o=new AbortController,n=setTimeout(()=>o.abort(),s),{data:l,error:c}=await i.functions.invoke("ielts-speaking-evaluator",{body:{audio:e,prompt:r}});if(clearTimeout(n),c){const e=c.message||"";if(e.includes("FunctionsFetchError")||e.includes("Failed to send a request"))throw new Error("AI evaluation service is currently unavailable. Please try again in a moment.");throw c}if(null==l?void 0:l.error)throw console.error("‚ùå API returned error:",l.error),new Error(l.error);if(!l||!l.metrics||"object"!=typeof l.metrics)throw console.error("‚ùå Invalid response structure:",l),new Error("Invalid response from evaluation service. Please try again.");const d={...l,metrics:{pronunciation:Number(l.metrics.pronunciation)||0,vocabulary:Number(l.metrics.vocabulary)||0,grammar:Number(l.metrics.grammar)||0,intonation:Number(l.metrics.intonation)||0,fluency:Number(l.metrics.fluency)||0}};console.log("‚úÖ Evaluation received:",d),console.log("üìä Validated metrics:",d.metrics),Nr(d)}catch(o){console.error("Evaluation error:",o);let t="Could not evaluate the recording. Please try again.";(null==(e=null==o?void 0:o.message)?void 0:e.includes("unavailable"))||(null==(r=null==o?void 0:o.message)?void 0:r.includes("FunctionsFetchError"))?t="AI evaluation service is temporarily unavailable. Please try again in a few moments.":(null==o?void 0:o.message)&&(t=o.message),we({title:"Evaluation Failed",description:t,variant:"destructive",duration:6e3})}finally{kr(!1)}}},disabled:jr,variant:"outline",size:"icon",className:"h-12 w-12 rounded-xl relative",style:{borderColor:Ne.border,color:Ne.buttonPrimary,backgroundColor:jr?"dark"===Ne.theme.name?"rgba(59, 130, 246, 0.2)":"#eff6ff":"transparent"},onMouseEnter:e=>{jr||(e.currentTarget.style.backgroundColor=Ne.hoverBg)},onMouseLeave:e=>{jr||(e.currentTarget.style.backgroundColor="transparent")},children:jr?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-current border-t-transparent"}):e.jsx(re,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:jr?"Evaluating your answer...":"Evaluate with AI"})})]})]})})}),Cr&&Ke[`part${Ee}_q${Me}`]&&e.jsx("div",{className:"mt-4 p-4 rounded-xl border animate-in fade-in slide-in-from-top-4 duration-300",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"#ffffff"},children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium flex items-center gap-2 text-sm uppercase tracking-wider opacity-80",style:{color:Ne.textPrimary},children:[e.jsx(ee,{className:"w-4 h-4"}),"Your Recorded Answer"]}),$r&&e.jsx("div",{className:"p-2 rounded-xl border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(0,0,0,0.2)":"rgba(255,255,255,0.5)"},children:e.jsx(P,{src:$r,accentColor:Ne.buttonPrimary,style:{backgroundColor:"transparent"}})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>_r(!1),className:"h-8 px-3 text-xs",style:{color:Ne.textSecondary},children:"Hide Player"})})]})}),jr&&e.jsx("div",{className:"mt-4 flex items-center justify-center animate-in fade-in slide-in-from-top-2 duration-300",children:e.jsxs("div",{className:"flex items-center gap-3 px-5 py-3 rounded-full shadow-lg border",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(30, 41, 59, 0.95)":"rgba(255, 255, 255, 0.98)",borderColor:Ne.border,boxShadow:`0 4px 20px -4px ${Ne.buttonPrimary}30`},children:[e.jsx("div",{className:"w-8 h-8",children:e.jsx(c,{size:"sm",message:""})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"text-sm font-medium",style:{color:Ne.textPrimary},children:"Catie is evaluating..."}),e.jsx("p",{className:"text-xs",style:{color:Ne.textSecondary},children:"You can continue practicing"})]})]})}),wr&&e.jsxs("div",{className:"mt-8 p-6 rounded-2xl border animate-in fade-in slide-in-from-top-4 duration-500 max-w-3xl mx-auto text-left shadow-lg relative overflow-hidden",style:{borderColor:Ne.border,backgroundColor:Ne.theme.colors.cardBackground||"#ffffff",color:Ne.textPrimary},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:"/1000031289.png",alt:"Catie AI",className:"w-14 h-14 rounded-full shadow-md object-cover ring-2 ring-offset-2",style:{ringColor:Ne.buttonPrimary}}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center shadow-sm border-2 border-white",style:{backgroundColor:Ne.buttonPrimary},children:e.jsx(re,{className:"w-2.5 h-2.5 text-white"})})]}),e.jsx("div",{children:e.jsx("h3",{className:"font-bold text-lg",style:{color:Ne.textPrimary},children:"Catie's Feedback"})})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>Nr(null),className:"h-8 w-8 p-0 opacity-60 hover:opacity-100",children:e.jsx(te,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"mb-6 space-y-4 relative z-10",children:e.jsxs("div",{className:"rounded-xl p-4 space-y-3 border",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"#ffffff",borderColor:Ne.border},children:[e.jsxs("h4",{className:"font-medium mb-2 flex items-center gap-2 text-xs uppercase tracking-wider opacity-80",style:{color:Ne.textPrimary},children:[e.jsx(ee,{className:"w-3.5 h-3.5"}),"Your Response"]}),$r?e.jsx("div",{className:"p-2 rounded-xl border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(0,0,0,0.2)":"rgba(255,255,255,0.5)"},children:e.jsx(P,{src:$r,accentColor:Ne.buttonPrimary,style:{backgroundColor:"transparent"}})}):e.jsxs("div",{className:"text-xs italic p-3 rounded-lg border flex items-center gap-2",style:{borderColor:Ne.border,color:Ne.textSecondary},children:[e.jsx(ae,{className:"w-4 h-4"}),"Audio recording not available"]}),e.jsx("div",{className:"mt-4",children:e.jsxs("div",{className:"rounded-xl p-4 border shadow-sm relative group",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(0,0,0,0.2)":"#ffffff",borderColor:Ne.border},children:[e.jsx("div",{className:"absolute top-3 right-3 opacity-20 group-hover:opacity-50 transition-opacity",children:e.jsx(se,{className:"w-4 h-4"})}),e.jsxs("p",{className:"text-sm leading-relaxed italic",style:{color:Ne.textPrimary},children:['"',wr.transcription,'"']})]})})]})}),e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6 items-center",children:[e.jsx("div",{className:"flex flex-col items-center justify-center p-4 rounded-2xl border",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.03)":"minimalist"===Ne.theme.name?"#ffffff":"rgba(255,255,255,0.5)",borderColor:Ne.border},children:e.jsx(ue,{score:Math.round(Object.values(wr.metrics||{}).reduce((e,r)=>e+r,0)/(Object.keys(wr.metrics||{}).length||1)),label:"Overall",subLabel:"Speaking Score",size:160,color:Ne.buttonPrimary})}),e.jsx("div",{className:"flex items-center justify-center p-4 rounded-2xl border min-h-[240px]",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.03)":"minimalist"===Ne.theme.name?"#ffffff":"rgba(255,255,255,0.5)",borderColor:Ne.border},children:e.jsx(pe,{metrics:{pronunciation:(null==(E=wr.metrics)?void 0:E.pronunciation)||0,vocabulary:(null==(T=wr.metrics)?void 0:T.vocabulary)||0,grammar:(null==(M=wr.metrics)?void 0:M.grammar)||0,intonation:(null==(A=wr.metrics)?void 0:A.intonation)||0,fluency:(null==($=wr.metrics)?void 0:$.fluency)||0},width:240,height:220})})]})}),e.jsx(S,{className:"my-6",style:{backgroundColor:Ne.border}}),e.jsxs("div",{className:"space-y-2 mb-6",children:[e.jsxs("h3",{className:"font-semibold text-base flex items-center gap-2",style:{color:Ne.textPrimary},children:[e.jsx(oe,{className:"w-4 h-4",style:{color:Ne.buttonPrimary}}),"Feedback"]}),e.jsx("p",{className:"text-sm leading-relaxed",style:{color:Ne.textSecondary},children:wr.feedback})]}),e.jsxs("div",{className:"p-4 rounded-xl space-y-2 mb-6 border-2",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.7)":"minimalist"===Ne.theme.name?"#f0f9ff":"rgba(255,255,255,0.4)",borderColor:`${Ne.buttonPrimary}40`},children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2 text-xs uppercase tracking-wide",style:{color:Ne.buttonPrimary},children:[e.jsx(re,{className:"w-3 h-3"}),"Try saying it like this"]}),e.jsxs("p",{className:"text-base italic font-medium",style:{color:Ne.textPrimary},children:['"',wr.enhancedSentence,'"']})]}),wr.detailedAnalysis&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2",style:{color:Ne.textPrimary},children:[e.jsx(ne,{className:"w-4 h-4",style:{color:Ne.textSecondary}}),"Detailed Analysis"]}),e.jsxs("div",{className:"grid gap-2",children:[wr.detailedAnalysis.pronunciation&&e.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:Ne.textPrimary},children:"Pronunciation"}),e.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:Ne.textSecondary},children:[(null==(R=wr.metrics)?void 0:R.pronunciation)||0,"%"]})]}),e.jsx("p",{className:"text-xs leading-relaxed",style:{color:Ne.textSecondary},children:wr.detailedAnalysis.pronunciation})]}),wr.detailedAnalysis.vocabulary&&e.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:Ne.textPrimary},children:"Vocabulary"}),e.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:Ne.textSecondary},children:[(null==(ge=wr.metrics)?void 0:ge.vocabulary)||0,"%"]})]}),e.jsx("p",{className:"text-xs leading-relaxed",style:{color:Ne.textSecondary},children:wr.detailedAnalysis.vocabulary})]}),wr.detailedAnalysis.grammar&&e.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:Ne.textPrimary},children:"Grammar"}),e.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:Ne.textSecondary},children:[(null==(xe=wr.metrics)?void 0:xe.grammar)||0,"%"]})]}),e.jsx("p",{className:"text-xs leading-relaxed",style:{color:Ne.textSecondary},children:wr.detailedAnalysis.grammar})]}),wr.detailedAnalysis.intonation&&e.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:Ne.textPrimary},children:"Intonation"}),e.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:Ne.textSecondary},children:[(null==(fe=wr.metrics)?void 0:fe.intonation)||0,"%"]})]}),e.jsx("p",{className:"text-xs leading-relaxed",style:{color:Ne.textSecondary},children:wr.detailedAnalysis.intonation})]}),wr.detailedAnalysis.fluency&&e.jsxs("div",{className:"p-3 rounded-lg border",style:{borderColor:Ne.border,backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.02)":"rgba(0,0,0,0.01)"},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide",style:{color:Ne.textPrimary},children:"Fluency"}),e.jsxs("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded",style:{backgroundColor:"dark"===Ne.theme.name?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)",color:Ne.textSecondary},children:[(null==(be=wr.metrics)?void 0:be.fluency)||0,"%"]})]}),e.jsx("p",{className:"text-xs leading-relaxed",style:{color:Ne.textSecondary},children:wr.detailedAnalysis.fluency})]})]})]})]}),rr&&e.jsx("div",{className:"flex justify-center mt-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(k,{value:ar,onValueChange:sr,children:[e.jsx(w,{className:"w-[90px] h-8 text-sm border-0 bg-transparent shadow-none p-0 focus:ring-0",style:{color:Ne.textPrimary,"--tw-ring-color":Ne.buttonPrimary},children:e.jsx(N,{placeholder:"Language"})}),e.jsx(C,{children:O.map(r=>e.jsx(_,{value:r.value,children:r.label},r.value))})]}),e.jsx(p,{type:"button",onClick:()=>{try{localStorage.setItem("ielts_speaking_feedback_language",ar||"en")}catch(e){console.warn("Unable to persist feedback language preference",e)}(async()=>{var e,r,t,a,s,o;try{const l=Object.entries(Ke);if(0===l.length)return void we({title:"No recordings found",description:"Please record answers before submitting.",variant:"destructive"});console.log("üìù Preparing speaking uploads:",{count:l.length,keys:l.map(([e])=>e)});const c=l.map(async([e,r],t)=>{var a,s,o,n,i,c,d,m,u,p,h,g,x,f,b,y;const v=(null==Ce?void 0:Ce.id)||"unknown",j=Date.now(),k=`speaking_${v}_${e}_${j}.webm`,w=new File([r],k,{type:"audio/webm"});try{console.log(`üì§ Uploading speaking recording [${t+1}/${l.length}]:`,{fileName:k,key:e,size:r.size});const u=await L.uploadSpeaking(w,v,e);if(!u.success)throw console.error(`‚ùå R2 upload reported failure for ${k}:`,u.error),new Error(u.error||"Upload failed");u.url||console.warn(`‚ö†Ô∏è R2 upload returned success but no URL for ${k}. Falling back to deterministic URL.`);const p=u.url||`https://placeholder-r2/${v}/speaking/${encodeURIComponent(e)}/${j}.webm`;console.log(`‚úÖ Speaking recording uploaded successfully: ${p}`);let h="";const g=e.match(/^part(\d+)_q(\d+)$/);if(g){const e=parseInt(g[1],10),r=parseInt(g[2],10);1===e&&(null==(a=null==Ce?void 0:Ce.part1_prompts)?void 0:a[r])?h=(null==(s=Ce.part1_prompts[r])?void 0:s.prompt_text)||(null==(o=Ce.part1_prompts[r])?void 0:o.transcription)||(null==(n=Ce.part1_prompts[r])?void 0:n.title)||"":2===e&&(null==Ce?void 0:Ce.part2_prompt)?h=Ce.part2_prompt.prompt_text||Ce.part2_prompt.transcription||Ce.part2_prompt.title||"":3===e&&(null==(i=null==Ce?void 0:Ce.part3_prompts)?void 0:i[r])&&(h=(null==(c=Ce.part3_prompts[r])?void 0:c.prompt_text)||(null==(d=Ce.part3_prompts[r])?void 0:d.transcription)||(null==(m=Ce.part3_prompts[r])?void 0:m.title)||"")}return{part:e,audio_url:p,question_text:h,upload_error:!1}}catch(N){const r=(null==N?void 0:N.message)||("string"==typeof N?N:"Unknown upload error");console.error(`‚ùå Hard failure uploading ${k}:`,r),we({title:"Upload Warning",description:`We could not upload your recording for ${e}. We will still save your test and run analysis using available audio.`,variant:"destructive"});const t=`https://mock-r2-fallback.local/speaking/${encodeURIComponent(v)}/${encodeURIComponent(e)}/${j}.webm`;let a="";const s=e.match(/^part(\d+)_q(\d+)$/);if(s){const e=parseInt(s[1],10),r=parseInt(s[2],10);1===e&&(null==(u=null==Ce?void 0:Ce.part1_prompts)?void 0:u[r])?a=(null==(p=Ce.part1_prompts[r])?void 0:p.prompt_text)||(null==(h=Ce.part1_prompts[r])?void 0:h.transcription)||(null==(g=Ce.part1_prompts[r])?void 0:g.title)||"":2===e&&(null==Ce?void 0:Ce.part2_prompt)?a=Ce.part2_prompt.prompt_text||Ce.part2_prompt.transcription||Ce.part2_prompt.title||"":3===e&&(null==(x=null==Ce?void 0:Ce.part3_prompts)?void 0:x[r])&&(a=(null==(f=Ce.part3_prompts[r])?void 0:f.prompt_text)||(null==(b=Ce.part3_prompts[r])?void 0:b.transcription)||(null==(y=Ce.part3_prompts[r])?void 0:y.title)||"")}return{part:e,audio_url:t,question_text:a,upload_error:!0,error_message:r}}}),d=await Promise.all(c);if(!d||0===d.length)return console.error("‚ùå No speaking upload results returned"),void we({title:"Upload error",description:"We could not process your recordings. Please try again.",variant:"destructive"});const m=d.filter(e=>!e.upload_error).length,u=d.filter(e=>e.upload_error).length;console.log("üìä Speaking upload summary:",{total:d.length,successfulCount:m,failedCount:u});try{const{data:{user:n}}=await i.auth.getUser();if(!n)throw new Error("User not authenticated while submitting speaking test");const c=d.map(e=>e.audio_url),{data:p,error:h}=await i.from("test_results").insert({user_id:n.id,test_type:"speaking",total_questions:d.length,correct_answers:null,score_percentage:0,time_taken:900,audio_urls:c,audio_retention_expires_at:null,test_data:{recordings_count:d.length,parts_completed:[1,2,3].filter(e=>!Je.has(e)),parts_skipped:Array.from(Je),r2_upload_summary:{total:d.length,successful:m,failed:u},retention_policy:"no_auto_expiry_r2_persistent"}}).select().single();if(h||!p)throw h||new Error("Failed to create speaking test result");console.log("‚úÖ Speaking test base records saved. AI scoring will be handled by backend using stored metadata and URLs.");const g=[];for(const l of d){const i=l.part.match(/^part(\d+)/),c=i?parseInt(i[1],10):NaN;if(isNaN(c)||c<1||c>3){console.error(`Invalid part number for recording: ${l.part}`);continue}let d="";if(1===c&&(null==(e=null==Ce?void 0:Ce.part1_prompts)?void 0:e.length)){const e=l.part.match(/_q(\d+)/),a=e?parseInt(e[1],10):0;a>=0&&a<Ce.part1_prompts.length&&(d=(null==(r=Ce.part1_prompts[a])?void 0:r.prompt_text)||(null==(t=Ce.part1_prompts[a])?void 0:t.transcription)||"")}else if(2===c&&(null==Ce?void 0:Ce.part2_prompt))d=Ce.part2_prompt.prompt_text||"";else if(3===c&&(null==(a=null==Ce?void 0:Ce.part3_prompts)?void 0:a.length)){const e=l.part.match(/_q(\d+)/),r=e?parseInt(e[1],10):0;r>=0&&r<Ce.part3_prompts.length&&(d=(null==(s=Ce.part3_prompts[r])?void 0:s.prompt_text)||(null==(o=Ce.part3_prompts[r])?void 0:o.transcription)||"")}g.push({user_id:n.id,test_result_id:p.id,part_number:c,question_text:d,audio_url:l.audio_url,transcription:"",band_scores:{},detailed_feedback:"",duration_seconds:120})}const{error:x}=await i.from("speaking_test_results").insert(g);if(x)throw x;console.log("‚úÖ Speaking test base records saved. Running AI scoring..."),console.log("‚ÑπÔ∏è Skipping inline AI scoring for speaking test; base records saved for backend evaluation."),Qe({}),je("/ielts-speaking-results",{state:{testData:Ce,recordings:d,audioBlobs:Object.fromEntries(l),testResultId:p.id}})}catch(n){console.error("Error saving or scoring speaking results:",n),we({title:"Save error",description:"Failed to save or score speaking results. Your recordings may not be fully processed.",variant:"destructive"})}}catch(l){console.error("Error submitting test:",l),we({title:"Submission Error",description:"Failed to submit test. Please try again.",variant:"destructive"})}})()},className:"font-medium",style:{backgroundColor:Ne.buttonPrimary,color:"#ffffff"},children:"Submit"})]})}),(1===Ee||3===Ee)&&!rr&&e.jsx(x,{children:e.jsxs(e.Fragment,{children:[e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"ghost",onClick:()=>{console.log("üîô Previous question button clicked"),Me>0&&(Ae(Me-1),dr(!1),Nr(null),_r(!1))},disabled:0===Me,size:"icon",className:"absolute bottom-0 left-0 h-12 w-12",style:{color:Ne.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=Ne.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=Ne.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:e.jsx(le,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:"Previous question"})})]}),e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"ghost",onClick:()=>{console.log("üîò Next question button clicked"),dr(!1),Br()},disabled:!Ke[`part${Ee}_q${Me}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12",style:{color:Ne.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=Ne.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=Ne.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:e.jsx(ie,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:Ke[`part${Ee}_q${Me}`]?Me!==((null==Ce?void 0:Ce.part1_prompts.length)||0)-1||1!==Ee||(null==Ce?void 0:Ce.part2_prompt)||(null==Ce?void 0:Ce.part3_prompts)&&0!==Ce.part3_prompts.length?"Next question":"Complete test":"Please record your answer first"})})]})]})}),2===Ee&&!rr&&e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"ghost",onClick:()=>{console.log("üîò Part 2 navigation button clicked"),Br()},disabled:!Ke[`part${Ee}_q${Me}`],size:"icon",className:"absolute bottom-0 right-0 h-12 w-12 hover:bg-transparent hover:text-foreground",style:{color:Ne.textSecondary},onMouseEnter:e=>{e.currentTarget.style.color=Ne.buttonPrimary,e.currentTarget.style.backgroundColor="transparent"},onMouseLeave:e=>{e.currentTarget.style.color=Ne.textSecondary,e.currentTarget.style.backgroundColor="transparent"},children:e.jsx(ie,{className:"w-5 h-5"})})}),e.jsx(y,{children:e.jsx("p",{children:Ke[`part${Ee}_q${Me}`]?(null==Ce?void 0:Ce.part3_prompts)&&Ce.part3_prompts.length>0?"Go to Part 3":"Complete test":"Please record your answer first"})})]})})]})]}),e.jsx("div",{className:"fixed bottom-6 left-6 z-40 flex items-center gap-4",children:e.jsx("button",{onClick:()=>je("/ielts-portal"),className:"text-lg cursor-pointer transition-colors",style:{color:Ne.textSecondary},onMouseEnter:e=>e.currentTarget.style.color=Ne.buttonPrimary,onMouseLeave:e=>e.currentTarget.style.color=Ne.textSecondary,children:"Exit Test"})}),or&&e.jsxs("div",{className:"fixed bottom-12 right-4 sm:bottom-20 sm:right-[420px] z-50 flex flex-col gap-2 sm:gap-3",children:[e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"icon",onClick:()=>Gr("Help with Speaking Structure"),disabled:yr,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:Ne.border||"#e5e7eb",backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff",color:Ne.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},children:e.jsx(ce,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:Ne.buttonPrimary||"#2563eb"}})})}),e.jsx(y,{side:"left",children:e.jsx("p",{children:"Get help with speaking structure"})})]})}),e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"icon",onClick:()=>Gr("Suggest Some Speaking Vocabulary"),disabled:yr,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:Ne.border||"#e5e7eb",backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff",color:Ne.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},children:e.jsx(de,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:Ne.buttonPrimary||"#2563eb"}})})}),e.jsx(y,{side:"left",children:e.jsx("p",{children:"Get vocabulary suggestions"})})]})}),e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"icon",onClick:()=>Gr("Give me 2-3 straightforward band 7+ example answers for this exact IELTS Speaking question. Just show the actual answers, no explanations."),disabled:yr,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:Ne.border||"#e5e7eb",backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff",color:Ne.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},children:e.jsx(re,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:Ne.buttonPrimary||"#2563eb"}})})}),e.jsx(y,{side:"left",children:e.jsx("p",{children:"View band 7+ example answers"})})]})}),e.jsx(x,{children:e.jsxs(f,{children:[e.jsx(b,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"icon",onClick:()=>Gr("Help me with grammar for this speaking question"),disabled:yr,className:"h-9 w-9 sm:h-12 sm:w-12 p-0 backdrop-blur-sm shadow-lg",style:{borderColor:Ne.border||"#e5e7eb",backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff",color:Ne.buttonPrimary||"#2563eb"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=Ne.hoverBg||"rgba(0,0,0,0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.9)":"dark"===Ne.theme.name?"rgba(255,255,255,0.15)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground||"#ffffff"},children:e.jsx(se,{className:"w-4 h-4 sm:w-6 sm:h-6",style:{color:Ne.buttonPrimary||"#2563eb"}})})}),e.jsx(y,{side:"left",children:e.jsx("p",{children:"Get grammar help"})})]})})]}),e.jsxs("div",{className:"fixed bottom-6 right-3 sm:bottom-6 sm:right-6 z-50",children:[or&&e.jsxs(g,{className:"backdrop-blur-md rounded-3xl w-[260px] h-[360px] sm:w-96 sm:h-[500px] shadow-2xl flex flex-col transform-gpu origin-bottom-right transition-all duration-260 ease-in-out "+(lr?"opacity-100 scale-100 translate-y-0":"opacity-0 scale-75 translate-y-8"),style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.95)":"dark"===Ne.theme.name?"rgba(30, 41, 59, 0.95)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,borderColor:Ne.border,backdropFilter:"glassmorphism"===Ne.theme.name?"blur(12px)":"dark"===Ne.theme.name?"blur(8px)":"none",...Ne.cardStyle},children:[e.jsx(v,{className:"pb-1 sm:pb-2 rounded-t-3xl relative",children:e.jsx("div",{className:"absolute top-1.5 right-1.5 sm:top-2 sm:right-2",children:e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{ir(!1),setTimeout(()=>{nr(!1)},260)},className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:Ne.textPrimary},children:"‚úï"})})}),e.jsxs(u,{className:"flex-1 flex flex-col px-2.5 py-2 sm:p-4 overflow-hidden",children:[e.jsx(I,{className:"flex-1 min-h-0",children:e.jsx(q,{className:"flex-1 min-h-0",children:0!==gr.length||yr?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-lg p-3 mb-4",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#f9fafb":"rgba(255,255,255,0.6)",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid"},children:[e.jsx("div",{className:"text-xs uppercase tracking-wide mb-1",style:{color:Ne.textSecondary},children:"Question"}),e.jsx("div",{className:"text-xs sm:text-sm font-medium",style:{color:Ne.textPrimary},children:Kr}),e.jsx("div",{className:"text-[10px] sm:text-sm whitespace-pre-wrap mt-1",style:{color:Ne.textSecondary},children:Yr||"No question available."})]}),gr.map(r=>e.jsxs(B,{from:"user"===r.type?"user":"assistant",children:["bot"===r.type&&e.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:e.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})}),e.jsx(U,{children:e.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid",color:Ne.textPrimary},children:e.jsx(D,{dangerouslySetInnerHTML:{__html:r.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^‚Ä¢ (.*)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}})})}),"user"===r.type&&(null==ke?void 0:ke.avatar_url)&&e.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px",flexShrink:0},children:e.jsx("img",{src:ke.avatar_url,alt:"Your avatar",style:{width:"100%",height:"100%",objectFit:"cover"}})})]},r.id)),yr&&e.jsxs(B,{from:"assistant",children:[e.jsx(U,{children:e.jsx("div",{className:"px-3 py-2 rounded-xl text-sm",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#f9fafb":"rgba(255,255,255,0.5)",borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid"},children:e.jsx(W,{text:"Thinking..."})})}),e.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"52px",height:"52px"},children:e.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]}):e.jsx(F,{icon:e.jsx(z,{className:"size-9 sm:size-12",style:{color:Ne.textSecondary}}),title:"Start a conversation",description:"Ask for help with your IELTS speaking practice"})})}),e.jsx("div",{className:"flex-shrink-0 mt-2.5 sm:mt-4",children:e.jsxs("div",{className:"flex gap-1.5 sm:gap-2",children:[e.jsx("input",{type:"text",value:fr,onChange:e=>br(e.target.value),onKeyPress:e=>"Enter"===e.key&&!yr&&fr.trim()&&Vr(),placeholder:"Ask for speaking help...",className:"flex-1 px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-lg text-[10px] sm:text-sm focus:outline-none focus:ring-0 resize-none",style:{backgroundColor:"glassmorphism"===Ne.theme.name?"rgba(255,255,255,0.1)":"dark"===Ne.theme.name?"rgba(255,255,255,0.05)":"minimalist"===Ne.theme.name?"#ffffff":Ne.theme.colors.cardBackground,borderColor:Ne.border,borderWidth:"1px",borderStyle:"solid",color:Ne.textPrimary},disabled:yr}),e.jsx("style",{dangerouslySetInnerHTML:{__html:`\n                      input[placeholder="Ask for speaking help..."]::placeholder {\n                        color: ${Ne.textSecondary};\n                      }\n                    `}}),e.jsx(p,{onClick:()=>Vr(),disabled:yr||!fr.trim(),variant:"ghost",size:"icon",className:"h-7 w-7 sm:h-8 sm:w-8 p-0",style:{color:Ne.textPrimary},children:yr?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2",style:{borderColor:Ne.textPrimary}}):e.jsx(me,{className:"w-4 h-4"})})]})})]})]}),!or&&e.jsx("div",{style:{borderRadius:"50%",overflow:"hidden",width:"64px",height:"64px",cursor:"pointer",boxShadow:"0 8px 20px rgba(0,0,0,0.18)",transition:"transform 0.22s ease-out, box-shadow 0.22s ease-out"},onClick:()=>{nr(!0),requestAnimationFrame(()=>ir(!0))},onMouseEnter:e=>{const r=e.currentTarget;r.style.transform="scale(1.06) translateY(-2px)",r.style.boxShadow="0 14px 30px rgba(0,0,0,0.24)"},onMouseLeave:e=>{const r=e.currentTarget;r.style.transform="scale(1.0) translateY(0px)",r.style.boxShadow="0 10px 25px rgba(0,0,0,0.15)"},children:e.jsx("img",{src:"/1000031289.png",alt:"Catie",style:{width:"100%",height:"100%",objectFit:"cover"}})})]})]})})})})]})};export{ge as default};
