import{r as e,j as s}from"./vendor-react-rLLBBC7n.js";import{J as t,C as a,b as r,c as n,a as l,B as i,S as o,i as c,j as d,k as u,l as m,e as x,T as p,I as g,s as h}from"./index-BDl0jLJK.js";import{ak as b,aS as j,aV as v,q as f,aN as N,X as y,bD as w}from"./vendor-ui-BGi_EvHx.js";const q=({testId:q,testType:k,onQuestionsExtracted:_,initialImageFile:T,onImageSelected:I})=>{const[C,S]=e.useState(null),[Q,A]=e.useState(""),[D,E]=e.useState("questions"),[P,z]=e.useState("Multiple Choice"),[F,L]=e.useState(!1),[G,R]=e.useState([]),[M,O]=e.useState(null),[B,$]=e.useState(null),[U,V]=e.useState(!1);e.useEffect(()=>{T&&J(T)},[T]);const J=e=>{if(!e.type.startsWith("image/"))return void t.error("Please upload an image file (JPG, PNG, WebP)");if(e.size>10485760)return void t.error("Image size should be less than 10MB");S(e),I&&I(e);const s=new FileReader;s.onloadend=()=>{A(s.result)},s.readAsDataURL(e),t.success("Image uploaded successfully!")},W=()=>{O(null),$(null)},K=()=>{if(null!==M&&B){const e=[...G];e[M]=B,R(e),O(null),$(null),t.success("Question updated")}};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs(a,{className:"border-2 border-purple-200 dark:border-purple-800",children:[s.jsxs(r,{className:"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950 dark:to-blue-950",children:[s.jsxs(n,{className:"flex items-center gap-2",children:[s.jsx(b,{className:"w-5 h-5 text-purple-600"}),"AI Question Extraction (Gemini Vision)"]}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Upload an image of IELTS questions and let Gemini AI extract them automatically"})]}),s.jsxs(l,{className:"pt-6 space-y-6",children:[s.jsx("div",{className:"border-2 border-dashed rounded-lg p-8 transition-all duration-200 "+(U?"border-purple-500 bg-purple-50 dark:bg-purple-900/20 scale-[1.02]":"border-border hover:border-purple-400"),onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),V(!0)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget===e.target&&V(!1)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),V(!1);const s=e.dataTransfer.files;if(s&&s.length>0){const e=s[0];J(e)}},children:Q?s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"relative max-h-96 overflow-hidden rounded-lg border",children:s.jsx("img",{src:Q,alt:"Questions Preview",className:"w-full object-contain"})}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[s.jsx(f,{className:"w-4 h-4 text-green-500"}),null==C?void 0:C.name," (",(C.size/1024).toFixed(0)," KB)"]}),s.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{S(null),A(""),R([])},children:"Change Image"})]})]}):s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"transition-transform duration-200 "+(U?"scale-110":""),children:s.jsx(j,{className:"w-16 h-16 mx-auto mb-4 "+(U?"text-purple-600":"text-purple-400")})}),s.jsx("h4",{className:"font-medium mb-2",children:U?"ðŸ“Ž Drop image here!":"Upload Question Image"}),s.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:U?"Release to upload":"Drag & drop or click to browse â€¢ JPG, PNG, WebP (max 10MB)"}),!U&&s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&J(t)},className:"hidden",id:"question-image-upload"}),s.jsxs(i,{onClick:()=>{var e;return null==(e=document.getElementById("question-image-upload"))?void 0:e.click()},variant:"outline",className:"border-purple-300 hover:bg-purple-50",children:[s.jsx(v,{className:"w-4 h-4 mr-2"}),"Choose Image"]}),s.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"ðŸ’¡ Tip: Clear, high-resolution images work best"})]})]})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium",children:"Extraction Type"}),s.jsxs(o,{value:D,onValueChange:E,children:[s.jsx(c,{children:s.jsx(d,{placeholder:"Select extraction type"})}),s.jsxs(u,{children:[s.jsx(m,{value:"questions",children:"ðŸ“ Questions (Full questions with options)"}),s.jsx(m,{value:"answers",children:"âœ“ Answers Only (Answer keys for 1-40)"})]})]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ Choose whether to extract full questions or just the answer keys"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("label",{className:"text-sm font-medium",children:["Question Type ",s.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),s.jsxs(o,{value:P,onValueChange:z,children:[s.jsx(c,{children:s.jsx(d,{placeholder:"AI will auto-detect type"})}),s.jsxs(u,{children:[s.jsx(m,{value:"auto",children:"ðŸ¤– Auto-Detect (Recommended)"}),s.jsx(m,{value:"Listening Question Type 1 â€“ Multiple choice",children:"Type 1 â€“ Multiple choice"}),s.jsx(m,{value:"Listening Question Type 2 â€“ Matching",children:"Type 2 â€“ Matching"}),s.jsx(m,{value:"Listening Question Type 3 â€“ Plan/map/diagram labelling",children:"Type 3 â€“ Plan/map/diagram labelling"}),s.jsx(m,{value:"Listening Question Type 4 â€“ Form/note/table/flow chart/summary completion",children:"Type 4 â€“ Form/note/table/flow chart/summary completion"}),s.jsx(m,{value:"Listening Question Type 5 â€“ Sentence completion",children:"Type 5 â€“ Sentence completion"}),s.jsx(m,{value:"Listening Question Type 6 â€“ Short-answer questions",children:"Type 6 â€“ Short-answer questions"})]})]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI analyzes the image to identify question types"})]})]}),s.jsx(i,{onClick:async()=>{var e;if(C){L(!0);try{const s=Q.split(",")[1],a="1-40",r=P&&"auto"!==P?P:"";console.log("ðŸ“¤ Sending to Gemini:",{extractionType:D,questionRange:a,questionType:r||"AUTO-DETECT",imageSize:s.length});const{data:n,error:l}=await h.functions.invoke("gemini-question-extractor",{body:{imageBase64:s,questionRange:a,questionType:r,extractionType:D,testType:k,testId:q}});if(l)throw console.error("âŒ Extraction error:",l),l;if(!n.success)throw new Error(n.error||"Extraction failed");console.log("âœ… Extracted questions:",n),console.log("ðŸ“‹ Structure items:",n.structureItems),console.log("ðŸ“‹ Raw questions:",n.questions);let i=[];n.structureItems&&n.structureItems.length>0?(console.log("ðŸ“Š Using structureItems for rendering"),i=n.structureItems.map((e,s)=>{const t=!0===e.isQuestion,a=e.questionNumber||0,r=(n.questions||[]).find(e=>e.question_number===a);return{question_number:a,question_text:e.displayText||e.label||"",question_type:n.questionType||"note_completion",options:(null==r?void 0:r.options)||null,correct_answer:(null==r?void 0:r.correct_answer)||"",explanation:(null==r?void 0:r.explanation)||"",is_info_row:!t,label:e.label||"",value:e.value||e.prefixText||"",section_header:0===s&&n.taskInstructions||"",section_label:0===s&&n.partNumber||"",order:e.order||s+1,fullSentence:e.fullSentence||!1}}),console.log("ðŸ“Š Processed questions with structure:",i)):(console.log("ðŸ“Š Fallback: extracting label from questions array"),i=(n.questions||[]).map((e,s)=>{let t=e.fieldLabel||e.label||"",a=e.value||e.prefixText||"";const r=!0===e.is_info_row||0===e.question_number;if(!t&&e.question_text){const s=e.question_text.indexOf(":");if(s>0){t=e.question_text.substring(0,s).trim();const r=e.question_text.substring(s+1),n=r.match(/\(?\d+\)?/);n&&n.index&&n.index>0&&(a=r.substring(0,n.index).trim())}}return{question_number:e.question_number||s+1,question_text:e.question_text||"",question_type:e.question_type||n.questionType||"note_completion",options:e.options||null,correct_answer:e.correct_answer||"",explanation:e.explanation||"",is_info_row:r,label:t,value:a,section_header:0===s&&n.taskInstructions||"",section_label:0===s&&n.partNumber||""}})),R(i);const o=n.autoDetected?`\nDetected: ${n.range} (${n.questionType})`:`Range: ${n.range}`,c=(null==(e=n.structureItems)?void 0:e.length)?`\n${n.structureItems.length} structure items (including context rows)`:"";t.success(`âœ¨ Successfully extracted ${n.count} questions!`,{description:o+c})}catch(s){console.error("âŒ Extraction failed:",s),t.error("Failed to extract questions",{description:s.message||"Please try again or check the image quality"})}finally{L(!1)}}else t.error("Please upload an image")},disabled:!C||F,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700",size:"lg",children:F?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Gemini AI is analyzing the image..."]}):s.jsxs(s.Fragment,{children:[s.jsx(b,{className:"w-5 h-5 mr-2"}),"Extract Questions with AI"]})})]})]}),G.length>0&&s.jsxs(a,{children:[s.jsx(r,{children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsxs(n,{className:"flex items-center gap-2",children:[s.jsx(N,{className:"w-5 h-5"}),"Extracted Questions (",G.length,")"]}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and edit if needed, then save to database"})]}),s.jsx(x,{variant:"secondary",className:"text-sm",children:"questions"===D?"Questions 1-40":"Answers 1-40"})]})}),s.jsxs(l,{children:[s.jsx("div",{className:"max-h-[600px] overflow-y-auto space-y-4",children:G.map((e,a)=>s.jsx("div",{className:"border rounded-lg overflow-hidden",children:M===a?s.jsxs("div",{className:"p-4 space-y-3 bg-muted/30",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs font-medium",children:["Question ",e.question_number]}),s.jsx(p,{value:(null==B?void 0:B.question_text)||"",onChange:e=>$(s=>s?{...s,question_text:e.target.value}:null),rows:3,className:"mt-1"})]}),(null==B?void 0:B.options)&&s.jsxs("div",{children:[s.jsx("label",{className:"text-xs font-medium",children:"Options (one per line)"}),s.jsx(p,{value:B.options.join("\n"),onChange:e=>$(s=>s?{...s,options:e.target.value.split("\n")}:null),rows:4,className:"mt-1"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-xs font-medium",children:"Correct Answer"}),s.jsx(g,{value:(null==B?void 0:B.correct_answer)||"",onChange:e=>$(s=>s?{...s,correct_answer:e.target.value}:null),className:"mt-1"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(i,{size:"sm",onClick:K,children:[s.jsx(f,{className:"w-4 h-4 mr-1"}),"Save"]}),s.jsxs(i,{size:"sm",variant:"outline",onClick:W,children:[s.jsx(y,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]}):s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 border-b",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(x,{variant:"outline",className:"font-mono",children:["Q",e.question_number]}),s.jsx(x,{variant:"secondary",className:"Multiple Choice"===e.question_type?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"Fill in the blank"===e.question_type?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"True/False/Not Given"===e.question_type?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:e.question_type})]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(i,{size:"sm",variant:"ghost",onClick:()=>(e=>{O(e),$({...G[e]})})(a),children:s.jsx(w,{className:"w-3 h-3"})}),s.jsx(i,{size:"sm",variant:"ghost",onClick:()=>(e=>{const s=G.filter((s,t)=>t!==e);R(s),t.success("Question removed")})(a),className:"text-red-500 hover:text-red-700",children:s.jsx(y,{className:"w-3 h-3"})})]})]}),s.jsxs("div",{className:"p-4 bg-white dark:bg-gray-900",children:[s.jsxs("div",{className:"mb-3",children:[s.jsxs("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1",children:["Question ",e.question_number]}),s.jsx("p",{className:"text-base leading-relaxed",children:e.question_text})]}),e.options&&e.options.length>0&&s.jsx("div",{className:"space-y-2 pl-2",children:e.options.map((t,r)=>s.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors "+(t===e.correct_answer?"bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[s.jsx("input",{type:"radio",name:`question-${a}`,checked:t===e.correct_answer,readOnly:!0,className:"w-4 h-4"}),s.jsx("span",{className:t===e.correct_answer?"font-medium text-green-700 dark:text-green-300":"",children:t}),t===e.correct_answer&&s.jsx(x,{variant:"default",className:"ml-auto text-xs",children:"âœ“ Correct"})]},r))}),!e.options&&e.correct_answer&&s.jsx("div",{className:"space-y-2",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Answer:"}),s.jsx(g,{value:e.correct_answer,readOnly:!0,className:"max-w-xs bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700 font-medium"}),s.jsx(x,{variant:"default",className:"text-xs",children:"âœ“ Correct Answer"})]})}),e.explanation&&s.jsxs("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[s.jsx("p",{className:"text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1",children:"Explanation:"}),s.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-400",children:e.explanation})]})]})]})},a))}),s.jsxs("div",{className:"mt-6 flex gap-3",children:[s.jsxs(i,{onClick:()=>_(G),className:"flex-1 bg-green-600 hover:bg-green-700",size:"lg",children:[s.jsx(f,{className:"w-5 h-5 mr-2"}),"Save ",G.length," Questions to Database"]}),s.jsx(i,{variant:"outline",onClick:()=>R([]),children:"Clear All"})]})]})]})]})};export{q as I};
