import{c as e,r as s,J as t,j as a,C as r,b as n,d as l,O as i,a as o,B as c,x as d,S as u,p as m,q as x,s as p,t as g,E as h,l as b,T as j,I as v,X as f}from"./index-CdTEz0eh.js";import{s as y}from"./supabase-DWL4C3fA.js";import{I as N}from"./image-olWVJqOh.js";import{U as w}from"./upload-D63c_qIV.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=e("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),k=({testId:e,testType:k,onQuestionsExtracted:_,initialImageFile:T,onImageSelected:I})=>{const[C,S]=s.useState(null),[Q,P]=s.useState(""),[E,A]=s.useState("questions"),[D,z]=s.useState("Multiple Choice"),[F,L]=s.useState(!1),[G,M]=s.useState([]),[O,R]=s.useState(null),[B,U]=s.useState(null),[$,J]=s.useState(!1);s.useEffect(()=>{T&&V(T)},[T]);const V=e=>{if(!e.type.startsWith("image/"))return void t.error("Please upload an image file (JPG, PNG, WebP)");if(e.size>10485760)return void t.error("Image size should be less than 10MB");S(e),I&&I(e);const s=new FileReader;s.onloadend=()=>{P(s.result)},s.readAsDataURL(e),t.success("Image uploaded successfully!")},W=()=>{R(null),U(null)},K=()=>{if(null!==O&&B){const e=[...G];e[O]=B,M(e),R(null),U(null),t.success("Question updated")}};return a.jsxs("div",{className:"space-y-6",children:[a.jsxs(r,{className:"border-2 border-purple-200 dark:border-purple-800",children:[a.jsxs(n,{className:"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950 dark:to-blue-950",children:[a.jsxs(l,{className:"flex items-center gap-2",children:[a.jsx(i,{className:"w-5 h-5 text-purple-600"}),"AI Question Extraction (Gemini Vision)"]}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Upload an image of IELTS questions and let Gemini AI extract them automatically"})]}),a.jsxs(o,{className:"pt-6 space-y-6",children:[a.jsx("div",{className:"border-2 border-dashed rounded-lg p-8 transition-all duration-200 "+($?"border-purple-500 bg-purple-50 dark:bg-purple-900/20 scale-[1.02]":"border-border hover:border-purple-400"),onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),J(!0)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget===e.target&&J(!1)},onDrop:e=>{e.preventDefault(),e.stopPropagation(),J(!1);const s=e.dataTransfer.files;if(s&&s.length>0){const e=s[0];V(e)}},children:Q?a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"relative max-h-96 overflow-hidden rounded-lg border",children:a.jsx("img",{src:Q,alt:"Questions Preview",className:"w-full object-contain"})}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[a.jsx(d,{className:"w-4 h-4 text-green-500"}),null==C?void 0:C.name," (",(C.size/1024).toFixed(0)," KB)"]}),a.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{S(null),P(""),M([])},children:"Change Image"})]})]}):a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"transition-transform duration-200 "+($?"scale-110":""),children:a.jsx(N,{className:"w-16 h-16 mx-auto mb-4 "+($?"text-purple-600":"text-purple-400")})}),a.jsx("h4",{className:"font-medium mb-2",children:$?"ðŸ“Ž Drop image here!":"Upload Question Image"}),a.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:$?"Release to upload":"Drag & drop or click to browse â€¢ JPG, PNG, WebP (max 10MB)"}),!$&&a.jsxs(a.Fragment,{children:[a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&V(t)},className:"hidden",id:"question-image-upload"}),a.jsxs(c,{onClick:()=>{var e;return null==(e=document.getElementById("question-image-upload"))?void 0:e.click()},variant:"outline",className:"border-purple-300 hover:bg-purple-50",children:[a.jsx(w,{className:"w-4 h-4 mr-2"}),"Choose Image"]}),a.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"ðŸ’¡ Tip: Clear, high-resolution images work best"})]})]})}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"text-sm font-medium",children:"Extraction Type"}),a.jsxs(u,{value:E,onValueChange:A,children:[a.jsx(m,{children:a.jsx(x,{placeholder:"Select extraction type"})}),a.jsxs(p,{children:[a.jsx(g,{value:"questions",children:"ðŸ“ Questions (Full questions with options)"}),a.jsx(g,{value:"answers",children:"âœ“ Answers Only (Answer keys for 1-40)"})]})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ Choose whether to extract full questions or just the answer keys"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("label",{className:"text-sm font-medium",children:["Question Type ",a.jsx("span",{className:"text-muted-foreground font-normal",children:"(Optional - AI will detect)"})]}),a.jsxs(u,{value:D,onValueChange:z,children:[a.jsx(m,{children:a.jsx(x,{placeholder:"AI will auto-detect type"})}),a.jsxs(p,{children:[a.jsx(g,{value:"auto",children:"ðŸ¤– Auto-Detect (Recommended)"}),a.jsx(g,{value:"Listening Question Type 1 â€“ Multiple choice",children:"Type 1 â€“ Multiple choice"}),a.jsx(g,{value:"Listening Question Type 2 â€“ Matching",children:"Type 2 â€“ Matching"}),a.jsx(g,{value:"Listening Question Type 3 â€“ Plan/map/diagram labelling",children:"Type 3 â€“ Plan/map/diagram labelling"}),a.jsx(g,{value:"Listening Question Type 4 â€“ Form/note/table/flow chart/summary completion",children:"Type 4 â€“ Form/note/table/flow chart/summary completion"}),a.jsx(g,{value:"Listening Question Type 5 â€“ Sentence completion",children:"Type 5 â€“ Sentence completion"}),a.jsx(g,{value:"Listening Question Type 6 â€“ Short-answer questions",children:"Type 6 â€“ Short-answer questions"})]})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"ðŸ’¡ AI analyzes the image to identify question types"})]})]}),a.jsx(c,{onClick:async()=>{var s;if(C){L(!0);try{const a=Q.split(",")[1],r="1-40",n=D&&"auto"!==D?D:"";console.log("ðŸ“¤ Sending to Gemini:",{extractionType:E,questionRange:r,questionType:n||"AUTO-DETECT",imageSize:a.length});const{data:l,error:i}=await y.functions.invoke("gemini-question-extractor",{body:{imageBase64:a,questionRange:r,questionType:n,extractionType:E,testType:k,testId:e}});if(i)throw console.error("âŒ Extraction error:",i),i;if(!l.success)throw new Error(l.error||"Extraction failed");console.log("âœ… Extracted questions:",l),console.log("ðŸ“‹ Structure items:",l.structureItems),console.log("ðŸ“‹ Raw questions:",l.questions);let o=[];l.structureItems&&l.structureItems.length>0?(console.log("ðŸ“Š Using structureItems for rendering"),o=l.structureItems.map((e,s)=>{const t=!0===e.isQuestion,a=e.questionNumber||0,r=(l.questions||[]).find(e=>e.question_number===a);return{question_number:a,question_text:e.displayText||e.label||"",question_type:l.questionType||"note_completion",options:(null==r?void 0:r.options)||null,correct_answer:(null==r?void 0:r.correct_answer)||"",explanation:(null==r?void 0:r.explanation)||"",is_info_row:!t,label:e.label||"",value:e.value||e.prefixText||"",section_header:0===s&&l.taskInstructions||"",section_label:0===s&&l.partNumber||"",order:e.order||s+1,fullSentence:e.fullSentence||!1}}),console.log("ðŸ“Š Processed questions with structure:",o)):(console.log("ðŸ“Š Fallback: extracting label from questions array"),o=(l.questions||[]).map((e,s)=>{let t=e.fieldLabel||e.label||"",a=e.value||e.prefixText||"";const r=!0===e.is_info_row||0===e.question_number;if(!t&&e.question_text){const s=e.question_text.indexOf(":");if(s>0){t=e.question_text.substring(0,s).trim();const r=e.question_text.substring(s+1),n=r.match(/\(?\d+\)?/);n&&n.index&&n.index>0&&(a=r.substring(0,n.index).trim())}}return{question_number:e.question_number||s+1,question_text:e.question_text||"",question_type:e.question_type||l.questionType||"note_completion",options:e.options||null,correct_answer:e.correct_answer||"",explanation:e.explanation||"",is_info_row:r,label:t,value:a,section_header:0===s&&l.taskInstructions||"",section_label:0===s&&l.partNumber||""}})),M(o);const c=l.autoDetected?`\nDetected: ${l.range} (${l.questionType})`:`Range: ${l.range}`,d=(null==(s=l.structureItems)?void 0:s.length)?`\n${l.structureItems.length} structure items (including context rows)`:"";t.success(`âœ¨ Successfully extracted ${l.count} questions!`,{description:c+d})}catch(a){console.error("âŒ Extraction failed:",a),t.error("Failed to extract questions",{description:a.message||"Please try again or check the image quality"})}finally{L(!1)}}else t.error("Please upload an image")},disabled:!C||F,className:"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700",size:"lg",children:F?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Gemini AI is analyzing the image..."]}):a.jsxs(a.Fragment,{children:[a.jsx(i,{className:"w-5 h-5 mr-2"}),"Extract Questions with AI"]})})]})]}),G.length>0&&a.jsxs(r,{children:[a.jsx(n,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsxs(l,{className:"flex items-center gap-2",children:[a.jsx(h,{className:"w-5 h-5"}),"Extracted Questions (",G.length,")"]}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and edit if needed, then save to database"})]}),a.jsx(b,{variant:"secondary",className:"text-sm",children:"questions"===E?"Questions 1-40":"Answers 1-40"})]})}),a.jsxs(o,{children:[a.jsx("div",{className:"max-h-[600px] overflow-y-auto space-y-4",children:G.map((e,s)=>a.jsx("div",{className:"border rounded-lg overflow-hidden",children:O===s?a.jsxs("div",{className:"p-4 space-y-3 bg-muted/30",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"text-xs font-medium",children:["Question ",e.question_number]}),a.jsx(j,{value:(null==B?void 0:B.question_text)||"",onChange:e=>U(s=>s?{...s,question_text:e.target.value}:null),rows:3,className:"mt-1"})]}),(null==B?void 0:B.options)&&a.jsxs("div",{children:[a.jsx("label",{className:"text-xs font-medium",children:"Options (one per line)"}),a.jsx(j,{value:B.options.join("\n"),onChange:e=>U(s=>s?{...s,options:e.target.value.split("\n")}:null),rows:4,className:"mt-1"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs font-medium",children:"Correct Answer"}),a.jsx(v,{value:(null==B?void 0:B.correct_answer)||"",onChange:e=>U(s=>s?{...s,correct_answer:e.target.value}:null),className:"mt-1"})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(c,{size:"sm",onClick:K,children:[a.jsx(d,{className:"w-4 h-4 mr-1"}),"Save"]}),a.jsxs(c,{size:"sm",variant:"outline",onClick:W,children:[a.jsx(f,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]}):a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 border-b",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(b,{variant:"outline",className:"font-mono",children:["Q",e.question_number]}),a.jsx(b,{variant:"secondary",className:"Multiple Choice"===e.question_type?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"Fill in the blank"===e.question_type?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":"True/False/Not Given"===e.question_type?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:e.question_type})]}),a.jsxs("div",{className:"flex gap-1",children:[a.jsx(c,{size:"sm",variant:"ghost",onClick:()=>(e=>{R(e),U({...G[e]})})(s),children:a.jsx(q,{className:"w-3 h-3"})}),a.jsx(c,{size:"sm",variant:"ghost",onClick:()=>(e=>{const s=G.filter((s,t)=>t!==e);M(s),t.success("Question removed")})(s),className:"text-red-500 hover:text-red-700",children:a.jsx(f,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"p-4 bg-white dark:bg-gray-900",children:[a.jsxs("div",{className:"mb-3",children:[a.jsxs("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1",children:["Question ",e.question_number]}),a.jsx("p",{className:"text-base leading-relaxed",children:e.question_text})]}),e.options&&e.options.length>0&&a.jsx("div",{className:"space-y-2 pl-2",children:e.options.map((t,r)=>a.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors "+(t===e.correct_answer?"bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700"),children:[a.jsx("input",{type:"radio",name:`question-${s}`,checked:t===e.correct_answer,readOnly:!0,className:"w-4 h-4"}),a.jsx("span",{className:t===e.correct_answer?"font-medium text-green-700 dark:text-green-300":"",children:t}),t===e.correct_answer&&a.jsx(b,{variant:"default",className:"ml-auto text-xs",children:"âœ“ Correct"})]},r))}),!e.options&&e.correct_answer&&a.jsx("div",{className:"space-y-2",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("label",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Answer:"}),a.jsx(v,{value:e.correct_answer,readOnly:!0,className:"max-w-xs bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700 font-medium"}),a.jsx(b,{variant:"default",className:"text-xs",children:"âœ“ Correct Answer"})]})}),e.explanation&&a.jsxs("div",{className:"mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[a.jsx("p",{className:"text-xs font-semibold text-blue-700 dark:text-blue-300 mb-1",children:"Explanation:"}),a.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-400",children:e.explanation})]})]})]})},s))}),a.jsxs("div",{className:"mt-6 flex gap-3",children:[a.jsxs(c,{onClick:()=>_(G),className:"flex-1 bg-green-600 hover:bg-green-700",size:"lg",children:[a.jsx(d,{className:"w-5 h-5 mr-2"}),"Save ",G.length," Questions to Database"]}),a.jsx(c,{variant:"outline",onClick:()=>M([]),children:"Clear All"})]})]})]})]})};export{k as I,q as P};
