import{u as e,a2 as s,h as r,a0 as t,r as a,j as n,a3 as i,bg as o,a4 as l,an as c,k as d,C as u,b as m,d as x,M as g,y as h,a as p,O as j,Y as f,Z as y,a1 as v,a9 as b,B as w,K as N,l as k,aq as S,V as q,N as _,z as C,ai as Q}from"./index-DGTvukq5.js";import{s as E}from"./supabase-DWL4C3fA.js";import{P}from"./phone-YeUpyjIj.js";import{S as F}from"./skip-forward-Cz1Qci1e.js";import{P as I}from"./phone-off-Bel8qoXP.js";import{A}from"./award-D5wytfjc.js";import{C as B}from"./circle-alert-CF23T1As.js";import{C as R}from"./chart-column-DZZWoOqm.js";const $=[{id:"Elias",name:"Elias - Professional",gender:"Male"},{id:"Jennifer",name:"Jennifer - Friendly",gender:"Female"},{id:"Ryan",name:"Ryan - Formal",gender:"Male"},{id:"Katerina",name:"Katerina - Warm",gender:"Female"}],T=()=>{var T,U,M,z;const L=e(),{user:G}=s(),{toast:O}=r(),V=t(),D=a.useRef(null),J=a.useRef(null),[Y,K]=a.useState(!0),[W,Z]=a.useState(""),[H,X]=a.useState(""),[ee,se]=a.useState(null),[re,te]=a.useState("quality_only"),[ae,ne]=a.useState("Jennifer"),[ie,oe]=a.useState("idle"),[le,ce]=a.useState(""),[de,ue]=a.useState(""),[me,xe]=a.useState(!1),[ge,he]=a.useState([]),pe=e=>{const s=(new Date).toLocaleTimeString();console.log(`[${s}] ${e}`),he(r=>[...r.slice(-10),`[${s}] ${e}`])};a.useEffect(()=>{(async()=>{if(G)try{const{data:e}=await E.from("business_profiles").select("occupation, industry").eq("user_id",G.id).maybeSingle();e&&(Z(e.occupation||""),X(e.industry||""))}catch(e){console.error("Error loading profile:",e)}finally{K(!1)}else K(!1)})()},[G]),a.useEffect(()=>{const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return void pe("Speech recognition not supported");const s=new e;return s.continuous=!0,s.interimResults=!0,s.language="en-US",s.onstart=()=>{pe("Speech recognition started"),oe("listening")},s.onresult=e=>{let s="",r="";for(let t=e.resultIndex;t<e.results.length;t++){const a=e.results[t][0].transcript;e.results[t].isFinal?r+=a:s=a}r?(ce(e=>e+" "+r),ue("")):ue(s)},s.onerror=e=>{pe(`Speech error: ${e.error}`),"no-speech"!==e.error&&"aborted"!==e.error&&O({title:"Microphone Error",description:"Please check your microphone settings",variant:"destructive"})},s.onend=()=>{if(pe("Speech recognition ended"),"listening"===ie)try{s.start()}catch(e){}},J.current=s,()=>{try{s.abort()}catch(e){}}},[O]);const je=async e=>{oe("speaking"),xe(!0),pe(`Playing question: ${e.substring(0,50)}...`);try{const{data:s,error:r}=await E.functions.invoke("openrouter-qwen-tts",{body:{text:e,voice:ae,language_type:"English"}});if(r)throw r;if(!s.audioContent)throw new Error("No audio content received");{let e=s.audioContent.trim().replace(/\s/g,"");for(e=e.replace(/-/g,"+").replace(/_/g,"/");e.length%4;)e+="=";const r=atob(e),t=new Uint8Array(r.length);for(let s=0;s<r.length;s++)t[s]=r.charCodeAt(s);const a=new Blob([t],{type:"audio/mp3"});if(D.current){const e=URL.createObjectURL(a);D.current.src=e,D.current.onended=()=>{URL.revokeObjectURL(e),xe(!1),pe("Question audio ended, starting listening"),fe()},D.current.onerror=()=>{pe("Audio playback error"),xe(!1),fe()},await D.current.play()}}}catch(s){console.error("TTS error:",s),pe(`TTS error: ${s}`),xe(!1),fe()}},fe=()=>{if(ce(""),ue(""),oe("listening"),J.current)try{J.current.start(),pe("Started listening for answer")}catch(e){pe("Recognition already started")}},ye=async e=>{pe("Generating final summary...");try{const{data:s,error:r}=await E.functions.invoke("interview-evaluator",{body:{action:"generate_summary",questions:e,occupation:W,gradingMode:re}});if(r)throw r;s.success&&ee&&(se({...ee,status:"completed",overallQualityScore:s.overallQualityScore,overallEnglishScore:s.overallEnglishScore,summaryFeedback:s.summaryFeedback,strengths:s.strengths,areasToImprove:s.areasToImprove}),G&&await E.from("interview_sessions").insert({user_id:G.id,occupation:W,industry:H,grading_mode:re,questions:e,overall_quality_score:s.overallQualityScore,overall_english_score:s.overallEnglishScore,summary_feedback:s.summaryFeedback,strengths:s.strengths,areas_to_improve:s.areasToImprove,status:"completed",completed_at:(new Date).toISOString()}),oe("idle"),pe("Interview completed!"))}catch(s){console.error("Error generating summary:",s),oe("idle")}},ve=e=>e>=8?"text-green-600":e>=6?"text-yellow-600":"text-red-600";return Y?n.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:V.theme.colors.background},children:n.jsx(i,{})}):n.jsxs("div",{className:"min-h-screen",style:{backgroundColor:V.theme.colors.background},children:[n.jsx(o,{title:"Interview Practice - Business English",description:"Practice job interviews with AI voice interviewer. Get feedback on answer quality and English proficiency.",keywords:"interview practice, job interview, mock interview, interview preparation"}),n.jsx(l,{title:"Interview Practice",showBackButton:!0,backPath:"/business-portal",children:n.jsxs("div",{className:"max-w-4xl mx-auto px-4 space-y-6",children:[n.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[n.jsx("button",{onClick:()=>L("/hero"),className:"text-muted-foreground hover:text-primary",children:n.jsx(c,{className:"h-4 w-4"})}),n.jsx(d,{className:"h-4 w-4 text-muted-foreground"}),n.jsx("button",{onClick:()=>L("/business-portal"),className:"text-muted-foreground hover:text-primary",children:"Business English"}),n.jsx(d,{className:"h-4 w-4 text-muted-foreground"}),n.jsx("span",{style:{color:V.textPrimary},children:"Interview Practice"})]}),!ee&&n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsxs(m,{children:[n.jsxs(x,{className:"flex items-center gap-2",children:[n.jsx(g,{className:"h-6 w-6 text-orange-500"}),"AI Interview Practice"]}),n.jsx(h,{children:"Practice with a voice-powered AI interviewer. Get instant feedback on your answers."})]}),n.jsxs(p,{className:"space-y-6",children:[n.jsxs("div",{className:"p-4 bg-orange-50 dark:bg-orange-950 rounded-lg",children:[n.jsx("p",{className:"text-sm text-muted-foreground",children:"Practicing for:"}),n.jsxs("p",{className:"text-lg font-semibold capitalize",style:{color:V.textPrimary},children:[W.replace(/_/g," ")," ",H&&`â€¢ ${H}`]})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsx(j,{className:"text-base font-medium",children:"Grading Mode"}),n.jsxs(f,{value:re,onValueChange:e=>te(e),children:[n.jsxs("div",{className:"flex items-start gap-3 p-4 border rounded-lg hover:bg-muted/50 cursor-pointer",children:[n.jsx(y,{value:"quality_only",id:"quality_only"}),n.jsxs("div",{className:"flex-1",children:[n.jsxs(j,{htmlFor:"quality_only",className:"text-sm font-medium cursor-pointer flex items-center gap-2",children:[n.jsx(v,{className:"h-4 w-4 text-blue-500"}),"Answer Quality Only"]}),n.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Focuses on content relevance, structure, depth, and examples"})]})]}),n.jsxs("div",{className:"flex items-start gap-3 p-4 border rounded-lg hover:bg-muted/50 cursor-pointer",children:[n.jsx(y,{value:"quality_and_english",id:"quality_and_english"}),n.jsxs("div",{className:"flex-1",children:[n.jsxs(j,{htmlFor:"quality_and_english",className:"text-sm font-medium cursor-pointer flex items-center gap-2",children:[n.jsx(b,{className:"h-4 w-4 text-purple-500"}),"Quality + English Proficiency"]}),n.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Also evaluates grammar, vocabulary, fluency, and pronunciation"})]})]})]})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsx(j,{className:"text-base font-medium",children:"Interviewer Voice"}),n.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:$.map(e=>n.jsxs("button",{onClick:()=>ne(e.id),className:"p-3 rounded-lg border-2 transition-all text-left "+(ae===e.id?"border-orange-500 bg-orange-50 dark:bg-orange-950":"border-border hover:border-orange-300"),children:[n.jsx("p",{className:"text-sm font-medium",children:e.name}),n.jsx("p",{className:"text-xs text-muted-foreground",children:e.gender})]},e.id))})]}),n.jsxs(w,{onClick:async()=>{if(!W)return O({title:"Profile required",description:"Please set up your business profile first",variant:"destructive"}),void L("/business-portal");oe("thinking"),pe("Starting interview...");try{const{data:e,error:s}=await E.functions.invoke("interview-evaluator",{body:{action:"generate_questions",occupation:W,industry:H,count:10}});if(s)throw s;if(!e.success||!e.questions)throw new Error(e.error||"Failed to generate questions");{const s={id:crypto.randomUUID(),occupation:W,gradingMode:re,questions:e.questions.map((e,s)=>({id:crypto.randomUUID(),question:e,category:s<4?"behavioral":s<7?"situational":"technical"})),currentQuestion:0,status:"in_progress"};se(s),await je(s.questions[0].question)}}catch(e){console.error("Error starting interview:",e),O({title:"Error",description:"Failed to start interview. Please try again.",variant:"destructive"}),oe("idle")}},disabled:!W,className:"w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600",size:"lg",children:[n.jsx(P,{className:"h-5 w-5 mr-2"}),"Start Interview"]}),n.jsx("div",{className:"text-sm text-muted-foreground text-center",children:n.jsx("p",{children:"10 questions â€¢ ~15-20 minutes â€¢ Voice-to-voice conversation"})})]})]}),ee&&"in_progress"===ee.status&&n.jsxs(n.Fragment,{children:[n.jsx(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:n.jsxs(p,{className:"pt-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs("span",{className:"text-sm font-medium",children:["Question ",ee.currentQuestion+1," of 10"]}),n.jsx("span",{className:"text-sm text-muted-foreground",children:"speaking"===ie?"ðŸ”Š Listening...":"listening"===ie?"ðŸŽ¤ Your turn...":"grading"===ie?"â³ Grading...":""})]}),n.jsx(N,{value:10*(ee.currentQuestion+1),className:"h-2"})]})}),n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsxs(m,{children:[n.jsx(k,{variant:"outline",className:"w-fit capitalize",children:null==(T=ee.questions[ee.currentQuestion])?void 0:T.category}),n.jsx(x,{className:"text-xl mt-2",children:null==(U=ee.questions[ee.currentQuestion])?void 0:U.question})]}),n.jsxs(p,{className:"space-y-4",children:[("listening"===ie||le||de)&&n.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-900 rounded-lg min-h-[100px]",children:[n.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Your Answer:"}),n.jsxs("p",{className:"text-base",children:[le,de&&n.jsxs("span",{className:"text-muted-foreground italic",children:[" ",de]})]})]}),n.jsxs("div",{className:"flex gap-3",children:["listening"===ie&&n.jsxs(n.Fragment,{children:[n.jsxs(w,{onClick:async()=>{if(J.current)try{J.current.stop()}catch(s){}const e=(le+" "+de).trim();if(e){if(ee){oe("grading"),pe(`Submitting answer: ${e.substring(0,50)}...`);try{const{data:s,error:r}=await E.functions.invoke("interview-evaluator",{body:{action:"grade_answer",question:ee.questions[ee.currentQuestion].question,answer:e,occupation:W,gradingMode:re}});if(r)throw r;if(!s.success)throw new Error(s.error||"Failed to grade answer");{const r=[...ee.questions];r[ee.currentQuestion]={...r[ee.currentQuestion],answer:e,qualityScore:s.qualityScore,englishScore:s.englishScore,feedback:s.feedback};const t=ee.currentQuestion+1,a=t>=ee.questions.length;se({...ee,questions:r,currentQuestion:t,status:a?"completed":"in_progress"}),a?await ye(r):(ce(""),ue(""),await je(r[t].question))}}catch(r){console.error("Error grading answer:",r),O({title:"Error",description:"Failed to grade answer. Please try again.",variant:"destructive"}),oe("listening")}}}else O({title:"No answer detected",description:"Please speak your answer before submitting",variant:"destructive"})},className:"flex-1",children:[n.jsx(S,{className:"h-4 w-4 mr-2"}),"Submit Answer"]}),n.jsxs(w,{variant:"outline",onClick:async()=>{if(!ee)return;if(J.current)try{J.current.stop()}catch(s){}const e=ee.currentQuestion+1;e>=ee.questions.length?(se({...ee,currentQuestion:e,status:"completed"}),await ye(ee.questions)):(se({...ee,currentQuestion:e}),ce(""),ue(""),await je(ee.questions[e].question))},children:[n.jsx(F,{className:"h-4 w-4 mr-2"}),"Skip"]})]}),"speaking"===ie&&n.jsxs(w,{variant:"outline",disabled:!0,className:"flex-1",children:[n.jsx(q,{className:"h-4 w-4 mr-2 animate-pulse"}),"AI Speaking..."]}),"grading"===ie&&n.jsxs(w,{variant:"outline",disabled:!0,className:"flex-1",children:[n.jsx(_,{className:"h-4 w-4 mr-2 animate-spin"}),"Analyzing Answer..."]}),n.jsx(w,{variant:"destructive",onClick:()=>{if(J.current)try{J.current.abort()}catch(e){}D.current&&(D.current.pause(),D.current.currentTime=0),se(null),oe("idle"),ce(""),ue("")},children:n.jsx(I,{className:"h-4 w-4"})})]})]})]}),ee.currentQuestion>0&&n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsx(m,{className:"pb-2",children:n.jsx(x,{className:"text-sm",children:"Previous Answers"})}),n.jsx(p,{children:n.jsx("div",{className:"space-y-2",children:ee.questions.slice(0,ee.currentQuestion).map((e,s)=>n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsxs("span",{className:"text-muted-foreground",children:["Q",s+1]}),void 0!==e.qualityScore&&n.jsxs("span",{className:`font-medium ${ve(e.qualityScore)}`,children:[e.qualityScore,"/10"]})]},e.id))})})]})]}),ee&&"completed"===ee.status&&n.jsxs(n.Fragment,{children:[n.jsx(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:n.jsx(p,{className:"pt-6",children:n.jsxs("div",{className:"text-center",children:[n.jsx(A,{className:"h-16 w-16 mx-auto text-yellow-500 mb-4"}),n.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Interview Complete!"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mt-6",children:[n.jsxs("div",{className:"p-6 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[n.jsx(v,{className:"h-8 w-8 mx-auto text-blue-500 mb-2"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"Answer Quality"}),n.jsxs("p",{className:`text-4xl font-bold ${ve(ee.overallQualityScore||0)}`,children:[null==(M=ee.overallQualityScore)?void 0:M.toFixed(1),"/10"]})]}),"quality_and_english"===re&&n.jsxs("div",{className:"p-6 bg-purple-50 dark:bg-purple-950 rounded-lg",children:[n.jsx(b,{className:"h-8 w-8 mx-auto text-purple-500 mb-2"}),n.jsx("p",{className:"text-sm text-muted-foreground",children:"English Proficiency"}),n.jsxs("p",{className:`text-4xl font-bold ${ve(ee.overallEnglishScore||0)}`,children:[null==(z=ee.overallEnglishScore)?void 0:z.toFixed(1),"/10"]})]})]})]})})}),ee.summaryFeedback&&n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsx(m,{children:n.jsxs(x,{className:"flex items-center gap-2",children:[n.jsx(C,{className:"h-5 w-5 text-blue-500"}),"Interview Feedback"]})}),n.jsx(p,{children:n.jsx("p",{className:"text-muted-foreground",children:ee.summaryFeedback})})]}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[ee.strengths&&ee.strengths.length>0&&n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsx(m,{className:"pb-2",children:n.jsxs(x,{className:"text-sm flex items-center gap-2 text-green-600",children:[n.jsx(S,{className:"h-4 w-4"}),"Strengths"]})}),n.jsx(p,{children:n.jsx("ul",{className:"text-sm space-y-2",children:ee.strengths.map((e,s)=>n.jsxs("li",{className:"flex items-start gap-2",children:[n.jsx(Q,{className:"h-4 w-4 text-yellow-500 flex-shrink-0 mt-0.5"}),e]},s))})})]}),ee.areasToImprove&&ee.areasToImprove.length>0&&n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsx(m,{className:"pb-2",children:n.jsxs(x,{className:"text-sm flex items-center gap-2 text-orange-600",children:[n.jsx(B,{className:"h-4 w-4"}),"Areas to Improve"]})}),n.jsx(p,{children:n.jsx("ul",{className:"text-sm space-y-2",children:ee.areasToImprove.map((e,s)=>n.jsxs("li",{className:"flex items-start gap-2",children:[n.jsx(d,{className:"h-4 w-4 text-orange-500 flex-shrink-0 mt-0.5"}),e]},s))})})]})]}),n.jsxs(u,{style:{backgroundColor:V.theme.colors.cardBackground},children:[n.jsx(m,{children:n.jsxs(x,{className:"flex items-center gap-2",children:[n.jsx(R,{className:"h-5 w-5 text-purple-500"}),"Question Results"]})}),n.jsx(p,{children:n.jsx("div",{className:"space-y-4",children:ee.questions.map((e,s)=>n.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-900 rounded-lg",children:[n.jsxs("div",{className:"flex items-start justify-between mb-2",children:[n.jsxs("div",{className:"flex-1",children:[n.jsx(k,{variant:"outline",className:"capitalize text-xs mb-1",children:e.category}),n.jsxs("p",{className:"font-medium text-sm",children:["Q",s+1,": ",e.question]})]}),void 0!==e.qualityScore&&n.jsxs("div",{className:"text-right ml-4",children:[n.jsxs("span",{className:`text-lg font-bold ${ve(e.qualityScore)}`,children:[e.qualityScore,"/10"]}),"quality_and_english"===re&&void 0!==e.englishScore&&n.jsxs("p",{className:"text-xs text-muted-foreground",children:["English: ",e.englishScore,"/10"]})]})]}),e.answer&&n.jsxs("p",{className:"text-sm text-muted-foreground mt-2 line-clamp-2",children:[n.jsx("strong",{children:"Your answer:"})," ",e.answer]}),e.feedback&&n.jsxs("p",{className:"text-sm text-blue-600 dark:text-blue-400 mt-2",children:[n.jsx("strong",{children:"Feedback:"})," ",e.feedback]})]},e.id))})})]}),n.jsxs("div",{className:"flex gap-3",children:[n.jsx(w,{variant:"outline",onClick:()=>{se(null),oe("idle")},className:"flex-1",children:"Practice Again"}),n.jsx(w,{onClick:()=>L("/business-portal"),className:"flex-1 bg-gradient-to-r from-orange-500 to-red-500",children:"Back to Portal"})]})]}),n.jsx("audio",{ref:D})]})})]})};export{T as default};
