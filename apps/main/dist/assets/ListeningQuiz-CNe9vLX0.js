import{G as e,u as s,r as t,j as r,B as a,aa as n,K as i,C as l,a as c,T as o}from"./index-x_G9xLa2.js";import{s as d}from"./supabase-DWL4C3fA.js";import{C as m}from"./CelebrationLottieAnimation-CybaN2o3.js";import{P as u}from"./PenguinClapAnimation-D-JBbbcd.js";function x(e){const s=[...e];for(let t=s.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[s[t],s[e]]=[s[e],s[t]]}return s}function h(e){if(!e)return"";let s=e.trim();return s=s.replace(/^[\-â€¢]\s*/,""),s=s.replace(/\*\*(.*?)\*\*/g,"$1"),s=s.replace(/\*(.*?)\*/g,"$1"),s=s.replace(/_(.*?)_/g,"$1"),s=s.replace(/`(.*?)`/g,"$1"),s}function p(e){return(e||"").toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim()}const f=()=>{var f,j;const{testId:g}=e(),v=s(),[w,N]=t.useState([]),[b,y]=t.useState(0),[_,C]=t.useState(null),[k,T]=t.useState(""),[q,S]=t.useState(!1),[A,L]=t.useState(0),[Y,$]=t.useState(!1),[B,P]=t.useState(!1),[z,M]=t.useState([]);t.useEffect(()=>{(async()=>{if(!g)return;const{data:e,error:s}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation,original_sentence,audio_url").eq("skill_test_id",g);s||N(x(e??[]))})()},[g]);const R=w[b],V=t.useMemo(()=>R&&"Listening_MultipleChoice"===R.question_format?x([R.correct_answer,...R.incorrect_answers||[]]):[],[R]),E=w.length?b/w.length*100:0,G=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),s=e.createOscillator(),t=e.createGain();s.type="sine",s.frequency.value=880,s.connect(t),t.connect(e.destination),t.gain.setValueAtTime(1e-4,e.currentTime),t.gain.exponentialRampToValueAtTime(.2,e.currentTime+.01),s.start(),setTimeout(()=>{s.frequency.setValueAtTime(660,e.currentTime),t.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{s.stop(),e.close()},180)},120)}catch{}},I=()=>{b+1>=w.length?$(!0):(y(e=>e+1),C(null),T(""),S(!1))};return g?r.jsx(n,{title:"Listening for Details",showBackButton:!0,backPath:"/ielts-portal",children:r.jsx("section",{className:"mx-auto px-4",children:r.jsxs("div",{className:"min-h-[70vh] flex flex-col items-center justify-center gap-4",children:[r.jsx("div",{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:r.jsxs("div",{className:"relative",children:[r.jsx("div",{className:"absolute -top-10 h-10 flex items-center justify-center -translate-x-1/2 transition-[left] duration-300 ease-out",style:{left:`${E}%`},"aria-label":"Progress mascot",title:"Keep going!",children:r.jsx("img",{src:"/lovable-uploads/27e74cd0-58d8-4b55-b31a-fdb162f21e8b.png",alt:"Listening progress turtle mascot",className:"w-12 h-12 object-contain drop-shadow animate-[turtle-legs_900ms_ease-in-out_infinite]",loading:"lazy"})}),r.jsx("style",{children:"@keyframes turtle-legs { 0% { transform: translateY(0) rotate(0deg) } 25% { transform: translateY(-1px) rotate(-2deg) } 50% { transform: translateY(0) rotate(0deg) } 75% { transform: translateY(-1px) rotate(2deg) } 100% { transform: translateY(0) rotate(0deg) } }"}),r.jsx(i,{value:E})]})}),Y?r.jsx(l,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:r.jsxs(c,{className:"p-6 space-y-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-center gap-3",children:[r.jsx("div",{className:"text-2xl font-semibold",children:"Great job!"}),r.jsx(u,{size:"sm",speed:1.1})]}),r.jsxs("div",{className:"text-center text-muted-foreground",children:["Your score: ",A," / ",w.length]})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Review"}),r.jsx("div",{className:"max-h-[50vh] overflow-auto space-y-3",children:z.map((e,s)=>r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsx("div",{className:"text-sm font-medium",children:e.question}),r.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+(e.isCorrect?"bg-soft-green":"bg-destructive/10 text-destructive"),children:e.isCorrect?"Correct":"Incorrect"})]}),!e.isCorrect&&r.jsxs("div",{className:"mt-2 text-sm space-y-1",children:[r.jsxs("div",{className:"text-muted-foreground",children:["Your answer: ",e.chosen]}),r.jsxs("div",{className:"text-muted-foreground",children:["Correct answer: ",e.correct]})]})]},e.id+String(s)))})]}),r.jsxs("div",{className:"flex gap-2 justify-center",children:[r.jsx(a,{onClick:()=>{y(0),L(0),C(null),$(!1),M([]),T(""),S(!1)},children:"Retry"}),r.jsx(a,{variant:"secondary",onClick:()=>v("/ielts-portal"),children:"Back"})]})]})}):r.jsx(r.Fragment,{children:R?r.jsx(l,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl border-light-border",children:r.jsxs(c,{className:"relative p-6 space-y-4",children:[B&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:r.jsx(m,{size:"sm",speed:1.2})}),r.jsxs("div",{className:"text-sm text-muted-foreground",children:["Question ",b+1," of ",w.length]}),r.jsx("audio",{controls:!0,className:"w-full",children:r.jsx("source",{src:(D=R,(null==D?void 0:D.audio_url)?D.audio_url.startsWith("http")?D.audio_url:`https://your-bucket.your-domain.com/${D.audio_url}`:"")})}),"Listening_Dictation"===R.question_format?r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"text-2xl font-semibold",children:R.content}),r.jsx(o,{value:k,onChange:e=>T(e.target.value),placeholder:"Type what you hear...",className:"min-h-[120px] text-base"}),q?r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsx("div",{className:"text-sm font-medium",children:(null==(f=z[z.length-1])?void 0:f.isCorrect)?"Correct!":"Incorrect"}),!(null==(j=z[z.length-1])?void 0:j.isCorrect)&&r.jsxs("div",{className:"text-sm text-muted-foreground",children:["Correct sentence: ",R.correct_answer]})]}),R.explanation&&r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:h(R.explanation)})]}),r.jsx(a,{onClick:I,children:"Continue"})]}):r.jsx(a,{onClick:()=>{if(!R)return;const e=[R.correct_answer,...R.incorrect_answers||[]].map(p),s=p(k),t=e.includes(s);S(!0),t&&(L(e=>e+1),G(),P(!0),setTimeout(()=>P(!1),1200)),M(e=>[...e,{id:R.id,question:R.content,chosen:k,correct:R.correct_answer,isCorrect:t}])},disabled:0===k.trim().length,children:"Check Answer"})]}):r.jsxs("div",{children:[r.jsx("div",{className:"text-2xl font-semibold mb-4 whitespace-pre-wrap",children:R.content}),r.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:V.map(e=>{const s=q&&e===R.correct_answer,t=q&&_===e&&e!==R.correct_answer;return r.jsx(a,{variant:s?"success":t?"destructive":"outline",className:"w-full justify-start text-left h-auto py-3 text-sm md:text-base whitespace-normal break-words",onClick:()=>(e=>{if(_||q)return;if(!R)return;C(e);const s=e===R.correct_answer;s&&(L(e=>e+1),G(),P(!0),setTimeout(()=>P(!1),1200)),S(!0),M(t=>[...t,{id:R.id,question:R.content,chosen:e,correct:R.correct_answer,isCorrect:s}])})(e),children:e},e)})}),q&&r.jsxs("div",{className:"pt-2 space-y-3",children:[R.explanation&&r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:h(R.explanation)})]}),r.jsx(a,{onClick:I,children:"Continue"})]})]})]})}):r.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading questions..."})})]})})}):r.jsx("div",{className:"min-h-screen flex items-center justify-center",children:r.jsx(a,{onClick:()=>v("/ielts-portal"),children:"Back"})});var D};export{f as default};
