import{u as e,c as s,r as t,j as i}from"./vendor-react-JN_hy__U.js";import{E as r,s as a,J as n,x as l,y as o,B as c,e as d,C as m,a as u,P as x,b as h,c as g,T as p,I as j,R as f,p as v,L as N}from"./index-DXpPY1B7.js";import{C as _}from"./checkbox-Xp4fA8WG.js";import{T as y,a as b,b as w,c as S}from"./tabs-CUO_kQ2m.js";import{aJ as C,aA as k,aK as L,aL as E,at as T,x as I,bc as M,ap as W,b2 as q,b3 as B,aw as J}from"./vendor-ui-DG51EGkO.js";import"./vendor-react-dom-Cb-iy8Oc.js";import"./vendor-animation-ClPlB6zo.js";import"./vendor-i18n-DlHrixAm.js";import"./vendor-utils-D5HPTFR9.js";import"./vendor-supabase-D7XYLCUu.js";import"./vendor-charts-BpOKEG9Z.js";import"./vendor-date-DT7Rq6D9.js";const O=[{id:"summarize_spoken_text",name:"Summarize Spoken Text",icon:W,isWriting:!0},{id:"listening_mcq_multiple",name:"MCQ Multiple",icon:T,isMultiple:!0},{id:"fill_blanks_type_in",name:"Fill in Blanks",icon:q,isTypeIn:!0},{id:"highlight_correct_summary",name:"Highlight Summary",icon:B,isSingle:!0},{id:"listening_mcq_single",name:"MCQ Single",icon:T,isSingle:!0},{id:"select_missing_word",name:"Missing Word",icon:J,isSingle:!0},{id:"highlight_incorrect_words",name:"Highlight Incorrect",icon:B,isHighlight:!0},{id:"write_from_dictation",name:"Write Dictation",icon:q,isDictation:!0}],F=()=>{const W=e(),{testId:q}=s(),{user:B}=r(),J=t.useRef(null),[F,H]=t.useState(null),[D,$]=t.useState([]),[z,P]=t.useState(!0),[Q,A]=t.useState("summarize_spoken_text"),[K,R]=t.useState(0),[V,Y]=t.useState(!1),[G,U]=t.useState(0),[X,Z]=t.useState(0),[ee,se]=t.useState(!1),[te,ie]=t.useState(600),[re,ae]=t.useState(!1),[ne,le]=t.useState(""),[oe,ce]=t.useState([]),[de,me]=t.useState(""),[ue,xe]=t.useState({}),[he,ge]=t.useState([]),[pe,je]=t.useState(""),[fe,ve]=t.useState(!1),[Ne,_e]=t.useState(!1),[ye,be]=t.useState(!1),[we,Se]=t.useState([]),Ce=D.filter(e=>e.pte_section_type===Q),ke=Ce[K],Le=O.find(e=>e.id===Q);t.useEffect(()=>{q&&(Ee(),Te())},[q]),t.useEffect(()=>{const e=J.current;if(!e)return;const s=()=>U(e.currentTime),t=()=>Z(e.duration),i=()=>{Y(!1),se(!0)};return e.addEventListener("timeupdate",s),e.addEventListener("loadedmetadata",t),e.addEventListener("ended",i),()=>{e.removeEventListener("timeupdate",s),e.removeEventListener("loadedmetadata",t),e.removeEventListener("ended",i)}},[null==F?void 0:F.audio_url]),t.useEffect(()=>{Ie(),_e(!1),se(!1),(null==Le?void 0:Le.isWriting)?ie(600):(null==Le?void 0:Le.isDictation)?ie(30):ie(60)},[Q,K]),t.useEffect(()=>{let e;return re&&te>0&&(e=setInterval(()=>{ie(e=>e<=1?(ae(!1),0):e-1)},1e3)),()=>clearInterval(e)},[re,te]);const Ee=async()=>{if(q)try{const{data:e,error:s}=await a.from("pte_listening_tests").select("*").eq("id",q).single();if(s)throw s;H(e)}catch(e){console.error("Error loading test:",e),n.error("Failed to load test")}},Te=async()=>{if(q){P(!0);try{const{data:e,error:s}=await a.from("pte_listening_items").select("*").eq("listening_test_id",q).order("question_number",{ascending:!0});if(s)throw s;if(!e||0===e.length)return n.error("No questions in this test"),void W("/pte-portal");$(e);const t=O.find(s=>e.some(e=>e.pte_section_type===s.id));t&&A(t.id)}catch(e){console.error("Error loading items:",e),n.error("Failed to load questions")}finally{P(!1)}}},Ie=()=>{le(""),ce([]),me(""),xe({}),ge([]),je("")},Me=async()=>{if(B&&ke){ve(!0);try{const e=(()=>{if(!(null==ke?void 0:ke.correct_answer))return!1;const e=ke.correct_answer.toLowerCase().split(",").map(e=>e.trim());if(null==Le?void 0:Le.isWriting)return ne.split(/\s+/).filter(e=>e).length>=50;if(null==Le?void 0:Le.isDictation)return pe.toLowerCase().trim()===ke.correct_answer.toLowerCase().trim();if(null==Le?void 0:Le.isSingle)return e.includes(de.toLowerCase());if(null==Le?void 0:Le.isMultiple){const s=oe.map(e=>e.toLowerCase()).sort();return JSON.stringify(s)===JSON.stringify(e.sort())}if(null==Le?void 0:Le.isTypeIn){const s=Object.values(ue).map(e=>e.toLowerCase().trim());return JSON.stringify(s)===JSON.stringify(e)}if(null==Le?void 0:Le.isHighlight){const s=he.map(e=>e.toLowerCase()).sort();return JSON.stringify(s)===JSON.stringify(e.sort())}return!1})();be(e);let s="";(null==Le?void 0:Le.isWriting)?s=ne:(null==Le?void 0:Le.isDictation)?s=pe:(null==Le?void 0:Le.isSingle)?s=de:(null==Le?void 0:Le.isMultiple)?s=oe.join(", "):(null==Le?void 0:Le.isTypeIn)?s=Object.values(ue).join(", "):(null==Le?void 0:Le.isHighlight)&&(s=he.join(", "));const{error:t}=await a.from("pte_user_progress").insert({user_id:B.id,pte_skill:"listening",pte_section_type:Q,listening_test_id:q,completed:!0,score:e?100:0,response_text:s});if(t)throw t;ae(!1),_e(!0),n.success(e?"Correct!":"Submitted")}catch(e){console.error("Error submitting:",e),n.error("Failed to submit")}finally{ve(!1)}}},We=()=>{if(K<Ce.length-1)R(e=>e+1);else{Se(e=>[...e,Q]);const e=O.findIndex(e=>e.id===Q),s=O.slice(e+1).find(e=>D.some(s=>s.pte_section_type===e.id)&&!we.includes(e.id));s?(A(s.id),R(0)):(n.success("You have completed all questions!"),W("/pte-portal"))}},qe=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`,Be=()=>{if(!(null==ke?void 0:ke.passage_text))return null;const e=ke.passage_text.split(/\[BLANK\]/g);return i.jsx("div",{className:"prose dark:prose-invert max-w-none",children:e.map((s,t)=>i.jsxs("span",{children:[s,t<e.length-1&&i.jsx(j,{value:ue[t]||"",onChange:e=>xe(s=>({...s,[t]:e.target.value})),className:"w-32 inline-block mx-1",placeholder:`(${t+1})`})]},t))})},Je=()=>{if(!(null==ke?void 0:ke.passage_text))return null;const e=ke.passage_text.split(/\s+/);return i.jsx("div",{className:"leading-relaxed text-lg",children:e.map((e,s)=>i.jsxs("span",{className:"cursor-pointer px-0.5 rounded transition-colors "+(he.includes(e)?"bg-yellow-300 dark:bg-yellow-600":"hover:bg-gray-100 dark:hover:bg-gray-800"),onClick:()=>(e=>{ge(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])})(e),children:[e," "]},s))})};if(z)return i.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:i.jsx(l,{})});if(!F)return i.jsx(o,{title:"PTE Listening",showBackButton:!0,children:i.jsxs("div",{className:"text-center py-12",children:[i.jsx("p",{className:"text-muted-foreground",children:"Test not found"}),i.jsx(c,{onClick:()=>W("/pte-portal"),className:"mt-4",children:"Back to PTE Portal"})]})});const Oe=((null==Le?void 0:Le.isWriting)?ne:pe).trim().split(/\s+/).filter(e=>e).length;return i.jsxs(o,{title:F.test_name,showBackButton:!0,children:[F.audio_url&&i.jsx("audio",{ref:J,src:F.audio_url,className:"hidden"}),i.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs(d,{variant:"outline",className:"text-green-600 border-green-600",children:[i.jsx(C,{className:"w-3 h-3 mr-1"}),"Listening"]}),i.jsxs(d,{variant:"secondary",children:[we.length,"/",O.filter(e=>D.some(s=>s.pte_section_type===e.id)).length," sections"]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(k,{className:"w-4 h-4 text-muted-foreground"}),i.jsx("span",{className:"font-mono text-lg "+(te<30?"text-red-500":""),children:qe(te)})]})]}),F.audio_url&&i.jsx(m,{className:"bg-green-50 dark:bg-green-950/20 border-green-200",children:i.jsx(u,{className:"pt-4",children:i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsx(c,{variant:"outline",size:"lg",onClick:()=>{J.current&&(V?J.current.pause():((null==ke?void 0:ke.audio_start_time)&&J.current&&(J.current.currentTime=ke.audio_start_time),J.current.play(),re||ae(!0)),Y(!V))},className:"w-12 h-12",children:V?i.jsx(L,{className:"w-6 h-6"}):i.jsx(E,{className:"w-6 h-6"})}),i.jsxs("div",{className:"flex-1 space-y-1",children:[i.jsx(x,{value:G/X*100,className:"h-2"}),i.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[i.jsx("span",{children:qe(G)}),i.jsx("span",{children:qe(X)})]})]})]})})}),i.jsxs(y,{value:Q,onValueChange:e=>{A(e),R(0)},children:[i.jsx(b,{className:"flex flex-wrap h-auto gap-1 bg-transparent",children:O.filter(e=>D.some(s=>s.pte_section_type===e.id)).map(e=>{const s=e.icon,t=D.filter(s=>s.pte_section_type===e.id),r=we.includes(e.id);return i.jsxs(w,{value:e.id,className:"flex items-center gap-1 text-xs border "+(r?"border-green-300 bg-green-50":"border-gray-200"),disabled:r,children:[i.jsx(s,{className:"w-3 h-3"}),i.jsx("span",{className:"hidden md:inline",children:e.name}),i.jsx(d,{variant:"secondary",className:"text-xs ml-1",children:t.length}),r&&i.jsx(T,{className:"w-3 h-3 text-green-500"})]},e.id)})}),O.map(e=>{const s=D.filter(s=>s.pte_section_type===e.id);return i.jsx(S,{value:e.id,className:"space-y-4 mt-4",children:s.length>0&&ke&&i.jsxs(m,{children:[i.jsx(h,{children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs(g,{className:"flex items-center gap-2",children:[i.jsx(e.icon,{className:"w-5 h-5"}),e.name]}),i.jsxs(d,{variant:"outline",children:[K+1," / ",s.length]})]})}),i.jsxs(u,{className:"space-y-6",children:[ke.prompt_text&&i.jsx("div",{className:"text-lg",children:ke.prompt_text}),(null==Le?void 0:Le.isWriting)&&!Ne&&i.jsxs("div",{className:"space-y-4",children:[i.jsx(p,{value:ne,onChange:e=>le(e.target.value),placeholder:"Write your summary here (50-70 words)...",rows:8,disabled:!ee}),i.jsxs("p",{className:"text-sm "+(Oe<50?"text-yellow-500":Oe>70?"text-red-500":"text-green-500"),children:["Words: ",Oe," / 50-70"]})]}),(null==Le?void 0:Le.isDictation)&&!Ne&&i.jsx("div",{className:"space-y-4",children:i.jsx(j,{value:pe,onChange:e=>je(e.target.value),placeholder:"Type exactly what you hear...",disabled:!ee,className:"text-lg"})}),(null==Le?void 0:Le.isSingle)&&ke.options&&!Ne&&i.jsx(f,{value:de,onValueChange:me,children:i.jsx("div",{className:"space-y-3",children:ke.options.map((e,s)=>i.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border hover:bg-gray-50",children:[i.jsx(v,{value:String.fromCharCode(65+s),id:`opt-${s}`}),i.jsxs(N,{htmlFor:`opt-${s}`,className:"flex-1 cursor-pointer",children:[i.jsxs("span",{className:"font-medium mr-2",children:[String.fromCharCode(65+s),"."]}),e]})]},s))})}),(null==Le?void 0:Le.isMultiple)&&ke.options&&!Ne&&i.jsx("div",{className:"space-y-3",children:ke.options.map((e,s)=>{const t=String.fromCharCode(65+s);return i.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border cursor-pointer "+(oe.includes(t)?"bg-green-50 border-green-300":"hover:bg-gray-50"),onClick:()=>(e=>{ce(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])})(t),children:[i.jsx(_,{checked:oe.includes(t)}),i.jsxs(N,{className:"flex-1 cursor-pointer",children:[i.jsxs("span",{className:"font-medium mr-2",children:[t,"."]}),e]})]},s)})}),(null==Le?void 0:Le.isTypeIn)&&ke.passage_text&&!Ne&&i.jsx(m,{className:"bg-gray-50",children:i.jsx(u,{className:"pt-4",children:Be()})}),(null==Le?void 0:Le.isHighlight)&&ke.passage_text&&!Ne&&i.jsxs("div",{className:"space-y-2",children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Click on words that differ from what you hear:"}),i.jsx(m,{className:"bg-gray-50",children:i.jsx(u,{className:"pt-4",children:Je()})})]}),!Ne&&i.jsx("div",{className:"flex justify-end",children:i.jsxs(c,{onClick:Me,disabled:fe||!ee&&!(null==Le?void 0:Le.isHighlight),className:"bg-green-600 hover:bg-green-700",children:[i.jsx(I,{className:"w-4 h-4 mr-2"}),fe?"Submitting...":"Submit"]})}),Ne&&i.jsxs("div",{className:"space-y-4",children:[i.jsxs(m,{className:""+(ye?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"),children:[i.jsx(h,{children:i.jsx(g,{className:"flex items-center gap-2 "+(ye?"text-green-700":"text-amber-700"),children:ye?i.jsxs(i.Fragment,{children:[i.jsx(T,{className:"w-5 h-5"})," Correct!"]}):i.jsxs(i.Fragment,{children:[i.jsx(T,{className:"w-5 h-5"})," Submitted"]})})}),i.jsxs(u,{className:"space-y-2",children:[ke.correct_answer&&i.jsxs("p",{children:[i.jsx("span",{className:"font-medium",children:"Correct answer: "}),ke.correct_answer]}),ke.explanation&&i.jsx("p",{className:"text-sm text-muted-foreground",children:ke.explanation})]})]}),i.jsx("div",{className:"flex justify-end",children:i.jsxs(c,{onClick:We,className:"bg-green-600 hover:bg-green-700",children:[i.jsx(M,{className:"w-4 h-4 mr-2"}),"Next Question"]})})]})]})]})},e.id)})]})]})]})};export{F as default};
