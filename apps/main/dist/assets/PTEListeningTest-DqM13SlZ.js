import{u as e,G as s,ae as t,r as i,J as r,j as a,a9 as n,aa as l,B as o,l as c,H as d,W as m,C as u,a as x,Y as h,Z as g,K as p,L as j,b as f,d as v,T as N,I as _,_ as y,$ as b,R as w,a0 as S,F as C,V as k}from"./index-C7_FyMei.js";import{C as L}from"./checkbox-H3ngDK4R.js";import{T as E,a as T,b as W,c as I}from"./tabs-DwyCwmFY.js";import{s as M}from"./supabase-DWL4C3fA.js";import{S as F}from"./skip-forward-Di7lbhHH.js";import{T as H,H as q}from"./type-D7hJxx8k.js";const B=[{id:"summarize_spoken_text",name:"Summarize Spoken Text",icon:C,isWriting:!0},{id:"listening_mcq_multiple",name:"MCQ Multiple",icon:j,isMultiple:!0},{id:"fill_blanks_type_in",name:"Fill in Blanks",icon:H,isTypeIn:!0},{id:"highlight_correct_summary",name:"Highlight Summary",icon:q,isSingle:!0},{id:"listening_mcq_single",name:"MCQ Single",icon:j,isSingle:!0},{id:"select_missing_word",name:"Missing Word",icon:k,isSingle:!0},{id:"highlight_incorrect_words",name:"Highlight Incorrect",icon:q,isHighlight:!0},{id:"write_from_dictation",name:"Write Dictation",icon:H,isDictation:!0}],O=()=>{const C=e(),{testId:k}=s(),{user:H}=t(),q=i.useRef(null),[O,J]=i.useState(null),[D,$]=i.useState([]),[z,P]=i.useState(!0),[Q,V]=i.useState("summarize_spoken_text"),[G,K]=i.useState(0),[R,Y]=i.useState(!1),[A,Z]=i.useState(0),[U,X]=i.useState(0),[ee,se]=i.useState(!1),[te,ie]=i.useState(600),[re,ae]=i.useState(!1),[ne,le]=i.useState(""),[oe,ce]=i.useState([]),[de,me]=i.useState(""),[ue,xe]=i.useState({}),[he,ge]=i.useState([]),[pe,je]=i.useState(""),[fe,ve]=i.useState(!1),[Ne,_e]=i.useState(!1),[ye,be]=i.useState(!1),[we,Se]=i.useState([]),Ce=D.filter(e=>e.pte_section_type===Q),ke=Ce[G],Le=B.find(e=>e.id===Q);i.useEffect(()=>{k&&(Ee(),Te())},[k]),i.useEffect(()=>{const e=q.current;if(!e)return;const s=()=>Z(e.currentTime),t=()=>X(e.duration),i=()=>{Y(!1),se(!0)};return e.addEventListener("timeupdate",s),e.addEventListener("loadedmetadata",t),e.addEventListener("ended",i),()=>{e.removeEventListener("timeupdate",s),e.removeEventListener("loadedmetadata",t),e.removeEventListener("ended",i)}},[null==O?void 0:O.audio_url]),i.useEffect(()=>{We(),_e(!1),se(!1),(null==Le?void 0:Le.isWriting)?ie(600):(null==Le?void 0:Le.isDictation)?ie(30):ie(60)},[Q,G]),i.useEffect(()=>{let e;return re&&te>0&&(e=setInterval(()=>{ie(e=>e<=1?(ae(!1),0):e-1)},1e3)),()=>clearInterval(e)},[re,te]);const Ee=async()=>{if(k)try{const{data:e,error:s}=await M.from("pte_listening_tests").select("*").eq("id",k).single();if(s)throw s;J(e)}catch(e){console.error("Error loading test:",e),r.error("Failed to load test")}},Te=async()=>{if(k){P(!0);try{const{data:e,error:s}=await M.from("pte_listening_items").select("*").eq("listening_test_id",k).order("question_number",{ascending:!0});if(s)throw s;if(!e||0===e.length)return r.error("No questions in this test"),void C("/pte-portal");$(e);const t=B.find(s=>e.some(e=>e.pte_section_type===s.id));t&&V(t.id)}catch(e){console.error("Error loading items:",e),r.error("Failed to load questions")}finally{P(!1)}}},We=()=>{le(""),ce([]),me(""),xe({}),ge([]),je("")},Ie=async()=>{if(H&&ke){ve(!0);try{const e=(()=>{if(!(null==ke?void 0:ke.correct_answer))return!1;const e=ke.correct_answer.toLowerCase().split(",").map(e=>e.trim());if(null==Le?void 0:Le.isWriting)return ne.split(/\s+/).filter(e=>e).length>=50;if(null==Le?void 0:Le.isDictation)return pe.toLowerCase().trim()===ke.correct_answer.toLowerCase().trim();if(null==Le?void 0:Le.isSingle)return e.includes(de.toLowerCase());if(null==Le?void 0:Le.isMultiple){const s=oe.map(e=>e.toLowerCase()).sort();return JSON.stringify(s)===JSON.stringify(e.sort())}if(null==Le?void 0:Le.isTypeIn){const s=Object.values(ue).map(e=>e.toLowerCase().trim());return JSON.stringify(s)===JSON.stringify(e)}if(null==Le?void 0:Le.isHighlight){const s=he.map(e=>e.toLowerCase()).sort();return JSON.stringify(s)===JSON.stringify(e.sort())}return!1})();be(e);let s="";(null==Le?void 0:Le.isWriting)?s=ne:(null==Le?void 0:Le.isDictation)?s=pe:(null==Le?void 0:Le.isSingle)?s=de:(null==Le?void 0:Le.isMultiple)?s=oe.join(", "):(null==Le?void 0:Le.isTypeIn)?s=Object.values(ue).join(", "):(null==Le?void 0:Le.isHighlight)&&(s=he.join(", "));const{error:t}=await M.from("pte_user_progress").insert({user_id:H.id,pte_skill:"listening",pte_section_type:Q,listening_test_id:k,completed:!0,score:e?100:0,response_text:s});if(t)throw t;ae(!1),_e(!0),r.success(e?"Correct!":"Submitted")}catch(e){console.error("Error submitting:",e),r.error("Failed to submit")}finally{ve(!1)}}},Me=()=>{if(G<Ce.length-1)K(e=>e+1);else{Se(e=>[...e,Q]);const e=B.findIndex(e=>e.id===Q),s=B.slice(e+1).find(e=>D.some(s=>s.pte_section_type===e.id)&&!we.includes(e.id));s?(V(s.id),K(0)):(r.success("You have completed all questions!"),C("/pte-portal"))}},Fe=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`,He=()=>{if(!(null==ke?void 0:ke.passage_text))return null;const e=ke.passage_text.split(/\[BLANK\]/g);return a.jsx("div",{className:"prose dark:prose-invert max-w-none",children:e.map((s,t)=>a.jsxs("span",{children:[s,t<e.length-1&&a.jsx(_,{value:ue[t]||"",onChange:e=>xe(s=>({...s,[t]:e.target.value})),className:"w-32 inline-block mx-1",placeholder:`(${t+1})`})]},t))})},qe=()=>{if(!(null==ke?void 0:ke.passage_text))return null;const e=ke.passage_text.split(/\s+/);return a.jsx("div",{className:"leading-relaxed text-lg",children:e.map((e,s)=>a.jsxs("span",{className:"cursor-pointer px-0.5 rounded transition-colors "+(he.includes(e)?"bg-yellow-300 dark:bg-yellow-600":"hover:bg-gray-100 dark:hover:bg-gray-800"),onClick:()=>(e=>{ge(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])})(e),children:[e," "]},s))})};if(z)return a.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:a.jsx(n,{})});if(!O)return a.jsx(l,{title:"PTE Listening",showBackButton:!0,children:a.jsxs("div",{className:"text-center py-12",children:[a.jsx("p",{className:"text-muted-foreground",children:"Test not found"}),a.jsx(o,{onClick:()=>C("/pte-portal"),className:"mt-4",children:"Back to PTE Portal"})]})});const Be=((null==Le?void 0:Le.isWriting)?ne:pe).trim().split(/\s+/).filter(e=>e).length;return a.jsxs(l,{title:O.test_name,showBackButton:!0,children:[O.audio_url&&a.jsx("audio",{ref:q,src:O.audio_url,className:"hidden"}),a.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs(c,{variant:"outline",className:"text-green-600 border-green-600",children:[a.jsx(d,{className:"w-3 h-3 mr-1"}),"Listening"]}),a.jsxs(c,{variant:"secondary",children:[we.length,"/",B.filter(e=>D.some(s=>s.pte_section_type===e.id)).length," sections"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(m,{className:"w-4 h-4 text-muted-foreground"}),a.jsx("span",{className:"font-mono text-lg "+(te<30?"text-red-500":""),children:Fe(te)})]})]}),O.audio_url&&a.jsx(u,{className:"bg-green-50 dark:bg-green-950/20 border-green-200",children:a.jsx(x,{className:"pt-4",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx(o,{variant:"outline",size:"lg",onClick:()=>{q.current&&(R?q.current.pause():((null==ke?void 0:ke.audio_start_time)&&q.current&&(q.current.currentTime=ke.audio_start_time),q.current.play(),re||ae(!0)),Y(!R))},className:"w-12 h-12",children:R?a.jsx(h,{className:"w-6 h-6"}):a.jsx(g,{className:"w-6 h-6"})}),a.jsxs("div",{className:"flex-1 space-y-1",children:[a.jsx(p,{value:A/U*100,className:"h-2"}),a.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[a.jsx("span",{children:Fe(A)}),a.jsx("span",{children:Fe(U)})]})]})]})})}),a.jsxs(E,{value:Q,onValueChange:e=>{V(e),K(0)},children:[a.jsx(T,{className:"flex flex-wrap h-auto gap-1 bg-transparent",children:B.filter(e=>D.some(s=>s.pte_section_type===e.id)).map(e=>{const s=e.icon,t=D.filter(s=>s.pte_section_type===e.id),i=we.includes(e.id);return a.jsxs(W,{value:e.id,className:"flex items-center gap-1 text-xs border "+(i?"border-green-300 bg-green-50":"border-gray-200"),disabled:i,children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{className:"hidden md:inline",children:e.name}),a.jsx(c,{variant:"secondary",className:"text-xs ml-1",children:t.length}),i&&a.jsx(j,{className:"w-3 h-3 text-green-500"})]},e.id)})}),B.map(e=>{const s=D.filter(s=>s.pte_section_type===e.id);return a.jsx(I,{value:e.id,className:"space-y-4 mt-4",children:s.length>0&&ke&&a.jsxs(u,{children:[a.jsx(f,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(v,{className:"flex items-center gap-2",children:[a.jsx(e.icon,{className:"w-5 h-5"}),e.name]}),a.jsxs(c,{variant:"outline",children:[G+1," / ",s.length]})]})}),a.jsxs(x,{className:"space-y-6",children:[ke.prompt_text&&a.jsx("div",{className:"text-lg",children:ke.prompt_text}),(null==Le?void 0:Le.isWriting)&&!Ne&&a.jsxs("div",{className:"space-y-4",children:[a.jsx(N,{value:ne,onChange:e=>le(e.target.value),placeholder:"Write your summary here (50-70 words)...",rows:8,disabled:!ee}),a.jsxs("p",{className:"text-sm "+(Be<50?"text-yellow-500":Be>70?"text-red-500":"text-green-500"),children:["Words: ",Be," / 50-70"]})]}),(null==Le?void 0:Le.isDictation)&&!Ne&&a.jsx("div",{className:"space-y-4",children:a.jsx(_,{value:pe,onChange:e=>je(e.target.value),placeholder:"Type exactly what you hear...",disabled:!ee,className:"text-lg"})}),(null==Le?void 0:Le.isSingle)&&ke.options&&!Ne&&a.jsx(y,{value:de,onValueChange:me,children:a.jsx("div",{className:"space-y-3",children:ke.options.map((e,s)=>a.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border hover:bg-gray-50",children:[a.jsx(b,{value:String.fromCharCode(65+s),id:`opt-${s}`}),a.jsxs(w,{htmlFor:`opt-${s}`,className:"flex-1 cursor-pointer",children:[a.jsxs("span",{className:"font-medium mr-2",children:[String.fromCharCode(65+s),"."]}),e]})]},s))})}),(null==Le?void 0:Le.isMultiple)&&ke.options&&!Ne&&a.jsx("div",{className:"space-y-3",children:ke.options.map((e,s)=>{const t=String.fromCharCode(65+s);return a.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border cursor-pointer "+(oe.includes(t)?"bg-green-50 border-green-300":"hover:bg-gray-50"),onClick:()=>(e=>{ce(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])})(t),children:[a.jsx(L,{checked:oe.includes(t)}),a.jsxs(w,{className:"flex-1 cursor-pointer",children:[a.jsxs("span",{className:"font-medium mr-2",children:[t,"."]}),e]})]},s)})}),(null==Le?void 0:Le.isTypeIn)&&ke.passage_text&&!Ne&&a.jsx(u,{className:"bg-gray-50",children:a.jsx(x,{className:"pt-4",children:He()})}),(null==Le?void 0:Le.isHighlight)&&ke.passage_text&&!Ne&&a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:"Click on words that differ from what you hear:"}),a.jsx(u,{className:"bg-gray-50",children:a.jsx(x,{className:"pt-4",children:qe()})})]}),!Ne&&a.jsx("div",{className:"flex justify-end",children:a.jsxs(o,{onClick:Ie,disabled:fe||!ee&&!(null==Le?void 0:Le.isHighlight),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(S,{className:"w-4 h-4 mr-2"}),fe?"Submitting...":"Submit"]})}),Ne&&a.jsxs("div",{className:"space-y-4",children:[a.jsxs(u,{className:""+(ye?"bg-green-50 border-green-200":"bg-amber-50 border-amber-200"),children:[a.jsx(f,{children:a.jsx(v,{className:"flex items-center gap-2 "+(ye?"text-green-700":"text-amber-700"),children:ye?a.jsxs(a.Fragment,{children:[a.jsx(j,{className:"w-5 h-5"})," Correct!"]}):a.jsxs(a.Fragment,{children:[a.jsx(j,{className:"w-5 h-5"})," Submitted"]})})}),a.jsxs(x,{className:"space-y-2",children:[ke.correct_answer&&a.jsxs("p",{children:[a.jsx("span",{className:"font-medium",children:"Correct answer: "}),ke.correct_answer]}),ke.explanation&&a.jsx("p",{className:"text-sm text-muted-foreground",children:ke.explanation})]})]}),a.jsx("div",{className:"flex justify-end",children:a.jsxs(o,{onClick:Me,className:"bg-green-600 hover:bg-green-700",children:[a.jsx(F,{className:"w-4 h-4 mr-2"}),"Next Question"]})})]})]})]})},e.id)})]})]})]})};export{O as default};
