import{r as e,a5 as t,u as s,j as a,cb as l,cc as n}from"./index-CgS2SMUD.js";import{s as r}from"./supabase-DWL4C3fA.js";import{f as i,S as d,L as c}from"./taskBank-C_v_y-ZR.js";const o=()=>{var i,d,c,o;const[x,u]=e.useState(null),[h,p]=e.useState(null),[g,b]=e.useState(null),[j,v]=e.useState([]),[f,N]=e.useState(new Set),[y,w]=e.useState(""),[k,S]=e.useState(20),[C,D]=e.useState(new Set),[$,A]=e.useState(""),[I,T]=e.useState(!0),[M,O]=e.useState(""),[E,J]=e.useState(!1),L=t(),_=s();if(e.useEffect(()=>{(async()=>{var e;const t=null==(e=null==L?void 0:L.state)?void 0:e.plan;if(t)return void u(t);try{const e=localStorage.getItem("latest_plan");if(e){const t=JSON.parse(e);if(null==t?void 0:t.plan)return void u(t.plan);if(t&&"object"==typeof t)return void u(t)}}catch{}const{data:{user:s}}=await r.auth.getUser();if(!s)return;const{data:a}=await r.from("profiles").select("*, current_plan_id").eq("id",s.id).single();if(!(null==a?void 0:a.current_plan_id))return;const{data:l}=await r.from("study_plans").select("*").eq("id",a.current_plan_id).single();(null==l?void 0:l.plan)&&u(l.plan)})()},[null==L?void 0:L.state]),!x)return a.jsx("div",{className:"max-w-3xl mx-auto p-6",children:"No plan yet."});const F=e=>{var t;if(!e)return null;const[s,a]=e.split("-").map(Number);return(null==(t=x.weekly.find(e=>e.week===s))?void 0:t.days.find(e=>e.day===a))||null},P=e=>"number"==typeof e&&isFinite(e)?e.toFixed(1):"-",R=(()=>{var e;const t=(null==(e=x.meta)?void 0:e.startDateISO)?new Date(x.meta.startDateISO):new Date;return new Date(t.getFullYear(),t.getMonth(),t.getDate())})(),Y=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,q=(()=>{const e=[];return x.weekly.forEach((t,s)=>{t.days.forEach((a,l)=>{const n=new Date(R);n.setDate(R.getDate()+7*s+l),e.push({date:n,week:t.week,day:a.day,tasks:a.tasks})})}),e})(),G=(()=>{const e=new Map;return q.forEach(t=>{const s=`${t.date.getFullYear()}-${String(t.date.getMonth()+1).padStart(2,"0")}`;e.has(s)||e.set(s,[]),e.get(s).push(t)}),Array.from(e.entries()).sort((e,t)=>e[0].localeCompare(t[0]))})(),W=(e,t)=>{try{localStorage.setItem(`plan-custom-tasks-${e}`,JSON.stringify(t))}catch{}},B=(e,t)=>{try{localStorage.setItem(`plan-completed-${e}`,JSON.stringify(Array.from(t)))}catch{}},z=(e,t)=>{try{localStorage.setItem(`plan-hidden-ai-${e}`,JSON.stringify(Array.from(t)))}catch{}},U=(e,t)=>{try{localStorage.setItem(`plan-notes-${e}`,t)}catch{}},V=(e,t)=>{const s=q.find(s=>s.week===e&&s.day===t),a=s?Y(s.date):null;b(a),a&&(e=>{try{const t=JSON.parse(localStorage.getItem(`plan-custom-tasks-${e}`)||"[]"),s=JSON.parse(localStorage.getItem(`plan-completed-${e}`)||"[]"),a=JSON.parse(localStorage.getItem(`plan-hidden-ai-${e}`)||"[]"),l=localStorage.getItem(`plan-notes-${e}`)||"";v(Array.isArray(t)?t:[]),N(new Set(Array.isArray(s)?s:[])),D(new Set(Array.isArray(a)?a:[])),A(l)}catch{v([]),N(new Set),D(new Set),A("")}})(a),p(`${e}-${t}`)},K=e=>{const t=new Set(f);t.has(e)?t.delete(e):t.add(e),N(t),g&&B(g,t)},H=(e,t)=>{if(!g)return;const s=j.slice(),a=e+t;if(a<0||a>=s.length)return;const[l]=s.splice(e,1);s.splice(a,0,l),v(s),W(g,s)},Q=()=>{if(!window.confirm("Reset all local study plan data (completions, custom tasks, notes)?"))return;const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s&&((s.startsWith("plan-")||s.startsWith("quicktodo-"))&&e.push(s))}e.forEach(e=>{try{localStorage.removeItem(e)}catch{}}),N(new Set),v([]),D(new Set),A("")};return a.jsx("div",{className:"max-w-5xl mx-auto p-6 lg:p-10",children:a.jsxs("div",{className:"bg-white/70 backdrop-blur-xl border border-white/30 rounded-2xl shadow-sm p-6 lg:p-8",children:[a.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl lg:text-3xl font-semibold text-slate-900",children:"Your Personalized IELTS Study Plan"}),a.jsx("p",{className:"text-slate-600 mt-1",children:"Designed from your quick assessment"})]}),x.meta&&a.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3",children:[a.jsxs("div",{className:"rounded-xl border border-white/40 bg-white/60 px-4 py-3 text-center",children:[a.jsx("div",{className:"text-xs text-slate-500",children:"Current Level"}),a.jsx("div",{className:"text-lg font-semibold text-slate-900",children:x.meta.currentLevel})]}),a.jsxs("div",{className:"rounded-xl border border-white/40 bg-white/60 px-4 py-3 text-center",children:[a.jsx("div",{className:"text-xs text-slate-500",children:"Now (IELTS)"}),a.jsx("div",{className:"text-lg font-semibold text-slate-900",children:P(x.meta.currentApproxIELTS)})]}),a.jsxs("div",{className:"rounded-xl border border-white/40 bg-white/60 px-4 py-3 text-center",children:[a.jsx("div",{className:"text-xs text-slate-500",children:"Target"}),a.jsx("div",{className:"text-lg font-semibold text-slate-900",children:P(null==(i=x.meta)?void 0:i.targetIELTS)})]}),a.jsxs("div",{className:"rounded-xl border border-white/40 bg-white/60 px-4 py-3 text-center",children:[a.jsx("div",{className:"text-xs text-slate-500",children:"ETA"}),a.jsxs("div",{className:"text-lg font-semibold text-slate-900",children:["~",null==(d=x.meta)?void 0:d.estimatedMonths," mo"]})]})]})]}),a.jsxs("div",{className:"rounded-xl border border-slate-200 bg-white/70 p-4 mb-6",children:[a.jsx("div",{className:"text-sm font-medium text-slate-800 mb-2",children:"Generate tasks from your focus (write in any language)"}),a.jsx("textarea",{value:M,onChange:e=>O(e.target.value),className:"w-full rounded-md border px-3 py-2 min-h-[80px]",placeholder:"예: 그래프 비교 쓰기(Task 1)와 cohesion 연결어 연습"}),a.jsx("div",{className:"mt-2",children:a.jsx("button",{onClick:async()=>{var e,t,s,a;if(M.trim()){J(!0);try{const i=(null==(e=null==x?void 0:x.meta)?void 0:e.dailyMinutes)||45,d=(null==(t=null==x?void 0:x.meta)?void 0:t.firstLanguage)||"en",c=(null==(s=null==x?void 0:x.meta)?void 0:s.currentLevel)||"B1",{data:o,error:m}=await r.functions.invoke("plan-focus-to-todos",{body:{focusText:M,minutesPerDay:i,days:7,firstLanguage:d,level:c}});if(m||!(null==o?void 0:o.success))throw m||new Error((null==o?void 0:o.error)||"Failed to generate");const u=l(new Date),h=n(u),p=JSON.parse(localStorage.getItem(`plan-custom-tasks-${h}`)||"[]"),g=Array.isArray(o.days)&&o.days.length>0&&(null==(a=o.days[0])?void 0:a.tasks)||[],b=Array.isArray(p)?[...p,...g]:g;localStorage.setItem(`plan-custom-tasks-${h}`,JSON.stringify(b)),O(""),alert("A to‑do pack has been generated for tomorrow. You can move/edit them in the day view.")}catch(i){alert("Could not generate tasks: "+(i.message||i))}finally{J(!1)}}},disabled:E||!M.trim(),className:"px-4 py-2 rounded-md bg-black text-white disabled:opacity-50",children:E?"Generating…":"Generate To‑dos"})})]}),a.jsxs("div",{className:"flex gap-3 mb-6",children:[a.jsx("button",{onClick:()=>_("/dashboard"),className:"px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-slate-800 transition-colors",children:"Go to Dashboard"}),a.jsx("button",{onClick:()=>_("/onboarding/assessment"),className:"px-4 py-2 rounded-lg bg-black text-white hover:bg-black/90 transition-colors",children:"New Assessment"})]}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("div",{className:"text-sm text-slate-600",children:"View mode"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("label",{className:"text-sm text-slate-700",children:"Todo list focus"}),a.jsx("input",{type:"checkbox",checked:I,onChange:e=>T(e.target.checked)})]})]}),(()=>{const e=new Date,t=q.find(t=>t.date.toDateString()===e.toDateString());return t&&0!==t.tasks.length?a.jsxs("div",{className:"rounded-2xl border border-blue-200 bg-blue-50 p-6 mb-8",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-semibold text-blue-900",children:"Today's Study Tasks"}),a.jsx("button",{onClick:()=>V(t.week,t.day),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"View Details"})]}),a.jsxs("div",{className:"grid gap-3",children:[t.tasks.map((e,t)=>a.jsxs("label",{className:"flex items-center justify-between bg-white rounded-lg p-3 border border-blue-100",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("input",{type:"checkbox"}),a.jsx("span",{className:"font-medium text-slate-800",children:e.title})]}),a.jsxs("span",{className:"text-sm text-blue-600 bg-blue-100 px-2 py-1 rounded",children:[e.minutes," min"]})]},t)),a.jsxs("div",{className:"text-sm text-blue-700 mt-2",children:["Total: ",t.tasks.reduce((e,t)=>e+t.minutes,0)," minutes"]})]})]}):null})(),a.jsx("div",{className:"space-y-8",children:G.map(([e,t])=>{var s,l,n;const r=Number(e.split("-")[0]),i=Number(e.split("-")[1])-1,d=new Date(r,i,1),c=new Date(r,i+1,0).getDate(),o=d.getDay(),m=[];for(let a=0;a<o;a++)m.push(null);for(let a=1;a<=c;a++){const e=t.find(e=>e.date.getDate()===a)||null;e?m.push(e):m.push(null)}const u=d.toLocaleString(void 0,{month:"long",year:"numeric"});return a.jsxs("div",{className:"rounded-2xl border border-white/40 bg-white/60 p-5",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:u}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{className:"text-xs underline",onClick:Q,children:"Reset all"}),a.jsxs("div",{className:"text-xs text-slate-500",children:["Daily ~",(null==(s=x.meta)?void 0:s.dailyMinutes)||0===(null==(l=x.meta)?void 0:l.dailyMinutes)?null==(n=x.meta)?void 0:n.dailyMinutes:60," min"]})]})]}),a.jsxs("div",{className:"grid grid-cols-7 gap-2 text-xs text-slate-500 mb-1",children:[a.jsx("div",{children:"Sun"}),a.jsx("div",{children:"Mon"}),a.jsx("div",{children:"Tue"}),a.jsx("div",{children:"Wed"}),a.jsx("div",{children:"Thu"}),a.jsx("div",{children:"Fri"}),a.jsx("div",{children:"Sat"})]}),a.jsx("div",{className:"grid grid-cols-7 gap-2 rounded-2xl p-2 bg-white/50 border border-white/40",children:m.map((e,t)=>{if(!e)return a.jsx("div",{className:"h-24 rounded-xl bg-transparent"},t);const s=Y(e.date),l=`plan-date-complete-${s}`,n="undefined"!=typeof window&&"1"===localStorage.getItem(l),r=(new Date).toDateString()===e.date.toDateString(),i=h===`${e.week}-${e.day}`,d=e.tasks.reduce((e,t)=>e+t.minutes,0);return a.jsxs("button",{className:`h-24 rounded-2xl border p-2 text-left shadow-sm transition-all duration-200 ${e.tasks.length?i?"bg-blue-100 border-blue-300 ring-2 ring-blue-200":n?"bg-green-100 border-green-300 hover:bg-green-200":"bg-white/80 border-white/60 hover:bg-white hover:border-blue-200":"bg-white/40 border-white/40 hover:bg-white/60"} ${r?"ring-2 ring-orange-200":""}`,onClick:()=>V(e.week,e.day),children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm font-medium "+(r?"text-orange-600":"text-slate-900"),children:e.date.getDate()}),r&&a.jsx("span",{className:"text-xs text-orange-500",children:"Today"})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[e.tasks.length>0&&a.jsxs("span",{className:"text-xs text-slate-500 bg-slate-100 px-1 rounded",children:[d,"m"]}),a.jsx("input",{type:"checkbox","aria-label":`Mark ${s} complete`,onChange:e=>{e.target.checked?localStorage.setItem(l,"1"):localStorage.removeItem(l)},defaultChecked:n,onClick:e=>e.stopPropagation(),className:"w-3 h-3"})]})]}),a.jsxs("ul",{className:"space-y-1 text-slate-700 text-xs",children:[e.tasks.slice(0,2).map((e,t)=>a.jsxs("li",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"truncate max-w-[120px]",children:e.title}),!I&&a.jsxs("span",{className:"text-[10px] text-slate-500",children:[e.minutes,"m"]})]},t)),e.tasks.length>2&&a.jsxs("li",{className:"text-[10px] text-slate-500",children:["+",e.tasks.length-2," more"]}),0===e.tasks.length&&a.jsx("li",{className:"text-[10px] text-slate-400 italic",children:"No tasks"})]})]},s)})})]},e)})}),h&&g&&a.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:()=>{p(null),b(null)},children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-[90%] max-w-xl p-6",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("h3",{className:"text-lg font-semibold text-slate-900",children:[g," • ",h.replace("-"," • Day ")]}),a.jsx("button",{className:"text-slate-500 hover:text-slate-700",onClick:()=>{p(null),b(null)},children:"Close"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h4",{className:"text-sm font-semibold text-slate-800 mb-2",children:"AI Tasks"}),a.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[a.jsx("button",{className:"rounded-md border px-2 py-1",onClick:()=>{var e;if(!g)return;const t=new Date(g);t.setDate(t.getDate()+1);const s=Y(t),a=((null==(e=F(h))?void 0:e.tasks)||[]).map(e=>({title:e.title,minutes:e.minutes})),l=JSON.parse(localStorage.getItem(`plan-custom-tasks-${s}`)||"[]"),n=Array.isArray(l)?[...l,...j,...a]:[...j,...a];try{localStorage.setItem(`plan-custom-tasks-${s}`,JSON.stringify(n))}catch{}},children:"Duplicate to tomorrow"}),a.jsx("button",{className:"rounded-md border px-2 py-1",onClick:()=>{var e;const t=((null==(e=F(h))?void 0:e.tasks)||[]).length,s=new Set;for(let a=0;a<t;a++)s.add(`ai-${a}`);D(s),g&&z(g,s)},children:"Remove all AI tasks"}),a.jsx("button",{className:"rounded-md border px-2 py-1",onClick:()=>{const e=new Set;D(e),g&&z(g,e)},children:"Restore AI tasks"}),a.jsx("button",{className:"rounded-md border px-2 py-1",onClick:()=>{g&&(v([]),N(new Set),A(""),W(g,[]),B(g,new Set),U(g,""))},children:"Reset day"})]})]}),a.jsx("ul",{className:"space-y-2 text-slate-800",children:((null==(c=F(h))?void 0:c.tasks)||[]).map((e,t)=>{const s=`ai-${t}`;return C.has(s)?null:a.jsxs("li",{className:"flex items-center justify-between rounded-lg border p-3",children:[a.jsxs("label",{className:"flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",checked:f.has(s),onChange:()=>K(s)}),a.jsx("span",{children:e.title})]}),a.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-500",children:[a.jsxs("span",{children:[e.minutes," min"]}),a.jsx("button",{className:"text-red-500",onClick:()=>(e=>{const t=`ai-${e}`,s=new Set(C);s.add(t),D(s),g&&z(g,s)})(t),children:"Remove"})]})]},s)})}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-semibold text-slate-800 mb-2",children:"Your Tasks"}),a.jsxs("div",{className:"flex gap-2 mb-2",children:[a.jsx("input",{value:y,onChange:e=>w(e.target.value),placeholder:"Add a task (e.g., Writing Task 2 intro)",className:"flex-1 rounded-md border px-3 py-2"}),a.jsx("input",{type:"number",value:k,onChange:e=>S(Number(e.target.value)),className:"w-24 rounded-md border px-3 py-2"}),a.jsx("button",{className:"rounded-md bg-black text-white px-3 py-2",onClick:()=>{if(!g||!y.trim())return;const e={title:y.trim(),minutes:Math.max(5,Math.min(180,Number(k)||20))},t=[...j,e];v(t),W(g,t),w(""),S(20)},children:"Add"})]}),a.jsxs("details",{className:"mb-2",children:[a.jsx("summary",{className:"cursor-pointer text-sm text-slate-700",children:"Add from Task Bank"}),a.jsx(m,{onPick:e=>{w(e.label),S(e.minutes)}})]}),a.jsxs("ul",{className:"space-y-2",children:[j.map((e,t)=>{const s=`custom-${t}`;return a.jsxs("li",{className:"flex items-center justify-between rounded-lg border p-3",children:[a.jsxs("label",{className:"flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",checked:f.has(s),onChange:()=>K(s)}),a.jsx("span",{children:e.title})]}),a.jsxs("div",{className:"flex items-center gap-3 text-xs text-slate-500",children:[a.jsxs("span",{children:[e.minutes," min"]}),a.jsx("button",{className:"border rounded px-2 py-1",onClick:()=>H(t,-1),children:"Up"}),a.jsx("button",{className:"border rounded px-2 py-1",onClick:()=>H(t,1),children:"Down"}),a.jsx("button",{className:"text-red-500",onClick:()=>(e=>{if(!g)return;const t=j.slice();t.splice(e,1),v(t),W(g,t);const s=`custom-${e}`;if(f.has(s)){const e=new Set(f);e.delete(s),N(e),B(g,e)}})(t),children:"Remove"})]})]},s)}),0===j.length&&a.jsx("li",{className:"text-sm text-slate-500",children:"No custom tasks yet."})]})]}),a.jsxs("div",{children:[a.jsx("h4",{className:"text-sm font-semibold text-slate-800 mb-2",children:"Notes"}),a.jsx("textarea",{value:$,onChange:e=>{A(e.target.value),g&&U(g,e.target.value)},className:"w-full rounded-md border px-3 py-2 min-h-[80px]",placeholder:"Key mistakes, time spent, reflections..."}),a.jsxs("div",{className:"mt-2 text-xs text-slate-500",children:["Total planned minutes: ",((null==(o=F(h))?void 0:o.tasks)||[]).reduce((e,t)=>e+t.minutes,0)+j.reduce((e,t)=>e+t.minutes,0)," min"]})]})]})]})})]})})};function m({onPick:t}){const[s,l]=e.useState("all"),[n,r]=e.useState("any"),[o,m]=e.useState(""),x=e.useMemo(()=>{const e=i({skill:s,level:n,query:o}),t=new Map;for(const s of e)t.has(s.skill)||t.set(s.skill,[]),t.get(s.skill).push(s);return Array.from(t.entries())},[s,n,o]);return a.jsxs("div",{className:"mt-2 border rounded-lg p-3 bg-white/70",children:[a.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[a.jsx("select",{value:s,onChange:e=>l(e.target.value),className:"rounded border px-2 py-1 text-sm",children:d.map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsx("select",{value:n,onChange:e=>r(e.target.value),className:"rounded border px-2 py-1 text-sm",children:c.map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsx("input",{value:o,onChange:e=>m(e.target.value),placeholder:"Search (e.g., inference)",className:"flex-1 rounded border px-2 py-1 text-sm"})]}),a.jsx("div",{className:"max-h-64 overflow-auto",children:x.map(([e,s])=>a.jsxs("div",{className:"mb-2",children:[a.jsx("div",{className:"text-xs font-semibold text-slate-700 mb-1 uppercase",children:e}),a.jsx("div",{className:"grid gap-2",children:s.map(e=>a.jsxs("button",{onClick:()=>t(e),className:"text-left text-sm px-2 py-1 rounded border hover:bg-slate-50",children:[e.label," ",a.jsxs("span",{className:"text-xs text-slate-500",children:["• ",e.minutes," min"]})]},e.id))})]},e))})]})}export{o as default};
