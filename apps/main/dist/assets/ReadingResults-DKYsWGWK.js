import{c as e,j as s,D as r,m as t,n as a,o,L as n,a6 as i,u as l,a3 as d,r as c,h as m,a4 as x,B as u,ai as h,e as p,I as g,C as f,b,d as j,l as N,i as v,k as w,a as y,E as q}from"./index-DdedLmvr.js";import{s as _}from"./supabase-DWL4C3fA.js";import{C as k,a as A,b as C}from"./collapsible-C017bQJM.js";import{H as S}from"./Header-B4RxjAO3.js";import{S as E}from"./search-P3WnWCrc.js";import{T as $}from"./trash-2-BMwIHhRg.js";import"./dropdown-menu-u6ffxSBN.js";import"./shield-DThOHUCj.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=e("BookmarkCheck",[["path",{d:"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z",key:"169p4p"}],["path",{d:"m9 10 2 2 4-4",key:"1gnqz4"}]]),L=e("Bookmark",[["path",{d:"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z",key:"1fy3hk"}]]),z=e("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),O=({isOpen:e,onClose:l,question:d,passage:c})=>{var m;if(!d)return null;const x=d.isCorrect,u=((e,s)=>{if(!s)return e;const r=s.match(/"([^"]+)"/g);let t=e;return r&&r.forEach(e=>{const s=e.slice(1,-1),r=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");t=t.replace(r,'<mark class="bg-primary/20 px-1 rounded">$1</mark>')}),t})(c,d.explanation);return s.jsx(r,{open:e,onOpenChange:l,children:s.jsxs(t,{className:"max-w-7xl max-h-[95vh] overflow-hidden z-50",children:[s.jsx(a,{className:"border-b border-border pb-4",children:s.jsxs(o,{className:"text-2xl font-bold text-foreground flex items-center gap-3",children:["Question ",d.questionNumber," Review",x?s.jsx(n,{className:"w-6 h-6 text-green-600"}):s.jsx(i,{className:"w-6 h-6 text-red-600"})]})}),s.jsxs("div",{className:"flex gap-6 h-[calc(95vh-120px)] overflow-hidden",children:[s.jsxs("div",{className:"flex-1 flex flex-col",children:[s.jsx("h3",{className:"text-lg font-semibold mb-3 text-foreground border-b border-border pb-2",children:"Reading Passage"}),s.jsx("div",{className:"flex-1 bg-muted/30 p-6 rounded-lg text-sm text-foreground leading-relaxed overflow-y-auto",children:c?s.jsx("div",{className:"whitespace-pre-line",dangerouslySetInnerHTML:{__html:u.replace(/\n\n/g,'</p><p class="mb-4">').replace(/\n/g,"<br>").replace(/^/,'<p class="mb-4">').replace(/$/,"</p>")}}):s.jsx("div",{className:"text-muted-foreground italic",children:"No passage text available for this question."})})]}),s.jsx("div",{className:"flex-1 flex flex-col",children:s.jsxs("div",{className:"flex-1 overflow-y-auto space-y-6",children:[d.type&&s.jsx("div",{className:"bg-primary/5 border border-primary/20 rounded-lg p-3",children:s.jsx("span",{className:"text-sm font-medium text-primary",children:d.type})}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-semibold mb-3 text-foreground",children:"Question"}),s.jsx("div",{className:"bg-background border border-border rounded-lg p-4",children:s.jsx("p",{className:"text-foreground font-medium",children:d.question||d.text||"No question text available"})})]}),d.options&&d.options.length>0?s.jsxs("div",{children:[s.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Answer Options"}),(null==(m=d.options[0])?void 0:m.includes("Missing option data"))?s.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[s.jsx("h4",{className:"text-md font-semibold mb-2 text-amber-800",children:"Answer Options Missing"}),s.jsxs("p",{className:"text-sm text-amber-700",children:["This question's answer options were not properly stored in the database. The correct answer is ",s.jsx("strong",{children:d.correctAnswer}),", but the original multiple choice options are missing."]}),s.jsxs("p",{className:"text-sm text-amber-700 mt-2",children:[s.jsx("strong",{children:"Note:"})," Please refer to the original test material to see all answer options."]})]}):s.jsx("div",{className:"space-y-2",children:d.options.map((e,r)=>{const t=String.fromCharCode(65+r),a=d.correctAnswer.split(/[,\s]+/).map(e=>e.trim()),o=d.userAnswer?d.userAnswer.split(/[,\s]+/).map(e=>e.trim()):[],l=a.includes(t),c=o.includes(t);let m="bg-background border-border",u="text-foreground";return l?(m="bg-green-50 border-green-200",u="text-green-700"):c&&!x&&(m="bg-red-50 border-red-200",u="text-red-700"),s.jsxs("div",{className:`p-3 rounded border text-sm flex items-center gap-2 ${m} ${u}`,children:[s.jsxs("span",{className:"font-medium min-w-[24px]",children:[t,"."]}),s.jsx("span",{className:"flex-1",children:e.replace(/^[A-Z]\.\s*/,"")}),l&&s.jsx(n,{className:"w-4 h-4 text-green-600"}),c&&!x&&s.jsx(i,{className:"w-4 h-4 text-red-600"})]},r)})})]}):["multiple_choice","matching","multiple_select"].includes(d.type||"")&&s.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[s.jsx("h4",{className:"text-md font-semibold mb-2 text-amber-800",children:"Answer Options Not Available"}),s.jsxs("p",{className:"text-sm text-amber-700",children:['The original answer options for this question are not stored in the database. This appears to be a multiple choice question where the correct answer is "',d.correctAnswer,'".']}),s.jsxs("p",{className:"text-sm text-amber-700 mt-2",children:[s.jsx("strong",{children:"Note:"})," To see the complete answer options, please refer to the original test material."]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Answer Summary"}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{className:"rounded-lg p-4 border "+(x?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:[s.jsx("h5",{className:"font-semibold mb-2 "+(x?"text-green-700":"text-red-700"),children:"Your Answer"}),s.jsx("p",{className:"font-medium "+(x?"text-green-600":"text-red-600"),children:d.userAnswer||"No answer provided"})]}),s.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[s.jsx("h5",{className:"font-semibold text-green-700 mb-2",children:"Correct Answer"}),s.jsx("p",{className:"text-green-600 font-medium",children:d.correctAnswer||"Not available"})]})]})]}),d.explanation&&s.jsxs("div",{children:[s.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Explanation"}),s.jsx("div",{className:"bg-primary/5 border border-primary/20 rounded-lg p-4",children:s.jsx("p",{className:"text-foreground leading-relaxed",children:d.explanation})})]})]})})]})]})})},P=()=>{const e=l(),{user:r,loading:t}=d(),[a,o]=c.useState([]),[n,i]=c.useState(!0),[P,Q]=c.useState(null),[B,F]=c.useState(""),[R,D]=c.useState(new Set),[I,H]=c.useState({}),[M,Y]=c.useState(new Set),[V,Z]=c.useState(""),[G,J]=c.useState("all"),[K,U]=c.useState(new Set),{toast:W}=m();c.useEffect(()=>{t?console.log("â³ Auth still loading, waiting..."):r?(X(),ee()):(i(!1),o([]))},[r,t]),c.useEffect(()=>{if(t){const e=setTimeout(()=>{console.warn("âš ï¸ Auth loading timeout reached, forcing loading to false"),i(!1),o([])},1e4);return()=>clearTimeout(e)}},[t]),c.useEffect(()=>{a.length>0&&(async()=>{const e={};for(const s of a)e[s.id]=await re(s);H(e)})()},[a]);const X=async()=>{if(!(null==r?void 0:r.id))return console.warn("No authenticated user found"),void(t||i(!1));try{const{data:e,error:s}=await _.from("reading_test_results").select("*").eq("user_id",r.id).order("created_at",{ascending:!1});s?(console.error("Error fetching reading results:",s),W({title:"Error loading results",description:"Failed to load reading test results. Please try refreshing the page.",variant:"destructive"}),o([])):o(e||[])}catch(e){console.error("Error loading reading results:",e),W({title:"Connection error",description:"Failed to connect to the server. Please check your internet connection and try again.",variant:"destructive"}),o([])}finally{i(!1)}},ee=async()=>{if(null==r?void 0:r.id)try{const{data:e,error:s}=await _.from("question_bookmarks").select("question_id, test_result_id").eq("user_id",r.id);if(s)return void console.error("Error fetching bookmarks:",s);const t=new Set((null==e?void 0:e.map(e=>`${e.test_result_id}-${e.question_id}`))||[]);U(t)}catch(e){console.error("Error loading bookmarks:",e)}},se=(e,s)=>K.has(`${e}-${s.questionNumber}`),re=async e=>{if(!e.questions_data)return[];const s=[],r=e.questions_data.questions||e.questions_data;return Array.isArray(r)&&r.forEach((e,r)=>{const t=e.user_answer||"",a=e.correct_answer||e.answer||"",o=void 0!==e.is_correct?e.is_correct:t===a;if(!o){const n=e.options&&Array.isArray(e.options)?e.options:[];s.push({questionNumber:r+1,question:e.question_text||e.question||e.text||"",text:e.question_text||e.text,userAnswer:t,correctAnswer:a,explanation:e.explanation||"",options:n,type:e.type||e.question_type||"",isCorrect:o})}}),s},te=(e,s)=>R.has(`${e}-${s}`),ae=a.filter(e=>{var s;const r=(I[e.id]||[]).filter(s=>!te(e.id,s.questionNumber));if(0===r.length)return!1;if(V){const t=V.toLowerCase(),a=null==(s=e.passage_title)?void 0:s.toLowerCase().includes(t),o=r.some(e=>e.question.toLowerCase().includes(t)||e.userAnswer.toLowerCase().includes(t)||e.correctAnswer.toLowerCase().includes(t));if(!a&&!o)return!1}if("all"!==G)if("bookmarked"===G){if(!r.some(s=>se(e.id,s)))return!1}else{if(!r.some(e=>{var s;return null==(s=e.type)?void 0:s.toLowerCase().includes(G.toLowerCase())}))return!1}return!0});return n||t?s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsx(x,{})}):s.jsxs("div",{className:"min-h-screen bg-background",children:[s.jsx(S,{}),s.jsx("div",{className:"bg-gradient-to-r from-primary/10 via-primary/5 to-background border-b border-border/20",children:s.jsxs("div",{className:"container mx-auto px-4 py-8",children:[s.jsx("div",{className:"flex items-center gap-4 mb-2",children:s.jsxs(u,{variant:"ghost",onClick:()=>e("/dashboard"),className:"text-muted-foreground hover:text-foreground",children:[s.jsx(h,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]})}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center",children:s.jsx(p,{className:"w-6 h-6 text-primary"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Incorrect Answer Notes"}),s.jsx("p",{className:"text-muted-foreground",children:"Review and manage your incorrect answers to improve learning"})]})]})]})}),s.jsxs("div",{className:"container mx-auto px-4 py-8",children:[a.length>0&&s.jsxs("div",{className:"mb-8 space-y-4",children:[s.jsxs("div",{className:"flex gap-4 items-center",children:[s.jsxs("div",{className:"relative flex-1 max-w-md",children:[s.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),s.jsx(g,{placeholder:"Search questions, answers, or passages...",value:V,onChange:e=>Z(e.target.value),className:"pl-10"})]}),s.jsx("div",{className:"flex items-center gap-2"})]}),s.jsxs("div",{className:"flex gap-6 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"}),s.jsxs("span",{className:"text-muted-foreground",children:["Tests: ",s.jsx("span",{className:"text-foreground font-medium",children:a.length})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),s.jsxs("span",{className:"text-muted-foreground",children:["Incorrect Notes: ",s.jsx("span",{className:"text-foreground font-medium",children:ae.reduce((e,s)=>e+(I[s.id]||[]).filter(e=>!te(s.id,e.questionNumber)).length,0)})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),s.jsxs("span",{className:"text-muted-foreground",children:["Bookmarked: ",s.jsx("span",{className:"text-foreground font-medium",children:a.reduce((e,s)=>e+(I[s.id]||[]).filter(e=>se(s.id,e)).length,0)})]})]})]})]}),s.jsx("div",{className:"space-y-6",children:ae.length>0?ae.map(e=>{const t=I[e.id],n=Array.isArray(t)?t:[],i=e.questions_data.questions||e.questions_data||[],l=Array.isArray(i)?i.length:0,d=n.length;let c=n.filter(s=>!te(e.id,s.questionNumber));"bookmarked"===G&&(c=c.filter(s=>se(e.id,s)));const m=M.has(e.id);return 0===c.length?null:s.jsx(k,{open:m,onOpenChange:()=>{return s=e.id,void Y(e=>{const r=new Set(e);return r.has(s)?r.delete(s):r.add(s),r});var s},children:s.jsxs(f,{className:"overflow-hidden transition-all duration-200 hover:shadow-md",children:[s.jsx(A,{className:"w-full",children:s.jsx(b,{className:"hover:bg-muted/30 transition-colors",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-start gap-4",children:[s.jsx("div",{className:"w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0",children:s.jsx(z,{className:"w-5 h-5 text-red-600"})}),s.jsxs("div",{className:"text-left",children:[s.jsxs(j,{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[e.passage_title||"Reading Test",s.jsxs(N,{variant:"destructive",className:"text-xs",children:[c.length," to review"]}),c.some(s=>se(e.id,s))&&s.jsxs(N,{variant:"outline",className:"text-xs text-yellow-600 border-yellow-200",children:["ðŸ”– ",c.filter(s=>se(e.id,s)).length," bookmarked"]})]}),s.jsxs("div",{className:"flex items-center gap-3 mt-1 text-sm text-muted-foreground",children:[s.jsx("span",{children:new Date(e.created_at).toLocaleDateString()}),s.jsxs("span",{className:"text-foreground font-medium",children:[l-d,"/",l," correct"]})]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[c.length>0&&s.jsxs(u,{variant:"outline",size:"sm",onClick:s=>{s.stopPropagation(),(async(e,s)=>{try{const r=a.find(s=>s.id===e);if(!r)return;const t=(r.questions_data.questions||r.questions_data).filter((e,s)=>{const r=e.user_answer||"",t=e.correct_answer||e.answer||"";return void 0!==e.is_correct?e.is_correct:r===t});if(0===t.length){const{error:s}=await _.from("reading_test_results").delete().eq("id",e);if(s)throw s;o(s=>s.filter(s=>s.id!==e)),W({title:"Test result removed",description:"All incorrect questions were removed, so the test result has been deleted"})}else{const{error:r}=await _.from("reading_test_results").update({questions_data:{questions:t}}).eq("id",e);if(r)throw r;o(s=>s.map(s=>s.id===e?{...s,questions_data:{questions:t}}:s)),W({title:"Questions removed",description:`${s.length} incorrect questions permanently removed`})}}catch(r){console.error("Error removing questions:",r),W({title:"Error",description:"Failed to remove questions",variant:"destructive"})}})(e.id,c)},className:"text-red-600 border-red-200 hover:bg-red-50",children:[s.jsx($,{className:"w-4 h-4 mr-2"}),"Clear All"]}),m?s.jsx(v,{className:"w-5 h-5 text-muted-foreground"}):s.jsx(w,{className:"w-5 h-5 text-muted-foreground"})]})]})})}),s.jsx(C,{children:s.jsx(y,{className:"pt-0 px-6 pb-6",children:s.jsx("div",{className:"space-y-4",children:c.map((t,n)=>s.jsx("div",{className:"p-4 border rounded-lg hover:shadow-sm transition-all "+(se(e.id,t)?"bg-yellow-50 border-yellow-200":"bg-red-50 border-red-200"),children:s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[s.jsx("span",{className:"w-7 h-7 rounded-full bg-red-100 flex items-center justify-center text-xs font-semibold text-red-700",children:t.questionNumber}),se(e.id,t)&&s.jsx(T,{className:"w-4 h-4 text-yellow-600"})]}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-sm font-medium text-foreground mb-2 leading-relaxed",children:t.question}),t.options&&t.options.length>0&&s.jsx("div",{className:"mb-3 p-2 bg-background/60 rounded border border-border/50",children:s.jsx("div",{className:"grid grid-cols-1 gap-1",children:t.options.map((e,r)=>s.jsx("div",{className:"text-xs text-foreground/80",children:e},r))})}),s.jsxs("div",{className:"flex gap-3 mb-2",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Your Answer:"}),s.jsx("div",{className:"text-sm font-medium text-red-600 mt-1",children:t.userAnswer||"No answer"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Correct:"}),s.jsx("div",{className:"text-sm font-medium text-green-600 mt-1",children:t.correctAnswer})]})]}),t.explanation&&s.jsx("div",{className:"mt-2 p-2 bg-blue-50/80 rounded border border-blue-200/50",children:s.jsx("p",{className:"text-xs text-blue-700 leading-relaxed",children:t.explanation})})]}),s.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[s.jsx(u,{variant:"ghost",size:"sm",onClick:s=>{s.stopPropagation(),(async(e,s)=>{if(!(null==r?void 0:r.id))return;const t=`${e.id}-${s.questionNumber}`,a=K.has(t);try{if(a){const{error:a}=await _.from("question_bookmarks").delete().eq("user_id",r.id).eq("question_id",s.questionNumber.toString()).eq("test_result_id",e.id);if(a)throw a;U(e=>{const s=new Set(e);return s.delete(t),s}),W({title:"Bookmark removed",description:"Question removed from your bookmarks"})}else{const{error:a}=await _.from("question_bookmarks").insert({user_id:r.id,question_id:s.questionNumber.toString(),question_text:s.question,question_type:s.type||"",user_answer:s.userAnswer,correct_answer:s.correctAnswer,explanation:s.explanation||"",options:s.options||[],passage_title:e.passage_title,passage_text:e.passage_text||"",test_result_id:e.id});if(a)throw a;U(e=>new Set([...e,t])),W({title:"Question bookmarked",description:"Added to your bookmarks for later review"})}}catch(o){console.error("Error toggling bookmark:",o),W({title:"Error",description:"Failed to update bookmark",variant:"destructive"})}})(e,t)},className:"h-8 w-8 p-0 "+(se(e.id,t)?"text-yellow-600 hover:text-yellow-700 hover:bg-yellow-100":"text-gray-400 hover:text-yellow-600 hover:bg-yellow-50"),children:se(e.id,t)?s.jsx(T,{className:"w-4 h-4"}):s.jsx(L,{className:"w-4 h-4"})}),s.jsx(u,{variant:"ghost",size:"sm",onClick:()=>((e,s)=>{Q(e),F(s)})(t,e.passage_text||""),className:"h-8 w-8 p-0 text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:s.jsx(q,{className:"w-4 h-4"})}),s.jsx(u,{variant:"ghost",size:"sm",onClick:()=>(async(e,s)=>{try{const r=a.find(s=>s.id===e);if(!r)return;const t=(r.questions_data.questions||r.questions_data).filter((e,r)=>r+1!==s);if(0===t.length){const{error:s}=await _.from("reading_test_results").delete().eq("id",e);if(s)throw s;o(s=>s.filter(s=>s.id!==e)),W({title:"Test result removed",description:"All questions were removed, so the test result has been deleted"})}else{const{error:s}=await _.from("reading_test_results").update({questions_data:{questions:t}}).eq("id",e);if(s)throw s;o(s=>s.map(s=>s.id===e?{...s,questions_data:{questions:t}}:s)),W({title:"Question removed",description:"Question permanently removed from your results"})}}catch(r){console.error("Error removing question:",r),W({title:"Error",description:"Failed to remove question",variant:"destructive"})}})(e.id,t.questionNumber),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50",children:s.jsx($,{className:"w-4 h-4"})})]})]})},n))})})})]})},e.id)}):a.length>0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(E,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground/50"}),s.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No results found"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"Try adjusting your search or filter criteria"}),s.jsx(u,{variant:"outline",onClick:()=>{Z(""),J("all")},children:"Clear Filters"})]}):s.jsxs("div",{className:"text-center py-12",children:[s.jsx(p,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground/50"}),s.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No reading test results found"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"Your reading practice results will appear here once you complete some tests"}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{onClick:()=>e("/ielts-portal"),className:"mb-2",children:"Start Reading Practice"}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Complete reading tests to see your progress and feedback"})]})]})}),s.jsx(O,{isOpen:!!P,onClose:()=>Q(null),question:P,passage:B})]})]})};
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */export{P as default};
