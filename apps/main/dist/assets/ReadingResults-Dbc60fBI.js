import{j as e,u as s,r}from"./vendor-react-rLLBBC7n.js";import{D as t,f as a,g as o,h as n,E as i,d as l,s as d,x as c,B as m,I as x,C as u,b as h,c as g,e as p,a as f}from"./index-BDl0jLJK.js";import{C as b,a as j,b as N}from"./collapsible-ts_KamNe.js";import{H as v}from"./Header-B_feYwRL.js";import{at as w,aI as y,az as q,ao as _,aW as k,c6 as A,aY as C,h as S,aa as E,c7 as $,c8 as T,aN as L}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";import"./dropdown-menu-DF6eZyHV.js";const O=({isOpen:s,onClose:r,question:i,passage:l})=>{var d;if(!i)return null;const c=i.isCorrect,m=((e,s)=>{if(!s)return e;const r=s.match(/"([^"]+)"/g);let t=e;return r&&r.forEach(e=>{const s=e.slice(1,-1),r=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");t=t.replace(r,'<mark class="bg-primary/20 px-1 rounded">$1</mark>')}),t})(l,i.explanation);return e.jsx(t,{open:s,onOpenChange:r,children:e.jsxs(a,{className:"max-w-7xl max-h-[95vh] overflow-hidden z-50",children:[e.jsx(o,{className:"border-b border-border pb-4",children:e.jsxs(n,{className:"text-2xl font-bold text-foreground flex items-center gap-3",children:["Question ",i.questionNumber," Review",c?e.jsx(w,{className:"w-6 h-6 text-green-600"}):e.jsx(y,{className:"w-6 h-6 text-red-600"})]})}),e.jsxs("div",{className:"flex gap-6 h-[calc(95vh-120px)] overflow-hidden",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-foreground border-b border-border pb-2",children:"Reading Passage"}),e.jsx("div",{className:"flex-1 bg-muted/30 p-6 rounded-lg text-sm text-foreground leading-relaxed overflow-y-auto",children:l?e.jsx("div",{className:"whitespace-pre-line",dangerouslySetInnerHTML:{__html:m.replace(/\n\n/g,'</p><p class="mb-4">').replace(/\n/g,"<br>").replace(/^/,'<p class="mb-4">').replace(/$/,"</p>")}}):e.jsx("div",{className:"text-muted-foreground italic",children:"No passage text available for this question."})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-6",children:[i.type&&e.jsx("div",{className:"bg-primary/5 border border-primary/20 rounded-lg p-3",children:e.jsx("span",{className:"text-sm font-medium text-primary",children:i.type})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-foreground",children:"Question"}),e.jsx("div",{className:"bg-background border border-border rounded-lg p-4",children:e.jsx("p",{className:"text-foreground font-medium",children:i.question||i.text||"No question text available"})})]}),i.options&&i.options.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Answer Options"}),(null==(d=i.options[0])?void 0:d.includes("Missing option data"))?e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-md font-semibold mb-2 text-amber-800",children:"Answer Options Missing"}),e.jsxs("p",{className:"text-sm text-amber-700",children:["This question's answer options were not properly stored in the database. The correct answer is ",e.jsx("strong",{children:i.correctAnswer}),", but the original multiple choice options are missing."]}),e.jsxs("p",{className:"text-sm text-amber-700 mt-2",children:[e.jsx("strong",{children:"Note:"})," Please refer to the original test material to see all answer options."]})]}):e.jsx("div",{className:"space-y-2",children:i.options.map((s,r)=>{const t=String.fromCharCode(65+r),a=i.correctAnswer.split(/[,\s]+/).map(e=>e.trim()),o=i.userAnswer?i.userAnswer.split(/[,\s]+/).map(e=>e.trim()):[],n=a.includes(t),l=o.includes(t);let d="bg-background border-border",m="text-foreground";return n?(d="bg-green-50 border-green-200",m="text-green-700"):l&&!c&&(d="bg-red-50 border-red-200",m="text-red-700"),e.jsxs("div",{className:`p-3 rounded border text-sm flex items-center gap-2 ${d} ${m}`,children:[e.jsxs("span",{className:"font-medium min-w-[24px]",children:[t,"."]}),e.jsx("span",{className:"flex-1",children:s.replace(/^[A-Z]\.\s*/,"")}),n&&e.jsx(w,{className:"w-4 h-4 text-green-600"}),l&&!c&&e.jsx(y,{className:"w-4 h-4 text-red-600"})]},r)})})]}):["multiple_choice","matching","multiple_select"].includes(i.type||"")&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-md font-semibold mb-2 text-amber-800",children:"Answer Options Not Available"}),e.jsxs("p",{className:"text-sm text-amber-700",children:['The original answer options for this question are not stored in the database. This appears to be a multiple choice question where the correct answer is "',i.correctAnswer,'".']}),e.jsxs("p",{className:"text-sm text-amber-700 mt-2",children:[e.jsx("strong",{children:"Note:"})," To see the complete answer options, please refer to the original test material."]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Answer Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-lg p-4 border "+(c?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:[e.jsx("h5",{className:"font-semibold mb-2 "+(c?"text-green-700":"text-red-700"),children:"Your Answer"}),e.jsx("p",{className:"font-medium "+(c?"text-green-600":"text-red-600"),children:i.userAnswer||"No answer provided"})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("h5",{className:"font-semibold text-green-700 mb-2",children:"Correct Answer"}),e.jsx("p",{className:"text-green-600 font-medium",children:i.correctAnswer||"Not available"})]})]})]}),i.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold mb-3 text-foreground",children:"Explanation"}),e.jsx("div",{className:"bg-primary/5 border border-primary/20 rounded-lg p-4",children:e.jsx("p",{className:"text-foreground leading-relaxed",children:i.explanation})})]})]})})]})]})})},P=()=>{const t=s(),{user:a,loading:o}=i(),[n,w]=r.useState([]),[y,P]=r.useState(!0),[Q,z]=r.useState(null),[F,R]=r.useState(""),[I,B]=r.useState(new Set),[D,Y]=r.useState({}),[H,M]=r.useState(new Set),[W,Z]=r.useState(""),[G,J]=r.useState("all"),[K,U]=r.useState(new Set),{toast:V}=l();r.useEffect(()=>{o?console.log("â³ Auth still loading, waiting..."):a?(X(),ee()):(P(!1),w([]))},[a,o]),r.useEffect(()=>{if(o){const e=setTimeout(()=>{console.warn("âš ï¸ Auth loading timeout reached, forcing loading to false"),P(!1),w([])},1e4);return()=>clearTimeout(e)}},[o]),r.useEffect(()=>{n.length>0&&(async()=>{const e={};for(const s of n)e[s.id]=await re(s);Y(e)})()},[n]);const X=async()=>{if(!(null==a?void 0:a.id))return console.warn("No authenticated user found"),void(o||P(!1));try{const{data:e,error:s}=await d.from("reading_test_results").select("*").eq("user_id",a.id).order("created_at",{ascending:!1});s?(console.error("Error fetching reading results:",s),V({title:"Error loading results",description:"Failed to load reading test results. Please try refreshing the page.",variant:"destructive"}),w([])):w(e||[])}catch(e){console.error("Error loading reading results:",e),V({title:"Connection error",description:"Failed to connect to the server. Please check your internet connection and try again.",variant:"destructive"}),w([])}finally{P(!1)}},ee=async()=>{if(null==a?void 0:a.id)try{const{data:e,error:s}=await d.from("question_bookmarks").select("question_id, test_result_id").eq("user_id",a.id);if(s)return void console.error("Error fetching bookmarks:",s);const r=new Set((null==e?void 0:e.map(e=>`${e.test_result_id}-${e.question_id}`))||[]);U(r)}catch(e){console.error("Error loading bookmarks:",e)}},se=(e,s)=>K.has(`${e}-${s.questionNumber}`),re=async e=>{if(!e.questions_data)return[];const s=[],r=e.questions_data.questions||e.questions_data;return Array.isArray(r)&&r.forEach((e,r)=>{const t=e.user_answer||"",a=e.correct_answer||e.answer||"",o=void 0!==e.is_correct?e.is_correct:t===a;if(!o){const n=e.options&&Array.isArray(e.options)?e.options:[];s.push({questionNumber:r+1,question:e.question_text||e.question||e.text||"",text:e.question_text||e.text,userAnswer:t,correctAnswer:a,explanation:e.explanation||"",options:n,type:e.type||e.question_type||"",isCorrect:o})}}),s},te=(e,s)=>I.has(`${e}-${s}`),ae=n.filter(e=>{var s;const r=(D[e.id]||[]).filter(s=>!te(e.id,s.questionNumber));if(0===r.length)return!1;if(W){const t=W.toLowerCase(),a=null==(s=e.passage_title)?void 0:s.toLowerCase().includes(t),o=r.some(e=>e.question.toLowerCase().includes(t)||e.userAnswer.toLowerCase().includes(t)||e.correctAnswer.toLowerCase().includes(t));if(!a&&!o)return!1}if("all"!==G)if("bookmarked"===G){if(!r.some(s=>se(e.id,s)))return!1}else{if(!r.some(e=>{var s;return null==(s=e.type)?void 0:s.toLowerCase().includes(G.toLowerCase())}))return!1}return!0});return y||o?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(c,{})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(v,{}),e.jsx("div",{className:"bg-gradient-to-r from-primary/10 via-primary/5 to-background border-b border-border/20",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"flex items-center gap-4 mb-2",children:e.jsxs(m,{variant:"ghost",onClick:()=>t("/dashboard"),className:"text-muted-foreground hover:text-foreground",children:[e.jsx(q,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(_,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Incorrect Answer Notes"}),e.jsx("p",{className:"text-muted-foreground",children:"Review and manage your incorrect answers to improve learning"})]})]})]})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[n.length>0&&e.jsxs("div",{className:"mb-8 space-y-4",children:[e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(k,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(x,{placeholder:"Search questions, answers, or passages...",value:W,onChange:e=>Z(e.target.value),className:"pl-10"})]}),e.jsx("div",{className:"flex items-center gap-2"})]}),e.jsxs("div",{className:"flex gap-6 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"}),e.jsxs("span",{className:"text-muted-foreground",children:["Tests: ",e.jsx("span",{className:"text-foreground font-medium",children:n.length})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsxs("span",{className:"text-muted-foreground",children:["Incorrect Notes: ",e.jsx("span",{className:"text-foreground font-medium",children:ae.reduce((e,s)=>e+(D[s.id]||[]).filter(e=>!te(s.id,e.questionNumber)).length,0)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),e.jsxs("span",{className:"text-muted-foreground",children:["Bookmarked: ",e.jsx("span",{className:"text-foreground font-medium",children:n.reduce((e,s)=>e+(D[s.id]||[]).filter(e=>se(s.id,e)).length,0)})]})]})]})]}),e.jsx("div",{className:"space-y-6",children:ae.length>0?ae.map(s=>{const r=D[s.id],t=Array.isArray(r)?r:[],o=s.questions_data.questions||s.questions_data||[],i=Array.isArray(o)?o.length:0,l=t.length;let c=t.filter(e=>!te(s.id,e.questionNumber));"bookmarked"===G&&(c=c.filter(e=>se(s.id,e)));const x=H.has(s.id);return 0===c.length?null:e.jsx(b,{open:x,onOpenChange:()=>{return e=s.id,void M(s=>{const r=new Set(s);return r.has(e)?r.delete(e):r.add(e),r});var e},children:e.jsxs(u,{className:"overflow-hidden transition-all duration-200 hover:shadow-md",children:[e.jsx(j,{className:"w-full",children:e.jsx(h,{className:"hover:bg-muted/30 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0",children:e.jsx(A,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{className:"text-left",children:[e.jsxs(g,{className:"text-lg font-semibold text-foreground flex items-center gap-2",children:[s.passage_title||"Reading Test",e.jsxs(p,{variant:"destructive",className:"text-xs",children:[c.length," to review"]}),c.some(e=>se(s.id,e))&&e.jsxs(p,{variant:"outline",className:"text-xs text-yellow-600 border-yellow-200",children:["ðŸ”– ",c.filter(e=>se(s.id,e)).length," bookmarked"]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-sm text-muted-foreground",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),e.jsxs("span",{className:"text-foreground font-medium",children:[i-l,"/",i," correct"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.length>0&&e.jsxs(m,{variant:"outline",size:"sm",onClick:e=>{e.stopPropagation(),(async(e,s)=>{try{const r=n.find(s=>s.id===e);if(!r)return;const t=(r.questions_data.questions||r.questions_data).filter((e,s)=>{const r=e.user_answer||"",t=e.correct_answer||e.answer||"";return void 0!==e.is_correct?e.is_correct:r===t});if(0===t.length){const{error:s}=await d.from("reading_test_results").delete().eq("id",e);if(s)throw s;w(s=>s.filter(s=>s.id!==e)),V({title:"Test result removed",description:"All incorrect questions were removed, so the test result has been deleted"})}else{const{error:r}=await d.from("reading_test_results").update({questions_data:{questions:t}}).eq("id",e);if(r)throw r;w(s=>s.map(s=>s.id===e?{...s,questions_data:{questions:t}}:s)),V({title:"Questions removed",description:`${s.length} incorrect questions permanently removed`})}}catch(r){console.error("Error removing questions:",r),V({title:"Error",description:"Failed to remove questions",variant:"destructive"})}})(s.id,c)},className:"text-red-600 border-red-200 hover:bg-red-50",children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Clear All"]}),x?e.jsx(S,{className:"w-5 h-5 text-muted-foreground"}):e.jsx(E,{className:"w-5 h-5 text-muted-foreground"})]})]})})}),e.jsx(N,{children:e.jsx(f,{className:"pt-0 px-6 pb-6",children:e.jsx("div",{className:"space-y-4",children:c.map((r,t)=>e.jsx("div",{className:"p-4 border rounded-lg hover:shadow-sm transition-all "+(se(s.id,r)?"bg-yellow-50 border-yellow-200":"bg-red-50 border-red-200"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx("span",{className:"w-7 h-7 rounded-full bg-red-100 flex items-center justify-center text-xs font-semibold text-red-700",children:r.questionNumber}),se(s.id,r)&&e.jsx($,{className:"w-4 h-4 text-yellow-600"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-foreground mb-2 leading-relaxed",children:r.question}),r.options&&r.options.length>0&&e.jsx("div",{className:"mb-3 p-2 bg-background/60 rounded border border-border/50",children:e.jsx("div",{className:"grid grid-cols-1 gap-1",children:r.options.map((s,r)=>e.jsx("div",{className:"text-xs text-foreground/80",children:s},r))})}),e.jsxs("div",{className:"flex gap-3 mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Your Answer:"}),e.jsx("div",{className:"text-sm font-medium text-red-600 mt-1",children:r.userAnswer||"No answer"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Correct:"}),e.jsx("div",{className:"text-sm font-medium text-green-600 mt-1",children:r.correctAnswer})]})]}),r.explanation&&e.jsx("div",{className:"mt-2 p-2 bg-blue-50/80 rounded border border-blue-200/50",children:e.jsx("p",{className:"text-xs text-blue-700 leading-relaxed",children:r.explanation})})]}),e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx(m,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),(async(e,s)=>{if(!(null==a?void 0:a.id))return;const r=`${e.id}-${s.questionNumber}`,t=K.has(r);try{if(t){const{error:t}=await d.from("question_bookmarks").delete().eq("user_id",a.id).eq("question_id",s.questionNumber.toString()).eq("test_result_id",e.id);if(t)throw t;U(e=>{const s=new Set(e);return s.delete(r),s}),V({title:"Bookmark removed",description:"Question removed from your bookmarks"})}else{const{error:t}=await d.from("question_bookmarks").insert({user_id:a.id,question_id:s.questionNumber.toString(),question_text:s.question,question_type:s.type||"",user_answer:s.userAnswer,correct_answer:s.correctAnswer,explanation:s.explanation||"",options:s.options||[],passage_title:e.passage_title,passage_text:e.passage_text||"",test_result_id:e.id});if(t)throw t;U(e=>new Set([...e,r])),V({title:"Question bookmarked",description:"Added to your bookmarks for later review"})}}catch(o){console.error("Error toggling bookmark:",o),V({title:"Error",description:"Failed to update bookmark",variant:"destructive"})}})(s,r)},className:"h-8 w-8 p-0 "+(se(s.id,r)?"text-yellow-600 hover:text-yellow-700 hover:bg-yellow-100":"text-gray-400 hover:text-yellow-600 hover:bg-yellow-50"),children:se(s.id,r)?e.jsx($,{className:"w-4 h-4"}):e.jsx(T,{className:"w-4 h-4"})}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>((e,s)=>{z(e),R(s)})(r,s.passage_text||""),className:"h-8 w-8 p-0 text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:e.jsx(L,{className:"w-4 h-4"})}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>(async(e,s)=>{try{const r=n.find(s=>s.id===e);if(!r)return;const t=(r.questions_data.questions||r.questions_data).filter((e,r)=>r+1!==s);if(0===t.length){const{error:s}=await d.from("reading_test_results").delete().eq("id",e);if(s)throw s;w(s=>s.filter(s=>s.id!==e)),V({title:"Test result removed",description:"All questions were removed, so the test result has been deleted"})}else{const{error:s}=await d.from("reading_test_results").update({questions_data:{questions:t}}).eq("id",e);if(s)throw s;w(s=>s.map(s=>s.id===e?{...s,questions_data:{questions:t}}:s)),V({title:"Question removed",description:"Question permanently removed from your results"})}}catch(r){console.error("Error removing question:",r),V({title:"Error",description:"Failed to remove question",variant:"destructive"})}})(s.id,r.questionNumber),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(C,{className:"w-4 h-4"})})]})]})},t))})})})]})},s.id)}):n.length>0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(k,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No results found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Try adjusting your search or filter criteria"}),e.jsx(m,{variant:"outline",onClick:()=>{Z(""),J("all")},children:"Clear Filters"})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(_,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No reading test results found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Your reading practice results will appear here once you complete some tests"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{onClick:()=>t("/ielts-portal"),className:"mb-2",children:"Start Reading Practice"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Complete reading tests to see your progress and feedback"})]})]})}),e.jsx(O,{isOpen:!!Q,onClose:()=>z(null),question:Q,passage:F})]})]})};export{P as default};
