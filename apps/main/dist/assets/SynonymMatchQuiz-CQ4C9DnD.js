import{G as e,u as t,r as s,h as a,j as r,B as n,aa as i,K as l,C as o,a as c}from"./index-CC0VvhH4.js";import{s as d}from"./supabase-DWL4C3fA.js";import{C as m}from"./CelebrationLottieAnimation-nPnA3YpT.js";import{P as u}from"./PenguinClapAnimation-D9M7rgdU.js";function x(e){const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}const h=()=>{const{testId:h}=e(),f=t(),[p,j]=s.useState([]),[g,v]=s.useState(0),[w,y]=s.useState(null),[N,_]=s.useState(0),[b,k]=s.useState(!1),[C,q]=s.useState(!1),[S,T]=s.useState([]),[M,A]=s.useState(null),[Y,B]=s.useState(!0),[E,L]=s.useState(null),{toast:F}=a();s.useEffect(()=>{(async()=>{if(h){B(!0),L(null);try{console.log("ðŸ“š Loading synonym match questions for test:",h);const{data:e,error:t}=await d.from("skill_practice_questions").select("id,content,question_format,correct_answer,incorrect_answers,explanation").eq("skill_test_id",h);if(t)return console.error("âŒ Query error:",t),void L(`Failed to load questions: ${t.message}`);if(console.log("ðŸ“– Fetched data:",e),!e||0===e.length)return console.warn("âš ï¸ No questions found for test:",h),void L("No questions found for this test. The test may not have any questions yet.");const s=x(e).slice(0,10);console.log(`âœ… Loaded ${s.length} questions`),j(s)}catch(e){console.error("âŒ Error loading questions:",e),L(e.message||"Failed to load questions")}finally{B(!1)}}})()},[h]),s.useEffect(()=>{if(!h)return;(async()=>{const{data:e}=await d.from("skill_tests").select("id, created_at").eq("skill_slug","synonym-match").order("created_at",{ascending:!0}),t=(e??[]).findIndex(e=>e.id===h);t>=0&&A(t+1)})()},[h]),s.useEffect(()=>{(async()=>{var e;if(!b||!h)return;const{data:t}=await d.auth.getUser(),s=null==(e=null==t?void 0:t.user)?void 0:e.id;if(!s)return;const a=Math.round(N/p.length*100),r=N>=Math.ceil(.8*(p.length||10));try{if(await d.from("user_test_progress").upsert({user_id:s,test_id:h,status:"completed",completed_score:a},{onConflict:"user_id,test_id"}),r){const{data:e}=await d.from("skill_tests").select("id, test_order").eq("skill_slug","synonym-match").order("test_order",{ascending:!0});if(e){const t=e.find(e=>e.id===h),a=e.find(e=>e.test_order===((null==t?void 0:t.test_order)||0)+1);a&&(await d.from("user_test_progress").upsert({user_id:s,test_id:a.id,status:"unlocked"},{onConflict:"user_id,test_id"}),F({title:"Level up!",description:"Next level unlocked! Great job!"}))}}}catch(n){console.error("Error updating progress:",n)}})()},[b]);const G=p[g],Q=s.useMemo(()=>G?x([G.correct_answer,...G.incorrect_answers||[]]):[],[G]),R=p.length?g/p.length*100:0,V=e=>{if(w)return;if(y(e),!G)return;const t=e===G.correct_answer;t&&(_(e=>e+1),(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),s=e.createGain();t.type="sine",t.frequency.value=880,t.connect(s),s.connect(e.destination),s.gain.setValueAtTime(1e-4,e.currentTime),s.gain.exponentialRampToValueAtTime(.2,e.currentTime+.01),t.start(),setTimeout(()=>{t.frequency.setValueAtTime(660,e.currentTime),s.gain.exponentialRampToValueAtTime(1e-5,e.currentTime+.15),setTimeout(()=>{t.stop(),e.close()},180)},120)}catch(e){}})(),q(!0),setTimeout(()=>q(!1),1200)),T(s=>[...s,{id:G.id,question:G.content,chosen:e,correct:G.correct_answer,isCorrect:t}])};return h?r.jsx(i,{title:"Synonym Match",showBackButton:!0,children:r.jsx("section",{className:"mx-auto px-4",children:r.jsxs("div",{className:"min-h-[70vh] flex flex-col items-center justify-center gap-4",children:[r.jsx("div",{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:r.jsxs("div",{className:"relative",children:[r.jsx("div",{className:"absolute -top-10 h-10 flex items-center justify-center -translate-x-1/2 transition-[left] duration-300 ease-out",style:{left:`${R}%`},"aria-label":"Progress mascot",title:"Keep going!",children:r.jsx("img",{src:"/lovable-uploads/27e74cd0-58d8-4b55-b31a-fdb162f21e8b.png",alt:"Synonym match progress turtle mascot",className:"w-12 h-12 object-contain drop-shadow animate-[turtle-legs_900ms_ease-in-out_infinite]",loading:"lazy"})}),r.jsx("style",{children:"@keyframes turtle-legs { 0% { transform: translateY(0) rotate(0deg) } 25% { transform: translateY(-1px) rotate(-2deg) } 50% { transform: translateY(0) rotate(0deg) } 75% { transform: translateY(-1px) rotate(2deg) } 100% { transform: translateY(0) rotate(0deg) } }"}),r.jsx(l,{value:R})]})}),!b&&r.jsx("div",{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl flex justify-end -mt-2",children:r.jsx(n,{variant:"outline",onClick:()=>f("/skills/synonym-match"),children:"Quit to Map"})}),b?r.jsx(o,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl",children:r.jsxs(c,{className:"p-6 space-y-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-center gap-3",children:[r.jsx("div",{className:"text-2xl font-semibold",children:"Great job!"}),r.jsx(u,{size:"sm",speed:1.1})]}),r.jsxs("div",{className:"text-center text-muted-foreground",children:["Your score: ",N," / ",p.length]})]}),r.jsxs("div",{children:[r.jsx("div",{className:"text-sm font-medium mb-2",children:"Review"}),r.jsx("div",{className:"max-h-[50vh] overflow-auto space-y-3",children:S.map((e,t)=>r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsx("div",{className:"text-sm font-medium",children:e.question}),r.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+(e.isCorrect?"bg-soft-green":"bg-destructive/10 text-destructive"),children:e.isCorrect?"Correct":"Incorrect"})]}),!e.isCorrect&&r.jsxs("div",{className:"mt-2 text-sm space-y-1",children:[r.jsxs("div",{className:"text-muted-foreground",children:["Your answer: ",e.chosen]}),r.jsxs("div",{className:"text-muted-foreground",children:["Correct answer: ",e.correct]})]})]},e.id+String(t)))})]}),r.jsxs("div",{className:"flex gap-2 justify-center",children:[r.jsx(n,{onClick:()=>{v(0),_(0),y(null),k(!1),T([])},children:"Retry"}),r.jsx(n,{variant:"secondary",onClick:()=>f("/skills/synonym-match"),children:"Back to Map"})]})]})}):r.jsx(r.Fragment,{children:G?r.jsx(o,{className:"w-full max-w-3xl md:max-w-4xl lg:max-w-5xl border-light-border",children:r.jsxs(c,{className:"relative p-6 space-y-4",children:[C&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:r.jsx(m,{size:"sm",speed:1.2})}),r.jsxs("div",{className:"text-sm text-muted-foreground",children:["Question ",g+1," of ",p.length]}),"DefinitionMatch"===G.question_format?r.jsxs("div",{children:[r.jsx("div",{className:"text-2xl font-semibold mb-4",children:G.content}),r.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:Q.map(e=>{const t=w&&e===G.correct_answer,s=w===e&&e!==G.correct_answer;return r.jsx(n,{variant:t?"success":s?"destructive":"outline",className:"w-full justify-start text-left h-auto py-3 text-sm md:text-base whitespace-normal break-words break-all md:break-words",onClick:()=>V(e),children:e},e)})})]}):r.jsxs("div",{children:[r.jsx("div",{className:"text-2xl font-semibold mb-4 whitespace-pre-wrap",children:G.content}),r.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:Q.map(e=>{const t=w&&e===G.correct_answer,s=w===e&&e!==G.correct_answer;return r.jsx(n,{variant:t?"success":s?"destructive":"outline",className:"w-full justify-start text-left h-auto py-3 text-sm md:text-base whitespace-normal break-words break-all md:break-words",onClick:()=>V(e),children:e},e)})})]}),w&&r.jsxs("div",{className:"pt-2 space-y-3",children:[G.explanation&&r.jsxs("div",{className:"rounded-md border p-3",children:[r.jsx("div",{className:"text-sm font-medium",children:"Explanation"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:G.explanation})]}),r.jsx(n,{onClick:()=>{g+1>=p.length?k(!0):(v(e=>e+1),y(null))},children:"Continue"})]})]})}):Y?r.jsxs("div",{className:"text-center py-8",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading questions..."})]}):E?r.jsx(o,{className:"w-full max-w-lg",children:r.jsxs(c,{className:"p-6 text-center space-y-4",children:[r.jsx("div",{className:"text-destructive",children:"âš ï¸"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:E}),r.jsx(n,{variant:"outline",onClick:()=>f("/skills/synonym-match"),children:"Back to Synonym Match"})]})}):r.jsx("p",{className:"text-sm text-muted-foreground",children:"No questions available"})})]})})}):r.jsx("div",{className:"min-h-screen flex items-center justify-center",children:r.jsx(n,{onClick:()=>f("/ielts-portal"),children:"Back"})})};export{h as default};
