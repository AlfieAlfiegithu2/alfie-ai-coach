import{u as e,G as s,r as t,J as a,j as r,B as n,l as i,R as o,K as l,C as c,a as d,W as u,Y as m,V as x,b as h,d as b,Z as p,O as j,_ as g,L as N,$ as f,a0 as v,k as _}from"./index-BcRn0esQ.js";import{H as w}from"./Header-DjUzp7lg.js";import{s as q}from"./supabase-DWL4C3fA.js";import{C as y}from"./circle-alert-CJuYMXEg.js";import"./dropdown-menu-DrmFSAB3.js";import"./shield-zyDra3Nq.js";const k={1:{name:"Photos",questions:6,description:"Look at the photo and choose the statement that best describes it"},2:{name:"Question-Response",questions:25,description:"Listen and choose the best response"},3:{name:"Conversations",questions:39,description:"Listen to conversations and answer questions"},4:{name:"Talks",questions:30,description:"Listen to talks and answer questions"}},S=()=>{var S,C;const E=e(),{testId:P}=s(),L=t.useRef(null),[T,I]=t.useState(!0),[O,Q]=t.useState(""),[$,z]=t.useState([]),[B,R]=t.useState(0),[U,F]=t.useState(0),[H,J]=t.useState({}),[M,V]=t.useState(!1),[A,G]=t.useState(2700),[K,W]=t.useState(!1),[Y,Z]=t.useState(!1);t.useEffect(()=>{P&&D()},[P]),t.useEffect(()=>{if(!K&&A>0){const e=setInterval(()=>{G(e=>e-1)},1e3);return()=>clearInterval(e)}0!==A||K||ae()},[A,K]);const D=async()=>{if(P)try{const{data:e,error:s}=await q.from("tests").select("*").eq("id",P).single();if(s)throw s;Q(e.test_name);const{data:t,error:a}=await q.from("questions").select("*").eq("test_id",P).order("toeic_part",{ascending:!0}).order("question_number_in_part",{ascending:!0});if(a)throw a;const r={};null==t||t.forEach(e=>{const s=e.toeic_part||1;r[s]||(r[s]=[]),r[s].push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,toeic_part:s,audio_url:e.audio_url,image_url:e.image_url,ai_explanation:e.ai_explanation})});const n=Object.entries(r).map(([e,s])=>{var t;return{partNumber:parseInt(e),questions:s,audioUrl:null==(t=s[0])?void 0:t.audio_url}}).sort((e,s)=>e.partNumber-s.partNumber);z(n)}catch(e){console.error("Error loading test:",e),a.error("Failed to load test")}finally{I(!1)}},X=$[B],ee=null==X?void 0:X.questions[U],se=$.reduce((e,s)=>e+s.questions.length,0),te=Object.keys(H).length,ae=async()=>{W(!0),Z(!0);let e=0;$.forEach(s=>{s.questions.forEach(s=>{H[s.question_number]===s.correct_answer&&e++})}),a.success(`Test submitted! Score: ${e}/${se}`)};return T?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Loading test..."})]})}):0===$.length?r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsx(w,{}),r.jsxs("div",{className:"container mx-auto px-4 py-8 text-center",children:[r.jsx(y,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),r.jsx("h2",{className:"text-2xl font-bold mb-2",children:"No Questions Found"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:"This test doesn't have any questions yet."}),r.jsx(n,{onClick:()=>E("/toeic"),children:"Back to TOEIC Portal"})]})]}):r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950",children:[r.jsx(w,{}),r.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-4xl",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-xl font-bold",children:O}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"TOEIC Listening Test"})]}),r.jsx("div",{className:"flex items-center gap-4",children:r.jsxs(i,{variant:A<300?"destructive":"secondary",className:"text-lg px-3 py-1",children:[r.jsx(o,{className:"w-4 h-4 mr-1"}),(e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`})(A)]})})]}),r.jsxs("div",{className:"mb-4",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm mb-1",children:[r.jsxs("span",{children:["Progress: ",te,"/",se," answered"]}),r.jsxs("span",{children:[Math.round(te/se*100),"%"]})]}),r.jsx(l,{value:te/se*100,className:"h-2"})]}),r.jsx("div",{className:"flex gap-2 mb-4 overflow-x-auto pb-2",children:$.map((e,s)=>r.jsxs(n,{variant:s===B?"default":"outline",size:"sm",onClick:()=>{R(s),F(0)},className:"whitespace-nowrap",children:["Part ",e.partNumber,r.jsxs(i,{variant:"secondary",className:"ml-1 text-xs",children:[e.questions.filter(e=>H[e.question_number]).length,"/",e.questions.length]})]},e.partNumber))}),(null==X?void 0:X.audioUrl)&&r.jsx(c,{className:"mb-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white",children:r.jsx(d,{className:"p-4",children:r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx(n,{variant:"secondary",size:"icon",onClick:()=>{L.current&&(M?L.current.pause():L.current.play(),V(!M))},className:"bg-white/20 hover:bg-white/30",children:M?r.jsx(u,{className:"w-5 h-5"}):r.jsx(m,{className:"w-5 h-5"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("audio",{ref:L,src:X.audioUrl,onEnded:()=>V(!1)}),r.jsxs("p",{className:"text-sm font-medium",children:["Part ",X.partNumber," Audio"]}),r.jsx("p",{className:"text-xs opacity-80",children:null==(S=k[X.partNumber])?void 0:S.name})]}),r.jsx(x,{className:"w-5 h-5 opacity-80"})]})})}),ee&&r.jsxs(c,{className:"mb-4",children:[r.jsx(h,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(b,{className:"text-lg",children:["Question ",ee.question_number]}),r.jsxs(i,{variant:"outline",children:["Part ",X.partNumber,": ",null==(C=k[X.partNumber])?void 0:C.name]})]})}),r.jsxs(d,{children:[ee.image_url&&r.jsx("div",{className:"mb-4",children:r.jsx("img",{src:ee.image_url,alt:"Question image",className:"max-w-full h-auto rounded-lg border"})}),r.jsx("p",{className:"mb-4 text-lg",children:ee.question_text}),ee.options&&r.jsx(p,{value:H[ee.question_number]||"",onValueChange:e=>{return s=ee.question_number,t=e,void J(e=>({...e,[s]:t}));var s,t},children:r.jsx("div",{className:"space-y-3",children:ee.options.map((e,s)=>{const t=String.fromCharCode(65+s),a=H[ee.question_number]===t,n=Y&&t===ee.correct_answer,i=Y&&a&&t!==ee.correct_answer;return r.jsxs(j,{className:"flex items-center gap-3 p-4 rounded-lg border cursor-pointer transition-all "+(n?"bg-green-50 border-green-300 dark:bg-green-950/20":i?"bg-red-50 border-red-300 dark:bg-red-950/20":a?"bg-blue-50 border-blue-300 dark:bg-blue-950/20":"hover:bg-gray-50 dark:hover:bg-gray-800"),children:[r.jsx(g,{value:t,disabled:K}),r.jsxs("span",{className:"font-medium mr-2",children:["(",t,")"]}),r.jsx("span",{className:"flex-1",children:e}),Y&&n&&r.jsx(N,{className:"w-5 h-5 text-green-500"}),Y&&i&&r.jsx(y,{className:"w-5 h-5 text-red-500"})]},s)})})}),Y&&ee.ai_explanation&&r.jsxs("div",{className:"mt-4 p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg",children:[r.jsx("h4",{className:"font-semibold text-blue-700 dark:text-blue-400 mb-2",children:"Explanation"}),r.jsx("p",{className:"text-sm",children:ee.ai_explanation})]})]})]}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(n,{variant:"outline",onClick:()=>{U>0?F(e=>e-1):B>0&&(R(e=>e-1),F($[B-1].questions.length-1))},disabled:0===B&&0===U,children:[r.jsx(f,{className:"w-4 h-4 mr-1"}),"Previous"]}),K?r.jsx(n,{onClick:()=>E("/toeic"),children:"Back to Portal"}):r.jsxs(n,{onClick:ae,className:"bg-orange-600 hover:bg-orange-700",children:[r.jsx(v,{className:"w-4 h-4 mr-1"}),"Submit Test"]}),r.jsxs(n,{variant:"outline",onClick:()=>{U<X.questions.length-1?F(e=>e+1):B<$.length-1&&(R(e=>e+1),F(0))},disabled:B===$.length-1&&U===X.questions.length-1,children:["Next",r.jsx(_,{className:"w-4 h-4 ml-1"})]})]}),r.jsxs(c,{className:"mt-4",children:[r.jsx(h,{className:"py-3",children:r.jsx(b,{className:"text-sm",children:"Question Navigator"})}),r.jsx(d,{className:"pb-4",children:r.jsx("div",{className:"flex flex-wrap gap-2",children:null==X?void 0:X.questions.map((e,s)=>{const t=!!H[e.question_number],a=s===U,i=Y&&H[e.question_number]===e.correct_answer,o=Y&&H[e.question_number]&&H[e.question_number]!==e.correct_answer;return r.jsx(n,{variant:"outline",size:"sm",className:"w-10 h-10 p-0 "+(i?"bg-green-100 border-green-300 text-green-700":o?"bg-red-100 border-red-300 text-red-700":a?"bg-blue-100 border-blue-300":t?"bg-gray-100":""),onClick:()=>F(s),children:e.question_number},e.question_number)})})})]})]})]})};export{S as default};
