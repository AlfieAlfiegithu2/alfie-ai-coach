import{u as e,G as s,r as t,J as a,j as r,B as n,l as i,R as o,K as l,C as c,b as d,d as m,F as u,a as x,Z as p,O as h,_ as g,L as b,$ as j,a0 as N,k as v}from"./index-C36stBbp.js";import{S as _}from"./scroll-area-C0V1h9rh.js";import{H as f}from"./Header-CuTtpzU-.js";import{s as q}from"./supabase-DWL4C3fA.js";import{C as w}from"./circle-alert-DsvRNcJP.js";import"./dropdown-menu-CmC5UrFc.js";import"./shield-D8ns6_jV.js";const y={5:{name:"Incomplete Sentences",questions:40,description:"Choose the word or phrase that best completes the sentence"},6:{name:"Text Completion",questions:12,description:"Complete the passage with the correct word or phrase"},7:{name:"Reading Comprehension",questions:48,description:"Read the passage and answer questions"}},k=()=>{var k;const S=e(),{testId:C}=s(),[E,I]=t.useState(!0),[P,T]=t.useState(""),[O,R]=t.useState([]),[$,F]=t.useState(0),[B,Q]=t.useState(0),[z,H]=t.useState({}),[J,L]=t.useState(4500),[M,G]=t.useState(!1),[K,V]=t.useState(!1);t.useEffect(()=>{C&&Z()},[C]),t.useEffect(()=>{if(!M&&J>0){const e=setInterval(()=>{L(e=>e-1)},1e3);return()=>clearInterval(e)}0!==J||M||Y()},[J,M]);const Z=async()=>{if(C)try{const{data:e,error:s}=await q.from("tests").select("*").eq("id",C).single();if(s)throw s;T(e.test_name);const{data:t,error:a}=await q.from("questions").select("*").eq("test_id",C).order("toeic_part",{ascending:!0}).order("question_number_in_part",{ascending:!0});if(a)throw a;const{data:r,error:n}=await q.from("toeic_passages").select("*").eq("test_id",C).order("question_range_start",{ascending:!0}),i={5:{questions:[],passages:[]},6:{questions:[],passages:[]},7:{questions:[],passages:[]}};null==t||t.forEach(e=>{const s=e.toeic_part||5;i[s]&&i[s].questions.push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,toeic_part:s,passage_context:e.passage_context,ai_explanation:e.ai_explanation})}),null==r||r.forEach(e=>{const s=e.part_number;i[s]&&i[s].passages.push({id:e.id,title:e.passage_title,content:e.passage_content,type:e.passage_type,questionStart:e.question_range_start,questionEnd:e.question_range_end})});const o=Object.entries(i).filter(([e,s])=>s.questions.length>0).map(([e,s])=>({partNumber:parseInt(e),questions:s.questions,passages:s.passages})).sort((e,s)=>e.partNumber-s.partNumber);R(o)}catch(e){console.error("Error loading test:",e),a.error("Failed to load test")}finally{I(!1)}},A=O[$],D=null==A?void 0:A.questions[B],U=O.reduce((e,s)=>e+s.questions.length,0),W=Object.keys(z).length,X=null==A?void 0:A.passages.find(e=>D&&D.question_number>=e.questionStart&&D.question_number<=e.questionEnd),Y=async()=>{G(!0),V(!0);let e=0;O.forEach(s=>{s.questions.forEach(s=>{z[s.question_number]===s.correct_answer&&e++})}),a.success(`Test submitted! Score: ${e}/${U}`)};return E?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Loading test..."})]})}):0===O.length?r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsx(f,{}),r.jsxs("div",{className:"container mx-auto px-4 py-8 text-center",children:[r.jsx(w,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),r.jsx("h2",{className:"text-2xl font-bold mb-2",children:"No Questions Found"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:"This test doesn't have any questions yet."}),r.jsx(n,{onClick:()=>S("/toeic"),children:"Back to TOEIC Portal"})]})]}):r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-green-50 via-white to-emerald-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950",children:[r.jsx(f,{}),r.jsxs("div",{className:"container mx-auto px-4 py-4 max-w-6xl",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-xl font-bold",children:P}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"TOEIC Reading Test"})]}),r.jsx("div",{className:"flex items-center gap-4",children:r.jsxs(i,{variant:J<300?"destructive":"secondary",className:"text-lg px-3 py-1",children:[r.jsx(o,{className:"w-4 h-4 mr-1"}),(e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`})(J)]})})]}),r.jsxs("div",{className:"mb-4",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm mb-1",children:[r.jsxs("span",{children:["Progress: ",W,"/",U," answered"]}),r.jsxs("span",{children:[Math.round(W/U*100),"%"]})]}),r.jsx(l,{value:W/U*100,className:"h-2"})]}),r.jsx("div",{className:"flex gap-2 mb-4 overflow-x-auto pb-2",children:O.map((e,s)=>r.jsxs(n,{variant:s===$?"default":"outline",size:"sm",onClick:()=>{F(s),Q(0)},className:"whitespace-nowrap",children:["Part ",e.partNumber,r.jsxs(i,{variant:"secondary",className:"ml-1 text-xs",children:[e.questions.filter(e=>z[e.question_number]).length,"/",e.questions.length]})]},e.partNumber))}),r.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[(6===(null==A?void 0:A.partNumber)||7===(null==A?void 0:A.partNumber))&&(X||(null==D?void 0:D.passage_context))&&r.jsxs(c,{className:"md:h-[600px]",children:[r.jsx(d,{className:"py-3",children:r.jsxs(m,{className:"text-sm flex items-center gap-2",children:[r.jsx(u,{className:"w-4 h-4"}),(null==X?void 0:X.title)||"Reading Passage"]})}),r.jsx(x,{className:"p-0",children:r.jsx(_,{className:"h-[520px] px-4",children:r.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none pb-4",children:r.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",children:(null==X?void 0:X.content)||(null==D?void 0:D.passage_context)})})})})]}),r.jsxs(c,{className:""+(6!==(null==A?void 0:A.partNumber)&&7!==(null==A?void 0:A.partNumber)||!X&&!(null==D?void 0:D.passage_context)?"md:col-span-2":""),children:[r.jsx(d,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(m,{className:"text-lg",children:["Question ",null==D?void 0:D.question_number]}),r.jsxs(i,{variant:"outline",children:["Part ",null==A?void 0:A.partNumber,": ",null==(k=y[null==A?void 0:A.partNumber])?void 0:k.name]})]})}),r.jsx(x,{children:D&&r.jsxs(r.Fragment,{children:[r.jsx("p",{className:"mb-4 text-lg leading-relaxed",children:D.question_text}),D.options&&r.jsx(p,{value:z[D.question_number]||"",onValueChange:e=>{return s=D.question_number,t=e,void H(e=>({...e,[s]:t}));var s,t},children:r.jsx("div",{className:"space-y-3",children:D.options.map((e,s)=>{const t=String.fromCharCode(65+s),a=z[D.question_number]===t,n=K&&t===D.correct_answer,i=K&&a&&t!==D.correct_answer;return r.jsxs(h,{className:"flex items-center gap-3 p-4 rounded-lg border cursor-pointer transition-all "+(n?"bg-green-50 border-green-300 dark:bg-green-950/20":i?"bg-red-50 border-red-300 dark:bg-red-950/20":a?"bg-green-50 border-green-300 dark:bg-green-950/20":"hover:bg-gray-50 dark:hover:bg-gray-800"),children:[r.jsx(g,{value:t,disabled:M}),r.jsxs("span",{className:"font-medium mr-2",children:["(",t,")"]}),r.jsx("span",{className:"flex-1",children:e}),K&&n&&r.jsx(b,{className:"w-5 h-5 text-green-500"}),K&&i&&r.jsx(w,{className:"w-5 h-5 text-red-500"})]},s)})})}),K&&D.ai_explanation&&r.jsxs("div",{className:"mt-4 p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg",children:[r.jsx("h4",{className:"font-semibold text-blue-700 dark:text-blue-400 mb-2",children:"Explanation"}),r.jsx("p",{className:"text-sm",children:D.ai_explanation})]})]})})]})]}),r.jsxs("div",{className:"flex items-center justify-between mt-4",children:[r.jsxs(n,{variant:"outline",onClick:()=>{B>0?Q(e=>e-1):$>0&&(F(e=>e-1),Q(O[$-1].questions.length-1))},disabled:0===$&&0===B,children:[r.jsx(j,{className:"w-4 h-4 mr-1"}),"Previous"]}),M?r.jsx(n,{onClick:()=>S("/toeic"),children:"Back to Portal"}):r.jsxs(n,{onClick:Y,className:"bg-orange-600 hover:bg-orange-700",children:[r.jsx(N,{className:"w-4 h-4 mr-1"}),"Submit Test"]}),r.jsxs(n,{variant:"outline",onClick:()=>{B<A.questions.length-1?Q(e=>e+1):$<O.length-1&&(F(e=>e+1),Q(0))},disabled:$===O.length-1&&B===A.questions.length-1,children:["Next",r.jsx(v,{className:"w-4 h-4 ml-1"})]})]}),r.jsxs(c,{className:"mt-4",children:[r.jsx(d,{className:"py-3",children:r.jsx(m,{className:"text-sm",children:"Question Navigator"})}),r.jsx(x,{className:"pb-4",children:r.jsx("div",{className:"flex flex-wrap gap-2",children:null==A?void 0:A.questions.map((e,s)=>{const t=!!z[e.question_number],a=s===B,i=K&&z[e.question_number]===e.correct_answer,o=K&&z[e.question_number]&&z[e.question_number]!==e.correct_answer;return r.jsx(n,{variant:"outline",size:"sm",className:"w-10 h-10 p-0 "+(i?"bg-green-100 border-green-300 text-green-700":o?"bg-red-100 border-red-300 text-red-700":a?"bg-green-100 border-green-300":t?"bg-gray-100":""),onClick:()=>Q(s),children:e.question_number},e.question_number)})})})]})]})]})};export{k as default};
