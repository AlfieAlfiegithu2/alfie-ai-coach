import{u as e,c as s,r as t,j as r}from"./vendor-react-rLLBBC7n.js";import{q as a,s as n,J as o,B as i,C as l,b as d,c,a as m,R as u,L as x,p as h,r as g,t as b,v as p}from"./index-KxDfHqNJ.js";import{S as v}from"./scroll-area-Fi9tRruB.js";import{b4 as j,ap as N,at as w,a9 as f,ba as _,aM as q,aN as E,x as y,aa as k}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const A=()=>{const A=e(),{testId:D}=s(),B="note"===a().theme.name,[S,F]=t.useState(!0),[C,I]=t.useState(""),[P,Q]=t.useState([]),[T,$]=t.useState(0),[O,H]=t.useState(0),[J,L]=t.useState({}),[R,z]=t.useState([]),[M,V]=t.useState(4500),[G,K]=t.useState(!1),[U,W]=t.useState(!1);t.useEffect(()=>{D&&X()},[D]),t.useEffect(()=>{if(!G&&M>0){const e=setInterval(()=>{V(e=>e-1)},1e3);return()=>clearInterval(e)}0!==M||G||te()},[M,G]);const X=async()=>{if(D)try{const{data:e,error:s}=await n.from("tests").select("*").eq("id",D).single();if(s)throw s;I(e.test_name);const{data:t,error:r}=await n.from("questions").select("*").eq("test_id",D).order("toeic_part",{ascending:!0}).order("question_number_in_part",{ascending:!0});if(r)throw r;const{data:a,error:o}=await n.from("toeic_passages").select("*").eq("test_id",D).order("question_range_start",{ascending:!0});if(o)throw o;const i={5:{questions:[],passages:[]},6:{questions:[],passages:[]},7:{questions:[],passages:[]}};null==t||t.forEach(e=>{const s=e.toeic_part||5;i[s]&&i[s].questions.push({id:e.id,question_number:e.question_number_in_part,question_text:e.question_text,question_type:e.question_type,options:e.choices?JSON.parse(e.choices):null,correct_answer:e.correct_answer,toeic_part:s,passage_context:e.passage_context,ai_explanation:e.ai_explanation})}),null==a||a.forEach(e=>{const s=e.part_number;i[s]&&i[s].passages.push({id:e.id,title:e.passage_title,content:e.passage_content,type:e.passage_type,questionStart:e.question_range_start,questionEnd:e.question_range_end})});const l=Object.entries(i).filter(([e,s])=>s.questions.length>0).map(([e,s])=>({partNumber:parseInt(e),questions:s.questions,passages:s.passages})).sort((e,s)=>e.partNumber-s.partNumber);Q(l)}catch(e){console.error("Error loading test:",e),o.error("Failed to load test")}finally{F(!1)}},Y=P[T],Z=null==Y?void 0:Y.questions[O],ee=P.reduce((e,s)=>e+s.questions.length,0),se=null==Y?void 0:Y.passages.find(e=>Z&&Z.question_number>=e.questionStart&&Z.question_number<=e.questionEnd),te=async()=>{K(!0),W(!0);let e=0;P.forEach(s=>{s.questions.forEach(s=>{J[s.question_number]===s.correct_answer&&e++})}),o.success(`Test submitted! Score: ${e}/${ee}`),A("/toeic/reading/result",{state:{score:e,totalQuestions:ee,answers:J,groupedParts:P,testName:C}})},re=Y&&T===P.length-1&&O===Y.questions.length-1;return S?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Loading test..."})]})}):0===P.length?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsxs("div",{className:"container mx-auto px-4 py-8 text-center max-w-2xl",children:[r.jsx(j,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),r.jsx("h2",{className:"text-2xl font-bold mb-2",children:"No Questions Found"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:"This test doesn't have any questions yet."}),r.jsx(i,{onClick:()=>A("/toeic"),children:"Back to TOEIC Portal"})]})}):r.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center py-8 "+(B?"bg-[#FEF9E7]":"bg-gradient-to-br from-green-50 via-white to-emerald-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950"),children:r.jsxs("div",{className:"container px-4 max-w-6xl w-full",children:[r.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[(6===(null==Y?void 0:Y.partNumber)||7===(null==Y?void 0:Y.partNumber))&&(se||(null==Z?void 0:Z.passage_context))&&r.jsxs(l,{className:"md:h-[600px] "+(B?"bg-[#FEF9E7] border-[#E8D5A3]":""),children:[r.jsx(d,{className:"py-3",children:r.jsxs(c,{className:"text-sm flex items-center gap-2",style:{color:B?"#5D4E37":void 0},children:[r.jsx(N,{className:"w-4 h-4 "+(B?"text-[#8B6914]":"")}),(null==se?void 0:se.title)||"Reading Passage"]})}),r.jsx(m,{className:"p-0",children:r.jsx(v,{className:"h-[520px] px-4",children:r.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none pb-4",children:r.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed",style:{color:B?"#5D4E37":void 0},children:(null==se?void 0:se.content)||(null==Z?void 0:Z.passage_context)})})})})]}),r.jsxs(l,{className:`${6!==(null==Y?void 0:Y.partNumber)&&7!==(null==Y?void 0:Y.partNumber)||!se&&!(null==Z?void 0:Z.passage_context)?"md:col-span-2":""} ${B?"bg-[#FEF9E7] border-[#E8D5A3]":""}`,children:[r.jsx(d,{className:"flex flex-row items-center justify-between pb-2",children:r.jsxs(c,{className:"text-lg",style:{color:B?"#5D4E37":void 0},children:["Question ",null==Z?void 0:Z.question_number]})}),r.jsx(m,{children:Z&&r.jsxs(r.Fragment,{children:[r.jsx("p",{className:"mb-4 text-lg leading-relaxed",style:{color:B?"#5D4E37":void 0},children:Z.question_text}),Z.options&&r.jsx(u,{value:J[Z.question_number]||"",onValueChange:e=>{return s=Z.question_number,t=e,void L(e=>({...e,[s]:t}));var s,t},children:r.jsx("div",{className:"space-y-3",children:Z.options.map((e,s)=>{const t=String.fromCharCode(65+s),a=J[Z.question_number]===t,n=R.includes(Z.question_number),o=(U||n)&&t===Z.correct_answer,i=(U||n)&&a&&t!==Z.correct_answer;return r.jsxs(x,{className:"flex items-center gap-3 p-4 rounded-lg border cursor-pointer transition-all "+(o?"bg-green-50 border-green-300 dark:bg-green-950/20":i?"bg-red-50 border-red-300 dark:bg-red-950/20":a?B?"bg-[#E8D5A3]/30 border-[#A68B5B]":"bg-green-50 border-green-300 dark:bg-green-950/20":B?"bg-white/50 border-[#E8D5A3] hover:border-[#A68B5B]/50":"hover:bg-gray-50 dark:hover:bg-gray-800"),children:[r.jsx(h,{value:t,disabled:G,className:"sr-only"}),r.jsxs("span",{className:"font-medium mr-2 "+(B?"text-[#5D4E37]":""),children:["(",t,")"]}),r.jsx("span",{className:"flex-1 "+(B?"text-[#5D4E37]":""),children:e}),(U||n)&&o&&r.jsx(w,{className:"w-5 h-5 text-green-500"}),(U||n)&&i&&r.jsx(j,{className:"w-5 h-5 text-red-500"})]},s)})})}),(U||R.includes(Z.question_number))&&Z.ai_explanation&&r.jsxs("div",{className:"mt-4 p-4 rounded-lg "+(B?"bg-[#E8D5A3]/20 border border-[#E8D5A3]":"bg-blue-50 dark:bg-blue-950/20"),children:[r.jsx("h4",{className:"font-semibold mb-2 "+(B?"text-[#8B6914]":"text-blue-700 dark:text-blue-400"),children:"Explanation"}),r.jsx("p",{className:"text-sm "+(B?"text-[#5D4E37]":""),children:Z.ai_explanation})]})]})})]})]}),r.jsxs("div",{className:"flex items-center justify-between mt-8 px-4 relative",children:[r.jsx(i,{variant:"ghost",onClick:()=>{O>0?H(e=>e-1):T>0&&($(e=>e-1),H(P[T-1].questions.length-1))},disabled:0===T&&0===O,className:"w-12 h-12 rounded-full p-0 transition-all duration-200 "+(B?"bg-[#E8D5A3]/20 text-[#5D4E37] hover:bg-[#E8D5A3]/40 disabled:opacity-30":"bg-white shadow-md text-slate-600 hover:text-emerald-600 hover:bg-white hover:shadow-lg hover:-translate-y-0.5 disabled:opacity-30 disabled:shadow-none dark:bg-gray-800 dark:text-gray-300 dark:hover:text-emerald-400"),children:r.jsx(f,{className:"w-6 h-6"})}),r.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",children:r.jsxs(g,{children:[r.jsx(b,{asChild:!0,children:r.jsxs(i,{variant:"ghost",className:"flex items-center gap-2 px-4 py-2 rounded-full shadow-sm transition-all border "+(B?"bg-[#FEF9E7] border-[#E8D5A3] text-[#5D4E37] hover:bg-[#E8D5A3]/20":"bg-white border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-emerald-600 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300"),children:[r.jsx(_,{className:"w-4 h-4"}),r.jsxs("span",{className:"font-medium",children:[O+1," / ",null==Y?void 0:Y.questions.length]})]})}),r.jsx(p,{className:"w-80 p-4 "+(B?"bg-[#FEF9E7] border-[#E8D5A3]":""),align:"center",side:"top",children:r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h4",{className:"font-medium "+(B?"text-[#5D4E37]":""),children:"Question Navigator"}),r.jsxs("span",{className:"text-xs "+(B?"text-[#8B6914]":"text-muted-foreground"),children:["Part ",null==Y?void 0:Y.partNumber]})]}),r.jsx(v,{className:"h-[200px]",children:r.jsx("div",{className:"grid grid-cols-5 gap-2",children:null==Y?void 0:Y.questions.map((e,s)=>{const t=!!J[e.question_number],a=s===O,n=U&&J[e.question_number]===e.correct_answer,o=U&&J[e.question_number]&&J[e.question_number]!==e.correct_answer;return r.jsx(i,{variant:"outline",size:"sm",className:"h-9 w-full p-0 text-xs "+(n?"bg-green-100 border-green-300 text-green-700":o?"bg-red-100 border-red-300 text-red-700":a?B?"bg-[#A68B5B] text-white border-[#A68B5B]":"bg-emerald-600 text-white border-emerald-600":t?B?"bg-[#E8D5A3] text-[#5D4E37] border-[#E8D5A3]":"bg-emerald-50 text-emerald-700 border-emerald-200":B?"bg-transparent border-[#E8D5A3] text-[#5D4E37] hover:bg-[#E8D5A3]/20":""),onClick:()=>H(s),children:e.question_number},e.question_number)})})})]})})]})}),G?r.jsx(i,{onClick:()=>A("/toeic"),className:"px-6 rounded-full shadow-md transition-all "+(B?"bg-[#A68B5B] hover:bg-[#8B6914] text-white":"bg-slate-800 text-white hover:bg-slate-700"),children:"Back to Portal"}):r.jsxs("div",{className:"flex items-center gap-4",children:[Z&&!U&&r.jsx(i,{variant:"ghost",onClick:()=>{return e=Z.question_number,void(R.includes(e)?z(s=>s.filter(s=>s!==e)):z(s=>[...s,e]));var e},className:"rounded-full px-4 py-2 transition-all duration-200 gap-2 "+(B?"text-[#A68B5B] hover:bg-[#E8D5A3]/20":"text-slate-500 hover:text-emerald-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:text-emerald-400 dark:hover:bg-slate-800"),title:R.includes(Z.question_number)?"Hide Answer":"Show Answer",children:R.includes(Z.question_number)?r.jsxs(r.Fragment,{children:[r.jsx(q,{className:"w-5 h-5"}),r.jsx("span",{className:"text-sm font-medium",children:"Hide Answer"})]}):r.jsxs(r.Fragment,{children:[r.jsx(E,{className:"w-5 h-5"}),r.jsx("span",{className:"text-sm font-medium",children:"Show Answer"})]})}),re?r.jsxs(i,{onClick:te,className:"px-8 py-6 rounded-full shadow-md text-base font-medium transition-all duration-200 "+(B?"bg-[#A68B5B] hover:bg-[#8B6914] text-white hover:shadow-lg hover:-translate-y-0.5":"bg-gradient-to-r from-emerald-500 to-green-600 text-white hover:shadow-lg hover:shadow-green-500/20 hover:-translate-y-0.5"),children:["Submit Test",r.jsx(y,{className:"w-4 h-4 ml-2"})]}):r.jsx(i,{onClick:()=>{O<Y.questions.length-1?H(e=>e+1):T<P.length-1&&($(e=>e+1),H(0))},variant:"ghost",className:"w-12 h-12 rounded-full p-0 transition-all duration-200 "+(B?"bg-[#A68B5B] text-white hover:bg-[#8B6914] shadow-sm hover:shadow-md":"bg-white shadow-md text-emerald-600 hover:bg-white hover:shadow-lg hover:-translate-y-0.5 dark:bg-gray-800 dark:text-emerald-400"),children:r.jsx(k,{className:"w-6 h-6"})})]})]})]})})};export{A as default};
