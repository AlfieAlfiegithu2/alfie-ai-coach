import{aq as e,u as a,ak as s,r as t,j as n,_ as i,B as o,a3 as r,C as l,a as c}from"./index-CKnaXPOD.js";import{s as d}from"./supabase-DWL4C3fA.js";function m(){var m,h,u,v,x,g,b,p;const{deckId:j}=e(),f=a(),{theme:N}=s(),[w,S]=t.useState("Deck Test"),[k,_]=t.useState([]),[y,C]=t.useState(0),[q,T]=t.useState({}),[z,E]=t.useState(""),[M,$]=t.useState(!1),[A,I]=t.useState([]),[L,F]=t.useState(null),[O,B]=t.useState(null),[P,R]=t.useState(null),[V,D]=t.useState(!1),[J,U]=t.useState(!1),[W,X]=t.useState(!1),[G,H]=t.useState(0),[K,Q]=t.useState({}),[Y,Z]=t.useState(0),[ee,ae]=t.useState(!1),[se,te]=t.useState([]),[ne,ie]=t.useState(null),[oe,re]=t.useState(null),[le,ce]=t.useState(0),[de,me]=t.useState(null),[he,ue]=t.useState([]),[ve,xe]=t.useState({}),[ge,be]=t.useState([]),[pe,je]=t.useState(!1),[fe,Ne]=t.useState(!1),[we,Se]=t.useState(""),[ke,_e]=t.useState(()=>{const e=localStorage.getItem("vocab-shuffle-enabled");return!!e&&JSON.parse(e)}),ye=k.length,Ce=k[y]||null,qe=V?k[Y]:null,Te=2===G?k[le]:null,ze=2===G&&ge[le]||null,Ee="note"===N.name,Me=t.useMemo(()=>Ee?{"--behind-gradient":"linear-gradient(to bottom, #E6D29D 0%, #D4C08B 100%)","--inner-gradient":"linear-gradient(145deg, #FEF9E7 0%, #FFFDF5 100%)"}:{"--behind-gradient":"radial-gradient(farthest-side circle at 50% 50%, hsla(220,15%,70%,0.1) 4%, hsla(220,10%,60%,0.05) 10%, hsla(220,5%,50%,0.02) 50%, hsla(220,0%,40%,0) 100%), radial-gradient(35% 52% at 55% 20%, hsla(210,20%,60%,0.1) 0%, hsla(210,15%,50%,0) 100%), radial-gradient(100% 100% at 50% 50%, hsla(200,25%,55%,0.05) 1%, hsla(200,20%,45%,0) 76%), conic-gradient(from 124deg at 50% 50%, hsla(215,20%,65%,0.1) 0%, hsla(215,15%,55%,0.08) 40%, hsla(215,15%,55%,0.08) 60%, hsla(215,20%,65%,0.1) 100%)","--inner-gradient":"linear-gradient(145deg, hsla(220,10%,15%,0.6) 0%, hsla(210,15%,20%,0.4) 100%)"},[Ee]),$e=t.useMemo(()=>Ee?Me:{"--behind-gradient":"radial-gradient(farthest-side circle at 50% 50%, hsla(220,15%,70%,0.1) 4%, hsla(220,10%,60%,0.05) 10%, hsla(220,5%,50%,0.02) 50%, hsla(220,0%,40%,0) 100%), radial-gradient(35% 52% at 55% 20%, hsla(210,20%,60%,0.1) 0%, hsla(210,15%,50%,0) 100%), radial-gradient(100% 100% at 50% 50%, hsla(200,25%,55%,0.05) 1%, hsla(200,20%,45%,0) 76%), conic-gradient(from 124deg at 50% 50%, hsla(215,20%,65%,0.1) 0%, hsla(215,15%,55%,0.08) 40%, hsla(215,15%,55%,0.08) 60%, hsla(215,20%,65%,0.1) 100%)","--inner-gradient":"linear-gradient(145deg, hsla(220,10%,15%,0.6) 0%, hsla(210,15%,20%,0.4) 100%)"},[Ee,Me]);t.useEffect(()=>{(async()=>{var e,a,s;if(!j)return void console.log("VocabTest: No deckId provided");console.log("VocabTest: Loading deckId:",j),await d.auth.getSession();const t=decodeURIComponent(String(j)).trim();console.log("VocabTest: Safe deckId:",t);const{data:n}=await d.auth.getUser(),i=null==(e=null==n?void 0:n.user)?void 0:e.id,[o,r]=await Promise.all([d.from("vocab_cards").select("id, term, translation, pos, ipa, context_sentence, examples_json").eq("deck_id",t).or(`user_id.eq.${i||"null"},is_public.eq.true`).order("created_at",{ascending:!0}).limit(1e3),d.from("vocab_cards").select("vocab_decks!inner(name)").eq("deck_id",t).limit(1)]);console.log("VocabTest: Cards query result:",o),console.log("VocabTest: Deck name query result:",r);const l=null==(s=null==(a=((null==r?void 0:r.data)||[])[0])?void 0:a.vocab_decks)?void 0:s.name;S(l||"Deck Test");let c=(null==o?void 0:o.data)||[];if(console.log("VocabTest: Initial rows count:",c.length),0===c.length){const{data:e}=await d.from("vocab_cards").select("id, term, translation, pos, ipa, context_sentence, examples_json").eq("deck_id",t).eq("is_public",!0).order("created_at",{ascending:!0}).limit(1e3);c=e||[],console.log("VocabTest: Public fallback rows count:",c.length)}if(0===c.length){const{data:e}=await d.from("vocab_cards").select("id, term, translation, pos, ipa, context_sentence, examples_json, vocab_decks!inner(id)").eq("vocab_decks.id",t).order("created_at",{ascending:!0}).limit(1e3);c=(e||[]).map(e=>({id:e.id,term:e.term,translation:e.translation,pos:e.pos,ipa:e.ipa,context_sentence:e.context_sentence,examples_json:e.examples_json})),console.log("VocabTest: Join fallback rows count:",c.length)}console.log("VocabTest: Final rows count:",c.length);const m=localStorage.getItem("vocab-shuffle-enabled");m&&JSON.parse(m)&&(c=c.sort(()=>Math.random()-.5)),_(c),C(0)})()},[j]);const Ae=t.useMemo(()=>Ce?Array.isArray(Ce.examples_json)&&Ce.examples_json[0]?Ce.examples_json[0]:Ce.context_sentence||"":"",[Ce]);t.useMemo(()=>qe?Array.isArray(qe.examples_json)&&qe.examples_json[0]?qe.examples_json[0]:qe.context_sentence||"":"",[qe]);t.useEffect(()=>{const e=localStorage.getItem("vocab-notes");if(e)try{T(JSON.parse(e))}catch(a){console.error("Error loading notes:",a)}},[]),t.useEffect(()=>{Object.keys(q).length>0&&(localStorage.setItem("vocab-notes",JSON.stringify(q)),E("Saved"),setTimeout(()=>E(""),2e3))},[q]);const Ie=Ce&&q[Ce.id]||"";t.useEffect(()=>{M&&Ce&&Le()},[M,Ce]),t.useEffect(()=>{ee&&qe&&Fe()},[ee,qe]),t.useEffect(()=>{2===G&&(ze||Te)&&Oe()},[G,ze,Te]),t.useEffect(()=>{1===G&&qe&&Fe()},[G,qe,Y]);const Le=()=>{if(!Ce)return;const e=k.filter(e=>e.id!==Ce.id&&e.translation).map(e=>e.translation).filter(e=>e!==Ce.translation).slice(0,3),a=[Ce.translation,...e].sort(()=>Math.random()-.5);I(a),F(null),B(null)},Fe=()=>{if(!qe)return;const e=(qe.translation||"").toString(),a=new Set;k.forEach(s=>{if(!s||s.id===qe.id)return;const t=(s.translation||"").toString().trim();t&&t.toLowerCase()!==e.toLowerCase()&&(a.has(t.toLowerCase())||a.add(t.toLowerCase()))});let s=Array.from(a).map(e=>{const a=k.find(a=>(a.translation||"").toString().trim().toLowerCase()===e);return((null==a?void 0:a.translation)||"").toString()});s=s.sort(()=>Math.random()-.5).slice(0,3);const t=["A temporary or short-lived occurrence","An idea that lacks practical application","Something rare or infrequently encountered","A minor detail with little significance","A device used to measure performance"],n=new Set([e.toLowerCase(),...s.map(e=>e.toLowerCase())]);for(const o of t){if(s.length>=3)break;n.has(o.toLowerCase())||(s.push(o),n.add(o.toLowerCase()))}for(;s.length<3;){const e=`Option ${s.length+1}`;if(n.has(e.toLowerCase()))break;s.push(e),n.add(e.toLowerCase())}const i=[e,...s].filter(e=>"string"==typeof e&&e.trim().length>0).sort(()=>Math.random()-.5);te(i),ie(null),re(null)},Oe=()=>{const e=ze||Te;if(!e)return;const a=k.filter(a=>a.id!==e.id&&a.translation).map(e=>e.translation).filter(a=>a!==e.translation).slice(0,3),s=[e.translation,...a].sort(()=>Math.random()-.5);ue(s),me(null)},Be=e=>{Se(e),Ne(!0),setTimeout(()=>Ne(!1),3e3)},Pe=async(e,a)=>{try{const{data:s}=await d.auth.getUser();if(!(null==s?void 0:s.user))return;const{error:t}=await d.from("vocab_reviews").insert({user_id:s.user.id,card_id:e,rating:a?3:1,reviewed_at:(new Date).toISOString()});t&&console.error("Error saving SRS data:",t)}catch(s){console.error("Error saving SRS data:",s)}};return t.useEffect(()=>{$(!1),B(null),F(null)},[y]),n.jsx(i,{title:w,transparentBackground:Ee,children:n.jsxs("div",{className:"space-y-4",children:[n.jsx(o,{asChild:!0,variant:"secondary",size:"sm",className:"vocab-back-button",onClick:e=>e.stopPropagation(),children:n.jsx(r,{to:"/vocabulary",children:"â† Back"})}),n.jsxs(o,{variant:ke?"default":"outline",size:"sm",className:"vocab-shuffle-button ml-2",onClick:e=>{e.stopPropagation(),(()=>{const e=!ke;_e(e),localStorage.setItem("vocab-shuffle-enabled",JSON.stringify(e)),e?_(e=>[...e].sort(()=>Math.random()-.5)):window.location.reload()})()},children:["ðŸ”€ ",ke?"Shuffled":"Shuffle"]}),n.jsx(o,{variant:"outline",size:"sm",className:"vocab-add-button",onClick:async e=>{var a;e.stopPropagation();try{const{data:e}=await d.auth.getUser(),s=null==(a=null==e?void 0:e.user)?void 0:a.id;if(!s)return void alert("Please log in to add words to your word book.");const t=k.map(e=>e.term),{data:n}=await d.from("vocab_cards").select("term").eq("user_id",s).in("term",t),i=new Set((null==n?void 0:n.map(e=>e.term))||[]),o=k.filter(e=>!i.has(e.term));if(0===o.length)return void Be("All words already in your word book!");let{data:r}=await d.from("vocab_decks").select("id").eq("user_id",s).eq("name","My Word Book").maybeSingle();if(!r){const{data:e,error:a}=await d.from("vocab_decks").insert({user_id:s,name:"My Word Book",is_public:!1}).select("id").single();if(a)return console.error("Failed to create personal deck:",a),void Be("Failed to create word book. Please try again.");r=e}const l=o.map(e=>({user_id:s,deck_id:r.id,language:"en",term:e.term,translation:e.translation,pos:e.pos,ipa:e.ipa,context_sentence:e.context_sentence,is_public:!1})),{error:c}=await d.from("vocab_cards").insert(l);c?(console.error("Add to word book failed:",c),Be(`Failed to add words: ${c.message}`)):Be(`${o.length} words added to My Word Book!`)}catch(s){console.error("Add to word book failed",s),Be("Failed to add words. Please try again.")}},children:"Add"}),J&&n.jsx("div",{className:"vocab-screen-container",children:n.jsx(l,{children:n.jsxs(c,{className:"p-6 space-y-4",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Get ready for two quick tests"}),n.jsxs("ul",{className:"text-sm text-muted-foreground list-disc pl-6 space-y-1",children:[n.jsx("li",{children:"Test 1: See the English word with the same image from learning, choose the correct meaning."}),n.jsx("li",{children:"Test 2: See only the English word, choose the correct meaning."})]}),n.jsx("div",{className:"flex gap-2 justify-center pt-2",children:n.jsx(o,{onClick:()=>{U(!1),D(!0),H(1),Z(0),Q({}),ae(!1),be(k)},children:"Start Test 1"})})]})})}),W&&n.jsx("div",{className:"vocab-screen-container",children:n.jsx(l,{children:n.jsxs(c,{className:"p-6 space-y-4",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Next: Word-only test"}),n.jsx("div",{className:"text-sm text-muted-foreground",children:"Now you will only see the English word. Choose the correct meaning."}),n.jsx("div",{className:"flex gap-2 justify-center pt-2",children:n.jsx(o,{onClick:()=>{X(!1),H(2),ce(0),xe({})},children:"Start Test 2"})})]})})}),V&&qe&&1===G?n.jsxs("div",{className:"vocab-screen-container","data-theme":N.name,onClick:e=>{if(e.target.closest(".vocab-progress, .vocab-back-button"))return;const a=e.currentTarget.getBoundingClientRect(),s=e.clientX-a.left,t=a.width,n=.6*t;s<.4*t?Y>0&&(R("prev"),setTimeout(()=>R(null),600),Z(Y-1),ae(!1)):s>n&&Y<ye-1&&(R("next"),setTimeout(()=>R(null),600),Z(Y+1),ae(!1))},children:[n.jsxs("div",{className:"vocab-progress",children:[n.jsxs("div",{className:"text-sm text-white/80 font-medium",children:["Test 1: ",Y+1," / ",ye]}),n.jsxs("div",{className:"text-xs text-white/60 mt-1",children:["Score: ",Object.values(K).filter(e=>!0===e).length," correct"]})]}),n.jsx("div",{className:"vocab-card-container "+(P?`page-turn-${P}`:""),children:n.jsx("div",{className:"vocab-card-wrapper test1-mode",style:Me,children:n.jsx("div",{className:"vocab-card-inner",children:n.jsx("section",{className:"vocab-card front",children:n.jsxs("div",{className:"vocab-inside",children:[n.jsx("div",{className:"vocab-shine"}),n.jsx("div",{className:"vocab-glare"}),n.jsx("div",{className:"vocab-image-content",children:n.jsx("div",{className:"word-image-placeholder",children:n.jsx("div",{className:"text-6xl font-bold text-white/80 select-none",children:(null==(h=null==(m=qe.term)?void 0:m.slice(0,1))?void 0:h.toUpperCase())||"A"})})}),n.jsxs("div",{className:"vocab-content",children:[n.jsxs("div",{className:"vocab-details",children:[n.jsx("h3",{className:"vocab-term",children:qe.term}),n.jsx("p",{className:"vocab-pos",children:qe.pos||"word"}),qe.ipa&&n.jsxs("p",{className:"vocab-ipa",children:["/",qe.ipa,"/"]})]}),n.jsxs("div",{className:"vocab-quiz mt-4",children:[n.jsx("div",{className:"quiz-options",children:se.map((e,a)=>n.jsx("button",{className:"quiz-option "+(ne===e?"correct"===oe?"correct":"incorrect"===oe?"incorrect":"selected":""),onClick:()=>!ne&&(e=>{ie(e);const a=e===(null==qe?void 0:qe.translation);re(a?"correct":"incorrect"),qe&&(Q({...K,[qe.id]:a}),Pe(qe.id,a))})(e),disabled:!!ne,children:e},a))}),oe&&"incorrect"===oe&&n.jsx("div",{className:`quiz-feedback ${oe}`,children:"âœ— Incorrect"})]})]})]})})})})}),n.jsx("div",{style:{textAlign:"center",marginTop:"20px"},children:n.jsx(o,{variant:"outline",onClick:()=>{const e=Object.values(K).filter(e=>!0===e).length;if(1===G)D(!1),X(!0);else{const a=`Test Results:\n${e} out of ${ye} correct (${Math.round(e/ye*100)}%)`;alert(a),D(!1)}},children:1===G?"Continue to Test 2":"Finish Test"})})]}):2===G?n.jsxs("div",{className:"vocab-screen-container","data-theme":N.name,onClick:e=>{if(e.target.closest(".vocab-progress, .vocab-back-button, .vocab-add-button, .quiz-option"))return;if(!de)return;const a=e.currentTarget.getBoundingClientRect();if(e.clientX-a.left>.6*a.width){const e=ge.length||ye;le<e-1?(R("next"),setTimeout(()=>R(null),600),ce(le+1),me(null)):je(!0)}},children:[n.jsxs("div",{className:"vocab-progress",children:[n.jsxs("div",{className:"text-sm text-white/80 font-medium",children:["Test 2: ",Math.min(le+1,ge.length||ye)," / ",ge.length||ye]}),n.jsxs("div",{className:"text-xs text-white/60 mt-1",children:["Score: ",Object.values(ve).filter(e=>!0===e).length," correct"]})]}),n.jsx("div",{className:"vocab-card-container "+(P?`page-turn-${P}`:""),children:n.jsx("div",{className:"vocab-card-wrapper test2-mode",style:$e,children:n.jsx("div",{className:"vocab-card-inner",children:n.jsx("section",{className:"vocab-card front",children:n.jsxs("div",{className:"vocab-inside",children:[n.jsx("div",{className:"vocab-shine"}),n.jsx("div",{className:"vocab-glare"}),n.jsxs("div",{className:"vocab-content",children:[n.jsxs("div",{className:"vocab-details",children:[n.jsx("h3",{className:"vocab-term",children:null==(u=ze||Te)?void 0:u.term}),n.jsx("p",{className:"vocab-pos",children:(null==(v=ze||Te)?void 0:v.pos)||"word"}),(null==(x=ze||Te)?void 0:x.ipa)&&n.jsxs("p",{className:"vocab-ipa",children:["/",null==(g=ze||Te)?void 0:g.ipa,"/"]})]}),n.jsx("div",{className:"vocab-quiz",children:n.jsx("div",{className:"quiz-options",children:he.map((e,a)=>{var s;return n.jsx("button",{className:"quiz-option "+(de===e?e===(null==(s=ze||Te)?void 0:s.translation)?"correct":"incorrect":""),onClick:()=>!de&&(e=>{me(e);const a=ze||Te,s=e===(null==a?void 0:a.translation);a&&(xe({...ve,[a.id]:!!s}),Pe(a.id,!!s))})(e),disabled:!!de,children:e},a)})})})]})]})})})})}),pe&&n.jsx("div",{className:"mt-4",children:n.jsx(l,{className:"w-full max-w-2xl mx-auto",children:n.jsxs(c,{className:"p-6 space-y-4",children:[n.jsx("div",{className:"text-lg font-semibold text-center",children:"Results"}),n.jsxs("div",{className:"text-center text-muted-foreground",children:["Correct: ",Object.values(ve).filter(e=>!0===e).length," / ",ge.length||ye]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-sm font-medium mb-2",children:"Need more practice"}),n.jsx("div",{className:"grid gap-2",children:(ge.length?ge:k).filter(e=>!ve[e.id]).map(e=>n.jsxs("div",{className:"rounded-md border p-3 flex items-center justify-between",children:[n.jsx("div",{className:"text-sm font-medium",children:e.term}),n.jsx("div",{className:"text-xs text-muted-foreground",children:e.translation})]},e.id))})]}),n.jsxs("div",{className:"flex justify-center gap-2",children:[n.jsx(o,{onClick:()=>{const e=(ge.length?ge:k).filter(e=>!ve[e.id]);if(0===e.length)return je(!1),void f("/vocabulary");be(e),xe({}),ce(0),me(null),je(!1)},children:0===(ge.length?ge:k).filter(e=>!ve[e.id]).length?"Done":"Retake wrong only"}),n.jsx(o,{variant:"secondary",onClick:()=>f("/vocabulary"),children:"Back to Vocabulary"})]})]})})})]}):Ce?n.jsxs("div",{className:"vocab-screen-container","data-theme":N.name,onClick:e=>{if(e.target.closest(".vocab-navigation, .vocab-notes-section, .vocab-progress, .vocab-back-button"))return;const a=e.currentTarget.getBoundingClientRect(),s=e.clientX-a.left,t=a.width,n=.6*t;s<.4*t?y>0&&(R("prev"),setTimeout(()=>R(null),600),C(e=>Math.max(e-1,0))):s>n&&(y<ye-1?(R("next"),setTimeout(()=>R(null),600),C(e=>Math.min(e+1,Math.max(0,ye-1)))):y===ye-1&&U(!0))},children:[n.jsx("div",{className:"vocab-progress",children:n.jsx("div",{className:"text-sm text-white/80 font-medium",children:ye?`${y+1} / ${ye}`:"0 / 0"})}),n.jsxs("div",{className:"vocab-card-container "+(P?`page-turn-${P}`:""),children:[n.jsx("div",{className:"vocab-card-wrapper "+(M?"flipped":""),onClick:e=>{e.target.closest(".quiz-option")||(e.stopPropagation(),$(!M))},style:Me,children:n.jsxs("div",{className:"vocab-card-inner",children:[n.jsx("section",{className:"vocab-card front",children:n.jsxs("div",{className:"vocab-inside",children:[n.jsx("div",{className:"vocab-shine"}),n.jsx("div",{className:"vocab-glare"}),n.jsx("div",{className:"vocab-image-content",children:n.jsx("div",{className:"word-image-placeholder",children:n.jsx("div",{className:"text-6xl font-bold text-white/80 select-none",children:(null==(p=null==(b=Ce.term)?void 0:b.slice(0,1))?void 0:p.toUpperCase())||"A"})})}),n.jsxs("div",{className:"vocab-content",children:[n.jsxs("div",{className:"vocab-details",children:[n.jsx("h3",{className:"vocab-term",children:Ce.term}),n.jsx("p",{className:"vocab-pos",children:Ce.pos||"word"}),Ce.ipa&&n.jsxs("p",{className:"vocab-ipa",children:["/",Ce.ipa,"/"]})]}),Ce.translation&&n.jsx("div",{className:"vocab-translation",children:n.jsx("div",{className:"translation-text",children:Ce.translation})}),Ae&&n.jsx("div",{className:"vocab-example",children:n.jsx("div",{className:"example-text",dangerouslySetInnerHTML:{__html:((e,a)=>{if(!e||!a)return e;const s=new RegExp(`\\b(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})\\b`,"gi");return e.replace(s,e=>`<mark class="highlighted-word">${e}</mark>`)})(Ae,(null==Ce?void 0:Ce.term)||"")}})})]})]})}),n.jsx("section",{className:"vocab-card back",children:n.jsxs("div",{className:"vocab-inside",children:[n.jsx("div",{className:"vocab-shine"}),n.jsx("div",{className:"vocab-glare"}),n.jsxs("div",{className:"vocab-quiz",children:[n.jsxs("div",{className:"quiz-header",children:[n.jsx("h3",{className:"quiz-question",children:"What is the translation of:"}),n.jsx("div",{className:"quiz-word",children:Ce.term})]}),n.jsx("div",{className:"quiz-options",children:A.map((e,a)=>n.jsx("button",{className:"quiz-option "+(L===e?"correct"===O?"correct":"incorrect"===O?"incorrect":"selected":""),onClick:()=>!L&&(e=>{F(e);const a=e===(null==Ce?void 0:Ce.translation);B(a?"correct":"incorrect"),Ce&&Pe(Ce.id,a)})(e),disabled:!!L,children:e},a))}),O&&"incorrect"===O&&n.jsx("div",{className:`quiz-feedback ${O}`,children:"âœ— Incorrect"})]})]})})]})}),n.jsxs("div",{className:"vocab-notes-section",onClick:e=>e.stopPropagation(),children:[n.jsx("textarea",{className:"notes-textarea",placeholder:"",value:Ie,onChange:e=>{return Ce&&(a=Ce.id,s=e.target.value,void T(e=>({...e,[a]:s})));var a,s},rows:3}),z&&n.jsx("div",{className:"notes-save-indicator "+("Saved"===z?"notes-saved":""),children:z})]})]})]}):n.jsx(l,{children:n.jsxs(c,{className:"p-6 text-sm text-muted-foreground",children:["Loadingâ€¦ ",0===ye?"No cards found for this deck.":""]})}),fe&&n.jsx("div",{className:"vocab-toast",children:we})]})})}export{m as default};
