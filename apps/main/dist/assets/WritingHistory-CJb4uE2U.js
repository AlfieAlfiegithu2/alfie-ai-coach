import{u as e,ae as t,h as s,r,j as a,B as i,ar as n,C as l,a as o,ap as d,l as c,as as m,k as u}from"./index-x_G9xLa2.js";import{s as h}from"./supabase-DWL4C3fA.js";import{S as x}from"./square-pen-DP3RrITH.js";import{B as b}from"./book-CK3_iWib.js";import{T as g}from"./trash-2-BByKM9fF.js";const p=()=>{const p=e(),{user:f}=t(),{toast:j}=s(),[v,_]=r.useState([]),[y,N]=r.useState(!0);r.useEffect(()=>{f&&w()},[f]);const w=async()=>{try{N(!0);const{data:e,error:t}=await h.from("test_results").select("*").eq("user_id",null==f?void 0:f.id).like("test_type","%writing%").order("created_at",{ascending:!1});if(t)throw t;const{data:s,error:r}=await h.from("writing_test_results").select("*").eq("user_id",null==f?void 0:f.id).order("created_at",{ascending:!1});if(r)throw r;const a=[];e&&e.forEach(e=>{const t=(null==s?void 0:s.filter(t=>t.test_result_id===e.id))||[];let r=7;if(t.length>0){const e=t.find(e=>1===e.task_number),s=t.find(e=>2===e.task_number);if(e&&s){const t=k(e),a=k(s);r=Math.round((1*t+2*a)/3*2)/2}}a.push({id:e.id,created_at:e.created_at,overall_band:r,task1_results:t.filter(e=>1===e.task_number),task2_results:t.filter(e=>2===e.task_number),test_name:T(t)})});const i=(null==s?void 0:s.filter(e=>!e.test_result_id))||[],n={};i.forEach(e=>{var t;const s=(null==(t=e.created_at)?void 0:t.split("T")[0])||"unknown";n[s]||(n[s]=[]),n[s].push(e)}),Object.entries(n).forEach(([e,t])=>{const s=t.filter(e=>1===e.task_number),r=t.filter(e=>2===e.task_number);let i=7;if(s.length>0&&r.length>0){const e=k(s[0]),t=k(r[0]);i=Math.round((1*e+2*t)/3*2)/2}a.push({id:`standalone-${e}`,created_at:t[0].created_at||e,overall_band:i,task1_results:s,task2_results:r,test_name:T(t)})}),a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),_(a)}catch(e){console.error("Error fetching writing history:",e),j({title:"Error",description:"Failed to load writing history",variant:"destructive"})}finally{N(!1)}},k=e=>{if(e.band_scores&&"object"==typeof e.band_scores){const t=Object.values(e.band_scores).filter(e=>"number"==typeof e);if(t.length>0)return t.reduce((e,t)=>e+t,0)/t.length}return 7},T=e=>{if(!e||0===e.length)return"IELTS Writing Test";const t=e.find(e=>1===e.task_number),s=e.find(e=>2===e.task_number),r=(null==t?void 0:t.prompt_text)?t.prompt_text.replace(/\s+/g," ").trim():"",a=(null==s?void 0:s.prompt_text)?s.prompt_text.replace(/\s+/g," ").trim():"";return`IELTS Writing • ${r?`Task 1: ${r.substring(0,40)}${r.length>40?"…":""}`:"Task 1"} | ${a?`Task 2: ${a.substring(0,40)}${a.length>40?"…":""}`:"Task 2"}`};return y?a.jsx("div",{className:"min-h-screen bg-surface-2 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-brand-blue mx-auto mb-4"}),a.jsx("p",{className:"text-text-secondary",children:"Loading..."})]})}):a.jsxs("div",{className:"min-h-screen bg-surface-2",children:[a.jsx("div",{className:"bg-surface-1 border-b border-border sticky top-0 z-10",children:a.jsx("div",{className:"container mx-auto px-6 py-4",children:a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs(i,{variant:"ghost",onClick:()=>p("/dashboard"),className:"hover:bg-surface-3",children:[a.jsx(n,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-heading-2",children:"My Writing History"}),a.jsx("p",{className:"text-caption",children:"Review your past IELTS Writing submissions and progress"})]})]})})})}),a.jsx("div",{className:"container mx-auto px-6 py-8",children:0===v.length?a.jsx(l,{className:"card-modern text-center py-12",children:a.jsxs(o,{children:[a.jsx(x,{className:"w-16 h-16 text-text-muted mx-auto mb-4"}),a.jsx("h3",{className:"text-heading-3 mb-2",children:"No Writing History Found"}),a.jsx("p",{className:"text-body mb-6",children:"You haven't completed any IELTS Writing tests yet. Start practicing to build your history!"}),a.jsx(i,{onClick:()=>p("/ielts-portal"),className:"button-primary",children:"Start Writing Practice"})]})}):a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("h2",{className:"text-heading-3",children:["Your Writing Submissions (",v.length,")"]}),a.jsx(i,{onClick:()=>p("/ielts-portal"),className:"button-primary",children:"Take New Test"})]}),v.map(e=>{var t,s,r,n;return a.jsx(l,{className:"card-modern hover:shadow-lg transition-all cursor-pointer group",onClick:()=>(async e=>{try{const t=e.id.startsWith("standalone-")?e.id.replace("standalone-",""):e.id;p(`/results/writing/${t}`,{state:{submissionData:e}})}catch(t){console.error("Error viewing submission:",t),j({title:"Error",description:"Failed to load test details",variant:"destructive"})}})(e),children:a.jsx(o,{className:"p-6",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[a.jsx(d,{className:"w-4 h-4 text-brand-blue"}),a.jsx("span",{className:"text-sm text-text-secondary",children:new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),a.jsx("h3",{className:"font-semibold text-text-primary mb-2 line-clamp-2",children:e.test_name}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs(c,{variant:"outline",className:(n=e.overall_band||7,n>=8.5?"text-green-600 bg-green-50 border-green-200":n>=7?"text-blue-600 bg-blue-50 border-blue-200":n>=6?"text-yellow-600 bg-yellow-50 border-yellow-200":"text-red-600 bg-red-50 border-red-200")+" px-3 py-1",children:[a.jsx(m,{className:"w-3 h-3 mr-1"}),"Band ",(null==(t=e.overall_band)?void 0:t.toFixed(1))||"7.0"]}),a.jsxs("div",{className:"flex items-center gap-2 text-sm text-text-secondary",children:[a.jsx(b,{className:"w-4 h-4"}),a.jsxs("span",{children:[(null==(s=e.task1_results)?void 0:s.length)||0," Task 1, ",(null==(r=e.task2_results)?void 0:r.length)||0," Task 2"]})]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(i,{variant:"ghost",size:"sm",onClick:t=>(async(e,t)=>{if(e.stopPropagation(),window.confirm("Are you sure you want to delete this writing test result? This action cannot be undone."))try{const e=t.id.startsWith("standalone-")?t.id.replace("standalone-",""):t.id,{error:s}=await h.from("writing_test_results").delete().eq("test_result_id",e).eq("user_id",null==f?void 0:f.id);if(s)throw s;const{error:r}=await h.from("test_results").delete().eq("id",e).eq("user_id",null==f?void 0:f.id);if(r&&"PGRST116"!==r.code)throw r;j({title:"Test Result Deleted",description:"Your writing test result has been removed."}),w()}catch(s){console.error("Error deleting submission:",s),j({title:"Delete Failed",description:"Failed to delete the test result. Please try again.",variant:"destructive"})}})(t,e),className:"opacity-0 group-hover:opacity-100 transition-opacity text-red-600 hover:text-red-700 hover:bg-red-50",children:a.jsx(g,{className:"w-4 h-4"})}),a.jsx(u,{className:"w-5 h-5 text-text-muted"})]})]})})},e.id)})]})})]})};export{p as default};
