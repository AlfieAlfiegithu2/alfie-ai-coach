import{u as e,r as t,j as s}from"./vendor-react-rLLBBC7n.js";import{E as r,d as a,s as i,B as n,C as l,a as o,e as d}from"./index-KxDfHqNJ.js";import{az as c,aX as m,N as u,F as h,c5 as x,aY as p,aa as b}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";const g=()=>{const g=e(),{user:v}=r(),{toast:j}=a(),[f,_]=t.useState([]),[y,N]=t.useState(!0);t.useEffect(()=>{v&&w()},[v]);const w=async()=>{try{N(!0);const{data:e,error:t}=await i.from("test_results").select("*").eq("user_id",null==v?void 0:v.id).like("test_type","%writing%").order("created_at",{ascending:!1});if(t)throw t;const{data:s,error:r}=await i.from("writing_test_results").select("*").eq("user_id",null==v?void 0:v.id).order("created_at",{ascending:!1});if(r)throw r;const a=[];e&&e.forEach(e=>{const t=(null==s?void 0:s.filter(t=>t.test_result_id===e.id))||[];let r=7;if(t.length>0){const e=t.find(e=>1===e.task_number),s=t.find(e=>2===e.task_number);if(e&&s){const t=k(e),a=k(s);r=Math.round((1*t+2*a)/3*2)/2}}a.push({id:e.id,created_at:e.created_at,overall_band:r,task1_results:t.filter(e=>1===e.task_number),task2_results:t.filter(e=>2===e.task_number),test_name:T(t)})});const n=(null==s?void 0:s.filter(e=>!e.test_result_id))||[],l={};n.forEach(e=>{var t;const s=(null==(t=e.created_at)?void 0:t.split("T")[0])||"unknown";l[s]||(l[s]=[]),l[s].push(e)}),Object.entries(l).forEach(([e,t])=>{const s=t.filter(e=>1===e.task_number),r=t.filter(e=>2===e.task_number);let i=7;if(s.length>0&&r.length>0){const e=k(s[0]),t=k(r[0]);i=Math.round((1*e+2*t)/3*2)/2}a.push({id:`standalone-${e}`,created_at:t[0].created_at||e,overall_band:i,task1_results:s,task2_results:r,test_name:T(t)})}),a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),_(a)}catch(e){console.error("Error fetching writing history:",e),j({title:"Error",description:"Failed to load writing history",variant:"destructive"})}finally{N(!1)}},k=e=>{if(e.band_scores&&"object"==typeof e.band_scores){const t=Object.values(e.band_scores).filter(e=>"number"==typeof e);if(t.length>0)return t.reduce((e,t)=>e+t,0)/t.length}return 7},T=e=>{if(!e||0===e.length)return"IELTS Writing Test";const t=e.find(e=>1===e.task_number),s=e.find(e=>2===e.task_number),r=(null==t?void 0:t.prompt_text)?t.prompt_text.replace(/\s+/g," ").trim():"",a=(null==s?void 0:s.prompt_text)?s.prompt_text.replace(/\s+/g," ").trim():"";return`IELTS Writing • ${r?`Task 1: ${r.substring(0,40)}${r.length>40?"…":""}`:"Task 1"} | ${a?`Task 2: ${a.substring(0,40)}${a.length>40?"…":""}`:"Task 2"}`};return y?s.jsx("div",{className:"min-h-screen bg-surface-2 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-brand-blue mx-auto mb-4"}),s.jsx("p",{className:"text-text-secondary",children:"Loading..."})]})}):s.jsxs("div",{className:"min-h-screen bg-surface-2",children:[s.jsx("div",{className:"bg-surface-1 border-b border-border sticky top-0 z-10",children:s.jsx("div",{className:"container mx-auto px-6 py-4",children:s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs(n,{variant:"ghost",onClick:()=>g("/dashboard"),className:"hover:bg-surface-3",children:[s.jsx(c,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-heading-2",children:"My Writing History"}),s.jsx("p",{className:"text-caption",children:"Review your past IELTS Writing submissions and progress"})]})]})})})}),s.jsx("div",{className:"container mx-auto px-6 py-8",children:0===f.length?s.jsx(l,{className:"card-modern text-center py-12",children:s.jsxs(o,{children:[s.jsx(m,{className:"w-16 h-16 text-text-muted mx-auto mb-4"}),s.jsx("h3",{className:"text-heading-3 mb-2",children:"No Writing History Found"}),s.jsx("p",{className:"text-body mb-6",children:"You haven't completed any IELTS Writing tests yet. Start practicing to build your history!"}),s.jsx(n,{onClick:()=>g("/ielts-portal"),className:"button-primary",children:"Start Writing Practice"})]})}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsxs("h2",{className:"text-heading-3",children:["Your Writing Submissions (",f.length,")"]}),s.jsx(n,{onClick:()=>g("/ielts-portal"),className:"button-primary",children:"Take New Test"})]}),f.map(e=>{var t,r,a,c;return s.jsx(l,{className:"card-modern hover:shadow-lg transition-all cursor-pointer group",onClick:()=>(async e=>{try{const t=e.id.startsWith("standalone-")?e.id.replace("standalone-",""):e.id;g(`/results/writing/${t}`,{state:{submissionData:e}})}catch(t){console.error("Error viewing submission:",t),j({title:"Error",description:"Failed to load test details",variant:"destructive"})}})(e),children:s.jsx(o,{className:"p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[s.jsx(u,{className:"w-4 h-4 text-brand-blue"}),s.jsx("span",{className:"text-sm text-text-secondary",children:new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),s.jsx("h3",{className:"font-semibold text-text-primary mb-2 line-clamp-2",children:e.test_name}),s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs(d,{variant:"outline",className:(c=e.overall_band||7,c>=8.5?"text-green-600 bg-green-50 border-green-200":c>=7?"text-blue-600 bg-blue-50 border-blue-200":c>=6?"text-yellow-600 bg-yellow-50 border-yellow-200":"text-red-600 bg-red-50 border-red-200")+" px-3 py-1",children:[s.jsx(h,{className:"w-3 h-3 mr-1"}),"Band ",(null==(t=e.overall_band)?void 0:t.toFixed(1))||"7.0"]}),s.jsxs("div",{className:"flex items-center gap-2 text-sm text-text-secondary",children:[s.jsx(x,{className:"w-4 h-4"}),s.jsxs("span",{children:[(null==(r=e.task1_results)?void 0:r.length)||0," Task 1, ",(null==(a=e.task2_results)?void 0:a.length)||0," Task 2"]})]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(n,{variant:"ghost",size:"sm",onClick:t=>(async(e,t)=>{if(e.stopPropagation(),window.confirm("Are you sure you want to delete this writing test result? This action cannot be undone."))try{const e=t.id.startsWith("standalone-")?t.id.replace("standalone-",""):t.id,{error:s}=await i.from("writing_test_results").delete().eq("test_result_id",e).eq("user_id",null==v?void 0:v.id);if(s)throw s;const{error:r}=await i.from("test_results").delete().eq("id",e).eq("user_id",null==v?void 0:v.id);if(r&&"PGRST116"!==r.code)throw r;j({title:"Test Result Deleted",description:"Your writing test result has been removed."}),w()}catch(s){console.error("Error deleting submission:",s),j({title:"Delete Failed",description:"Failed to delete the test result. Please try again.",variant:"destructive"})}})(t,e),className:"opacity-0 group-hover:opacity-100 transition-opacity text-red-600 hover:text-red-700 hover:bg-red-50",children:s.jsx(p,{className:"w-4 h-4"})}),s.jsx(b,{className:"w-5 h-5 text-text-muted"})]})]})})},e.id)})]})})]})};export{g as default};
