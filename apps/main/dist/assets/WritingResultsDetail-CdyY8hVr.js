import{c as e,u as r,d as t,r as s,j as a}from"./vendor-react-rLLBBC7n.js";import{E as n,d as l,s as d,B as i,M as o,C as c,a as m,b,c as u,e as x}from"./index-BDl0jLJK.js";import{A as p}from"./AnnotatedWritingText-0Xj4l4db.js";import{az as h,bo as g,c4 as v,aY as f,at as j,be as N,K as k,a_ as S,as as y}from"./vendor-ui-BGi_EvHx.js";import"./vendor-react-dom-CgqbTh6h.js";import"./vendor-charts-0DeywwxG.js";import"./vendor-i18n-gE2_DBDv.js";import"./vendor-utils-Cn4gX4Gv.js";import"./vendor-supabase-DcWtwiPX.js";import"./vendor-animation-DlplP_f6.js";import"./vendor-date-DT7Rq6D9.js";import"./tabs-CFW1rRMF.js";const w=()=>{var w,T,_,A,E,O,C,B,I,$,L,R,W,D;const{submissionId:M}=e(),F=r(),q=t(),{user:K}=n(),{toast:Y}=l(),[G,P]=s.useState(!0),[z,H]=s.useState(null);s.useEffect(()=>{M&&K?V():q.state&&(H(q.state),P(!1))},[M,K,q.state]);const V=async()=>{try{P(!0);const{data:e,error:r}=await d.from("test_results").select("*").eq("id",M).eq("user_id",null==K?void 0:K.id).single();if(r&&"PGRST116"!==r.code)throw r;const{data:t,error:s}=await d.from("writing_test_results").select("*").eq("test_result_id",M).eq("user_id",null==K?void 0:K.id).order("task_number");if(s)throw s;if(!t||0===t.length)return Y({title:"Not Found",description:"Could not find the requested test results",variant:"destructive"}),void F("/dashboard/writing-history");const a=t.find(e=>1===e.task_number),n=t.find(e=>2===e.task_number);if(!a||!n)return Y({title:"Incomplete Data",description:"This test appears to be incomplete",variant:"destructive"}),void F("/dashboard/writing-history");const l=U(a),i=U(n),o=Math.round((1*l+2*i)/3*2)/2,c=a.structured||n.structured||null,m={testName:(null==e?void 0:e.test_type)||"IELTS Writing Test",task1Answer:a.user_response,task2Answer:n.user_response,feedback:Q(a,n,o),task1Data:{title:"Task 1",prompt_text:a.prompt_text,instructions:a.prompt_text},task2Data:{title:"Task 2",prompt_text:n.prompt_text,instructions:n.prompt_text},task1WordCount:a.word_count,task2WordCount:n.word_count,structured:c||{task1:{criteria:a.band_scores,overall_band:l},task2:{criteria:n.band_scores,overall_band:i},overall:{band:o}}};H(m)}catch(e){console.error("Error fetching submission data:",e),Y({title:"Error",description:"Failed to load test results",variant:"destructive"}),F("/dashboard/writing-history")}finally{P(!1)}},U=e=>{if(e.band_scores&&"object"==typeof e.band_scores){const r=Object.values(e.band_scores).filter(e=>"number"==typeof e);if(r.length>0)return r.reduce((e,r)=>e+r,0)/r.length}return 7},Q=(e,r,t)=>`TASK 1 ASSESSMENT\n\n${e.detailed_feedback||"Task 1 feedback not available"}\n\nTask 1 Overall Band Score: ${U(e)}\n\nTASK 2 ASSESSMENT\n\n${r.detailed_feedback||"Task 2 feedback not available"}\n\nTask 2 Overall Band Score: ${U(r)}\n\nOVERALL WRITING ASSESSMENT\n\nOverall Writing Band Score: ${t}\n\nThis assessment is based on your performance across both writing tasks, with Task 2 carrying more weight (67%) than Task 1 (33%) in the final calculation.`,J=e=>Math.round(2*e)/2;if(G)return a.jsx("div",{className:"min-h-screen bg-surface-2 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-brand-blue mx-auto mb-4"}),a.jsx("p",{className:"text-text-secondary",children:"Loading..."})]})});if(!z)return a.jsx("div",{className:"min-h-screen bg-surface-2 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("h2",{className:"text-heading-2 mb-4",children:"Test Not Available"}),a.jsx("p",{className:"text-body mb-6",children:"Could not load the requested test results."}),a.jsx(i,{onClick:()=>F("/dashboard/writing-history"),children:"Back to Writing History"})]})});const X=z.structured?{task1:[],task2:[],overall:z.structured.overall.band,task1Overall:z.structured.task1.overall_band,task2Overall:z.structured.task2.overall_band}:(e=>{let r=e.match(/TASK 1 ASSESSMENT([\s\S]*?)(?=TASK 2 ASSESSMENT)/),t=e.match(/TASK 2 ASSESSMENT([\s\S]*?)(?=OVERALL WRITING ASSESSMENT)/);if(!r||!t)return{task1:[],task2:[],overall:7,task1Overall:7,task2Overall:7};const s=e=>{const r=[];let t=e.match(/Band Score: (\d+(?:\.\d+)?)/g);return t||(t=e.match(/\*\*Band Score: (\d+(?:\.\d+)?)\*\*/g)),t&&r.push(...t.map(e=>{var r;return J(parseFloat((null==(r=e.match(/(\d+(?:\.\d+)?)/))?void 0:r[1])||"7"))})),r},a=s(r[1]),n=s(t[1]),l=r[1].match(/Task 1 Overall Band Score: (\d+(?:\.\d+)?)/),d=t[1].match(/Task 2 Overall Band Score: (\d+(?:\.\d+)?)/),i=l?J(parseFloat(l[1])):a.length>0?J(a.reduce((e,r)=>e+r,0)/a.length):7,o=d?J(parseFloat(d[1])):n.length>0?J(n.reduce((e,r)=>e+r,0)/n.length):7;let c=e.match(/Overall Writing Band Score: (\d+(?:\.\d+)?)/),m=7;if(c)m=J(parseFloat(c[1]));else{m=J((1*i+2*o)/3)}return{task1:a,task2:n,overall:m,task1Overall:i,task2Overall:o}})(z.feedback),Z=X.overall;return a.jsxs("div",{className:"min-h-screen bg-surface-2 relative",children:[a.jsx(o,{raysOrigin:"top-center",raysColor:"#4F46E5",raysSpeed:.5,lightSpread:2,rayLength:1.5,pulsating:!1,fadeDistance:1.2,saturation:.8,followMouse:!0,mouseInfluence:.05,noiseAmount:.1,distortion:.2}),a.jsx("div",{className:"bg-surface-1 border-b border-border sticky top-0 z-10",children:a.jsx("div",{className:"container mx-auto px-6 py-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs(i,{variant:"ghost",onClick:()=>F("/dashboard/writing-history"),className:"hover:bg-surface-3",children:[a.jsx(h,{className:"w-4 h-4 mr-2"}),"Back to History"]}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-heading-2",children:"Test Results"}),a.jsx("p",{className:"text-caption",children:z.testName})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{const e=document.createElement("a"),r=new Blob([z.feedback],{type:"text/plain"});e.href=URL.createObjectURL(r),e.download=`IELTS-Writing-Report-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(e),e.click(),document.body.removeChild(e)},children:[a.jsx(g,{className:"w-4 h-4 mr-2"}),"Download Report"]}),a.jsxs(i,{variant:"outline",size:"sm",children:[a.jsx(v,{className:"w-4 h-4 mr-2"}),"Share Results"]}),a.jsxs(i,{variant:"outline",size:"sm",onClick:async()=>{if(!M||!K)return;if(window.confirm("Are you sure you want to delete this writing test result? This action cannot be undone."))try{P(!0);const{error:e}=await d.from("writing_test_results").delete().eq("test_result_id",M).eq("user_id",K.id);if(e)throw e;const{error:r}=await d.from("test_results").delete().eq("id",M).eq("user_id",K.id);if(r)throw r;Y({title:"Test Result Deleted",description:"Your writing test result has been permanently removed."}),F("/dashboard/writing-history")}catch(e){console.error("Error deleting result:",e),Y({title:"Delete Failed",description:"Failed to delete the test result. Please try again.",variant:"destructive"})}finally{P(!1)}},className:"text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300",children:[a.jsx(f,{className:"w-4 h-4 mr-2"}),"Delete Result"]})]})]})})}),a.jsxs("div",{className:"container mx-auto px-6 space-section",children:[a.jsx(c,{className:"mb-8 card-modern border-2 border-brand-green/20 bg-gradient-to-br from-brand-green/5 to-brand-green/10",children:a.jsx(m,{className:"pt-6",children:a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{className:"p-3 rounded-2xl bg-brand-green/10",children:a.jsx(j,{className:"w-8 h-8 text-brand-green"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-heading-3 text-brand-green",children:"Test Completed Successfully!"}),a.jsx("p",{className:"text-body",children:"Your IELTS Writing test has been evaluated by our AI examiner."})]})]})})}),a.jsxs(c,{className:"card-elevated mb-6 overflow-hidden",children:[a.jsx(b,{className:"text-center bg-gradient-to-r from-brand-blue/10 to-brand-purple/10 py-3",children:a.jsxs("div",{className:"flex items-center justify-center gap-2",children:[a.jsx("div",{className:"p-2 rounded-xl bg-brand-blue/10",children:a.jsx(N,{className:"w-6 h-6 text-brand-blue"})}),a.jsx(u,{className:"text-heading-3",children:"Your IELTS Writing Band Score"})]})}),a.jsxs(m,{className:"text-center py-4",children:[a.jsx("div",{className:"text-6xl font-bold mb-4 bg-gradient-to-r from-brand-blue to-brand-purple bg-clip-text text-transparent",children:Z.toFixed(1)}),a.jsxs(x,{variant:"outline",className:(ee=Z,ee>=8.5?"text-green-600 bg-green-50 border-green-200":ee>=7?"text-blue-600 bg-blue-50 border-blue-200":ee>=6?"text-yellow-600 bg-yellow-50 border-yellow-200":"text-red-600 bg-red-50 border-red-200")+" text-lg px-4 py-2 rounded-2xl mb-2",children:[(e=>e>=8.5?"Excellent":e>=7?"Good":e>=6?"Competent":e>=5?"Modest":"Limited")(Z)," Performance"]}),a.jsx("p",{className:"text-caption",children:"Based on official IELTS assessment criteria"})]})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:[a.jsxs(c,{className:"card-modern border-2 border-brand-blue/20 bg-gradient-to-br from-brand-blue/5 to-brand-blue/10",children:[a.jsx(b,{className:"text-center",children:a.jsxs(u,{className:"flex items-center justify-center gap-2 text-brand-blue",children:[a.jsx("div",{className:"p-2 rounded-xl bg-brand-blue/10",children:a.jsx(k,{className:"w-5 h-5"})}),"Task 1 - Data Description"]})}),a.jsxs(m,{className:"text-center",children:[a.jsx("div",{className:"text-3xl font-bold mb-2 text-brand-blue",children:X.task1Overall?X.task1Overall.toFixed(1):"7.0"}),a.jsx("p",{className:"text-caption mb-2",children:"Overall Band Score"}),a.jsxs(x,{variant:"outline",className:"text-brand-blue border-brand-blue/30 rounded-full",children:[z.task1WordCount||(null==(w=z.task1Answer)?void 0:w.trim().split(/\s+/).filter(e=>e.length>0).length)||0," words"]})]})]}),a.jsxs(c,{className:"card-modern border-2 border-brand-purple/20 bg-gradient-to-br from-brand-purple/5 to-brand-purple/10",children:[a.jsx(b,{className:"text-center",children:a.jsxs(u,{className:"flex items-center justify-center gap-2 text-brand-purple",children:[a.jsx("div",{className:"p-2 rounded-xl bg-brand-purple/10",children:a.jsx(S,{className:"w-5 h-5"})}),"Task 2 - Essay Writing"]})}),a.jsxs(m,{className:"text-center",children:[a.jsx("div",{className:"text-3xl font-bold mb-2 text-brand-purple",children:X.task2Overall?X.task2Overall.toFixed(1):"7.0"}),a.jsx("p",{className:"text-caption mb-2",children:"Overall Band Score"}),a.jsxs(x,{variant:"outline",className:"text-brand-purple border-brand-purple/30 rounded-full",children:[z.task2WordCount||(null==(T=z.task2Answer)?void 0:T.trim().split(/\s+/).filter(e=>e.length>0).length)||0," words"]})]})]})]}),z.task2Data&&a.jsxs(c,{className:"mb-6 card-elevated border-2 border-brand-purple/20",children:[a.jsx(b,{className:"bg-gradient-to-r from-brand-purple/10 to-brand-purple/5",children:a.jsxs(u,{className:"flex items-center gap-2 text-brand-purple",children:[a.jsx("div",{className:"p-2 rounded-xl bg-brand-purple/10",children:a.jsx(S,{className:"w-5 h-5"})}),"Task 2 Question"]})}),a.jsx(m,{className:"p-6",children:a.jsxs("div",{className:"bg-surface-1 rounded-xl p-6 border border-border",children:[a.jsx("h4",{className:"font-semibold text-text-primary mb-3",children:z.task2Data.title}),a.jsx("div",{className:"text-text-secondary leading-relaxed whitespace-pre-wrap",children:z.task2Data.prompt_text||z.task2Data.instructions})]})})]}),a.jsxs(c,{className:"mb-8 bg-surface-1 rounded-3xl shadow-lg border-2 border-brand-blue/20",children:[a.jsxs(b,{className:"bg-gradient-to-r from-brand-blue/10 to-brand-purple/10",children:[a.jsxs(u,{className:"flex items-center gap-2 text-brand-blue",children:[a.jsx("div",{className:"p-2 rounded-xl bg-brand-blue/10",children:a.jsx(y,{className:"w-5 h-5"})}),"AI Examiner Report - Professional IELTS Assessment"]}),a.jsx("p",{className:"text-body",children:"Comprehensive analysis based on official IELTS band descriptors"})]}),a.jsx(m,{className:"p-6",children:a.jsx("div",{className:"prose prose-lg max-w-none text-text-primary",dangerouslySetInnerHTML:{__html:z.feedback.replace(/^(TASK [12] ASSESSMENT)$/gm,'<h2 class="text-2xl font-bold text-brand-blue mt-8 mb-6 border-b-2 border-brand-blue/20 pb-3">$1</h2>').replace(/^(OVERALL WRITING ASSESSMENT)$/gm,'<h2 class="text-2xl font-bold text-brand-purple mt-8 mb-6 border-b-2 border-brand-purple/20 pb-3">$1</h2>').replace(/^(Task Achievement|Task Response|Coherence and Cohesion|Lexical Resource|Grammatical Range and Accuracy|Your Path to a Higher Score)$/gm,'<h3 class="text-xl font-semibold text-text-primary mt-6 mb-4 bg-surface-3 p-3 rounded-xl">$1</h3>').replace(/^Band Score: (\d+(?:\.\d+)?)$/gm,'<div class="text-lg font-bold text-brand-green mb-3 bg-brand-green/10 p-2 rounded-lg inline-block">Band Score: $1</div>').replace(/^(Positive Feedback|Areas for Improvement):$/gm,'<h4 class="text-lg font-semibold text-text-primary mt-4 mb-2">$1:</h4>').replace(/^â€¢ (.*)$/gm,'<li class="mb-2 text-text-secondary">$1</li>').replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs,'<ul class="list-disc pl-6 mb-4 space-y-1">$1</ul>').replace(/^Overall Writing Band Score: (.*)$/gm,'<div class="text-2xl font-bold text-brand-purple mt-6 mb-4 bg-brand-purple/10 p-4 rounded-xl text-center">Overall Writing Band Score: $1</div>').replace(/\n/g,"<br>").replace(/---/g,'<hr class="my-8 border-border">')}})})]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:[a.jsx(p,{taskTitle:"Your Task 1 Answer",originalText:z.task1Answer||"",annotatedOriginal:null==(A=null==(_=z.structured)?void 0:_.task1)?void 0:A.annotated_original,annotatedCorrected:null==(O=null==(E=z.structured)?void 0:E.task1)?void 0:O.annotated_corrected,corrections:null==(B=null==(C=z.structured)?void 0:C.task1)?void 0:B.corrections,icon:k,colorScheme:"text-brand-blue"}),a.jsx(p,{taskTitle:"Your Task 2 Answer",originalText:z.task2Answer||"",annotatedOriginal:null==($=null==(I=z.structured)?void 0:I.task2)?void 0:$.annotated_original,annotatedCorrected:null==(R=null==(L=z.structured)?void 0:L.task2)?void 0:R.annotated_corrected,corrections:null==(D=null==(W=z.structured)?void 0:W.task2)?void 0:D.corrections,icon:S,colorScheme:"text-brand-purple"})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-center justify-center",children:[a.jsx(i,{onClick:()=>F("/ielts-portal"),className:"button-primary flex-1 sm:flex-none",children:"Take Another Test"}),a.jsx(i,{variant:"outline",onClick:()=>F("/dashboard"),className:"flex-1 sm:flex-none",children:"Back to Dashboard"})]})]})]});var ee};export{w as default};
